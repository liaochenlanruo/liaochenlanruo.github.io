{"total":136,"pageSize":10,"pageCount":14,"data":[{"title":"Scikit-learn机器学习实战-PCA","slug":"Scikit-learn机器学习实战-PCA","date":"2024-09-01T08:38:58.000Z","updated":"2024-09-01T08:47:58.888Z","comments":true,"path":"api/articles/Scikit-learn机器学习实战-PCA.json","excerpt":null,"keywords":null,"cover":"/PCA_files/PCA_5_0.png","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>PCA的全称是<strong>Principal Component Analysis</strong>，即主成分分析。这是一种常用的数据分析方法，主要用于数据降维。PCA的主要思想是将原始的高维特征空间通过线性变换投射到一个新的低维特征空间上，同时尽量保持原始数据的方差，使得在新的低维空间中数据的差异性得以保留。这一过程中，通过计算数据集的协方差矩阵，找到其特征值和特征向量，进而确定主成分的方向和贡献率，实现数据的有效降维。</p>\n<p>具体来说，PCA的计算过程包括以下几个步骤：</p>\n<ul>\n<li>数据标准化：将原始数据转换为均值为0，标准差为1的标准化数据，以消除不同量纲对分析结果的影响。</li>\n<li>计算协方差矩阵：标准化后的数据矩阵的协方差矩阵反映了各变量之间的相关性。</li>\n<li>计算特征值和特征向量：对协方差矩阵进行特征值分解，得到特征值和对应的特征向量。特征值的大小反映了对应主成分的重要性，而特征向量则指示了主成分的方向。</li>\n<li>选取主成分：根据特征值的大小，选取前k个主成分，使得这k个主成分的累计贡献率达到一定的阈值（如80%或90%）。</li>\n<li>转换数据到新的主成分空间：将原始数据转换到由选定的主成分构成的新空间中，得到降维后的数据。</li>\n</ul>\n<p>PCA在数据分析和机器学习领域有着广泛的应用，如特征提取、数据压缩、噪声消除、图像识别等。同时，PCA也是一种无监督学习的方法，它不需要数据的标签信息，就可以从数据中提取出有用的特征信息。</p>\n<p>本文通过鸢尾花数据集演示PCA方法，讲解如何确定降维采用的特征向量的数量，并完成降维。包括手写函数实现和通过SK-learn实现代码。</p>\n<h1 id=\"导入数据集\"><a href=\"#导入数据集\" class=\"headerlink\" title=\"导入数据集\"></a>导入数据集</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\">df = pd.read_csv(<span class=\"string\">&#x27;iris.data&#x27;</span>)</span><br><span class=\"line\">df.head()</span><br></pre></td></tr></table></figure>\n\n\n\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>5.1</th>\n      <th>3.5</th>\n      <th>1.4</th>\n      <th>0.2</th>\n      <th>Iris-setosa</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>4.9</td>\n      <td>3.0</td>\n      <td>1.4</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>4.7</td>\n      <td>3.2</td>\n      <td>1.3</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>4.6</td>\n      <td>3.1</td>\n      <td>1.5</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>5.0</td>\n      <td>3.6</td>\n      <td>1.4</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>5.4</td>\n      <td>3.9</td>\n      <td>1.7</td>\n      <td>0.4</td>\n      <td>Iris-setosa</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加列名，分别为 sepal_len, sepal_wid, petal_len, petal_wid, class</span></span><br><span class=\"line\"><span class=\"comment\"># 前四列为特征，最后一列为类别，共有3种类别</span></span><br><span class=\"line\">df.columns=[<span class=\"string\">&#x27;sepal_len&#x27;</span>, <span class=\"string\">&#x27;sepal_wid&#x27;</span>, <span class=\"string\">&#x27;petal_len&#x27;</span>, <span class=\"string\">&#x27;petal_wid&#x27;</span>, <span class=\"string\">&#x27;class&#x27;</span>]</span><br><span class=\"line\">df.head()</span><br></pre></td></tr></table></figure>\n\n\n\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>sepal_len</th>\n      <th>sepal_wid</th>\n      <th>petal_len</th>\n      <th>petal_wid</th>\n      <th>class</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>4.9</td>\n      <td>3.0</td>\n      <td>1.4</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>4.7</td>\n      <td>3.2</td>\n      <td>1.3</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>4.6</td>\n      <td>3.1</td>\n      <td>1.5</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>5.0</td>\n      <td>3.6</td>\n      <td>1.4</td>\n      <td>0.2</td>\n      <td>Iris-setosa</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>5.4</td>\n      <td>3.9</td>\n      <td>1.7</td>\n      <td>0.4</td>\n      <td>Iris-setosa</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拆分特征和标签</span></span><br><span class=\"line\"></span><br><span class=\"line\">X = df.iloc[:,<span class=\"number\">0</span>:<span class=\"number\">4</span>].values</span><br><span class=\"line\">y = df.iloc[:,<span class=\"number\">4</span>].values</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"特征工程\"><a href=\"#特征工程\" class=\"headerlink\" title=\"特征工程\"></a>特征工程</h1><h2 id=\"特征展示\"><a href=\"#特征展示\" class=\"headerlink\" title=\"特征展示\"></a>特征展示</h2><p>查看特征的取值范围以及其和类别的关系。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 导入matplotlib库中的pyplot模块，用于绘图</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> matplotlib <span class=\"keyword\">import</span> pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"comment\"># 导入math库</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> math</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义一个字典，映射数字到鸢尾花的种类名称</span></span><br><span class=\"line\">label_dict = &#123;<span class=\"number\">1</span>: <span class=\"string\">&#x27;Iris-Setosa&#x27;</span>,</span><br><span class=\"line\">              <span class=\"number\">2</span>: <span class=\"string\">&#x27;Iris-Versicolor&#x27;</span>,</span><br><span class=\"line\">              <span class=\"number\">3</span>: <span class=\"string\">&#x27;Iris-Virgnica&#x27;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义一个字典，映射数字到鸢尾花的特征名称</span></span><br><span class=\"line\">feature_dict = &#123;<span class=\"number\">0</span>: <span class=\"string\">&#x27;sepal length [cm]&#x27;</span>,</span><br><span class=\"line\">                <span class=\"number\">1</span>: <span class=\"string\">&#x27;sepal width [cm]&#x27;</span>,</span><br><span class=\"line\">                <span class=\"number\">2</span>: <span class=\"string\">&#x27;petal length [cm]&#x27;</span>,</span><br><span class=\"line\">                <span class=\"number\">3</span>: <span class=\"string\">&#x27;petal width [cm]&#x27;</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个8x6英寸的图像</span></span><br><span class=\"line\">plt.figure(figsize=(<span class=\"number\">8</span>, <span class=\"number\">6</span>))</span><br><span class=\"line\"><span class=\"comment\"># 循环绘制4个子图，每个子图代表一个特征的直方图</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> cnt <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">4</span>):</span><br><span class=\"line\">    <span class=\"comment\"># 在图像中创建2x2的子图，并指定当前子图的位置</span></span><br><span class=\"line\">    plt.subplot(<span class=\"number\">2</span>, <span class=\"number\">2</span>, cnt+<span class=\"number\">1</span>)</span><br><span class=\"line\">    <span class=\"comment\"># 遍历每种鸢尾花类别，绘制直方图</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> lab <span class=\"keyword\">in</span> (<span class=\"string\">&#x27;Iris-setosa&#x27;</span>, <span class=\"string\">&#x27;Iris-versicolor&#x27;</span>, <span class=\"string\">&#x27;Iris-virginica&#x27;</span>):</span><br><span class=\"line\">        <span class=\"comment\"># 绘制指定特征的直方图，使用不同颜色和透明度区分不同类别</span></span><br><span class=\"line\">        plt.hist(X[y==lab, cnt],</span><br><span class=\"line\">                 label=lab,</span><br><span class=\"line\">                 bins=<span class=\"number\">10</span>,</span><br><span class=\"line\">                 alpha=<span class=\"number\">0.3</span>,)</span><br><span class=\"line\">    <span class=\"comment\"># 设置子图的x轴标签</span></span><br><span class=\"line\">    plt.xlabel(feature_dict[cnt])</span><br><span class=\"line\">    <span class=\"comment\"># 添加图例，用于标识不同类别的鸢尾花</span></span><br><span class=\"line\">    plt.legend(loc=<span class=\"string\">&#x27;upper right&#x27;</span>, fancybox=<span class=\"literal\">True</span>, fontsize=<span class=\"number\">8</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 调整子图间的间距，使布局更加紧凑</span></span><br><span class=\"line\">plt.tight_layout()</span><br><span class=\"line\"><span class=\"comment\"># 显示绘制的图像</span></span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/PCA_files/PCA_5_0.png\" class=\"lazyload placeholder\" data-srcset=\"/PCA_files/PCA_5_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<ul>\n<li>发现<code>花萼的长度</code>和<code>宽度</code>能够较好的区分3种类别。</li>\n<li>四个特征取值范围差异较大，需要进行标准化。</li>\n</ul>\n<h2 id=\"数据标准化\"><a href=\"#数据标准化\" class=\"headerlink\" title=\"数据标准化\"></a>数据标准化</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进行数据标准化</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\">X_std = StandardScaler().fit_transform(X)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (X_std)</span><br></pre></td></tr></table></figure>\n\n<pre><code>[[-1.1483555  -0.11805969 -1.35396443 -1.32506301]\n [-1.3905423   0.34485856 -1.41098555 -1.32506301]\n [-1.51163569  0.11339944 -1.29694332 -1.32506301]\n [-1.02726211  1.27069504 -1.35396443 -1.32506301]\n [-0.54288852  1.9650724  -1.18290109 -1.0614657 ]\n [-1.51163569  0.8077768  -1.35396443 -1.19326436]\n [-1.02726211  0.8077768  -1.29694332 -1.32506301]\n [-1.75382249 -0.34951881 -1.35396443 -1.32506301]\n [-1.1483555   0.11339944 -1.29694332 -1.45686167]\n [-0.54288852  1.50215416 -1.29694332 -1.32506301]\n [-1.2694489   0.8077768  -1.23992221 -1.32506301]\n [-1.2694489  -0.11805969 -1.35396443 -1.45686167]\n [-1.87491588 -0.11805969 -1.52502777 -1.45686167]\n [-0.05851493  2.19653152 -1.46800666 -1.32506301]\n [-0.17960833  3.122368   -1.29694332 -1.0614657 ]\n [-0.54288852  1.9650724  -1.41098555 -1.0614657 ]\n [-0.90616871  1.03923592 -1.35396443 -1.19326436]\n [-0.17960833  1.73361328 -1.18290109 -1.19326436]\n [-0.90616871  1.73361328 -1.29694332 -1.19326436]\n [-0.54288852  0.8077768  -1.18290109 -1.32506301]\n [-0.90616871  1.50215416 -1.29694332 -1.0614657 ]\n [-1.51163569  1.27069504 -1.58204889 -1.32506301]\n [-0.90616871  0.57631768 -1.18290109 -0.92966704]\n [-1.2694489   0.8077768  -1.06885886 -1.32506301]\n [-1.02726211 -0.11805969 -1.23992221 -1.32506301]\n [-1.02726211  0.8077768  -1.23992221 -1.0614657 ]\n [-0.78507531  1.03923592 -1.29694332 -1.32506301]\n [-0.78507531  0.8077768  -1.35396443 -1.32506301]\n [-1.3905423   0.34485856 -1.23992221 -1.32506301]\n [-1.2694489   0.11339944 -1.23992221 -1.32506301]\n [-0.54288852  0.8077768  -1.29694332 -1.0614657 ]\n [-0.78507531  2.42799064 -1.29694332 -1.45686167]\n [-0.42179512  2.65944976 -1.35396443 -1.32506301]\n [-1.1483555   0.11339944 -1.29694332 -1.45686167]\n [-1.02726211  0.34485856 -1.46800666 -1.32506301]\n [-0.42179512  1.03923592 -1.41098555 -1.32506301]\n [-1.1483555   0.11339944 -1.29694332 -1.45686167]\n [-1.75382249 -0.11805969 -1.41098555 -1.32506301]\n [-0.90616871  0.8077768  -1.29694332 -1.32506301]\n [-1.02726211  1.03923592 -1.41098555 -1.19326436]\n [-1.63272909 -1.73827353 -1.41098555 -1.19326436]\n [-1.75382249  0.34485856 -1.41098555 -1.32506301]\n [-1.02726211  1.03923592 -1.23992221 -0.79786838]\n [-0.90616871  1.73361328 -1.06885886 -1.0614657 ]\n [-1.2694489  -0.11805969 -1.35396443 -1.19326436]\n [-0.90616871  1.73361328 -1.23992221 -1.32506301]\n [-1.51163569  0.34485856 -1.35396443 -1.32506301]\n [-0.66398191  1.50215416 -1.29694332 -1.32506301]\n [-1.02726211  0.57631768 -1.35396443 -1.32506301]\n [ 1.39460583  0.34485856  0.52773232  0.25652088]\n [ 0.66804545  0.34485856  0.41369009  0.38831953]\n [ 1.27351244  0.11339944  0.64177455  0.38831953]\n [-0.42179512 -1.73827353  0.12858453  0.12472222]\n [ 0.78913885 -0.58097793  0.47071121  0.38831953]\n [-0.17960833 -0.58097793  0.41369009  0.12472222]\n [ 0.54695205  0.57631768  0.52773232  0.52011819]\n [-1.1483555  -1.50681441 -0.27056327 -0.27067375]\n [ 0.91023225 -0.34951881  0.47071121  0.12472222]\n [-0.78507531 -0.81243705  0.07156341  0.25652088]\n [-1.02726211 -2.43265089 -0.15652104 -0.27067375]\n [ 0.06257847 -0.11805969  0.24262675  0.38831953]\n [ 0.18367186 -1.96973265  0.12858453 -0.27067375]\n [ 0.30476526 -0.34951881  0.52773232  0.25652088]\n [-0.30070172 -0.34951881 -0.09949993  0.12472222]\n [ 1.03132564  0.11339944  0.35666898  0.25652088]\n [-0.30070172 -0.11805969  0.41369009  0.38831953]\n [-0.05851493 -0.81243705  0.18560564 -0.27067375]\n [ 0.42585866 -1.96973265  0.41369009  0.38831953]\n [-0.30070172 -1.27535529  0.07156341 -0.1388751 ]\n [ 0.06257847  0.34485856  0.58475344  0.78371551]\n [ 0.30476526 -0.58097793  0.12858453  0.12472222]\n [ 0.54695205 -1.27535529  0.64177455  0.38831953]\n [ 0.30476526 -0.58097793  0.52773232 -0.00707644]\n [ 0.66804545 -0.34951881  0.29964787  0.12472222]\n [ 0.91023225 -0.11805969  0.35666898  0.25652088]\n [ 1.15241904 -0.58097793  0.58475344  0.25652088]\n [ 1.03132564 -0.11805969  0.69879566  0.65191685]\n [ 0.18367186 -0.34951881  0.41369009  0.38831953]\n [-0.17960833 -1.04389617 -0.15652104 -0.27067375]\n [-0.42179512 -1.50681441  0.0145423  -0.1388751 ]\n [-0.42179512 -1.50681441 -0.04247882 -0.27067375]\n [-0.05851493 -0.81243705  0.07156341 -0.00707644]\n [ 0.18367186 -0.81243705  0.75581678  0.52011819]\n [-0.54288852 -0.11805969  0.41369009  0.38831953]\n [ 0.18367186  0.8077768   0.41369009  0.52011819]\n [ 1.03132564  0.11339944  0.52773232  0.38831953]\n [ 0.54695205 -1.73827353  0.35666898  0.12472222]\n [-0.30070172 -0.11805969  0.18560564  0.12472222]\n [-0.42179512 -1.27535529  0.12858453  0.12472222]\n [-0.42179512 -1.04389617  0.35666898 -0.00707644]\n [ 0.30476526 -0.11805969  0.47071121  0.25652088]\n [-0.05851493 -1.04389617  0.12858453 -0.00707644]\n [-1.02726211 -1.73827353 -0.27056327 -0.27067375]\n [-0.30070172 -0.81243705  0.24262675  0.12472222]\n [-0.17960833 -0.11805969  0.24262675 -0.00707644]\n [-0.17960833 -0.34951881  0.24262675  0.12472222]\n [ 0.42585866 -0.34951881  0.29964787  0.12472222]\n [-0.90616871 -1.27535529 -0.44162661 -0.1388751 ]\n [-0.17960833 -0.58097793  0.18560564  0.12472222]\n [ 0.54695205  0.57631768  1.2690068   1.70630611]\n [-0.05851493 -0.81243705  0.75581678  0.91551417]\n [ 1.51569923 -0.11805969  1.21198569  1.17911148]\n [ 0.54695205 -0.34951881  1.04092235  0.78371551]\n [ 0.78913885 -0.11805969  1.15496457  1.31091014]\n [ 2.12116622 -0.11805969  1.61113348  1.17911148]\n [-1.1483555  -1.27535529  0.41369009  0.65191685]\n [ 1.75788602 -0.34951881  1.44007014  0.78371551]\n [ 1.03132564 -1.27535529  1.15496457  0.78371551]\n [ 1.63679263  1.27069504  1.32602791  1.70630611]\n [ 0.78913885  0.34485856  0.75581678  1.04731282]\n [ 0.66804545 -0.81243705  0.869859    0.91551417]\n [ 1.15241904 -0.11805969  0.98390123  1.17911148]\n [-0.17960833 -1.27535529  0.69879566  1.04731282]\n [-0.05851493 -0.58097793  0.75581678  1.57450745]\n [ 0.66804545  0.34485856  0.869859    1.4427088 ]\n [ 0.78913885 -0.11805969  0.98390123  0.78371551]\n [ 2.24225961  1.73361328  1.6681546   1.31091014]\n [ 2.24225961 -1.04389617  1.78219682  1.4427088 ]\n [ 0.18367186 -1.96973265  0.69879566  0.38831953]\n [ 1.27351244  0.34485856  1.09794346  1.4427088 ]\n [-0.30070172 -0.58097793  0.64177455  1.04731282]\n [ 2.24225961 -0.58097793  1.6681546   1.04731282]\n [ 0.54695205 -0.81243705  0.64177455  0.78371551]\n [ 1.03132564  0.57631768  1.09794346  1.17911148]\n [ 1.63679263  0.34485856  1.2690068   0.78371551]\n [ 0.42585866 -0.58097793  0.58475344  0.78371551]\n [ 0.30476526 -0.11805969  0.64177455  0.78371551]\n [ 0.66804545 -0.58097793  1.04092235  1.17911148]\n [ 1.63679263 -0.11805969  1.15496457  0.52011819]\n [ 1.87897942 -0.58097793  1.32602791  0.91551417]\n [ 2.48444641  1.73361328  1.49709126  1.04731282]\n [ 0.66804545 -0.58097793  1.04092235  1.31091014]\n [ 0.54695205 -0.58097793  0.75581678  0.38831953]\n [ 0.30476526 -1.04389617  1.04092235  0.25652088]\n [ 2.24225961 -0.11805969  1.32602791  1.4427088 ]\n [ 0.54695205  0.8077768   1.04092235  1.57450745]\n [ 0.66804545  0.11339944  0.98390123  0.78371551]\n [ 0.18367186 -0.11805969  0.58475344  0.78371551]\n [ 1.27351244  0.11339944  0.92688012  1.17911148]\n [ 1.03132564  0.11339944  1.04092235  1.57450745]\n [ 1.27351244  0.11339944  0.75581678  1.4427088 ]\n [-0.05851493 -0.81243705  0.75581678  0.91551417]\n [ 1.15241904  0.34485856  1.21198569  1.4427088 ]\n [ 1.03132564  0.57631768  1.09794346  1.70630611]\n [ 1.03132564 -0.11805969  0.81283789  1.4427088 ]\n [ 0.54695205 -1.27535529  0.69879566  0.91551417]\n [ 0.78913885 -0.11805969  0.81283789  1.04731282]\n [ 0.42585866  0.8077768   0.92688012  1.4427088 ]\n [ 0.06257847 -0.11805969  0.75581678  0.78371551]]\n</code></pre>\n<h1 id=\"确定特征向量的数量\"><a href=\"#确定特征向量的数量\" class=\"headerlink\" title=\"确定特征向量的数量\"></a>确定特征向量的数量</h1><h2 id=\"协方差矩阵\"><a href=\"#协方差矩阵\" class=\"headerlink\" title=\"协方差矩阵\"></a>协方差矩阵</h2><p>协方差是衡量两个变量总体误差的期望，用于描述两个变量之间的线性关系程度和方向。两个特征间的协方差值越大，表明其相关性越强。</p>\n<p>对于两个随机变量$X$和$Y$，其协方差$Cov(X,Y)$的计算公式为：</p>\n<p>$$Cov(X,Y) &#x3D; E[(X - E[X])(Y - E[Y])]$$</p>\n<p>其中，$E[X]$和$E[Y]$分别是$X$和$Y$的期望值（即均值）。</p>\n<p>在实际应用中，当我们只有样本数据时，我们通常使用样本协方差来估计总体协方差。对于包含$n$个样本点的数据集，样本协方差$s_{xy}$的计算公式为：</p>\n<p>$$s_{xy} &#x3D; \\frac{1}{n-1} \\sum_{i&#x3D;1}^{n} (x_i - \\bar{x})(y_i - \\bar{y})$$</p>\n<p>其中，$x_i$和$y_i$是样本点，$\\bar{x}$和$\\bar{y}$分别是$X$和$Y$的样本均值，计算公式为：</p>\n<p>$$\\bar{x} &#x3D; \\frac{1}{n} \\sum_{i&#x3D;1}^{n} x_i$$</p>\n<p>$$\\bar{y} &#x3D; \\frac{1}{n} \\sum_{i&#x3D;1}^{n} y_i$$</p>\n<p>注意，在计算样本协方差时，分母是$n-1$而不是$n$，这是为了得到总体协方差的无偏估计。</p>\n<p><strong>以下命令二选一</strong>：</p>\n<ul>\n<li>构造函数计算协方差矩阵</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 计算特征向量的均值，用于中心化数据</span></span><br><span class=\"line\">mean_vec = np.mean(X_std, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 计算数据的协方差矩阵，用于理解特征之间的线性关系</span></span><br><span class=\"line\"><span class=\"comment\"># (X_std - mean_vec).T.dot((X_std - mean_vec) )计算的是(X_std - mean_vec)的矩阵乘法</span></span><br><span class=\"line\"><span class=\"comment\"># 除以(X_std.shape[0]-1)是为了获得一个无偏估计</span></span><br><span class=\"line\">cov_mat = (X_std - mean_vec).T.dot((X_std - mean_vec)) / (X_std.shape[<span class=\"number\">0</span>]-<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出协方差矩阵，以便于后续分析和使用</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Covariance matrix \\n%s&#x27;</span> %cov_mat)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Covariance matrix \n[[ 1.00675676 -0.10448539  0.87716999  0.82249094]\n [-0.10448539  1.00675676 -0.41802325 -0.35310295]\n [ 0.87716999 -0.41802325  1.00675676  0.96881642]\n [ 0.82249094 -0.35310295  0.96881642  1.00675676]]\n</code></pre>\n<ul>\n<li>使用numpy计算协方差矩阵</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;NumPy covariance matrix: \\n%s&#x27;</span> %np.cov(X_std.T))</span><br></pre></td></tr></table></figure>\n\n<pre><code>NumPy covariance matrix: \n[[ 1.00675676 -0.10448539  0.87716999  0.82249094]\n [-0.10448539  1.00675676 -0.41802325 -0.35310295]\n [ 0.87716999 -0.41802325  1.00675676  0.96881642]\n [ 0.82249094 -0.35310295  0.96881642  1.00675676]]\n</code></pre>\n<p>求协方差矩阵的特征向量和特征值。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 求协方差矩阵</span></span><br><span class=\"line\">cov_mat = np.cov(X_std.T)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 求协方差矩阵的特征向量，返回特征向量（eig_vecs）和特征值（eig_vals）</span></span><br><span class=\"line\">eig_vals, eig_vecs = np.linalg.eig(cov_mat)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Eigenvectors \\n%s&#x27;</span> %eig_vecs)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;\\nEigenvalues \\n%s&#x27;</span> %eig_vals)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Eigenvectors \n[[ 0.52308496 -0.36956962 -0.72154279  0.26301409]\n [-0.25956935 -0.92681168  0.2411952  -0.12437342]\n [ 0.58184289 -0.01912775  0.13962963 -0.80099722]\n [ 0.56609604 -0.06381646  0.63380158  0.52321917]]\n\nEigenvalues \n[2.92442837 0.93215233 0.14946373 0.02098259]\n</code></pre>\n<p>肉眼观察<code>Eigenvalues</code>，应当取前2个特征值对应的特征向量，因为其最重要。</p>\n<p>创建一个包含特征值和对应特征向量的元组列表。按特征值降序排序这些元组。打印排序后的特征值，确认排序正确。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Make a list of (eigenvalue, eigenvector) tuples</span></span><br><span class=\"line\">eig_pairs = [(np.<span class=\"built_in\">abs</span>(eig_vals[i]), eig_vecs[:,i]) <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"built_in\">len</span>(eig_vals))]</span><br><span class=\"line\"><span class=\"built_in\">print</span> (eig_pairs)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (<span class=\"string\">&#x27;----------&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># Sort the (eigenvalue, eigenvector) tuples from high to low</span></span><br><span class=\"line\">eig_pairs.sort(key=<span class=\"keyword\">lambda</span> x: x[<span class=\"number\">0</span>], reverse=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Visually confirm that the list is correctly sorted by decreasing eigenvalues</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Eigenvalues in descending order:&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> eig_pairs:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(i[<span class=\"number\">0</span>])</span><br></pre></td></tr></table></figure>\n\n<pre><code>[(np.float64(2.9244283691111117), array([ 0.52308496, -0.25956935,  0.58184289,  0.56609604])), (np.float64(0.9321523302535062), array([-0.36956962, -0.92681168, -0.01912775, -0.06381646])), (np.float64(0.14946373489813364), array([-0.72154279,  0.2411952 ,  0.13962963,  0.63380158])), (np.float64(0.020982592764271016), array([ 0.26301409, -0.12437342, -0.80099722,  0.52321917]))]\n----------\nEigenvalues in descending order:\n2.9244283691111117\n0.9321523302535062\n0.14946373489813364\n0.020982592764271016\n</code></pre>\n<p>计算累计变异解释百分比，以评估前几个主成分能解释的总变异比例。最后输出累计变异解释百分比。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 计算所有特征值的总和</span></span><br><span class=\"line\">tot = <span class=\"built_in\">sum</span>(eig_vals)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 计算每个特征值占总和的百分比，并按降序排序</span></span><br><span class=\"line\"><span class=\"comment\"># 这一步的目的是确定每个特征值在总变异中所占的百分比</span></span><br><span class=\"line\">var_exp = [(i / tot)*<span class=\"number\">100</span> <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">sorted</span>(eig_vals, reverse=<span class=\"literal\">True</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出每个特征值的变异解释百分比</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(var_exp)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 计算累计变异解释百分比</span></span><br><span class=\"line\"><span class=\"comment\"># 这一步是为了了解前几个主成分可以解释多少总变异</span></span><br><span class=\"line\">cum_var_exp = np.cumsum(var_exp)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 累计变异解释百分比</span></span><br><span class=\"line\">cum_var_exp</span><br></pre></td></tr></table></figure>\n\n<pre><code>[np.float64(72.62003332692032), np.float64(23.147406858644143), np.float64(3.711515564584531), np.float64(0.5210442498510259)]\n\n\n\n\n\narray([ 72.62003333,  95.76744019,  99.47895575, 100.        ])\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 演示np.cumsum() 函数的用法</span></span><br><span class=\"line\">a = np.array([<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>])</span><br><span class=\"line\"><span class=\"built_in\">print</span> (a)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (<span class=\"string\">&#x27;-----------&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (np.cumsum(a)) <span class=\"comment\"># 元素的累加和</span></span><br></pre></td></tr></table></figure>\n\n<pre><code>[1 2 3 4]\n-----------\n[ 1  3  6 10]\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 绘制特征值的重要性</span></span><br><span class=\"line\">plt.figure(figsize=(<span class=\"number\">6</span>, <span class=\"number\">4</span>))</span><br><span class=\"line\"></span><br><span class=\"line\">plt.bar(<span class=\"built_in\">range</span>(<span class=\"number\">4</span>), var_exp, alpha=<span class=\"number\">0.5</span>, align=<span class=\"string\">&#x27;center&#x27;</span>,</span><br><span class=\"line\">            label=<span class=\"string\">&#x27;individual explained variance&#x27;</span>)</span><br><span class=\"line\">plt.step(<span class=\"built_in\">range</span>(<span class=\"number\">4</span>), cum_var_exp, where=<span class=\"string\">&#x27;mid&#x27;</span>,</span><br><span class=\"line\">             label=<span class=\"string\">&#x27;cumulative explained variance&#x27;</span>)</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Explained variance ratio&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Principal components&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>)</span><br><span class=\"line\">plt.tight_layout()</span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/PCA_files/PCA_20_0.png\" class=\"lazyload placeholder\" data-srcset=\"/PCA_files/PCA_20_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>根据上图可以决定取几个特征值进行降维，此例中前两个特征值已经足够（~95.77%）。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 根据前两个主要成分构造转换矩阵W</span></span><br><span class=\"line\"><span class=\"comment\"># 选择主要成分分析（PCA）得到的前两个特征向量</span></span><br><span class=\"line\"><span class=\"comment\"># 将特征向量重塑为4x1的矩阵形式，以便进行矩阵操作</span></span><br><span class=\"line\"><span class=\"comment\"># 这两个特征向量代表了数据中方差最大的两个方向</span></span><br><span class=\"line\">matrix_w = np.hstack((eig_pairs[<span class=\"number\">0</span>][<span class=\"number\">1</span>].reshape(<span class=\"number\">4</span>,<span class=\"number\">1</span>),</span><br><span class=\"line\">                      eig_pairs[<span class=\"number\">1</span>][<span class=\"number\">1</span>].reshape(<span class=\"number\">4</span>,<span class=\"number\">1</span>)))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印转换矩阵W，以便于查看和验证结果</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Matrix W:\\n&#x27;</span>, matrix_w)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Matrix W:\n [[ 0.52308496 -0.36956962]\n [-0.25956935 -0.92681168]\n [ 0.58184289 -0.01912775]\n [ 0.56609604 -0.06381646]]\n</code></pre>\n<h1 id=\"矩阵降维\"><a href=\"#矩阵降维\" class=\"headerlink\" title=\"矩阵降维\"></a>矩阵降维</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 标准化数据X_std与权重矩阵matrix_w进行点积运算，用于特征提取和数据转换</span></span><br><span class=\"line\">Y = X_std.dot(matrix_w)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出转换后的数据Y</span></span><br><span class=\"line\">Y</span><br></pre></td></tr></table></figure>\n\n\n\n\n<pre><code>array([[-2.10795032,  0.64427554],\n       [-2.38797131,  0.30583307],\n       [-2.32487909,  0.56292316],\n       [-2.40508635, -0.687591  ],\n       [-2.08320351, -1.53025171],\n       [-2.4636848 , -0.08795413],\n       [-2.25174963, -0.25964365],\n       [-2.3645813 ,  1.08255676],\n       [-2.20946338,  0.43707676],\n       [-2.17862017, -1.08221046],\n       [-2.34525657, -0.17122946],\n       [-2.24590315,  0.6974389 ],\n       [-2.66214582,  0.92447316],\n       [-2.2050227 , -1.90150522],\n       [-2.25993023, -2.73492274],\n       [-2.21591283, -1.52588897],\n       [-2.20705382, -0.52623535],\n       [-1.9077081 , -1.4415791 ],\n       [-2.35411558, -1.17088308],\n       [-1.93202643, -0.44083479],\n       [-2.21942518, -0.96477499],\n       [-2.79116421, -0.50421849],\n       [-1.83814105, -0.11729122],\n       [-2.24572458, -0.17450151],\n       [-1.97825353,  0.59734172],\n       [-2.06935091, -0.27755619],\n       [-2.18514506, -0.56366755],\n       [-2.15824269, -0.34805785],\n       [-2.28843932,  0.30256102],\n       [-2.16501749,  0.47232759],\n       [-1.8491597 , -0.45547527],\n       [-2.62023392, -1.84237072],\n       [-2.44885384, -2.1984673 ],\n       [-2.20946338,  0.43707676],\n       [-2.23112223,  0.17266644],\n       [-2.06147331, -0.6957435 ],\n       [-2.20946338,  0.43707676],\n       [-2.45783833,  0.86912843],\n       [-2.1884075 , -0.30439609],\n       [-2.30357329, -0.48039222],\n       [-1.89932763,  2.31759817],\n       [-2.57799771,  0.4400904 ],\n       [-1.98020921, -0.50889705],\n       [-2.14679556, -1.18365675],\n       [-2.09668176,  0.68061705],\n       [-2.39554894, -1.16356284],\n       [-2.41813611,  0.34949483],\n       [-2.24196231, -1.03745802],\n       [-2.22484727, -0.04403395],\n       [ 1.09225538, -0.86148748],\n       [ 0.72045861, -0.59920238],\n       [ 1.2299583 , -0.61280832],\n       [ 0.37598859,  1.756516  ],\n       [ 1.05729685,  0.21303055],\n       [ 0.36816104,  0.58896262],\n       [ 0.73800214, -0.77956125],\n       [-0.52021731,  1.84337921],\n       [ 0.9113379 , -0.02941906],\n       [-0.01292322,  1.02537703],\n       [-0.15020174,  2.65452146],\n       [ 0.42437533,  0.05686991],\n       [ 0.52894687,  1.77250558],\n       [ 0.70241525,  0.18484154],\n       [-0.05385675,  0.42901221],\n       [ 0.86277668, -0.50943908],\n       [ 0.33388091,  0.18785518],\n       [ 0.13504146,  0.7883247 ],\n       [ 1.19457128,  1.63549265],\n       [ 0.13677262,  1.30063807],\n       [ 0.72711201, -0.40394501],\n       [ 0.45564294,  0.41540628],\n       [ 1.21038365,  0.94282042],\n       [ 0.61327355,  0.4161824 ],\n       [ 0.68512164,  0.06335788],\n       [ 0.85951424, -0.25016762],\n       [ 1.23906722,  0.08500278],\n       [ 1.34575245, -0.32669695],\n       [ 0.64732915,  0.22336443],\n       [-0.06728496,  1.05414028],\n       [ 0.10033285,  1.56100021],\n       [-0.00745518,  1.57050182],\n       [ 0.2179082 ,  0.77368423],\n       [ 1.04116321,  0.63744742],\n       [ 0.20719664,  0.27736006],\n       [ 0.42154138, -0.85764157],\n       [ 1.03691937, -0.52112206],\n       [ 1.015435  ,  1.39413373],\n       [ 0.0519502 ,  0.20903977],\n       [ 0.25582921,  1.32747797],\n       [ 0.25384813,  1.11700714],\n       [ 0.60915822, -0.02858679],\n       [ 0.31116522,  0.98711256],\n       [-0.39679548,  2.01314578],\n       [ 0.26536661,  0.85150613],\n       [ 0.07385897,  0.17160757],\n       [ 0.20854936,  0.37771566],\n       [ 0.55843737,  0.15286277],\n       [-0.47853403,  1.53421644],\n       [ 0.23545172,  0.59332536],\n       [ 1.8408037 , -0.86943848],\n       [ 1.13831104,  0.70171953],\n       [ 2.19615974, -0.54916658],\n       [ 1.42613827,  0.05187679],\n       [ 1.8575403 , -0.28797217],\n       [ 2.74511173, -0.78056359],\n       [ 0.34010583,  1.5568955 ],\n       [ 2.29180093, -0.40328242],\n       [ 1.98618025,  0.72876171],\n       [ 2.26382116, -1.91685818],\n       [ 1.35591821, -0.69255356],\n       [ 1.58471851,  0.43102351],\n       [ 1.87342402, -0.41054652],\n       [ 1.23656166,  1.16818977],\n       [ 1.45128483,  0.4451459 ],\n       [ 1.58276283, -0.67521526],\n       [ 1.45956552, -0.25105642],\n       [ 2.43560434, -2.55096977],\n       [ 3.29752602,  0.01266612],\n       [ 1.23377366,  1.71954411],\n       [ 2.03218282, -0.90334021],\n       [ 0.95980311,  0.57047585],\n       [ 2.88717988, -0.38895776],\n       [ 1.31405636,  0.48854962],\n       [ 1.69619746, -1.01153249],\n       [ 1.94868773, -0.99881497],\n       [ 1.1574572 ,  0.31987373],\n       [ 1.007133  , -0.06550254],\n       [ 1.7733922 ,  0.19641059],\n       [ 1.85327106, -0.55077372],\n       [ 2.4234788 , -0.2397454 ],\n       [ 2.31353522, -2.62038074],\n       [ 1.84800289,  0.18799967],\n       [ 1.09649923,  0.29708201],\n       [ 1.1812503 ,  0.81858241],\n       [ 2.79178861, -0.83668445],\n       [ 1.57340399, -1.07118383],\n       [ 1.33614369, -0.420823  ],\n       [ 0.91061354, -0.01965942],\n       [ 1.84350913, -0.66872729],\n       [ 2.00701161, -0.60663655],\n       [ 1.89319854, -0.68227708],\n       [ 1.13831104,  0.70171953],\n       [ 2.03519535, -0.86076914],\n       [ 1.99464025, -1.04517619],\n       [ 1.85977129, -0.37934387],\n       [ 1.54200377,  0.90808604],\n       [ 1.50925493, -0.26460621],\n       [ 1.3690965 , -1.01583909],\n       [ 0.94680339,  0.02182097]])\n</code></pre>\n<p>查看降维前的区分表现。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plt.figure(figsize=(<span class=\"number\">6</span>, <span class=\"number\">4</span>))</span><br><span class=\"line\"><span class=\"keyword\">for</span> lab, col <span class=\"keyword\">in</span> <span class=\"built_in\">zip</span>((<span class=\"string\">&#x27;Iris-setosa&#x27;</span>, <span class=\"string\">&#x27;Iris-versicolor&#x27;</span>, <span class=\"string\">&#x27;Iris-virginica&#x27;</span>),</span><br><span class=\"line\">                        (<span class=\"string\">&#x27;blue&#x27;</span>, <span class=\"string\">&#x27;red&#x27;</span>, <span class=\"string\">&#x27;green&#x27;</span>)):</span><br><span class=\"line\">     plt.scatter(X[y==lab, <span class=\"number\">0</span>],</span><br><span class=\"line\">                X[y==lab, <span class=\"number\">1</span>],</span><br><span class=\"line\">                label=lab,</span><br><span class=\"line\">                c=col)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;sepal_len&#x27;</span>)</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;sepal_wid&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>)</span><br><span class=\"line\">plt.tight_layout()</span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/PCA_files/PCA_26_0.png\" class=\"lazyload placeholder\" data-srcset=\"/PCA_files/PCA_26_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>查看降维后的区分表现。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plt.figure(figsize=(<span class=\"number\">6</span>, <span class=\"number\">4</span>))</span><br><span class=\"line\"><span class=\"keyword\">for</span> lab, col <span class=\"keyword\">in</span> <span class=\"built_in\">zip</span>((<span class=\"string\">&#x27;Iris-setosa&#x27;</span>, <span class=\"string\">&#x27;Iris-versicolor&#x27;</span>, <span class=\"string\">&#x27;Iris-virginica&#x27;</span>),</span><br><span class=\"line\">                        (<span class=\"string\">&#x27;blue&#x27;</span>, <span class=\"string\">&#x27;red&#x27;</span>, <span class=\"string\">&#x27;green&#x27;</span>)):</span><br><span class=\"line\">     plt.scatter(Y[y==lab, <span class=\"number\">0</span>],</span><br><span class=\"line\">                Y[y==lab, <span class=\"number\">1</span>],</span><br><span class=\"line\">                label=lab,</span><br><span class=\"line\">                c=col)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Principal Component 1&#x27;</span>)</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Principal Component 2&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;lower center&#x27;</span>)</span><br><span class=\"line\">plt.tight_layout()</span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/PCA_files/PCA_28_0.png\" class=\"lazyload placeholder\" data-srcset=\"/PCA_files/PCA_28_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h1 id=\"利用SK-LEARN-PCA进行降维\"><a href=\"#利用SK-LEARN-PCA进行降维\" class=\"headerlink\" title=\"利用SK-LEARN PCA进行降维\"></a>利用SK-LEARN PCA进行降维</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn <span class=\"keyword\">import</span> datasets</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.decomposition <span class=\"keyword\">import</span> PCA</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1. 加载鸢尾花数据集</span></span><br><span class=\"line\">iris = datasets.load_iris()</span><br><span class=\"line\">X = iris.data</span><br><span class=\"line\">y = iris.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. 数据标准化</span></span><br><span class=\"line\">scaler = StandardScaler()</span><br><span class=\"line\">X_std = scaler.fit_transform(X)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. 应用PCA降维</span></span><br><span class=\"line\">pca = PCA()</span><br><span class=\"line\">X_pca = pca.fit_transform(X_std)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4. 计算特征值总和</span></span><br><span class=\"line\">tot = <span class=\"built_in\">sum</span>(pca.explained_variance_)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5. 计算每个特征值占总和的百分比，并按降序排序</span></span><br><span class=\"line\">var_exp = [(i / tot) * <span class=\"number\">100</span> <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">sorted</span>(pca.explained_variance_, reverse=<span class=\"literal\">True</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6. 输出每个特征值的变异解释百分比</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;变异解释百分比:&quot;</span>, var_exp)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7. 计算累计变异解释百分比</span></span><br><span class=\"line\">cum_var_exp = np.cumsum(var_exp)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8. 输出累计变异解释百分比</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;累计变异解释百分比:&quot;</span>, cum_var_exp)</span><br></pre></td></tr></table></figure>\n\n<pre><code>变异解释百分比: [np.float64(72.96244541329987), np.float64(22.850761786701742), np.float64(3.668921889282886), np.float64(0.5178709107154782)]\n累计变异解释百分比: [ 72.96244541  95.8132072   99.48212909 100.        ]\n</code></pre>\n<p>由上述结果同样可见，前两个特征向量累计贡献的方差为95.81%，故取前2个特征向量。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 应用PCA降维到2个主成分</span></span><br><span class=\"line\">pca = PCA(n_components=<span class=\"number\">2</span>)</span><br><span class=\"line\">X_pca = pca.fit_transform(X_std)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4. 绘制PCA图</span></span><br><span class=\"line\">plt.figure(figsize=(<span class=\"number\">8</span>, <span class=\"number\">6</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 为不同的类别绘制不同颜色的点</span></span><br><span class=\"line\">colors = [<span class=\"string\">&#x27;r&#x27;</span>, <span class=\"string\">&#x27;g&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>]</span><br><span class=\"line\">markers = [<span class=\"string\">&#x27;s&#x27;</span>, <span class=\"string\">&#x27;x&#x27;</span>, <span class=\"string\">&#x27;o&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> idx, color, marker <span class=\"keyword\">in</span> <span class=\"built_in\">zip</span>(<span class=\"built_in\">range</span>(<span class=\"number\">3</span>), colors, markers):</span><br><span class=\"line\">    plt.scatter(x=X_pca[y == idx, <span class=\"number\">0</span>], </span><br><span class=\"line\">                y=X_pca[y == idx, <span class=\"number\">1</span>],</span><br><span class=\"line\">                c=color, </span><br><span class=\"line\">                marker=marker,</span><br><span class=\"line\">                label=iris.target_names[idx])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加标题和标签</span></span><br><span class=\"line\">plt.title(<span class=\"string\">&#x27;PCA of Iris Dataset&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Principal Component 1&#x27;</span>)</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Principal Component 2&#x27;</span>)</span><br><span class=\"line\">plt.legend()</span><br><span class=\"line\">plt.grid(<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示图形</span></span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/PCA_files/PCA_32_0.png\" class=\"lazyload placeholder\" data-srcset=\"/PCA_files/PCA_32_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”，获取更多教程。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"AI","path":"api/categories/AI.json"}],"tags":[{"name":"机器学习","path":"api/tags/机器学习.json"},{"name":"Scikit-learn","path":"api/tags/Scikit-learn.json"}]},{"title":"PyTorch实战-利用卷积神经网络完成手写数字识别","slug":"PyTorch实战-利用卷积神经网络完成手写数字识别","date":"2024-09-01T04:37:55.000Z","updated":"2024-09-01T04:57:42.611Z","comments":true,"path":"api/articles/PyTorch实战-利用卷积神经网络完成手写数字识别.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/mnist.pytorchOK_files/mnist.pytorchOK_5_0.png","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>卷积神经网络（Convolutional Neural Networks, CNNs）是一种特殊类型的神经网络，在图像和视频识别、推荐系统、图像分类、医学图像分析、自然语言处理等领域有着广泛的应用。它们能够自动从原始图像中提取特征，并通过多层网络结构学习这些特征的高级表示。本文通过手写数字识别项目带大家学习卷积神经网络。</p>\n<h1 id=\"卷积神经网络基本概念\"><a href=\"#卷积神经网络基本概念\" class=\"headerlink\" title=\"卷积神经网络基本概念\"></a>卷积神经网络基本概念</h1><h2 id=\"CNN结构\"><a href=\"#CNN结构\" class=\"headerlink\" title=\"CNN结构\"></a>CNN结构</h2><p>输入层（Input Layer）–&gt; {卷积层（Convolutional Layer） –&gt; 池化层（Pooling Layer）–&gt; 卷积层（Convolutional Layer） –&gt; 池化层（Pooling Layer）}(重复) –&gt; 全连接层（Fully Connected Layer）</p>\n<h2 id=\"卷积层\"><a href=\"#卷积层\" class=\"headerlink\" title=\"卷积层\"></a>卷积层</h2><p>在深度学习和计算机视觉中，尤其是在处理卷积神经网络（CNN）时，计算输出尺寸（Output Size）的公式非常重要。您给出的公式是卷积层输出尺寸计算的一个基本公式，但通常我们会用更直观的符号来表示它。下面是该公式转换为常用表示方法的形式：</p>\n<p>$$ O &#x3D; \\left\\lfloor \\frac{I + 2P - K}{S} \\right\\rfloor + 1 $$</p>\n<p>其中：</p>\n<ul>\n<li>$O$ 代表输出尺寸（Output Size），通常是输出特征图的高度或宽度（假设它们是相等的，即正方形特征图）。</li>\n<li>$I$ 代表输入尺寸（Input Size），即输入特征图的高度或宽度。</li>\n<li>$P$ 代表填充（Padding）的大小，即在输入特征图的边界上添加的零的层数。注意，这里的 $2P$ 表示在输入特征图的两侧（或上下两侧，取决于维度）都添加了 $P$ 层的零。</li>\n<li>$K$ 代表卷积核（Kernel Size）的大小，即卷积核的高度或宽度（在正方形卷积核的情况下）。</li>\n<li>$S$ 代表步长（Stride），即卷积核在输入特征图上移动的步数。</li>\n<li>$\\left\\lfloor \\cdot \\right\\rfloor$ 表示向下取整操作，因为像素数必须是整数。</li>\n</ul>\n<p>这个公式适用于计算卷积层（包括标准卷积层和转置卷积层，但转置卷积层有额外的参数和复杂性）后的输出特征图尺寸。在实际应用中，了解如何根据这些参数调整网络结构以得到期望的输出尺寸是非常重要的。</p>\n<h2 id=\"激活函数（Activation-Function）\"><a href=\"#激活函数（Activation-Function）\" class=\"headerlink\" title=\"激活函数（Activation Function）\"></a>激活函数（Activation Function）</h2><p>激活函数用于在卷积层（以及其他类型的神经网络层）之后引入非线性。常见的激活函数包括ReLU（Rectified Linear Unit，修正线性单元）、sigmoid和tanh等。ReLU因其简单性和减少梯度消失问题的能力而在CNN中广泛使用。</p>\n<h2 id=\"池化层\"><a href=\"#池化层\" class=\"headerlink\" title=\"池化层\"></a>池化层</h2><p>池化层（Pooling Layer）在卷积神经网络（CNN）中扮演着重要的角色，主要用于特征融合和降维，以减少计算量和控制过拟合。池化层的输入尺寸和输出尺寸计算公式可以根据不同的参数设置而有所不同，但基本思路是相似的。</p>\n<h3 id=\"池化层的输出尺寸计算公式\"><a href=\"#池化层的输出尺寸计算公式\" class=\"headerlink\" title=\"池化层的输出尺寸计算公式\"></a>池化层的输出尺寸计算公式</h3><p>池化层的输出尺寸计算公式可以表示为：</p>\n<p>$$ O &#x3D; \\left\\lfloor \\frac{I + 2P - F}{S} + 1 \\right\\rfloor $$</p>\n<p>其中：</p>\n<ul>\n<li>$O$ 代表输出尺寸（Output Size），即池化层输出的特征图的高度和宽度。</li>\n<li>$I$ 代表输入尺寸（Input Size），即输入特征图的高度和宽度。</li>\n<li>$F$ 是池化窗口（Pooling Window）的大小，即池化操作覆盖的输入特征图的区域大小。</li>\n<li>$S$ 是步长（Stride），即池化窗口在输入特征图上移动的步数。</li>\n<li>$P$ 是填充（Padding），即在输入特征图的边界上添加的零的层数，用于控制输出尺寸。</li>\n<li>$\\left\\lfloor \\cdot \\right\\rfloor$ 表示向下取整操作，因为像素数必须是整数。</li>\n</ul>\n<h3 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h3><ul>\n<li>池化层通常不涉及权重和偏置参数，因此它们不会影响模型的学习能力，但对于减少计算量和控制过拟合非常有帮助。</li>\n<li>在实际应用中，池化窗口的大小$F$和步长$S$通常设置为相同的值，如2或3，这样可以更有效地降低特征图的维度。</li>\n<li>填充$P$的值可以是0（无填充），也可以是其他正整数（有填充），具体取决于需要保持输出特征图尺寸与输入特征图尺寸的比例关系。</li>\n</ul>\n<h2 id=\"全连接层（Fully-Connected-Layer-FC-Layer）\"><a href=\"#全连接层（Fully-Connected-Layer-FC-Layer）\" class=\"headerlink\" title=\"全连接层（Fully Connected Layer, FC Layer）\"></a>全连接层（Fully Connected Layer, FC Layer）</h2><p>在CNN的末端，通常会有几个全连接层。这些层中的每个神经元都与前一层的所有神经元相连接。全连接层的作用是将前面层学到的“分布式特征表示”映射到样本标记空间。在分类任务中，全连接层的输出可以传递给softmax函数来生成最终的类别概率分布。</p>\n<h2 id=\"参数共享（Parameter-Sharing）\"><a href=\"#参数共享（Parameter-Sharing）\" class=\"headerlink\" title=\"参数共享（Parameter Sharing）\"></a>参数共享（Parameter Sharing）</h2><p>在CNN中，卷积核的参数是在整个输入数据上共享的。这意味着无论数据中的哪个位置，卷积核都使用相同的权重和偏置参数进行卷积操作。这种参数共享机制减少了模型的参数量，并有助于模型学习到输入数据的空间层次结构。</p>\n<h2 id=\"局部连接（Local-Connectivity）\"><a href=\"#局部连接（Local-Connectivity）\" class=\"headerlink\" title=\"局部连接（Local Connectivity）\"></a>局部连接（Local Connectivity）</h2><p>在卷积层中，每个神经元仅与输入数据的一个局部区域（即感受野）相连接，而不是与整个输入数据相连接。这种局部连接机制使得CNN能够学习到数据的局部特征，这与人类视觉系统的处理机制相似。</p>\n<h2 id=\"反向传播（Backpropagation）\"><a href=\"#反向传播（Backpropagation）\" class=\"headerlink\" title=\"反向传播（Backpropagation）\"></a>反向传播（Backpropagation）</h2><p>反向传播算法是训练CNN（以及其他类型的神经网络）的关键算法。在训练过程中，通过计算损失函数关于网络参数的梯度，并利用梯度下降（或其变体）来更新网络参数，以最小化损失函数。反向传播算法通过链式法则在网络的每一层中传播梯度信息。</p>\n<h1 id=\"MNIST数据集介绍\"><a href=\"#MNIST数据集介绍\" class=\"headerlink\" title=\"MNIST数据集介绍\"></a>MNIST数据集介绍</h1><p>在探索机器学习领域的广阔天地时，手写数字识别作为一个经典且基础的任务，始终占据着重要的地位。而MNIST（Modified National Institute of Standards and Technology）数据集，正是这一任务中最常用、最经典的数据集之一。本文将首先介绍MNIST数据集，为后续的手写数字识别模型训练与测试打下坚实的基础。</p>\n<h2 id=\"MNIST数据集概述\"><a href=\"#MNIST数据集概述\" class=\"headerlink\" title=\"MNIST数据集概述\"></a>MNIST数据集概述</h2><p>MNIST数据集由Yann LeCun等人搜集整理，是一个大型的手写体数字数据库。该数据集最初来源于NIST（National Institute of Standards and Technology）的两个数据库：专用数据库1（Special Database 1）和特殊数据库3（Special Database 3）。通过精心筛选与预处理，MNIST最终成为了一个包含大量手写数字图像的标准数据集，广泛应用于各种图像处理系统和机器学习算法的训练与测试中。</p>\n<h2 id=\"数据集的构成\"><a href=\"#数据集的构成\" class=\"headerlink\" title=\"数据集的构成\"></a>数据集的构成</h2><p>MNIST数据集由60,000个训练样本和10,000个测试样本组成，每个样本都是一张<code>28x28</code>像素的灰度图像，表示一个手写数字（0-9）。这些图像均已被归一化，像素值范围在0到255之间，其中<code>0</code>代表黑色，<code>255</code>代表白色。数据集的图像由来自不同人群的手写体构成，包括高中生和美国人口普查局的工作人员，确保了数据的多样性和代表性。</p>\n<h2 id=\"数据集的特点\"><a href=\"#数据集的特点\" class=\"headerlink\" title=\"数据集的特点\"></a>数据集的特点</h2><ol>\n<li><p><strong>简单性</strong>：虽然MNIST数据集包含的手写数字种类繁多，但由于其图像尺寸小（28x28像素）、像素深度低（灰度图像），使得处理起来相对简单。这使其成为机器学习初学者练习图像识别、模式识别等任务的理想选择。</p>\n</li>\n<li><p><strong>代表性</strong>：MNIST数据集中的手写数字覆盖了各种书写风格和变体，使得训练出的模型能够较好地泛化到未知的手写数字上。因此，该数据集在评估机器学习算法性能时具有很高的参考价值。</p>\n</li>\n<li><p><strong>广泛应用</strong>：由于其简单性和代表性，MNIST数据集在机器学习领域得到了广泛应用。从简单的神经网络到复杂的深度学习模型，几乎所有的图像识别算法都会使用MNIST数据集进行训练和测试。</p>\n</li>\n</ol>\n<h2 id=\"数据集的下载与使用\"><a href=\"#数据集的下载与使用\" class=\"headerlink\" title=\"数据集的下载与使用\"></a>数据集的下载与使用</h2><p>MNIST数据集可以通过多种途径下载，其中最常用的方式是通过互联网直接下载。用户可以从Yann LeCun的官方网站（<a href=\"http://yann.lecun.com/exdb/mnist/%EF%BC%89%E6%88%96%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%85%B1%E4%BA%AB%E5%B9%B3%E5%8F%B0%E8%8E%B7%E5%8F%96%E8%AF%A5%E6%95%B0%E6%8D%AE%E9%9B%86%E3%80%82%E4%B8%8B%E8%BD%BD%E5%90%8E%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%E9%80%9A%E5%B8%B8%E5%8C%85%E5%90%AB%E5%9B%9B%E4%B8%AA%E6%96%87%E4%BB%B6%EF%BC%9A%E8%AE%AD%E7%BB%83%E9%9B%86%E5%9B%BE%E5%83%8F%E3%80%81%E8%AE%AD%E7%BB%83%E9%9B%86%E6%A0%87%E7%AD%BE%E3%80%81%E6%B5%8B%E8%AF%95%E9%9B%86%E5%9B%BE%E5%83%8F%E5%92%8C%E6%B5%8B%E8%AF%95%E9%9B%86%E6%A0%87%E7%AD%BE%E3%80%82%E8%BF%99%E4%BA%9B%E6%96%87%E4%BB%B6%E5%9D%87%E4%B8%BA%E5%8E%8B%E7%BC%A9%E6%A0%BC%E5%BC%8F%EF%BC%8C%E7%94%A8%E6%88%B7%E9%9C%80%E8%A6%81%E8%A7%A3%E5%8E%8B%E5%90%8E%E6%89%8D%E8%83%BD%E4%BD%BF%E7%94%A8%E3%80%82\">http://yann.lecun.com/exdb/mnist/）或其他数据共享平台获取该数据集。下载后的数据集通常包含四个文件：训练集图像、训练集标签、测试集图像和测试集标签。这些文件均为压缩格式，用户需要解压后才能使用。</a></p>\n<p>在使用MNIST数据集时，用户需要根据自己的需求进行预处理和加载操作。例如，可以使用Python的NumPy库或Pandas库来读取和处理数据集中的图像和标签信息；也可以使用深度学习框架（如TensorFlow、PyTorch等）中提供的数据加载工具来简化这一过程。</p>\n<h1 id=\"下载并导入数据集\"><a href=\"#下载并导入数据集\" class=\"headerlink\" title=\"下载并导入数据集\"></a>下载并导入数据集</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 导入必要的库</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> torch</span><br><span class=\"line\"><span class=\"keyword\">import</span> torch.nn <span class=\"keyword\">as</span> nn</span><br><span class=\"line\"><span class=\"keyword\">import</span> torch.optim <span class=\"keyword\">as</span> optim</span><br><span class=\"line\"><span class=\"keyword\">from</span> torchvision <span class=\"keyword\">import</span> datasets, transforms</span><br><span class=\"line\"><span class=\"keyword\">from</span> torch.utils.data <span class=\"keyword\">import</span> DataLoader</span><br><span class=\"line\"><span class=\"keyword\">import</span> torch.nn.functional <span class=\"keyword\">as</span> F</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 数据预处理</span></span><br><span class=\"line\"><span class=\"comment\"># 使用Compose组合多个变换，这里将数据转换为张量并进行标准化</span></span><br><span class=\"line\">transform = transforms.Compose([</span><br><span class=\"line\">    transforms.ToTensor(),</span><br><span class=\"line\">    transforms.Normalize((<span class=\"number\">0.5</span>,), (<span class=\"number\">0.5</span>,))</span><br><span class=\"line\">])</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 下载MNIST数据集并划分为训练集和测试集</span></span><br><span class=\"line\">train_dataset = datasets.MNIST(root=<span class=\"string\">&#x27;./data&#x27;</span>, train=<span class=\"literal\">True</span>, download=<span class=\"literal\">True</span>, transform=transform)</span><br><span class=\"line\">test_dataset = datasets.MNIST(root=<span class=\"string\">&#x27;./data&#x27;</span>, train=<span class=\"literal\">False</span>, download=<span class=\"literal\">True</span>, transform=transform)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>查看训练集属性：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看整个训练集的样本数量及单个样本的形状</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;训练集大小: <span class=\"subst\">&#123;<span class=\"built_in\">len</span>(train_dataset)&#125;</span>&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># 查看第一个样本的数据和标签</span></span><br><span class=\"line\">first_sample, first_label = train_dataset[<span class=\"number\">0</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;首个样本数据形状: <span class=\"subst\">&#123;first_sample.shape&#125;</span>&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;首个样本标签: <span class=\"subst\">&#123;first_label&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果想查看前几个样本的具体数据内容，可以通过循环实现</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">5</span>):</span><br><span class=\"line\">    data, label = train_dataset[i]</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&quot;样本 <span class=\"subst\">&#123;i+<span class=\"number\">1</span>&#125;</span> 的数据:\\n<span class=\"subst\">&#123;data&#125;</span>\\n标签: <span class=\"subst\">&#123;label&#125;</span>\\n&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>训练集大小: 60000\n首个样本数据形状: torch.Size([1, 28, 28])\n首个样本标签: 5\n样本 1 的数据:\ntensor([[[-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.9765, -0.8588,\n          -0.8588, -0.8588, -0.0118,  0.0667,  0.3725, -0.7961,  0.3020,\n           1.0000,  0.9373, -0.0039, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.7647, -0.7176, -0.2627,  0.2078,  0.3333,  0.9843,\n           0.9843,  0.9843,  0.9843,  0.9843,  0.7647,  0.3490,  0.9843,\n           0.8980,  0.5294, -0.4980, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.6157,  0.8667,  0.9843,  0.9843,  0.9843,  0.9843,  0.9843,\n           0.9843,  0.9843,  0.9843,  0.9686, -0.2706, -0.3569, -0.3569,\n          -0.5608, -0.6941, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.8588,  0.7176,  0.9843,  0.9843,  0.9843,  0.9843,  0.9843,\n           0.5529,  0.4275,  0.9373,  0.8902, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.3725,  0.2235, -0.1608,  0.9843,  0.9843,  0.6078,\n          -0.9137, -1.0000, -0.6627,  0.2078, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.8902, -0.9922,  0.2078,  0.9843, -0.2941,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000,  0.0902,  0.9843,  0.4902,\n          -0.9843, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.9137,  0.4902,  0.9843,\n          -0.4510, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.7255,  0.8902,\n           0.7647,  0.2549, -0.1529, -0.9922, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3647,\n           0.8824,  0.9843,  0.9843, -0.0667, -0.8039, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.6471,  0.4588,  0.9843,  0.9843,  0.1765, -0.7882, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.8745, -0.2706,  0.9765,  0.9843,  0.4667, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.9529,  0.9843,  0.9529, -0.4980,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.6392,  0.0196,  0.4353,  0.9843,  0.9843,  0.6235, -0.9843,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.6941,  0.1608,\n           0.7961,  0.9843,  0.9843,  0.9843,  0.9608,  0.4275, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.8118, -0.1059,  0.7333,  0.9843,\n           0.9843,  0.9843,  0.9843,  0.5765, -0.3882, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.8196, -0.4824,  0.6706,  0.9843,  0.9843,  0.9843,\n           0.9843,  0.5529, -0.3647, -0.9843, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.8588,\n           0.3412,  0.7176,  0.9843,  0.9843,  0.9843,  0.9843,  0.5294,\n          -0.3725, -0.9294, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -0.5686,  0.3490,  0.7725,\n           0.9843,  0.9843,  0.9843,  0.9843,  0.9137,  0.0431, -0.9137,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000,  0.0667,  0.9843,  0.9843,\n           0.9843,  0.6627,  0.0588,  0.0353, -0.8745, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000]]])\n标签: 5\n\n样本 2 的数据:\ntensor([[[-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.6000,  0.2471,  0.9843,  0.2471, -0.6078, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.6235,  0.8667,  0.9765,  0.9765,  0.9765,  0.8588, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.5765,\n           0.7804,  0.9843,  0.9765,  0.8745,  0.8275,  0.9765, -0.5529,\n          -0.9529, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.9216, -0.5294,  0.7569,\n           0.9765,  0.9843,  0.9765,  0.5843, -0.3412,  0.9765,  0.9843,\n          -0.0431, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000,  0.2784,  0.9765,  0.9765,\n           0.9765,  0.9843,  0.9765,  0.9765, -0.2471,  0.4824,  0.9843,\n           0.3098, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.6000,  0.8667,  0.9843,  0.9843,\n           0.4902, -0.1059,  0.9843,  0.7882, -0.6314, -0.3804,  1.0000,\n           0.3176, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.6235,  0.8667,  0.9765,  0.9765,  0.4039,\n          -0.9059, -0.4118, -0.0510, -0.8353, -1.0000, -1.0000,  0.9843,\n           0.9059, -0.6078, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.7020,  0.2941,  0.9843,  0.8275,  0.6314, -0.3412,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.9843,\n           0.9765,  0.2941, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.9451,  0.3961,  0.9765,  0.8824, -0.4431, -0.8510, -0.7804,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.9843,\n           0.9765,  0.5294, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.5529,  0.9765,  0.9765, -0.5059, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.9843,\n           0.9765,  0.5294, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n           0.5529,  0.9843,  0.4902, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  1.0000,\n           0.9843,  0.5373, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.4039,\n           0.9294,  0.9765, -0.1216, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.9843,\n           0.9765,  0.1608, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3333,\n           0.9765,  0.8039, -0.8039, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.9451,  0.0588,  0.9843,\n           0.4588, -0.9059, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3333,\n           0.9765,  0.7490, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.9451,  0.0275,  0.9765,  0.7647,\n          -0.4431, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3333,\n           0.9765,  0.1373, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.6235,  0.2941,  0.9765,  0.3569, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3255,\n           0.9843,  0.7647, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.1059,  0.8667,  0.9843,  0.2706, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3333,\n           0.9765,  0.9529,  0.1451, -0.6235, -0.7725, -0.3333,  0.3961,\n           0.7647,  0.9843,  0.7490,  0.3098, -0.5608, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3333,\n           0.9765,  0.9765,  0.9765,  0.7961,  0.6863,  0.9765,  0.9765,\n           0.9765,  0.5373,  0.0196, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.7804,\n           0.5608,  0.9765,  0.9765,  0.9843,  0.9765,  0.9765,  0.8275,\n           0.1373, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.8039,  0.0039,  0.9765,  0.9843,  0.9765,  0.1059, -0.7098,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000]]])\n标签: 0\n\n样本 3 的数据:\ntensor([[[-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.4745,\n           0.8196, -0.6941, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -0.5137, -0.3647, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.0588,\n           0.4118, -0.6941, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -0.0118,  0.2784, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.9843,  0.2000,\n           0.6471, -0.6863, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000,  0.7255,  0.2784, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.7882,  0.9922,\n           0.2706, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000,  0.7412,  0.2784, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.4353,  0.9922,\n          -0.0196, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -0.6392,  0.9216,  0.2784, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,  0.5529,  0.9922,\n          -0.5608, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -0.0588,  0.9922,  0.2784, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.8196,  0.8118,  0.9922,\n          -0.7725, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000,  0.2471,  0.9922, -0.0588, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000,  0.2784,  0.9922,  0.6941,\n          -0.8745, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000,  0.2471,  0.9922, -0.4745, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.8902, -0.3255,  0.3961,  0.9451,  0.9922, -0.2863,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000,  0.2471,  0.9922, -0.3333, -1.0000,\n          -1.0000, -1.0000, -0.6314, -0.6157, -0.0902,  0.1294,  0.1765,\n           0.8902,  0.9059,  0.8353,  0.4039,  0.8902,  0.9765, -0.6863,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000,  0.1765,  0.9843,  0.8588,  0.6235,\n           0.6235,  0.6235,  0.9843,  0.9922,  0.9608,  0.8824,  0.5529,\n           0.1216, -0.2863, -0.7804, -0.9608,  0.8275,  0.9608, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -0.0667,  0.3882,  0.3882,\n           0.3882,  0.3882,  0.3882, -0.2314, -0.5608, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.2000,  0.9922,  0.7255, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  0.9922,  0.0745, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  0.9922, -0.5529, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  0.9922, -0.5529, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  1.0000, -0.2627, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  0.9922, -0.2471, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  0.9922,  0.2000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.3255,  1.0000,  0.2000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.2471,  0.9922,  0.2000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000]]])\n标签: 4\n\n样本 4 的数据:\ntensor([[[-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.0275,  0.9843,  1.0000,\n          -0.5059, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.2471,  0.9137,  0.9686,  0.9843,\n          -0.5137, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.0039,  0.9686,  0.9686,  0.9843,\n          -0.5137, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.4667,  0.8510,  0.9686,  0.6549, -0.7569,\n          -0.9373, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.5294,  0.7882,  0.9686,  0.9686, -0.2627, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000,  0.2157,  0.9843,  0.9843,  0.4824, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.8431,  0.9843,  0.9686,  0.8431, -0.4824, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.7490,\n           0.6078,  0.9843,  0.9686, -0.0118, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.1843,\n           0.9686,  0.9843,  0.4431, -0.8824, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.3725,  0.8824,\n           0.9686,  0.5137, -0.8196, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.7490,  0.9843,  0.9843,\n           0.9843,  0.2471, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000,  0.1843,  0.9686,  0.9686,\n           0.9686, -0.6941, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -0.6235,  0.7333,  0.9686,  0.9686,\n           0.3490, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.8353,  0.9686,  0.9686,  0.5373,\n          -0.9059, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000,  0.9843,  0.9686,  0.9686, -0.3020,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000,  0.2471,  1.0000,  0.9843,  0.9843, -0.7569,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.6235,  0.7882,  0.9843,  0.9373,  0.0980, -0.9373,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.4980,  0.9686,  0.9843,  0.7255, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.4980,  0.9686,  0.9843,  0.7255, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.8118,  0.5137,  0.9843,  0.7255, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000]]])\n标签: 1\n\n样本 5 的数据:\ntensor([[[-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.5686,  0.1608,\n           0.6471,  0.9843,  0.9843, -0.1137, -0.3176,  0.1608, -0.5686,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -0.3176,  0.8196,  0.9765,\n           0.9843,  0.4824,  0.6471,  0.9765,  0.9765,  0.9843,  0.3176,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.9686, -0.5529,  0.8980,  0.9765,  0.4902,\n          -0.4902, -0.9608, -0.9059,  0.4275,  0.9765,  0.9843, -0.0902,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -0.2471,  0.9765,  0.9765,  0.4353, -0.8902,\n          -1.0000, -1.0000, -0.2784,  0.9765,  0.9765,  0.7647, -0.8353,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000,  0.0353,  0.9843,  0.9765,  0.1451, -0.8902, -1.0000,\n          -1.0000, -1.0000,  0.6863,  0.9765,  0.9765, -0.3804, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.0118,  0.9843,  0.9373,  0.3804, -0.9294, -1.0000, -1.0000,\n          -0.9373, -0.3882,  0.9216,  0.9843,  0.0118, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.8745,\n           0.8196,  0.9765,  0.3804, -1.0000, -1.0000, -1.0000, -0.7176,\n           0.5765,  0.9765,  0.9765,  0.3255, -0.9137, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.8275,\n           0.9765,  0.9765, -0.7647, -0.8275, -0.0667,  0.5451,  0.8902,\n           0.9843,  0.9765,  0.9686, -0.3961, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.8745,\n           0.8118,  0.9765,  0.9843,  0.9765,  0.9765,  0.9765,  0.7725,\n           0.7804,  0.9765,  0.8118, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.5686,  0.8431,  0.9843,  0.7020,  0.0824, -0.6706, -0.8118,\n           0.5059,  0.9765,  0.1216, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.5137,\n           1.0000,  0.9843, -0.1451, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.4431,\n           0.9843,  0.9765, -0.8353, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n           0.9843,  0.9765, -0.8353, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.4431,\n           0.9843,  0.9765, -0.8353, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.1686,\n           0.9843,  0.9765, -0.8353, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -0.6471,\n           1.0000,  0.9843, -0.8353, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n           0.7098,  0.9765, -0.5608, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.2471,  0.9765,  0.4824, -0.6706, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -0.8902,  0.4431,  0.9765,  0.3333, -0.9137, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -0.8902,  0.1529,  0.9765, -0.6706, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000],\n         [-1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000,\n          -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000, -1.0000]]])\n标签: 9\n</code></pre>\n<p>展示训练集中的第一幅图片：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取第一个样本的数据和标签</span></span><br><span class=\"line\">first_image, first_label = train_dataset[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将图像数据从形状 (1, 28, 28) 转换为 (28, 28)，以便显示</span></span><br><span class=\"line\">first_image = first_image.squeeze().numpy()  <span class=\"comment\"># 去除通道维度，并转换为numpy数组</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 显示图像</span></span><br><span class=\"line\">plt.imshow(first_image, cmap=<span class=\"string\">&#x27;gray&#x27;</span>)  <span class=\"comment\"># 使用灰度色阶显示图像</span></span><br><span class=\"line\">plt.title(<span class=\"string\">f&#x27;Label: <span class=\"subst\">&#123;first_label&#125;</span>&#x27;</span>)  <span class=\"comment\"># 显示图像标签作为标题</span></span><br><span class=\"line\">plt.axis(<span class=\"string\">&#x27;off&#x27;</span>)  <span class=\"comment\"># 不显示坐标轴</span></span><br><span class=\"line\">plt.show()</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/mnist.pytorchOK_files/mnist.pytorchOK_5_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/mnist.pytorchOK_files/mnist.pytorchOK_5_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取第一个样本的数据</span></span><br><span class=\"line\">first_image, _ = train_dataset[<span class=\"number\">0</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将张量转换为numpy数组以便打印</span></span><br><span class=\"line\">first_image_np = first_image.numpy()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 打印原始的三维数组（包含通道维度）</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;原始图像数据（包含通道维度）:&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(first_image_np)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>原始图像数据（包含通道维度）:\n[[[-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -0.9764706  -0.85882354 -0.85882354\n   -0.85882354 -0.01176471  0.06666672  0.37254906 -0.79607844\n    0.30196083  1.          0.9372549  -0.00392157 -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -0.7647059  -0.7176471\n   -0.26274508  0.20784318  0.33333337  0.9843137   0.9843137\n    0.9843137   0.9843137   0.9843137   0.7647059   0.34901965\n    0.9843137   0.8980392   0.5294118  -0.4980392  -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -0.6156863   0.8666667   0.9843137\n    0.9843137   0.9843137   0.9843137   0.9843137   0.9843137\n    0.9843137   0.9843137   0.96862745 -0.27058822 -0.35686272\n   -0.35686272 -0.56078434 -0.69411767 -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -0.85882354  0.7176471   0.9843137\n    0.9843137   0.9843137   0.9843137   0.9843137   0.5529412\n    0.427451    0.9372549   0.8901961  -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -0.372549    0.22352946\n   -0.1607843   0.9843137   0.9843137   0.60784316 -0.9137255\n   -1.         -0.6627451   0.20784318 -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -0.8901961\n   -0.99215686  0.20784318  0.9843137  -0.29411763 -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.          0.09019613  0.9843137   0.4901961  -0.9843137\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -0.9137255   0.4901961   0.9843137  -0.45098037\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -0.7254902   0.8901961   0.7647059\n    0.254902   -0.15294117 -0.99215686 -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -0.36470586  0.88235295\n    0.9843137   0.9843137  -0.06666666 -0.8039216  -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -0.64705884\n    0.45882356  0.9843137   0.9843137   0.17647064 -0.7882353\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -0.8745098  -0.27058822  0.9764706   0.9843137   0.4666667\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.          0.9529412   0.9843137   0.9529412\n   -0.4980392  -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -0.6392157\n    0.0196079   0.43529415  0.9843137   0.9843137   0.62352943\n   -0.9843137  -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -0.69411767  0.16078436  0.79607844\n    0.9843137   0.9843137   0.9843137   0.9607843   0.427451\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -0.8117647  -0.10588235  0.73333335  0.9843137   0.9843137\n    0.9843137   0.9843137   0.5764706  -0.38823527 -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -0.81960785 -0.4823529\n    0.67058825  0.9843137   0.9843137   0.9843137   0.9843137\n    0.5529412  -0.36470586 -0.9843137  -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -0.85882354  0.3411765   0.7176471   0.9843137\n    0.9843137   0.9843137   0.9843137   0.5294118  -0.372549\n   -0.92941177 -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -0.5686275\n    0.34901965  0.77254903  0.9843137   0.9843137   0.9843137\n    0.9843137   0.9137255   0.04313731 -0.9137255  -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.          0.06666672\n    0.9843137   0.9843137   0.9843137   0.6627451   0.05882359\n    0.03529418 -0.8745098  -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]\n  [-1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.         -1.         -1.\n   -1.         -1.         -1.        ]]]\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果你想去掉通道维度，打印二维矩阵</span></span><br><span class=\"line\">first_image_2d = first_image_np.squeeze()  <span class=\"comment\"># 去掉通道维度</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&quot;\\n去掉通道后的二维矩阵:&quot;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(first_image_2d)</span><br></pre></td></tr></table></figure>\n\n<pre><code>去掉通道后的二维矩阵:\n[[-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -0.9764706  -0.85882354 -0.85882354 -0.85882354 -0.01176471  0.06666672\n   0.37254906 -0.79607844  0.30196083  1.          0.9372549  -0.00392157\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -0.7647059  -0.7176471  -0.26274508  0.20784318\n   0.33333337  0.9843137   0.9843137   0.9843137   0.9843137   0.9843137\n   0.7647059   0.34901965  0.9843137   0.8980392   0.5294118  -0.4980392\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -0.6156863   0.8666667   0.9843137   0.9843137   0.9843137\n   0.9843137   0.9843137   0.9843137   0.9843137   0.9843137   0.96862745\n  -0.27058822 -0.35686272 -0.35686272 -0.56078434 -0.69411767 -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -0.85882354  0.7176471   0.9843137   0.9843137   0.9843137\n   0.9843137   0.9843137   0.5529412   0.427451    0.9372549   0.8901961\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -0.372549    0.22352946 -0.1607843   0.9843137\n   0.9843137   0.60784316 -0.9137255  -1.         -0.6627451   0.20784318\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -0.8901961  -0.99215686  0.20784318\n   0.9843137  -0.29411763 -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.          0.09019613\n   0.9843137   0.4901961  -0.9843137  -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -0.9137255\n   0.4901961   0.9843137  -0.45098037 -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -0.7254902   0.8901961   0.7647059   0.254902   -0.15294117 -0.99215686\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -0.36470586  0.88235295  0.9843137   0.9843137  -0.06666666\n  -0.8039216  -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -0.64705884  0.45882356  0.9843137   0.9843137\n   0.17647064 -0.7882353  -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -0.8745098  -0.27058822  0.9764706\n   0.9843137   0.4666667  -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.          0.9529412\n   0.9843137   0.9529412  -0.4980392  -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -0.6392157   0.0196079   0.43529415  0.9843137\n   0.9843137   0.62352943 -0.9843137  -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -0.69411767  0.16078436  0.79607844  0.9843137   0.9843137   0.9843137\n   0.9607843   0.427451   -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -0.8117647  -0.10588235\n   0.73333335  0.9843137   0.9843137   0.9843137   0.9843137   0.5764706\n  -0.38823527 -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -0.81960785 -0.4823529   0.67058825  0.9843137\n   0.9843137   0.9843137   0.9843137   0.5529412  -0.36470586 -0.9843137\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -0.85882354  0.3411765   0.7176471   0.9843137   0.9843137   0.9843137\n   0.9843137   0.5294118  -0.372549   -0.92941177 -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -0.5686275   0.34901965\n   0.77254903  0.9843137   0.9843137   0.9843137   0.9843137   0.9137255\n   0.04313731 -0.9137255  -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.          0.06666672  0.9843137\n   0.9843137   0.9843137   0.6627451   0.05882359  0.03529418 -0.8745098\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]\n [-1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.         -1.         -1.\n  -1.         -1.         -1.         -1.        ]]\n</code></pre>\n<h1 id=\"定义模型、优化器、损失函数\"><a href=\"#定义模型、优化器、损失函数\" class=\"headerlink\" title=\"定义模型、优化器、损失函数\"></a>定义模型、优化器、损失函数</h1><p>进行2次卷积和2次池化，得到64<em>7</em>17，再进行2次全连接，得到10个输出。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义批次大小</span></span><br><span class=\"line\">batch_size = <span class=\"number\">64</span></span><br><span class=\"line\"><span class=\"comment\"># 使用DataLoader加载数据，以便在训练过程中更方便地迭代数据</span></span><br><span class=\"line\">train_loader = DataLoader(train_dataset, batch_size=batch_size, shuffle=<span class=\"literal\">True</span>)</span><br><span class=\"line\">test_loader = DataLoader(test_dataset, batch_size=batch_size, shuffle=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义模型</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Net</span>(nn.Module):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"built_in\">super</span>(Net, self).__init__()</span><br><span class=\"line\">        <span class=\"comment\"># 初始化卷积层、池化层、全连接层和dropout层</span></span><br><span class=\"line\">        <span class=\"comment\"># 定义第一个卷积层，用于提取特征</span></span><br><span class=\"line\">        <span class=\"comment\"># 输入通道数为1（适用于灰度图像），输出通道数为32，卷积核大小为5x5，步长为1，padding为2</span></span><br><span class=\"line\">        <span class=\"comment\"># 第一次卷积后生成的特征图大小为32*28*28</span></span><br><span class=\"line\">        self.conv1 = nn.Conv2d(<span class=\"number\">1</span>, <span class=\"number\">32</span>, kernel_size=<span class=\"number\">5</span>, stride=<span class=\"number\">1</span>, padding=<span class=\"number\">2</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\"># 定义最大池化层，用于降低特征维度，减少计算量</span></span><br><span class=\"line\">        <span class=\"comment\"># 池化窗口大小为2x2，步长为2，无padding</span></span><br><span class=\"line\">        <span class=\"comment\"># 第一次池化后生成的特征图大小为32*14*14</span></span><br><span class=\"line\">        self.pool = nn.MaxPool2d(kernel_size=<span class=\"number\">2</span>, stride=<span class=\"number\">2</span>, padding=<span class=\"number\">0</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\"># 定义第二个卷积层，进一步提取和整合特征</span></span><br><span class=\"line\">        <span class=\"comment\"># 输入通道数为32，输出通道数为64，卷积核大小为5x5，步长为1，padding为2</span></span><br><span class=\"line\">        <span class=\"comment\"># 第二次卷积后生成的特征图大小为64*14*14</span></span><br><span class=\"line\">        self.conv2 = nn.Conv2d(<span class=\"number\">32</span>, <span class=\"number\">64</span>, kernel_size=<span class=\"number\">5</span>, stride=<span class=\"number\">1</span>, padding=<span class=\"number\">2</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\"># 定义第一个全连接层，用于分类前的特征转换</span></span><br><span class=\"line\">        <span class=\"comment\"># 输入大小为64*7*7（这里的尺寸为64*7*7是因为在前向传播时对第二次卷积进行了池化操作），输出大小为1024</span></span><br><span class=\"line\">        self.fc1 = nn.Linear(<span class=\"number\">64</span> * <span class=\"number\">7</span> * <span class=\"number\">7</span>, <span class=\"number\">1024</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\"># 定义第二个全连接层，用于最终的分类输出</span></span><br><span class=\"line\">        <span class=\"comment\"># 输入大小为1024，输出大小为10（假设分类任务有10个类别）</span></span><br><span class=\"line\">        self.fc2 = nn.Linear(<span class=\"number\">1024</span>, <span class=\"number\">10</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 定义Dropout层，用于训练过程中的正则化，防止过拟合</span></span><br><span class=\"line\">        <span class=\"comment\"># Dropout比例为0.5，即在训练过程中随机将50%的元素置为0</span></span><br><span class=\"line\">        self.dropout = nn.Dropout(p=<span class=\"number\">0.5</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">forward</span>(<span class=\"params\">self, x</span>):</span><br><span class=\"line\">        <span class=\"comment\"># 定义前向传播过程</span></span><br><span class=\"line\">        x = self.pool(F.relu(self.conv1(x)))</span><br><span class=\"line\">        x = self.pool(F.relu(self.conv2(x)))</span><br><span class=\"line\">        x = x.view(-<span class=\"number\">1</span>, <span class=\"number\">64</span> * <span class=\"number\">7</span> * <span class=\"number\">7</span>)</span><br><span class=\"line\">        x = F.relu(self.fc1(x))</span><br><span class=\"line\">        x = self.dropout(x)</span><br><span class=\"line\">        x = self.fc2(x)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> x</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 实例化模型</span></span><br><span class=\"line\">model = Net()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义优化器</span></span><br><span class=\"line\"><span class=\"comment\"># 使用Adam优化器更新模型参数</span></span><br><span class=\"line\">optimizer = optim.Adam(model.parameters(), lr=<span class=\"number\">1e-4</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义损失函数</span></span><br><span class=\"line\"><span class=\"comment\"># 使用交叉熵损失函数进行分类任务</span></span><br><span class=\"line\">criterion = nn.CrossEntropyLoss()</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"训练模型\"><a href=\"#训练模型\" class=\"headerlink\" title=\"训练模型\"></a>训练模型</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将模型转移到GPU设备上（如果可用）</span></span><br><span class=\"line\">device = torch.device(<span class=\"string\">&quot;cuda&quot;</span> <span class=\"keyword\">if</span> torch.cuda.is_available() <span class=\"keyword\">else</span> <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\">model.to(device)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义训练轮数</span></span><br><span class=\"line\">num_epochs = <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"comment\"># 开始训练过程</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> epoch <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(num_epochs):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i, (images, labels) <span class=\"keyword\">in</span> <span class=\"built_in\">enumerate</span>(train_loader):</span><br><span class=\"line\">        <span class=\"comment\"># 将数据转移到GPU设备上（如果可用）</span></span><br><span class=\"line\">        images, labels = images.to(device), labels.to(device)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 前向传播</span></span><br><span class=\"line\">        outputs = model(images)</span><br><span class=\"line\">        loss = criterion(outputs, labels)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 反向传播和优化</span></span><br><span class=\"line\">        optimizer.zero_grad()</span><br><span class=\"line\">        loss.backward()</span><br><span class=\"line\">        optimizer.step()</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># 打印损失信息</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (i + <span class=\"number\">1</span>) % <span class=\"number\">100</span> == <span class=\"number\">0</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">f&#x27;Epoch [<span class=\"subst\">&#123;epoch + <span class=\"number\">1</span>&#125;</span>/<span class=\"subst\">&#123;num_epochs&#125;</span>], Step [<span class=\"subst\">&#123;i + <span class=\"number\">1</span>&#125;</span>/<span class=\"subst\">&#123;<span class=\"built_in\">len</span>(train_loader)&#125;</span>], Loss: <span class=\"subst\">&#123;loss.item():<span class=\"number\">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存模型参数到文件</span></span><br><span class=\"line\">torch.save(model.state_dict(), <span class=\"string\">&#x27;model.pth&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Epoch [1/10], Step [100/938], Loss: 0.0037\nEpoch [1/10], Step [200/938], Loss: 0.0029\nEpoch [1/10], Step [300/938], Loss: 0.0022\nEpoch [1/10], Step [400/938], Loss: 0.0651\nEpoch [1/10], Step [500/938], Loss: 0.0038\nEpoch [1/10], Step [600/938], Loss: 0.0022\nEpoch [1/10], Step [700/938], Loss: 0.0079\nEpoch [1/10], Step [800/938], Loss: 0.0019\nEpoch [1/10], Step [900/938], Loss: 0.0016\nEpoch [2/10], Step [100/938], Loss: 0.0016\nEpoch [2/10], Step [200/938], Loss: 0.0102\nEpoch [2/10], Step [300/938], Loss: 0.0341\nEpoch [2/10], Step [400/938], Loss: 0.0060\nEpoch [2/10], Step [500/938], Loss: 0.0257\nEpoch [2/10], Step [600/938], Loss: 0.0013\nEpoch [2/10], Step [700/938], Loss: 0.0767\nEpoch [2/10], Step [800/938], Loss: 0.0018\nEpoch [2/10], Step [900/938], Loss: 0.0343\nEpoch [3/10], Step [100/938], Loss: 0.0063\nEpoch [3/10], Step [200/938], Loss: 0.0096\nEpoch [3/10], Step [300/938], Loss: 0.0007\nEpoch [3/10], Step [400/938], Loss: 0.0002\nEpoch [3/10], Step [500/938], Loss: 0.0124\nEpoch [3/10], Step [600/938], Loss: 0.0109\nEpoch [3/10], Step [700/938], Loss: 0.0340\nEpoch [3/10], Step [800/938], Loss: 0.0004\nEpoch [3/10], Step [900/938], Loss: 0.0586\nEpoch [4/10], Step [100/938], Loss: 0.0002\nEpoch [4/10], Step [200/938], Loss: 0.0554\nEpoch [4/10], Step [300/938], Loss: 0.0008\nEpoch [4/10], Step [400/938], Loss: 0.0029\nEpoch [4/10], Step [500/938], Loss: 0.0036\nEpoch [4/10], Step [600/938], Loss: 0.0009\nEpoch [4/10], Step [700/938], Loss: 0.0281\nEpoch [4/10], Step [800/938], Loss: 0.0826\nEpoch [4/10], Step [900/938], Loss: 0.0003\nEpoch [5/10], Step [100/938], Loss: 0.0001\nEpoch [5/10], Step [200/938], Loss: 0.0240\nEpoch [5/10], Step [300/938], Loss: 0.0040\nEpoch [5/10], Step [400/938], Loss: 0.0003\nEpoch [5/10], Step [500/938], Loss: 0.0107\nEpoch [5/10], Step [600/938], Loss: 0.0019\nEpoch [5/10], Step [700/938], Loss: 0.0002\nEpoch [5/10], Step [800/938], Loss: 0.0006\nEpoch [5/10], Step [900/938], Loss: 0.0008\nEpoch [6/10], Step [100/938], Loss: 0.0003\nEpoch [6/10], Step [200/938], Loss: 0.0001\nEpoch [6/10], Step [300/938], Loss: 0.0003\nEpoch [6/10], Step [400/938], Loss: 0.0226\nEpoch [6/10], Step [500/938], Loss: 0.0024\nEpoch [6/10], Step [600/938], Loss: 0.0020\nEpoch [6/10], Step [700/938], Loss: 0.0005\nEpoch [6/10], Step [800/938], Loss: 0.0007\nEpoch [6/10], Step [900/938], Loss: 0.0188\nEpoch [7/10], Step [100/938], Loss: 0.0286\nEpoch [7/10], Step [200/938], Loss: 0.0007\nEpoch [7/10], Step [300/938], Loss: 0.0004\nEpoch [7/10], Step [400/938], Loss: 0.0008\nEpoch [7/10], Step [500/938], Loss: 0.0001\nEpoch [7/10], Step [600/938], Loss: 0.0006\nEpoch [7/10], Step [700/938], Loss: 0.0005\nEpoch [7/10], Step [800/938], Loss: 0.0007\nEpoch [7/10], Step [900/938], Loss: 0.0432\nEpoch [8/10], Step [100/938], Loss: 0.0005\nEpoch [8/10], Step [200/938], Loss: 0.0005\nEpoch [8/10], Step [300/938], Loss: 0.0000\nEpoch [8/10], Step [400/938], Loss: 0.0013\nEpoch [8/10], Step [500/938], Loss: 0.0005\nEpoch [8/10], Step [600/938], Loss: 0.0002\nEpoch [8/10], Step [700/938], Loss: 0.0004\nEpoch [8/10], Step [800/938], Loss: 0.0111\nEpoch [8/10], Step [900/938], Loss: 0.0001\nEpoch [9/10], Step [100/938], Loss: 0.0004\nEpoch [9/10], Step [200/938], Loss: 0.0693\nEpoch [9/10], Step [300/938], Loss: 0.0071\nEpoch [9/10], Step [400/938], Loss: 0.0000\nEpoch [9/10], Step [500/938], Loss: 0.0003\nEpoch [9/10], Step [600/938], Loss: 0.0003\nEpoch [9/10], Step [700/938], Loss: 0.0001\nEpoch [9/10], Step [800/938], Loss: 0.0000\nEpoch [9/10], Step [900/938], Loss: 0.0029\nEpoch [10/10], Step [100/938], Loss: 0.0008\nEpoch [10/10], Step [200/938], Loss: 0.0001\nEpoch [10/10], Step [300/938], Loss: 0.0000\nEpoch [10/10], Step [400/938], Loss: 0.0273\nEpoch [10/10], Step [500/938], Loss: 0.0001\nEpoch [10/10], Step [600/938], Loss: 0.0002\nEpoch [10/10], Step [700/938], Loss: 0.0010\nEpoch [10/10], Step [800/938], Loss: 0.0019\nEpoch [10/10], Step [900/938], Loss: 0.0000\n</code></pre>\n<h1 id=\"评估模型\"><a href=\"#评估模型\" class=\"headerlink\" title=\"评估模型\"></a>评估模型</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 实例化一个与原模型结构相同的模型</span></span><br><span class=\"line\">model = Net().to(device)  <span class=\"comment\"># 确保模型被放置在正确的设备上</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载模型参数</span></span><br><span class=\"line\">model.load_state_dict(torch.load(<span class=\"string\">&#x27;model.pth&#x27;</span>, map_location=device, weights_only=<span class=\"literal\">True</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将模型设置为评估模式</span></span><br><span class=\"line\">model.<span class=\"built_in\">eval</span>()</span><br><span class=\"line\"><span class=\"comment\"># 禁用梯度计算以减少内存消耗</span></span><br><span class=\"line\"><span class=\"keyword\">with</span> torch.no_grad():</span><br><span class=\"line\">    correct = <span class=\"number\">0</span></span><br><span class=\"line\">    total = <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"comment\"># 在测试集上进行预测</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> images, labels <span class=\"keyword\">in</span> test_loader:</span><br><span class=\"line\">        images, labels = images.to(device), labels.to(device)</span><br><span class=\"line\">        outputs = model(images)</span><br><span class=\"line\">        _, predicted = torch.<span class=\"built_in\">max</span>(outputs.data, <span class=\"number\">1</span>)</span><br><span class=\"line\">        total += labels.size(<span class=\"number\">0</span>)</span><br><span class=\"line\">        correct += (predicted == labels).<span class=\"built_in\">sum</span>().item()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 打印测试集上的准确率</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">f&#x27;Test Accuracy of the model on the <span class=\"subst\">&#123;total&#125;</span> test images: <span class=\"subst\">&#123;<span class=\"number\">100</span> * correct / total&#125;</span>%&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Test Accuracy of the model on the 10000 test images: 99.29%\n</code></pre>\n<h1 id=\"代码获取\"><a href=\"#代码获取\" class=\"headerlink\" title=\"代码获取\"></a>代码获取</h1><p>关注公众号“生信之巅”，聊天窗口回复“a7fe”获取完整版代码下载链接。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"AI","path":"api/categories/AI.json"}],"tags":[{"name":"机器学习","path":"api/tags/机器学习.json"},{"name":"深度学习","path":"api/tags/深度学习.json"},{"name":"PyTorch","path":"api/tags/PyTorch.json"},{"name":"卷积神经网络","path":"api/tags/卷积神经网络.json"}]},{"title":"Scikit-learn机器学习实战-HumanResourcesAnalytics","slug":"Scikit-learn机器学习实战-HumanResourcesAnalytics","date":"2024-08-30T14:24:05.000Z","updated":"2024-08-30T14:59:29.868Z","comments":true,"path":"api/articles/Scikit-learn机器学习实战-HumanResourcesAnalytics.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_10_0.png","content":"<h1 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h1><p>本文构建预测员工是否会离职的模型，并使用模型对员工进行预测。通过本文可以学习到：</p>\n<ul>\n<li>查看数据集的统计信息</li>\n<li>特征工程</li>\n<li>数据集的划分</li>\n<li>数据集的预处理</li>\n<li>数据集的可视化</li>\n<li>模型训练</li>\n<li>模型调参</li>\n<li>模型评估</li>\n<li>模型预测</li>\n</ul>\n<h1 id=\"查看数据集信息\"><a href=\"#查看数据集信息\" class=\"headerlink\" title=\"查看数据集信息\"></a>查看数据集信息</h1><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入数据</span></span><br><span class=\"line\">url = <span class=\"string\">&#x27;https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/data/ML/HumanResourcesAnalytics/HR_comma_sep.csv&#x27;</span></span><br><span class=\"line\">df = pd.read_csv(url)</span><br><span class=\"line\"><span class=\"comment\">#df = pd.read_csv(&#x27;HR_comma_sep.csv&#x27;)</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(df.info()) <span class=\"comment\">#474241623</span></span><br><span class=\"line\">df.head()</span><br></pre></td></tr></table></figure>\n\n<pre><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;\nRangeIndex: 14999 entries, 0 to 14998\nData columns (total 10 columns):\n #   Column                 Non-Null Count  Dtype  \n---  ------                 --------------  -----  \n 0   satisfaction_level     14999 non-null  float64\n 1   last_evaluation        14999 non-null  float64\n 2   number_project         14999 non-null  int64  \n 3   average_montly_hours   14999 non-null  int64  \n 4   time_spend_company     14999 non-null  int64  \n 5   Work_accident          14999 non-null  int64  \n 6   left                   14999 non-null  int64  \n 7   promotion_last_5years  14999 non-null  int64  \n 8   sales                  14999 non-null  object \n 9   salary                 14999 non-null  object \ndtypes: float64(2), int64(6), object(2)\nmemory usage: 1.1+ MB\nNone\n</code></pre>\n<div style=\"overflow-x: auto; width: 100%;\">\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n</head>\n<body>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>satisfaction_level</th>\n      <th>last_evaluation</th>\n      <th>number_project</th>\n      <th>average_montly_hours</th>\n      <th>time_spend_company</th>\n      <th>Work_accident</th>\n      <th>left</th>\n      <th>promotion_last_5years</th>\n      <th>sales</th>\n      <th>salary</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0.38</td>\n      <td>0.53</td>\n      <td>2</td>\n      <td>157</td>\n      <td>3</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0.80</td>\n      <td>0.86</td>\n      <td>5</td>\n      <td>262</td>\n      <td>6</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>medium</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0.11</td>\n      <td>0.88</td>\n      <td>7</td>\n      <td>272</td>\n      <td>4</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>medium</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0.72</td>\n      <td>0.87</td>\n      <td>5</td>\n      <td>223</td>\n      <td>5</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0.37</td>\n      <td>0.52</td>\n      <td>2</td>\n      <td>159</td>\n      <td>3</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<p><strong>header 信息</strong></p>\n<ul>\n<li>satisfaction_level\t员工满意度</li>\n<li>last_evaluation\t员工考核评分</li>\n<li>number_project\t员工参与的项目数</li>\n<li>average_montly_hours\t每个月均工作时长</li>\n<li>time_spend_company\t员工工作年限</li>\n<li>Work_accident\t是否发生过事故</li>\n<li>left\t员工是否离职</li>\n<li>promotion_last_5years\t过去5年中是否有升职</li>\n<li>sales\t员工岗位</li>\n<li>salary 员工薪资水平</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 更正列名</span></span><br><span class=\"line\">df.rename(columns=&#123;<span class=\"string\">&#x27;average_montly_hours&#x27;</span>:<span class=\"string\">&#x27;average_monthly_hours&#x27;</span>, <span class=\"string\">&#x27;sales&#x27;</span>:<span class=\"string\">&#x27;department&#x27;</span>&#125;, </span><br><span class=\"line\">          inplace=<span class=\"literal\">True</span>)</span><br><span class=\"line\">df.head()</span><br></pre></td></tr></table></figure>\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>satisfaction_level</th>\n      <th>last_evaluation</th>\n      <th>number_project</th>\n      <th>average_monthly_hours</th>\n      <th>time_spend_company</th>\n      <th>Work_accident</th>\n      <th>left</th>\n      <th>promotion_last_5years</th>\n      <th>department</th>\n      <th>salary</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0.38</td>\n      <td>0.53</td>\n      <td>2</td>\n      <td>157</td>\n      <td>3</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0.80</td>\n      <td>0.86</td>\n      <td>5</td>\n      <td>262</td>\n      <td>6</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>medium</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0.11</td>\n      <td>0.88</td>\n      <td>7</td>\n      <td>272</td>\n      <td>4</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>medium</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0.72</td>\n      <td>0.87</td>\n      <td>5</td>\n      <td>223</td>\n      <td>5</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0.37</td>\n      <td>0.52</td>\n      <td>2</td>\n      <td>159</td>\n      <td>3</td>\n      <td>0</td>\n      <td>1</td>\n      <td>0</td>\n      <td>sales</td>\n      <td>low</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 展示数据集的统计信息，仅展示数值列</span></span><br><span class=\"line\">df.describe()</span><br></pre></td></tr></table></figure>\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>satisfaction_level</th>\n      <th>last_evaluation</th>\n      <th>number_project</th>\n      <th>average_monthly_hours</th>\n      <th>time_spend_company</th>\n      <th>Work_accident</th>\n      <th>left</th>\n      <th>promotion_last_5years</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>count</th>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n      <td>14999.000000</td>\n    </tr>\n    <tr>\n      <th>mean</th>\n      <td>0.612834</td>\n      <td>0.716102</td>\n      <td>3.803054</td>\n      <td>201.050337</td>\n      <td>3.498233</td>\n      <td>0.144610</td>\n      <td>0.238083</td>\n      <td>0.021268</td>\n    </tr>\n    <tr>\n      <th>std</th>\n      <td>0.248631</td>\n      <td>0.171169</td>\n      <td>1.232592</td>\n      <td>49.943099</td>\n      <td>1.460136</td>\n      <td>0.351719</td>\n      <td>0.425924</td>\n      <td>0.144281</td>\n    </tr>\n    <tr>\n      <th>min</th>\n      <td>0.090000</td>\n      <td>0.360000</td>\n      <td>2.000000</td>\n      <td>96.000000</td>\n      <td>2.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>25%</th>\n      <td>0.440000</td>\n      <td>0.560000</td>\n      <td>3.000000</td>\n      <td>156.000000</td>\n      <td>3.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>50%</th>\n      <td>0.640000</td>\n      <td>0.720000</td>\n      <td>4.000000</td>\n      <td>200.000000</td>\n      <td>3.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>75%</th>\n      <td>0.820000</td>\n      <td>0.870000</td>\n      <td>5.000000</td>\n      <td>245.000000</td>\n      <td>4.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n      <td>0.000000</td>\n    </tr>\n    <tr>\n      <th>max</th>\n      <td>1.000000</td>\n      <td>1.000000</td>\n      <td>7.000000</td>\n      <td>310.000000</td>\n      <td>10.000000</td>\n      <td>1.000000</td>\n      <td>1.000000</td>\n      <td>1.000000</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各元素的出现次数</span></span><br><span class=\"line\"><span class=\"built_in\">print</span> (<span class=\"string\">&#x27;Departments:&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (df[<span class=\"string\">&#x27;department&#x27;</span>].value_counts())</span><br><span class=\"line\"><span class=\"built_in\">print</span> (<span class=\"string\">&#x27;\\nSalary:&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (df[<span class=\"string\">&#x27;salary&#x27;</span>].value_counts())</span><br></pre></td></tr></table></figure>\n\n<pre><code>Departments:\ndepartment\nsales          4140\ntechnical      2720\nsupport        2229\nIT             1227\nproduct_mng     902\nmarketing       858\nRandD           787\naccounting      767\nhr              739\nmanagement      630\nName: count, dtype: int64\n\nSalary:\nsalary\nlow       7316\nmedium    6446\nhigh      1237\nName: count, dtype: int64\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 记录各特征的类型和取值范围</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">satisfaction_level | Satisfaction level of employee based on survey | Continuous | [0.09, 1]</span></span><br><span class=\"line\"><span class=\"string\">last_evaluation | Score based on employee&#x27;s last evaluation | Continuous | [0.36, 1]</span></span><br><span class=\"line\"><span class=\"string\">number_project | Number of projects | Continuous | [2, 7]</span></span><br><span class=\"line\"><span class=\"string\">average_monthly_hours | Average monthly hours | Continuous | [96, 310]</span></span><br><span class=\"line\"><span class=\"string\">time_spend_company | Years at company | Continuous | [2, 10]</span></span><br><span class=\"line\"><span class=\"string\">Work_accident | Whether employee had a work accident | Categorical | &#123;0, 1&#125;</span></span><br><span class=\"line\"><span class=\"string\">left | Whether employee had left (Outcome Variable) | Categorical | &#123;0, 1&#125;</span></span><br><span class=\"line\"><span class=\"string\">promotion_last_5years | Whether employee had a promotion in the last 5 years | Categorical | &#123;0, 1&#125;</span></span><br><span class=\"line\"><span class=\"string\">department | Department employee worked in | Categorical | 10 departments</span></span><br><span class=\"line\"><span class=\"string\">salary | Level of employee&#x27;s salary | Categorical | &#123;low, medium, high&#125;</span></span><br><span class=\"line\"><span class=\"string\">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;\\nsatisfaction_level | Satisfaction level of employee based on survey | Continuous | [0.09, 1]\\nlast_evaluation | Score based on employee&#x27;s last evaluation | Continuous | [0.36, 1]\\nnumber_project | Number of projects | Continuous | [2, 7]\\naverage_monthly_hours | Average monthly hours | Continuous | [96, 310]\\ntime_spend_company | Years at company | Continuous | [2, 10]\\nWork_accident | Whether employee had a work accident | Categorical | &#123;0, 1&#125;\\nleft | Whether employee had left (Outcome Variable) | Categorical | &#123;0, 1&#125;\\npromotion_last_5years | Whether employee had a promotion in the last 5 years | Categorical | &#123;0, 1&#125;\\ndepartment | Department employee worked in | Categorical | 10 departments\\nsalary | Level of employee&#x27;s salary | Categorical | &#123;low, medium, high&#125;\\n&quot;</span><br></pre></td></tr></table></figure>\n\n\n<h1 id=\"特征工程\"><a href=\"#特征工程\" class=\"headerlink\" title=\"特征工程\"></a>特征工程</h1><ul>\n<li>查找相关性大的特征，只保留其中的一个。</li>\n<li>也可查看与标签（left）相关性较大的特征，如此数据集中的<code>satisfaction_level</code>。</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 筛选 DataFrame 中的所有数值列</span></span><br><span class=\"line\">numeric_df = df.select_dtypes(include=[np.number])</span><br><span class=\"line\"><span class=\"comment\"># 计算数值列之间的相关系数</span></span><br><span class=\"line\">numeric_df.corr()</span><br></pre></td></tr></table></figure>\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>satisfaction_level</th>\n      <th>last_evaluation</th>\n      <th>number_project</th>\n      <th>average_monthly_hours</th>\n      <th>time_spend_company</th>\n      <th>Work_accident</th>\n      <th>left</th>\n      <th>promotion_last_5years</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>satisfaction_level</th>\n      <td>1.000000</td>\n      <td>0.105021</td>\n      <td>-0.142970</td>\n      <td>-0.020048</td>\n      <td>-0.100866</td>\n      <td>0.058697</td>\n      <td>-0.388375</td>\n      <td>0.025605</td>\n    </tr>\n    <tr>\n      <th>last_evaluation</th>\n      <td>0.105021</td>\n      <td>1.000000</td>\n      <td>0.349333</td>\n      <td>0.339742</td>\n      <td>0.131591</td>\n      <td>-0.007104</td>\n      <td>0.006567</td>\n      <td>-0.008684</td>\n    </tr>\n    <tr>\n      <th>number_project</th>\n      <td>-0.142970</td>\n      <td>0.349333</td>\n      <td>1.000000</td>\n      <td>0.417211</td>\n      <td>0.196786</td>\n      <td>-0.004741</td>\n      <td>0.023787</td>\n      <td>-0.006064</td>\n    </tr>\n    <tr>\n      <th>average_monthly_hours</th>\n      <td>-0.020048</td>\n      <td>0.339742</td>\n      <td>0.417211</td>\n      <td>1.000000</td>\n      <td>0.127755</td>\n      <td>-0.010143</td>\n      <td>0.071287</td>\n      <td>-0.003544</td>\n    </tr>\n    <tr>\n      <th>time_spend_company</th>\n      <td>-0.100866</td>\n      <td>0.131591</td>\n      <td>0.196786</td>\n      <td>0.127755</td>\n      <td>1.000000</td>\n      <td>0.002120</td>\n      <td>0.144822</td>\n      <td>0.067433</td>\n    </tr>\n    <tr>\n      <th>Work_accident</th>\n      <td>0.058697</td>\n      <td>-0.007104</td>\n      <td>-0.004741</td>\n      <td>-0.010143</td>\n      <td>0.002120</td>\n      <td>1.000000</td>\n      <td>-0.154622</td>\n      <td>0.039245</td>\n    </tr>\n    <tr>\n      <th>left</th>\n      <td>-0.388375</td>\n      <td>0.006567</td>\n      <td>0.023787</td>\n      <td>0.071287</td>\n      <td>0.144822</td>\n      <td>-0.154622</td>\n      <td>1.000000</td>\n      <td>-0.061788</td>\n    </tr>\n    <tr>\n      <th>promotion_last_5years</th>\n      <td>0.025605</td>\n      <td>-0.008684</td>\n      <td>-0.006064</td>\n      <td>-0.003544</td>\n      <td>0.067433</td>\n      <td>0.039245</td>\n      <td>-0.061788</td>\n      <td>1.000000</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">import</span> seaborn <span class=\"keyword\">as</span> sns</span><br><span class=\"line\">%matplotlib inline</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看离职员工部门分布，发现HR离职员工最多</span></span><br><span class=\"line\">plot = sns.catplot(x=<span class=\"string\">&#x27;department&#x27;</span>, y=<span class=\"string\">&#x27;left&#x27;</span>, kind=<span class=\"string\">&#x27;bar&#x27;</span>, data=df)</span><br><span class=\"line\">plot.set_xticklabels(rotation=<span class=\"number\">45</span>, horizontalalignment=<span class=\"string\">&#x27;right&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_10_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_10_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看工资水平和离职率的关系</span></span><br><span class=\"line\">plot = sns.catplot(x=<span class=\"string\">&#x27;salary&#x27;</span>, y=<span class=\"string\">&#x27;left&#x27;</span>, kind=<span class=\"string\">&#x27;bar&#x27;</span>, data=df);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_11_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_11_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看经理工资水平分布</span></span><br><span class=\"line\">df[df[<span class=\"string\">&#x27;department&#x27;</span>]==<span class=\"string\">&#x27;management&#x27;</span>][<span class=\"string\">&#x27;salary&#x27;</span>].value_counts().plot(kind=<span class=\"string\">&#x27;pie&#x27;</span>, title=<span class=\"string\">&#x27;Management salary level distribution&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_12_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_12_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看研发工资水平分布</span></span><br><span class=\"line\">df[df[<span class=\"string\">&#x27;department&#x27;</span>]==<span class=\"string\">&#x27;RandD&#x27;</span>][<span class=\"string\">&#x27;salary&#x27;</span>].value_counts().plot(kind=<span class=\"string\">&#x27;pie&#x27;</span>, title=<span class=\"string\">&#x27;R&amp;D dept salary level distribution&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_13_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_13_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 绘制员工满意度分布的直方图，并分为两类员工：已离职和未离职</span></span><br><span class=\"line\"><span class=\"comment\"># 生成21个等间距的数值作为直方图的区间，范围从0.0001到1.0001</span></span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">0.0001</span>, <span class=\"number\">1.0001</span>, <span class=\"number\">21</span>)</span><br><span class=\"line\"><span class=\"comment\"># 绘制直方图。首先筛选出已离职员工（df[&#x27;left&#x27;]==1）和未离职员工（df[&#x27;left&#x27;]==0）的满意度数据，使用指定的区间（bins）、透明度（alpha）和标签（label）进行绘制。</span></span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">1</span>][<span class=\"string\">&#x27;satisfaction_level&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.7</span>, label=<span class=\"string\">&#x27;Employees Left&#x27;</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">0</span>][<span class=\"string\">&#x27;satisfaction_level&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.5</span>, label=<span class=\"string\">&#x27;Employees Stayed&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;satisfaction_level&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\"># 设置x轴的显示范围从0到1.05</span></span><br><span class=\"line\">plt.xlim((<span class=\"number\">0</span>,<span class=\"number\">1.05</span>))</span><br><span class=\"line\"><span class=\"comment\"># 在最合适的位置添加图例</span></span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_14_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_14_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>发现已离职员工对公司的满意度比较低（0~0.5），当然也存在满意度较高（0.8附近）的员工离职的情况。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Last evaluation</span></span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">0.3501</span>, <span class=\"number\">1.0001</span>, <span class=\"number\">14</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">1</span>][<span class=\"string\">&#x27;last_evaluation&#x27;</span>], bins=bins, alpha=<span class=\"number\">1</span>, label=<span class=\"string\">&#x27;Employees Left&#x27;</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">0</span>][<span class=\"string\">&#x27;last_evaluation&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.4</span>, label=<span class=\"string\">&#x27;Employees Stayed&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;last_evaluation&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_16_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_16_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>公司评分高（0.8~1.0）的员工离职了很多，原因可能是这部分员工能力强，跳槽寻求更好的工作机会。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Number of projects </span></span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">1.5</span>, <span class=\"number\">7.5</span>, <span class=\"number\">7</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">1</span>][<span class=\"string\">&#x27;number_project&#x27;</span>], bins=bins, alpha=<span class=\"number\">1</span>, label=<span class=\"string\">&#x27;Employees Left&#x27;</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">0</span>][<span class=\"string\">&#x27;number_project&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.4</span>, label=<span class=\"string\">&#x27;Employees Stayed&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;number_project&#x27;</span>)</span><br><span class=\"line\">plt.grid(axis=<span class=\"string\">&#x27;x&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_18_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_18_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>项目少时离职了，可能因为员工锻炼机会少。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Average monthly hours</span></span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">75</span>, <span class=\"number\">325</span>, <span class=\"number\">11</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">1</span>][<span class=\"string\">&#x27;average_monthly_hours&#x27;</span>], bins=bins, alpha=<span class=\"number\">1</span>, label=<span class=\"string\">&#x27;Employees Left&#x27;</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">0</span>][<span class=\"string\">&#x27;average_monthly_hours&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.4</span>, label=<span class=\"string\">&#x27;Employees Stayed&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;average_monthly_hours&#x27;</span>)</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_20_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_20_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>工作时长少和多都容易离职。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Years at company </span></span><br><span class=\"line\">bins = np.linspace(<span class=\"number\">1.5</span>, <span class=\"number\">10.5</span>, <span class=\"number\">10</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">1</span>][<span class=\"string\">&#x27;time_spend_company&#x27;</span>], bins=bins, alpha=<span class=\"number\">1</span>, label=<span class=\"string\">&#x27;Employees Left&#x27;</span>)</span><br><span class=\"line\">plt.hist(df[df[<span class=\"string\">&#x27;left&#x27;</span>]==<span class=\"number\">0</span>][<span class=\"string\">&#x27;time_spend_company&#x27;</span>], bins=bins, alpha=<span class=\"number\">0.4</span>, label=<span class=\"string\">&#x27;Employees Stayed&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;time_spend_company&#x27;</span>)</span><br><span class=\"line\">plt.xlim((<span class=\"number\">1</span>,<span class=\"number\">11</span>))</span><br><span class=\"line\">plt.grid(axis=<span class=\"string\">&#x27;x&#x27;</span>)</span><br><span class=\"line\">plt.xticks(np.arange(<span class=\"number\">2</span>,<span class=\"number\">11</span>))</span><br><span class=\"line\">plt.legend(loc=<span class=\"string\">&#x27;best&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_22_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_22_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>工作年限3年，离职率最高。年限越长，离职率越低。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># whether employee had work accident</span></span><br><span class=\"line\">plot = sns.catplot(x=<span class=\"string\">&#x27;Work_accident&#x27;</span>, y=<span class=\"string\">&#x27;left&#x27;</span>, kind=<span class=\"string\">&#x27;bar&#x27;</span>, data=df);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_24_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_24_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>未发生工作事故的离职率较高，难以解释。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#whether employee had promotion in last 5 years</span></span><br><span class=\"line\">plot = sns.catplot(x=<span class=\"string\">&#x27;promotion_last_5years&#x27;</span>, y=<span class=\"string\">&#x27;left&#x27;</span>, kind=<span class=\"string\">&#x27;bar&#x27;</span>, data=df);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_26_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_26_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p>不升职的离职率较高。</p>\n<h1 id=\"数据预处理\"><a href=\"#数据预处理\" class=\"headerlink\" title=\"数据预处理\"></a>数据预处理</h1><h2 id=\"独热编码替换分类数据\"><a href=\"#独热编码替换分类数据\" class=\"headerlink\" title=\"独热编码替换分类数据\"></a>独热编码替换分类数据</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 丢弃标签（left）列</span></span><br><span class=\"line\">X = df.drop(<span class=\"string\">&#x27;left&#x27;</span>, axis=<span class=\"number\">1</span>)</span><br><span class=\"line\"><span class=\"comment\"># 提取标签列</span></span><br><span class=\"line\">y = df[<span class=\"string\">&#x27;left&#x27;</span>]</span><br><span class=\"line\"><span class=\"comment\"># 删除部门与工资列，后面会通过独热编码将信息添加回来</span></span><br><span class=\"line\">X.drop([<span class=\"string\">&#x27;department&#x27;</span>,<span class=\"string\">&#x27;salary&#x27;</span>], axis=<span class=\"number\">1</span>, inplace=<span class=\"literal\">True</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># One-hot encoding</span></span><br><span class=\"line\"><span class=\"comment\"># 对工资进行独热编码</span></span><br><span class=\"line\">salary_dummy = pd.get_dummies(df[<span class=\"string\">&#x27;salary&#x27;</span>])</span><br><span class=\"line\"><span class=\"comment\"># 对部门进行独热编码</span></span><br><span class=\"line\">department_dummy = pd.get_dummies(df[<span class=\"string\">&#x27;department&#x27;</span>])</span><br><span class=\"line\">X = pd.concat([X, salary_dummy], axis=<span class=\"number\">1</span>)</span><br><span class=\"line\">X = pd.concat([X, department_dummy], axis=<span class=\"number\">1</span>)</span><br><span class=\"line\">X.head()</span><br></pre></td></tr></table></figure>\n\n<div style=\"overflow-x: auto; width: 100%;\">\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>satisfaction_level</th>\n      <th>last_evaluation</th>\n      <th>number_project</th>\n      <th>average_monthly_hours</th>\n      <th>time_spend_company</th>\n      <th>Work_accident</th>\n      <th>promotion_last_5years</th>\n      <th>high</th>\n      <th>low</th>\n      <th>medium</th>\n      <th>IT</th>\n      <th>RandD</th>\n      <th>accounting</th>\n      <th>hr</th>\n      <th>management</th>\n      <th>marketing</th>\n      <th>product_mng</th>\n      <th>sales</th>\n      <th>support</th>\n      <th>technical</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>0.38</td>\n      <td>0.53</td>\n      <td>2</td>\n      <td>157</td>\n      <td>3</td>\n      <td>0</td>\n      <td>0</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>0.80</td>\n      <td>0.86</td>\n      <td>5</td>\n      <td>262</td>\n      <td>6</td>\n      <td>0</td>\n      <td>0</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>0.11</td>\n      <td>0.88</td>\n      <td>7</td>\n      <td>272</td>\n      <td>4</td>\n      <td>0</td>\n      <td>0</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>0.72</td>\n      <td>0.87</td>\n      <td>5</td>\n      <td>223</td>\n      <td>5</td>\n      <td>0</td>\n      <td>0</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>0.37</td>\n      <td>0.52</td>\n      <td>2</td>\n      <td>159</td>\n      <td>3</td>\n      <td>0</td>\n      <td>0</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>False</td>\n      <td>True</td>\n      <td>False</td>\n      <td>False</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<h2 id=\"拆分训练集和测试集\"><a href=\"#拆分训练集和测试集\" class=\"headerlink\" title=\"拆分训练集和测试集\"></a>拆分训练集和测试集</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 划分训练集和测试集 (70%/30%)</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> train_test_split</span><br><span class=\"line\"></span><br><span class=\"line\">X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class=\"number\">0.3</span>)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据标准化\"><a href=\"#数据标准化\" class=\"headerlink\" title=\"数据标准化\"></a>数据标准化</h2><ul>\n<li>比较大的数值，算法会认为其比较重要，导致结果不准确。</li>\n<li>数值差异比较大的话，模型收敛较慢。</li>\n<li>因此，需要将数据标准化。</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 数据标准化，这里是一个例子</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\">stdsc = StandardScaler()</span><br><span class=\"line\">X_example = np.array([[ <span class=\"number\">10.</span>, -<span class=\"number\">2.</span>,  <span class=\"number\">23.</span>],</span><br><span class=\"line\">                      [ <span class=\"number\">5.</span>,  <span class=\"number\">32.</span>,  <span class=\"number\">211.</span>],</span><br><span class=\"line\">                      [ <span class=\"number\">10.</span>,  <span class=\"number\">1.</span>, -<span class=\"number\">130.</span>]])</span><br><span class=\"line\">X_example = stdsc.fit_transform(X_example)</span><br><span class=\"line\">X_example = pd.DataFrame(X_example)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (X_example)</span><br><span class=\"line\">X_example.describe()</span><br></pre></td></tr></table></figure>\n\n<pre><code>          0         1         2\n0  0.707107 -0.802454 -0.083658\n1 -1.414214  1.409716  1.264429\n2  0.707107 -0.607262 -1.180771\n</code></pre>\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>0</th>\n      <th>1</th>\n      <th>2</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>count</th>\n      <td>3.000000e+00</td>\n      <td>3.000000e+00</td>\n      <td>3.000000e+00</td>\n    </tr>\n    <tr>\n      <th>mean</th>\n      <td>-2.960595e-16</td>\n      <td>-1.110223e-16</td>\n      <td>7.401487e-17</td>\n    </tr>\n    <tr>\n      <th>std</th>\n      <td>1.224745e+00</td>\n      <td>1.224745e+00</td>\n      <td>1.224745e+00</td>\n    </tr>\n    <tr>\n      <th>min</th>\n      <td>-1.414214e+00</td>\n      <td>-8.024539e-01</td>\n      <td>-1.180771e+00</td>\n    </tr>\n    <tr>\n      <th>25%</th>\n      <td>-3.535534e-01</td>\n      <td>-7.048582e-01</td>\n      <td>-6.322145e-01</td>\n    </tr>\n    <tr>\n      <th>50%</th>\n      <td>7.071068e-01</td>\n      <td>-6.072624e-01</td>\n      <td>-8.365788e-02</td>\n    </tr>\n    <tr>\n      <th>75%</th>\n      <td>7.071068e-01</td>\n      <td>4.012270e-01</td>\n      <td>5.903856e-01</td>\n    </tr>\n    <tr>\n      <th>max</th>\n      <td>7.071068e-01</td>\n      <td>1.409716e+00</td>\n      <td>1.264429e+00</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 分别对训练集和测试集进行标准化</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\"></span><br><span class=\"line\">stdsc = StandardScaler()</span><br><span class=\"line\"><span class=\"comment\"># transform our training features</span></span><br><span class=\"line\">X_train_std = stdsc.fit_transform(X_train)</span><br><span class=\"line\"><span class=\"built_in\">print</span> (X_train_std[<span class=\"number\">0</span>])</span><br><span class=\"line\"><span class=\"comment\"># transform the testing features in the same way</span></span><br><span class=\"line\">X_test_std = stdsc.transform(X_test)</span><br></pre></td></tr></table></figure>\n\n<pre><code>[ 1.40697692 -0.21068428 -0.65422416 -1.37529896 -1.02172591 -0.41080801\n -0.14595719 -0.30564365 -0.98084819  1.16499228 -0.2981308  -0.23781569\n -0.22665375 -0.23057496 -0.21332806 -0.24641294 -0.25073288  1.62416352\n -0.41712208 -0.47247431]\n</code></pre>\n<h1 id=\"构建模型\"><a href=\"#构建模型\" class=\"headerlink\" title=\"构建模型\"></a>构建模型</h1><h2 id=\"随机森林法\"><a href=\"#随机森林法\" class=\"headerlink\" title=\"随机森林法\"></a>随机森林法</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 交叉验证（Cross validation）</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> ShuffleSplit</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进行20折交叉验证</span></span><br><span class=\"line\">cv = ShuffleSplit(n_splits=<span class=\"number\">20</span>, test_size=<span class=\"number\">0.3</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 构建随机森林模型</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.ensemble <span class=\"keyword\">import</span> RandomForestClassifier</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.model_selection <span class=\"keyword\">import</span> GridSearchCV</span><br><span class=\"line\">rf_model = RandomForestClassifier()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置RF模型，建立树的数量</span></span><br><span class=\"line\">rf_param = &#123;<span class=\"string\">&#x27;n_estimators&#x27;</span>: <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">11</span>)&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 探索模型参数（最佳树的个数）</span></span><br><span class=\"line\">rf_grid = GridSearchCV(rf_model, rf_param, cv=cv)</span><br><span class=\"line\">rf_grid.fit(X_train, y_train)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出最佳参数和最佳得分</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Parameter with best score:&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(rf_grid.best_params_)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Cross validation score:&#x27;</span>, rf_grid.best_score_)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Parameter with best score:\n&#123;&#39;n_estimators&#39;: 9&#125;\nCross validation score: 0.9835079365079364\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在测试集上评估模型</span></span><br><span class=\"line\">best_rf = rf_grid.best_estimator_</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">&#x27;Test score:&#x27;</span>, best_rf.score(X_test, y_test))</span><br></pre></td></tr></table></figure>\n\n<pre><code>Test score: 0.9884444444444445\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过随机森林查看特征的重要性，原理是每次打乱一个特征（或添加噪音），然后看预测结果（错误率）是否发生变化，如果变化大，则该特征对预测结果有影响，否则没有影响</span></span><br><span class=\"line\">features = X.columns</span><br><span class=\"line\">feature_importances = best_rf.feature_importances_</span><br><span class=\"line\"></span><br><span class=\"line\">features_df = pd.DataFrame(&#123;<span class=\"string\">&#x27;Features&#x27;</span>: features, <span class=\"string\">&#x27;Importance Score&#x27;</span>: feature_importances&#125;)</span><br><span class=\"line\">features_df.sort_values(<span class=\"string\">&#x27;Importance Score&#x27;</span>, inplace=<span class=\"literal\">True</span>, ascending=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">features_df</span><br></pre></td></tr></table></figure>\n\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n<pre><code>.dataframe tbody tr th &#123;\n    vertical-align: top;\n&#125;\n\n.dataframe thead th &#123;\n    text-align: right;\n&#125;\n</code></pre>\n<p></style></p>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Features</th>\n      <th>Importance Score</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>satisfaction_level</td>\n      <td>0.260366</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>average_monthly_hours</td>\n      <td>0.186585</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>number_project</td>\n      <td>0.179788</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>time_spend_company</td>\n      <td>0.179571</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>last_evaluation</td>\n      <td>0.144083</td>\n    </tr>\n    <tr>\n      <th>5</th>\n      <td>Work_accident</td>\n      <td>0.011949</td>\n    </tr>\n    <tr>\n      <th>8</th>\n      <td>low</td>\n      <td>0.006395</td>\n    </tr>\n    <tr>\n      <th>7</th>\n      <td>high</td>\n      <td>0.005206</td>\n    </tr>\n    <tr>\n      <th>9</th>\n      <td>medium</td>\n      <td>0.003336</td>\n    </tr>\n    <tr>\n      <th>17</th>\n      <td>sales</td>\n      <td>0.003200</td>\n    </tr>\n    <tr>\n      <th>18</th>\n      <td>support</td>\n      <td>0.003070</td>\n    </tr>\n    <tr>\n      <th>19</th>\n      <td>technical</td>\n      <td>0.003039</td>\n    </tr>\n    <tr>\n      <th>11</th>\n      <td>RandD</td>\n      <td>0.002143</td>\n    </tr>\n    <tr>\n      <th>10</th>\n      <td>IT</td>\n      <td>0.002048</td>\n    </tr>\n    <tr>\n      <th>12</th>\n      <td>accounting</td>\n      <td>0.001887</td>\n    </tr>\n    <tr>\n      <th>6</th>\n      <td>promotion_last_5years</td>\n      <td>0.001799</td>\n    </tr>\n    <tr>\n      <th>14</th>\n      <td>management</td>\n      <td>0.001755</td>\n    </tr>\n    <tr>\n      <th>13</th>\n      <td>hr</td>\n      <td>0.001425</td>\n    </tr>\n    <tr>\n      <th>16</th>\n      <td>product_mng</td>\n      <td>0.001182</td>\n    </tr>\n    <tr>\n      <th>15</th>\n      <td>marketing</td>\n      <td>0.001173</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 计算前五项特征的重要性之和</span></span><br><span class=\"line\">features_df[<span class=\"string\">&#x27;Importance Score&#x27;</span>][:<span class=\"number\">5</span>].<span class=\"built_in\">sum</span>()</span><br></pre></td></tr></table></figure>\n\n<pre><code>np.float64(0.9503925098929926)\n</code></pre>\n<h2 id=\"基于聚类模型的分析\"><a href=\"#基于聚类模型的分析\" class=\"headerlink\" title=\"基于聚类模型的分析\"></a>基于聚类模型的分析</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">import</span> seaborn <span class=\"keyword\">as</span> sns</span><br><span class=\"line\">%matplotlib inline</span><br><span class=\"line\"></span><br><span class=\"line\">data = pd.read_csv(url)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plt.figure(figsize = (<span class=\"number\">8</span>,<span class=\"number\">8</span>))</span><br><span class=\"line\">plt.subplot(<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">1</span>)</span><br><span class=\"line\">plt.plot(data.satisfaction_level[data.left == <span class=\"number\">1</span>],data.last_evaluation[data.left == <span class=\"number\">1</span>],<span class=\"string\">&#x27;o&#x27;</span>, alpha = <span class=\"number\">0.1</span>)</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Last Evaluation&#x27;</span>)</span><br><span class=\"line\">plt.title(<span class=\"string\">&#x27;Employees who left&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Satisfaction level&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">plt.subplot(<span class=\"number\">1</span>,<span class=\"number\">2</span>,<span class=\"number\">2</span>)</span><br><span class=\"line\">plt.title(<span class=\"string\">&#x27;Employees who stayed&#x27;</span>)</span><br><span class=\"line\">plt.plot(data.satisfaction_level[data.left == <span class=\"number\">0</span>],data.last_evaluation[data.left == <span class=\"number\">0</span>],<span class=\"string\">&#x27;o&#x27;</span>, alpha = <span class=\"number\">0.1</span>)</span><br><span class=\"line\">plt.xlim([<span class=\"number\">0.4</span>,<span class=\"number\">1</span>])</span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Last Evaluation&#x27;</span>)</span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Satisfaction level&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Text(0.5, 0, &#39;Satisfaction level&#39;)\n</code></pre>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_43_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_43_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 用KMeans聚类分析</span></span><br><span class=\"line\"><span class=\"comment\"># 导入KMeans聚类算法模块</span></span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.cluster <span class=\"keyword\">import</span> KMeans</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 选取数据中已经离职的员工（left列为1），并从这些数据中删除特定的列</span></span><br><span class=\"line\"><span class=\"comment\"># 这里axis=1表示按列删除，这些列包括：项目数量、月平均工作小时、公司服务时间、工作事故、是否离职、过去5年是否晋升、销售部门和薪水等</span></span><br><span class=\"line\">kmeans_df =  data[data.left == <span class=\"number\">1</span>].drop([ <span class=\"string\">u&#x27;number_project&#x27;</span>,</span><br><span class=\"line\">       <span class=\"string\">u&#x27;average_montly_hours&#x27;</span>, <span class=\"string\">u&#x27;time_spend_company&#x27;</span>, <span class=\"string\">u&#x27;Work_accident&#x27;</span>,</span><br><span class=\"line\">       <span class=\"string\">u&#x27;left&#x27;</span>, <span class=\"string\">u&#x27;promotion_last_5years&#x27;</span>, <span class=\"string\">u&#x27;sales&#x27;</span>, <span class=\"string\">u&#x27;salary&#x27;</span>],axis = <span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用KMeans算法对处理后的数据进行聚类，设定聚类数为3，并设置随机种子为0以确保结果的可复现性</span></span><br><span class=\"line\"><span class=\"comment\"># 这里fit方法用于训练模型，使其学习数据的聚类结构</span></span><br><span class=\"line\">kmeans = KMeans(n_clusters = <span class=\"number\">3</span>, random_state = <span class=\"number\">0</span>).fit(kmeans_df)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问并输出每个聚类中心点的坐标，这些坐标表示了每个聚类的中心位置</span></span><br><span class=\"line\">kmeans.cluster_centers_</span><br></pre></td></tr></table></figure>\n\n<pre><code>array([[0.41014545, 0.51698182],\n       [0.80851586, 0.91170931],\n       [0.11115466, 0.86930085]])\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 筛选出离职员工的数据</span></span><br><span class=\"line\">left = data[data.left == <span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用布尔索引和 .loc 方法将 KMeans 聚类的标签分配给离职员工数据</span></span><br><span class=\"line\">left_labels = (data.left == <span class=\"number\">1</span>)</span><br><span class=\"line\">data.loc[left_labels, <span class=\"string\">&#x27;label&#x27;</span>] = kmeans.labels_</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重新获取带有标签的离职员工数据</span></span><br><span class=\"line\">left = data[data.left == <span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个新的图形窗口</span></span><br><span class=\"line\">plt.figure()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置 x 轴标签为满意度水平</span></span><br><span class=\"line\">plt.xlabel(<span class=\"string\">&#x27;Satisfaction Level&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置 y 轴标签为最后一次评估结果</span></span><br><span class=\"line\">plt.ylabel(<span class=\"string\">&#x27;Last Evaluation&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置图形标题为“离职员工的3个聚类”</span></span><br><span class=\"line\">plt.title(<span class=\"string\">&#x27;3 Clusters of employees who left&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘制不同聚类的离职员工的满意度水平和最后一次评估结果</span></span><br><span class=\"line\">plt.plot(left.satisfaction_level[left.label==<span class=\"number\">0</span>], left.last_evaluation[left.label==<span class=\"number\">0</span>], <span class=\"string\">&#x27;o&#x27;</span>, alpha=<span class=\"number\">0.2</span>, color=<span class=\"string\">&#x27;r&#x27;</span>)</span><br><span class=\"line\">plt.plot(left.satisfaction_level[left.label==<span class=\"number\">1</span>], left.last_evaluation[left.label==<span class=\"number\">1</span>], <span class=\"string\">&#x27;o&#x27;</span>, alpha=<span class=\"number\">0.2</span>, color=<span class=\"string\">&#x27;g&#x27;</span>)</span><br><span class=\"line\">plt.plot(left.satisfaction_level[left.label==<span class=\"number\">2</span>], left.last_evaluation[left.label==<span class=\"number\">2</span>], <span class=\"string\">&#x27;o&#x27;</span>, alpha=<span class=\"number\">0.2</span>, color=<span class=\"string\">&#x27;b&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加图例，解释不同聚类的含义，并设置图例的位置和字体大小</span></span><br><span class=\"line\">plt.legend([<span class=\"string\">&#x27;Winners&#x27;</span>, <span class=\"string\">&#x27;Frustrated&#x27;</span>, <span class=\"string\">&#x27;Bad Match&#x27;</span>], loc=<span class=\"number\">3</span>, fontsize=<span class=\"number\">15</span>, frameon=<span class=\"literal\">True</span>);</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_45_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/WhoWillLeave_files/WhoWillLeave_45_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"AI","path":"api/categories/AI.json"}],"tags":[{"name":"机器学习","path":"api/tags/机器学习.json"},{"name":"Scikit-learn","path":"api/tags/Scikit-learn.json"}]},{"title":"NCBI上传基因簇之table2asn的使用","slug":"NCBI上传基因簇之table2asn的使用","date":"2024-08-28T12:44:49.000Z","updated":"2024-08-28T13:12:11.597Z","comments":true,"path":"api/articles/NCBI上传基因簇之table2asn的使用.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<p>向<a href=\"https://www.ncbi.nlm.nih.gov/\">NCBI</a>提交基因簇的时候需要提供sqn格式的文件，之前我在文章<a href=\"http://liaochenlanruo.fun/post/d444.html\">《NCBI上传基因簇之tbl2asn的使用》</a>中介绍过如何使用<a href=\"https://www.ncbi.nlm.nih.gov/genbank/tbl2asn2/\">tbl2asn</a>生成<code>sqn</code>文件，遗憾的是<code>tbl2asn</code>官方已经<a href=\"https://ftp.ncbi.nih.gov/toolbox/ncbi_tools/converters/by_program/tbl2asn/README\">不再提供软件下载了</a>，提供的新工具为<a href=\"https://ftp.ncbi.nlm.nih.gov/asn1-converters/by_program/table2asn/\">table2asn</a>，本文介绍<code>table2asn</code>的使用方法。</p>\n<h1 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h1><h2 id=\"下载table2asn\"><a href=\"#下载table2asn\" class=\"headerlink\" title=\"下载table2asn\"></a>下载table2asn</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 此处下载Linux版，Windows和MacOS请自行到https://ftp.ncbi.nlm.nih.gov/asn1-converters/by_program/table2asn/下载</span></span><br><span class=\"line\">wget https://ftp.ncbi.nlm.nih.gov/asn1-converters/by_program/table2asn/linux64.table2asn.gz</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>解压缩文件后得到可执行程序，将其重命名为<code>table2asn</code>，并将其加入环境变量即可，环境变量的设置请自行搜索。</p>\n<h1 id=\"文件准备\"><a href=\"#文件准备\" class=\"headerlink\" title=\"文件准备\"></a>文件准备</h1><p>table2asn依赖三个文件来生成sqn文件：</p>\n<ul>\n<li>文件1：fasta格式的基因组序列文件，文件后缀需要为<code>.fsa</code>，如<code>Toyoncin.fas</code>。</li>\n</ul>\n<p><strong>注意Header处需要添加中括号部分，及相关描述信息。</strong></p>\n<figure class=\"highlight tex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;Toyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster [organism=Bacillus toyonensis] [strain=XIN-YC13] [topology=linear] [moltype=DNA] [tech=wgs] [gcode=11] [country=China] Bacillus toyonensis strain XIN-YC13 Toyoncin biosynthesis gene cluster, complete sequence</span><br><span class=\"line\">ttaaaa taatttaata</span><br><span class=\"line\">gggaagtttt ttagttgttt tggactcttc ccaaacactg ctttaagtgt tggattaaca</span><br><span class=\"line\"> tcatccctat tccccgaaaa cataatgtga ggatttatga ataatgcata tgctctaaca</span><br><span class=\"line\">ttattatcat caacaccact ctctgaacga gccataatac ccttatcaat taattttcta</span><br><span class=\"line\">accaatggac taactttagt ttcatgtctt ccaatttttt tagctaattc tcgctgagtt</span><br><span class=\"line\"> aatgggattt gttctttcga attaatatca ttaactaaac aattacttaa aaaacctaca</span><br><span class=\"line\">cacattgaaa tatctactaa aaataccttc tcagcatttg ttaaataatc aatttcgaac</span><br><span class=\"line\"> aaatactgga tattttgttg aataatctga acaaacttcg ctttattttt cactttacgc</span><br><span class=\"line\"> tcaggaacta atttcattcc tcttgaacga gcttttgatt gaagtttatt tgctaaatac</span><br><span class=\"line\"> atctcttctt cagacaagac ctttaaatcc tcaatatctc tcaatcttga atttttttca</span><br><span class=\"line\"> gcttgttcta agttgataaa ctttgacata ttctttttgc tcctcttttc taagattttc</span><br><span class=\"line\"> aactagagaa ggaaaaaatt ttatgttatg attcctgtag aatttacaat tcaatatgta</span><br><span class=\"line\"> caaaagaact ccccttttct aattgatagt ttggtcgctt tcaattataa tacaagggga</span><br><span class=\"line\"> ttttttacat cttaaaattt ttcatttttg aatcaatccc tgaaaatata aagaacacat</span><br><span class=\"line\"> cacataaatt attcttaata ttttataatc gaaaaaataa taggaataaa gaaaaatact</span><br><span class=\"line\"> gcaataaata tattcatctg tttcttactc aaaccggcca ctatatttaa tcccattcct</span><br><span class=\"line\"> ataataatta attcccaaat tgaaaacact tcaaatttac tacaaattat atatagtaat</span><br><span class=\"line\"> gtacctggtt caaatattga acccaaacta gtatacgtta ctatttctcc tcctataaat</span><br><span class=\"line\"> agtgttaata atgtattaat taatttacct aaaatagaaa ttacactagc aaatattgta</span><br><span class=\"line\"> atagatacta actttttata agaaacatct ttactcatca gcatcattac aatctttaaa</span><br><span class=\"line\"> ataatccccc aaataaaagg tgtaattaaa gcaatgaaaa tcgatgcaaa acctcctaac</span><br><span class=\"line\"> atcatttggg aaacaagggg tatttccata tctgcaaata cttctttttg aattttaacc</span><br><span class=\"line\"> aattctggat tgctatgtct tgcatataca gataaaatcc ctattattgc ttgtataact</span><br><span class=\"line\"> gataaataca taagaggaaa ccatatcgga ctaattattt tcatacgctc gaattcagaa</span><br><span class=\"line\"> ataggagatg taatcataaa aattagagat ggtttttcat aattgttttt ttctttattc</span><br><span class=\"line\"> actactaaac tattatccat atattaacac cttctttttt tattcataac gtaatgcttc</span><br><span class=\"line\"> aattggatct aattttgcag ccttattggc tggaatcaat ccaaatataa taccaagcga</span><br><span class=\"line\"> catcgaaaat aatacgccac ccacaacaac ttcccatgaa acaagaggcg gccattttgc</span><br><span class=\"line\"> aaatgtggac acaatgtacg ctccacaata accaagtcca atcccaatca atccaccaag</span><br><span class=\"line\"> aagtgtcaac ataattgctt caattaaaaa ttgcaacaaa attttaccac gcgttgctcc</span><br><span class=\"line\">aagtgcttta cgtaccccaa tctcacgtgt acgctctgtt acagaaacaa gcatgatatt</span><br><span class=\"line\">cataactcca attccgccta caactaaaga aatacttgca atacctgcaa taatcattgt</span><br><span class=\"line\">cataatatta gtaactttag aaataccttt ttggatttct tctaaattta caatttcata</span><br><span class=\"line\"> tttcccttta aactcttcag attgtctatc atttaataat tttactccct tttttccagc</span><br><span class=\"line\">tgtttgtaat tgatcaaccc ctattgcttg aattgtaata gattgttgag agttatcatc</span><br><span class=\"line\"> tccatataat attggccata ttgaaagtgg tattaaaatt tctgacattc caaaaccaag</span><br><span class=\"line\"> ctcttcatct cctgaactga atagaccaat aatttgaagt ggctgacctt taatttctat</span><br><span class=\"line\"> aattttacca atgactgatt catgctcatt aggaaataac tctttcacta atgtttgatt</span><br><span class=\"line\"> aaccattatt acattattac cttgcatcaa atcatcttca ttaagagaac gacctttctc</span><br><span class=\"line\"> tattttcatt ttagtcatat taaaatattc ttttgtaata ccatttatat tagttacaac</span><br><span class=\"line\">ctttttatca tcaccaatta atgtctctgt actagagttt tgaacaatta catttttaat</span><br><span class=\"line\"> ttcttttatc ttttttaact caaaaagatc ttcttcactt acagatggtt ttttgtcatt</span><br><span class=\"line\"> catagatcct gttgttaata actcattaat atcttcttta tatgtaatcg gaatagtgtt</span><br><span class=\"line\"> attgccagaa gcggtaaatt gtgatttaag cattgcttct ccacctttac caatggctac</span><br><span class=\"line\"> aacagtaata atagaaccta caccaataat aattccaagc atcgtaagag ctgagcgcag</span><br><span class=\"line\"> tttatgagct aaaatagaag ataaggcaat ttttatacta tctaataaac tcataccata</span><br><span class=\"line\"> caccttctat cttctgtaat tttcccatct cgcaatatga tgcgacgtga agaataagct</span><br><span class=\"line\"> gctacctctt cttcatgtgt aaccataacg attgtcgtac cttctgcatt taacttcgta</span><br><span class=\"line\"> aagatatcca taacttgtgc accagacttc gtatcaagcg caccagttgg ctcatcagcc</span><br><span class=\"line\"> ataataaacg ttggattatt cgcaatcgat cttgcaatag caacacgctg cttctgtcca</span><br><span class=\"line\"> cctgacagct cactaggtaa atgatgtact ctatccgcta atccaacttt cccaagcgct</span><br><span class=\"line\"> tcgagcgctc tttgacgacg ctctgctttc ttcactccac cataaatcag tggtaattca</span><br><span class=\"line\"> acgttttcca ctgcggaaag gcgcggcaat aaattaaaat gctggaacac aaaaccgata</span><br><span class=\"line\">tattcattac gaattaaagc aagttttgac tcatctgctg ttaaaatatt cacatcattc</span><br><span class=\"line\">agcatatatt cgccttctgt tggacgatct aaacaaccga taatattcat aagagttgat</span><br><span class=\"line\">ttaccagaac cagacggtcc cataattgaa acaaattcac caccttgaat agttaaacta</span><br><span class=\"line\">ataccgtgca aaataggaac cgccattttt ccttgataat acgttttagc aatattattt</span><br><span class=\"line\">aacgtaatca tttctctttc acttccattc cgtcatatac gttgtcggaa ggatttttaa</span><br><span class=\"line\">ccaccttttg ccccactgtt gcgccctcta caatctctgt ccaatctcca tcagtagcac</span><br><span class=\"line\">cttttttcac attttgttta cgaagcttac ctttctcttc gatatataca aatgcatcat</span><br><span class=\"line\">      cgcctttttc aacaatactc ttacttggaa cagcaatcat tcttttattc tctaaattta</span><br><span class=\"line\">      cttgtaacga aacatgataa cctggagata aaccatcttg actatcaaga cttgctttat</span><br><span class=\"line\">      atgtatattg agacatattt tgagtcactt cccccatgcc atcagcttga gccatttcta</span><br><span class=\"line\">      cacttgttgg gaactcactt acctctgtaa tcttccctgt ccactttttc ttactatttg</span><br><span class=\"line\">      ctttcgcagt tacagtaaac gtttgatcct tttgaatttg cgacttctga agctcagtta</span><br><span class=\"line\">      atgttccttg aatttggaat ggatctttag aagcaacttg taaaaaggct ttcccttgac</span><br><span class=\"line\">      cacctaacgc ttgtgatgaa ctttgtgctg catctttatc taacttttga acaacaccag</span><br><span class=\"line\">      caaaattgct ataaatcgta agttcgttct gctttttatt taactcttct ttttgtaact</span><br><span class=\"line\">      tccctttctc tttctcaagg tctgttgtct tttgcgctat ttctaattca cttacttgct</span><br><span class=\"line\">      cttccatcgg atctattact tctttcccag ctccgctatc tttcgccttc ttaatttctt</span><br><span class=\"line\">      tcttcaacga atcaatcttc tttttccctt ggtcataacg catatctgcc atcttttgat</span><br><span class=\"line\">      caagcacagc ttgcttcatt tgcaaattaa tttcttcatt atcgtaagaa aacaatttcg</span><br><span class=\"line\">      ttcccttttc tatttcttgt ccttctttca cttcaatatc tttcactttt cctttagtca</span><br><span class=\"line\">      gatccgcgta gaaactttca atattccccg gcttcacttg accagaaatt aactttgtat</span><br><span class=\"line\">      tattaagatt gcgctctgtg actttttcaa aactaacagt atctattttt gttaccgctt</span><br><span class=\"line\">      tcttcttact ttgcactacg aaaatattaa taaatgtaac aataacaatt aacgcaataa</span><br><span class=\"line\">      ctccaataat agctcctttc tttttatttt taaaaataaa aagttctttt ttaatcacaa</span><br><span class=\"line\">      caatcttctc cttattcata tctaaaattt aaacttttaa attttacata aaaatttaaa</span><br><span class=\"line\">      acttctaaaa tataacatgt ataatttacc atagatgatt tattttgtat aatataaaaa</span><br><span class=\"line\">      tatctatata aataatgcta attttcaaac aatggggtgg aagatactaa tgttagaaaa</span><br><span class=\"line\">      aaaagataga ctaacagaaa tagaggaaca aattatatac ttaatttcaa aggaattagg</span><br><span class=\"line\">      aaataaagaa atagcggaaa aattaaatta ttcacaacgt agcatcggtt acaaaataaa</span><br><span class=\"line\">      taatattttt aaaaaattaa atgttaattc aagaatcgga ctgattatag aagctgtaaa</span><br><span class=\"line\">      aaaaaatata atttaaatat aagaatgctt tcatgttaat attttataga aactaaatat</span><br><span class=\"line\">      agaggtgatt aaaatgcaaa aattttttga agctattagt gctataggta tagtaggtta</span><br><span class=\"line\">      ctttttaggt aaattcacaa gtattccttt aatagacaaa tatacattgt atttcggcgt</span><br><span class=\"line\">      aatgttgatg attggggtta ttggaagatt tattataaaa gtaattaact cagaagaaga</span><br><span class=\"line\">      gacacatgat tcaaacaaat aaaatactct aataaaaatg gaagaagatt gcacttaagt</span><br><span class=\"line\">      gcaatcttct tccattttta ttgaaaattg attaaataat gttaatattg caattgtgtg</span><br><span class=\"line\">      gtgcagatta gggtgattat gtaatagggg gaaattaaaa atgatcaata cagcttggaa</span><br><span class=\"line\">      aattattaaa gcactacaaa aatacggtac aaaagcatac aatgttatca aaaaaggcgg</span><br><span class=\"line\">      ccaagcaatg tacgacagct tcatggcagc taaagctaaa ggttggacac atgcagcttg</span><br><span class=\"line\">      gtggctagta gaacatggtt caactttagg aacattctat gatttattaa aagctgctgg</span><br><span class=\"line\">      attaatcgac taattacagc aactaaacaa ctaaacaact aaacaactta aaaatacaaa</span><br><span class=\"line\">      ttaccctaaa ctgtacccct attacatatt aactaattat tttaaaggtt ggatgataat</span><br><span class=\"line\">      atgtcaaata acatcatatc tgtaaaaaat ttaattaaaa gcttcgataa caaaatagta</span><br><span class=\"line\">      ttagataaat taaatttcga aatgaaagaa aactccactg ttgtaataat aggtaaaaac</span><br><span class=\"line\">      ggtgcaggta aaagtgtctt tctaaattgt ttacttggat ttattcatta caaccaaggt</span><br><span class=\"line\">      tcaatactaa tagatggaca acctgtagaa aatcgattac atctccgcaa gattacatcg</span><br><span class=\"line\">      ttaatttctt cagaccatca agaacatcta aatttattaa cccccaatga atatttttct</span><br><span class=\"line\">      tttttacaag atatttacca actaaaaagt aataataaag acaaaattca aaattactca</span><br><span class=\"line\">     gaagatctat atgttactaa agaactcaat actgtatttt catcactttc ttttggaaca</span><br><span class=\"line\">     aaaaagaaaa tacaattaat tggtagccta ttatattctc ctaaattatt gatttgcgac</span><br><span class=\"line\">     gaaatatttg aagggcttga tacagactca gtaaaatggg ttaaaaactt atttcaacaa</span><br><span class=\"line\">     agaaaacaag aaaatctttc tactttattt acaactcata ttactgaaca tataacagat</span><br><span class=\"line\">     ataacagaaa aaaattacat acttgaaaat ggaaaattaa ttgtgtaagt ttaaccactt</span><br><span class=\"line\">     atatttaaag ctaaaattaa ggagcttaaa atatgaattt taatatatat aagagactat</span><br><span class=\"line\">     atgataaatc aacagaagaa aaaagcaaaa caataacaaa acaaatatta tttggaatta</span><br><span class=\"line\">     taaatagttc tatattaata ggtatactac tcacatgttt ggagattttc aactttaaaa</span><br><span class=\"line\">     tttcaactgt aatgtatggt tatttcacta tatatataat actagaactt ttactattat</span><br><span class=\"line\">     tctctgcaaa tcaactatat gaaagtacag aattcataat aaaattcctt aaatatacac</span><br><span class=\"line\">     caataaccat aaataaacta tatttctcac attttctaag ttctaaatat tcattttcca</span><br><span class=\"line\">     atctttttga aataataact ctcacatcaa ttttattaat atataatgtc gatatcttat</span><br><span class=\"line\">     attcatttat tttcataatt agcttacaaa ttattagctt aataagaaca tatttagaat</span><br><span class=\"line\">     ttttactatt atattctcaa aaaaaacagg ttaaaatttt tactctaacc cattttgttt</span><br><span class=\"line\">     tcataatatc tatggttttt tatattattg ttaaaacaaa atcgatagat ttagtattct</span><br><span class=\"line\">     ttgaaaacac aaatatgtta attatatctg ttcttctcat aacattcttg atatcacttt</span><br><span class=\"line\">     taacatataa acatattata gaatacttaa tgaaaaataa tgaaattgta tataatgcta</span><br><span class=\"line\">     tttttatcaa gttaactttt aacacagcta atttaattag taaattattt aaatttaata</span><br><span class=\"line\">     catcaattgc atctttaata aaaatacata taatacgatt attacgtaat caagactata</span><br><span class=\"line\">     taagtagatt actaaaaata ggaatattac tatttatttt ttcttctata agctttctat</span><br><span class=\"line\">     ttttcgataa atcatcaaca aacaatgaaa tgagtgatat actttacttt tcatttttta</span><br><span class=\"line\">     tttccttatt tagtttttct aacatacgat tagactataa cttagtttct aaattaagct</span><br><span class=\"line\">     tagaggatta tccaataaca aaattacaat caagattaag cattgatata gcacatggaa</span><br><span class=\"line\">     ttttactatt tatactatct ttatttcttt tattaacaca atacttattg aatccaacaa</span><br><span class=\"line\">     atattctaac tctaattgat ggtttattat catttatttg tttttatttt ctaagtcttg</span><br><span class=\"line\">     gtatagaaaa agcagatatt ataataacac caaaaacaaa atggaaaatg tatccattat</span><br><span class=\"line\">     tttttgtgat gggattaata attgaagcaa tatttctatt aaaattcaaa atatggataa</span><br><span class=\"line\">     aattaataac tttattcctt tgtatactgt ggtcatattt acgtgtttat tggaaattaa</span><br><span class=\"line\">     aaaaacaata aacacaatta aaaagttccc ttcatatttt ttgaagggaa cttttatttt</span><br><span class=\"line\">     aaacaaaaat tacaaacaag caaagttatt taaaagtaaa cttttaaaat tattgaatta</span><br><span class=\"line\">     ataacaatta gtctaagata tatcagccaa atttaatttt taaacaaacc gaaaaaccct</span><br><span class=\"line\">     ttccgttttt gtttctgatt ttggctctgt atttctctaa tgttttcaag caataactga</span><br><span class=\"line\">     tctcgttttt caaatttttt ctctataaaa acctctaatt caatattttt atcttctact</span><br><span class=\"line\">     tcctttaatt ttctctccgt attagccaaa tgttcttttg tggtaactaa ttcattcgta</span><br><span class=\"line\">     atctcttgta atttttgaac aagcgtttga ttgaactgat tttgtaattg ttgattttct</span><br><span class=\"line\">     aatacttcat ccaacttctt ttctaattcc gatttttcct ctcttgaaac aaacaaatca</span><br><span class=\"line\">     agttctccat tccgccatgc tcgaacttga tcataagacc atttttgcac ctgtattttt</span><br><span class=\"line\">     tctttaattg ctatcaattc ttctatattt tcctttgagt acctacgatg ccctccctga</span><br><span class=\"line\">     cttcgctccg tttgtatatt aaattcgttt gaccatgctt ttaacaagtc aggggtaatc</span><br><span class=\"line\">     cctaaacgat ccgcaacaat tttcggtgta tacatttctg attttaattc caa</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>文件2：描述基因特征的feature table文件（.tbl），文件名与FASTA文件一致，如<code>Toyoncin.tbl</code>。</li>\n</ul>\n<p>该文件可以用prokka对文件1进行注释而得到，但是需要自己加以修改，加上gene相关的信息，<code>product</code>部分也要自己修改，该文件共<code>5</code>列，各列之间用制表符分隔。Header部分的名称要与Fasta文件中的一致，但开头需要加上<code>Feature</code>。</p>\n<figure class=\"highlight tex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt;Feature Toyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster</span><br><span class=\"line\">585\t1\tgene</span><br><span class=\"line\">\t\t\tgene\torf1</span><br><span class=\"line\">585\t1\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00001</span><br><span class=\"line\">\t\t\tproduct\tMarR family transcriptional regulator</span><br><span class=\"line\">1476\t811\tgene</span><br><span class=\"line\">\t\t\tgene\torf2</span><br><span class=\"line\">1476\t811\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00002</span><br><span class=\"line\">\t\t\tproduct\tYIP1 family membrane protein</span><br><span class=\"line\">2710\t1496\tgene</span><br><span class=\"line\">\t\t\tgene\torf3</span><br><span class=\"line\">2710\t1496\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00003</span><br><span class=\"line\">\t\t\tproduct\tABC transporter permease</span><br><span class=\"line\">3387\t2707\tgene</span><br><span class=\"line\">\t\t\tgene\torf4</span><br><span class=\"line\">3387\t2707\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00004</span><br><span class=\"line\">\t\t\tproduct\tABC transporter ATP-binding protein</span><br><span class=\"line\">4595\t3384\tgene</span><br><span class=\"line\">\t\t\tgene\torf5</span><br><span class=\"line\">4595\t3384\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00005</span><br><span class=\"line\">\t\t\tproduct\tRND family efflux transporter, MFP subunit</span><br><span class=\"line\">4746\t4952\tgene</span><br><span class=\"line\">\t\t\tgene\torf6</span><br><span class=\"line\">4746\t4952\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00006</span><br><span class=\"line\">\t\t\tproduct\tHelix-turn-helix transcriptional regulator</span><br><span class=\"line\">5010\t5198\tgene</span><br><span class=\"line\">\t\t\tgene\torf7</span><br><span class=\"line\">5010\t5198\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00007</span><br><span class=\"line\">\t\t\tproduct\tPutative membrane protein</span><br><span class=\"line\">5337\t5549\tgene</span><br><span class=\"line\">\t\t\tgene\ttoyA</span><br><span class=\"line\">5337\t5549\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00008</span><br><span class=\"line\">\t\t\tproduct\tToyonsin precusor</span><br><span class=\"line\">5657\t6304\tgene</span><br><span class=\"line\">\t\t\tgene\torf9</span><br><span class=\"line\">5657\t6304\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00009</span><br><span class=\"line\">\t\t\tproduct\tABC transporter ATP-binding protein</span><br><span class=\"line\">6349\t7707\tgene</span><br><span class=\"line\">\t\t\tgene\torf10</span><br><span class=\"line\">6349\t7707\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00010</span><br><span class=\"line\">\t\t\tproduct\tPutative membrane protein</span><br><span class=\"line\">8391\t7849\tgene</span><br><span class=\"line\">\t\t\tgene\torf11</span><br><span class=\"line\">8391\t7849\tCDS</span><br><span class=\"line\">\t\t\tinference\tab initio prediction:Prodigal:002006</span><br><span class=\"line\">\t\t\tlocus<span class=\"built_in\">_</span>tag\tToyoncin<span class=\"built_in\">_</span>biosynthesis<span class=\"built_in\">_</span>gene<span class=\"built_in\">_</span>cluster<span class=\"built_in\">_</span>00011</span><br><span class=\"line\">\t\t\tproduct\tMarR family transcriptional regulator</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>文件3：描述作者信息的模板文件（.sbt）</li>\n</ul>\n<p>可以在<a href=\"https://submit.ncbi.nlm.nih.gov/genbank/template/submission/\">NCBI</a>上生成该文件。</p>\n<figure class=\"highlight tex\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Submit-block ::= &#123;</span><br><span class=\"line\">  contact &#123;</span><br><span class=\"line\">    contact &#123;</span><br><span class=\"line\">      name name &#123;</span><br><span class=\"line\">        last &quot;xin&quot;,</span><br><span class=\"line\">        first &quot;bingyue&quot;,</span><br><span class=\"line\">        middle &quot;&quot;,</span><br><span class=\"line\">        initials &quot;&quot;,</span><br><span class=\"line\">        suffix &quot;&quot;,</span><br><span class=\"line\">        title &quot;&quot;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      affil std &#123;</span><br><span class=\"line\">        affil &quot;Huaibei Normal University&quot;,</span><br><span class=\"line\">        div &quot;College of Life Sciences&quot;,</span><br><span class=\"line\">        city &quot;Huaibei&quot;,</span><br><span class=\"line\">        sub &quot;Anhui&quot;,</span><br><span class=\"line\">        country &quot;China&quot;,</span><br><span class=\"line\">        street &quot;Dongshan road No.100&quot;,</span><br><span class=\"line\">        email &quot;xinbingyuex@163.com&quot;,</span><br><span class=\"line\">        postal-code &quot;235000&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  cit &#123;</span><br><span class=\"line\">    authors &#123;</span><br><span class=\"line\">      names std &#123;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          name name &#123;</span><br><span class=\"line\">            last &quot;Xin&quot;,</span><br><span class=\"line\">            first &quot;Bingyue&quot;,</span><br><span class=\"line\">            middle &quot;&quot;,</span><br><span class=\"line\">            initials &quot;&quot;,</span><br><span class=\"line\">            suffix &quot;&quot;,</span><br><span class=\"line\">            title &quot;&quot;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      affil std &#123;</span><br><span class=\"line\">        affil &quot;Huaibei Normal University&quot;,</span><br><span class=\"line\">        div &quot;College of Life Sciences&quot;,</span><br><span class=\"line\">        city &quot;Huaibei&quot;,</span><br><span class=\"line\">        sub &quot;Anhui&quot;,</span><br><span class=\"line\">        country &quot;China&quot;,</span><br><span class=\"line\">        street &quot;Dongshan road No.100&quot;,</span><br><span class=\"line\">        postal-code &quot;235000&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  subtype new</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Seqdesc ::= pub &#123;</span><br><span class=\"line\">  pub &#123;</span><br><span class=\"line\">    gen &#123;</span><br><span class=\"line\">      cit &quot;unpublished&quot;,</span><br><span class=\"line\">      authors &#123;</span><br><span class=\"line\">        names std &#123;</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">            name name &#123;</span><br><span class=\"line\">              last &quot;Xin&quot;,</span><br><span class=\"line\">              first &quot;Bingyue&quot;,</span><br><span class=\"line\">              middle &quot;&quot;,</span><br><span class=\"line\">              initials &quot;&quot;,</span><br><span class=\"line\">              suffix &quot;&quot;,</span><br><span class=\"line\">              title &quot;&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      title &quot;Purification and characterization of a novel leaderless bacteriocin, toyoncin, produced by Bacillus toyonensis XIN-YC13 that specifically active against Bacilus cereus and Listeria monocytogenes&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Seqdesc ::= user &#123;</span><br><span class=\"line\">  type str &quot;Submission&quot;,</span><br><span class=\"line\">  data &#123;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      label str &quot;AdditionalComment&quot;,</span><br><span class=\"line\">      data str &quot;ALT EMAIL:xinbingyuex@163.com&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Seqdesc ::= user &#123;</span><br><span class=\"line\">  type str &quot;Submission&quot;,</span><br><span class=\"line\">  data &#123;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      label str &quot;AdditionalComment&quot;,</span><br><span class=\"line\">      data str &quot;Submission Title:None&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<p><strong>注意</strong>：文件1和文件2的序列描述信息必须一致，此例中均为“Toyoncin_biosynthesis_gene_cluster”。</p>\n<h1 id=\"文件生成\"><a href=\"#文件生成\" class=\"headerlink\" title=\"文件生成\"></a>文件生成</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">table2asn -i Toyoncin.fas -t template.sbt -V vb</span><br></pre></td></tr></table></figure>\n\n<p>-i 指定FASTA文件<br>-t 指定模板文件<br>-V<br>  -v 生成验证文件，保存错误信息<br>  -b 生成gbf文件<br>-x 文件1（FASTA文件）的后缀名，根据实际情况填写</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><p><a href=\"https://ftp.ncbi.nih.gov/toolbox/ncbi_tools/converters/by_program/table2asn_GFF/DOCUMENTATION/table2asn_readme.txt\">table2asn</a></p>\n</li>\n<li><p><a href=\"http://liaochenlanruo.fun/post/d444.html\">《NCBI上传基因簇之tbl2asn的使用》</a></p>\n</li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>扫码关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"NCBI","path":"api/tags/NCBI.json"},{"name":"序列处理","path":"api/tags/序列处理.json"},{"name":"生信软件","path":"api/tags/生信软件.json"}]},{"title":"深入理解特征标准化：为何、如何及其重要性","slug":"特征标准化","date":"2024-08-12T10:30:19.000Z","updated":"2024-08-12T12:01:50.986Z","comments":true,"path":"api/articles/特征标准化.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<h1 id=\"引言\"><a href=\"#引言\" class=\"headerlink\" title=\"引言\"></a>引言</h1><p>在数据驱动的时代，无论是机器学习模型的构建、数据分析的深入探索，还是统计建模的精确预测，数据预处理都是不可或缺的一环。数据预处理如同烹饪前的食材准备，它决定了最终成果的质量与口感。在众多预处理技术中，特征标准化（Feature Standardization）以其独特的优势，成为了提升模型性能、加速算法收敛、确保数值稳定性的重要手段。</p>\n<p>特征标准化，简而言之，是通过数学变换将原始数据特征转换为具有特定均值（通常为0）和标准差（通常为1）的新数据的过程。这一过程不仅消除了不同特征之间因量纲差异而可能导致的偏见，还使得模型在训练过程中能够更加高效地遍历参数空间，从而更快地找到最优解。此外，特征标准化还有助于避免极端值对模型训练造成的干扰，确保数值计算的稳定性和准确性。</p>\n<p>本文旨在深入探讨特征标准化的概念、方法、应用场景及其重要性。我们将从定义出发，逐步解析特征标准化的原理与优势；通过实例展示如何在实践中应用特征标准化技术；并探讨在实施过程中可能遇到的挑战与注意事项。希望通过本文的阐述，读者能够全面理解并掌握特征标准化的精髓，从而在数据分析和机器学习项目中更加得心应手。</p>\n<h1 id=\"一、特征标准化的基本概念\"><a href=\"#一、特征标准化的基本概念\" class=\"headerlink\" title=\"一、特征标准化的基本概念\"></a>一、特征标准化的基本概念</h1><p><strong>定义解析</strong>：</p>\n<p><code>特征标准化</code>，又称Z-score标准化或标准差标准化，是一种将数据按比例缩放，使其落入一个小的特定区间（通常是-1到1之间，但并非严格限制）的技术。这一过程主要通过去除数据的均值并除以数据的标准差来实现，从而确保处理后的数据具有单位方差和指定的均值（在Z-score标准化中，均值通常为0）。特征标准化的数学表达式通常基于Z-score公式，如下所示：</p>\n<p>$Z &#x3D; \\frac{X - \\mu}{\\sigma}$</p>\n<p>其中，$X$ 是原始数据特征中的某个值，$\\mu$ 是该特征所有值的均值，$\\sigma$ 是该特征所有值的标准差，而<em>Z</em>则是经过标准化处理后的新值。通过这个公式，我们可以将任何一组数据转换为具有相同尺度的数据，使得不同量纲或分布的数据能够在同一框架下进行比较和分析。</p>\n<p><strong>与归一化的区别</strong>：</p>\n<p>特征标准化与数据归一化（Min-Max Scaling）虽然都旨在将数据缩放到一个统一的范围内，但它们在实现方法和适用场景上存在显著差异。</p>\n<ul>\n<li><p><strong>实现方法</strong>：特征标准化通过去除均值并除以标准差来实现，而数据归一化则是通过将数据缩放到指定的最小值和最大值之间（通常是0到1）来完成。归一化的数学表达式可以表示为：</p>\n<p>$X_{\\text{norm}} &#x3D; {\\frac{X - X_{\\min}}{X_{\\max} - X_{\\min}}}\\times (range_{max} - range_{min}) + range_{min}$</p>\n<p>其中，$X_{\\text{norm}}$ 是归一化后的值，$X_{\\min}$ 和 $X_{\\max}$ 分别是原始数据中的最小值和最大值，$range_{max}$和$range_{min}$分别是缩放后的目标范围的最小值和最大值。</p>\n</li>\n<li><p><strong>适用场景</strong>：特征标准化更适合于那些分布符合高斯分布（或接近高斯分布）的数据集，以及那些对异常值不敏感或希望保留异常值影响的场景。因为标准化不会改变数据的分布形状，只是进行了尺度上的缩放。相比之下，归一化更适合于那些数据分布范围已知且较为稳定的场景，尤其是当数据分布明显偏离高斯分布时。此外，归一化对于需要限制数据范围到特定区间的算法（如某些神经网络层的激活函数）特别有用。</p>\n</li>\n</ul>\n<h1 id=\"二、为何需要特征标准化\"><a href=\"#二、为何需要特征标准化\" class=\"headerlink\" title=\"二、为何需要特征标准化\"></a>二、为何需要特征标准化</h1><p>在机器学习和数据科学领域，特征标准化是一项至关重要的预处理步骤，它对于提升模型性能、加快训练过程以及确保数值计算的稳定性具有显著作用。以下是特征标准化的几个关键原因：</p>\n<h2 id=\"1-消除量纲影响\"><a href=\"#1-消除量纲影响\" class=\"headerlink\" title=\"1. 消除量纲影响\"></a>1. 消除量纲影响</h2><p>不同特征往往具有不同的量纲和度量单位，例如，一个特征可能表示年龄（以年为单位），而另一个特征可能表示收入（以美元为单位）。这些不同量纲的数据在数值上差异巨大，如果直接用于模型训练，会导致某些特征在模型中的权重被不恰当地放大或缩小，从而影响模型的训练效果和泛化能力。通过特征标准化，即将所有特征缩放到同一尺度（如均值为0，标准差为1），可以消除这种量纲差异，使得每个特征在模型训练过程中都能被公平对待。</p>\n<h2 id=\"2-加快收敛速度\"><a href=\"#2-加快收敛速度\" class=\"headerlink\" title=\"2. 加快收敛速度\"></a>2. 加快收敛速度</h2><p>在大多数机器学习算法中，尤其是基于梯度下降的优化算法，特征标准化能够显著加快收敛速度。梯度下降算法通过计算损失函数关于模型参数的梯度来更新参数，以最小化损失函数。如果特征未经过标准化处理，不同特征的数值范围差异可能导致梯度在更新过程中呈现不同的步长，使得优化过程变得曲折且缓慢。通过标准化，所有特征的梯度更新步长变得相对一致，从而加快了算法的收敛速度，减少了达到最优解所需的迭代次数。</p>\n<h2 id=\"3-提升模型性能\"><a href=\"#3-提升模型性能\" class=\"headerlink\" title=\"3. 提升模型性能\"></a>3. 提升模型性能</h2><p>多项研究表明，特征标准化能够显著提升模型的准确率和稳定性。标准化后的数据使得模型更容易学习到数据中的真实模式，而不是被数据的量纲差异所误导。此外，标准化还有助于减少过拟合的风险，因为标准化后的数据分布更加均匀，减少了模型对特定数据点的过度依赖。通过实例或研究数据展示，我们可以发现，在相同的数据集和模型架构下，经过标准化的模型往往能够取得更高的准确率和更低的误差率。</p>\n<h2 id=\"4-避免数值问题\"><a href=\"#4-避免数值问题\" class=\"headerlink\" title=\"4. 避免数值问题\"></a>4. 避免数值问题</h2><p>极端值（如非常大或非常小的数值）在数据集中是常见的，它们可能导致数值计算问题，如梯度爆炸或梯度消失，进而影响模型的训练过程。梯度爆炸指的是在梯度更新过程中，梯度值变得异常大，导致模型参数更新不稳定；而梯度消失则相反，梯度值变得非常小，使得模型参数几乎不更新。通过特征标准化，可以将极端值限制在一个合理的范围内，从而有效避免这些数值问题，确保模型训练的顺利进行。</p>\n<h1 id=\"三、特征标准化的方法\"><a href=\"#三、特征标准化的方法\" class=\"headerlink\" title=\"三、特征标准化的方法\"></a>三、特征标准化的方法</h1><h2 id=\"Z-score标准化\"><a href=\"#Z-score标准化\" class=\"headerlink\" title=\"Z-score标准化\"></a>Z-score标准化</h2><p>Z-score标准化，也称为标准差标准化，是最常用的特征标准化方法之一。它通过计算每个特征值的Z分数（即该值与其均值的差除以标准差）来实现数据的标准化。具体计算过程如下：</p>\n<ol>\n<li><p><strong>计算均值</strong>：首先，对于每个特征，计算其所有样本值的均值（$\\mu$）。均值反映了该特征的中心趋势。</p>\n</li>\n<li><p><strong>计算标准差</strong>：接着，计算该特征的标准差（$\\sigma$）。标准差衡量了数据点相对于均值的离散程度，是数据分布宽度的一个度量。</p>\n</li>\n<li><p><strong>标准化处理</strong>：最后，使用Z-score公式将每个特征值转换为标准化后的值（$Z$）。公式为：</p>\n<p>$Z &#x3D; \\frac{X - \\mu}{\\sigma}$</p>\n<p>其中，$X$ 是原始特征值，$Z$ 是转换后的标准化值。</p>\n</li>\n</ol>\n<p>Z-score标准化的作用在于将数据转换为均值为0、标准差为1的分布，从而消除了不同特征之间的量纲差异，使得它们在模型训练中具有相同的权重。此外，Z-score标准化对异常值相对不敏感，因为它依赖于整个数据集的统计特性（均值和标准差）。Z-score标准化会改变原始数据的稀疏性（原来很多非零数据变为0）及分布，而且并不是归一化的。</p>\n<h2 id=\"MinMaxScaler标准化\"><a href=\"#MinMaxScaler标准化\" class=\"headerlink\" title=\"MinMaxScaler标准化\"></a>MinMaxScaler标准化</h2><p>虽然Min-Max标准化并不完全等同于特征标准化（因为它不改变数据的分布形状和稀疏性，只是进行了线性缩放），但它仍然是一种常用的数据缩放方法，并经常与特征标准化进行比较。Min-Max标准化的原理是将数据缩放到一个指定的最小值和最大值之间（通常是0和1），其计算公式为：</p>\n<p>$X_{\\text{norm}} &#x3D; {\\frac{X - X_{\\min}}{X_{\\max} - X_{\\min}}}\\times (range_{max} - range_{min}) + range_{min}$</p>\n<p>其中，$X_{\\text{norm}}$ 是归一化后的值，$X$ 是原始特征值，$X_{\\min}$ 和 $X_{\\max}$ 分别是该特征的最小值和最大值，$range_{max}$和$range_{min}$分别是缩放后的目标范围的最小值和最大值。</p>\n<p>Min-Max标准化适用于那些需要数据范围限制在特定区间的场景，比如某些神经网络的激活函数。然而，它对于新数据的加入比较敏感，因为新数据的最大值和最小值可能会改变整个数据集的缩放比例。</p>\n<h2 id=\"MaxAbsScaler\"><a href=\"#MaxAbsScaler\" class=\"headerlink\" title=\"MaxAbsScaler\"></a>MaxAbsScaler</h2><p>分别对每个特征进行缩放和平移，使得每个特征的最大绝对值为1，最终的值在[-1, 1]。该法不会导致数据整体形态发生大的变化，因此不破坏稀疏性（非零数据不会变为0，0还是0）。因此，可用于比较稀疏的数据。虽然会对分布造成一定的改变，但大致形态接近。</p>\n<p>$X_{\\text{norm}} &#x3D; \\frac{X}{\\left\\vert X_{max} \\right\\vert}$</p>\n<h2 id=\"保持分布的归一化缩放\"><a href=\"#保持分布的归一化缩放\" class=\"headerlink\" title=\"保持分布的归一化缩放\"></a>保持分布的归一化缩放</h2><p>若把一个样本用向量来表示，对于不全是0的向量，对其进行独立于其他样本的缩放，从而使其范数等于1，即将样本分别表转化为单位范数。</p>\n<p><code>L1范数</code>是向量中所有元素值的绝对值之和；<code>L2范数</code>是所有元素平方和的平方根；<code>inf范数</code>指所有元素最大绝对值。</p>\n<p><strong>L2范数标准化（也称为单位向量标准化）</strong>：将特征向量缩放为具有单位L2范数（即欧几里得距离）。这种方法常用于文本数据处理（文本分类、聚类）或图像处理中，以确保特征向量之间的比较是公平的。该缩放基本保持了原始数据的分布，并且对范围进行了归一化（[0, 1]）。</p>\n<p>$X_{\\text{norm}} &#x3D; \\frac{X}{\\left\\vert\\left\\vert X \\right\\vert\\right\\vert}$</p>\n<h2 id=\"缩放含离群值的特征（RobustScaler）\"><a href=\"#缩放含离群值的特征（RobustScaler）\" class=\"headerlink\" title=\"缩放含离群值的特征（RobustScaler）\"></a>缩放含离群值的特征（RobustScaler）</h2><p>若数据包含很多异常离群值，用Z-score方法效果不佳。可以使用RobustScaler替代。</p>\n<p><strong>原理</strong>：通过计算每个特征的中位数和四分位数范围来进行数据缩放。具体来说，它将每个特征的值减去该特征的中位数，然后再除以该特征的四分位数范围。这种方法可以有效地处理异常值的影响，因为四分位数范围对异常值不敏感，从而使得标准化后的数据更加稳定和可靠。</p>\n<p><strong>应用</strong>：RobustScaler在机器学习模型中的应用主要体现在提高模型的泛化能力和稳定性上。通过减少异常值对数据分析的影响，RobustScaler可以帮助模型更好地学习数据的内在规律，从而提高模型的预测准确性和稳定性。</p>\n<p>$X_{\\text{norm}} &#x3D; \\frac{X-Q1}{IQR}$</p>\n<p>其中 $X$ 是原始数据值 $Q1$ 是第一四分位数 $IQR$ 是四分位数间距，即 $Q3−Q1$。</p>\n<h2 id=\"其他标准化技术\"><a href=\"#其他标准化技术\" class=\"headerlink\" title=\"其他标准化技术\"></a>其他标准化技术</h2><p>除了上述标准化之外，还存在其他几种标准化方法，每种方法都有其特定的适用场景：</p>\n<ul>\n<li><p><strong>小数定标标准化（Decimal Scaling Normalization）</strong>：通过移动数据的小数点位置来进行标准化。具体移动多少位取决于数据的最大值。这种方法适用于数据范围已知且相对稳定的场景。</p>\n</li>\n<li><p><strong>对数标准化</strong>：对于某些具有长尾分布的数据，可以通过取对数来减少极端值的影响，并进行标准化处理。这种方法在经济学和金融数据分析中尤为常见。</p>\n</li>\n</ul>\n<p>每种标准化方法都有其独特的优势和局限性，因此在选择时应根据数据的特性、模型的需求以及业务场景来综合考虑。</p>\n<h1 id=\"四、特征标准化的实施步骤\"><a href=\"#四、特征标准化的实施步骤\" class=\"headerlink\" title=\"四、特征标准化的实施步骤\"></a>四、特征标准化的实施步骤</h1><h2 id=\"数据准备\"><a href=\"#数据准备\" class=\"headerlink\" title=\"数据准备\"></a>数据准备</h2><p>在进行特征标准化之前，数据准备是至关重要的一步。数据准备阶段主要包括数据清洗和预处理，以确保数据的质量和一致性，为后续的标准化过程打下坚实的基础。以下是数据准备阶段的关键步骤：</p>\n<ol>\n<li><p><strong>数据清洗</strong>：检查并处理数据中的缺失值、重复值、错误格式等问题。对于缺失值，可以采用填充（如均值填充、中位数填充、众数填充或插值法）或删除的方法进行处理。对于重复值，根据业务需求决定是保留还是删除。</p>\n</li>\n<li><p><strong>异常值处理</strong>：识别并处理数据中的异常值。异常值可能对标准化过程和模型训练产生不利影响。可以通过统计方法（如箱线图、IQR四分位距法）或基于模型的方法（如孤立森林）来检测异常值，并采取相应的处理措施（如删除、替换或标记）。</p>\n</li>\n<li><p><strong>数据划分</strong>：将数据集划分为训练集、验证集和测试集（如果可用）。虽然这一步不是直接针对特征标准化的，但它对于后续评估标准化效果至关重要。</p>\n</li>\n</ol>\n<h2 id=\"选择标准化方法\"><a href=\"#选择标准化方法\" class=\"headerlink\" title=\"选择标准化方法\"></a>选择标准化方法</h2><p>在选择标准化方法时，需要考虑数据类型、数据分布、模型需求以及业务场景等因素。对于大多数情况，Z-score标准化是一个安全且有效的选择，因为它能够消除量纲差异，并且对数据分布形状的影响较小。然而，在某些特定场景下，如需要限制数据范围到特定区间时，Min-Max标准化可能更为合适。此外，还可以根据数据的具体特性和业务需求探索其他标准化方法。</p>\n<h2 id=\"应用标准化\"><a href=\"#应用标准化\" class=\"headerlink\" title=\"应用标准化\"></a>应用标准化</h2><p>在确定了标准化方法后，可以使用编程工具来实现特征标准化。以下是一个使用Python的Pandas和Scikit-learn库进行Z-score标准化的示例：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pandas <span class=\"keyword\">as</span> pd</span><br><span class=\"line\"><span class=\"keyword\">from</span> sklearn.preprocessing <span class=\"keyword\">import</span> StandardScaler</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 假设df是你的DataFrame，其中包含了需要标准化的特征</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用StandardScaler进行Z-score标准化</span></span><br><span class=\"line\">scaler = StandardScaler()</span><br><span class=\"line\">df_scaled = scaler.fit_transform(df)  <span class=\"comment\"># 注意：这会返回NumPy数组，而不是DataFrame</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果你需要DataFrame格式，可以这样做：</span></span><br><span class=\"line\">df_scaled = pd.DataFrame(df_scaled, columns=df.columns)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 或者，如果你只想标准化DataFrame中的某些列，可以这样做：</span></span><br><span class=\"line\">scaler = StandardScaler()</span><br><span class=\"line\">df[[<span class=\"string\">&#x27;feature1&#x27;</span>, <span class=\"string\">&#x27;feature2&#x27;</span>]] = scaler.fit_transform(df[[<span class=\"string\">&#x27;feature1&#x27;</span>, <span class=\"string\">&#x27;feature2&#x27;</span>]])</span><br></pre></td></tr></table></figure>\n\n<p>注意：在实际应用中，通常只在训练集上调用<code>fit_transform()</code>方法来拟合并转换数据，然后在验证集和测试集上调用<code>transform()</code>方法应用相同的转换规则，以确保数据的一致性。</p>\n<h2 id=\"验证效果\"><a href=\"#验证效果\" class=\"headerlink\" title=\"验证效果\"></a>验证效果</h2><p>验证标准化效果是评估特征标准化对模型性能影响的关键步骤。这通常通过比较标准化前后模型的性能指标（如准确率、召回率、F1分数等）来实现。此外，还可以观察模型训练过程中的收敛速度、损失函数的变化情况以及梯度更新的稳定性等指标来评估标准化的效果。如果标准化后模型的性能有所提升，且训练过程更加稳定，那么可以认为标准化是有效的。反之，则需要考虑调整标准化方法或进一步探索其他数据预处理技术。</p>\n<h1 id=\"五、特征标准化的应用场景\"><a href=\"#五、特征标准化的应用场景\" class=\"headerlink\" title=\"五、特征标准化的应用场景\"></a>五、特征标准化的应用场景</h1><h2 id=\"机器学习模型\"><a href=\"#机器学习模型\" class=\"headerlink\" title=\"机器学习模型\"></a>机器学习模型</h2><p>在机器学习领域，特征标准化是提升模型性能的重要手段之一。以下是几个常见机器学习任务中特征标准化的应用：</p>\n<ul>\n<li><p><strong>分类任务</strong>：在分类问题中，如文本分类、图像识别等，特征标准化可以帮助模型更好地学习数据中的真实模式，减少因量纲差异导致的偏差。通过标准化，模型可以更加公平地对待不同特征，从而提高分类的准确率。</p>\n</li>\n<li><p><strong>回归任务</strong>：在回归问题中，如房价预测、股票价格预测等，特征标准化同样重要。标准化后的数据能够加快梯度下降等优化算法的收敛速度，使模型更快找到最优解。此外，标准化还能提高模型的泛化能力，减少过拟合的风险。</p>\n</li>\n<li><p><strong>聚类任务</strong>：在聚类分析中，如K-means聚类、层次聚类等，特征标准化能够确保不同特征在聚类过程中具有相同的权重，从而得到更加合理和准确的聚类结果。未标准化的数据可能会导致某些特征在聚类过程中占据主导地位，影响聚类的有效性。</p>\n</li>\n</ul>\n<h2 id=\"深度学习\"><a href=\"#深度学习\" class=\"headerlink\" title=\"深度学习\"></a>深度学习</h2><p>在深度学习领域，神经网络训练过程中特征标准化的重要性更加凸显。神经网络通常包含多层非线性变换，如果输入数据未经过标准化处理，可能会导致梯度消失或梯度爆炸问题，严重影响模型的训练效果。通过特征标准化，可以确保输入数据在合理的范围内波动，有助于神经网络学习过程的稳定进行。此外，标准化后的数据还能加速神经网络的收敛速度，提高模型的训练效率。</p>\n<h2 id=\"金融分析\"><a href=\"#金融分析\" class=\"headerlink\" title=\"金融分析\"></a>金融分析</h2><p>在金融领域，特征标准化广泛应用于时间序列分析、风险评估等任务中。在金融时间序列分析中，不同金融指标（如股票价格、汇率、利率等）的量纲和波动范围差异较大，直接用于分析可能导致结果失真。通过特征标准化，可以消除这些差异，使得不同指标在模型中具有相同的权重和重要性。在风险评估领域，标准化后的数据有助于构建更加稳定和准确的风险评估模型，提高风险识别的准确性和及时性。</p>\n<h2 id=\"其他领域\"><a href=\"#其他领域\" class=\"headerlink\" title=\"其他领域\"></a>其他领域</h2><p>除了上述领域外，特征标准化还在生物信息学、图像处理等其他领域发挥着重要作用。在生物信息学中，基因表达数据、蛋白质结构数据等通常需要进行标准化处理，以便进行后续的生物信息学分析和挖掘。在图像处理中，像素值的标准化有助于减少光照变化、噪声等因素对图像质量的影响，提高图像识别和分析的准确性。</p>\n<h1 id=\"六、注意事项与挑战\"><a href=\"#六、注意事项与挑战\" class=\"headerlink\" title=\"六、注意事项与挑战\"></a>六、注意事项与挑战</h1><h2 id=\"数据泄露\"><a href=\"#数据泄露\" class=\"headerlink\" title=\"数据泄露\"></a>数据泄露</h2><p>在进行特征标准化时，需要特别注意数据泄露的问题。特别是在使用交叉验证或测试集来评估模型性能时，应避免在测试集上直接使用训练集计算得到的统计量（如均值和标准差）进行标准化。这样做会导致数据泄露问题，使得模型在测试集上的性能被高估。正确的做法是使用训练集计算统计量，并仅对训练集进行标准化处理；在评估模型性能时，应对测试集使用训练集统计量进行标准化，以确保评估的公正性和准确性。</p>\n<h2 id=\"异常值处理\"><a href=\"#异常值处理\" class=\"headerlink\" title=\"异常值处理\"></a>异常值处理</h2><p>异常值处理是特征标准化前的重要步骤之一。异常值可能会对统计量的计算产生显著影响，导致标准化后的数据出现偏差。因此，在进行特征标准化之前，应对数据进行全面的异常值检测和处理。常见的异常值处理方法包括删除、替换（如使用中位数或均值替换）、标记（如设置标志位）等。根据数据的特性和业务需求选择合适的异常值处理方法至关重要。</p>\n<h2 id=\"选择适合的标准化方法\"><a href=\"#选择适合的标准化方法\" class=\"headerlink\" title=\"选择适合的标准化方法\"></a>选择适合的标准化方法</h2><p>选择适合的标准化方法对于提高模型性能至关重要。不同的标准化方法适用于不同的数据类型和业务场景。例如，Z-score标准化适用于大多数连续型数据的标准化处理；Min-Max标准化适用于需要限制数据范围到特定区间的场景；小数定标标准化适用于数据范围已知且相对稳定的场景等。在选择标准化方法时，应充分考虑数据的特性、模型的需求以及业务场景的要求，以确保标准化过程的有效性和合理性。</p>\n<h1 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h1><p>在本文中，我们全面探讨了特征标准化的定义、重要性、方法、实施步骤以及广泛的应用场景。特征标准化作为数据预处理的关键步骤之一，通过调整数据的分布和量纲，使得不同特征在模型中具有相同的权重和重要性，从而提高了模型的训练效率和预测性能。</p>\n<p>首先，我们回顾了特征标准化的基本定义，即通过对数据进行缩放或平移操作，使其满足特定的统计特性（如均值为0，标准差为1）。接着，我们强调了特征标准化在机器学习、深度学习以及金融分析等领域中的重要性，指出它能够有效减少模型训练时间、提高模型泛化能力并优化模型性能。</p>\n<p>在方法部分，我们介绍了多种常见的特征标准化方法，包括Z-score标准化、Min-Max标准化以及小数定标标准化等，并讨论了它们各自的适用场景和优缺点。通过对比不同方法的特点和效果，读者可以根据实际需求选择最适合的标准化方法。</p>\n<p>在实施步骤方面，我们详细阐述了数据准备、选择标准化方法、应用标准化以及验证效果等关键步骤。这些步骤为读者提供了从数据清洗到模型评估的完整流程，有助于他们在实际项目中有效地应用特征标准化技术。</p>\n<p>此外，我们还探讨了特征标准化在多个领域的应用场景，包括机器学习模型中的分类、回归和聚类任务，深度学习中的神经网络训练，以及金融分析中的时间序列分析和风险评估等。这些应用案例不仅展示了特征标准化的广泛适用性，还进一步强调了其在解决实际问题中的重要作用。</p>\n<p>展望未来，随着数据科学和机器学习技术的不断发展，特征标准化技术也将迎来新的发展机遇。自动化标准化工具的发展将使得特征标准化的过程更加简便快捷，降低了技术门槛并提高了工作效率。同时，随着新算法和新模型的不断涌现，特征标准化的方法和应用场景也将不断拓展和深化。</p>\n<p>最后，我们鼓励读者在自己的项目中积极尝试应用特征标准化技术，并通过实践不断积累经验。通过分享实践经验和学习心得，我们可以共同推动特征标准化技术的发展和应用，为数据科学和机器学习领域的发展贡献自己的力量。</p>\n<h1 id=\"关注我\"><a href=\"#关注我\" class=\"headerlink\" title=\"关注我\"></a>关注我</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"机器学习","path":"api/tags/机器学习.json"},{"name":"特征工程","path":"api/tags/特征工程.json"}]},{"title":"用MaAsLin2包做微生物组多变量线性模型关联分析","slug":"用MaAsLin2包做微生物组多变量线性模型关联分析","date":"2024-07-30T14:41:21.000Z","updated":"2024-08-12T13:51:57.224Z","comments":true,"path":"api/articles/用MaAsLin2包做微生物组多变量线性模型关联分析.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/sigresults_screenshot.png","content":"<h1 id=\"简介\"><a href=\"#简介\" class=\"headerlink\" title=\"简介\"></a>简介</h1><p>MaAsLin 2 是 MaAsLin（微生物组多变量线性模型关联，Microbiome Multivariable Association with Linear Models）的下一代产品。</p>\n<p>MaAsLin 2 是一个全面的 R 语言软件包，用于高效地确定表型、环境、暴露、协变量和微生物组元组学特征之间的多变量关联。MaAsLin 2 依赖于一般线性模型来适应大多数现代流行病学研究设计，包括横断面和纵向研究，以及多种数据探索、标准化和转换方法。</p>\n<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>requireNamespace<span class=\"punctuation\">(</span><span class=\"string\">&quot;BiocManager&quot;</span><span class=\"punctuation\">,</span> quietly <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;BiocManager&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">BiocManager<span class=\"operator\">::</span>install<span class=\"punctuation\">(</span><span class=\"string\">&quot;Maaslin2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"微生物组关联检测\"><a href=\"#微生物组关联检测\" class=\"headerlink\" title=\"微生物组关联检测\"></a>微生物组关联检测</h1><h2 id=\"输入文件\"><a href=\"#输入文件\" class=\"headerlink\" title=\"输入文件\"></a>输入文件</h2><h3 id=\"微生物组特征数据或功能数据\"><a href=\"#微生物组特征数据或功能数据\" class=\"headerlink\" title=\"微生物组特征数据或功能数据\"></a>微生物组特征数据或功能数据</h3><ul>\n<li>以制表符分隔列</li>\n<li>行为样本，列为特征（微生物&#x2F;基因&#x2F;功能……）</li>\n</ul>\n<div style=\"overflow-x:auto;\">\n<table>\n    <thead>\n        <tr>\n            <th>ID</th>\n            <th>Bifidobacterium adolescentis</th>\n            <th>Bifidobacterium bifidum</th>\n            <th>Bifidobacterium longum</th>\n            <th>Bifidobacterium pseudocatenulatum</th>\n            <th>Collinsella aerofaciens</th>\n            <th>Bacteroides caccae</th>\n            <th>Bacteroides cellulosilyticus</th>\n            <th>Bacteroides dorei</th>\n            <th>Bacteroides eggerthii</th>\n            <th>Bacteroides faecis</th>\n            <th>Bacteroides finegoldii</th>\n        </tr>\n    </thead>\n    <tbody>\n        <tr>\n            <td>CSM5FZ3N_P</td>\n            <td>Cedars-Sinai</td>\n            <td>43</td>\n            <td>CD</td>\n            <td>C3001</td>\n            <td>No</td>\n            <td>No</td>\n            <td>0.792314801112388</td>\n            <td>No</td>\n            <td>No</td>\n            <td>No</td>\n            <td>1</td>\n        </tr>\n        <!-- ... other rows ... -->\n        <tr>\n            <td>CSM5FZ4M_P</td> <!-- Added _P to make the ID consistent -->\n            <td>Cedars-Sinai</td>\n            <td>43</td>\n            <td>UC</td>\n            <td>C3003</td>\n            <td>No</td>\n            <td>No</td>\n            <td>0.761300183426806</td>\n            <td>No</td>\n            <td>No</td>\n            <td>No</td>\n            <td>6</td>\n        </tr>\n        <tr>\n            <td>CSM5LLGB_P</td>\n            <td>MGH</td>\n            <td>30</td>\n            <td>CD</td>\n            <td>M2014</td>\n            <td>No</td>\n            <td>No</td>\n            <td>0.730525895151516</td>\n            <td>No</td>\n            <td>No</td>\n            <td>No</td>\n            <td>8</td>\n        </tr>\n    </tbody>\n</table>\n</div>\n\n<h3 id=\"元数据\"><a href=\"#元数据\" class=\"headerlink\" title=\"元数据\"></a>元数据</h3><ul>\n<li>以制表符分隔列</li>\n<li>行为样本，列为特征</li>\n</ul>\n<div style=\"overflow-x:auto;\">  \n<table border=\"1\">  \n    <thead>  \n        <tr>  \n            <th>ID</th>  \n            <th>site</th>  \n            <th>age</th>  \n            <th>diagnosis</th>  \n            <th>subject</th>  \n            <th>antibiotics</th>  \n            <th>dysbiosis_binary</th>  \n            <th>dysbiosis</th>  \n            <th>dysbiosisnonIBD</th>  \n            <th>dysbiosisUC</th>  \n            <th>dysbiosisCD</th>  \n            <th>collection</th>  \n        </tr>  \n    </thead>  \n    <tbody>  \n                <tr>\n            <td>CSM5FZ3N_P</td><td>Cedars-Sinai</td><td>43</td><td>CD</td><td>C3001</td><td>No</td><td>No</td><td>0.792314801112388</td><td>No</td><td>No</td><td>No</td><td>1</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ3R_P</td><td>Cedars-Sinai</td><td>43</td><td>CD</td><td>C3001</td><td>No</td><td>No</td><td>0.837923415694291</td><td>No</td><td>No</td><td>No</td><td>2</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ3T_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.924296928419748</td><td>No</td><td>No</td><td>Yes</td><td>1</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ3V_P</td><td>Cedars-Sinai</td><td>43</td><td>CD</td><td>C3001</td><td>No</td><td>No</td><td>0.830400526852384</td><td>No</td><td>No</td><td>No</td><td>4</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ3X_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.910966992923041</td><td>No</td><td>No</td><td>Yes</td><td>2</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ3Z_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.912281677355966</td><td>No</td><td>No</td><td>Yes</td><td>3</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ42_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.903049136702093</td><td>No</td><td>No</td><td>Yes</td><td>4</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ44_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.87825476936449</td><td>No</td><td>No</td><td>Yes</td><td>5</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ46_P</td><td>Cedars-Sinai</td><td>76</td><td>CD</td><td>C3002</td><td>No</td><td>Yes</td><td>0.92542872181954</td><td>No</td><td>No</td><td>Yes</td><td>6</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4A_P</td><td>Cedars-Sinai</td><td>47</td><td>UC</td><td>C3004</td><td>No</td><td>No</td><td>0.775160480913896</td><td>No</td><td>No</td><td>No</td><td>1</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4C_P</td><td>Cedars-Sinai</td><td>43</td><td>CD</td><td>C3001</td><td>No</td><td>No</td><td>0.836244630681399</td><td>No</td><td>No</td><td>No</td><td>5</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4E_P</td><td>Cedars-Sinai</td><td>43</td><td>UC</td><td>C3003</td><td>Yes</td><td>No</td><td>0.787616535915359</td><td>No</td><td>No</td><td>No</td><td>2</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4G_P</td><td>Cedars-Sinai</td><td>43</td><td>UC</td><td>C3003</td><td>No</td><td>No</td><td>0.68128445477854</td><td>No</td><td>No</td><td>No</td><td>3</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4K_P</td><td>Cedars-Sinai</td><td>43</td><td>UC</td><td>C3003</td><td>Yes</td><td>No</td><td>0.717164790084925</td><td>No</td><td>No</td><td>No</td><td>5</td>\n        </tr>\n        <tr>\n            <td>CSM5FZ4M</td><td>Cedars-Sinai</td><td>43</td><td>UC</td><td>C3003</td><td>No</td><td>No</td><td>0.761300183426806</td><td>No</td><td>No</td><td>No</td><td>6</td>\n        </tr>\n        <tr>\n            <td>CSM5LLGB_P</td><td>MGH</td><td>30</td><td>CD</td><td>M2014</td><td>No</td><td>No</td><td>0.730525895151516</td><td>No</td><td>No</td><td>No</td><td>8</td>\n        </tr> \n    </tbody>  \n</table>  \n</div>\n\n<p>两个文件包含的样本可以不同，分析时只取二者共有的样本。样本顺序也无需一致。</p>\n<h3 id=\"读入文件\"><a href=\"#读入文件\" class=\"headerlink\" title=\"读入文件\"></a>读入文件</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df_input_data <span class=\"operator\">=</span> read.table<span class=\"punctuation\">(</span>file             <span class=\"operator\">=</span> input_data<span class=\"punctuation\">,</span></span><br><span class=\"line\">                           header           <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           sep              <span class=\"operator\">=</span> <span class=\"string\">&quot;\\t&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           row.names        <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           stringsAsFactors <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">df_input_data<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">df_input_metadata <span class=\"operator\">=</span> read.table<span class=\"punctuation\">(</span>file             <span class=\"operator\">=</span> input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                               header           <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                               sep              <span class=\"operator\">=</span> <span class=\"string\">&quot;\\t&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                               row.names        <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                               stringsAsFactors <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">df_input_metadata<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">df_input_path <span class=\"operator\">=</span> read.csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;./pathabundance_relab.tsv&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                         sep              <span class=\"operator\">=</span> <span class=\"string\">&quot;\\t&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                         stringsAsFactors <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                         row.names        <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">df_input_path<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行MaAsLin-2\"><a href=\"#运行MaAsLin-2\" class=\"headerlink\" title=\"运行MaAsLin 2\"></a>运行MaAsLin 2</h2><p>在MaAsLin中，可以使用几种不同类型的统计模型来进行关联测试（例如简单线性模型、零膨胀模型、基于计数的模型等）。作者在论文中评估了各种模型的优缺点，虽然默认模型通常适用于大多数分析，但在某些情况下，用户可能希望选择不同的模型。这同样适用于多种不同的微生物群落数据类型（taxonomy 或functional profiles）、环境（人类或其他）和测量方式（计数或相对比例），只要使用适当修改过的归一化&#x2F;转换方案即可。</p>\n<p>对于模型选择，如果你的输入是<code>计数数据</code>，那么你可以使用<code>NEGBIN</code>和<code>ZINB</code>模型；而对于<code>非计数数据</code>（如百分比、CPM或相对丰度）的输入，你可以使用<code>LM</code>和<code>CPLM</code>模型。</p>\n<p>在MaAsLin 2实现的归一化方法中，<u>TMM和CSS仅适用于计数数据，并且它们也返回归一化后的计数</u>，这与TSS和CLR不同。因此，如果你的输入是计数数据，你可以使用上述两种归一化方法（即TMM、CSS或NONE（如果数据已经归一化））而无需进一步转换（即transform &#x3D; NONE）。</p>\n<p><u>在非计数模型中，CPLM要求数据为正数</u>。因此，任何产生负值的转换通常都不适用于<code>CPLM</code>。</p>\n<p>由于所有非LM模型都与其与广义线性模型（GLM）的紧密联系而使用固有的对数链接转换，因此建议它们以<code>transform = NONE</code>的方式运行。</p>\n<p>除此之外，<u>LM是唯一能够处理正数和负数（在归一化&#x2F;转换之后）的模型</u>，并且（根据手稿）它通常对参数变化具有更强的鲁棒性（这是非LM模型的典型限制）。关于是否使用LM、CPLM或其他模型，直观上，<u>在存在零值的情况下，<code>CPLM</code>或<code>零膨胀替代模型</code>应该表现更好，但根据我们的基准测试，我们没有证据表明CPLM显著优于LM模型</u>。因此，<b>在选择模型时，应综合考虑数据的特性、研究目的以及模型的适用性和性能</b>。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">Model (-m ANALYSIS_METHOD)</th>\n<th align=\"center\">Data type</th>\n<th align=\"center\">Normalization (-n NORMALIZATION)</th>\n<th align=\"center\">Transformation (-t TRANSFORM)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">LM</td>\n<td align=\"center\">count and non-count</td>\n<td align=\"center\">TSS, CLR, NONE</td>\n<td align=\"center\">LOG, LOGIT, AST, NONE</td>\n</tr>\n<tr>\n<td align=\"center\">CPLM</td>\n<td align=\"center\">count and non-count</td>\n<td align=\"center\">TSS, TMM, CSS, NONE</td>\n<td align=\"center\">NONE</td>\n</tr>\n<tr>\n<td align=\"center\">NEGBIN</td>\n<td align=\"center\">count</td>\n<td align=\"center\">TMM, CSS, NONE</td>\n<td align=\"center\">NONE</td>\n</tr>\n<tr>\n<td align=\"center\">ZINB</td>\n<td align=\"center\">count</td>\n<td align=\"center\">TMM, CSS, NONE</td>\n<td align=\"center\">NONE</td>\n</tr>\n</tbody></table>\n<p><strong>注</strong>：通常，还需要考虑用于过滤数据（即流行率和丰度阈值）的阈值，以减少异常值和假阳性。有关此方面的更多详细信息，请参阅MaAsLin 2中的第<a href=\"https://github.com/biobakery/biobakery/wiki/maaslin2#431-prevalence-and-abundance-filtering-in-maaslin2\">4.3.1节“流行率和丰度过滤”</a>。</p>\n<p>以下命令在HMP2数据上运行MaAsLin 2，执行多变量回归模型以测试微生物物种丰度与IBD诊断和<a href=\"https://www.nature.com/articles/s41586-019-1237-9\">菌群失调评分</a>之间的关联（<code>fixed_effects = c(&quot;diagnosis&quot;, &quot;dysbiosis&quot;)</code>）。对于具有超过2个水平的任何分类变量，还需要指定哪个变量应作为参考水平，方法是使用（<code>reference = c(&quot;diagnosis,nonIBD&quot;)</code>）。<strong>注</strong>：<font color=#FF0000>在变量和水平之间添加空格可能会导致使用错误的参考水平</font>。输出将生成在当前工作目录下的名为demo_output的文件夹中（<code>output = &quot;demo_output&quot;</code>）。在此示例中，输入数据已预先进行归一化和过滤，因此我们也将关闭默认的归一化和流行率过滤。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fit_data <span class=\"operator\">=</span> Maaslin2<span class=\"punctuation\">(</span>input_data     <span class=\"operator\">=</span> df_input_data<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    input_metadata <span class=\"operator\">=</span> df_input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    min_prevalence <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    normalization  <span class=\"operator\">=</span> <span class=\"string\">&quot;NONE&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    output         <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_output&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    fixed_effects  <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dysbiosis&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    reference      <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis,nonIBD&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"输出\"><a href=\"#输出\" class=\"headerlink\" title=\"输出\"></a>输出</h2><h3 id=\"重要关联\"><a href=\"#重要关联\" class=\"headerlink\" title=\"重要关联\"></a>重要关联</h3><p>MaAsLin 2最重要的输出之一可能是重要关联的列表。这些关联在<code>significant_results.tsv</code>文件中提供：</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/sigresults_screenshot.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/sigresults_screenshot.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"significant_results.tsv\"></p>\n<p>这些是通过MaAsLin 2显著性阈值的全部关联列表，按照q值递增的顺序排序。列包括：</p>\n<ul>\n<li><p><strong>metadata</strong>：与微生物特征相关联的变量名。</p>\n</li>\n<li><p><strong>feature</strong>：微生物特征（分类群、基因、途径等）。</p>\n</li>\n<li><p><strong>value</strong>：对于分类特征，这是报告系数和关联显著性的具体特征水平。</p>\n</li>\n<li><p><strong>coef</strong>：模型系数值（效应大小）。对于分类变量，系数表示在value中指定的类别与参考类别之间的对比。</p>\n</li>\n<li><p><strong>stderr</strong>：模型的标准误差。</p>\n</li>\n<li><p><strong>N</strong>：用于此关联的模型中样本的总数（例如，因为可以排除缺失值）。</p>\n</li>\n<li><p><strong>N.not.0</strong>：在这些样本中，特征非零的总数。</p>\n</li>\n<li><p><strong>pval</strong>：此关联的名义显著性。</p>\n</li>\n<li><p><strong>qval</strong>：使用p.adjust函数和校正方法（如BH等）计算得到的校正显著性。</p>\n</li>\n<li><p><strong>问题</strong>：如何解释这个表格的第一行？</p>\n</li>\n</ul>\n<p>对于<code>significant_results.tsv</code>中的每个重要关联，MaAsLin 2还会生成可视化图表以供检查（分类变量的箱线图，连续变量的散点图）。这些图表命名为“metadata_name.pdf”。例如，从我们的分析运行中，我们得到了可视化文件<code>dysbiosis.pdf</code>和<code>diagnosis.pdf</code>。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/scatterplot_screenshot.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/scatterplot_screenshot.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"dysbiosis.pdf\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/boxplot_screenshot.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/biobakery/omnibus-and-maaslin2-rscripts-and-hmp2-data@master/assets/boxplot_screenshot.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"diagnosis.pdf\"></p>\n<h3 id=\"输出文件完整列表\"><a href=\"#输出文件完整列表\" class=\"headerlink\" title=\"输出文件完整列表\"></a>输出文件完整列表</h3><p>MaAsLin 2生成两种类型的输出文件：数据和可视化文件。</p>\n<ul>\n<li><p>数据输出文件</p>\n<ul>\n<li><p>significant_results.tsv</p>\n</li>\n<li><p>all_results.tsv</p>\n<ul>\n<li>与significant_results.tsv格式相同，但包含所有关联结果（而不仅仅是显著的结果）。</li>\n<li>您也可以在R中使用fit_data$results访问此表。</li>\n</ul>\n</li>\n<li><p>residuals.rds</p>\n<ul>\n<li>此文件包含一个包含每个特征残差的数据框。</li>\n</ul>\n</li>\n<li><p>maaslin2.log</p>\n<ul>\n<li>此文件包含运行的所有日志信息。</li>\n<li>它包括所有设置、警告、错误和运行的步骤。</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>可视化输出文件</p>\n<ul>\n<li><p>heatmap.pdf</p>\n<ul>\n<li>此文件包含显著关联的热图。</li>\n</ul>\n</li>\n<li><p>[a-z&#x2F;0-9]+.pdf</p>\n<ul>\n<li>为每个显著关联生成一个图表。</li>\n<li>对于连续元数据，使用散点图。</li>\n<li>对于分类数据，使用箱线图。</li>\n<li>绘制的数据点已经过归一化、过滤和转换。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MaAsLin-2在功能谱上的应用\"><a href=\"#MaAsLin-2在功能谱上的应用\" class=\"headerlink\" title=\"MaAsLin 2在功能谱上的应用\"></a>MaAsLin 2在功能谱上的应用</h3><p>如果您的功能表是由HUMAnN生成的，并且已经使用<code>humann_renorm_table</code>脚本进行了归一化，那么您不需要执行任何额外的归一化——测序深度的影响已经被消除（这正是本教程中将使用的）。我们倾向于使用<code>CPM</code>单位，因为我们发现它们更方便，但在建模目的上，它们在数值上与相对丰度是等价的（<code>CPM = RA * 1e6</code>）。</p>\n<p>否则，可使用上述关于模型&#x2F;归一化&#x2F;转换的相同思路。</p>\n<p>在使用MaAsLin 2处理功能谱时的一些其他快速提示：</p>\n<ul>\n<li>为了减少特征数量，通常希望运行未分层的功能特征（或分层特征的过滤子集）。</li>\n<li>可能还想移除与特定分类群高度相关的功能特征（即可能由该微生物贡献），因为这些特征可以通过分类学变化得到更好的解释。</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#This can also be done with with the HUMAnN 3 untiliy `humann_split_stratified_table`</span></span><br><span class=\"line\">unstrat_pathways <span class=\"operator\">&lt;-</span><span class=\"keyword\">function</span><span class=\"punctuation\">(</span>dat_path<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  temp <span class=\"operator\">=</span> dat_path<span class=\"punctuation\">[</span><span class=\"operator\">!</span>grepl<span class=\"punctuation\">(</span><span class=\"string\">&quot;\\\\|&quot;</span><span class=\"punctuation\">,</span>rownames<span class=\"punctuation\">(</span>dat_path<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"built_in\">return</span><span class=\"punctuation\">(</span>temp<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">df_input_path <span class=\"operator\">=</span> unstrat_pathways<span class=\"punctuation\">(</span>df_input_path<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>在由<a href=\"https://github.com/biobakery/biobakery/wiki/biobakery_workflows\">bioBakery工作流程</a>生成的MetaCyc途径表上运行与上述相同的模型。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fit_func <span class=\"operator\">=</span> Maaslin2<span class=\"punctuation\">(</span>input_data     <span class=\"operator\">=</span> df_input_path<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    input_metadata <span class=\"operator\">=</span> df_input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    output         <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_functional&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                    fixed_effects  <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dysbiosis&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    reference      <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis,nonIBD&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    min_abundance  <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                    min_prevalence <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：在这里，我们有列中的样本和行中的特征，MaAsLin 2正确地识别了这一点，并且能够匹配样本。</p>\n<p>作者最近还发表了关于使用MaAsLin 2分析宏转录组学数据（MTX）中差异特征的研究，有关该主题的更多信息，请参阅<a href=\"https://academic.oup.com/bioinformatics/article/37/Supplement_1/i34/6319701\">最近的出版物</a>。</p>\n<h1 id=\"高级主题\"><a href=\"#高级主题\" class=\"headerlink\" title=\"高级主题\"></a>高级主题</h1><h2 id=\"交互作用\"><a href=\"#交互作用\" class=\"headerlink\" title=\"交互作用\"></a>交互作用</h2><p>许多统计分析都关注于测试某些变量之间的交互作用。不幸的是，MaAsLin 2目前尚未提供直接的界面来进行此操作。相反，用户需要创建人工交互列作为额外的fixed_effects项。以上面的拟合为例，为了测试诊断与菌群失调之间的交互作用，我可以创建两列额外的数据：CD_dysbiosis和UC_dysbiosis（因为诊断的参考是非IBD）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df_input_metadata<span class=\"operator\">$</span>CD_dysbiosis <span class=\"operator\">=</span> <span class=\"punctuation\">(</span>df_input_metadata<span class=\"operator\">$</span>diagnosis <span class=\"operator\">==</span> <span class=\"string\">&quot;CD&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span></span><br><span class=\"line\">                                 df_input_metadata<span class=\"operator\">$</span>dysbiosis</span><br><span class=\"line\">df_input_metadata<span class=\"operator\">$</span>UC_dysbiosis <span class=\"operator\">=</span> <span class=\"punctuation\">(</span>df_input_metadata<span class=\"operator\">$</span>diagnosis <span class=\"operator\">==</span> <span class=\"string\">&quot;UC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span></span><br><span class=\"line\">                                 df_input_metadata<span class=\"operator\">$</span>dysbiosis</span><br><span class=\"line\"></span><br><span class=\"line\">fit_data_ixn <span class=\"operator\">=</span> Maaslin2<span class=\"punctuation\">(</span>input_data     <span class=\"operator\">=</span> df_input_data<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                        input_metadata <span class=\"operator\">=</span> df_input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                        min_prevalence <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                        normalization  <span class=\"operator\">=</span> <span class=\"string\">&quot;NONE&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                        output         <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_output_interaction&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                        fixed_effects  <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dysbiosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;CD_dysbiosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;UC_dysbiosis&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                        reference      <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis,nonIBD&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"随机效应\"><a href=\"#随机效应\" class=\"headerlink\" title=\"随机效应\"></a>随机效应</h2><p>某些研究自然地将样本观测值“分组”，例如在纵向设计中按受试者分组或在家庭设计中按家庭分组。对于统计分析来说，重要的是要处理属于同一组的样本之间的非独立性。MaAsLin 2 通过 <code>random_effects</code> 参数提供了一个简单的界面来处理这个问题，用户可以在其中指定分组变量来运行混合效应模型。例如，我们注意到 HMP2 是一个纵向设计，其中同一个受试者（列中的 subject）可以有多个样本。因此，我们要求 MaAsLin 2 使用 subject 作为其随机效应分组变量：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fit_data_random <span class=\"operator\">=</span> Maaslin2<span class=\"punctuation\">(</span>input_data     <span class=\"operator\">=</span> df_input_data<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           input_metadata <span class=\"operator\">=</span> df_input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           min_prevalence <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           normalization  <span class=\"operator\">=</span> <span class=\"string\">&quot;NONE&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           output         <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_output_random&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           fixed_effects  <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dysbiosis&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           random_effects <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;subject&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           reference      <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis,nonIBD&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>如果你对在纵向研究中测试时间的影响感兴趣，那么在调用 MaAsLin 2 时，时间点变量应该包含在 <code>fixed_effects </code>中。</p>\n<ul>\n<li>问题：直觉上，你能想到为什么解决样本之间的非独立性很重要吗？<ul>\n<li>提示：想象一下一个简单的场景，你有两个受试者，一个病例和一个对照，每个受试者都有两个样本。</li>\n<li>当同一受试者的样本高度独立时，与它们高度相关时，有效样本大小是多少？</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"其他选项\"><a href=\"#其他选项\" class=\"headerlink\" title=\"其他选项\"></a>其他选项</h2><p>MaAsLin 2 提供了许多参数选项，用于不同的数据预处理（规范化、过滤、转换）和其他任务。这些选项的完整列表是：</p>\n<ul>\n<li><p>min_abundance</p>\n<ul>\n<li>每个特征的最小丰度 [ 默认值：0 ]</li>\n</ul>\n</li>\n<li><p>min_prevalence</p>\n<ul>\n<li>以最小丰度检测到一个特征的最小样本百分比 [ 默认值：0.1 ]</li>\n</ul>\n</li>\n<li><p>max_significance</p>\n<ul>\n<li>显著性的 q 值阈值 [ 默认值：0.25 ]</li>\n</ul>\n</li>\n<li><p>normalization</p>\n<ul>\n<li>要应用的规范化方法 [ 默认值：”TSS” ] [ 选项：”TSS”、”CLR”、”CSS”、”NONE”、”TMM” ]</li>\n</ul>\n</li>\n<li><p>transform</p>\n<ul>\n<li>要应用的转换 [ 默认值：”LOG” ] [ 选项：”LOG”、”LOGIT”、”AST”、”NONE” ]</li>\n</ul>\n</li>\n<li><p>analysis_method</p>\n<ul>\n<li>要应用的分析方法 [ 默认值：”LM” ] [ 选项：”LM”、”CPLM”、”ZICP”、”NEGBIN”、”ZINB” ]</li>\n</ul>\n</li>\n<li><p>correction</p>\n<ul>\n<li>计算 q 值的校正方法 [ 默认值：”BH” ]</li>\n</ul>\n</li>\n<li><p>standardize</p>\n<ul>\n<li>应用 z 分数，以便连续元数据在同一尺度上 [ 默认值：TRUE ]</li>\n</ul>\n</li>\n<li><p>plot_heatmap</p>\n<ul>\n<li>为显著关联生成热图 [ 默认值：TRUE ]</li>\n</ul>\n</li>\n<li><p>heatmap_first_n</p>\n<ul>\n<li>在热图中，绘制具有显著关联的前 N 个特征 [ 默认值：50 ]</li>\n</ul>\n</li>\n<li><p>plot_scatter</p>\n<ul>\n<li>为显著关联生成散点图 [ 默认值：TRUE ]</li>\n</ul>\n</li>\n<li><p>cores</p>\n<ul>\n<li>并行运行的 R 进程数 [ 默认值：1 ]</li>\n</ul>\n</li>\n<li><p>reference</p>\n<ul>\n<li>用作具有两个以上级别的变量的参考，以“变量,参考”的字符串形式提供，多个变量之间用分号分隔。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MaAsLin-2-中的流行率和丰度过滤\"><a href=\"#MaAsLin-2-中的流行率和丰度过滤\" class=\"headerlink\" title=\"MaAsLin 2 中的流行率和丰度过滤\"></a>MaAsLin 2 中的流行率和丰度过滤</h3><p>通常，只有在某个特征在“足够”多的时间内非零时，测试特征与元数据之间的关联才有意义。“足够”的具体比例可能因研究而异，但 10-50% 的最小流行率阈值并不罕见（高达 70-90% 也是合理的）。由于我们已经在使用一小部分精选的演示数据，我们将使用 <code>min_prevalence = 0.1</code> 来仅测试至少 10% 的非零值的特征。请注意：这是 MaAsLin 2 中的默认参数设置。</p>\n<p>类似地，通常只希望测试在这么多样本中达到最小丰度阈值的特征。默认情况下，MaAsLin 2 会认为任何非零值都是可靠的，如果你已经在数据集中进行了充分的质量控制（QC），那么这样做是合适的。然而，如果你想要进行更多过滤或采取保守态度，你可以设置一个最小丰度阈值，如 <code>min_abundance = 0.0001</code>，以仅测试达到这个（相对）丰度的特征。</p>\n<p>将这些参数组合起来，我们可以使用两者来运行 MaAsLin 2（并且速度会更快！）：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fit_data_filter <span class=\"operator\">=</span> Maaslin2<span class=\"punctuation\">(</span>input_data     <span class=\"operator\">=</span> df_input_data<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           input_metadata <span class=\"operator\">=</span> df_input_metadata<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           normalization  <span class=\"operator\">=</span> <span class=\"string\">&quot;NONE&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           output         <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_output_filter&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                           fixed_effects  <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dysbiosis&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           reference      <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;diagnosis,nonIBD&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           random_effects <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;subject&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           min_prevalence <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                           min_abundance  <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"命令行\"><a href=\"#命令行\" class=\"headerlink\" title=\"命令行\"></a>命令行</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Maaslin2.R --transform=AST --fixed_effects=<span class=\"string\">&quot;diagnosis,dysbiosis&quot;</span>  /usr/local/lib/R/site-library/Maaslin2/extdata/HMP2_taxonomy.tsv /usr/local/lib/R/site-library/Maaslin2/extdata/HMP2_metadata.tsv demo_output --reference=<span class=\"string\">&quot;diagnosis,nonIBD&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ Maaslin2.R --help</span><br><span class=\"line\">Usage: ./R/Maaslin2.R [options] &lt;data.tsv&gt; &lt;metadata.tsv&gt; &lt;output_folder&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Options:</span><br><span class=\"line\">    -h, --help</span><br><span class=\"line\">        Show this help message and exit</span><br><span class=\"line\"></span><br><span class=\"line\">    -a MIN_ABUNDANCE, --min_abundance=MIN_ABUNDANCE</span><br><span class=\"line\">        The minimum abundance for each feature [ Default: 0 ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -p MIN_PREVALENCE, --min_prevalence=MIN_PREVALENCE</span><br><span class=\"line\">        The minimum percent of samples for which a feature </span><br><span class=\"line\">        is detected at minimum abundance [ Default: 0.1 ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -s MAX_SIGNIFICANCE, --max_significance=MAX_SIGNIFICANCE</span><br><span class=\"line\">        The q-value threshold for significance [ Default: 0.25 ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -n NORMALIZATION, --normalization=NORMALIZATION</span><br><span class=\"line\">        The normalization method to apply [ Default: TSS ]</span><br><span class=\"line\">        [ Choices: TSS, CLR, CSS, NONE, TMM ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -t TRANSFORM, --transform=TRANSFORM</span><br><span class=\"line\">        The transform to apply [ Default: LOG ]</span><br><span class=\"line\">        [ Choices: LOG, LOGIT, AST, NONE ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -m ANALYSIS_METHOD, --analysis_method=ANALYSIS_METHOD</span><br><span class=\"line\">        The analysis method to apply [ Default: LM ]</span><br><span class=\"line\">        [ Choices: LM, CPLM, NEGBIN, ZINB ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -r RANDOM_EFFECTS, --random_effects=RANDOM_EFFECTS</span><br><span class=\"line\">        The random effects for the model, comma-delimited</span><br><span class=\"line\">        for multiple effects [ Default: none ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -f FIXED_EFFECTS, --fixed_effects=FIXED_EFFECTS</span><br><span class=\"line\">        The fixed effects for the model, comma-delimited</span><br><span class=\"line\">        for multiple effects [ Default: all ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -c CORRECTION, --correction=CORRECTION</span><br><span class=\"line\">        The correction method for computing the </span><br><span class=\"line\">        q-value [ Default: BH ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -z STANDARDIZE, --standardize=STANDARDIZE</span><br><span class=\"line\">        Apply z-score so continuous metadata are </span><br><span class=\"line\">        on the same scale [ Default: TRUE ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -l PLOT_HEATMAP, --plot_heatmap=PLOT_HEATMAP</span><br><span class=\"line\">        Generate a heatmap for the significant </span><br><span class=\"line\">        associations [ Default: TRUE ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -i HEATMAP_FIRST_N, --heatmap_first_n=HEATMAP_FIRST_N</span><br><span class=\"line\">        In heatmap, plot top N features with significant </span><br><span class=\"line\">        associations [ Default: TRUE ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -o PLOT_SCATTER, --plot_scatter=PLOT_SCATTER</span><br><span class=\"line\">        Generate scatter plots for the significant</span><br><span class=\"line\">        associations [ Default: TRUE ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -e CORES, --cores=CORES</span><br><span class=\"line\">        The number of R processes to run in parallel</span><br><span class=\"line\">        [ Default: 1 ]</span><br><span class=\"line\"></span><br><span class=\"line\">    -r REFERENCE, --reference=&#x27;VARIABLE,REFERENCE&#x27;</span><br><span class=\"line\">        The factor to use as a reference for a </span><br><span class=\"line\">        variable with more than two levels </span><br><span class=\"line\">        provided as a string of &#x27;variable,reference&#x27; </span><br><span class=\"line\">        semi-colon delimited for multiple variables.</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"参考文献\"><a href=\"#参考文献\" class=\"headerlink\" title=\"参考文献\"></a>参考文献</h1><ul>\n<li>Mallick H, Rahnavard A, McIver LJ, Ma S, Zhang Y, Nguyen LH, Tickle TL, Weingart G, Ren B, Schwager EH, Chatterjee S, Thompson KN, Wilkinson JE, Subramanian A, Lu Y, Waldron L, Paulson JN, Franzosa EA, Bravo HC, Huttenhower C (2021). <a href=\"https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009442\">Multivariable Association Discovery in Population-scale Meta-omics Studies</a>. PLoS Computational Biology, 17(11):e1009442.</li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"扩增子","path":"api/tags/扩增子.json"},{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"R语言","path":"api/tags/R语言.json"}]},{"title":"Shiny从入门到入定——13-Why reactivity?","slug":"Shiny从入门到入定——13-Why-reactivity","date":"2024-04-27T13:37:04.000Z","updated":"2024-04-27T13:38:58.624Z","comments":true,"path":"api/articles/Shiny从入门到入定——13-Why-reactivity.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>现在你已经掌握了一系列有用的技巧，这些技巧赋予了你创建各种有用应用程序的能力。接下来，我们将把注意力转向Shiny魔力背后的反应性理论：</p>\n<ul>\n<li><p>在第<code>13</code>章中，你将了解为什么需要反应性编程模型，以及关于R之外的反应性编程历史的一些知识。</p>\n</li>\n<li><p>在第<code>14</code>章中，你将学习反应图的全部细节，它将决定反应组件何时更新。</p>\n</li>\n<li><p>在第<code>15</code>章中，你将了解底层的构建块，尤其是观察者和定时失效。</p>\n</li>\n<li><p>在第<code>16</code>章中，你将学习如何使用<a href=\"https://rdrr.io/pkg/shiny/man/reactiveVal.html\">reactiveVal()</a>和<a href=\"https://rdrr.io/pkg/shiny/man/observe.html\">observe()</a>来突破反应图的限制。</p>\n</li>\n</ul>\n<p>当然，对于日常开发Shiny应用程序，你并不需要理解所有这些细节。但是，提高你的理解将有助于你从一开始就编写正确的应用程序，当某些行为不符合预期时，你可以更快地缩小问题的范围。</p>\n<h1 id=\"13-为什么需要反应性？\"><a href=\"#13-为什么需要反应性？\" class=\"headerlink\" title=\"13 为什么需要反应性？\"></a>13 为什么需要反应性？</h1><h2 id=\"13-1-引言\"><a href=\"#13-1-引言\" class=\"headerlink\" title=\"13.1 引言\"></a>13.1 引言</h2><p>Shiny给人的初步印象通常是“神奇”。当你刚开始使用时，这种神奇感非常棒，因为它能让你迅速构建出简单的应用程序。但是，软件中的神奇通常会导致幻灭：如果没有一个稳固的思维模型，当你尝试超出其演示和示例的边界时，要预测软件将如何表现就极其困难。而当事情不按你预期的方式发展时，调试几乎是不可能的。</p>\n<p>幸运的是，Shiny的“神奇”是有益的。正如汤姆·戴尔（Tom Dale）谈到他的Ember.js JavaScript框架时所说：“我们做了很多神奇的事情，但这是有益的神奇，这意味着它可以分解为合理的原始元素。”这是Shiny团队希望Shiny所具备的品质，尤其是在反应性编程方面。当你剥去反应性编程的层层外衣时，你不会发现一堆启发式方法、特殊情况和黑客攻击；相反，你会发现一个巧妙但最终相当直接的机制。一旦你形成了对反应性的准确思维模型，你就会明白Shiny并没有耍花招：神奇来自于以一致的方式组合简单概念。</p>\n<p>在本章中，我们将尝试在没有反应性编程的情况下进行开发，以此说明反应性编程的必要性，然后简要介绍与Shiny相关的反应性编程的历史。</p>\n<h2 id=\"13-2-为什么我们需要反应性编程？\"><a href=\"#13-2-为什么我们需要反应性编程？\" class=\"headerlink\" title=\"13.2 为什么我们需要反应性编程？\"></a>13.2 为什么我们需要反应性编程？</h2><p>反应性编程是一种编程风格，它关注随时间变化的值，以及依赖于这些值的计算和操作。反应性对于Shiny应用程序至关重要，因为它们具有交互性：用户改变输入控件（拖动滑块、在文本框中输入内容、勾选复选框等），这会触发服务器上的逻辑运行（读取CSV文件、筛选数据、拟合模型等），最终导致输出更新（图表重绘、表格更新等）。这与大多数R代码有很大的不同，后者通常处理相对静态的数据。</p>\n<p>为了让Shiny应用程序发挥最大效用，我们需要确保反应式表达式和输出仅在它们的输入发生变化时更新。我们希望输出与输入保持同步，同时确保不会进行比必要更多的工作。为了了解反应性为何如此有用，我们将尝试解决一个不使用反应性的简单问题。</p>\n<h3 id=\"13-2-1-为什么不能使用变量？\"><a href=\"#13-2-1-为什么不能使用变量？\" class=\"headerlink\" title=\"13.2.1 为什么不能使用变量？\"></a>13.2.1 为什么不能使用变量？</h3><p>从某种意义上说，你已经知道如何处理“随时间变化的值”：它们被称为“变量”。在R中，变量代表值，它们可以随时间变化，但它们并不是为帮助你处理变化而设计的。以下是一个简单的将温度从摄氏度转换为华氏度的例子：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> 10</span><br><span class=\"line\">temp_f <span class=\"operator\">&lt;-</span> <span class=\"punctuation\">(</span>temp_c <span class=\"operator\">*</span> <span class=\"number\">9</span> <span class=\"operator\">/</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"number\">32</span></span><br><span class=\"line\">temp_f</span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 50</span></span><br></pre></td></tr></table></figure>\n\n<p>到目前为止还不错：<code>temp_c</code>变量有值10，<code>temp_f</code>变量有值50，我们可以改变<code>temp_c</code>的值：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> 30</span><br></pre></td></tr></table></figure>\n\n<p>但是改变<code>temp_c</code>的值并不会影响<code>temp_f</code>的值：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_f</span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 50</span></span><br></pre></td></tr></table></figure>\n\n<p>变量可以随时间变化，但它们不会自动变化。</p>\n<h3 id=\"13-2-2-使用函数怎么样？\"><a href=\"#13-2-2-使用函数怎么样？\" class=\"headerlink\" title=\"13.2.2 使用函数怎么样？\"></a>13.2.2 使用函数怎么样？</h3><p>你也可以通过函数来解决这个问题：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> 10</span><br><span class=\"line\">temp_f <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  message<span class=\"punctuation\">(</span><span class=\"string\">&quot;Converting&quot;</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  <span class=\"punctuation\">(</span>temp_c <span class=\"operator\">*</span> <span class=\"number\">9</span> <span class=\"operator\">/</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 50</span></span><br></pre></td></tr></table></figure>\n\n<p>（这是一个有点奇怪的函数，因为它没有参数，而是从其封闭环境40中访问<code>temp_c</code>，但它是一个完全有效的R代码。）</p>\n<p>这解决了反应性试图解决的第一个问题：每当你访问<code>temp_f()</code>时，你都会得到最新的计算结果：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> <span class=\"operator\">-</span><span class=\"number\">3</span></span><br><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 26.6</span></span><br></pre></td></tr></table></figure>\n\n<p>然而，它并没有减少计算量。每次你调用<code>temp_f()</code>时，它都会重新计算，即使<code>temp_c</code>没有改变：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 26.6</span></span><br></pre></td></tr></table></figure>\n\n<p>在这个简单的例子中，计算成本不高，所以重复计算没什么大不了的，但这仍然是多余的：如果输入没有改变，我们为什么要重新计算输出呢？</p>\n<h3 id=\"13-2-3-事件驱动编程\"><a href=\"#13-2-3-事件驱动编程\" class=\"headerlink\" title=\"13.2.3 事件驱动编程\"></a>13.2.3 事件驱动编程</h3><p>由于变量和函数都不适用，我们需要创建一些新的东西。在过去的几十年里，我们可能会直接跳到事件驱动编程。事件驱动编程是一个吸引人的简单范式：你注册回调函数，这些函数会在事件发生时执行。</p>\n<p>我们可以使用R6实现一个非常简单的事件驱动工具包，如下例所示。在这里，我们定义了一个<code>DynamicValue</code>，它有三个重要的方法：<a href=\"https://rdrr.io/r/base/get.html\">get()</a>和<code>set()</code>用于访问和更改基础值，<code>onUpdate()</code>用于注册在值被修改时要运行的代码。如果你不熟悉R6，不用担心细节，而是关注下面的例子。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DynamicValue <span class=\"operator\">&lt;-</span> R6<span class=\"operator\">::</span>R6Class<span class=\"punctuation\">(</span><span class=\"string\">&quot;DynamicValue&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span></span><br><span class=\"line\">  value <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  on_update <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"></span><br><span class=\"line\">  get <span class=\"operator\">=</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> self<span class=\"operator\">$</span>value<span class=\"punctuation\">,</span></span><br><span class=\"line\"></span><br><span class=\"line\">  set <span class=\"operator\">=</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>value<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    self<span class=\"operator\">$</span>value <span class=\"operator\">&lt;-</span> value</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.null</span><span class=\"punctuation\">(</span>self<span class=\"operator\">$</span>on_update<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">      self<span class=\"operator\">$</span>on_update<span class=\"punctuation\">(</span>value<span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"built_in\">invisible</span><span class=\"punctuation\">(</span>self<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  onUpdate <span class=\"operator\">=</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>on_update<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    self<span class=\"operator\">$</span>on_update <span class=\"operator\">&lt;-</span> on_update</span><br><span class=\"line\">    <span class=\"built_in\">invisible</span><span class=\"punctuation\">(</span>self<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>因此，如果Shiny在五年前就被发明出来，它可能看起来会更像这样，其中<code>temp_c</code>使用<code>&lt;&lt;-</code>来在需要时更新<code>temp_f</code>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> DynamicValue<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">temp_c<span class=\"operator\">$</span>onUpdate<span class=\"punctuation\">(</span><span class=\"keyword\">function</span><span class=\"punctuation\">(</span>value<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  message<span class=\"punctuation\">(</span><span class=\"string\">&quot;Converting&quot;</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  temp_f <span class=\"operator\">&lt;&lt;-</span> <span class=\"punctuation\">(</span>value <span class=\"operator\">*</span> <span class=\"number\">9</span> <span class=\"operator\">/</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">temp_c<span class=\"operator\">$</span>set<span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\">temp_f</span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 50</span></span><br><span class=\"line\"></span><br><span class=\"line\">temp_c<span class=\"operator\">$</span>set<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"number\">3</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\">temp_f</span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 26.6</span></span><br></pre></td></tr></table></figure>\n\n<p>事件驱动编程解决了不必要的计算问题，但它又产生了一个新问题：你必须仔细跟踪哪些输入会影响哪些计算。不久之后，你就会在正确性（即在任何内容发生更改时都更新所有内容）和性能（即尝试仅更新必要的部分，并希望你没有遗漏任何边缘情况）之间权衡取舍，因为同时做到这两点非常困难。</p>\n<h3 id=\"13-2-4-反应性编程\"><a href=\"#13-2-4-反应性编程\" class=\"headerlink\" title=\"13.2.4 反应性编程\"></a>13.2.4 反应性编程</h3><p>反应性编程通过将上述解决方案的特性结合起来，优雅地解决了这两个问题。现在，我们可以向您展示一些真正的Shiny代码，它使用了一个特殊的Shiny模式，即<code>reactiveConsole(TRUE)</code>，这使得我们可以直接在控制台中实验反应性。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>shiny<span class=\"punctuation\">)</span></span><br><span class=\"line\">reactiveConsole<span class=\"punctuation\">(</span><span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>与事件驱动编程一样，我们需要某种方式来指示我们有一个特殊类型的变量。在Shiny中，我们使用<a href=\"https://rdrr.io/pkg/shiny/man/reactiveVal.html\">reactiveVal()</a>创建一个反<strong>reactive value</strong>。反应式值有特殊的语法来获取其值（像调用无参数函数一样调用它）和设置其值（像调用单参数函数一样调用它来设置其值）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c <span class=\"operator\">&lt;-</span> reactiveVal<span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"comment\"># create</span></span><br><span class=\"line\">temp_c<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span>                  <span class=\"comment\"># get</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 10</span></span><br><span class=\"line\">temp_c<span class=\"punctuation\">(</span><span class=\"number\">20</span><span class=\"punctuation\">)</span>                <span class=\"comment\"># set</span></span><br><span class=\"line\">temp_c<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span>                  <span class=\"comment\"># get</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 20</span></span><br></pre></td></tr></table></figure>\n\n<p>现在我们可以创建一个依赖于这个值的反应式表达式：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_f <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  message<span class=\"punctuation\">(</span><span class=\"string\">&quot;Converting&quot;</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  <span class=\"punctuation\">(</span>temp_c<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span> <span class=\"number\">9</span> <span class=\"operator\">/</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"number\">32</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 68</span></span><br></pre></td></tr></table></figure>\n\n<p>在创建应用程序时，你已经了解到反应式表达式会自动跟踪其所有依赖项。因此，如果之后<code>temp_c</code>发生变化，<code>temp_f</code>会自动更新：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_c<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"number\">3</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">temp_c<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Converting</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 14</span></span><br></pre></td></tr></table></figure>\n\n<p>但如果<code>temp_c()</code>没有变化，那么<code>temp_f()</code>就不需要重新计算，可以直接从缓存中获取：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_f<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 14</span></span><br></pre></td></tr></table></figure>\n\n<p>反应式表达式有两个重要特性：</p>\n<ul>\n<li><p>它是<strong>惰性</strong>的：在被调用之前，它不会进行任何工作。</p>\n</li>\n<li><p>它是<strong>缓存</strong>的：在第二次及后续调用时，它不会进行任何工作，因为它缓存了之前的结果。</p>\n</li>\n</ul>\n<p>我们将在第<code>14</code>章中再次讨论这些重要特性。</p>\n<h2 id=\"13-3-反应式编程简史\"><a href=\"#13-3-反应式编程简史\" class=\"headerlink\" title=\"13.3 反应式编程简史\"></a>13.3 反应式编程简史</h2><p>如果你想了解更多其他语言的反应式编程知识，那么了解其发展历史可能会有所帮助。你可以在<a href=\"https://en.wikipedia.org/wiki/VisiCalc\">VisiCalc</a>（第一个电子表格软件）中看到反应式编程的萌芽，它起源于40多年前：</p>\n<p>  我想象了一个神奇的黑板，当你擦去一个数字并写入新的东西时，其他所有的数字都会自动改变，就像用数字进行的文字处理一样。</p>\n<p>  ——<a href=\"https://youtu.be/YDvbDiJZpy0\">Dan Bricklin</a></p>\n<p>电子表格与反应式编程密切相关：你使用公式声明单元格之间的关系，当一个单元格发生变化时，其所有依赖项都会自动更新。因此，你可能已经在不知不觉中进行了大量反应式编程！</p>\n<p>虽然反应性的概念已经存在很长时间了，但直到20世纪90年代末，学术界才开始对其进行认真研究。反应式编程的研究始于FRAN（<strong>f</strong>unctional <strong>r</strong>eactive <strong>a</strong>nimation，功能性反应式动画），这是一种将随时间变化和用户输入融入功能编程语言中的新颖系统。这催生了一系列丰富的文献，但对编程实践的影响却很小。</p>\n<p>直到2010年代，反应式编程才通过JavaScript UI框架的快节奏世界进入主流编程领域。像<a href=\"https://knockoutjs.com/\">Knockout</a>、<a href=\"https://emberjs.com/\">Ember</a>和<a href=\"https://www.meteor.com/\">Meteor</a>（Joe Cheng’s personal inspiration for Shiny）这样的开创性框架表明，反应式编程可以极大地简化UI编程。短短几年内，反应式编程通过<a href=\"https://reactjs.org/\">React</a>、<a href=\"https://vuejs.org/\">Vue.js</a>和<a href=\"https://angularjs.org/\">Angular</a>等广受欢迎的框架主导了网络编程，这些框架要么本质上具有反应性，要么设计为与反应式后端协同工作。</p>\n<p>值得一提的是，“反应式编程”是一个相当泛泛的术语。虽然所有反应式编程的库、框架和语言大体上都是关注编写响应值变化的程序，但是它们在术语、设计和实现方面却存在巨大的差异。在本书中，每当提到“反应式编程”时，我们特指在Shiny中实现的反应式编程。因此，如果你阅读了关于反应式编程的资料，而这些资料并不是专门针对Shiny的，那么这些概念甚至术语都不太可能与编写Shiny应用相关。对于那些对其他反应式编程框架有一定经验的读者来说，Shiny的方法与<a href=\"https://www.meteor.com/\">Meteor</a>和<a href=\"https://mobx.js.org/\">MobX</a>类似，与<a href=\"http://reactivex.io/\">ReactiveX</a>系列或任何将自己标记为功能反应式编程的内容有很大不同。</p>\n<h2 id=\"13-4-小结\"><a href=\"#13-4-小结\" class=\"headerlink\" title=\"13.4 小结\"></a>13.4 小结</h2><p>现在你已经理解了为什么需要反应式编程，并且对它的发展历史有了一些了解，接下来的一章将讨论其底层理论的更多细节。最重要的是，你将巩固对反应图的理解，反应图将反应值、反应表达式和观察者连接起来，并精确控制何时运行。</p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”，聊天窗口回复“85d7”获取下载链接。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"编程","path":"api/tags/编程.json"},{"name":"Shiny入门系列","path":"api/tags/Shiny入门系列.json"}]},{"title":"Shiny从入门到入定——12-Tidy evaluation","slug":"Shiny从入门到入定——12-Tidy-evaluation","date":"2024-04-27T12:58:06.000Z","updated":"2024-04-27T13:00:03.085Z","comments":true,"path":"api/articles/Shiny从入门到入定——12-Tidy-evaluation.json","excerpt":null,"keywords":null,"cover":"https://d33wubrfki0l68.cloudfront.net/2c131334332cadef7ec2b3e3bdf32689f3f1ebc6/f6143/demos/action-tidy/messed-up.png","content":"<h1 id=\"整洁评估\"><a href=\"#整洁评估\" class=\"headerlink\" title=\"整洁评估\"></a>整洁评估</h1><p>如果你在使用Shiny与tidyverse，那么你几乎肯定会遇到整洁评估编程的挑战。整洁评估在tidyverse中被广泛使用，使交互式数据探索更加流畅，但它也有代价：很难间接引用变量，因此编程起来也更加困难。</p>\n<p>在本章中，你将学习如何在Shiny应用程序中包装ggplot2和dplyr函数。（如果你不使用tidyverse，那么可以跳过这一章😄。）将ggplot2和dplyr函数包装在函数和包中的技术略有不同，并且在其他资源如<a href=\"http://ggplot2.tidyverse.org/dev/articles/ggplot2-in-packages.html\">“在包中使用ggplot2”</a>或<a href=\"http://dplyr.tidyverse.org/articles/programming.html\">“使用dplyr编程”</a>中有所涵盖。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>shiny<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>dplyr<span class=\"punctuation\">,</span> warn.conflicts <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"12-1-动机\"><a href=\"#12-1-动机\" class=\"headerlink\" title=\"12.1 动机\"></a>12.1 动机</h2><p>假设我想创建一个应用程序，允许你过滤一个数值变量，以选择大于某个阈值的行。你可能会写出类似这样的代码：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_vars <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;carat&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;depth&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;table&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;price&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;x&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;y&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;z&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> num_vars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Minimum&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;output&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  data <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>diamonds <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>var <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>output <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>head<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/2c131334332cadef7ec2b3e3bdf32689f3f1ebc6/f6143/demos/action-tidy/messed-up.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/2c131334332cadef7ec2b3e3bdf32689f3f1ebc6/f6143/demos/action-tidy/messed-up.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图12.1 一个应用程序试图选择用户选定变量中大于阈值的行\"></p>\n<p>从<code>图12.1</code>中你可以看到，该应用程序可以无错误地运行，但它并没有返回正确的结果——所有的行中，钻石的净重（<code>carat</code>）值都小于1。本章的目标是帮助你理解为什么这不起作用，以及为什么dplyr认为你请求的是<code>filter(diamonds, &quot;carat&quot; &gt; 1)</code>。</p>\n<p>这是一个<code>间接引用</code>的问题：通常在使用tidyverse函数时，你会直接在函数调用中输入变量的名称。但现在你想要间接引用它：变量（<code>carat</code>）存储在另一个变量（<code>input$var</code>）中。</p>\n<p>这句话可能对你来说很直观，但有点令人困惑，因为我在这里用“变量”来指代两种略有不同的事物。如果我们引入两个新术语来消除这两种用法之间的歧义，那么理解正在发生的事情会更容易：</p>\n<ul>\n<li><p>环境变量（<strong>env-variable</strong>）是一个“编程”变量，你用<code>&lt;-</code>来创建。<code>input$var</code>是一个环境变量。</p>\n</li>\n<li><p>数据变量（<strong>data-variable</strong>）是存储在数据框中的“统计”变量。<code>carat</code>是一个数据变量。</p>\n</li>\n</ul>\n<p>有了这些新术语，我们可以更清楚地阐述间接引用的问题：我们有一个数据变量（<code>carat</code>）存储在一个环境变量（<code>input$var</code>）中，我们需要一种方法来告诉dplyr这一点。根据你所使用的函数是“数据掩蔽”函数还是“整洁选择”函数，实现这一点的方法略有不同。</p>\n<h2 id=\"12-2-数据掩蔽\"><a href=\"#12-2-数据掩蔽\" class=\"headerlink\" title=\"12.2 数据掩蔽\"></a>12.2 数据掩蔽</h2><p>数据掩蔽函数允许你在“当前”数据框中使用变量，而无需任何额外的语法。它在许多dplyr函数（如<a href=\"https://dplyr.tidyverse.org/reference/arrange.html\">arrange()</a>、<a href=\"https://dplyr.tidyverse.org/reference/filter.html\">filter()</a>、<a href=\"https://dplyr.tidyverse.org/reference/group_by.html\">group_by()</a>、<a href=\"https://dplyr.tidyverse.org/reference/mutate.html\">mutate()</a>和<a href=\"https://dplyr.tidyverse.org/reference/summarise.html\">summarise()</a>）以及ggplot2的<a href=\"https://ggplot2.tidyverse.org/reference/aes.html\">aes()</a>中使用。数据掩蔽很有用，因为它允许你使用数据变量，而无需任何额外的语法。</p>\n<h3 id=\"12-2-1-开始\"><a href=\"#12-2-1-开始\" class=\"headerlink\" title=\"12.2.1 开始\"></a>12.2.1 开始</h3><p>让我们从调用<code>filter()</code>函数开始，它使用了一个数据变量（<code>carat</code>）和一个环境变量（<code>min</code>）：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">min</span> <span class=\"operator\">&lt;-</span> 1</span><br><span class=\"line\">diamonds <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>carat <span class=\"operator\">&gt;</span> <span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; # A tibble: 17,502 × 10</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   carat cut       color clarity depth table price     x     y     z</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  1.17 Very Good J     I1       60.2    61  2774  6.83  6.9   4.13</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2  1.01 Premium   F     I1       61.8    60  2781  6.39  6.36  3.94</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  1.01 Fair      E     I1       64.5    58  2788  6.29  6.21  4.03</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4  1.01 Premium   H     SI2      62.7    59  2788  6.31  6.22  3.93</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5  1.05 Very Good J     SI2      63.2    56  2789  6.49  6.45  4.09</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  1.05 Fair      J     SI2      65.8    59  2789  6.41  6.27  4.18</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; # … with 17,496 more rows</span></span><br></pre></td></tr></table></figure>\n\n<p>与基础R的等效代码进行比较：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">diamonds<span class=\"punctuation\">[</span>diamonds<span class=\"operator\">$</span>carat <span class=\"operator\">&gt;</span> <span class=\"built_in\">min</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n<p>在大多数（但不是全部）基础R函数中，你需要使用<code>$</code>来引用数据变量。这意味着你经常需要多次重复数据框的名称，但这确实清楚地表明了什么是数据变量，什么是环境变量。这也使得间接引用变得直接明了，因为你可以将数据变量的名称存储在一个环境变量中，然后从<code>$</code>切换到<code>[[</code>：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;carat&quot;</span></span><br><span class=\"line\">diamonds<span class=\"punctuation\">[</span>diamonds<span class=\"punctuation\">[[</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> <span class=\"built_in\">min</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n\n<p>我们如何使用整洁评估来达到相同的效果呢？我们需要一种方法将<code>$</code>重新加入进来。幸运的是，在数据掩蔽函数中，如果你想明确表示你是在谈论数据变量还是环境变量，你可以使用<code>.data</code>或<code>.env</code>：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">diamonds <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"operator\">$</span>carat <span class=\"operator\">&gt;</span> .env<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p>现在我们可以从$切换到[[：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">diamonds <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> .env<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p>让我们通过更新本章开始时使用的服务器函数来检查它是否有效：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_vars <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;carat&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;depth&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;table&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;price&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;x&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;y&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;z&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> num_vars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Minimum&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;output&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  data <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>diamonds <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> .env<span class=\"operator\">$</span>input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>output <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>head<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/878d4b65fc1671d180c91732193924ce2f3b3ea8/ca76b/demos/action-tidy/tidied-up.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/878d4b65fc1671d180c91732193924ce2f3b3ea8/ca76b/demos/action-tidy/tidied-up.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图12.2 我们的应用现在运行良好，因为我们明确了.data和.env以及[[与$的区别。请访问https://hadley.shinyapps.io/ms-tidied-up查看实时效果\"></p>\n<p><code>图12.2</code>显示我们已经成功了——我们只看到克拉值大于1的钻石。现在你已经了解了基础知识，我们将开发几个更现实但仍然简单的Shiny应用。</p>\n<h3 id=\"12-2-2-示例：ggplot2\"><a href=\"#12-2-2-示例：ggplot2\" class=\"headerlink\" title=\"12.2.2 示例：ggplot2\"></a>12.2.2 示例：ggplot2</h3><p>让我们将这个想法应用于动态绘图，允许用户通过选择要在<code>x</code>轴和<code>y</code>轴上显示的变量来创建散点图。结果如<code>图12.3</code>所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;x&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;X variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;y&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Y variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;plot&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>plot <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    ggplot<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">,</span> aes<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> .data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>y<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">      geom_point<span class=\"punctuation\">(</span>position <span class=\"operator\">=</span> ggforce<span class=\"operator\">::</span>position_auto<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td><img src=\"https://d33wubrfki0l68.cloudfront.net/9defdeb8a9d4c779898f02f540feb95283b62c65/23a54/demos/action-tidy/ggplot2-scatter.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/9defdeb8a9d4c779898f02f540feb95283b62c65/23a54/demos/action-tidy/ggplot2-scatter.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\"></td>\n<td><img src=\"https://d33wubrfki0l68.cloudfront.net/74cf9f3e211b5f2430a03a5c960da0ab63a1e29e/41abe/demos/action-tidy/ggplot2-swarm.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/74cf9f3e211b5f2430a03a5c960da0ab63a1e29e/41abe/demos/action-tidy/ggplot2-swarm.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\"></td>\n</tr>\n<tr>\n<td colspan=\"2\">图12.3 一个简单的应用程序，允许您选择要在x轴和y轴上绘制的变量。请访问<a href=\"https://hadley.shinyapps.io/ms-ggplot2\">https://hadley.shinyapps.io/ms-ggplot2</a>查看实时效果</td>\n</tr>\n</table>\n\n<p>这里我使用了<a href=\"https://ggforce.data-imaginist.com/reference/position_auto.html\">ggforce::position_auto()</a>，这样无论x和y变量是连续的还是离散的，<a href=\"https://ggplot2.tidyverse.org/reference/geom_point.html\">geom_point()</a>都能很好地工作。或者，我们也可以让用户选择geom。下面的应用程序使用<a href=\"https://rdrr.io/r/base/switch.html\">switch()</a>语句生成一个反应性的geom，稍后会将其添加到图中。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;x&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;X variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;y&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Y variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;geom&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;geom&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;point&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;smooth&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;jitter&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;plot&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  plot_geom <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"built_in\">switch</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>geom<span class=\"punctuation\">,</span></span><br><span class=\"line\">      point <span class=\"operator\">=</span> geom_point<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      smooth <span class=\"operator\">=</span> geom_smooth<span class=\"punctuation\">(</span>se <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      jitter <span class=\"operator\">=</span> geom_jitter<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>plot <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    ggplot<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">,</span> aes<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> .data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>y<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">      plot_geom<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>这是使用用户选择的变量进行编程时面临的挑战之一：你的代码必须变得更加复杂，以处理用户可能生成的所有情况。</p>\n<h3 id=\"12-2-3-示例：dplyr\"><a href=\"#12-2-3-示例：dplyr\" class=\"headerlink\" title=\"12.2.3 示例：dplyr\"></a>12.2.3 示例：dplyr</h3><p>同样的技术也适用于dplyr。下面的应用程序扩展了前面简单的示例，允许您选择一个变量进行过滤，选择一个最小值进行选择，以及选择一个变量进行排序。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Select variable&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Minimum value&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;sort&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Sort by&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    rng <span class=\"operator\">&lt;-</span> <span class=\"built_in\">range</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span></span><br><span class=\"line\">      session<span class=\"punctuation\">,</span> <span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      value <span class=\"operator\">=</span> rng<span class=\"punctuation\">[[</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"built_in\">min</span> <span class=\"operator\">=</span> rng<span class=\"punctuation\">[[</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"built_in\">max</span> <span class=\"operator\">=</span> rng<span class=\"punctuation\">[[</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    mtcars <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      arrange<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>sort<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/4b67467c8ad6e40cb3fffad24222564bf4858788/ae5b1/demos/action-tidy/dplyr.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/4b67467c8ad6e40cb3fffad24222564bf4858788/ae5b1/demos/action-tidy/dplyr.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图12.4 一个简单的应用程序，允许您选择一个变量作为阈值，并选择如何对结果进行排序。请访问https://hadley.shinyapps.io/ms-dplyr/查看实时效果\"></p>\n<p>大多数其他问题都可以通过结合<code>.data</code>和您的现有编程技能来解决。例如，如果您想要条件性地以升序或降序进行排序，应该怎么做呢？</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Sort by&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  checkboxInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;desc&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Descending order?&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  sorted <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>desc<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      arrange<span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">,</span> desc<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      arrange<span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">,</span> .data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>sorted<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>随着你提供更多控制选项，你会发现代码变得越来越复杂，同时创建一个既全面又友好的用户界面也变得越来越难。这就是为什么我一直专注于数据分析的代码工具：创建好的用户界面真的非常难！</p>\n<h3 id=\"12-2-4-用户提供的数据\"><a href=\"#12-2-4-用户提供的数据\" class=\"headerlink\" title=\"12.2.4 用户提供的数据\"></a>12.2.4 用户提供的数据</h3><p>在继续讨论整洁选择之前，我们还需要讨论最后一个话题：用户提供的数据。以<code>图12.5</code>中显示的这个应用程序为例：它允许用户上传一个tsv文件，然后选择一个变量并根据该变量进行筛选。它适用于绝大多数你可能会尝试的输入。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  fileInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;dataset&quot;</span><span class=\"punctuation\">,</span> accept <span class=\"operator\">=</span> <span class=\"string\">&quot;.tsv&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> character<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;output&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  data <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>data<span class=\"punctuation\">)</span></span><br><span class=\"line\">    vroom<span class=\"operator\">::</span>vroom<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>data<span class=\"operator\">$</span>datapath<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateSelectInput<span class=\"punctuation\">(</span>session<span class=\"punctuation\">,</span> <span class=\"string\">&quot;var&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    val <span class=\"operator\">&lt;-</span> data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">    updateNumericInput<span class=\"punctuation\">(</span>session<span class=\"punctuation\">,</span> <span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>val<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>output <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      arrange<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      head<span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/a2b57fbb1d8a118a0410942708a051e92355b7a6/a504d/demos/action-tidy/user-supplied.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/a2b57fbb1d8a118a0410942708a051e92355b7a6/a504d/demos/action-tidy/user-supplied.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图12.5 一个过滤用户提供的数据的应用程序，具有令人惊讶的故障模式。请访问https://hadley.shinyapps.io/ms-user-supplied/查看实时效果\"></p>\n<p>这里使用<a href=\"https://dplyr.tidyverse.org/reference/filter.html\">filter()</a>有一个微妙的问题。让我们把对<code>filter()</code>的调用提取出来，这样我们就可以在应用程序之外直接操作它：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df <span class=\"operator\">&lt;-</span> data.frame<span class=\"punctuation\">(</span>x <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> y <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">input <span class=\"operator\">&lt;-</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span>var <span class=\"operator\">=</span> <span class=\"string\">&quot;x&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">df <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   x y</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1 1 2</span></span><br></pre></td></tr></table></figure>\n\n<p>如果你试验这段代码，你会发现它对于绝大多数数据框都能很好地工作。然而，有一个微妙的问题：如果数据框中包含一个名为<code>input</code>的变量，会发生什么？</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df <span class=\"operator\">&lt;-</span> data.frame<span class=\"punctuation\">(</span>x <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> y <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> input <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">df <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Error in `filter()`:</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; ! Problem while computing `..1 = .data[[&quot;x&quot;]] &gt; input$min`.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Caused by error in `input$min`:</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; ! $ operator is invalid for atomic vectors</span></span><br></pre></td></tr></table></figure>\n\n<p>我们收到一条错误信息，因为<code>filter()</code>正在尝试计算<code>df$input$min</code>：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df<span class=\"operator\">$</span>input<span class=\"operator\">$</span><span class=\"built_in\">min</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Error in df$input$min: $ operator is invalid for atomic vectors</span></span><br></pre></td></tr></table></figure>\n\n<p>这个问题是由于数据变量和环境变量的歧义造成的，并且在两者都可用时，数据掩蔽更倾向于使用数据变量。我们可以通过使用<code>.env</code>来告诉<code>filter()</code>只在环境变量中查找<code>min</code>来解决这个问题：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>.data<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> .env<span class=\"operator\">$</span>input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   x y input</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1 1 2     3</span></span><br></pre></td></tr></table></figure>\n\n<p>请注意，这个问题只有在处理用户提供的数据时才需要考虑；在处理自己的数据时，你可以确保数据变量的名称不会与环境变量的名称冲突（如果不小心冲突了，你会立刻发现）。</p>\n<h3 id=\"12-2-5-为什么不使用基础R？\"><a href=\"#12-2-5-为什么不使用基础R？\" class=\"headerlink\" title=\"12.2.5 为什么不使用基础R？\"></a>12.2.5 为什么不使用基础R？</h3><p>到这时，你可能会想，如果没有<code>filter()</code>函数，使用等效的基础R代码会不会更好？</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">df<span class=\"punctuation\">[</span>df<span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>var<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&gt;</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   x y input</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1 1 2     3</span></span><br></pre></td></tr></table></figure>\n\n<p>这是一个完全合理的立场，只要你意识到<code>filter()</code>为你做的工作，以便你能生成等效的基础R代码。在这种情况下：</p>\n<ul>\n<li><p>如果df只包含一列，你需要使用<code>drop = FALSE</code>（否则你会得到一个向量而不是数据框）。</p>\n</li>\n<li><p>你需要使用<a href=\"https://rdrr.io/r/base/which.html\">which()</a>或类似函数来删除任何缺失值。</p>\n</li>\n<li><p>你不能进行分组过滤（例如，<code>df %&gt;% group_by(g) %&gt;% filter(n() == 1)</code>）。</p>\n</li>\n</ul>\n<p>一般来说，如果你只是使用dplyr来处理非常简单的案例，你可能会发现使用不使用数据掩蔽的基础R函数更容易。然而，在我看来，tidyverse的一个优势在于它仔细考虑了边缘情况，以便函数能更一致地工作。我不想夸大这一点，但同时，很容易忘记特定基础R函数的怪癖，并编写出95%以上时间都能工作，但在另外5%的时间里会以不寻常的方式失败的代码。</p>\n<h2 id=\"12-3-整洁选择-Tidy-selection\"><a href=\"#12-3-整洁选择-Tidy-selection\" class=\"headerlink\" title=\"12.3 整洁选择 Tidy-selection\"></a>12.3 整洁选择 Tidy-selection</h2><p>除了数据掩蔽之外，整洁评估还有一个重要的部分：整洁选择。整洁选择提供了一种简洁的方式来通过位置、名称或类型选择列。它在<a href=\"https://dplyr.tidyverse.org/reference/select.html\">dplyr::select()</a>和<a href=\"https://dplyr.tidyverse.org/reference/across.html\">dplyr::across()</a>以及tidyr中的许多函数（如<a href=\"https://tidyr.tidyverse.org/reference/pivot_longer.html\">pivot_longer()</a>、<a href=\"https://tidyr.tidyverse.org/reference/pivot_wider.html\">pivot_wider()</a>、<a href=\"https://tidyr.tidyverse.org/reference/separate.html\">separate()</a>、<a href=\"https://tidyr.tidyverse.org/reference/extract.html\">extract()</a>和<a href=\"https://tidyr.tidyverse.org/reference/unite.html\">unite()</a>）中使用。</p>\n<h3 id=\"12-3-1-间接引用\"><a href=\"#12-3-1-间接引用\" class=\"headerlink\" title=\"12.3.1 间接引用\"></a>12.3.1 间接引用</h3><p>要间接引用变量，可以使用<a href=\"https://tidyselect.r-lib.org/reference/all_of.html\">any_of()</a>或<a href=\"https://tidyselect.r-lib.org/reference/all_of.html\">all_of()</a>：两者都期望一个包含数据变量名称的字符向量作为环境变量。唯一的区别是，如果你提供了一个在输入中不存在的变量名，<code>all_of()</code>会引发错误，而<code>any_of()</code>则会静默地忽略它。</p>\n<p>例如，以下应用程序允许用户使用多选输入选择任意数量的变量，同时使用<code>all_of()</code>：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;vars&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Variables&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> multiple <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars<span class=\"punctuation\">)</span></span><br><span class=\"line\">    mtcars <span class=\"operator\">%&gt;%</span> select<span class=\"punctuation\">(</span>all_of<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"12-3-2-整洁选择与数据掩蔽\"><a href=\"#12-3-2-整洁选择与数据掩蔽\" class=\"headerlink\" title=\"12.3.2 整洁选择与数据掩蔽\"></a>12.3.2 整洁选择与数据掩蔽</h3><p>当使用采用整洁选择的函数时，处理多个变量变得轻而易举：您只需将包含变量名的字符向量传递给<code>any_of()</code>或<code>all_of()</code>。如果我们也能在数据掩蔽函数中使用这种方法，那该有多好？这正是dplyr 1.0.0版本中添加的<a href=\"https://dplyr.tidyverse.org/reference/across.html\">across()</a>函数的设计理念。它允许您在数据掩蔽函数中使用整洁选择。</p>\n<p><code>across()</code>函数通常使用一个或两个参数。第一个参数用于选择变量，在<a href=\"https://dplyr.tidyverse.org/reference/group_by.html\">group_by()</a>或<a href=\"https://dplyr.tidyverse.org/reference/distinct.html\">distinct()</a>等函数中非常有用。例如，以下应用程序允许您选择任意数量的变量并计算它们的唯一值数量。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;vars&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Variables&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> multiple <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;count&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>count <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars<span class=\"punctuation\">)</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    mtcars <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      group_by<span class=\"punctuation\">(</span>across<span class=\"punctuation\">(</span>all_of<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      summarise<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> n<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> .groups <span class=\"operator\">=</span> <span class=\"string\">&quot;drop&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/20b7acd57783cbc15cf0d64d8964bba1e093ba06/1c155/demos/action-tidy/across.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/20b7acd57783cbc15cf0d64d8964bba1e093ba06/1c155/demos/action-tidy/across.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图12.6 此应用程序允许您选择任意数量的变量，并计算它们的唯一组合数量。请访问https://hadley.shinyapps.io/ms-across实时查看\"></p>\n<p>第二个参数是一个函数（或函数列表），应用于每个选定的列。这使得它非常适合<a href=\"https://dplyr.tidyverse.org/reference/mutate.html\">mutate()</a>和<a href=\"https://dplyr.tidyverse.org/reference/summarise.html\">summarise()</a>等函数，因为您通常想要以某种方式转换每个变量。例如，以下代码允许用户选择任意数量的分组变量，以及任意数量的变量，以计算它们的平均值进行汇总。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;vars_g&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Group by&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> multiple <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;vars_s&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Summarise&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>mtcars<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> multiple <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    mtcars <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      group_by<span class=\"punctuation\">(</span>across<span class=\"punctuation\">(</span>all_of<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars_g<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      summarise<span class=\"punctuation\">(</span>across<span class=\"punctuation\">(</span>all_of<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>vars_s<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mean<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> n <span class=\"operator\">=</span> n<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"12-4-parse-eval\"><a href=\"#12-4-parse-eval\" class=\"headerlink\" title=\"12.4 parse() + eval()\"></a>12.4 parse() + eval()</h2><p>在我们继续之前，有必要对<a href=\"https://rdrr.io/r/base/paste.html\">paste()</a> + <a href=\"https://rdrr.io/r/base/parse.html\">parse()</a> + <a href=\"https://rdrr.io/r/base/eval.html\">eval()</a>组合进行简短的评论。如果你完全不了解这个组合，可以跳过这一节，但如果你已经使用过它，我想给你一个小小的警告。</p>\n<p>这是一个诱人的方法，因为它只需要学习很少的新概念。但它也有一些主要的缺点：由于你正在将字符串拼接在一起，很容易意外地创建出无效的代码，或者可能被滥用以执行你不希望的操作的代码。如果这只是你自己使用的Shiny应用程序，这可能不是非常重要，但这并不是一个值得养成的好习惯——否则，很容易在你广泛分享的应用程序中意外地创建一个安全漏洞。我们将在第<code>22章</code>中再次提及这个观点。</p>\n<p>（如果你发现这是解决问题的唯一方法，不必感到沮丧。但当你有了更多的思考空间时，我建议花些时间弄清楚如何在不进行字符串操作的情况下实现。这将有助于你成为一名更好的R程序员。）</p>\n<h2 id=\"12-5-总结\"><a href=\"#12-5-总结\" class=\"headerlink\" title=\"12.5 总结\"></a>12.5 总结</h2><p>在本章中，你学习了如何创建Shiny应用程序，让用户选择将哪些变量输入到如<a href=\"https://dplyr.tidyverse.org/reference/filter.html\">dplyr::filter()</a>和<a href=\"https://ggplot2.tidyverse.org/reference/aes.html\">ggplot2::aes()</a>这样的tidyverse函数中。这需要你理解一个你之前可能从未考虑过的关键区别：数据变量和环境变量的不同。这可能需要一些练习才能变得自然，但一旦你掌握了这些概念，你就能够解锁tidyverse的数据分析功能，并将其暴露给非R用户。</p>\n<p>这是本书<code>“Shiny实战”</code>部分的最后一章。既然你已经拥有了制作一系列有用应用程序所需的工具，我将重点提高你对Shiny底层理论的理解。</p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"编程","path":"api/tags/编程.json"},{"name":"Shiny入门系列","path":"api/tags/Shiny入门系列.json"}]},{"title":"Shiny从入门到入定——11-书签","slug":"Shiny从入门到入定——11-书签","date":"2024-04-27T09:53:52.000Z","updated":"2024-04-27T09:55:47.969Z","comments":true,"path":"api/articles/Shiny从入门到入定——11-书签.json","excerpt":null,"keywords":null,"cover":"https://d33wubrfki0l68.cloudfront.net/6ad93d80475f1ebc6d632c1293f210174da9b9d6/f576b/demos/action-bookmark/pendulum.png","content":"<h1 id=\"11-书签\"><a href=\"#11-书签\" class=\"headerlink\" title=\"11 书签\"></a>11 书签</h1><p>与大多数网站相比，Shiny应用程序有一个主要的缺点：您无法为应用程序添加书签以便将来返回同一位置，也无法通过电子邮件中的链接与他人分享您的工作。这是因为，默认情况下，Shiny不会在URL中公开应用程序的当前状态。然而，幸运的是，通过一些额外的工作，您可以更改此行为，本章将向您展示如何操作。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>shiny<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"11-1-基本思路\"><a href=\"#11-1-基本思路\" class=\"headerlink\" title=\"11.1 基本思路\"></a>11.1 基本思路</h2><p>让我们用一个简单的应用程序来演示如何使其具有书签功能。这个应用程序绘制了利萨茹曲线，这些曲线复制了摆锤的运动。这个应用程序可以生成各种有趣的图案，您可能想要与他人分享。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;omega&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;omega&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;delta&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;delta&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;damping&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;damping&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0.9</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.001</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;length&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;length&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;fig&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  t <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>seq<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span><span class=\"built_in\">length</span><span class=\"punctuation\">,</span> length.out <span class=\"operator\">=</span> input<span class=\"operator\">$</span><span class=\"built_in\">length</span> <span class=\"operator\">*</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  x <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"built_in\">sin</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>omega <span class=\"operator\">*</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> input<span class=\"operator\">$</span>delta<span class=\"punctuation\">)</span> <span class=\"operator\">*</span> input<span class=\"operator\">$</span>damping <span class=\"operator\">^</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  y <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"built_in\">sin</span><span class=\"punctuation\">(</span>t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span> input<span class=\"operator\">$</span>damping <span class=\"operator\">^</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>fig <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    plot<span class=\"punctuation\">(</span>x<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> y<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> axes <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> xlab <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> ylab <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> type <span class=\"operator\">=</span> <span class=\"string\">&quot;l&quot;</span><span class=\"punctuation\">,</span> lwd <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/6ad93d80475f1ebc6d632c1293f210174da9b9d6/f576b/demos/action-bookmark/pendulum.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/6ad93d80475f1ebc6d632c1293f210174da9b9d6/f576b/demos/action-bookmark/pendulum.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图11.1 这个应用程序允许您使用摆锤模型生成有趣的图案。如果能和朋友分享一个链接，岂不是很酷？\"></p>\n<p>为了使这个应用程序具有书签功能，我们需要做三件事情：</p>\n<ol>\n<li><p>在用户界面中添加一个<a href=\"https://rdrr.io/pkg/shiny/man/bookmarkButton.html\">bookmarkButton()</a>。这将生成一个按钮，用户点击后生成可书签的URL。</p>\n</li>\n<li><p>将ui变为一个函数。您需要这样做是因为书签化的应用程序必须重新播放书签化的值：实际上，Shiny会修改每个输入控件的默认<code>value</code>。这意味着不再有一个单一的静态用户界面，而是可能有多个依赖于URL中参数的用户界面，因此它必须是一个函数。</p>\n</li>\n<li><p>在<a href=\"https://rdrr.io/pkg/shiny/man/shinyApp.html\">shinyApp()</a>调用中添加<code>enableBookmarking = &quot;url&quot;</code>。</p>\n</li>\n</ol>\n<p>进行这些更改后，我们得到：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>request<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">      sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">        sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;omega&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;omega&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;delta&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;delta&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;damping&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;damping&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0.9</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">0.001</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;length&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;length&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        bookmarkButton<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">      <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">        plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;fig&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">      <span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shinyApp<span class=\"punctuation\">(</span>ui<span class=\"punctuation\">,</span> server<span class=\"punctuation\">,</span> enableBookmarking <span class=\"operator\">=</span> <span class=\"string\">&quot;url&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>您可以在<a href=\"https://hadley.shinyapps.io/ms-bookmark-url\">https://hadley.shinyapps.io/ms-bookmark-url</a>尝试一下。如果您在应用程序中操作并书签了一些有趣的状态，您会发现生成的URL看起来像这样：</p>\n<ul>\n<li><p><a href=\"https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&damping=1&delta=1&length=100&omega=1\">https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1</a></p>\n</li>\n<li><p><a href=\"https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&damping=0.966&delta=1.25&length=100&omega=-0.54\">https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54</a></p>\n</li>\n<li><p><a href=\"https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&damping=0.997&delta=1.37&length=500&omega=-0.9\">https://hadley.shinyapps.io/ms-bookmark-url/?_inputs_&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9</a></p>\n</li>\n</ul>\n<p>为了理解发生了什么，让我们以第一个URL为例，将其分解成几个部分：</p>\n<ul>\n<li><p><code>http://</code> 是与应用程序通信时使用的“协议”。这始终是<code>http</code>或<code>https</code>。</p>\n</li>\n<li><p><code>hadley.shinyapps.io/ms-bookmark-url</code> 是应用程序的位置。</p>\n</li>\n</ul>\n<p>问号<code>?</code>之后的所有内容都是“参数”。每个参数之间用<code>&amp;</code>分隔，如果将其分解，您可以看到应用程序中每个输入的值：</p>\n<ul>\n<li><p>damping&#x3D;1</p>\n</li>\n<li><p>delta&#x3D;1</p>\n</li>\n<li><p>length&#x3D;100</p>\n</li>\n<li><p>omega&#x3D;1</p>\n</li>\n</ul>\n<p>因此，“生成书签”意味着在URL的参数中记录输入的当前值。如果您在本地进行操作，URL看起来会略有不同：</p>\n<ul>\n<li><p><a href=\"http://127.0.0.1:4087/?_inputs_&damping=1&delta=1&length=100&omega=1\">http://127.0.0.1:4087/?_inputs_&amp;damping=1&amp;delta=1&amp;length=100&amp;omega=1</a></p>\n</li>\n<li><p><a href=\"http://127.0.0.1:4087/?_inputs_&damping=0.966&delta=1.25&length=100&omega=-0.54\">http://127.0.0.1:4087/?_inputs_&amp;damping=0.966&amp;delta=1.25&amp;length=100&amp;omega=-0.54</a></p>\n</li>\n<li><p><a href=\"http://127.0.0.1:4087/?_inputs_&damping=0.997&delta=1.37&length=500&omega=-0.9\">http://127.0.0.1:4087/?_inputs_&amp;damping=0.997&amp;delta=1.37&amp;length=500&amp;omega=-0.9</a></p>\n</li>\n</ul>\n<p>除了将<code>hadley.shinyapps.io/ms-bookmark-url</code>替换为类似<code>127.0.0.1:4087</code>的内容外，大多数部分都是相同的。<code>127.0.0.1</code>是一个特殊地址，始终指向您自己的计算机，而<code>4087</code>是一个随机分配的端口。通常，不同的应用程序会获得不同的路径或IP地址，但如果您在自己的计算机上托管多个应用程序，则无法做到这一点。</p>\n<h3 id=\"11-1-1-更新URL\"><a href=\"#11-1-1-更新URL\" class=\"headerlink\" title=\"11.1.1 更新URL\"></a>11.1.1 更新URL</h3><p>除了提供一个明确的按钮外，另一种选择是自动更新浏览器中的URL。这允许用户在其浏览器中使用用户书签命令，或者从地址栏复制和粘贴URL。</p>\n<p>自动更新URL需要在服务器函数中编写一些模板代码：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Automatically bookmark every time an input changes</span></span><br><span class=\"line\">observe<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  reactiveValuesToList<span class=\"punctuation\">(</span>input<span class=\"punctuation\">)</span></span><br><span class=\"line\">  session<span class=\"operator\">$</span>doBookmark<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># Update the query string</span></span><br><span class=\"line\">onBookmarked<span class=\"punctuation\">(</span>updateQueryString<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>这给我们提供了一个更新后的服务器函数，如下所示：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  t <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>seq<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span><span class=\"built_in\">length</span><span class=\"punctuation\">,</span> <span class=\"built_in\">length</span> <span class=\"operator\">=</span> input<span class=\"operator\">$</span><span class=\"built_in\">length</span> <span class=\"operator\">*</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  x <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"built_in\">sin</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>omega <span class=\"operator\">*</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> input<span class=\"operator\">$</span>delta<span class=\"punctuation\">)</span> <span class=\"operator\">*</span> input<span class=\"operator\">$</span>damping <span class=\"operator\">^</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  y <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"built_in\">sin</span><span class=\"punctuation\">(</span>t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span> input<span class=\"operator\">$</span>damping <span class=\"operator\">^</span> t<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">  output<span class=\"operator\">$</span>fig <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    plot<span class=\"punctuation\">(</span>x<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> y<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> axes <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> xlab <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> ylab <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> type <span class=\"operator\">=</span> <span class=\"string\">&quot;l&quot;</span><span class=\"punctuation\">,</span> lwd <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  observe<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    reactiveValuesToList<span class=\"punctuation\">(</span>input<span class=\"punctuation\">)</span></span><br><span class=\"line\">    session<span class=\"operator\">$</span>doBookmark<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  onBookmarked<span class=\"punctuation\">(</span>updateQueryString<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shinyApp<span class=\"punctuation\">(</span>ui<span class=\"punctuation\">,</span> server<span class=\"punctuation\">,</span> enableBookmarking <span class=\"operator\">=</span> <span class=\"string\">&quot;url&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>这会产生<a href=\"https://hadley.shinyapps.io/ms-bookmark-auto\">https://hadley.shinyapps.io/ms-bookmark-auto</a>——由于URL现在会自动更新，您可以从用户界面中删除书签按钮。</p>\n<h3 id=\"11-1-2-存储更丰富的状态\"><a href=\"#11-1-2-存储更丰富的状态\" class=\"headerlink\" title=\"11.1.2 存储更丰富的状态\"></a>11.1.2 存储更丰富的状态</h3><p>到目前为止，我们使用了<code>enableBookmarking = &quot;url&quot;</code>，它直接在URL中存储状态。这是一个很好的起点，因为它非常简单，可以在您可能部署Shiny应用的任何地方工作。然而，可以想象，如果您有大量的输入，URL会变得非常长，而且显然无法捕获上传的文件。</p>\n<p>对于这些情况，您可能想要使用<code>enableBookmarking = &quot;server&quot;</code>，它将状态保存到服务器上的<code>.rds</code>文件。这总是生成一个简短的、不透明的URL，但需要在服务器上额外存储。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">shinyApp<span class=\"punctuation\">(</span>ui<span class=\"punctuation\">,</span> server<span class=\"punctuation\">,</span> enableBookmarking <span class=\"operator\">=</span> <span class=\"string\">&quot;server&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>目前，shinyapps.io尚不支持服务器端书签，因此您需要在本地尝试。如果您这样做，您会看到书签按钮生成类似以下的URL：</p>\n<ul>\n<li><p><a href=\"http://127.0.0.1:4087/?_state_id_=0d645f1b28f05c97\">http://127.0.0.1:4087/?_state_id_=0d645f1b28f05c97</a></p>\n</li>\n<li><p><a href=\"http://127.0.0.1:4087/?_state_id_=87b56383d8a1062c\">http://127.0.0.1:4087/?_state_id_=87b56383d8a1062c</a></p>\n</li>\n<li><p><a href=\"http://127.0.0.1:4087/?_state_id_=c8b0291ba622b69c\">http://127.0.0.1:4087/?_state_id_=c8b0291ba622b69c</a></p>\n</li>\n</ul>\n<p>这些URL与您工作目录中匹配的目录配对：</p>\n<ul>\n<li><p>shiny_bookmarks&#x2F;0d645f1b28f05c97</p>\n</li>\n<li><p>shiny_bookmarks&#x2F;87b56383d8a1062c</p>\n</li>\n<li><p>shiny_bookmarks&#x2F;c8b0291ba622b69c</p>\n</li>\n</ul>\n<p>服务器端书签的主要缺点是它需要在服务器上保存文件，而且不清楚这些文件需要保留多长时间。如果您正在书签化复杂的状态并且从未删除这些文件，那么随着时间的推移，您的应用将占用越来越多的磁盘空间。如果您删除文件，一些旧书签将停止工作。</p>\n<h2 id=\"11-2-书签挑战\"><a href=\"#11-2-书签挑战\" class=\"headerlink\" title=\"11.2 书签挑战\"></a>11.2 书签挑战</h2><p>自动书签功能依赖于响应式图表。它使用保存的值初始化输入，然后重新播放所有的响应式表达式和输出，只要您的应用的响应式图表简单明了，就会产生与您看到的相同的应用。本节简要介绍了一些需要特别注意的情况：</p>\n<ul>\n<li><p>如果您的应用使用了随机数，即使所有输入都相同，结果也可能不同。如果确保每次生成相同的数字非常重要，您需要思考如何使随机过程可重复。最简单的方法是使用<a href=\"https://rdrr.io/pkg/shiny/man/repeatable.html\">repeatable()</a>函数；有关更多详细信息，请参阅相关文档。</p>\n</li>\n<li><p>如果您有选项卡，并希望书签和恢复活动选项卡，请确保在调用<a href=\"https://rdrr.io/pkg/shiny/man/tabsetPanel.html\">tabsetPanel()</a>时提供一个id。</p>\n</li>\n<li><p>如果有不应被书签记录的输入，例如它们包含不应共享的个人信息，请在服务器函数的某个位置调用<a href=\"https://rdrr.io/pkg/shiny/man/setBookmarkExclude.html\">setBookmarkExclude()</a>。例如，<code>setBookmarkExclude(c(&quot;secret1&quot;, &quot;secret2&quot;))</code>将确保<code>secret1</code>和<code>secret2</code>输入不会被书签记录。</p>\n</li>\n<li><p>如果您在自己的<a href=\"https://rdrr.io/pkg/shiny/man/reactiveValues.html\">reactiveValues()</a>对象中手动管理响应式状态（我们将在第<code>16</code>章中讨论），则需要使用<a href=\"https://rdrr.io/pkg/shiny/man/onBookmark.html\">onBookmark()</a>和<a href=\"https://rdrr.io/pkg/shiny/man/onBookmark.html\">onRestore()</a>回调来手动保存和加载额外的状态。有关更多详细信息，请参阅<a href=\"https://shiny.rstudio.com/articles/advanced-bookmarking.html\">高级书签</a>。</p>\n</li>\n</ul>\n<h2 id=\"11-3-练习\"><a href=\"#11-3-练习\" class=\"headerlink\" title=\"11.3 练习\"></a>11.3 练习</h2><ol>\n<li><p>为<a href=\"https://ambient.data-imaginist.com/reference/noise_simplex.html\">ambient::noise_simplex()</a>的结果生成可视化应用。您的应用应允许用户控制频率、分形、间隙和增益，并且应支持书签功能。如何确保从书签重新加载时图像看起来完全相同？（考虑seed参数的含义）。</p>\n</li>\n<li><p>创建一个简单的应用，允许您上传CSV文件，并为其添加书签。上传几个文件，然后查看<code>shiny_bookmarks</code>。这些文件是如何与书签对应的？（提示：您可以使用<a href=\"https://rdrr.io/r/base/readRDS.html\">readRDS()</a>来查看Shiny生成的缓存文件的内容）。</p>\n</li>\n</ol>\n<h2 id=\"11-4-总结\"><a href=\"#11-4-总结\" class=\"headerlink\" title=\"11.4 总结\"></a>11.4 总结</h2><p>本章介绍了如何为您的应用程序启用书签功能。书签功能对您的用户来说是一个很好的特性，因为它允许他们轻松地将自己的工作与他人分享。接下来，我们将讨论如何在Shiny应用程序中使用整洁评估。整洁评估是许多tidyverse函数的一个特性，如果您希望允许用户在（例如）dplyr管道或ggplot2图形中更改变量，那么您需要了解这个特性。</p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"编程","path":"api/tags/编程.json"},{"name":"Shiny入门系列","path":"api/tags/Shiny入门系列.json"}]},{"title":"Shiny从入门到入定——10-动态UI","slug":"Shiny从入门到入定——10-动态UI","date":"2024-04-27T09:05:46.000Z","updated":"2024-04-27T09:19:58.639Z","comments":true,"path":"api/articles/Shiny从入门到入定——10-动态UI.json","excerpt":null,"keywords":null,"cover":"https://d33wubrfki0l68.cloudfront.net/45d9b7c2dabd64a4597e370d2b84c0dc01cf8a2f/2dc99/demos/action-dynamic/update-basics-onload.png","content":"<h1 id=\"10-动态UI\"><a href=\"#10-动态UI\" class=\"headerlink\" title=\"10 动态UI\"></a>10 动态UI</h1><p>到目前为止，我们已经看到了UI和server函数之间的清晰分离：用户界面在应用程序启动时静态定义，因此它无法对应用程序中发生的任何事情做出响应。在本章中，您将学习如何创建动态用户界面，通过server函数中运行的代码来更改UI。</p>\n<p>创建动态用户界面有三个关键技术：</p>\n<ul>\n<li>使用<code>update</code>系列的函数来修改输入控件的参数。</li>\n<li>使用<a href=\"https://rdrr.io/pkg/shiny/man/tabsetPanel.html\">tabsetPanel()</a>来有条件地显示和隐藏用户界面的部分。</li>\n<li>使用<a href=\"https://rdrr.io/pkg/shiny/man/htmlOutput.html\">uiOutput()</a>和<a href=\"https://rdrr.io/pkg/shiny/man/renderUI.html\">renderUI()</a>通过代码生成用户界面的选定部分。</li>\n</ul>\n<p>这三个工具为您提供了相当强大的功能，通过修改输入和输出来响应用户。我将演示一些您可以应用它们的更有用的方式，但最终您的创造力是唯一的限制。同时，这些工具可能会使您的应用程序变得更难理解，因此请谨慎使用，并始终努力使用解决您问题的最简单技术。</p>\n<p>接下来是R代码库的加载部分：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>shiny<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>dplyr<span class=\"punctuation\">,</span> warn.conflicts <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"10-1-更新输入\"><a href=\"#10-1-更新输入\" class=\"headerlink\" title=\"10.1 更新输入\"></a>10.1 更新输入</h2><p>我们将从一个简单的技术开始，该技术允许您在创建后修改输入：<code>update</code>系列的函数。每个输入控件，例如<code>textInput()</code>，都配有一个更新函数，例如<code>updateTextInput()</code>，允许您在创建后修改该控件。</p>\n<p>请考虑以下代码示例，结果如<code>图10.1</code>所示。该应用程序有两个输入控件，它们控制另一个输入控件（滑块）的范围（最小值和最大值）。关键的想法是使用<a href=\"https://rdrr.io/pkg/shiny/man/observeEvent.html\">observeEvent()</a>来触发<a href=\"https://rdrr.io/pkg/shiny/man/updateSliderInput.html\">updateSliderInput()</a>，每当最小或最大输入发生变化时。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Minimum&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;max&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Maximum&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span>  </span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span><span class=\"built_in\">max</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> input<span class=\"operator\">$</span><span class=\"built_in\">max</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>在这个例子中，<code>observeEvent()</code>监视<code>min</code>和<code>max</code>输入的变化，并在它们变化时调用<code>updateSliderInput()</code>来更新滑块的最小和最大值。<code>renderText()</code>用于在<code>textOutput()</code>控件中显示当前范围。</p>\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/45d9b7c2dabd64a4597e370d2b84c0dc01cf8a2f/2dc99/demos/action-dynamic/update-basics-onload.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/45d9b7c2dabd64a4597e370d2b84c0dc01cf8a2f/2dc99/demos/action-dynamic/update-basics-onload.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/e5a1387f21bee28260731f6fb84991e188af5ec2/8cfbf/demos/action-dynamic/update-basics-max-increase.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/e5a1387f21bee28260731f6fb84991e188af5ec2/8cfbf/demos/action-dynamic/update-basics-max-increase.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/fcca996a780ec2cbaf306e764a577649e6fdca4b/5ecfc/demos/action-dynamic/update-basics-min-decrease.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/fcca996a780ec2cbaf306e764a577649e6fdca4b/5ecfc/demos/action-dynamic/update-basics-min-decrease.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr>\n<td colspan=\"3\">图10.1 应用程序加载时的界面（左），增加最大值后的界面（中），然后减少最小值后的界面（右）。请访问 <a href=\"https://hadley.shinyapps.io/ms-update-basics\">https://hadley.shinyapps.io/ms-update-basics</a> 查看实时效果\n</td>\n</tr>\n</table>\n\n<p>更新函数与其他Shiny函数有些不同：它们都接受输入的名称（作为字符串）作为<code>inputId</code>参数。其余的参数对应于输入构造函数中可以在创建后修改的参数。</p>\n<p>为了帮助您掌握更新函数的使用，我将展示几个简单的示例，然后我们将深入探讨使用分层选择框的复杂案例研究，最后讨论循环引用的问题。</p>\n<h3 id=\"10-1-1-简单应用\"><a href=\"#10-1-1-简单应用\" class=\"headerlink\" title=\"10.1.1 简单应用\"></a>10.1.1 简单应用</h3><p>更新函数最简单的用法是为用户提供一些小的便利。例如，您可能希望轻松地将参数重置为其初始值。以下代码片段展示了如何结合使用<a href=\"https://rdrr.io/pkg/shiny/man/actionButton.html\">actionButton()</a>、<a href=\"https://rdrr.io/pkg/shiny/man/observeEvent.html\">observeEvent()</a>和<a href=\"https://rdrr.io/pkg/shiny/man/updateSliderInput.html\">updateSliderInput()</a>，结果如<code>图10.2</code>所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;x1&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;x1&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;x2&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;x2&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;x3&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;x3&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;reset&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Reset&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>reset<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;x1&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;x2&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSliderInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;x3&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/b319bdb38cce5a357ba4131d17fec8b3a8bd34fd/cc473/demos/action-dynamic/update-reset-onload.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b319bdb38cce5a357ba4131d17fec8b3a8bd34fd/cc473/demos/action-dynamic/update-reset-onload.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/b5061a18295fbec4f08dd399e32ce252d2ad6eb9/230d4/demos/action-dynamic/update-reset-set.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b5061a18295fbec4f08dd399e32ce252d2ad6eb9/230d4/demos/action-dynamic/update-reset-set.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/b319bdb38cce5a357ba4131d17fec8b3a8bd34fd/8c5f7/demos/action-dynamic/update-reset-reset.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b319bdb38cce5a357ba4131d17fec8b3a8bd34fd/8c5f7/demos/action-dynamic/update-reset-reset.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.2 应用加载时（左图），拖动一些滑块后（中图），然后点击重置（右图）。在线查看地址：<a href=\"https://hadley.shinyapps.io/ms-update-reset\">https://hadley.shinyapps.io/ms-update-reset</a></td></tr>\n</table>\n\n<p>一个类似的应用是调整动作按钮的文本，以便你确切知道它将执行什么操作。图<code>10.3</code>展示了下面代码的结果。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Simulations&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;simulate&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Simulate&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    label <span class=\"operator\">&lt;-</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;Simulate &quot;</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span> <span class=\"string\">&quot; times&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateActionButton<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;simulate&quot;</span><span class=\"punctuation\">,</span> label <span class=\"operator\">=</span> label<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/f6604343f39fe08be631b06ddac37b2c00d73ea5/f636b/demos/action-dynamic/update-button-onload.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/f6604343f39fe08be631b06ddac37b2c00d73ea5/f636b/demos/action-dynamic/update-button-onload.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/d65b9991e6b08e57700bf2cc8f5fafafe59ebc4e/03e2a/demos/action-dynamic/update-button-set1.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/d65b9991e6b08e57700bf2cc8f5fafafe59ebc4e/03e2a/demos/action-dynamic/update-button-set1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/a2a75084db3d975c48dc56ef70eebd2906eae356/a924e/demos/action-dynamic/update-button-set100.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/a2a75084db3d975c48dc56ef70eebd2906eae356/a924e/demos/action-dynamic/update-button-set100.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图 10.3 应用加载时（左），将模拟次数设置为 1（中），再将模拟次数设置为 100（右）。在线查看地址：<a href=\"https://hadley.shinyapps.io/ms-update-button\">https://hadley.shinyapps.io/ms-update-button</a></td></tr>\n</table>\n\n<p>有很多方法可以用这种方式使用更新函数；在开发复杂应用时，要注意找出向用户提供更多信息的方法。一个特别重要的应用是通过逐步筛选来简化从一长串可能选项中进行选择的过程。这通常是“分层选择框”的问题。</p>\n<h3 id=\"10-1-2-分层选择框\"><a href=\"#10-1-2-分层选择框\" class=\"headerlink\" title=\"10.1.2 分层选择框\"></a>10.1.2 分层选择框</h3><p>更新函数的一个更复杂但特别有用的应用是允许在多个类别之间进行交互式深入探索。我将用一个来自 <a href=\"https://www.kaggle.com/kyanyoga/sample-sales-data\">https://www.kaggle.com/kyanyoga/sample-sales-data</a> 的销售仪表板的虚拟数据来说明它们的使用方法。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sales <span class=\"operator\">&lt;-</span> vroom<span class=\"operator\">::</span>vroom<span class=\"punctuation\">(</span><span class=\"string\">&quot;sales-dashboard/sales_data_sample.csv&quot;</span><span class=\"punctuation\">,</span> col_types <span class=\"operator\">=</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> na <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">sales <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  select<span class=\"punctuation\">(</span>TERRITORY<span class=\"punctuation\">,</span> CUSTOMERNAME<span class=\"punctuation\">,</span> ORDERNUMBER<span class=\"punctuation\">,</span> everything<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">  arrange<span class=\"punctuation\">(</span>ORDERNUMBER<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; # A tibble: 2,823 × 25</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    TERRITORY CUSTOM…¹ ORDER…² QUANT…³ PRICE…⁴ ORDER…⁵ SALES ORDER…⁶ STATUS QTR_ID</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    &lt;chr&gt;     &lt;chr&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt;</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  1 NA        Online …   10100      30   100         3 5151  1/6/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  2 NA        Online …   10100      50    67.8       2 3390  1/6/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  3 NA        Online …   10100      22    86.5       4 1903. 1/6/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  4 NA        Online …   10100      49    34.5       1 1689. 1/6/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  5 EMEA      Blauer …   10101      25   100         4 3782  1/9/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  6 EMEA      Blauer …   10101      26   100         1 3773. 1/9/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  7 EMEA      Blauer …   10101      45    31.2       3 1404  1/9/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  8 EMEA      Blauer …   10101      46    53.8       2 2473. 1/9/20… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;  9 NA        Vitachr…   10102      39   100         2 4808. 1/10/2… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 10 NA        Vitachr…   10102      41    50.1       1 2056. 1/10/2… Shipp…      1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; # … with 2,813 more rows, 15 more variables: MONTH_ID &lt;dbl&gt;, YEAR_ID &lt;dbl&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   PRODUCTLINE &lt;chr&gt;, MSRP &lt;dbl&gt;, PRODUCTCODE &lt;chr&gt;, PHONE &lt;chr&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   ADDRESSLINE1 &lt;chr&gt;, ADDRESSLINE2 &lt;chr&gt;, CITY &lt;chr&gt;, STATE &lt;chr&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   POSTALCODE &lt;chr&gt;, COUNTRY &lt;chr&gt;, CONTACTLASTNAME &lt;chr&gt;,</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   CONTACTFIRSTNAME &lt;chr&gt;, DEALSIZE &lt;chr&gt;, and abbreviated variable names</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   ¹​CUSTOMERNAME, ²​ORDERNUMBER, ³​QUANTITYORDERED, ⁴​PRICEEACH, ⁵​ORDERLINENUMBER,</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; #   ⁶​ORDERDATE</span></span><br></pre></td></tr></table></figure>\n\n<p>在这个演示中，我将重点关注数据中的自然层次结构：</p>\n<ul>\n<li><p>每个区域包含客户。</p>\n</li>\n<li><p>每个客户有多个订单。</p>\n</li>\n<li><p>每个订单包含行。</p>\n</li>\n</ul>\n<p>我想创建一个用户界面，你可以：</p>\n<ul>\n<li><p>选择一个区域来查看所有客户。</p>\n</li>\n<li><p>选择一个客户来查看所有订单。</p>\n</li>\n<li><p>选择一个订单来查看底层行。</p>\n</li>\n</ul>\n<p>用户界面的核心是简单的：我将创建三个选择框和一个输出表格。<code>customername</code>和<code>ordernumber</code>选择框的选项将动态生成，因此我将设置<code>choices = NULL</code>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;territory&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Territory&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> unique<span class=\"punctuation\">(</span>sales<span class=\"operator\">$</span>TERRITORY<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;customername&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Customer&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;ordernumber&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Order number&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>在服务器函数中，我自上而下地工作：</p>\n<ol>\n<li><p>我创建了一个响应式对象 <code>territory()</code>，它包含与所选区域匹配的 <code>sales</code> 中的行。</p>\n</li>\n<li><p>每当 <code>territory()</code> 发生变化时，我都会更新 <code>input$customername</code> 选择框中的选项列表。</p>\n</li>\n<li><p>我创建了另一个响应式对象 <code>customer()</code>，它包含与所选客户匹配的 <code>territory()</code> 中的行。</p>\n</li>\n<li><p>每当 <code>customer()</code> 发生变化时，我都会更新 <code>input$ordernumber</code> 选择框中的选项列表。</p>\n</li>\n<li><p>我在 <code>output$data</code> 中显示所选订单。</p>\n</li>\n</ol>\n<p>你可以看到下面的组织结构：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  territory <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    filter<span class=\"punctuation\">(</span>sales<span class=\"punctuation\">,</span> TERRITORY <span class=\"operator\">==</span> input<span class=\"operator\">$</span>territory<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>territory<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    choices <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>territory<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"operator\">$</span>CUSTOMERNAME<span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSelectInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;customername&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> choices<span class=\"punctuation\">)</span> </span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  customer <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>customername<span class=\"punctuation\">)</span></span><br><span class=\"line\">    filter<span class=\"punctuation\">(</span>territory<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> CUSTOMERNAME <span class=\"operator\">==</span> input<span class=\"operator\">$</span>customername<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>customer<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    choices <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>customer<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"operator\">$</span>ORDERNUMBER<span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSelectInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;ordernumber&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> choices<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    req<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>ordernumber<span class=\"punctuation\">)</span></span><br><span class=\"line\">    customer<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      filter<span class=\"punctuation\">(</span>ORDERNUMBER <span class=\"operator\">==</span> input<span class=\"operator\">$</span>ordernumber<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">      select<span class=\"punctuation\">(</span>QUANTITYORDERED<span class=\"punctuation\">,</span> PRICEEACH<span class=\"punctuation\">,</span> PRODUCTCODE<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/fe6c81ed4946e87b044fc7cc91b3bb05e4954043/7d64e/demos/action-dynamic/update-nested-territory.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/fe6c81ed4946e87b044fc7cc91b3bb05e4954043/7d64e/demos/action-dynamic/update-nested-territory.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/d3a0d284501015f737373cc8e6f14b27a49de373/0e06a/demos/action-dynamic/update-nested-customername.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/d3a0d284501015f737373cc8e6f14b27a49de373/0e06a/demos/action-dynamic/update-nested-customername.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/b0ae629ca1909719117abfce2d890db7bf379412/37026/demos/action-dynamic/update-nested-orders.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b0ae629ca1909719117abfce2d890db7bf379412/37026/demos/action-dynamic/update-nested-orders.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图 10.4 我选择“EMEA”（左），然后选择“Lyon Souveniers”（中），然后（右）查看订单。在线查看地址：<a href=\"https://hadley.shinyapps.io/ms-update-nested\">https://hadley.shinyapps.io/ms-update-nested</a></td></tr>\n</table>\n\n<p>你可以在 <a href=\"https://hadley.shinyapps.io/ms-update-nested\">https://hadley.shinyapps.io/ms-update-nested</a> 尝试这个简单的示例，或者在 <a href=\"https://github.com/hadley/mastering-shiny/tree/master/sales-dashboard\">https://github.com/hadley/mastering-shiny/tree/master/sales-dashboard</a> 查看一个更加完善的应用示例。</p>\n<h3 id=\"10-1-3-冻结响应式输入\"><a href=\"#10-1-3-冻结响应式输入\" class=\"headerlink\" title=\"10.1.3 冻结响应式输入\"></a>10.1.3 冻结响应式输入</h3><p>有时，这种分层选择会短暂地创建一个无效的输入集，导致出现不想要的输出闪烁。例如，考虑这个简单的应用，你首先选择一个数据集，然后选择要汇总的变量：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dataset&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Choose a dataset&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;pressure&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;cars&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;column&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Choose column&quot;</span><span class=\"punctuation\">,</span> character<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  verbatimTextOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;summary&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  dataset <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>get<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dataset<span class=\"punctuation\">,</span> <span class=\"string\">&quot;package:datasets&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dataset<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateSelectInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;column&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>summary <span class=\"operator\">&lt;-</span> renderPrint<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    summary<span class=\"punctuation\">(</span>dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>column<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果你在 <a href=\"https://hadley.shinyapps.io/ms-freeze\">https://hadley.shinyapps.io/ms-freeze</a> 上尝试这个实时应用，你会注意到当你切换数据集时，摘要输出会短暂地闪烁。这是因为 <a href=\"https://rdrr.io/pkg/shiny/man/updateSelectInput.html\">updateSelectInput()</a> 只有在所有输出和观察者都运行之后才会生效，因此会暂时出现一个状态，即你拥有数据集 B 和来自数据集 A 的变量，因此输出会包含 <code>summary(NULL)</code>。</p>\n<p>你可以通过“freezing”输入值来解决这个问题，使用 <a href=\"https://rdrr.io/pkg/shiny/man/freezeReactiveValue.html\">freezeReactiveValue()</a>。这确保了任何使用输入的响应式对象或输出都不会更新，直到下一次完整的失效周期。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  dataset <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>get<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dataset<span class=\"punctuation\">,</span> <span class=\"string\">&quot;package:datasets&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dataset<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    freezeReactiveValue<span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> <span class=\"string\">&quot;column&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateSelectInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;column&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>summary <span class=\"operator\">&lt;-</span> renderPrint<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    summary<span class=\"punctuation\">(</span>dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[[</span>input<span class=\"operator\">$</span>column<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>请注意，你不需要“thaw”输入值；当 Shiny 检测到会话和服务器再次同步时，这会自动发生。</p>\n<p>你可能会好奇什么时候应该使用 <a href=\"https://rdrr.io/pkg/shiny/man/freezeReactiveValue.html\">freezeReactiveValue()</a>：实际上，当你动态更改输入值时，使用它总是一个好习惯。实际的修改需要一些时间才能流向浏览器，然后再返回给 Shiny，而在此期间，任何对该值的读取都可能是浪费的，在最坏的情况下可能导致错误。使用 <code>freezeReactiveValue()</code> 告诉所有下游计算，输入值是陈旧的，它们应该保存它们的努力，直到它变得有用。</p>\n<h3 id=\"10-1-4-循环引用\"><a href=\"#10-1-4-循环引用\" class=\"headerlink\" title=\"10.1.4 循环引用\"></a>10.1.4 循环引用</h3><p>如果你想使用 update 函数来改变输入的当前<code>value</code>，那么我们需要讨论一个重要的问题。从 Shiny 的角度来看，使用 update 函数来修改值与用户通过点击或输入来修改值没有区别。这意味着 update 函数可以像人类一样触发响应式更新。这意味着你现在已经超出了纯响应式编程的范围，你需要开始担心循环引用和无限循环的问题。</p>\n<p>例如，看看下面这个简单的应用。它包含一个输入控件和一个观察者，后者将其值加一并更新。每次运行 <a href=\"https://rdrr.io/pkg/shiny/man/updateNumericInput.html\">updateNumericInput()</a> 时，它都会更改 <code>input$n</code>，导致 <code>updateNumericInput()</code> 再次运行，因此应用陷入无限循环，持续增加 <code>input$n</code> 的值。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span></span><br><span class=\"line\">    updateNumericInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> input<span class=\"operator\">$</span>n <span class=\"operator\">+</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>虽然你不太可能在自己的应用中创建这种显而易见的问题，但如果你在更新相互依赖的多个控件时，可能会遇到类似的问题，如下一个例子所示。</p>\n<h3 id=\"10-1-5-相互关联的输入\"><a href=\"#10-1-5-相互关联的输入\" class=\"headerlink\" title=\"10.1.5 相互关联的输入\"></a>10.1.5 相互关联的输入</h3><p>在应用中出现循环引用很容易发生在有多个“事实来源”时。例如，假设你想创建一个温度转换应用，用户既可以输入摄氏温度也可以输入华氏温度：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;temp_c&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Celsius&quot;</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;temp_f&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Fahrenheit&quot;</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">,</span> step <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>temp_f<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"built_in\">c</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">round</span><span class=\"punctuation\">(</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>temp_f <span class=\"operator\">-</span> <span class=\"number\">32</span><span class=\"punctuation\">)</span> <span class=\"operator\">*</span> <span class=\"number\">5</span> <span class=\"operator\">/</span> <span class=\"number\">9</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateNumericInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;temp_c&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>temp_c<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    f <span class=\"operator\">&lt;-</span> <span class=\"built_in\">round</span><span class=\"punctuation\">(</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>temp_c <span class=\"operator\">*</span> <span class=\"number\">9</span> <span class=\"operator\">/</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> <span class=\"number\">32</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    updateNumericInput<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;temp_f&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> f<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>如果你尝试这个应用，<a href=\"https://hadley.shinyapps.io/ms-temperature\">https://hadley.shinyapps.io/ms-temperature</a>，你会发现它大部分时候可以正常工作，但你可能也会注意到它有时会触发多次更改。例如：</p>\n<ul>\n<li><p>将温度设为120华氏度，然后点击向下的箭头。</p>\n</li>\n<li><p>华氏度变为119，摄氏度更新为48。</p>\n</li>\n<li><p>48摄氏度转换为118华氏度，因此华氏度再次变为118。</p>\n</li>\n<li><p>幸运的是，118华氏度仍然是48摄氏度，所以更新在那里停止了。</p>\n</li>\n</ul>\n<p>这个问题没有解决办法，因为你在应用中有一个概念（温度），但有两个表达式（摄氏度和华氏度）。在这里我们很幸运，因为循环迅速收敛到一个同时满足两个约束的值。一般来说，除非你愿意非常仔细地分析你创建的底层动态系统的收敛性质，否则最好避免这种情况。</p>\n<h3 id=\"10-1-6-练习\"><a href=\"#10-1-6-练习\" class=\"headerlink\" title=\"10.1.6 练习\"></a>10.1.6 练习</h3><ol>\n<li><p>请在下面的用户界面中添加一个服务器函数，以更新<code>input$date</code>，这样你只能选择<code>input$year</code>中的日期。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;year&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;year&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">2020</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  dateInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;date&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;date&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>请在下面的用户界面中添加一个服务器函数，根据<code>input$state</code>更新<code>input$county</code>的选择。作为一个额外的挑战，请也将路易斯安那州的标签从“County”改为“Parish”，阿拉斯加州的标签改为“Borough”。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>openintro<span class=\"punctuation\">,</span> warn.conflicts <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Loading required package: airports</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Loading required package: cherryblossom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Loading required package: usdata</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; Registered S3 methods overwritten by &#x27;readr&#x27;:</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   method                    from </span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   as.data.frame.spec_tbl_df vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   as_tibble.spec_tbl_df     vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   format.col_spec           vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   print.col_spec            vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   print.collector           vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   print.date_names          vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   print.locale              vroom</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;   str.col_spec              vroom</span></span><br><span class=\"line\">states <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>county<span class=\"operator\">$</span>state<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;state&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;State&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> states<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;county&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;County&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用服务器函数完善下面的用户界面，根据<code>input$continent</code>更新<code>input$country</code>的选择。使用<code>output$data</code>显示所有匹配的行。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>gapminder<span class=\"punctuation\">)</span></span><br><span class=\"line\">continents <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>gapminder<span class=\"operator\">$</span>continent<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;continent&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Continent&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> continents<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;country&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Country&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>扩展之前的应用，以便您还可以选择选择所有大洲，从而查看所有国家。您需要将<code>“(All)”</code>添加到选择列表中，然后在过滤时特殊处理它。</p>\n</li>\n<li><p>在<a href=\"https://community.rstudio.com/t/29307\">https://community.rstudio.com/t/29307</a>?上描述的问题的核心是什么？</p>\n</li>\n</ol>\n<h2 id=\"10-2-动态可见性\"><a href=\"#10-2-动态可见性\" class=\"headerlink\" title=\"10.2 动态可见性\"></a>10.2 动态可见性</h2><p>复杂性的下一步是有选择地显示和隐藏用户界面中的部分。如果您了解一些JavaScript和CSS，那么可以使用更复杂的方法，但有一种有用的技术不需要任何额外的知识：使用选项卡集（如在6.3.1节中介绍的）隐藏可选的用户界面。这是一种巧妙的技巧，允许您根据需要显示和隐藏用户界面，而无需从头开始重新生成它（您将在下一节中学到）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;controller&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Show&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;panel&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      tabsetPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">        id <span class=\"operator\">=</span> <span class=\"string\">&quot;switcher&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        type <span class=\"operator\">=</span> <span class=\"string\">&quot;hidden&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        tabPanelBody<span class=\"punctuation\">(</span><span class=\"string\">&quot;panel1&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Panel 1 content&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        tabPanelBody<span class=\"punctuation\">(</span><span class=\"string\">&quot;panel2&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Panel 2 content&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        tabPanelBody<span class=\"punctuation\">(</span><span class=\"string\">&quot;panel3&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Panel 3 content&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">      <span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>controller<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateTabsetPanel<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;switcher&quot;</span><span class=\"punctuation\">,</span> selected <span class=\"operator\">=</span> input<span class=\"operator\">$</span>controller<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/177d392d2358ae933be3c5ae9a78b2f076d8cce0/f34ae/demos/action-dynamic/dynamic-panels.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/177d392d2358ae933be3c5ae9a78b2f076d8cce0/f34ae/demos/action-dynamic/dynamic-panels.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/a4ab38457f2b2194dfd2a5e1792f1d38fff0b6dc/90b0c/demos/action-dynamic/dynamic-panels-panel2.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/a4ab38457f2b2194dfd2a5e1792f1d38fff0b6dc/90b0c/demos/action-dynamic/dynamic-panels-panel2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/7dc90302d452a421cc68547265384f212c58db8f/0dc9c/demos/action-dynamic/dynamic-panels-panel3.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/7dc90302d452a421cc68547265384f212c58db8f/0dc9c/demos/action-dynamic/dynamic-panels-panel3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.5 选择panel1（左），然后选择panel2（中），最后选择panel3（右）。查看实时效果请访问 <a href=\"https://hadley.shinyapps.io/ms-dynamic-panels\">https://hadley.shinyapps.io/ms-dynamic-panels</a></td></tr>\n</table>\n\n<p>这里主要有两个想法：</p>\n<ul>\n<li><p>使用带有隐藏选项卡的选项卡集面板。</p>\n</li>\n<li><p>使用<a href=\"https://rdrr.io/pkg/shiny/man/updateTabsetPanel.html\">updateTabsetPanel()</a>从服务器切换选项卡。</p>\n</li>\n</ul>\n<p>这是一个简单的想法，但结合一点创意，它将赋予你相当大的能力。接下来的两节将举例说明如何在实践中使用它的两个小例子。</p>\n<h3 id=\"10-2-1-条件用户界面\"><a href=\"#10-2-1-条件用户界面\" class=\"headerlink\" title=\"10.2.1 条件用户界面\"></a>10.2.1 条件用户界面</h3><p>想象一下，你想要一个应用，允许用户模拟正态分布、均匀分布和指数分布。每种分布都有不同的参数，因此我们需要某种方法来显示不同分布的不同控件。在这里，我将为每个分布的唯一用户界面放在它自己的<a href=\"https://rdrr.io/pkg/shiny/man/tabPanel.html\">tabPanel()</a>中，然后将三个选项卡组织成一个<a href=\"https://rdrr.io/pkg/shiny/man/tabsetPanel.html\">tabsetPanel()</a>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameter_tabs <span class=\"operator\">&lt;-</span> tabsetPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">  id <span class=\"operator\">=</span> <span class=\"string\">&quot;params&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  type <span class=\"operator\">=</span> <span class=\"string\">&quot;hidden&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;normal&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;sd&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;standard deviation&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;uniform&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;min&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;max&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;max&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;exponential&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;rate&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rate&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>然后，我将把这部分嵌入到一个更完整的用户界面中，允许用户选择样本数量，并显示结果的直方图：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dist&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Distribution&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">        choices <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;normal&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;uniform&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;exponential&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">      <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Number of samples&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      parameter_tabs<span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;hist&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>请注意，我已经仔细地将<code>input$dist</code>中的<code>choices</code>与选项卡面板的名称相匹配。这使得编写下面的<a href=\"https://rdrr.io/pkg/shiny/man/observeEvent.html\">observeEvent()</a>代码变得很容易，该代码会在分布变化时自动切换控件。该应用的其他部分使用了你已经熟悉的技术。最终结果如图10.6所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dist<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateTabsetPanel<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;params&quot;</span><span class=\"punctuation\">,</span> selected <span class=\"operator\">=</span> input<span class=\"operator\">$</span>dist<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  </span><br><span class=\"line\">  sample <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"built_in\">switch</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dist<span class=\"punctuation\">,</span></span><br><span class=\"line\">      normal <span class=\"operator\">=</span> rnorm<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>mean<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>sd<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      uniform <span class=\"operator\">=</span> runif<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span><span class=\"built_in\">min</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span><span class=\"built_in\">max</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      exponential <span class=\"operator\">=</span> rexp<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>rate<span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>hist <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span>hist<span class=\"punctuation\">(</span>sample<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/cce8beeaa545088bdba647ce61f6cb67f1eee04e/48a70/demos/action-dynamic/dynamic-conditional-normal.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/cce8beeaa545088bdba647ce61f6cb67f1eee04e/48a70/demos/action-dynamic/dynamic-conditional-normal.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/d4e7bf3c6b1d72e2733aeaf06741ab542607e288/882f0/demos/action-dynamic/dynamic-conditional-uniform.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/d4e7bf3c6b1d72e2733aeaf06741ab542607e288/882f0/demos/action-dynamic/dynamic-conditional-uniform.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/a5699032e1e6b89fcd6d2c87bcf2d8b616b82e8c/c0cb8/demos/action-dynamic/dynamic-conditional-exponential.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/a5699032e1e6b89fcd6d2c87bcf2d8b616b82e8c/c0cb8/demos/action-dynamic/dynamic-conditional-exponential.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.6 正态分布（左）、均匀分布（中）和指数分布（右）的结果。查看实时效果请访问 <a href=\"https://hadley.shinyapps.io/ms-dynamic-conditional\">https://hadley.shinyapps.io/ms-dynamic-conditional</a></td></tr>\n</table>\n\n<p>请注意，（例如）<code>input$mean</code>的值是否对用户可见是独立的。底层的HTML控件仍然存在；只是你看不到它。</p>\n<h3 id=\"10-2-2-向导界面\"><a href=\"#10-2-2-向导界面\" class=\"headerlink\" title=\"10.2.2 向导界面\"></a>10.2.2 向导界面</h3><p>你还可以使用这个想法来创建一个“wizard”，这是一种界面类型，通过将其分散到多个页面上，更容易收集大量信息。在这里，我们在每个“page”中嵌入动作按钮，使其易于向前和向后移动。结果如图10.7所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  tabsetPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">    id <span class=\"operator\">=</span> <span class=\"string\">&quot;wizard&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    type <span class=\"operator\">=</span> <span class=\"string\">&quot;hidden&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_1&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"string\">&quot;Welcome!&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_12&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;next&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_2&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"string\">&quot;Only one page to go&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_21&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;prev&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_23&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;next&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    tabPanel<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_3&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      <span class=\"string\">&quot;You&#x27;re done!&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_32&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;prev&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  switch_page <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>i<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    updateTabsetPanel<span class=\"punctuation\">(</span>inputId <span class=\"operator\">=</span> <span class=\"string\">&quot;wizard&quot;</span><span class=\"punctuation\">,</span> selected <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;page_&quot;</span><span class=\"punctuation\">,</span> i<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>page_12<span class=\"punctuation\">,</span> switch_page<span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>page_21<span class=\"punctuation\">,</span> switch_page<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>page_23<span class=\"punctuation\">,</span> switch_page<span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>page_32<span class=\"punctuation\">,</span> switch_page<span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/701f300df256124c9aa4cb5d9a6cb6245c7f70ce/e783b/demos/action-dynamic/wizard-1.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/701f300df256124c9aa4cb5d9a6cb6245c7f70ce/e783b/demos/action-dynamic/wizard-1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/8b0644dfec78873a45545620af591b31323fa11c/c61f6/demos/action-dynamic/wizard-2.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/8b0644dfec78873a45545620af591b31323fa11c/c61f6/demos/action-dynamic/wizard-2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/9089ca7b0a519d51ae51c4991b26234561a41e67/18197/demos/action-dynamic/wizard-3.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/9089ca7b0a519d51ae51c4991b26234561a41e67/18197/demos/action-dynamic/wizard-3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.7 向导界面将复杂的用户界面分割成多个页面。在这里，我们通过一个非常简单的示例来演示这个想法，点击“下一步”以进入下一页。查看实时效果请访问 <a href=\"https://hadley.shinyapps.io/ms-wizard\">https://hadley.shinyapps.io/ms-wizard</a></td></tr>\n</table>\n\n\n<p>请注意，使用<code>switch_page()</code>函数可以减少服务器代码中的重复量。我们将在第18章再次回到这个想法，然后在第<code>19.4.2</code>节中创建一个模块来自动化向导界面。</p>\n<h3 id=\"10-2-3-练习\"><a href=\"#10-2-3-练习\" class=\"headerlink\" title=\"10.2.3 练习\"></a>10.2.3 练习</h3><ol>\n<li><p>使用隐藏的选项卡集，仅当用户选中“advanced”复选框时才显示额外的控件。</p>\n</li>\n<li><p>创建一个应用，该应用绘制<code>ggplot(diamonds, aes(carat))</code>，但允许用户选择使用的geom：<a href=\"https://ggplot2.tidyverse.org/reference/geom_histogram.html\">geom_histogram()</a>、<a href=\"https://ggplot2.tidyverse.org/reference/geom_histogram.html\">geom_freqpoly()</a>或<a href=\"https://ggplot2.tidyverse.org/reference/geom_density.html\">geom_density()</a>。使用隐藏的选项卡集，允许用户根据geom选择不同的参数：<code>geom_histogram()</code>和<code>geom_freqpoly()</code>具有binwidth参数；<code>geom_density()</code>具有bw参数。</p>\n</li>\n<li><p>修改你在前一个练习中创建的应用，允许用户选择是否显示每个geom（即，而不是始终使用一个geom，他们可以选择0、1、2或3个）。确保你可以独立控制直方图和频率多边形的binwidth。</p>\n</li>\n</ol>\n<h2 id=\"10-3-使用代码创建用户界面\"><a href=\"#10-3-使用代码创建用户界面\" class=\"headerlink\" title=\"10.3 使用代码创建用户界面\"></a>10.3 使用代码创建用户界面</h2><p>有时，上面描述的技术无法提供您所需的动态性水平：更新函数只允许您更改现有的输入，而选项卡集仅在您具有固定且已知的可能组合集时才有效。有时，您需要根据其他输入创建不同类型的输入（或输出）或不同数量的输入（或输出）。这种最终技术使您能够这样做。</p>\n<p>值得注意的是，您一直使用代码创建用户界面，但到目前为止，您总是在应用启动之前这样做。这种技术使您能够在应用运行时创建和修改用户界面。这个解决方案有两个部分：</p>\n<ul>\n<li><p><a href=\"https://rdrr.io/pkg/shiny/man/htmlOutput.html\">uiOutput()</a> 在用户界面 (ui) 中插入一个占位符。这留下了一个“洞”，您的服务器代码稍后可以填充它。</p>\n</li>\n<li><p><a href=\"https://rdrr.io/pkg/shiny/man/renderUI.html\">renderUI()</a> 在 <code>server()</code> 中被调用，用于将占位符填充为动态生成的用户界面。</p>\n</li>\n</ul>\n<p>我们将通过一个简单的示例来了解这是如何工作的，然后深入探讨一些实际的应用。</p>\n<h3 id=\"10-3-1-入门\"><a href=\"#10-3-1-入门\" class=\"headerlink\" title=\"10.3.1 入门\"></a>10.3.1 入门</h3><p>让我们从一个简单的应用开始，该应用动态地创建输入控件，其类型和标签由另外两个输入控件控制。最终的应用如图<code>10.8</code>所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  textInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;label&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;label&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;type&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;type&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;slider&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;numeric&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  uiOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;numeric&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>numeric <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>type <span class=\"operator\">==</span> <span class=\"string\">&quot;slider&quot;</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dynamic&quot;</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>label<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dynamic&quot;</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>label<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/c7a0fbee966861954422cd6a1d7fd4a39185ec9c/28819/demos/action-dynamic/render-simple-onload.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/c7a0fbee966861954422cd6a1d7fd4a39185ec9c/28819/demos/action-dynamic/render-simple-onload.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/35b772f26ba5a178d1f693ce7de4b12c17a454f3/9cb14/demos/action-dynamic/render-simple-numeric.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/35b772f26ba5a178d1f693ce7de4b12c17a454f3/9cb14/demos/action-dynamic/render-simple-numeric.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/d8a85a47b59618a13f336b7d9d0d7c705d2ef05e/9c957/demos/action-dynamic/render-simple-label.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/d8a85a47b59618a13f336b7d9d0d7c705d2ef05e/9c957/demos/action-dynamic/render-simple-label.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.8 应用加载时（左），然后将类型更改为数值（中），再将标签更改为“我的标签”。查看实时效果请访问 <a href=\"https://hadley.shinyapps.io/ms-render-simple\">https://hadley.shinyapps.io/ms-render-simple</a></td></tr>\n</table>\n\n<p>如果你自己运行这段代码，你会发现应用在加载后需要一段时间才能显示。这是因为它是响应式的：应用必须先加载，触发一个响应事件，然后调用服务器函数，生成要插入页面的HTML。这是<a href=\"https://rdrr.io/pkg/shiny/man/renderUI.html\">renderUI()</a>的一个缺点；过多地依赖它可能会导致用户界面出现延迟。为了获得良好的性能，请尽量使用本章前面描述的技术，保持用户界面的固定部分。</p>\n<p>这种方法还有一个问题：当你更改控件时，会丢失当前选定的值。在使用代码创建用户界面时，保留现有状态是一大挑战。这就是为什么如果适用，选择性显示和隐藏用户界面是更好的方法——因为你没有销毁和重新创建控件，所以不需要做任何事情来保留值。然而，在许多情况下，我们可以通过将新输入的值设置为现有控件的当前值来解决这个问题：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>numeric <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    value <span class=\"operator\">&lt;-</span> isolate<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dynamic<span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>type <span class=\"operator\">==</span> <span class=\"string\">&quot;slider&quot;</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dynamic&quot;</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>label<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> value<span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dynamic&quot;</span><span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>label<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> value<span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>使用 <a href=\"https://rdrr.io/pkg/shiny/man/isolate.html\">isolate()</a> 非常重要。我们将在 <code>15.4.1</code> 节中详细讨论它的作用，但在这里，它确保我们不会创建一个响应式依赖，导致每次 <code>input$dynamic</code> 发生变化时（每当用户修改值时都会发生）都重新运行此代码。我们只希望在 <code>input$type</code> 或 <code>input$label</code> 发生变化时更改它。</p>\n<h3 id=\"10-3-2-多个控件\"><a href=\"#10-3-2-多个控件\" class=\"headerlink\" title=\"10.3.2 多个控件\"></a>10.3.2 多个控件</h3><p>当你需要生成任意数量或类型的控件时，动态用户界面（UI）最有用。这意味着你将使用代码生成用户界面，我建议使用函数式编程来完成此类任务。在这里，我将使用 <a href=\"https://purrr.tidyverse.org/reference/map.html\">purrr::map()</a> 和 <a href=\"https://purrr.tidyverse.org/reference/reduce.html\">purrr::reduce()</a>，但你也可以使用基础的 <a href=\"https://rdrr.io/r/base/lapply.html\">lapply()</a> 和 <a href=\"https://rdrr.io/r/base/funprog.html\">Reduce()</a> 函数来实现同样的效果。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>purrr<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>如果你不熟悉函数式编程中的 <a href=\"https://purrr.tidyverse.org/reference/map.html\">map()</a> 和 <code>reduce()</code>，你可能希望在继续之前先阅读有关<a href=\"https://adv-r.hadley.nz/functionals.html\">Functional programming</a>的内容。我们也将在第 <code>18</code> 章中再次讨论这个想法。这些想法相当复杂，所以如果你在第一次阅读时没有理解，请不要担心。</p>\n<p>为了具体说明，想象一下你想要用户能够提供自己的颜色调色板。他们首先会指定他们想要的颜色的数量，然后为每个颜色提供一个值。用户界面相当简单：我们有一个 <a href=\"https://rdrr.io/pkg/shiny/man/numericInput.html\">numericInput()</a> 来控制输入的数量，一个 <a href=\"https://rdrr.io/pkg/shiny/man/htmlOutput.html\">uiOutput()</a> 用于放置生成的文本框，以及一个 <a href=\"https://rdrr.io/pkg/shiny/man/textOutput.html\">textOutput()</a> 来证明我们已经正确地将所有内容连接在一起。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Number of colours&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  uiOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;col&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  textOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;palette&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>服务器函数很短，但包含了一些重要的想法：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  col_names <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;col&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">seq_len</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>col <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    map<span class=\"punctuation\">(</span>col_names<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> textInput<span class=\"punctuation\">(</span>.x<span class=\"punctuation\">,</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>palette <span class=\"operator\">&lt;-</span> renderText<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    map_chr<span class=\"punctuation\">(</span>col_names<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> input<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">%||%</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>我使用了一个响应式对象 <code>col_names()</code> 来存储即将生成的每个颜色输入的名称。</p>\n</li>\n<li><p>然后，我使用 <code>map()</code> 创建一个 <code>textInput()</code> 列表，每个列表项对应 <code>col_names()</code> 中的一个名称。<code>renderUI()</code> 随后将这个 HTML 组件列表添加到用户界面。</p>\n</li>\n<li><p>我需要使用一个新技巧来访问输入值。到目前为止，我们总是使用 <code>$</code> 来访问输入的组件，例如 <code>input$col1</code>。但在这里，我们的输入名称存储在一个字符向量中，比如 <code>var &lt;- &quot;col1&quot;</code>。在这种情况下，<code>$</code> 不再适用，因此我们需要切换到 <code>[[</code>，即 <code>input[[var]]</code>。</p>\n</li>\n<li><p>我使用 <a href=\"https://purrr.tidyverse.org/reference/map.html\">map_chr()</a> 将所有值收集到一个字符向量中，并在 <code>output$palette</code> 中显示。不幸的是，在浏览器渲染新输入之前，有一个短暂的时间段，其值会是 <code>NULL</code>。这会导致 <code>map_chr()</code> 报错，我们使用方便的 <code>%||%</code> 函数来解决这个问题：当左侧为 <code>NULL</code> 时，它返回右侧的值。</p>\n</li>\n</ul>\n<p>你可以在图 <code>10.9</code> 中看到结果。</p>\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/5301c856f06d8eba2b98b4a7c4d3fedb574d7f11/76c4e/demos/action-dynamic/render-palette-onload.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/5301c856f06d8eba2b98b4a7c4d3fedb574d7f11/76c4e/demos/action-dynamic/render-palette-onload.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/6a2df96ad06c05e809774c0db7d7e3611ec9eb53/d31b7/demos/action-dynamic/render-palette-change-n.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/6a2df96ad06c05e809774c0db7d7e3611ec9eb53/d31b7/demos/action-dynamic/render-palette-change-n.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/cad6373c73a55bf6e79fc166e72dadf394b528e1/b0691/demos/action-dynamic/render-palette-set-cols.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/cad6373c73a55bf6e79fc166e72dadf394b528e1/b0691/demos/action-dynamic/render-palette-set-cols.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"3\">图10.9 应用程序加载时（左），将n设置为3后（中），然后输入一些颜色（右）。请在<a href=\"https://hadley.shinyapps.io/ms-render-palette\">https://hadley.shinyapps.io/ms-render-palette</a>查看实时效果</td></tr>\n</table>\n\n<p>如果你运行这个应用程序，你会发现一个非常恼人的行为：每当你改变颜色的数量时，所有输入的数据都会消失。我们可以使用与之前相同的技术来解决这个问题：将<code>value</code>设置为（孤立的）当前值。我还会稍微调整外观，使其看起来更漂亮一些，包括在图中显示所选颜色。示例截图如图<code>10.10</code>所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Number of colours&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      uiOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;col&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      plotOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;plot&quot;</span><span class=\"punctuation\">)</span>  </span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  col_names <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span>paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;col&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">seq_len</span><span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>n<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>col <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    map<span class=\"punctuation\">(</span>col_names<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> textInput<span class=\"punctuation\">(</span>.x<span class=\"punctuation\">,</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> isolate<span class=\"punctuation\">(</span>input<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>plot <span class=\"operator\">&lt;-</span> renderPlot<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    cols <span class=\"operator\">&lt;-</span> map_chr<span class=\"punctuation\">(</span>col_names<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> input<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">%||%</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"comment\"># convert empty inputs to transparent</span></span><br><span class=\"line\">    cols<span class=\"punctuation\">[</span>cols <span class=\"operator\">==</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> <span class=\"literal\">NA</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    barplot<span class=\"punctuation\">(</span></span><br><span class=\"line\">      <span class=\"built_in\">rep</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"built_in\">length</span><span class=\"punctuation\">(</span>cols<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      col <span class=\"operator\">=</span> cols<span class=\"punctuation\">,</span></span><br><span class=\"line\">      space <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      axes <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span> res <span class=\"operator\">=</span> <span class=\"number\">96</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<tr>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/cc1d6ffde1b8ac88f72e2b897ed187f55cecedf1/89026/demos/action-dynamic/render-palette-full-rainbow.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/cc1d6ffde1b8ac88f72e2b897ed187f55cecedf1/89026/demos/action-dynamic/render-palette-full-rainbow.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n<td>\n<img src=\"https://d33wubrfki0l68.cloudfront.net/b1560598089d41fb8a7c71323c44efd7595ce615/b8927/demos/action-dynamic/render-palette-full-change-n.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b1560598089d41fb8a7c71323c44efd7595ce615/b8927/demos/action-dynamic/render-palette-full-change-n.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\">\n</td>\n</tr>\n<tr><td colspan=\"2\">图10.10 填写彩虹的颜色（左），然后将颜色数量减少到3（右）；请注意，现有颜色被保留。实时效果请访问<a href=\"https://hadley.shinyapps.io/ms-render-palette-full\">https://hadley.shinyapps.io/ms-render-palette-full</a>查看实时效果</td></tr>\n</table>\n\n<h3 id=\"10-3-3-动态过滤\"><a href=\"#10-3-3-动态过滤\" class=\"headerlink\" title=\"10.3.3 动态过滤\"></a>10.3.3 动态过滤</h3><p>为了结束本章，我将创建一个应用程序，允许你动态过滤任何数据框。每个数值变量都会得到一个范围滑块，每个因子变量都会得到一个多选控件，所以（例如）如果一个数据框有三个数值变量和两个因子，应用程序将有三个滑块和两个选择框。</p>\n<p>我将从一个为单个变量创建用户界面的函数开始。对于数值输入，它将返回一个范围滑块；对于因子输入，它将返回一个多选控件；对于其他所有类型，它将返回NULL（无）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make_ui <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">,</span> var<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"built_in\">is.numeric</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    rng <span class=\"operator\">&lt;-</span> <span class=\"built_in\">range</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">,</span> na.rm <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    sliderInput<span class=\"punctuation\">(</span>var<span class=\"punctuation\">,</span> var<span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> rng<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> rng<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> rng<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>is.factor<span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    levs <span class=\"operator\">&lt;-</span> levels<span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span></span><br><span class=\"line\">    selectInput<span class=\"punctuation\">(</span>var<span class=\"punctuation\">,</span> var<span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> levs<span class=\"punctuation\">,</span> selected <span class=\"operator\">=</span> levs<span class=\"punctuation\">,</span> multiple <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"comment\"># Not supported</span></span><br><span class=\"line\">    <span class=\"literal\">NULL</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>接着，我将编写此函数的服务器端等效项：它接收输入控件的变量和值，并返回一个逻辑向量，说明是否包含每个观测值。使用逻辑向量可以轻松组合来自多个列的结果。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter_var <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">,</span> val<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"built_in\">is.numeric</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span> <span class=\"operator\">&amp;</span> x <span class=\"operator\">&gt;=</span> val<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"punctuation\">]</span> <span class=\"operator\">&amp;</span> x <span class=\"operator\">&lt;=</span> val<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>is.factor<span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    x <span class=\"operator\">%in%</span> val</span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"comment\"># No control, so don&#x27;t filter</span></span><br><span class=\"line\">    <span class=\"literal\">TRUE</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p>然后，我可以手动使用这些函数为 <code>iris</code> 数据集生成一个简单的过滤用户界面：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      make_ui<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Sepal.Length<span class=\"punctuation\">,</span> <span class=\"string\">&quot;Sepal.Length&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      make_ui<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Sepal.Width<span class=\"punctuation\">,</span> <span class=\"string\">&quot;Sepal.Width&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      make_ui<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Species<span class=\"punctuation\">,</span> <span class=\"string\">&quot;Species&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  selected <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    filter_var<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Sepal.Length<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>Sepal.Length<span class=\"punctuation\">)</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">      filter_var<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Sepal.Width<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>Sepal.Width<span class=\"punctuation\">)</span> <span class=\"operator\">&amp;</span></span><br><span class=\"line\">      filter_var<span class=\"punctuation\">(</span>iris<span class=\"operator\">$</span>Species<span class=\"punctuation\">,</span> input<span class=\"operator\">$</span>Species<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>head<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">[</span>selected<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/c346538e80dd7b34a8142bdb05a537b44d581663/edd79/demos/action-dynamic/render-filter-1.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/c346538e80dd7b34a8142bdb05a537b44d581663/edd79/demos/action-dynamic/render-filter-1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图10.11 iris数据集的简单过滤界面\"></p>\n<p>你可能注意到了，我已经厌倦了复制粘贴，所以这个应用程序只适用于三列。通过使用一些函数式编程，我可以让它适用于所有列：</p>\n<ul>\n<li><p>在<code>ui</code>中，使用<a href=\"https://purrr.tidyverse.org/reference/map.html\">map()</a>为每个变量生成一个控件。</p>\n</li>\n<li><p>在<code>server()</code>，我使用<code>map()</code>为每个变量生成选择向量。然后，我使用<code>reduce()</code>将每个变量的逻辑向量组合成一个单一的逻辑向量，通过<code>&amp;</code>将每个向量连接在一起。</p>\n</li>\n</ul>\n<p>再次强调，如果你不完全理解这里发生了什么，请不要太过担心。主要的收获是，一旦你掌握了函数式编程，你就可以编写非常简洁的代码，从而生成复杂且动态的应用程序。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      map<span class=\"punctuation\">(</span><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> make_ui<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> .x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  selected <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    each_var <span class=\"operator\">&lt;-</span> map<span class=\"punctuation\">(</span><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>iris<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> filter_var<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> input<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    reduce<span class=\"punctuation\">(</span>each_var<span class=\"punctuation\">,</span> <span class=\"operator\">~</span> .x <span class=\"operator\">&amp;</span> .y<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>head<span class=\"punctuation\">(</span>iris<span class=\"punctuation\">[</span>selected<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/b5f7aa079010dea111f8cb50ff9ce875cef92b4a/4b175/demos/action-dynamic/render-filter-2.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/b5f7aa079010dea111f8cb50ff9ce875cef92b4a/4b175/demos/action-dynamic/render-filter-2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图10.12 使用函数式编程为iris数据集构建过滤应用程序\"></p>\n<p>从此处开始，对其进行简单泛化，使其可以与任何数据框配合使用。在此，我将使用datasets包中的数据框进行说明，但你可以很容易地想象如何将其扩展到用户上传的数据。结果如图<code>10.13</code>所示。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dfs <span class=\"operator\">&lt;-</span> keep<span class=\"punctuation\">(</span>ls<span class=\"punctuation\">(</span><span class=\"string\">&quot;package:datasets&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> is.data.frame<span class=\"punctuation\">(</span>get<span class=\"punctuation\">(</span>.x<span class=\"punctuation\">,</span> <span class=\"string\">&quot;package:datasets&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  sidebarLayout<span class=\"punctuation\">(</span></span><br><span class=\"line\">    sidebarPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;dataset&quot;</span><span class=\"punctuation\">,</span> label <span class=\"operator\">=</span> <span class=\"string\">&quot;Dataset&quot;</span><span class=\"punctuation\">,</span> choices <span class=\"operator\">=</span> dfs<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      uiOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;filter&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    mainPanel<span class=\"punctuation\">(</span></span><br><span class=\"line\">      tableOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;data&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  data <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    get<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>dataset<span class=\"punctuation\">,</span> <span class=\"string\">&quot;package:datasets&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  vars <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>filter <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span></span><br><span class=\"line\">    map<span class=\"punctuation\">(</span>vars<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> make_ui<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> .x<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  selected <span class=\"operator\">&lt;-</span> reactive<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    each_var <span class=\"operator\">&lt;-</span> map<span class=\"punctuation\">(</span>vars<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"operator\">~</span> filter_var<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> input<span class=\"punctuation\">[[</span>.x<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    reduce<span class=\"punctuation\">(</span>each_var<span class=\"punctuation\">,</span> `&amp;`<span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  output<span class=\"operator\">$</span>data <span class=\"operator\">&lt;-</span> renderTable<span class=\"punctuation\">(</span>head<span class=\"punctuation\">(</span>data<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span>selected<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://d33wubrfki0l68.cloudfront.net/539c4bcb59b7d52133c346ec6ca4a217e122e4df/9214d/demos/action-dynamic/filtering-final.png\" class=\"lazyload placeholder\" data-srcset=\"https://d33wubrfki0l68.cloudfront.net/539c4bcb59b7d52133c346ec6ca4a217e122e4df/9214d/demos/action-dynamic/filtering-final.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图10.13 根据所选数据集的字段自动生成的动态用户界面。请访问https://hadley.shinyapps.io/ms-filtering-final查看实时效果\"></p>\n<h3 id=\"10-3-4-对话框\"><a href=\"#10-3-4-对话框\" class=\"headerlink\" title=\"10.3.4 对话框\"></a>10.3.4 对话框</h3><p>在结束本章之前，我想提一下一个相关的技术：对话框。在<code>8.4.1</code>节中，你已经看到了对话框，其内容是固定的文本字符串。但由于<a href=\"https://rdrr.io/pkg/shiny/man/modalDialog.html\">modalDialog()</a>是在服务器函数中调用的，因此你可以像<a href=\"https://rdrr.io/pkg/shiny/man/renderUI.html\">renderUI()</a>一样动态地生成内容。如果你想在继续常规应用程序流程之前强制用户做出某些决定，这是一个很有用的技术。</p>\n<h3 id=\"10-3-5-练习\"><a href=\"#10-3-5-练习\" class=\"headerlink\" title=\"10.3.5 练习\"></a>10.3.5 练习</h3><ol>\n<li><p>根据本节中的初始示例，创建一个非常简单的应用程序：</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  selectInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;type&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;type&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;slider&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;numeric&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  uiOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;numeric&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  output<span class=\"operator\">$</span>numeric <span class=\"operator\">&lt;-</span> renderUI<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>type <span class=\"operator\">==</span> <span class=\"string\">&quot;slider&quot;</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      sliderInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      numericInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;n&quot;</span><span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">min</span> <span class=\"operator\">=</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span> <span class=\"built_in\">max</span> <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span>  </span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<p> 你如何使用动态可见性来实现它？如果你实现了动态可见性，当你更改控件时，如何保持值的同步？</p>\n</li>\n<li><p>解释这个应用程序是如何工作的。为什么当你第二次点击“输入密码”按钮时，密码会消失？</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ui <span class=\"operator\">&lt;-</span> fluidPage<span class=\"punctuation\">(</span></span><br><span class=\"line\">  actionButton<span class=\"punctuation\">(</span><span class=\"string\">&quot;go&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Enter password&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  textOutput<span class=\"punctuation\">(</span><span class=\"string\">&quot;text&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\">server <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>input<span class=\"punctuation\">,</span> output<span class=\"punctuation\">,</span> session<span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  observeEvent<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>go<span class=\"punctuation\">,</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    showModal<span class=\"punctuation\">(</span>modalDialog<span class=\"punctuation\">(</span></span><br><span class=\"line\">      passwordInput<span class=\"punctuation\">(</span><span class=\"string\">&quot;password&quot;</span><span class=\"punctuation\">,</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      title <span class=\"operator\">=</span> <span class=\"string\">&quot;Please enter your password&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">  output<span class=\"operator\">$</span>text <span class=\"operator\">&lt;-</span> renderText<span class=\"punctuation\">(</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"operator\">!</span>isTruthy<span class=\"punctuation\">(</span>input<span class=\"operator\">$</span>password<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"string\">&quot;No password&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span> <span class=\"keyword\">else</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"string\">&quot;Password entered&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在·10.3.1·节的应用程序中，如果你从<code>value &lt;- isolate(input$dynamic)</code>中去掉<a href=\"https://rdrr.io/pkg/shiny/man/isolate.html\">isolate()</a>会发生什么？</p>\n</li>\n<li><p>为<code>make_ui()</code>和<code>filter_var()</code>添加对日期和日期时间列的支持。</p>\n</li>\n<li><p>（高级）如果你了解S3面向对象编程（<a href=\"http://adv-r.hadley.nz/S3.html\">S3 OOP</a>）系统，请考虑如何使用通用函数替换<code>make_ui()</code>和<code>filter_var()</code>中的if块。</p>\n</li>\n</ol>\n<h2 id=\"10-4-总结\"><a href=\"#10-4-总结\" class=\"headerlink\" title=\"10.4 总结\"></a>10.4 总结</h2><p>在阅读本章之前，你只能在服务器函数运行之前静态地创建用户界面。现在你已经学会了如何根据用户操作修改用户界面并完全重新创建它。动态用户界面将极大地增加你的应用程序的复杂性，所以如果你发现自己很难调试正在发生的事情，不要感到惊讶。始终记住使用最简单的技术来解决你的问题，并回到<code>5.2</code>节中的调试建议。</p>\n<p>下一章将转向讨论书签功能，使应用程序能够与他人共享当前状态。</p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"编程","path":"api/tags/编程.json"},{"name":"Shiny入门系列","path":"api/tags/Shiny入门系列.json"}]}]}