{"total":135,"pageSize":10,"pageCount":14,"data":[{"title":"某某动物与人类基因组的相似性高达x%？——是时候改变这种丈二和尚的说法了","slug":"某某动物与人类基因组的相似性高达x-？——是时候改变这种丈二和尚的说法了","date":"2023-08-06T09:45:29.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/某某动物与人类基因组的相似性高达x-？——是时候改变这种丈二和尚的说法了.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><h2 id=\"缘由\"><a href=\"#缘由\" class=\"headerlink\" title=\"缘由\"></a>缘由</h2><p>网络上随处可见“某物种与人类的基因相似度高达x%”的说法。刚来P公司的时候F博曾问起过此事，初闻摸不着头脑，因为根本就不清楚说的是哪方面的相似性，讨论后一致认为这样的说法不合理。前几天需要制作一个宣传视频，F博又找我谈起了斑马鱼和人类基因的关系，为了严谨，我去查了发表斑马鱼基因组的原文，发现文中所用的描述根本就不是<code>相似性</code>。责任心治好了我的懒病，不如写一篇短文来澄清一下这种说法。</p>\n<h2 id=\"认识同源性和一致性\"><a href=\"#认识同源性和一致性\" class=\"headerlink\" title=\"认识同源性和一致性\"></a>认识同源性和一致性</h2><p>要掰扯清楚所谓的这个相似性，需要搞明白两个概念：<code>同源性</code>和<code>一致性</code>。二者均指的是基因之间的比较。</p>\n<p><strong>同源性</strong>：同源性是指在进化过程中源于同一祖先的分支之间的关系，包括直系同源和旁系同源。直系同源基因指的是在不同物种中来自于共同祖先的基因（就是老祖宗传下来的，给到了不同的物种），而旁系同源基因指的是在同一物种内由于基因复制而产生的同源基因（基因复制现象常有）。同源性只能谈有无，不能说高低，它是<code>质</code>而不是<code>量</code>。举个简单的例子，在做blast序列比对的时候，两条序列比对上了，且coverage比较高，我们就认为二者之间有同源性。我们通常会用一些软件对多个基因组进行同源蛋白家族聚类，说的就是这个同源性。</p>\n<p><strong>一致性</strong>：最常被翻译成相似性，blast比对的出来的<code>identity</code>描述的就是一致性，可以评判两个基因之间的序列相似性。</p>\n<h2 id=\"为何不能直接说“两个基因组的相似性”？\"><a href=\"#为何不能直接说“两个基因组的相似性”？\" class=\"headerlink\" title=\"为何不能直接说“两个基因组的相似性”？\"></a>为何不能直接说“两个基因组的相似性”？</h2><p>不论是同物种还是异种比较，实际上我们比较的是基因，而非把整个染色体拿来比（共线性分析不在此讨论）。对于两个物种而言，部分基因仅存在于物种A中，部分基因仅存在于物种B中。这两部分基因是没有办法做比较的。</p>\n<p>如要比较两个基因组的相似性，我们通常会用平均核苷酸一致性（ANI）或平均氨基酸一致性（AAI）来评估，ANI和AAI的计算方法很简单，可以去网上查。注意，这里只计算两个基因组都含有的基因。实际上不适合于物种跨度大的对象之间的比较，因为它们之间本就没有多少同源基因。</p>\n<p>实际上网传的动物与人基因组的相似性指的是<code>同源基因占所有基因数量的比例</code>。即人类基因组中有x%的基因在某某动物中存在同源基因，至于这些同源基因的ANI是多少需要另外计算。</p>\n<h1 id=\"几个例子\"><a href=\"#几个例子\" class=\"headerlink\" title=\"几个例子\"></a>几个例子</h1><h2 id=\"小鼠-vs-人\"><a href=\"#小鼠-vs-人\" class=\"headerlink\" title=\"小鼠 vs. 人\"></a>小鼠 vs. 人</h2><p><strong>文献</strong>：<a href=\"https://www.nature.com/articles/nature01262\">Initial sequencing and comparative analysis of the mouse genome</a></p>\n<p><strong>杂志</strong>：2002年12月5日，《Nature》</p>\n<ul>\n<li><p>Over 90% of the mouse and human genomes can be partitioned into corresponding regions of conserved synteny, reflecting segments in which the gene order in the most recent common ancestor has been conserved in both species.</p>\n</li>\n<li><p>超过90%的小鼠和人类基因组可以划分为保守共生的对应区域，反映了最近共同祖先的基因顺序在两个物种中都保守的片段。</p>\n</li>\n<li><p>At the nucleotide level, approximately 40% of the human genome can be aligned to the mouse genome. These sequences seem to represent most of the orthologous sequences that remain in both lineages from the common ancestor, with the rest likely to have been deleted in one or both genomes.</p>\n</li>\n<li><p>在核苷酸水平上，大约40%的人类基因组可以比对到小鼠的基因组。这些序列似乎代表了来自共同祖先的两个谱系中保留的大部分直系同源序列，其余的可能在一个或两个基因组中被删除。</p>\n</li>\n<li><p>The proportion of mouse genes with a single identifiable orthologue in the human genome seems to be approximately 80%. The proportion of mouse genes without any homologue currently detectable in the human genome (and vice versa) seems to be less than 1%.</p>\n</li>\n<li><p>大约80%的小鼠基因在人类基因组中具有单个可识别直系同源基因。目前小鼠中可检测到的在人类基因组中没有任何同源物的基因似乎不到1%。</p>\n</li>\n</ul>\n<h2 id=\"黑猩猩-vs-人\"><a href=\"#黑猩猩-vs-人\" class=\"headerlink\" title=\"黑猩猩 vs. 人\"></a>黑猩猩 vs. 人</h2><p><strong>文献</strong>：<a href=\"https://www.nature.com/articles/nature04072\">Initial sequence of the chimpanzee genome and comparison with the human genome</a></p>\n<p><strong>杂志</strong>：2005年9月1日，《Nature》</p>\n<p>Orthologous proteins in human and chimpanzee are extremely similar, with ∼29% being identical and the typical orthologue differing by only two amino acids, one per lineage.<br>人类和黑猩猩的直系同源蛋白非常相似，约29%是相同的，典型的直系同源蛋白仅相差两个氨基酸，每个谱系一个。</p>\n<h2 id=\"斑马鱼-vs-人\"><a href=\"#斑马鱼-vs-人\" class=\"headerlink\" title=\"斑马鱼 vs. 人\"></a>斑马鱼 vs. 人</h2><p><strong>文献</strong>：<a href=\"https://pubmed.ncbi.nlm.nih.gov/23594743/\">The zebrafish reference genome sequence and its relationship to the human genome</a></p>\n<p><strong>杂志</strong>：2013年4月25日，《Nature》</p>\n<p>Detailed automatic and manual annotation provides evidence of more than 26,000 protein-coding genes, the largest gene set of any vertebrate so far sequenced. Comparison to the human reference genome shows that approximately 70% of human genes have at least one obvious zebrafish orthologue.<br>在斑马鱼中注释到了超过26,000个蛋白质编码基因，这是迄今为止（2013年）测序的任何脊椎动物中最大的基因集。与人类参考基因组的比较表明，大约70%的人类基因至少有一个明显的斑马鱼直系同源物。</p>\n<h1 id=\"小结\"><a href=\"#小结\" class=\"headerlink\" title=\"小结\"></a>小结</h1><p>从上述几个例子可以看出，原文描述的都是<font color=\"#FF0000\">同源基因数量，而不是所谓的相似性</font>。所以，以后再提及基因组之间的比较，一定要擦亮眼睛，看看彼得到底是什么。</p>\n<h1 id=\"关注我\"><a href=\"#关注我\" class=\"headerlink\" title=\"关注我\"></a>关注我</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n","raw":null,"categories":[{"name":"探讨","path":"api/categories/探讨.json"}],"tags":[{"name":"同源家族","path":"api/tags/同源家族.json"},{"name":"比较基因组学","path":"api/tags/比较基因组学.json"}]},{"title":"公众号9岁了——送给粉丝的话","slug":"公众号9岁了——送给粉丝的话","date":"2023-07-02T06:54:22.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/公众号9岁了——送给粉丝的话.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_1.jpg","content":"<h1 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h1><p>从2014年6月10日发表的第一篇推文到现在，已经走过了9个年头，粉丝也过千了，1150个粉丝看起来少之又少，但对于一个由个人维护的公众号来说，足够了，人不在多，只要它能帮助到几位、几十位有需求的人就足够了。</p>\n<p>本号最初是我读博期间创建的。当时为了做实验室一项科研活动志愿者招募的宣传，需要有一个公众号，而实验室无法以组织身份申请公众号（无公章），因此我以个人身份申请后作为实验室相关活动宣传的窗口。当然，从建号开始到2021年7月，该号只用来发过数条通知，可谓长期处于休眠模式。当然也靠着实验室的宣传，本号积攒了小几百号粉丝。</p>\n<p>我自从2012年底就开始接触生物信息学，那时候学生信多靠自学（当然也少不了师兄的指点），经常需要在网络上查资料。各大博主分享的笔记、方法等对于生信菜鸟来说犹如一座灯塔。早年学生信的应该都知道“铁汉1990”的微博博客吧。那个时候我经常在网上找“大佬”解惑，如今，自己也称为了别人口中的“大佬”。</p>\n<p>逐渐成长之后，也想着去帮助更多的人。事实上，我也曾和水哥一起在武汉和南昌办过线下公益培训班，收到的反响不错，有不少人因此入门了生信，并且后续也在从事相关研究。然而，线下培训的受众毕竟是少数，后又遭遇疫情，线下培训更加困难。因此，我开始转战线上做一些原创分享，包括简书、优酷等各大平台都有投稿。但这些平台存在严格的审核机制，明明是绿色无害的内容，却总会被莫名其妙的屏蔽掉。</p>\n<p>2018年，我开始建个人网站，终于可以自由分享了。当然，网站需要被各大搜索引擎收录是一个漫长和复杂（SEO优化）的过程。换言之，如果没有被收录，网站文章在百度里是搜索不到的，自然无法被人看到。当然，网站现在已经被收录了，百度“了尘兰若的小坑”即可。</p>\n<p>2021年底，我发布声明，将微信公众号与原实验室脱钩（每个人只能申请一个公众号），开始正式发布原创文章。起初，只是在公众号中发布文章，并在自建的QQ群和微信群（群名：生信之巅）中分享，其弊端是粉丝只是小范围的人群。后来想到了通过个人网站引流，效果还不错。在此过程中，粉丝群体得到了洗牌，即初代粉丝大多取关，随之而来的是更加关注生信的粉丝的加入，至此，剩余的千余人粉丝基本上是内容导向的。</p>\n<h1 id=\"粉丝画像\"><a href=\"#粉丝画像\" class=\"headerlink\" title=\"粉丝画像\"></a>粉丝画像</h1><p>那么，是时候梳理一下粉丝画像了。</p>\n<h2 id=\"粉丝地理分布\"><a href=\"#粉丝地理分布\" class=\"headerlink\" title=\"粉丝地理分布\"></a>粉丝地理分布</h2><p>粉丝数排名前7的省市分别是：湖北、广东、北京、江苏、山东、上海、浙江。这一定程度上反映出在这些省份从事与我类似生信研究领域的同行比较多。湖北和广东是我待的比较久的城市，粉丝数也最多，不清楚是否是巧合。有意思的是京城的粉丝数竟然排第三。第四到第七可谓都是东部沿海城市。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_1.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_1.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"粉丝地理分布\"></p>\n<h2 id=\"粉丝年龄分布\"><a href=\"#粉丝年龄分布\" class=\"headerlink\" title=\"粉丝年龄分布\"></a>粉丝年龄分布</h2><p>总体来说年轻粉丝（&lt;&#x3D;35岁）比较多，尤其是18-25岁的群体，表明越来越多的年轻人正在或者已经踏入生信领域，是一股不可忽视的新生力量。不可思议的是有2.96%的大龄粉丝，生信在国内起步相对较晚，对于46-60岁这部分的粉丝群体，生信应该是一个新事物。还记得当年在南昌培训的时候，一位老教师（估计60岁左右）对着电脑在很认真的操作，并不断地提出问题，这种精神非常令人钦佩。其实，他大可不必，完全可以让学生来学习就好了。他真的是用实践做到了“活到老，学到老”。向以这位老教师为代表的大龄粉丝致敬。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_2.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_2.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"粉丝年龄分布\"></p>\n<h2 id=\"粉丝性别分布\"><a href=\"#粉丝性别分布\" class=\"headerlink\" title=\"粉丝性别分布\"></a>粉丝性别分布</h2><p>粉丝基本上处于男女平衡，男性略多（高11.21%）。表明推文内容在性别上的无偏性。当然，还存在0.72%的没有站队的粉丝。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_3.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_3.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"粉丝性别分布\"></p>\n<h2 id=\"粉丝语言分布\"><a href=\"#粉丝语言分布\" class=\"headerlink\" title=\"粉丝语言分布\"></a>粉丝语言分布</h2><p>不出意外，简体中文占比最高。还有使用繁体中文的同胞粉。我很好奇1.79%的英文粉丝是如何看推文内容的，也会用软件translate一下吗？</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_4.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_4.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"粉丝语言分布\"></p>\n<h2 id=\"终端分布\"><a href=\"#终端分布\" class=\"headerlink\" title=\"终端分布\"></a>终端分布</h2><p>顾名思义，就是粉丝用的哪种手机系统。安卓系统粉丝数最多，这应该也与安卓的市场份额大有关吧，当然用苹果的也不在少数，就是不知道微信公众平台什么时候能把咱们的鸿蒙系统也统计进来。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_5.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_5.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"终端分布\"></p>\n<h2 id=\"常读用户数变化\"><a href=\"#常读用户数变化\" class=\"headerlink\" title=\"常读用户数变化\"></a>常读用户数变化</h2><p>虽然有千余号粉丝，但常读人数却不多，这可能与我少更新有关。好在从近几个月的趋势来看，常读用户数在稳步增多，最近的涨粉速度也还可以。不过，还是那句话，对于一个个人公众号来说，能帮助到那么几个人也就够了，毕竟我不靠这个盈利。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_6.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/85ad_6.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"常读用户数变化\"></p>\n<h1 id=\"关于盈利\"><a href=\"#关于盈利\" class=\"headerlink\" title=\"关于盈利\"></a>关于盈利</h1><p>穷的时候，也不是没想着通过公众号来盈利。我没有深入研究过。据我所知，大概有几种盈利方式：</p>\n<p><strong>（1）内容付费</strong>，即推文的前部分可以免费阅读，后面的精彩部分需要付费阅读。在知识付费的时代，这是合情合理的，无可厚非。我支持这种方式，但是我没有采用。</p>\n<p><strong>（2）接入广告</strong>，也就是在内容中间插入一些广告，或者带货链接。这种方式不影响读者阅读内容，我目前采用的就是该方式。每个月可以赚到两三毛钱。</p>\n<p><strong>（3）合作卖课</strong>，也有一些人找到我要合作，即通过我来卖他们的生信培训课，提成还是挺可观的。但是我无法掌握其课程质量如何（没有时间去检查），因此，目前也是没有接类似的活。</p>\n<p><strong>（4）粉丝打赏</strong>，这是比较神奇的事情，不是钱的问题，是来自于粉丝的肯定。2021年12月女朋友赞赏了5元；2022年4月同校（HZAU）的张胜利赞赏10元；2023年6月网名“遠空”的粉丝赞赏5元。</p>\n<p><strong>总之</strong>，本号的定位就不是为了盈利，单纯的分享罢了。想挣大钱，还是要认认真真学习，踏踏实实工作。</p>\n<h1 id=\"给新手的建议\"><a href=\"#给新手的建议\" class=\"headerlink\" title=\"给新手的建议\"></a>给新手的建议</h1><p><strong>（0） 自己领域的生物学背景要扎实</strong><br>生信一定离不开生物学，所以做生信要做到博学，最起码将自己领域的生物学学到位，不然，数据摆到面前也看不懂。</p>\n<p><strong>（1）基本功要扎实</strong><br>生信躲不开学习LINUX系统、编程（Perl&#x2F;Python二选一）、R语言，不要迷恋各种云平台，真正想做前沿的东西，还是要靠自己。</p>\n<p><strong>（2）要有耐心</strong></p>\n<p>大多数软件都有官方的说明书，要扎下心去阅读，只有在自己啃不透的情况下再去问大佬，如对某些参数把握不准的时候。当然，有些软件开发者确实很懒，不写文档。</p>\n<p><strong>（3）善用网络教程</strong></p>\n<p>现在网上教程有很多，多去查一下资料，跟着教程进行练习，要认真仔细地跟着教程来，经常是一个空格或者符号的错误就会导致结果重复不出来。这种小错误往往是新手最容易犯的。</p>\n<p><strong>（4）提问的技巧</strong></p>\n<p>我常年混迹于各种生信群里，发现很多人提问题，却很少有人回答。问题的关键在于提问者没有描述好问题，即群友们看不懂你问的是什么。大家都很忙，没有时间和你交流把问题本身搞清楚。所以提问前自己要把问题描述清楚，附上自己的运行代码以及报错信息，最好是附上示例数据集。</p>\n<p><strong>（5）要有信心</strong></p>\n<p>前两天有粉丝在和我交流的过程中一直无法解决遇到的问题，进而说自己愚钝。我是不赞成的，在面对一个新领域的时候，我们都会感到束手无策。我相信都读到研究生阶段了，没有一个不聪明的。问题的关键在于不要怕出错，也不要怕在解决问题的过程中花费了多少时间，每解决一个问题都在促进我们的成长。所以，打起精神，持续钻研，终有一天再回首，哪些坎坎坷坷也会成为人生靓丽的风景。</p>\n<p><strong>（6）保持学习</strong></p>\n<p>在技术爆发的时代，一天不学习，感觉就要被时代抛弃。这一点在生信领域尤其明显。各种组学层出不穷，新技术、新手段、新方法、新算法、新软件让人眼花缭乱。虽然不断学习看起来很辛苦，但这也暗示着生物信息依然火爆，生物信息与大数据及AI的碰撞在未来的数年乃至十年将会迸发出耀眼的火花。</p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注“生信之巅”公众号和小程序。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n","raw":null,"categories":[{"name":"闲谈","path":"api/categories/闲谈.json"}],"tags":[{"name":"公众号","path":"api/tags/公众号.json"}]},{"title":"走向多标签分类：机器学习在微生物组研究中的下一步","slug":"走向多标签分类：机器学习在微生物组研究中的下一步","date":"2023-05-28T07:30:13.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/走向多标签分类：机器学习在微生物组研究中的下一步.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_1.PNG","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><code>微生物组</code>分析描述了复杂微生物群落的动态特征，从而为研究微生物图谱与人类疾病[1–3]之间的关系提供了机会。</p>\n<p><code>机器学习</code>（ML）算法揭示了不同状态下微生物组特征的独特模式，从而促进了基于微生物组的疾病检测和治疗[8–10]。作为机器学习的一项重要技术，监督分类已被广泛应用于<code>炎症性肠病（IBD）</code>[11,12]、<code>癌症</code>[13,14]、<code>糖尿病</code>[15]、<code>牙龈炎</code>[16,17]等疾病的预测。</p>\n<p>通过使用来自患者及其健康对照的分类学或功能轮廓作为训练数据来构建分类器和模型，ML分类器可据此推断新样本的状态（健康&#x2F;疾病）。此外，一些ML方法，如<font color=#FF0000>支持向量机（SVM）[20]和随机森林（RF）[21]，可以进一步衡量模型训练过程中每个特征的重要性，这可以识别对分类[2,22,23]有重要贡献的微生物生物标志物。</font></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_1.PNG\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_1.PNG\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图1 单标签分类与多标签分类的比较。 a.单标签分类要求一个样本有一个标签（状态）。 b.多标签分类可以检测到每个样本的多个状态。\"></p>\n<p>为了清楚地了解微生物和健康状态之间的相互作用，以前的研究队列总是设计得很好，其中<u>一个样本只有一个描述其健康状态的精确标签</u>，例如一个样本要么是健康，要么与一种确定的疾病相关（图1a）。然而，这种策略<u>在实际和临床应用中存在其局限性，因为一个患者可能有多个标签（多种疾病，也表示为并发症或共病；图1b）</u>。在这种情况下，常规的分类器不能很好地进行预测，这可能会受到多种疾病的协同作用和相互作用的显著干扰。更重要的是，由于预测结果中只出现单一标签（例如特定疾病），<font color=#FF0000>单标签ML模型[2,22]总是遗漏或忽略共病或并发症</font>。</p>\n<p>这项工作总结了微生物组研究的典型和经典的机器学习方法，并利用美国肠道项目数据集证明了它们在疾病识别方面的局限性。然后，我们希望利用一系列有前途的<code>多标签分类</code>[25–28]策略来进一步解决上述问题。最后，提出并讨论了将多标签分类应用于微生物识别疾病检测的一些关键技术问题。</p>\n<h2 id=\"微生物组研究中的单标签分类\"><a href=\"#微生物组研究中的单标签分类\" class=\"headerlink\" title=\"微生物组研究中的单标签分类\"></a>微生物组研究中的单标签分类</h2><p>在这里，我们回顾了常用的单标签分类方法，包括逻辑回归、支持向量机、k最近邻、随机森林、梯度增强树和神经网络（表1）。</p>\n<p><strong>表 1</strong> 广泛用于基于微生物组疾病检测的机器学习方法特征</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">ML approach</th>\n<th align=\"left\">Feature importance measurement</th>\n<th align=\"left\">Interpretability</th>\n<th align=\"left\">Package and applicable programming language</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">LR</td>\n<td align=\"left\">Y</td>\n<td align=\"left\">Excellent</td>\n<td align=\"left\">Scikit-learn (Python)[33]</td>\n</tr>\n<tr>\n<td align=\"left\">SVM</td>\n<td align=\"left\">Y</td>\n<td align=\"left\">Good</td>\n<td align=\"left\">Scikit-learn (Python), LibSVM(Python&#x2F;R&#x2F;Java)[34]</td>\n</tr>\n<tr>\n<td align=\"left\">k-NN</td>\n<td align=\"left\">N</td>\n<td align=\"left\">Weak</td>\n<td align=\"left\">Scikit-learn (Python)</td>\n</tr>\n<tr>\n<td align=\"left\">RF</td>\n<td align=\"left\">Y</td>\n<td align=\"left\">Good</td>\n<td align=\"left\">Scikit-learn (Python) randomForest (R) [35]</td>\n</tr>\n<tr>\n<td align=\"left\">GBDT</td>\n<td align=\"left\">Y</td>\n<td align=\"left\">Good</td>\n<td align=\"left\">Xgboost (Python&#x2F;R&#x2F;C++) [36,37] Lightgbm (Python&#x2F;R&#x2F;C++) [38] Catboost Python&#x2F;R&#x2F;C++) [39]</td>\n</tr>\n<tr>\n<td align=\"left\">Neural Networks</td>\n<td align=\"left\">N</td>\n<td align=\"left\">Weak</td>\n<td align=\"left\">Tensorflow (Python&#x2F;Java) [40] PyTorch (Python) [41] Keras (Python) [42]</td>\n</tr>\n</tbody></table>\n<p> <code>逻辑回归</code>（Logistic regression，LR）是一种典型的二元分类线性模型，它利用逻辑函数对二元变量建模[43]。基本上，它计算了一个特定事件发生的概率，例如，一个微生物组样本是健康的或疾病的。由于其在效率和可解释性方面的优势，它通常被用作基于微生物识别的疾病检测的基准[9,44]，尽管其性能不如其他方法。</p>\n<p> 与LR不同，<code>支持向量机</code>（SVM）捕获微生物组谱和宿主状态的<code>非线性关联</code>，以最大限度地提高健康和疾病样本之间的边际[20]，这获得了比LR更好的性能。值得注意的是，LR和SVM作为二值分类器，<strong>也可以通过为每种疾病分配一个各自的分类器扩展为多类别分类器</strong>。</p>\n<p><code>最近邻</code>（k-NN）直接用它的k个最近邻来标记一个新的样本[45]。k-NN的一个关键问题是如何通过基于几何的距离度量，如Bray-Curtis、JSD、JCCARD[47]或基于系统发育的算法，如UniFrac [48]或Meta-Storms[49]，适当地测量微生物组之间的邻域（neighborship）[46]。</p>\n<p>最近，一种基于搜索的策略采用微生物组搜索引擎（MSE）[50]，通过离群新颖性评分将不健康的微生物组与健康的微生物组分离，然后通过基于系统发育距离的k-NN识别其详细的疾病类型，在灵敏度、鲁棒性和速度方面优于传统的ML实现[51]。</p>\n<p>为了进一步提高微生物组疾病检测的性能，通过集成单个ML方法，开发了集成分类方法[52,53]。<code>随机森林</code>（RF）作为一个集成分类器，通过在训练数据中随机选择样本和特征，构建多个决策树，然后通过投票组合新样本的预测状态[2,8,9,21]。与RF不同的是，<code>梯度增强决策树</code>（GBDT）为每个微生物组样本赋权重，以阶段方式构建树状模型，然后迭代更新参数以最小化估计误差[56]。<u>RF和GBDT不仅在精度上优于单个ML方法，而且还可以评价每种微生物特征对分类的贡献[22,23]</u>。</p>\n<p>在传统的ML中，从输入数据中提取特征是准确性和敏感性的基础，例如，选择在疾病发展过程中作为签名的生物标志物物种，而这种过程总是需要人工努力[57]。<code>深度学习</code><u>自动进行特征提取，并以端到端的方式训练深度神经网络[58]，这可以缓解微生物群落的复杂性所带来的高维性</u>。神经网络（如深度神经网络（DNNs）[59]、递归神经网络（RNNs）[60]、卷积神经网络（CNNs）[61]等）已成功地从图像分析过渡到微生物组研究。在计算机视觉中，CNNs对相邻像素进行卷积运算，生成新的变量。然而，微生物之间的邻居关系在一个群落中并没有得到明确的定义。因此，<font color=#FF0000>Sharma等人[62]开发了一种基于CNNs的新方法，通过分层方法将OTUs分组到门簇中（phylum clusters）。Lo等人[63]还以负二项分布对微生物组谱建模，并解决了CNNs中的数据增强技术的过拟合问题。</font></p>\n<h2 id=\"在真实微生物组数据集上的单标签分类的局限性\"><a href=\"#在真实微生物组数据集上的单标签分类的局限性\" class=\"headerlink\" title=\"在真实微生物组数据集上的单标签分类的局限性\"></a>在真实微生物组数据集上的单标签分类的局限性</h2><p>为了衡量单标签分类器在处理具有多个标签的微生物组中的可行性，我们使用美国肠道项目[24]队列的一个子集进行了疾病检测（详见材料和方法）。从3433个健康宿主和10826例患者中收集了16S rRNA扩增子微生物组，记录了5种靶疾病，包括肠易激综合征（IBS）、自身免疫性、肺部疾病、偏头痛和甲状腺（表2）。对于每个目标疾病，微生物组样本被分为两组： i)<code>单一疾病组（SD）</code>，包含对照和仅与该目标疾病有关的样本；ii)<code>多疾病组（MD）</code>，包含对照和与该目标疾病和其他共病的样本。每组从健康样本中随机抽取对照，健康样本数等于疾病样本。我们实现了RF和GBDT的两个集成单标签分类器，分别使用每组的OTU水平谱来检测目标疾病。通过使用5倍交叉验证（详细的配置和参数见材料和方法）的AUC（受试者工作特征曲线下的面积）来评估性能。</p>\n<p><strong>表 2</strong> 目标疾病样本总览</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Target disease</th>\n<th align=\"left\">Total number of disease samples</th>\n<th align=\"left\">Number of single-disease samples</th>\n<th align=\"left\">Number of comorbidities samples</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">IBS</td>\n<td align=\"left\">2351</td>\n<td align=\"left\">1064</td>\n<td align=\"left\">1287</td>\n</tr>\n<tr>\n<td align=\"left\">Autoimmune</td>\n<td align=\"left\">2301</td>\n<td align=\"left\">487</td>\n<td align=\"left\">1814</td>\n</tr>\n<tr>\n<td align=\"left\">Lung disease</td>\n<td align=\"left\">2251</td>\n<td align=\"left\">1248</td>\n<td align=\"left\">1003</td>\n</tr>\n<tr>\n<td align=\"left\">Migraine</td>\n<td align=\"left\">2109</td>\n<td align=\"left\">938</td>\n<td align=\"left\">1171</td>\n</tr>\n<tr>\n<td align=\"left\">Thyroid</td>\n<td align=\"left\">1814</td>\n<td align=\"left\">559</td>\n<td align=\"left\">1255</td>\n</tr>\n<tr>\n<td align=\"left\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_2.PNG\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_2.PNG\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图2 通过无分布独立性试验，从SD和MD中选择自身免疫性疾病的微生物生物标志物\"></td>\n<td align=\"left\"></td>\n<td align=\"left\"></td>\n<td align=\"left\"></td>\n</tr>\n</tbody></table>\n<p>结果如表3所示，<u>在检测单个疾病组中检测目标疾病时，SD训练的分类器优于MD</u>，这主要是由于消除了共病微生物群模式的额外变化。另一方面，<u>MD训练的分类器在多疾病样本上优于SD训练</u>。然后，我们进一步解剖了SD和MD之间的微生物生物标记物和ML模型，得到了这些结果。对自身免疫样本的无分布检验显示[64,65]，从SD中选择的生物标志物与MD共享（图2；在属水平上进行了分类注释；详见材料与方法）。然而，由GBDT二值分类器构建的决策树与由MD构建的决策树有很大的不同(图3；例如，MD树中节点之间的结构和相互作用更加复杂），暗示了单一疾病与多种疾病之间的微生物相互作用的变化。因此，<font color=#FF0000>在实际情况下，ML模型的设计和构建应考虑共病对微生物群的影响。值得注意的是，虽然目标疾病检测的精度可以得到优化，但这两种单标签ML分类器都不能检测出目标疾病以外的共病或并发症。</font></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_t3.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_t3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"表3 单标签分类器对目标疾病检测的检测结果\"><br><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_3.PNG\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_3.PNG\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图3 由SD （A）构建的GBDT二值分类器的决策树比由MD （B）构建的更为复杂在每个树中，内部节点代表属级上的分类群，叶节点代表标签，分支权重代表决策的标准\"></p>\n<h2 id=\"多标签分类：为微生物组的机器学习向前迈进了一步\"><a href=\"#多标签分类：为微生物组的机器学习向前迈进了一步\" class=\"headerlink\" title=\"多标签分类：为微生物组的机器学习向前迈进了一步\"></a>多标签分类：为微生物组的机器学习向前迈进了一步</h2><p>与单标签ML分类器（图1a)不同，多标签分类允许每个样本具有多个状态（标签；图1b)。对于一个样本（患者），将多标签分类引入基于微生物组的疾病检测中，自然会可能有多种标签（共病或并发症）。本文介绍了两种多标签分类方案：<code>算法自适应</code>（algorithm adaption）和<code>问题变换</code>（problem transformation）[27]。</p>\n<p><code>算法自适应</code>通过直接修改单标签分类器来处理多标签数据。例如，ML-kNN（多标签k-最近邻）结合了k-NN和贝叶斯规则来确定一个新的样本的标签集[66]。另一个例子是一个名为C4.5的决策树算法 [67]，它使叶子代表一组标签，并修改类似熵的函数[68]，用于多标签分类。近年来，一种基于多项数据非参数预测推理模型的新的ML-DT（多标签决策树）算法，利用精确概率[69]实现了鲁棒性能。</p>\n<p><code>问题转换</code>通过二进制相关性、校准的标签排序或类链（ calibrated label ranking or class chains），将多标签问题转换为单标签问题。<code>二元相关性</code>基于一种一对一的策略，该策略将m个（m &gt; 1）标签转换为单独的m个二值分类问题，并通过二值分类器确定每个标签。虽然它提供了一个简单而有效的解决方案，<u>但二元相关性忽略了标签之间可能的相关性，从而导致错误的结果[70]</u>。为了解决该问题，<code>校准标签排序</code>通过考虑成对标签的相关性，构造m*(m-1)&#x2F;2二进制分类，将m个标签分类转换为标签排序问题[71]。因此，每个标签都由m-1个二值分类器进行投票表决。此外，还可以利用m-1二分类器的投票概率作为特征，训练新的二分类器，进一步提高性能。此外，一个标签可能依赖于其他一些标签，例如，心血管疾病的诊断和治疗与IBD [72]的标签有关。在这种情况下，将依赖标签作为二值分类器的特征的类链将是一个理想的选择[73]。</p>\n<h2 id=\"基于微生物组的疾病检测的多标签分类的关键技术问题\"><a href=\"#基于微生物组的疾病检测的多标签分类的关键技术问题\" class=\"headerlink\" title=\"基于微生物组的疾病检测的多标签分类的关键技术问题\"></a>基于微生物组的疾病检测的多标签分类的关键技术问题</h2><p><font color=#FF0000>由于其数据复杂性高、数据异质性和微生物-疾病相互作用，完善的多标签分类方法在处理微生物组数据集方面也存在不足</font>。在过去的几年中，已经研究和报道了数百种微生物组-疾病之间的相互作用，例如，<u>Disbiome数据库[74]收集了372种疾病和1622种微生物之间的10,934种经实验验证的微生物-疾病关联</u>。一个普遍的挑战是，如此多的标签可能会导致意想不到的高计算成本（图4a）。例如，为了训练一个100标签分类模型（一个样本含有100种疾病中的多种疾病），二值相关方法（binary relevance approach）需要100个二值分类器，校准标签排名（calibrated label ranking）需要多达4950个分类器。最近，<code>嵌入方法</code>，如SLEEC（Sparse Local Embeddings for Extreme Classification，稀疏局部嵌入的极端分类）算法[75]被提出以应对多标签挑战。它将标签投影到低维空间向量中，为每个标签构建一个回归，并通过压缩技术对预测的标签进行解码。为了拟合大规模的数据集，SLEEC在投影步骤之前使用无监督的k-means算法将训练数据划分为几个更小的子集。但是，由于忽略了标签信息，预分割可能会影响后续投影的质量。因此，通过使用<code>图嵌入算法</code>（graph embedding algorithm）[76]和一种<code>自适应特征聚合技术</code>，如 DEFRAG（Daptive Extreme FeatuRe AGglomeration，适应的极端特征）[77]，结合特征向量和标签信息，进一步改进了嵌入方法。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_4.PNG\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/801d_4.PNG\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"图4 多标签分类中的三个关键技术问题。 a.在训练数据中使用太多的标签会导致意想不到的高计算成本。 b.缺少的标签会降低检测的灵敏度。 c.模糊的标签会引入假阳性结果\"></p>\n<p><font color=#FF0000>标签缺失是多标签分类化中的另一个常见问题（图4b）</font>。在美国肠道项目队列中，一些多疾病样本可能因临床检查不充分而被错误地归入SD，使元数据中产生某些疾病的“阴性”或“未提供”记录。这种标签缺失也可能发生在多标签分类结果中，因为在同时检测多个状态的结果时灵敏度较低。本文介绍了<u><code>基于图</code>（ graph-based）的方法和<code>低秩</code>（ low-rank）方法两种替代方法来提高灵敏度</u>。基于图的方法估计来自标签特定图（ label-specific graph）[78]或标签向量（label vectors）[79]的综合标签。低秩方法将多标签学习定义为一个包含边信息[80]的矩阵补全问题，可以通过经验风险最小化框架（empirical risk minimization framework）[81]进行估计，以避免标签缺失。</p>\n<p><font color=#FF0000>在现实世界中，疾病元数据可能是基于宿主的个人经验或其他不可靠的结论，而没有得到临床诊断或来自医疗专业人员的确认。训练数据中这种不明确的标签（图4c）可能会引入假阳性结果</font>。部分多标签方法可以消除由模糊或错误的标签造成的错误，主要是通过<u>保持每个候选标签[82]的置信度值</u>。根据置信值的计算方法，部分多标签方法一般分为<code>两阶段</code>（two-stage）方法和<code>端到端学习</code>（end-to-end learning）方法。<code>两阶段方法</code>通过迭代标签传播（propagation）来估计每个样本的候选标签的置信度，然后使用具有高置信度[83]的可信标签来训练多标签分类器。然而，<u>由于消除歧义不足，这个简单的概念很容易出错</u>。与分离置信度估计（ separating confidence estimation）和分类器构建分为两个阶段不同，<code>端到端方法</code><u>将置信度值视为模型训练函数[82,84,85]的权值，并通过将两个阶段合并成一个统一的框架来增强标签的歧义消除</u>。</p>\n<h2 id=\"讨论\"><a href=\"#讨论\" class=\"headerlink\" title=\"讨论\"></a>讨论</h2><p><font color=#FF0000>ML分类器还没有有效地考虑到微生物之间的相互作用</font>。尽管来自单一疾病和共病的生物标志物分数相似（图1），但它们在GBDT决策树中的层次是高度多样化的（图2），可能是由微生物之间的不同相互作用指导的。近年来，微生物在各种生态系统中的共现或相关性得到了广泛的研究[86-89]，从生物学的角度调查了微生物与微生物之间的相互作用。然而，<u>如何有效地将这些生物信息整合到ML分类器中仍然是[22,90]进一步工作的一个开放问题</u>。</p>\n<p><font color=#FF0000>少有研究致力于在微生物组研究中关注ML模型的可解释性，但其对解释疾病预测结果有意义</font>。在单标签分类方法中，逻辑回归具有最好的可解释性和最低的性能，而NNs则相反。虽然RF和GBDT也输出特征的重要性，但计算过于粗糙，无法进行进一步的因果解释。先进的统计方法，如<u>单指数模型（single index model），它将建模的灵活性和（线性）系数[91,92]的可解释性相结合，可能为平衡可解释性和性能提供了一个潜在的解决方案</u>。同时，宿主在年龄、性别、饮食、生活方式等因素上的异质性[93]，以及微生物组数据的稀疏性、方差和高维（high-dimensionality）[94]也会混淆疾病的检测和解释，这在实验设计和ML分析中应进行评估和考虑。</p>\n<h2 id=\"材料与方法\"><a href=\"#材料与方法\" class=\"headerlink\" title=\"材料与方法\"></a>材料与方法</h2><h3 id=\"实验设计和数据集\"><a href=\"#实验设计和数据集\" class=\"headerlink\" title=\"实验设计和数据集\"></a>实验设计和数据集</h3><p>美国肠道项目队列包含29,344名受试者，其中包括15,799名健康对照者和13,545名患者。每个受试者的疾病状态均来自基于问卷的原始元数据，该元数据包括饮食、健康状况和卫生等信息。从Qiita [95]下载肠道微生物群的16S rRNA OTU profiles，使用GreenGenes13-8数据库[96]使用Parallel-META 3[31]获取属水平的分类注释。通过序列计数直接计算OTU和属水平上的相对丰度，然后用PICRUSt 2 [97]的16S rRNA基因拷贝数进行归一化。我们还删除了没有微生物组样本的受试者。</p>\n<p>如果受试者在元数据中被记录为“由医疗专业人员（医生、医生助理）诊断”为特定的疾病，则被视为患者；如果将所有疾病标记为“我没有这种情况”，则被视为健康。最后，我们收集了3433份健康样本和10,826例患者的数据。对于每个目标疾病，选择微生物组样本并分为两组：单一疾病组（SD）包含对照和仅与目标疾病有关的样本；多疾病组（MD）包含对照和与目标疾病和其他共病有关的样本。每组从3433个健康样本中随机抽取对照样本，样本数与疾病样本相等。</p>\n<p>对于每个目标疾病，我们进行了两个实验。首先，我们评估了ML分类器在区分疾病样本和健康对照组方面的效果。采用SD组和MD组构建分类器模型。具体来说，通过SD组训练的模型检测SD样本时采用5倍交叉验证（其中随机选择80%的样本作为模型构建的训练集，其余20%作为验证的测试集）。同时，在每5次折叠中，我们还从MD组中随机选择相同数量的样本，在相同的SD测试集中训练另一个模型进行目标疾病检测。记录SD-训练模型和MD-训练模型的AUCs进行比较。其次，我们评估了ML分类器在检测MD组中的作用，并在之前的过程中分别由SD组和MD组构建模型。</p>\n<h3 id=\"机器学习方法和生物标志物的选择\"><a href=\"#机器学习方法和生物标志物的选择\" class=\"headerlink\" title=\"机器学习方法和生物标志物的选择\"></a>机器学习方法和生物标志物的选择</h3><p>采用<code>随机森林</code>和<code>GBDT</code>两种流行的集成单标签分类方法构建单标签分类器。随机森林是由Python中的“scikit-learn”包实现的，“树数”设置为500，而其他参数作为默认配置。GBDT是由Python中的“lightgbm”包实现的，参数为“learning rate”&#x3D; 0.02，“maximum tree depth”&#x3D;6，“number of boosted<br>trees”&#x3D; 1000，“maximum tree leaves”&#x3D; 64，“subsample ratio”&#x3D;0.8和“colsample_bytree”&#x3D;0.8。生物标记物分析采用对疾病和对照样本之间的基因水平丰度进行 distribution-free test（python中的“mvtpy”包），选择p值&lt;0.01的检验统计量Top 10 taxa作为生物标记物。</p>\n<h3 id=\"代码和数据可用性\"><a href=\"#代码和数据可用性\" class=\"headerlink\" title=\"代码和数据可用性\"></a>代码和数据可用性</h3><p>本工作中的所有数据集和代码都可以在<a href=\"https://github.com/BruceQD/Microbiome-based-disease-detection\">https:&#x2F;&#x2F; github.com&#x2F;BruceQD&#x2F;Microbiome-based-disease-detection</a>上找到，所有其他相关资料均可根据要求提供。</p>\n<h1 id=\"重要参考文献\"><a href=\"#重要参考文献\" class=\"headerlink\" title=\"重要参考文献\"></a>重要参考文献</h1><ul>\n<li>[1] Knight R et al. Best practices for analysing microbiomes. Nat Rev Microbiol 2018;16(7):410–22.</li>\n<li>[2] LaPierre N et al. MetaPheno: a critical evaluation of deep learning and machine learning in metagenome-based disease prediction. Methods 2019;166:74–82.</li>\n<li>[3] Su X et al. Method development for cross-study microbiome data mining: challenges and opportunities. Computational and Structural. Biotechnol J 2020</li>\n<li>[8] Namkung J. Machine learning methods for microbiome studies. J Microbiol 2020;58(3):206–16.</li>\n<li>[9] Topçuog˘lu BD et al. A framework for effective application of machine learning to microbiome-based classification problems. Mbio 2020;11(3).</li>\n<li>[10] Cammarota G et al. Gut microbiome, big data and machine learning to promote precision medicine for cancer. Nat Rev Gastroenterol Hepatol 2020.</li>\n<li>[11] Gevers D et al. The treatment-naive microbiome in new-onset Crohn’s disease. Cell Host Microbe 2014;15(3):382–92.</li>\n<li>[12] Halfvarson J et al. Dynamics of the human gut microbiome in inflammatory bowel disease. Nat Microbiol 2017;2:17004.</li>\n<li>[13] Wirbel J et al. Meta-analysis of fecal metagenomes reveals global microbial signatures that are specific for colorectal cancer. Nat Med 2019;25(4):679.</li>\n<li>[14] Poore GD et al. Microbiome analyses of blood and tissues suggest cancer diagnostic approach. Nature 2020;579(7800):567–74.</li>\n<li>[15] Bajaj JS et al. Linkage of gut microbiome with cognition in hepatic encephalopathy. Am J Physiol Gastrointest Liver Physiol 2012;302(1): G168–75.</li>\n<li>[16] Huang S et al. Predictive modeling of gingivitis severity and susceptibility via oral microbiota. ISME J 2014;8(9):1768–80.</li>\n<li>[17] Huang S et al. Longitudinal multi-omics and microbiome meta-analysis identify an asymptomatic gingival state that links gingivitis, periodontitis, and aging. mBio 2021;12(2).</li>\n<li>[25] Liu, W., et al., The Emerging Trends of Multi-Label Learning. arXiv preprint arXiv:2011.11197; 2020.</li>\n<li>[26] Tsoumakas G, Katakis I. Multi-label classification: an overview. Int J Data Warehous Min (IJDWM) 2007;3(3):1–13.</li>\n<li>[27] Zhang M-L, Zhou Z-H. A review on multi-label learning algorithms. IEEE Trans Knowl Data Eng 2013;26(8):1819–37.</li>\n<li>[28] Gibaja E, Ventura S. Multi-label learning: a review of the state of the art and ongoing research. Wiley Interdiscip Rev: Data Min Knowledge Disc 2014;4(6):411–44.</li>\n<li>[33] Pedregosa F et al. Scikit-learn: machine learning in Python. J Mach Learn Res 2011;12:2825–30.</li>\n<li>[34] Chang C-C, Lin C-J. LIBSVM: a library for support vector machines. ACM Trans Intell Syst Technol (TIST) 2011;2(3):1–27.</li>\n<li>[35] RColorBrewer S, Liaw MA. Package ‘randomForest’. Berkeley, CA, USA: University of California, Berkeley; 2018.</li>\n<li>[36] Chen T, Guestrin C. Xgboost: A scalable tree boosting system. Proceedings of the 22nd acm sigkdd international conference on knowledge discovery and data mining, 2016.</li>\n<li>[37] Chen, T., et al., Xgboost: extreme gradient boosting. R package version 0.4-2, 2015: p. 1–4.</li>\n<li>[38] Ke G, et al. Lightgbm: A highly efficient gradient boosting decision tree. in Advances in neural information processing systems; 2017.</li>\n<li>[39] Prokhorenkova L, et al. CatBoost: unbiased boosting with categorical features. in Advances in neural information processing systems. 2018.</li>\n<li>[40] Abadi M, et al. Tensorflow: A system for large-scale machine learning. in 12th {USENIX} symposium on operating systems design and implementation ({OSDI} 16); 2016.</li>\n<li>[41] Paszke A, et al., Pytorch: An imperative style, high-performance deep learning library. arXiv preprint arXiv:1912.01703, 2019.</li>\n<li>[42] Ketkar N. Introduction to keras. In: Deep learning with Python. Springer; 2017. p. 97–111.</li>\n<li>[50] Jing G et al. Microbiome search engine 2: a Platform for taxonomic and functional search of global microbiomes on the whole-microbiome level. mSystems 2021;6(1).</li>\n<li>[51] Su X et al. Multiple-disease detection and classification across cohorts via microbiome search. Msystems 2020;5(2).</li>\n<li>[59] Deng Y et al. A hierarchical fused fuzzy deep neural network for data classification. IEEE Trans Fuzzy Syst 2016;25(4):1006–12.</li>\n<li>[60] Mou L, Ghamisi P, Zhu XX. Deep recurrent neural networks for hyperspectral image classification. IEEE Trans Geosci Remote Sens 2017;55(7):3639–55.</li>\n<li>[61] Gu J et al. Recent advances in convolutional neural networks. Pattern Recogn 2018;77:354–77.</li>\n<li>[62] Sharma D, Paterson AD, Xu W. TaxoNN: ensemble of neural networks on stratified microbiome data for disease prediction. Bioinformatics 2020.</li>\n<li>[66] Zhang M-L, Zhou Z-H. ML-KNN: A lazy learning approach to multi-label learning. Pattern Recogn 2007;40(7):2038–48.</li>\n<li>[67] Quinlan JR. C4. 5: programs for machine learning. 2014: Elsevier.</li>\n<li>[68] Clare A, King RD. Knowledge discovery in multi-label phenotype data. European conference on principles of data mining and knowledge discovery. Springer; 2001.</li>\n<li>[69] Moral-García S et al. Non-parametric predictive inference for solving multi-label classification. Appl Soft Comput 2020;88:106011.</li>\n<li>[70] Zhang M-L et al. Binary relevance for multi-label learning: an overview. Front Comp Sci 2018;12(2):191–202.</li>\n<li>[71] Dery, L., Multi-label Ranking: Mining Multi-label and Label Ranking Data. arXiv preprint arXiv:2101.00583, 2021.</li>\n<li>[72] Argollo M et al. Comorbidities in inflammatory bowel disease: a call for action. Lancet Gastroenterol Hepatol 2019;4(8):643–54.</li>\n<li>[73] Read J et al. Classifier chains for multi-label classification. Machine Learn 2011;85(3):333.</li>\n<li>[74] Janssens Y et al. Disbiome database: linking the microbiome to disease. BMC Microbiol 2018;18(1):1–6.</li>\n<li>[75] Bhatia, K., et al. Sparse Local Embeddings for Extreme Multi-label Classification. in NIPS. 2015.</li>\n<li>[76] Tagami, Annexml Y. Approximate nearest neighbor search for extreme multi\u0002label classification. Proceedings of the 23rd ACM SIGKDD international conference on knowledge discovery and data mining, 2017.</li>\n<li>[77] Jalan A, Kar P. Accelerating extreme classification via adaptive feature agglomeration. arXiv preprint arXiv:1905.11769; 2019.</li>\n<li>[78] Sun Y-Y, Zhang Y, Zhou Z-H. Multi-label learning with weak label. Proceedings of the AAAI Conference on Artificial Intelligence, 2010.</li>\n<li>[79] Wu B et al. Multi-label learning with missing labels. 22nd International Conference on Pattern Recognition. IEEE; 2014.</li>\n<li>[80] Xu M, Jin R, Zhou Z-H. Speedup matrix completion with side information: Application to multi-label learning. In: Advances in neural information processing systems. 2013.</li>\n<li>[81] Yu H-F, et al. Large-scale multi-label learning with missing labels. in International conference on machine learning; 2014. PMLR.</li>\n<li>[82] Xie M-K, Huang S-J. Partial multi-label learning. Proceedings of the AAAI Conference on Artificial Intelligence, 2018.</li>\n<li>[83] Fang J-P, Zhang M-L. Partial multi-label learning via credible label elicitation. Proceedings of the AAAI Conference on Artificial Intelligence, 2019.</li>\n<li>[90] Jackson MA et al. Gut microbiota associations with common diseases and prescription medications in a population-based cohort. Nat Commun 2018;9(1):1–8.</li>\n<li>[91] Liang H et al. Estimation and testing for partially linear single-index models. Ann Stat 2010;38(6):3811.</li>\n<li>[92] Yang Y, Tong T, Li G. SIMEX estimation for single-index model with covariate measurement error. AStA Adv Statist Anal 2019;103(1):137–61.</li>\n</ul>\n<h2 id=\"原文\"><a href=\"#原文\" class=\"headerlink\" title=\"原文\"></a>原文</h2><p>Shunyao Wu et al., Towards multi-label classification: Next step of machine learning for microbiome research. <em>Computational and Structural Biotechnology Journal</em> 19 (2021) 2742–2749. DOI: <a href=\"https://doi.org/10.1016/j.csbj.2021.04.054\">https://doi.org/10.1016/j.csbj.2021.04.054</a></p>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n","raw":null,"categories":[{"name":"机器学习","path":"api/categories/机器学习.json"}],"tags":[{"name":"ML与微生物组","path":"api/tags/ML与微生物组.json"},{"name":"ML与疾病诊断","path":"api/tags/ML与疾病诊断.json"}]},{"title":"批量下载某研究方向重要文献","slug":"批量下载某研究方向重要文献","date":"2023-04-24T14:15:30.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/批量下载某研究方向重要文献.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper.jpg","content":"<h1 id=\"安装Python及依赖包\"><a href=\"#安装Python及依赖包\" class=\"headerlink\" title=\"安装Python及依赖包\"></a>安装Python及依赖包</h1><h2 id=\"python下载安装\"><a href=\"#python下载安装\" class=\"headerlink\" title=\"python下载安装\"></a>python下载安装</h2><ul>\n<li><p>windows用户请到Python官网<a href=\"https://www.python.org/downloads/\">https://www.python.org/downloads</a>下载相应的版本，本教程在<code>version 3.10.0</code>测试可行，建议安装3.7以上版本。</p>\n</li>\n<li><p>Linux系统自带python，一般不需单独安装，除非版本太低，则需升级。</p>\n</li>\n</ul>\n<h2 id=\"依赖包安装\"><a href=\"#依赖包安装\" class=\"headerlink\" title=\"依赖包安装\"></a>依赖包安装</h2><h3 id=\"BeautifulSoup\"><a href=\"#BeautifulSoup\" class=\"headerlink\" title=\"BeautifulSoup\"></a>BeautifulSoup</h3><p>以下命令可以在Windows中的CMD&#x2F;Powershell或Linux终端中运行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install BeautifulSoup4</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"requests\"><a href=\"#requests\" class=\"headerlink\" title=\"requests\"></a>requests</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install requests</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"xlrd\"><a href=\"#xlrd\" class=\"headerlink\" title=\"xlrd\"></a>xlrd</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pip install xlrd</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"通过AI搜索关键词获取文献列表\"><a href=\"#通过AI搜索关键词获取文献列表\" class=\"headerlink\" title=\"通过AI搜索关键词获取文献列表\"></a>通过AI搜索关键词获取文献列表</h1><p>假设我们需要查找<code>代谢组学</code>和<code>微生物组</code>联合研究的文章，进入AI based文献检索网站<a href=\"https://www.citexs.com/Paperpicky\">https://www.citexs.com/Paperpicky</a>，输入关键词 “metabolomics;metabolome” 和 “microbiome”，并点击批量下载，保存为Excel格式（如下图所示）。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"AI文献检索\"></p>\n<p>下载后会得到“文献.csv”，打开文件检查各列是否与下图匹配。从左至右依次为Title、Journal、IF、DOI、PMID、Pub_Date、Url，若不匹配，请先修改，如果第二例为作者信息，那么可将该列删除。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"文献.csv内容\"></p>\n<h1 id=\"爬取文献保存至本地\"><a href=\"#爬取文献保存至本地\" class=\"headerlink\" title=\"爬取文献保存至本地\"></a>爬取文献保存至本地</h1><p>本教程脚本基于<code>大阔同学</code>脚本修改而来，添加了参数，避免用户修改源代码；增加了随机user-agent，避免下载次数过多被屏蔽。原理是基于文献DOI，利用爬虫通过SCI-HUB下载文献。因此，必需要在<code>文献.csv</code>中提供DOI。有些文章不在SCI-HUB中，或者网络环境较差，则会下载失败，失败信息写入<code>error.log</code>中。</p>\n<p>将<code>DownloadPaper.py</code>和<code>文献.csv</code>放在同一目录下，并在该目录下<code>shift+右键</code>打开Powershell窗口（俗称cmd），输入下面的命令，回车即可下载。如果电脑安装了WSL Ubuntu，也可以进入Linux终端。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python DownloadPaper.py -f 文献.csv -o Papers -c 20</span><br></pre></td></tr></table></figure>\n\n<p><strong>参数解析</strong>：</p>\n<ul>\n<li>f：指定包含文献信息的文件</li>\n<li>o：将文献下载至该参数指定的路径中</li>\n<li>c：影响因子阈值，低于该阈值的文献将不会下载</li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/downloadPaper3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"下载结果\"></p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><p><a href=\"https://mp.weixin.qq.com/s/OA8TN453sk7kV95XSiTsug\">快速获取某方向研究重要文献并批量下载\n</a></p>\n</li>\n<li><p><a href=\"https://github.com/DaKuoXueShengXin/DaKuoXueShengXin_essay_code/tree/main/2023\">Github</a></p>\n</li>\n</ul>\n<h1 id=\"代码获取\"><a href=\"#代码获取\" class=\"headerlink\" title=\"代码获取\"></a>代码获取</h1><p>关注公众号“生信之巅”，聊天窗口回复“29bf”获取下载链接。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"NCBI - 下载 - NCBI","path":"api/tags/NCBI - 下载 - NCBI.json"}]},{"title":"基于TidyMass的非靶向代谢组学分析","slug":"基于TidyMass的非靶向代谢组学分析","date":"2023-04-19T07:45:39.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/基于TidyMass的非靶向代谢组学分析.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png","content":"<h1 id=\"代谢组学常用仪器特点\"><a href=\"#代谢组学常用仪器特点\" class=\"headerlink\" title=\"代谢组学常用仪器特点\"></a>代谢组学常用仪器特点</h1><table border=\"1\">\n<tr>\n<th>仪器</th>\n<th>特点</th>\n</tr>\n<tr>\n<td>GC-MS</td>\n<td>易挥发，低极性，热稳定的小分子化合物；需衍生化</td>\n</tr>\n<tr>\n<td>LC-MS</td>\n<td>具有一定极性的有机化合物；无需衍生化</td>\n</tr>\n<tr>\n<td>NMR</td>\n<td>无偏性，无损检测；•无需繁琐前处理，便于活体、原位的动态检测</td>\n</tr>\n<tr>\n<td>CE-MS</td>\n<td>高极性化合物，如核酸，蛋白等</td>\n</tr>\n<tr>\n<td>ICP-MS</td>\n<td>无机化合物</td>\n</tr>\n</table>\n\n<h1 id=\"LC-QTOF原理\"><a href=\"#LC-QTOF原理\" class=\"headerlink\" title=\"LC-QTOF原理\"></a>LC-QTOF原理</h1><p>Q-TOF全称为四极飞行时间质谱仪（Quadrupole Time-of-Flight Mass Spectrometer）。其基本原理是将样品离子通过四极杆进行质量筛选，然后进入飞行时间质谱器（Time-of-Flight Mass Analyzer，ToF），测定其离子的飞行时间，从而得到样品中离子的质量信息。Q-TOF有正离子模式（positive ion mode, POS）和负离子模式（negative ion mode, NEG）两种电离方式，在检测代谢组时结合使用两种方式可以使代谢物覆盖率更高，检测效果也更好。</p>\n<p>Q-TOF的工作过程包含以下步骤：</p>\n<p><strong>离子化</strong>：样品通过电喷雾或者MALDI等方法被电离成为离子。</p>\n<p><strong>生成离子束</strong>：离子经过引出阱、加速器、光栅偏转镜等装置，形成一个带电的离子束。</p>\n<p><strong>四极杆质量筛选</strong>：离子束进入四极杆，通过高频交变电压（RF）和直流电压（DC）的控制，将不同质量的离子分离出来。</p>\n<p><strong>飞行时间质谱分析</strong>：通过激光或者其他方法对分散的离子束施加助推、聚焦和分析，并且测定其到达检测器所需的时间。不同质量的离子抵达检测器所需要的时间不同，从而可以得到离子的质量信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"LC-QTOF原理\"><br><font color=\"#FF0000\"><strong>FAQ</strong>：POS和NEG数据的利用。</font><br>负离子和正离子是数据采集时的时候的两种模式生成两套数据，一级分析（MS）结果中是提供 POS 和 NEG 两个检测结果列表的，但是在二级分析（MSMS）结果中，我们将鉴定正负离子模式下鉴定到的物质进行了合并，所以二级分析是针对代谢物来做的，不区分正负离子模式。</p>\n<p><font color=\"#FF0000\"><strong>FAQ</strong>: 当正负离子模式下都检测到了某种物质，如何对该物质的结果进行呈现？</font><br>会根据匹配参数进行取舍，选用匹配参数更好的模式下的数据在二级结果中进行分析。</p>\n<h1 id=\"数据分析\"><a href=\"#数据分析\" class=\"headerlink\" title=\"数据分析\"></a>数据分析</h1><h2 id=\"下机数据格式转换\"><a href=\"#下机数据格式转换\" class=\"headerlink\" title=\"下机数据格式转换\"></a>下机数据格式转换</h2><p>以下两个软件二选一，Windows下建议使用ProteoWizard，其用法可参考<a href=\"https://liaochenlanruo.fun/post/df57.html\">用metid构建代谢组数据库</a>。Linux下建议使用massconverter。</p>\n<h3 id=\"ProteoWizard\"><a href=\"#ProteoWizard\" class=\"headerlink\" title=\"ProteoWizard\"></a><a href=\"https://github.com/ProteoWizard\">ProteoWizard</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h3 id=\"massconverter\"><a href=\"#massconverter\" class=\"headerlink\" title=\"massconverter\"></a><a href=\"https://tidymass.github.io/massconverter/\">massconverter</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/massconverter&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取pwiz</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>massconverter<span class=\"punctuation\">)</span></span><br><span class=\"line\">docker_pull_pwiz<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><strong>Debug</strong>：如果报错<code>Error in docker_pull_pwiz() :   Please install docker first (https://www.docker.com/get-started)</code>，则首先确认系统是否已安装docker，如果未安装，请先安装docker；如已经安装，则是因为普通用户无运行docker的权限，将其添加到docker用户组中即可。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">root模式下运行如下shell命令，将用户lhl添加到docker组中</span></span><br><span class=\"line\">gpasswd -a lhl docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启docker生效</span></span><br><span class=\"line\">service docker restart</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置转换参数\"><a href=\"#设置转换参数\" class=\"headerlink\" title=\"设置转换参数\"></a>设置转换参数</h4><p>此处调用MSConvert进行格式转换，期间进行了过滤，主要采用了<code>Peak Picking</code>，<code>Subset</code>，和<code>Zero Samples</code>方法。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameter <span class=\"operator\">=</span></span><br><span class=\"line\">  massconverter<span class=\"operator\">::</span>create_msconvert_parameter<span class=\"punctuation\">(</span></span><br><span class=\"line\">    output_format <span class=\"operator\">=</span> <span class=\"string\">&quot;mzXML&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;mzXML&quot;, &quot;mzML&quot;, &quot;mz5&quot;, &quot;mgf&quot;, &quot;text&quot;, &quot;ms1&quot;, &quot;cms1&quot;, &quot;ms2&quot;, &quot;cms2&quot;</span></span><br><span class=\"line\">    binary_encoding_precision <span class=\"operator\">=</span> <span class=\"string\">&quot;64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    zlib <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    write_index <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    peak_picking_algorithm <span class=\"operator\">=</span> <span class=\"string\">&quot;cwt&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;vendor&quot; or &quot;cwt&quot;</span></span><br><span class=\"line\">    vendor_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 当前调用的是cwt，此参数可能无效</span></span><br><span class=\"line\">    cwt_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 如此设置即可</span></span><br><span class=\"line\">    cwt_min_snr <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum signal-to-noise ratio，设为0.1即可</span></span><br><span class=\"line\">    cwt_min_peak_spacing <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum peak spacing，设为0.1即可</span></span><br><span class=\"line\">    subset_polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;any&quot;, &quot;positive&quot; or &quot;negative&quot;，根据模式选择</span></span><br><span class=\"line\">    subset_scan_number <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"literal\">NA</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_scan_time <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">60</span><span class=\"punctuation\">,</span> <span class=\"number\">300</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_mode <span class=\"operator\">=</span> <span class=\"string\">&quot;removeExtra&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;no&quot;, &quot;removeExtra&quot;, or &quot;addMissing&quot;</span></span><br><span class=\"line\">    zero_samples_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_add_missing_flanking_zero_count <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"comment\"># 默认5即可</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"开始转换\"><a href=\"#开始转换\" class=\"headerlink\" title=\"开始转换\"></a>开始转换</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">convert_raw_data<span class=\"punctuation\">(</span>input_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/raw_data&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 output_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/mzxml&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 msconvert_parameter <span class=\"operator\">=</span> parameter<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 docker_parameters <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                 process_all <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"安装tidyMass\"><a href=\"#安装tidyMass\" class=\"headerlink\" title=\"安装tidyMass\"></a>安装<a href=\"https://tidymass.tidymass.org/\">tidyMass</a></h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mamba install gcc_linux-64 gxx_linux-64 gfortran_linux-64</span><br><span class=\"line\">mamba install bioconductor-msnbase bioconductor-rdisop r-openxlsx bioconductor-mzr bioconductor-xcms r-rvest r-tidyr r-stringi r-tidyversedyve r-hexbin</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/masstools&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/tidymass&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"原始数据处理\"><a href=\"#原始数据处理\" class=\"headerlink\" title=\"原始数据处理\"></a>原始数据处理</h2><p>调用<a href=\"https://massprocesser.tidymass.org/\">massprocesser</a>包进行原始数据处理，进行峰检测与对齐，输出peak table包括：<br>原始数据导入（read spectra from file）、峰检测（detect mass traces &amp; detect  chromatographic peaks）、校正保留时间（Correcting rentention time）、对已鉴定的色谱峰进行保留时间校正、Grouping peaks across samples、输出peak table。</p>\n<p><strong>数据目录结构</strong></p>\n<ul>\n<li>mzxml&#x2F;mzxml_ms1_data&#x2F;<ul>\n<li>POS&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n<li>NEG&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>mzxml&#x2F;mgf_ms2_data&#x2F;mgf_ms2_data&#x2F;<ul>\n<li>POS&#x2F;*.mgf</li>\n<li>NEG&#x2F;*.mgf</li>\n</ul>\n</li>\n<li>mzxml&#x2F;sample_info&#x2F;<ul>\n<li>sample_info_pos.csv</li>\n<li>sample_info_neg.csv</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"正离子模式\"><a href=\"#正离子模式\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><p><font color=#FF0000>注意：path指定的路径名不可以数字开头！</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/POS&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 路径根据实际情况定</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ppm</strong>：numeric defining the maximal tolerated m&#x2F;z deviation in consecutive scans in parts per million (ppm) for the initial regions-of-interest (ROI)  definition。<font color=#FF0000>此处的ppm来源于xcms包，但在xcms中不同的函数中，含义貌似不一样，需进一步确认。</font></li>\n<li><strong>peakwith</strong>：峰宽，取决于柱子（column）和LC系统。numeric(2) with the expected approximate peak width in chromatographic space. Given as a range (min, max) in seconds.</li>\n<li><strong>min_fraction</strong>：如果一个峰出现在至少一组样本中<code>min_fraction</code>样本以上（按比例），则将保留该峰值。</li>\n<li><strong>snthresh</strong> ：信噪比阈值。</li>\n<li><strong>prefilter</strong>：c(k, I) 在第一次分析步骤（ROI检测）中指定预筛选步骤。仅保留包含至少强度&gt;&#x3D;I的k个峰的的质量轨迹（Mass traces）。</li>\n<li><strong>fitgauss</strong> ：是否应对每个峰拟合高斯分布。主要影响峰的保留时间位置。</li>\n<li><strong>integrate</strong>：积分方法（1或2）。对于 integrate&#x3D;1，Peak limits通过在mexican hat 过滤后的数据上下降（descent）来确定；而对于 integrate&#x3D;2，则在原始数据上进行下降处理。后一种方法更准确但容易受到噪声的影响，而前一种方法更稳健但不太精确。</li>\n<li><strong>mzdiff</strong> ：representing the minimum difference in m&#x2F;z dimension required for peaks with overlapping retention times; can be negative to allow overlap. During peak post-processing, peaks defined to be overlapping are reduced to the one peak with the largest signal.</li>\n<li><strong>noise</strong>：设定第一步分析中需要的质心（centroids ）最小强度（intensity &lt; noise的质心将被省略在感兴趣区域检测之外）。</li>\n<li><strong>binSize</strong> ：将m&#x2F;z轴按照binSize划分为多个区间，再对各区间内的离子信号进行聚合。较小的binSize使得峰检测更加准确，检测到更多features，需要更多计算资源。</li>\n<li><strong>bw</strong>：带宽，通常在5-50间，这是用于峰值检测的核密度估计 （KDE） 算法中使用的参数。bw 控制估计的 KDE 曲线的平滑度，并确定峰的解析程度。较小的bw值将产生更详细的基础峰形表示，在紧密间隔或重叠的峰之间具有更好的分辨率，但也可能产生更高水平的噪声。相反，较大的bw值将导致对峰形的估计更平滑、更广义，这有助于降低噪声和杂散检测，但在某些情况下也可能导致峰分辨率降低。bw 值的选择将取决于所分析数据的具体特征以及分析的目标。通常，有必要试验一系列 bw 值，以找到给定数据集的最佳设置。</li>\n<li><strong>fill_peaks</strong>：Fill peaks NA or not。</li>\n</ul>\n<p><strong>结果</strong>：</p>\n<ul>\n<li><p>POS&#x2F;Result&#x2F;</p>\n<ul>\n<li><p>object：用于下一步分析</p>\n</li>\n<li><p>Peak_table.csv：用于下一步分析的峰表</p>\n</li>\n<li><p>Peak_table_for_cleaning.csv：删除了<code>Peak_table.csv</code>中无用的列，可直接用于后续的数据清洗</p>\n</li>\n<li><p>BPC.pdf：Base peak chromatogram，仅展示<code>group_for_figure</code>参数指定组内的样本<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"BPC.pdf\"></p>\n</li>\n<li><p>TIC.pdf：Total ion peak chromatogram，经色谱分离流出的组分不断进入质谱，质谱连续扫描采集数据，每一次扫描得到一张质谱图，将每一张质谱图中所有离子强度相加得到总离子流强度。然后以总离子强度为纵坐标，时间为横坐标绘图。<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"TIC.pdf\"></p>\n</li>\n<li><p>RT correction plot.pdf<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"RT correction plot.pdf\"></p>\n</li>\n<li><p>intermediate_data：中间文件目录，如果需要重新运行data processing，则需先删除该目录。</p>\n</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取互动图，在Rstudio中才能显示</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/intermediate_data/xdata2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot <span class=\"operator\">=</span> massprocesser<span class=\"operator\">::</span>plot_adjusted_rt<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> xdata2<span class=\"punctuation\">,</span> group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">interactive</span> <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"负离子模式\"><a href=\"#负离子模式\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">massprocesser<span class=\"operator\">::</span>process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/NEG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Explore-data\"><a href=\"#Explore-data\" class=\"headerlink\" title=\"Explore data\"></a>Explore data</h2><p>将peak table和样本信息（元数据）整合，得到<code>mass_dataset</code> class对象。获取数据的总结信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"样本信息表示例 sample_info_pos.csv\"></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"正离子模式-1\"><a href=\"#正离子模式-1\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_pos <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_pos.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  查看object_pos中的元数据</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12  Case Subject               6</span></span><br><span class=\"line\"><span class=\"comment\">#?? 为何还没整合的情况下object_pos中就存在了部分元数据列？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除object_pos中的&quot;group&quot;, &quot;class&quot;, &quot;injection.order&quot;</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_pos 中的所有列整合到object_pos 中</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看元数据信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/peak_distributation_plot_positive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span>hex <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 786005</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      4017       2713       4064       2981       2920       3846</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T73_POS  M70T53_POS M70T183_POS M70T527_POS M71T695_POS M71T183_POS</span></span><br><span class=\"line\"><span class=\"comment\">#        129          16         155          54         133         169</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> show_row_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;mz&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"峰分布图\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各variable的缺失值数量\"><br>黑色代表缺失值。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各样本的缺失值比例\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各variable的缺失值比例\"></p>\n<h3 id=\"负离子模式-1\"><a href=\"#负离子模式-1\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_neg <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_neg.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12  Case Subject               6</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_neg添加至object_neg</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/peak_distributation_plot_negtive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 748237</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      3029       2766       3298       3100       2912       3053</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T712_NEG M70T527_NEG M70T587_NEG  M70T47_NEG M71T587_NEG M71T641_NEG</span></span><br><span class=\"line\"><span class=\"comment\">#         16         137           2         146          41          19</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据清洗（Data-cleaning）\"><a href=\"#数据清洗（Data-cleaning）\" class=\"headerlink\" title=\"数据清洗（Data cleaning）\"></a>数据清洗（Data cleaning）</h2><h3 id=\"查看质量\"><a href=\"#查看质量\" class=\"headerlink\" title=\"查看质量\"></a>查看质量</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载数据</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将批次号改为字符串</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 先评估数据质量</span></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"正离子PCA\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"负离子PCA\"><br><font color=\"#FF0000\">从上两图可看出正离子模式下存在严重的批次效应，负离子模式下不存在明显的批次效应。</font></p>\n<h3 id=\"开始清洗\"><a href=\"#开始清洗\" class=\"headerlink\" title=\"开始清洗\"></a>开始清洗</h3><h4 id=\"移除噪音代谢features——缺失值过滤。\"><a href=\"#移除噪音代谢features——缺失值过滤。\" class=\"headerlink\" title=\"移除噪音代谢features——缺失值过滤。\"></a>移除噪音代谢features——缺失值过滤。</h4><p>移除超过20% QC样本中含有MVs以及至少在50%实验组或对照组样本中含有MVs的variables。</p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1  M70T73_POS 70.04074  73.31705 0.28205128 0.6000000 0.4727273</span></span><br><span class=\"line\"><span class=\"comment\">#2  M70T53_POS 70.06596  52.78542 0.00000000 0.1454545 0.0000000</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T183_POS 70.19977 182.87981 0.00000000 0.6636364 0.7454545</span></span><br><span class=\"line\"><span class=\"comment\">#4 M70T527_POS 70.36113 526.76657 0.02564103 0.1818182 0.3000000</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T695_POS 70.56911 694.84592 0.02564103 0.6454545 0.5545455</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T183_POS 70.75034 182.77790 0.05128205 0.7272727 0.7909091</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos</span><br></pre></td></tr></table></figure>\n\n<p> <strong>注</strong>：na_freq、na_freq.1和na_freq.2在此处分别代表某variables 在QC样本、对照组样本和实验组样本中缺失值MV所占的百分比。</p>\n<p> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"MVpercentQC\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1 M70T712_NEG 70.05911 711.97894 0.05128205 0.109090909 0.018181818</span></span><br><span class=\"line\"><span class=\"comment\">#2 M70T527_NEG 70.13902 526.85416 0.33333333 0.509090909 0.618181818</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T587_NEG 70.31217 587.25330 0.00000000 0.009090909 0.009090909</span></span><br><span class=\"line\"><span class=\"comment\">#4  M70T47_NEG 70.33835  46.57537 0.84615385 0.936363636 0.090909091</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T587_NEG 70.56315 587.02570 0.17948718 0.145454545 0.163636364</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T641_NEG 70.70657 641.16672 0.10256410 0.063636364 0.072727273</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"过滤离群样本（Filter-outlier-samples）\"><a href=\"#过滤离群样本（Filter-outlier-samples）\" class=\"headerlink\" title=\"过滤离群样本（Filter outlier samples）\"></a>过滤离群样本（Filter outlier samples）</h4><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除离群样本，如果有的话</span></span><br><span class=\"line\">need_id_pos <span class=\"operator\">&lt;-</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `==`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> need_id_pos<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"MVpercentALL\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"缺失值填充（Missing-value-imputation）\"><a href=\"#缺失值填充（Missing-value-imputation）\" class=\"headerlink\" title=\"缺失值填充（Missing value imputation）\"></a>缺失值填充（Missing value imputation）</h2><p>对原始数据中的缺失值进行模拟（missing value recoding）。方法包括：”knn”, “rf” (missForest), “mean”, “median”, “zero”, “minimum”, “bpca”, “svdImpute”, “ppca”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取正离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 148907</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取负离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 146409</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据标准化与整合（Data-normalization-and-integration）\"><a href=\"#数据标准化与整合（Data-normalization-and-integration）\" class=\"headerlink\" title=\"数据标准化与整合（Data normalization and integration）\"></a>数据标准化与整合（Data normalization and integration）</h2><p>数据标准化处理， 利用内标（internal standard, IS）进行归一化<font color=\"#FF0000\">待确认是否通过IS实现</font>。</p>\n<ul>\n<li><p>正离子模式</p>\n<p>标准化方法包括：”svr”, “total”, “median”, “mean”, “pqn”, “loess”；整合方法包括：”qc_mean”, “qc_median”, “subject_mean”, “subject_median”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"标准化后正离子PCA\"></p>\n<ul>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"标准化后负离子PCA\"></p>\n<p><strong>保存数据</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代谢物注释\"><a href=\"#代谢物注释\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h2><h3 id=\"加载数据\"><a href=\"#加载数据\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将MS2数据添加到mass-dataset\"><a href=\"#将MS2数据添加到mass-dataset\" class=\"headerlink\" title=\"将MS2数据添加到mass_dataset\"></a>将MS2数据添加到mass_dataset</h3><p><strong>如果没有MS2数据，此步不执行应该也可以！</strong><br><font color=\"#FF0000\">？？只有QC样的MS2数据，MS2数据是怎么来的？</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># rp or hilic，对应RPLC（反相色谱）和HILIC（亲水相互作用色谱）</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span><span class=\"comment\"># ppm</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span><span class=\"comment\"># seconds</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/POS&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1043 out of 5101 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/NEG&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1092 out of 4104 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"代谢物注释-1\"><a href=\"#代谢物注释-1\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h3><p><font color=#FF0000>需要考虑数据库是RPLC还是HILIC。</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/snyder_database_rplc0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">snyder_database_rplc0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/orbitrap_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">orbitrap_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/mona_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">mona_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>annotate_metabolites_mass_dataset 参数解析</strong>：</p>\n<ul>\n<li><strong>ms1.match.ppm</strong>：Precursor match ppm tolerance [25].</li>\n<li><strong>ms2.match.ppm</strong>：Fragment ion match ppm tolerance [30].</li>\n<li><strong>mz.ppm.thr</strong>：Accurate mass tolerance for m&#x2F;z error calculation [400].</li>\n<li><strong>ms2.match.tol</strong>：MS2 match (MS2 similarity) tolerance [0.5].</li>\n<li><strong>fraction.weight</strong>：The weight for matched fragments [0.3].</li>\n<li><strong>dp.forward.weight</strong>：Forward dot product weight [0.6].</li>\n<li><strong>dp.reverse.weight</strong>：Reverse dot product weight [0.1].</li>\n<li><strong>remove_fragment_intensity_cutoff</strong>：remove_fragment_intensity_cutoff [0].</li>\n<li><strong>rt.match.tol</strong>：RT match tolerance [30].</li>\n<li><strong>polarity</strong>：The polarity of data, “positive”or “negative”.</li>\n<li><strong>ce</strong>：Collision energy. Please confirm the CE values in your database. [all].</li>\n<li><strong>column</strong>：”hilic” (HILIC column) or “rp” (reverse phase).</li>\n<li><strong>ms1.match.weight</strong>：The weight of MS1 match for total score calculation [0.25].</li>\n<li><strong>rt.match.weight</strong>：The weight of RT match for total score calculation [0.25].</li>\n<li><strong>ms2.match.weight</strong>：The weight of MS2 match for total score calculation [0.5]</li>\n<li><strong>total.score.tol</strong>：Total score tolerance. The total score are referring to MS-DIAL [0.5]</li>\n<li><strong>candidate.num</strong>：The number of candidate [3]</li>\n</ul>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"查看注释结果\"><a href=\"#查看注释结果\" class=\"headerlink\" title=\"查看注释结果\"></a>查看注释结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>extract_annotation_table<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">variable_info_pos <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>variable_info_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Level<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Database<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"保存数据\"><a href=\"#保存数据\" class=\"headerlink\" title=\"保存数据\"></a>保存数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"统计分析\"><a href=\"#统计分析\" class=\"headerlink\" title=\"统计分析\"></a>统计分析</h2><h3 id=\"加载数据-1\"><a href=\"#加载数据-1\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"移除未被注释的features\"><a href=\"#移除未被注释的features\" class=\"headerlink\" title=\"移除未被注释的features\"></a>移除未被注释的features</h3><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> object_pos2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> object_neg2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"合并POS和NEG数据\"><a href=\"#合并POS和NEG数据\" class=\"headerlink\" title=\"合并POS和NEG数据\"></a>合并POS和NEG数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># inner merge for samples and full merge for variables</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">merge_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    x <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    y <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    sample_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;inner&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用inner较合理</span></span><br><span class=\"line\">    variable_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;full&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用full合理</span></span><br><span class=\"line\">    sample_by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># merge samples by what columns from sample_info</span></span><br><span class=\"line\">    variable_by <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;variable_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;mz&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rt&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\"># merge variables by what columns from variable_info</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<p><strong>名词解释：</strong></p>\n<ul>\n<li>**左连接 (Left join)**：将左表中的所有记录都保留下来，而右表中与左表中记录没有匹配的部分则丢弃。</li>\n<li>**右连接 (Right join)**：将右表中的所有记录都保留下来，而左表中与右表中记录没有匹配的部分则丢弃。</li>\n<li>**内连接 (Inner join)**：只有两个表中都存在的记录才保留下来，否则丢弃。</li>\n<li>**全连接 (Full join)**：将左表和右表中的所有记录都保留下来，如果某个表中的记录没有匹配到另一个表中的记录，则用NULL填充。</li>\n</ul>\n<h3 id=\"Trace-processing-information-of-object\"><a href=\"#Trace-processing-information-of-object\" class=\"headerlink\" title=\"Trace processing information of object\"></a>Trace processing information of object</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">report_parameters<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"基于level和score移除冗余注释代谢物\"><a href=\"#基于level和score移除冗余注释代谢物\" class=\"headerlink\" title=\"基于level和score移除冗余注释代谢物\"></a>基于level和score移除冗余注释代谢物</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>Compound.name<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><font color=#FF0000>为何要选最小的level？SS是什么score？</font></p>\n<h3 id=\"样本聚类\"><a href=\"#样本聚类\" class=\"headerlink\" title=\"样本聚类\"></a>样本聚类</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 排除QC样本</span></span><br><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>group <span class=\"operator\">!=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Samples_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"样本聚类热图\"></p>\n<h3 id=\"差异表达代谢物\"><a href=\"#差异表达代谢物\" class=\"headerlink\" title=\"差异表达代谢物\"></a>差异表达代谢物</h3><p><font color=#FF0000>如果有多组数据，需要适当增加相应下述代码。“mutate_fc”的逻辑是每运行一次，则在object中增加一列“fc”，当有多个实验组时，可以将先前生成的fc重命名，因此，object中可以包含多个组间比较的fc结果。</font></p>\n<ul>\n<li><p>计算变化倍数</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取对照组样本名列表</span></span><br><span class=\"line\">control_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取实验组样本名列表</span></span><br><span class=\"line\">case_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，参照以上格式在此列出，假设有实验组Case2</span></span><br><span class=\"line\">case2_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case2&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\">#可选&quot;mean&quot;, &quot;median&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case1_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case1_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较，此处计算Case2与Control</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case2_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case2_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>计算p值<br><font color=\"#FF0000\">同理，当有多个实验组时，也可以分别计算p值，并将默认的列名“p_value”和“p_value_adjust”重命名，以在object中容纳多组相互比较的p值。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;t.test&quot;, &quot;wilcox.test&quot;</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"comment\"># &quot;holm&quot;, &quot;hochberg&quot;, &quot;hommel&quot;, &quot;bonferroni&quot;, &quot;BH&quot;, &quot;BY&quot;, &quot;fdr&quot;, &quot;none&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case1_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case1_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"comment\">#! 假设存在Case2组</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case2_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case2_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制火山图</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span></span><br><span class=\"line\">      object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">      fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t  fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  </span><br><span class=\"line\">  p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">  dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"火山图\"></p>\n<p><font color=\"#FF0000\">假设存在Case2，绘制火山图。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano2.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\"> fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"> p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">           point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">)</span> <span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"></span><br><span class=\"line\">p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"保存结果\"><a href=\"#保存结果\" class=\"headerlink\" title=\"保存结果\"></a>保存结果</h3><ul>\n<li><p>保存差异表达代谢物结果。如果有多个实验组，则将下述代码中的“fc”和“p_value_adjust”更改为重命名后的名称，并分别保存到不同的文件中。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">differential_metabolites <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>fc <span class=\"operator\">&gt;</span> <span class=\"number\">2</span> <span class=\"operator\">|</span> fc <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">readr<span class=\"operator\">::</span>write_csv<span class=\"punctuation\">(</span>differential_metabolites<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/differential_metabolites.csv&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>保存结果对象</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_final <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_final<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"绘制热图\"><a href=\"#绘制热图\" class=\"headerlink\" title=\"绘制热图\"></a>绘制热图</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">,</span> case_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> differential_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/diff_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  row_labels <span class=\"operator\">=</span> extract_variable_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>Compound.name<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  border <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>  <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"显著差异代谢物热图\"></p>\n<h2 id=\"代谢通路富集\"><a href=\"#代谢通路富集\" class=\"headerlink\" title=\"代谢通路富集\"></a>代谢通路富集</h2><h3 id=\"导入数据\"><a href=\"#导入数据\" class=\"headerlink\" title=\"导入数据\"></a>导入数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"富集\"><a href=\"#富集\" class=\"headerlink\" title=\"富集\"></a>富集</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">diff_metabolites <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  extract_variable_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>diff_metabolites<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"加载KEGG-human-pathway数据库\"><a href=\"#加载KEGG-human-pathway数据库\" class=\"headerlink\" title=\"加载KEGG human pathway数据库\"></a>加载KEGG human pathway数据库</h3><p><font color=#FF0000>可选数据库：kegg_hsa_pathway，keggMS1database，query_id_kegg，hmdb_pathway，hmdbMS1Database，query_id_hmdb。</font></p>\n<p><strong>？？这些数据库的区别是什么？</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data<span class=\"punctuation\">(</span><span class=\"string\">&quot;kegg_hsa_pathway&quot;</span><span class=\"punctuation\">,</span> package <span class=\"operator\">=</span> <span class=\"string\">&quot;metpath&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">kegg_hsa_pathway</span><br><span class=\"line\"></span><br><span class=\"line\">get_pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除疾病相关通路!根据课题选择是否移除？</span></span><br><span class=\"line\">pathway_class <span class=\"operator\">=</span> metpath<span class=\"operator\">::</span>pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>pathway_class<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">remain_idx <span class=\"operator\">=</span> pathway_class <span class=\"operator\">%&gt;%</span> unlist<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> stringr<span class=\"operator\">::</span>str_detect<span class=\"punctuation\">(</span><span class=\"string\">&quot;Disease&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `!`<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pathway_database <span class=\"operator\">=</span> kegg_hsa_pathway<span class=\"punctuation\">[</span>remain_idx<span class=\"punctuation\">]</span></span><br><span class=\"line\">pathway_database</span><br><span class=\"line\"></span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  diff_metabolites<span class=\"operator\">$</span>KEGG.ID </span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  kegg_id<span class=\"punctuation\">[</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>kegg_id<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">result <span class=\"operator\">&lt;-</span> enrich_kegg<span class=\"punctuation\">(</span></span><br><span class=\"line\">    query_id <span class=\"operator\">=</span> kegg_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    query_type <span class=\"operator\">=</span> <span class=\"string\">&quot;compound&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    id_type <span class=\"operator\">=</span> <span class=\"string\">&quot;KEGG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pathway_database <span class=\"operator\">=</span> pathway_database<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    threads <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">result</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>result<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/result&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"绘制结果\"><a href=\"#绘制结果\" class=\"headerlink\" title=\"绘制结果\"></a>绘制结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  bar plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/barplot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_bar_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> x_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># scatter plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/scatter_plot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_scatter_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> y_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> y_axis_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\">tiff<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/network.tiff&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_network<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> point_size <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> only_significant_pathway <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集bar plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集scatter plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集network\"></p>\n<h2 id=\"Correlation-network-analysis\"><a href=\"#Correlation-network-analysis\" class=\"headerlink\" title=\"Correlation network analysis\"></a>Correlation network analysis</h2><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> diff_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidygraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">graph_data <span class=\"operator\">&lt;-</span> convert_mass_dataset2graph<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    margin <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_adjust_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pos_cor_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    neg_cor_cutoff <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">0.7</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  mutate<span class=\"punctuation\">(</span>Degree <span class=\"operator\">=</span> centrality_degree<span class=\"punctuation\">(</span>mode <span class=\"operator\">=</span> <span class=\"string\">&#x27;all&#x27;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>extrafont<span class=\"punctuation\">)</span></span><br><span class=\"line\">loadfonts<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>showtext<span class=\"punctuation\">)</span></span><br><span class=\"line\">showtext_auto<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">ggraph<span class=\"punctuation\">(</span>graph <span class=\"operator\">=</span> graph_data<span class=\"punctuation\">,</span> layout <span class=\"operator\">=</span> <span class=\"string\">&quot;kk&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_edge_fan<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>color <span class=\"operator\">=</span> correlation<span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"comment\">#width = -log((p_adjust+0.1), 10)),</span></span><br><span class=\"line\">                show.legend <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_node_point<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> Degree<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  shadowtext<span class=\"operator\">::</span>geom_shadowtext<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>x <span class=\"operator\">=</span> x<span class=\"punctuation\">,</span> y <span class=\"operator\">=</span> y<span class=\"punctuation\">,</span></span><br><span class=\"line\">                                  label <span class=\"operator\">=</span> Compound.name<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              bg.colour <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              colour <span class=\"operator\">=</span> <span class=\"string\">&quot;black&quot;</span><span class=\"punctuation\">)</span><span class=\"operator\">+</span></span><br><span class=\"line\">  theme_graph<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  scale_edge_color_gradient2<span class=\"punctuation\">(</span>low <span class=\"operator\">=</span> <span class=\"string\">&quot;darkblue&quot;</span><span class=\"punctuation\">,</span> mid <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span> high <span class=\"operator\">=</span> <span class=\"string\">&quot;red&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ggsave<span class=\"punctuation\">(</span>plot<span class=\"punctuation\">,</span> filename <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/cor_network.pdf&quot;</span><span class=\"punctuation\">,</span> width <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span> height <span class=\"operator\">=</span> <span class=\"number\">7</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"代谢物Correlation network\"></p>\n<h1 id=\"术语\"><a href=\"#术语\" class=\"headerlink\" title=\"术语\"></a>术语</h1><ul>\n<li><strong>HILIC</strong>（亲水相互作用色谱）&amp; <strong>RPLC</strong>（反相色谱）：RPLC 色谱柱主要使用非极性固定相（C18、C8 等），而 HILIC 色谱柱则使用极性固定相（二氧化硅、酰胺等）。两种技术采用的流动相通常由乙腈和水组成，这使得两种液相色谱模式之间可以实现轻松切换。HILIC 和 RPLC 流动相的主要区别在于溶剂洗脱强度。对于 RPLC，乙腈是强洗脱溶剂。但对于HILIC，水是强洗脱溶剂。对于 RPLC，得到的色谱图通常是极性分析物到非极性分析物，而 HILIC 则相反。这种相反的洗脱顺序使 HILIC 成为更常用的 RPLC 的一个很好的补充技术。对于极性分析物和离子化分析物尤其如此，它们在 HILIC 模式下的保留时间更长。</li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://www.bioengx.com/%E8%B4%A8%E8%B0%B1%E5%88%86%E6%9E%90%E6%9C%AF%E8%AF%AD%E6%9C%80%E5%85%A8%E8%A7%A3%E8%AF%BB/\">质谱分析术语最全解读</a></li>\n<li><a href=\"https://www.tidymass.org/start/whole_workflow/\">Whole workflow using tidymass</a></li>\n<li><a href=\"https://www.agilent.com/cs/library/applications/application-note-hilic%20versus-rplc-5994-1137zh-cn-agilent.pdf\">极性分子的保留和分离 ― 关于何时使用 HILIC 与反相液相色谱柱的详细研究</a></li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"代谢组","path":"api/tags/代谢组.json"}]},{"title":"用metid构建代谢组数据库","slug":"用metid构建代谢组数据库","date":"2023-04-17T09:15:39.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/用metid构建代谢组数据库.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_1.jpg","content":"<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><p>metid包能够用于in-house代谢物库构建，并可利用MS2 spectra进行代谢物鉴定。metid自带数据库，来自于公共数据库的整合。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/metid&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_1.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_1.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"数据库构建和使用\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"数据库构建和使用\"></p>\n<h1 id=\"建库\"><a href=\"#建库\" class=\"headerlink\" title=\"建库\"></a>建库</h1><h2 id=\"构建内部库\"><a href=\"#构建内部库\" class=\"headerlink\" title=\"构建内部库\"></a>构建内部库</h2><h3 id=\"质谱数据准备\"><a href=\"#质谱数据准备\" class=\"headerlink\" title=\"质谱数据准备\"></a>质谱数据准备</h3><p>将标准品原始质谱数据用<a href=\"http://www.proteowizard.org/download.html\">ProteoWizard</a>转换为mzXM格式.</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"格式转换\"></p>\n<h3 id=\"标准品信息表\"><a href=\"#标准品信息表\" class=\"headerlink\" title=\"标准品信息表\"></a>标准品信息表</h3><p>将标准品信息整理至csv格式表格中，参考如下。<br>共11列：“Lab.ID”, “Compound.name”, “mz”, “RT”, “CAS.ID”, “HMDB.ID”, “KEGG.ID”, “Formula”, “mz.pos”, “mz.neg”, “Submitter”。也可以添加更多的信息，如“Family”, “Sub.pathway” 和“Note”。</p>\n<p>Lab.ID: 不可重复</p>\n<p>mz: 化合物准确的mass</p>\n<p>RT: 保留时间，以秒为单位</p>\n<p>mz.pos: 正离子模式下化合物的mz，如M+H。可设为NA</p>\n<p>mz.neg: 负离子模式下化合物的mz，如M-H。可设为NA</p>\n<p>Submitter: 个人或组织名称，可设为NA</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"info.csv\"></p>\n<p>新建目录<code>database_construction</code>，将正离子数据放在<code>database_construction/POS</code>中，将负离子数据放在<code>database_construction/NEG</code>中，标准品信息表<code>metabolite.info_RPLC.csv</code>放在<code>database_construction</code>中。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_4.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/df57_4.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"数据集\"></p>\n<p><strong>注意</strong>：每个文件名必须包含碰撞能（collision energy），如<code>test_NCE25.mzXML</code>。</p>\n<h3 id=\"建库-1\"><a href=\"#建库-1\" class=\"headerlink\" title=\"建库\"></a>建库</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>metid<span class=\"punctuation\">)</span></span><br><span class=\"line\">datapath<span class=\"operator\">&lt;-</span>file.path<span class=\"punctuation\">(</span><span class=\"string\">&quot;./database_construction&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">mydb <span class=\"operator\">&lt;-</span> construct_database<span class=\"punctuation\">(</span></span><br><span class=\"line\">    path <span class=\"operator\">=</span> datapath<span class=\"punctuation\">,</span></span><br><span class=\"line\">\tversion <span class=\"operator\">=</span> <span class=\"string\">&quot;0.0.1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\tmetabolite.info.name <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite.info_RPLC.csv&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\tsource <span class=\"operator\">=</span> <span class=\"string\">&quot;my lab&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\tlink <span class=\"operator\">=</span> <span class=\"string\">&quot;http://xxx.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\tcreater <span class=\"operator\">=</span> <span class=\"string\">&quot;someone&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\temail <span class=\"operator\">=</span> <span class=\"string\">&quot;x@126.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\trt <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> <span class=\"comment\"># Do the metabolites have RT information or not?</span></span><br><span class=\"line\">\tmz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> <span class=\"comment\"># m/z tolerance for the match between metabolites and precursor m/z of MS2 spectra.</span></span><br><span class=\"line\">\trt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> <span class=\"comment\"># RT tolerance for the match between metabolites and precursor m/z of MS2 spectra.</span></span><br><span class=\"line\">\tthreads <span class=\"operator\">=</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据库</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>mydb<span class=\"punctuation\">,</span> file<span class=\"operator\">=</span><span class=\"string\">&quot;mydb&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>注意</strong>：保存时前后名字必须一样。</p>\n<h2 id=\"构建公共库\"><a href=\"#构建公共库\" class=\"headerlink\" title=\"构建公共库\"></a>构建公共库</h2><h3 id=\"安装massdatabase\"><a href=\"#安装massdatabase\" class=\"headerlink\" title=\"安装massdatabase\"></a>安装<a href=\"https://massdatabase.tidymass.org/index.html\">massdatabase</a></h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/massdatabase&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>可将msp格式的数据库转换为metid数据库。<font color=#FF0000>目前有bug：Error in `dplyr::select()`: ! Can’t subset columns that don’t exist. ✖ Column `Name` doesn’t exist.</font></p>\n<p>bug解决前可以下载已经构建好的公共库：<a href=\"https://tidymass.github.io/metid/articles/public_databases.html\">Database provided for metid</a>。</p>\n<h3 id=\"MassBank\"><a href=\"#MassBank\" class=\"headerlink\" title=\"MassBank\"></a><a href=\"https://github.com/MassBank/MassBank-data/releases\">MassBank</a></h3><p>下载最新的release <a href=\"https://github.com/MassBank/MassBank-data/releases/download/2022.12.1/MassBank_NIST.msp\">MassBank_NIST.msp</a>，将其放在当前目录下。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setwd<span class=\"punctuation\">(</span><span class=\"string\">&quot;C:/Users/liu/Downloads&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>metid<span class=\"punctuation\">)</span></span><br><span class=\"line\">massbank_database_2022.12.01 <span class=\"operator\">&lt;-</span> construct_mona_database<span class=\"punctuation\">(</span></span><br><span class=\"line\">  file <span class=\"operator\">=</span> <span class=\"string\">&quot;MassBank_NIST.msp&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;.&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  version <span class=\"operator\">=</span> <span class=\"string\">&quot;2022.12.01&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  source <span class=\"operator\">=</span> <span class=\"string\">&quot;MassBank&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  link <span class=\"operator\">=</span> <span class=\"string\">&quot;https://github.com/MassBank/MassBank-data/releases&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  creater <span class=\"operator\">=</span> <span class=\"string\">&quot;Hualin Liu&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  email <span class=\"operator\">=</span> <span class=\"string\">&quot;LHL371@126.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  rt <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">15</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>massbank_database_2022.12.01<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;massbank_database_2022.12.01&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MoNA\"><a href=\"#MoNA\" class=\"headerlink\" title=\"MoNA\"></a><a href=\"https://mona.fiehnlab.ucdavis.edu/downloads\">MoNA</a></h3><p>下载对应数据库，如此处下载<code>LC-MS Spectra (153,242 spectra)</code>，截至<a href=\"https://mona.fiehnlab.ucdavis.edu/spectra/statistics\">2023.04.16</a>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>metid<span class=\"punctuation\">)</span></span><br><span class=\"line\">mona_database_2023.04.16 <span class=\"operator\">&lt;-</span> construct_mona_database<span class=\"punctuation\">(</span></span><br><span class=\"line\">  file <span class=\"operator\">=</span> <span class=\"string\">&quot;MoNA-export-LC-MS_Spectra.msp&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;.&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  version <span class=\"operator\">=</span> <span class=\"string\">&quot;2023.04.16&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  source <span class=\"operator\">=</span> <span class=\"string\">&quot;MoNA&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  link <span class=\"operator\">=</span> <span class=\"string\">&quot;https://mona.fiehnlab.ucdavis.edu/&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  creater <span class=\"operator\">=</span> <span class=\"string\">&quot;Hualin Liu&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  email <span class=\"operator\">=</span> <span class=\"string\">&quot;LHL371@126.com&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  rt <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">10</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>mona_database_2023.04.16<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;mona_database_2023.04.16&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>massdatabase<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">data <span class=\"operator\">&lt;-</span> massdatabase<span class=\"operator\">::</span>read_msp_data<span class=\"punctuation\">(</span><span class=\"string\">&quot;MoNA-export-LC-MS_Spectra.msp&quot;</span><span class=\"punctuation\">,</span> source <span class=\"operator\">=</span> <span class=\"string\">&quot;mona&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massdatabase<span class=\"operator\">::</span>convert_mona2metid<span class=\"punctuation\">(</span>data <span class=\"operator\">=</span> data<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;.&quot;</span><span class=\"punctuation\">,</span> threads <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"https://tidymass.github.io/metid/articles/database_construction.html\">Construct in-house MS2 datbase using metid</a></li>\n<li><a href=\"https://tidymass.github.io/metid/articles/public_database_construction.html\">Construct public MS2 datbase using metid</a></li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"代谢组学","path":"api/tags/代谢组学.json"}]},{"title":"使用xcms3处理和分析LC-MS数据","slug":"使用xcms3处理和分析LC-MS数据","date":"2023-02-06T07:45:39.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/使用xcms3处理和分析LC-MS数据.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_1.png","content":"<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>本文档描述了xcms（version&gt;&#x3D;3）的LCMS实验的数据导入、探索、预处理和分析。示例和基本工作流程改编自Colin A.Smith的原始LC&#x2F;MS预处理和分析。</p>\n<p>新版本使用<code>XCMSnExpe</code>对象（而不是旧的xcmsSet对象）作为预处理结果的容器。然而，为了支持依赖于xcmsSet对象的包和管道，可以使用as方法（即xset&lt;-as(x, “xcmsSet”)）将XCMSnExpe转换为xcmsSet对象，其中x是XCMSnxp对象。</p>\n<h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span><span class=\"string\">&quot;BiocManager&quot;</span><span class=\"punctuation\">,</span> quietly <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">    install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;BiocManager&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">BiocManager<span class=\"operator\">::</span>install<span class=\"punctuation\">(</span><span class=\"string\">&quot;xcms&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"导入数据\"><a href=\"#导入数据\" class=\"headerlink\" title=\"导入数据\"></a>导入数据</h1><p>xcms支持（AIA&#x2F;ANDI）NetCDF、mzXML和mzML格式的LC&#x2F;MS数据。对于实际数据导入，使用Bioconductor的<a href=\"https://bioconductor.org/packages/3.15/mzR\">mzR</a>。出于演示目的，我们将分析[1]中的数据子集，其研究了敲除脂肪酸酰胺水解酶（FAAH）基因在小鼠中的代谢后果。原始数据文件（NetCDF格式）随<code>faahKO</code>数据包提供。数据集包括来自6只敲除小鼠和6只野生型小鼠脊髓的样本。每个文件包含在正离子模式下以200-600 m&#x2F;z和2500-4500秒采集的质心模式（centroid mode）数据。为了加快处理速度，我们仅分析8个文件，且限定保留时间范围为2500到3500秒。</p>\n<p>下面我们加载所有必需的包，在<code>faahKO</code>包中找到原始CDF文件，并构建描述实验设置的表型（phenodata）数据框。注意，对于实际实验，建议定义一个文件（表），其中包含原始数据文件的文件名以及每个文件的样本描述，作为附加列。然后，可以使用例如<code>read.table</code>导入该文件作为变量pd（而不是在下面的示例中在R中定义），并且可以将文件名传递给下面的<code>readMSData</code>函数，例如<code>files=paste0(MZML_PATH, &quot;/&quot;, pd$MZML_file)</code>，其中<code>MZML_PATH</code>是文件所在目录的路径，<code>&quot;mzMLfile&quot;</code>是phenodata文件中包含文件名那一列的<strong>列名</strong>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>xcms<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>faahKO<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>RColorBrewer<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>pander<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>magrittr<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>pheatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>SummarizedExperiment<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Get the full path to the CDF files</span></span><br><span class=\"line\">cdfs <span class=\"operator\">&lt;-</span> dir<span class=\"punctuation\">(</span>system.file<span class=\"punctuation\">(</span><span class=\"string\">&quot;cdf&quot;</span><span class=\"punctuation\">,</span> package <span class=\"operator\">=</span> <span class=\"string\">&quot;faahKO&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> full.names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"number\">6</span><span class=\"punctuation\">,</span> <span class=\"number\">7</span><span class=\"punctuation\">,</span> <span class=\"number\">8</span><span class=\"punctuation\">,</span> <span class=\"number\">11</span><span class=\"punctuation\">,</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"comment\">## Create a phenodata data.frame</span></span><br><span class=\"line\">pd <span class=\"operator\">&lt;-</span> data.frame<span class=\"punctuation\">(</span>sample_name <span class=\"operator\">=</span> sub<span class=\"punctuation\">(</span>basename<span class=\"punctuation\">(</span>cdfs<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> pattern <span class=\"operator\">=</span> <span class=\"string\">&quot;.CDF&quot;</span><span class=\"punctuation\">,</span> replacement <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> fixed <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> sample_group <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"built_in\">rep</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;KO&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"built_in\">rep</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;WT&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> stringsAsFactors <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>随后，我们使用<code>MSnbase</code>包中的<code>readMSData</code>方法将原始数据加载为<code>OnDiskMSnExpe</code>对象。MSnbase为质谱数据处理提供了基础结构和基础设施。此外，MSnbase可用于形心剖面模式（centroid profile-mode）MS数据（参见MSnbase包中的相应介绍）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">raw_data <span class=\"operator\">&lt;-</span> readMSData<span class=\"punctuation\">(</span>files <span class=\"operator\">=</span> cdfs<span class=\"punctuation\">,</span> pdata <span class=\"operator\">=</span> new<span class=\"punctuation\">(</span><span class=\"string\">&quot;NAnnotatedDataFrame&quot;</span><span class=\"punctuation\">,</span> pd<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mode <span class=\"operator\">=</span> <span class=\"string\">&quot;onDisk&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p>接下来，我们将数据集限制在2500到3500秒的保留时间范围内。这仅仅是为了减少该示例的处理时间。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">raw_data <span class=\"operator\">&lt;-</span> filterRt<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">,</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2500</span><span class=\"punctuation\">,</span> <span class=\"number\">3500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>生成的<code>OnDiskMSnExpe</code>对象包含关于spectrum数量、保留时间、测量的总离子电流等的一般信息，但不包含完整的原始数据（即每个测量光谱的m&#x2F;z和强度值）。因此，它的内存占用相当小，是代表大型代谢组学实验的理想对象，同时允许执行简单的质量控制、数据检查和探索以及数据取子集操作。m&#x2F;z和强度值根据需要从原始数据文件中导入，因此原始数据文件的位置在初始数据导入后不应更改。</p>\n<h1 id=\"初始数据检查\"><a href=\"#初始数据检查\" class=\"headerlink\" title=\"初始数据检查\"></a>初始数据检查</h1><p><code>OnDiskMSnExp</code>按spectrum组织MS数据，并提供<code>intensity</code>、<code>mz</code>和<code>rtime</code>方法以访问文件中的原始数据（测量的强度值、相应的m&#x2F;z和保留时间值）。此外，<code>spectra</code>方法可用于返回封装在spectrum对象中的所有数据。下面我们从对象中提取保留时间值。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>rtime<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## F1.S0001 F1.S0002 F1.S0003 F1.S0004 F1.S0005 F1.S0006 </span><br><span class=\"line\">## 2501.378 2502.943 2504.508 2506.073 2507.638 2509.203</span><br></pre></td></tr></table></figure>\n\n<p>即使实验由多个文件&#x2F;样本组成，所有数据都会作为一维矢量（one-dimensional vectors，rtime的一个数值型向量，一个向量列表for mz和intensity，每个各自都包含一个spectrum的值）返回。<code>fromFile</code>函数返回一个整型向量，提供值到原始文件的映射。下面我们使用<code>fromFile</code>索引按文件组织<code>mz</code>值。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mzs <span class=\"operator\">&lt;-</span> mz<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Split the list by file</span></span><br><span class=\"line\">mzs_by_file <span class=\"operator\">&lt;-</span> split<span class=\"punctuation\">(</span>mzs<span class=\"punctuation\">,</span> f <span class=\"operator\">=</span> fromFile<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">length</span><span class=\"punctuation\">(</span>mzs_by_file<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## [1] 8</span><br></pre></td></tr></table></figure>\n\n<p>作为数据的第一次评估，我们在实验中绘制了每个文件的基峰色谱图（base peak chromatogram, BPC）。我们使用<code>chromatogram</code>方法并将<code>aggregationFun</code>设置为<code>&quot;max&quot;</code>，以返回每个spectrum的最大强度，从而根据原始数据创建BPC。为了创建总离子色谱图（total ion chromatogram），我们可以将<code>aggregationFun</code>设置为<code>sum</code>。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Get the base peak chromatograms. This reads data from the files.</span></span><br><span class=\"line\">bpis <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">,</span> aggregationFun <span class=\"operator\">=</span> <span class=\"string\">&quot;max&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">## Define colors for the two groups</span></span><br><span class=\"line\">group_colors <span class=\"operator\">&lt;-</span> paste0<span class=\"punctuation\">(</span>brewer.pal<span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Set1&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;60&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"built_in\">names</span><span class=\"punctuation\">(</span>group_colors<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;KO&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;WT&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Plot all chromatograms.</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_1.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>bpis<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>raw_data<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"MChromatograms\"></p>\n<p><code>chromatogram</code>返回了一个<code>MCchromatograms</code>对象，该对象以二维矩阵形式组织各个<code>Chromatogram</code>对象（实际上包含chromatographic数据）：列表示样本，行（可选）表示m&#x2F;z和&#x2F;或保留时间范围。下面我们提取第一个样品的chromatogram，并获取其保留时间和强度值。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bpi_1 <span class=\"operator\">&lt;-</span> bpis<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>rtime<span class=\"punctuation\">(</span>bpi_1<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## F1.S0001 F1.S0002 F1.S0003 F1.S0004 F1.S0005 F1.S0006 </span><br><span class=\"line\">## 2501.378 2502.943 2504.508 2506.073 2507.638 2509.203</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>intensity<span class=\"punctuation\">(</span>bpi_1<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## F1.S0001 F1.S0002 F1.S0003 F1.S0004 F1.S0005 F1.S0006 </span><br><span class=\"line\">##   43888    43960    43392    42632    42200    42288 </span><br></pre></td></tr></table></figure>\n\n<p><code>chromatogram</code>法还支持从MS数据的m&#x2F;z-rt切片中提取chromatographic数据。在下一节中，我们将使用此方法为选定的峰创建提取的离子色谱图（extracted ion chromatogram, EIC）。</p>\n<p>注意，<code>chromatogram</code>从每个文件读取原始数据以计算chromatogram。另一方面，<code>bpi</code>和<code>tic</code>方法不从原始文件读取任何数据，而是使用输入文件的头定义(header definition)中提供的相应信息（可能与实际数据不同）。</p>\n<p>下面我们创建表示每个文件总离子流分布的箱线图。这些图对于发现有问题或失败的MS运行非常有用。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Get the total ion current by file</span></span><br><span class=\"line\">tc <span class=\"operator\">&lt;-</span> split<span class=\"punctuation\">(</span>tic<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> f <span class=\"operator\">=</span> fromFile<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">boxplot<span class=\"punctuation\">(</span>tc<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>raw_data<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        ylab <span class=\"operator\">=</span> <span class=\"string\">&quot;intensity&quot;</span><span class=\"punctuation\">,</span> main <span class=\"operator\">=</span> <span class=\"string\">&quot;Total ion current&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Distribution of total ion currents per file\"></p>\n<p>此外，我们可以根据样品的BPC的相似性对样品进行聚类。这也有助于在实验中发现潜在的有问题的样本，或获得实验中样本分组的初步概述。由于样本之间的保留时间不完全相同，我们使用<code>bin</code>函数将强度分组在沿保留时间轴的固定时间范围（bins）中。在本示例中，我们使用的bin大小为2秒，默认值为0.5秒。聚类是使用完全连锁分级聚类（complete linkage hierarchical clustering）对合并的BPC的成对相关性进行的。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Bin the BPC</span></span><br><span class=\"line\">bpis_bin <span class=\"operator\">&lt;-</span> MSnbase<span class=\"operator\">::</span>bin<span class=\"punctuation\">(</span>bpis<span class=\"punctuation\">,</span> binSize <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Calculate correlation on the log2 transformed base peak intensities</span></span><br><span class=\"line\">cormat <span class=\"operator\">&lt;-</span> cor<span class=\"punctuation\">(</span>log2<span class=\"punctuation\">(</span>do.call<span class=\"punctuation\">(</span>cbind<span class=\"punctuation\">,</span> lapply<span class=\"punctuation\">(</span>bpis_bin<span class=\"punctuation\">,</span> intensity<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">colnames<span class=\"punctuation\">(</span>cormat<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> rownames<span class=\"punctuation\">(</span>cormat<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> raw_data<span class=\"operator\">$</span>sample_name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Define which phenodata columns should be highlighted in the plot</span></span><br><span class=\"line\">ann <span class=\"operator\">&lt;-</span> data.frame<span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> raw_data<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">)</span></span><br><span class=\"line\">rownames<span class=\"punctuation\">(</span>ann<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> raw_data<span class=\"operator\">$</span>sample_name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Perform the cluster analysis</span></span><br><span class=\"line\">pheatmap<span class=\"punctuation\">(</span>cormat<span class=\"punctuation\">,</span> annotation <span class=\"operator\">=</span> ann<span class=\"punctuation\">,</span> annotation_color <span class=\"operator\">=</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Grouping of samples based on similarity of their base peak chromatogram\"></p>\n<p>样本以成对方式聚类，样本索引的KO和WT样本具有最相似的BPC。</p>\n<h1 id=\"色谱峰检测\"><a href=\"#色谱峰检测\" class=\"headerlink\" title=\"色谱峰检测\"></a>色谱峰检测</h1><p>接下来，我们使用<code>centWave</code>算法进行色谱峰检测[2]。然而，在运行峰值检测之前，强烈建议目视检查内参或已知化合物的提取离子色谱图，以评估和调整峰值检测设置，因为默认设置不适用于大多数LCMS实验。centWave的两个最关键的参数是<code>peakwidth</code>（色谱峰宽度的预期范围）和<code>ppm</code>（对应于一个色谱峰的centroids m&#x2F;z值的最大预期偏差；这通常比制造商规定的ppm大得多）参数。为了评估典型的色谱峰宽度，我们绘制了一个峰的EIC。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Define the rt and m/z range of the peak area</span></span><br><span class=\"line\">rtr <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2700</span><span class=\"punctuation\">,</span> <span class=\"number\">2900</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">mzr <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">334.9</span><span class=\"punctuation\">,</span> <span class=\"number\">335.1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">## extract the chromatogram</span></span><br><span class=\"line\">chr_raw <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">,</span> rt <span class=\"operator\">=</span> rtr<span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_raw<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>chr_raw<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_4.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_4.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Extracted ion chromatogram for one peak\"></p>\n<p>注意，如果在特定扫描（即特定保留时间）中，在各自的mz范围内没有测量到信号，则通过<code>chromatogram</code>法提取的Chromatogram对象包含<code>NA值</code>。反映在上图中为不连续的线。</p>\n<p>上面的峰值宽度约为50秒。<code>peakwidth</code>参数应设置为适应数据集中预期的峰值宽度。对于当前示例数据集，我们将其设置为<code>20,80</code>。</p>\n<p>对于<code>ppm</code>参数，我们提取对应于上述峰值的完整MS数据（强度、保留时间和m&#x2F;z值）。为此，我们首先按保留时间过滤原始对象，然后按m&#x2F;z过滤，最后用<code>type=“XIC”</code>绘制对象以生成下图。我们使用pipe（<code>%&gt;%</code>）命令更好地说明了相应的工作流。还应注意，在这种类型的图中，如果存在色谱峰，则默认显示色谱峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">raw_data <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">    filterRt<span class=\"punctuation\">(</span>rt <span class=\"operator\">=</span> rtr<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">    filterMz<span class=\"punctuation\">(</span>mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">    plot<span class=\"punctuation\">(</span>type <span class=\"operator\">=</span> <span class=\"string\">&quot;XIC&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_5.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_5.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Visualization of the raw MS data for one peak\"></p>\n<p><strong>图注</strong>：对于每个图：上面板：根据保留时间绘制强度值的色谱图；下面板：m&#x2F;z根据保留时间绘图。各个数据点根据强度进行着色。</p>\n<p>在目前的数据中，m&#x2F;z值实际上没有变化。通常可以看到m&#x2F;z值（下面板）散布在化合物的实际m&#x2F;z值周围。centWave算法的第一步基于连续扫描的m&#x2F;z值的差异定义所谓的感兴趣区域（regions of interest, ROI）。具体而言，如果ROI的m&#x2F;z和平均m&#x2F;z之间的差小于用户定义的ppm参数，则来自连续扫描的m&#x2F;z值被包括在ROI中。因此，ppm的合理选择可以是来自作为色谱峰一部分的相邻扫描&#x2F;光谱（scans&#x2F;spectra）的数据点的最大m&#x2F;z差。建议检查许多化合物（内标或样品中已知存在的化合物）的m&#x2F;z值范围，并根据这些确定centWave的ppm参数。</p>\n<p>注意，我们也可以对提取的离子色谱图（ion chromatogram）进行峰检测。这有助于评估不同的峰值检测设置。只需注意，提取的离子色谱图上的峰值检测不会考虑ppm参数，并且背景信号的估计与完整数据集上的峰值探测不同；因此，<code>snthresh</code>的值将具有不同的结果。下面我们使用<code>findChromPeaks</code>函数对提取的离子色谱图进行峰值检测。提交的参数对象定义将使用的算法，并允许定义此算法的设置。我们使用带有默认设置的centWave算法，<code>snthresh</code>除外。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xchr <span class=\"operator\">&lt;-</span> findChromPeaks<span class=\"punctuation\">(</span>chr_raw<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> CentWaveParam<span class=\"punctuation\">(</span>snthresh <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>我们可以使用<code>chromPeaks</code>函数访问已识别的色谱峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>chromPeaks<span class=\"punctuation\">(</span>xchr<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##            rt    rtmin    rtmax       into       intb  maxo  sn row column</span><br><span class=\"line\">## [1,] 2781.505 2761.160 2809.674  412134.25  355516.37 16856  13   1      1</span><br><span class=\"line\">## [2,] 2786.199 2764.290 2812.803 1496244.21 1391821.33 58736  20   1      2</span><br><span class=\"line\">## [3,] 2734.556 2714.211 2765.855   21579.37   18449.43   899   4   1      3</span><br><span class=\"line\">## [4,] 2797.154 2775.245 2815.933  159058.78  150289.31  6295  12   1      3</span><br><span class=\"line\">## [5,] 2784.635 2761.160 2808.109   54947.54   37923.53  2715   2   1      4</span><br><span class=\"line\">## [6,] 2859.752 2845.668 2878.532   13895.21   13874.87   905 904   1      4</span><br></pre></td></tr></table></figure>\n\n<p>与<code>chromPeaks</code>矩阵相似，还有一个数据框<code>chromPeakData</code>，允许为每个色谱峰添加任意注释。下面我们提取这个数据框，默认情况下，该数据框只包含识别峰值的MS水平。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chromPeakData<span class=\"punctuation\">(</span>xchr<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## DataFrame with 12 rows and 4 columns</span><br><span class=\"line\">##      ms_level is_filled       row    column</span><br><span class=\"line\">##     &lt;integer&gt; &lt;logical&gt; &lt;integer&gt; &lt;integer&gt;</span><br><span class=\"line\">## 1           1     FALSE         1         1</span><br><span class=\"line\">## 2           1     FALSE         1         2</span><br><span class=\"line\">## 3           1     FALSE         1         3</span><br><span class=\"line\">## 4           1     FALSE         1         3</span><br><span class=\"line\">## 5           1     FALSE         1         4</span><br><span class=\"line\">## ...       ...       ...       ...       ...</span><br><span class=\"line\">## 8           1     FALSE         1         4</span><br><span class=\"line\">## 9           1     FALSE         1         5</span><br><span class=\"line\">## 10          1     FALSE         1         6</span><br><span class=\"line\">## 11          1     FALSE         1         7</span><br><span class=\"line\">## 12          1     FALSE         1         8</span><br></pre></td></tr></table></figure>\n\n<p>接下来，我们在提取的离子色谱图中绘制已识别的色谱峰。我们使用<code>col</code>参数为各个色谱线上色。还可以为识别的峰值指定颜色，<code>peakCol</code>为前景&#x2F;边框颜色，<code>peakBg</code>为背景&#x2F;填充颜色。必须为<code>chromPeaks</code>列出的每个色谱峰提供一种颜色。下面我们定义了一种颜色，以指示样本所在的样本组，并使用峰<code>“sample”</code>列中的样本信息为每个色谱峰分配正确的颜色。更多峰值突出显示选项将在下面进一步描述。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sample_colors <span class=\"operator\">&lt;-</span> group_colors<span class=\"punctuation\">[</span>xchr<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>xchr<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">,</span></span><br><span class=\"line\">     peakBg <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>xchr<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;column&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_6.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_6.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Signal for an example peak\"></p>\n<p><strong>图注</strong>：红色和蓝色分别代表KO和野生型样本。已识别色谱峰的峰面积用样品组颜色突出显示。</p>\n<p>最后，我们对整个数据集进行色谱峰检测。请注意，我们将参数<code>prefilter</code>设置为<code>c(6, 5000)</code>，将<code>noise</code>设置为<code>5000</code>，以减少该示例的运行时间。使用此设置，我们只考虑峰值检测步骤中值大于5000的信号。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cwp <span class=\"operator\">&lt;-</span> CentWaveParam<span class=\"punctuation\">(</span>peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">20</span><span class=\"punctuation\">,</span> <span class=\"number\">80</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> noise <span class=\"operator\">=</span> <span class=\"number\">5000</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                     prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">6</span><span class=\"punctuation\">,</span> <span class=\"number\">5000</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> findChromPeaks<span class=\"punctuation\">(</span>raw_data<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> cwp<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>结果作为<code>XCMSnExp</code>对象返回，该对象通过存储LC&#x2F;GC-MS预处理结果来扩展<code>OnDiskMSnExp</code>对象。这也意味着，所有设置和过滤数据或访问（原始）数据的方法都是从<code>OnDiskMSnExp</code>对象继承的，因此可以重新使用。还请注意，通过使用参数<code>add＝TRUE</code>调用<code>findChromPeaks</code>，可以对<code>xdata</code>对象执行额外的峰值检测（例如，在MS level＞1的数据上）。</p>\n<p>色谱峰检测的结果可通过<code>chromPeaks</code>方法获得。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##           mz mzmin mzmax       rt    rtmin    rtmax      into      intb  maxo    sn sample</span><br><span class=\"line\">## CP0001 453.2 453.2 453.2 2509.203 2501.378 2527.982 1007409.0 1007380.8 38152 38151      1</span><br><span class=\"line\">## CP0002 236.1 236.1 236.1 2518.593 2501.378 2537.372  253501.0  226896.3 12957    11      1</span><br><span class=\"line\">## CP0003 594.0 594.0 594.0 2601.535 2581.191 2637.529  161042.2  149297.3  7850    13      1</span><br><span class=\"line\">## CP0004 577.0 577.0 577.0 2604.665 2581.191 2626.574  136105.2  129195.5  6215    13      1</span><br><span class=\"line\">## CP0005 369.2 369.2 369.2 2587.451 2556.151 2631.269  483852.3  483777.1  7215  7214      1</span><br><span class=\"line\">## CP0006 369.2 369.2 369.2 2568.671 2557.716 2578.061  144624.8  144602.9  7033  7032      1</span><br></pre></td></tr></table></figure>\n\n<p>返回的<code>matrix</code>提供了每个已识别色谱峰的m&#x2F;z和保留时间范围，以及整合的信号强度（“into”）和最大峰强度（“maxo”）。“sample”列包含确定峰值的对象&#x2F;实验中样本的索引。</p>\n<p>可以使用<code>chromPeakData</code>函数提取每个峰的注释。该数据框还可以用于为每个检测到的峰添加&#x2F;存储任意注释。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chromPeakData<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## DataFrame with 1707 rows and 2 columns</span><br><span class=\"line\">##         ms_level is_filled</span><br><span class=\"line\">##        &lt;integer&gt; &lt;logical&gt;</span><br><span class=\"line\">## CP0001         1     FALSE</span><br><span class=\"line\">## CP0002         1     FALSE</span><br><span class=\"line\">## CP0003         1     FALSE</span><br><span class=\"line\">## CP0004         1     FALSE</span><br><span class=\"line\">## CP0005         1     FALSE</span><br><span class=\"line\">## ...          ...       ...</span><br><span class=\"line\">## CP1703         1     FALSE</span><br><span class=\"line\">## CP1704         1     FALSE</span><br><span class=\"line\">## CP1705         1     FALSE</span><br><span class=\"line\">## CP1706         1     FALSE</span><br><span class=\"line\">## CP1707         1     FALSE</span><br></pre></td></tr></table></figure>\n\n<p>峰检测不会总是完美地工作，从而导致峰检测伪影（artifacts），例如重叠峰或人为分割峰。<code>refineChromPeaks</code>函数允许通过去除未通过特定标准的已识别峰或合并人工拆分的色谱峰来优化峰检测结果。使用参数对象<code>CleanPeaksParam</code>和<code>FilterIntensityParam</code>，可以分别删除保留时间范围或强度低于阈值的峰（有关更多详细信息和示例，请参阅各自的帮助页面）。使用<code>MergeNeighbringPeaksParam</code>可以合并色谱峰。下面我们对峰检测结果进行进一步处理，如果它们之间的信号低于较小峰最大强度的75%，合并每个文件在4秒窗口中重叠的峰值（merging peaks overlapping in a 4 second window per file）。有关设置和方法的详细说明，请参阅<code>MergeNeighborgingPeaksParam</code>帮助页面。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mpp <span class=\"operator\">&lt;-</span> MergeNeighboringPeaksParam<span class=\"punctuation\">(</span>expandRt <span class=\"operator\">=</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">xdata_pp <span class=\"operator\">&lt;-</span> refineChromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> mpp<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>如下展示了合并峰的示例。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mzr_1 <span class=\"operator\">&lt;-</span> 305.1 <span class=\"operator\">+</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">chr_1 <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>filterFile<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">chr_2 <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>filterFile<span class=\"punctuation\">(</span>xdata_pp<span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_7.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_8.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_2<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_7.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_7.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Result from the peak refinement step: 处理前的数据\" style=\"width: 300px;height: 300px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_8.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_8.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Result from the peak refinement step: 处理后的数据，峰被合并\" style=\"width: 300px;height: 300px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n<p>对于以上色谱图centWave检测到3个峰（1个峰代表整个区域，两个较小的峰，见上图中的左侧面板）。<code>MergeNeighborgingPeaksParam</code>的峰细化（refinement ）将它们减少为单个峰（上图中的右面板）。注意，这种细化不会合并相邻峰值，因为它们之间的信号低于一定比例（参见下图）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mzr_1 <span class=\"operator\">&lt;-</span> 496.2 <span class=\"operator\">+</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">0.01</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">chr_1 <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>filterFile<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">chr_2 <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>filterFile<span class=\"punctuation\">(</span>xdata_pp<span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_9.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_1<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_10.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_2<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_9.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_9.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Result from the peak refinement step: 处理前的数据\" style=\"width: 300px;height: 300px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_10.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_10.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Result from the peak refinement step: 处理后的数据，峰未合并\" style=\"width: 300px;height: 300px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n<p>还应注意，可以对提取的离子色谱图进行峰细化。这可以例如用于微调参数的设置。为了说明这一点，我们下面对提取的离子色谱图<code>chr_1</code>进行了峰细化，减少了<code>minProp</code>参数，以强制连接两个峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">res <span class=\"operator\">&lt;-</span> refineChromPeaks<span class=\"punctuation\">(</span>chr_1<span class=\"punctuation\">,</span> MergeNeighboringPeaksParam<span class=\"punctuation\">(</span>minProp <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">chromPeaks<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##         mz mzmin mzmax       rt    rtmin    rtmax     into intb    maxo  sn</span><br><span class=\"line\">## CPM1 496.2 496.2 496.2 3384.012 3294.809 3412.181 45940118   NA 1128960 177</span><br><span class=\"line\">##      sample row column</span><br><span class=\"line\">## CPM1      1   1      1</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;cxms_11.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_11.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_11.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"强制连接两个峰\"></p>\n<p>在继续之前，我们用峰细化的结果替换<code>xdata</code>对象。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> xdata_pp</span><br></pre></td></tr></table></figure>\n\n<p>下面我们使用<code>chromPeaks</code>矩阵中的数据来计算每个文件的一些摘要。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">summary_fun <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span></span><br><span class=\"line\">    <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>peak_count <span class=\"operator\">=</span> nrow<span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> rt <span class=\"operator\">=</span> quantile<span class=\"punctuation\">(</span>z<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rtmax&quot;</span><span class=\"punctuation\">]</span> <span class=\"operator\">-</span> z<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rtmin&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">T</span> <span class=\"operator\">&lt;-</span> lapply<span class=\"punctuation\">(</span>split.data.frame<span class=\"punctuation\">(</span>chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> f <span class=\"operator\">=</span> chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> FUN <span class=\"operator\">=</span> summary_fun<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">T</span> <span class=\"operator\">&lt;-</span> do.call<span class=\"punctuation\">(</span>rbind<span class=\"punctuation\">,</span> <span class=\"built_in\">T</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">rownames<span class=\"punctuation\">(</span><span class=\"built_in\">T</span><span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> basename<span class=\"punctuation\">(</span>fileNames<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pandoc.table<span class=\"punctuation\">(</span><span class=\"built_in\">T</span><span class=\"punctuation\">,</span> caption <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;Summary statistics on identified chromatographic&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot; peaks. Shown are number of identified peaks per&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot; sample and widths/duration of chromatographic &quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;peaks.&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------------------------------------------------------------------------</span><br><span class=\"line\">    &amp;nbsp;      peak_count   rt.0%   rt.25%   rt.50%   rt.75%   rt.100%</span><br><span class=\"line\">-------------- ------------ ------- -------- -------- -------- ---------</span><br><span class=\"line\"> **ko15.CDF**      400       10.95   34.43    42.25    53.21     319.2</span><br><span class=\"line\"></span><br><span class=\"line\"> **ko16.CDF**      522       10.95   32.86    42.25    53.21     151.8</span><br><span class=\"line\"></span><br><span class=\"line\"> **ko21.CDF**      215       10.95   42.25    50.08    64.95     164.3</span><br><span class=\"line\"></span><br><span class=\"line\"> **ko22.CDF**      239       10.95   37.56    46.95    59.47     147.1</span><br><span class=\"line\"></span><br><span class=\"line\"> **wt15.CDF**      408       10.95    31.3    42.25    53.21     161.2</span><br><span class=\"line\"></span><br><span class=\"line\"> **wt16.CDF**      366       10.95   35.99    45.38    59.47     162.8</span><br><span class=\"line\"></span><br><span class=\"line\"> **wt21.CDF**      228       10.95   35.99    48.51    65.73     172.1</span><br><span class=\"line\"></span><br><span class=\"line\"> **wt22.CDF**      334       10.95   35.99    43.82     57.9     228.5</span><br><span class=\"line\">------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">Table: Summary statistics on identified chromatographic peaks. Shown are number of identified peaks per sample and widths/duration of chromatographic peaks.</span><br></pre></td></tr></table></figure>\n\n<p>我们还可以使用<code>plotChromPeaks</code>函数绘制一个文件的m&#x2F;z——保留时间空间中已识别色谱峰的位置。下面我们绘制了第三个样品的色谱峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_12.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plotChromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_12.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_12.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Identified chromatographic peaks in the m/z by retention time space for one sample\"></p>\n<p>为了获得峰检测的全局概览，我们可以沿着保留时间轴绘制每个文件的已识别峰的频率。这允许识别MS运行中的时间段，在该时间段中识别出更多数量的峰，并评估这在文件之间是否一致。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_13.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plotChromPeakImage<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_13.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_13.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Frequency of identified chromatographic peaks along the retention time axis\"></p>\n<p><strong>图注</strong>：频率是彩色编码的，较高的频率由黄-白表示。每行显示一个文件的峰值频率。</p>\n<p>接下来，我们重点介绍前面示例峰的已识别色谱峰。在对应于已知峰或内标的峰列表上评估这样的图有助于确保峰检测设置是适当的并且正确地识别预期峰。我们从峰检测结果对象中提取离子色谱图，其中还包含我们可以使用<code>chromPeaks</code>函数提取的该离子的已识别色谱峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chr_ex <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">,</span> rt <span class=\"operator\">=</span> rtr<span class=\"punctuation\">)</span></span><br><span class=\"line\">chromPeaks<span class=\"punctuation\">(</span>chr_ex<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">##         mz mzmin mzmax       rt    rtmin    rtmax      into      intb  maxo sn</span><br><span class=\"line\">## CP0045 335   335   335 2781.505 2761.160 2809.674  412134.3  383167.4 16856 23</span><br><span class=\"line\">## CP0501 335   335   335 2786.199 2764.290 2812.803 1496244.2 1461187.3 58736 72</span><br><span class=\"line\">## CP1041 335   335   335 2797.154 2775.245 2815.933  159058.8  149229.6  6295 13</span><br><span class=\"line\">## CP2002 335   335   335 2786.199 2764.290 2812.803  932645.2  915333.8 35856 66</span><br><span class=\"line\">## CP2391 335   335   335 2792.461 2768.987 2823.760  876585.5  848569.1 27200 36</span><br><span class=\"line\">##        sample row column</span><br><span class=\"line\">## CP0045      1   1      1</span><br><span class=\"line\">## CP0501      2   1      2</span><br><span class=\"line\">## CP1041      3   1      3</span><br><span class=\"line\">## CP2002      6   1      6</span><br><span class=\"line\">## CP2391      7   1      7</span><br></pre></td></tr></table></figure>\n\n<p>我们还可以绘制提取的离子色谱图。已识别的色谱峰将在图中自动突出显示。下面我们用矩形突出显示色谱峰，从峰的最小到最大rt，从0到峰的最大信号。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sample_colors <span class=\"operator\">&lt;-</span> group_colors<span class=\"punctuation\">[</span>chr_ex<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_14.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_ex<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">,</span> peakType <span class=\"operator\">=</span> <span class=\"string\">&quot;rectangle&quot;</span><span class=\"punctuation\">,</span> peakCol <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>chr_ex<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> peakBg <span class=\"operator\">=</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_14.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_14.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Signal for an example peak\"></p>\n<p><strong>图注</strong>：红色和蓝色分别代表KO和野生型样本。矩形表示每个样品的色谱峰。</p>\n<p>作为上述矩形可视化的替代方案，可以用一个点表示每个峰的顶点位置（将参数<code>type=&quot;point&quot;</code>传递给函数），或通过指定<code>type=&quot;polygon&quot;</code>绘制实际识别的峰。为了完全省略突出显示已识别的峰（例如绘制基本峰色谱图或类似图），可以使用<code>type = &quot;none&quot;</code>”。下面我们使用<code>type=&quot;polygon&quot;</code>填充每个样品中每个已识别色谱峰的峰面积。然而，在这样的图中是否仍然可以识别单个峰取决于从中绘制峰的样本数量。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_15.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_ex<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>chr_raw<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> lwd <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">     peakBg <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>chr_ex<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_15.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_15.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Signal for an example peak\"><br><strong>图注</strong>：红色和蓝色分别代表KO和野生型样本。已识别色谱峰的信号区域用颜色填充。</p>\n<p>注意，我们还可以通过在<code>chromPeaks</code>方法中提供各自的m&#x2F;z和保留时间范围以及<code>mz</code>和<code>rt</code>参数，提取选定区域的已鉴定色谱峰。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pander<span class=\"punctuation\">(</span>chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">,</span> rt <span class=\"operator\">=</span> rtr<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> caption <span class=\"operator\">=</span> paste<span class=\"punctuation\">(</span><span class=\"string\">&quot;Identified chromatographic peaks in a selected &quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;m/z and retention time range.&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------------------------------------------------</span><br><span class=\"line\">   &amp;nbsp;     mz    mzmin   mzmax    rt    rtmin   rtmax    into      intb</span><br><span class=\"line\">------------ ----- ------- ------- ------ ------- ------- --------- ---------</span><br><span class=\"line\"> **CP0045**   335    335     335    2782   2761    2810    412134    383167</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP0501**   335    335     335    2786   2764    2813    1496244   1461187</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP1041**   335    335     335    2797   2775    2816    159059    149230</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP2002**   335    335     335    2786   2764    2813    932645    915334</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP2391**   335    335     335    2792   2769    2824    876586    848569</span><br><span class=\"line\">-----------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">Table: Identified chromatographic peaks in a selected  m/z and retention time range. (continued below)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------</span><br><span class=\"line\">   &amp;nbsp;     maxo    sn   sample</span><br><span class=\"line\">------------ ------- ---- --------</span><br><span class=\"line\"> **CP0045**   16856   23     1</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP0501**   58736   72     2</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP1041**   6295    13     3</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP2002**   35856   66     6</span><br><span class=\"line\"></span><br><span class=\"line\"> **CP2391**   27200   36     7</span><br><span class=\"line\">----------------------------------</span><br></pre></td></tr></table></figure>\n\n<p>最后，我们还绘制了每个样本的峰强度分布。这允许调查样本之间的峰信号是否存在系统差异。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Extract a list of per-sample peak intensities (in log2 scale)</span></span><br><span class=\"line\">ints <span class=\"operator\">&lt;-</span> split<span class=\"punctuation\">(</span>log2<span class=\"punctuation\">(</span>chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;into&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> f <span class=\"operator\">=</span> chromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_16.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">boxplot<span class=\"punctuation\">(</span>ints<span class=\"punctuation\">,</span> varwidth <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> ylab <span class=\"operator\">=</span> <span class=\"built_in\">expression</span><span class=\"punctuation\">(</span><span class=\"built_in\">log</span><span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"operator\">~</span>intensity<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> main <span class=\"operator\">=</span> <span class=\"string\">&quot;Peak intensities&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">grid<span class=\"punctuation\">(</span>nx <span class=\"operator\">=</span> <span class=\"literal\">NA</span><span class=\"punctuation\">,</span> ny <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_16.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_16.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Peak intensity distribution per sample\"><br>注意，除了上述色谱峰的识别之外，还可以使用<code>manualChromPeaks</code>函数手动定义和添加色谱峰（更多信息请参见<code>?manualChronPeaks</code>帮助页面）。</p>\n<h1 id=\"Alignment\"><a href=\"#Alignment\" class=\"headerlink\" title=\"Alignment\"></a>Alignment</h1><p>分析物在色谱中洗脱的时间可能因样品（甚至化合物）而异。在上一节中作为示例所示的提取离子色谱图中已经可以观察到这种差异。对齐步骤，也称为保留时间校正，旨在通过沿保留时间轴移动信号来调整这一点，以在实验中对齐不同样本之间的信号。</p>\n<p>存在很多的对齐算法（参见[3]），其中一些算法也在xcms中实现。在xcms中执行对齐&#x2F;保留时间校正的方法是<code>adjustRtime</code>，其根据所提供的参数类别使用不同的对齐算法。</p>\n<p>在下面的示例中，我们使用<em>obiwarp</em>方法[4]来对齐样本。我们使用<code>binSize＝0.6</code>，它在mz为0.6的bins中创建扭曲函数（warping functions）。此外，这里建议修改每个实验的设置，并评估保留时间校正是否对齐了内参或已知化合物。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> adjustRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> ObiwarpParam<span class=\"punctuation\">(</span>binSize <span class=\"operator\">=</span> <span class=\"number\">0.6</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><code>adjustRtime</code>，除了计算每个光谱的校正保留时间外，还调整了已鉴定色谱峰的报告保留时间。</p>\n<p>为了提取校正后的保留时间，我们可以使用<code>adjustedRtime</code>方法，或者简单地使用<code>rtime</code>方法，如果存在的话，默认情况下会从<code>XCMSnExp</code>对象返回校正后的保留时间。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Extract adjusted retention times</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>adjustedRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## F1.S0001 F1.S0002 F1.S0003 F1.S0004 F1.S0005 F1.S0006</span><br><span class=\"line\">## 2501.378 2502.958 2504.538 2506.118 2507.699 2509.280</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Or simply use the rtime method</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>rtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## F1.S0001 F1.S0002 F1.S0003 F1.S0004 F1.S0005 F1.S0006</span><br><span class=\"line\">## 2501.378 2502.958 2504.538 2506.118 2507.699 2509.280</span><br></pre></td></tr></table></figure>\n\n<p>原始保留时间可以从包含与<code>rtime(xdata，adjusted=FALSE)</code>对齐的数据的<code>XCMSnExp</code>中提取。</p>\n<p>为了评估对齐的影响，我们利用校正后的数据绘制BPC。此外，我们使用<code>plotAdjustedRtime</code>函数绘制每个样本的校正后保留时间与原始保留时间的差异。对于基峰色谱图，从结果对象中提取已识别的色谱峰是没有意义的。因此，我们在<code>chromatogram</code>调用中使用参数<code>include=&quot;none&quot;</code>，以在返回的对象中不包含色谱峰。请注意，也可以通过在<code>plot</code>调用中设置<code>peakType = &quot;none&quot;</code>来避免绘制它们。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Get the base peak chromatograms.</span></span><br><span class=\"line\">bpis_adj <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> aggregationFun <span class=\"operator\">=</span> <span class=\"string\">&quot;max&quot;</span><span class=\"punctuation\">,</span> include <span class=\"operator\">=</span> <span class=\"string\">&quot;none&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mar <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">4.5</span><span class=\"punctuation\">,</span> <span class=\"number\">4.2</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_17.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>bpis_adj<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>bpis_adj<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Plot also the difference of adjusted to raw retention time.</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_18.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plotAdjustedRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_17.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_17.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Obiwarp aligned data\"><br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_18.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_18.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Obiwarp aligned data\"></p>\n<p><strong>图注</strong>：对齐后的基峰色谱图（顶部）和沿保留时间轴的校正保留时间与原始保留时间之间的差异（底部）。</p>\n<p>校正后的保留时间与原始保留时间之间的差异太大，可能表明样品或对齐效果不佳（poorly performing samples or alignment）。</p>\n<p><strong>注意</strong>：<code>XCMSnExp</code>对象保存原始数据以及校正后的保留时间，在大多数情况下，子设置（subsetting）将删除校正后的保持时间。因此，一些情况下用校正后的保留时间代替原始保留时间可能是有用的。这可以通过<code>applyAdjustedRtime</code>完成。</p>\n<p>最后，我们评估了对齐对测试峰的影响。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">## Plot the raw data</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_19.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_raw<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>chr_raw<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Extract the chromatogram from the adjusted object</span></span><br><span class=\"line\">chr_adj <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> rt <span class=\"operator\">=</span> rtr<span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_20.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chr_adj<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> group_colors<span class=\"punctuation\">[</span>chr_raw<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> peakType <span class=\"operator\">=</span> <span class=\"string\">&quot;none&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_19.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_19.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Example extracted ion chromatogram before (top) and after alignment (bottom)\"><br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_20.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_20.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Example extracted ion chromatogram before (top) and after alignment (bottom)\"></p>\n<h2 id=\"Subset-based-alignment\"><a href=\"#Subset-based-alignment\" class=\"headerlink\" title=\"Subset-based alignment\"></a>Subset-based alignment</h2><p>在一些实验中，仅根据样本的子集进行比对可能会有所帮助，例如，如果QC样本定期注射（injected ），或者如果实验包含空白样本。xcms中的对齐方法允许估计样本子集（不包括空白样本的所有样本或在测量运行期间定期注入的质控样本）的保留时间漂移，并使用这些来调整整个数据集。</p>\n<p>参数<code>subset</code>（<code>PeakGroupsParam</code>或<code>ObiwarpParam</code>对象）可用于定义样本子集，整个数据集的对齐将基于该样本子集（例如，子集是QC样本的索引），参数<code>subsetAdjust</code>允许指定调整遗漏样本（left-out samples）的方法。目前有两个选项可用：</p>\n<ul>\n<li><code>subsetAdjust = &quot;previous&quot;</code>：根据先前子集样本（例如QC样本）的对齐结果调整非子集样本的保留时间。如果样本的顺序为A1、B1、B2、A2、B3、B4，A代表QC样本，B代表研究样本，则使用<code>subset = c(1, 4)</code>和<code>subsetAdjust = &quot;previous&quot;</code>将导致所有A样本彼此对齐，而非子集样本B1和B2将根据子集样本A1和B3以及B4对A2样本的对齐结果进行调整。</li>\n<li><code>subsetAdjust = &quot;average&quot;</code>：基于先前和后续子集样本的对齐结果的内插（interpolation）来调整非子集样本的保留时间。在上述示例中，B1将基于子集（QC）样本A1和A2之间的校正保留时间的平均值进行调整。由于在非子集样本B3和B4之后没有子集样本，因此将仅基于A2的对齐结果来校正这些样本。注意，加权平均值用于计算经校正的保留时间平均值，其使用非子集样本与子集样本的索引之差的倒数作为权重。因此，如果我们有类似A1、B1、B2、A2的设置，在校正非子集样本B1时，A1的校正保留时间将比A2的更大，从而使其校正保留时间更接近A1的保留时间，而不是A2的保留时间。请参见下面的示例。</li>\n</ul>\n<p>这两种情况都需要对对象内的样本进行有意义的&#x2F;正确的排序（例如按注入索引排序）。</p>\n<p>以下示例旨在说明这些对齐选项的效果。我们假设faahKO数据集中的样本1、4和7是质控样本（样本池）。因此，我们希望基于这些样本执行对齐，随后基于来自相邻子集（QC）样本的结果的插值来校正剩余的样本（2、3、5、6和8）的保留时间。在初始峰分组后，我们使用峰组法（peak groups method）进行校准，通过子集参数传递我们希望校准所基于的样本的索引，并指定<code>subsetAdjust = &quot;average&quot;</code>以根据相邻子集&#x2F;QC样本的校准结果的插值校正研究样本。</p>\n<p>注意，对于任何子集对齐，所有参数（如<code>minFraction</code>）都是相对于子集的，而不是整个实验！</p>\n<p>要重新执行对齐，我们可以首先使用<code>dropAdjustedRtime</code>函数删除以前的对齐结果。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> dropAdjustedRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Define the experimental layout</span></span><br><span class=\"line\">xdata<span class=\"operator\">$</span>sample_type <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;study&quot;</span></span><br><span class=\"line\">xdata<span class=\"operator\">$</span>sample_type<span class=\"punctuation\">[</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span> <span class=\"number\">7</span><span class=\"punctuation\">)</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;QC&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>接下来，我们必须进行初始对应分析，因为峰群对齐方法通过对齐之前识别的hook峰（存在于大多数&#x2F;所有样品中的色谱峰；下一节将介绍所用算法的详细信息）来校正保留时间。我们在这里使用默认设置，但强烈建议为每个数据集调整参数。<br><code>PeakDensityParam</code>必须定义样本组（即，将单个样本分配给实验中的样本组）。如果实验中没有样本组，则应将每个文件的样本组设置为单个值（例如<code>rep(1, length(fileNames(xdata))</code>）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Initial peak grouping. Use sample_type as grouping variable</span></span><br><span class=\"line\">pdp_subs <span class=\"operator\">&lt;-</span> PeakDensityParam<span class=\"punctuation\">(</span>sampleGroups <span class=\"operator\">=</span> xdata<span class=\"operator\">$</span>sample_type<span class=\"punctuation\">,</span></span><br><span class=\"line\">                             minFraction <span class=\"operator\">=</span> <span class=\"number\">0.9</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> groupChromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> pdp_subs<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Define subset-alignment options and perform the alignment</span></span><br><span class=\"line\">pgp_subs <span class=\"operator\">&lt;-</span> PeakGroupsParam<span class=\"punctuation\">(</span>minFraction <span class=\"operator\">=</span> <span class=\"number\">0.85</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                            subset <span class=\"operator\">=</span> which<span class=\"punctuation\">(</span>xdata<span class=\"operator\">$</span>sample_type <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                            subsetAdjust <span class=\"operator\">=</span> <span class=\"string\">&quot;average&quot;</span><span class=\"punctuation\">,</span> span <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> adjustRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> pgp_subs<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>下面，我们绘制了对齐结果，用绿色标记了作为子集一部分的样本，其他样本用灰色标注。这很好地显示了<code>subsetAdjust = &quot;average&quot;</code>的插值是如何工作的：样本2的保留时间是根据子集样本1和4的保留时间进行校正的，但是，给更接近的子集样本1赋予了更大的权重，这导致校正后的样本2的保持时间与样本1的保持时间更相似。另一方面，样本3得到校正，给第二子集样本（4）赋予更多权重。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">clrs <span class=\"operator\">&lt;-</span> <span class=\"built_in\">rep</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;#00000040&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">8</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">clrs<span class=\"punctuation\">[</span>xdata<span class=\"operator\">$</span>sample_type <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;#00ce0080&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">par<span class=\"punctuation\">(</span>mfrow <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> mar <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">4</span><span class=\"punctuation\">,</span> <span class=\"number\">4.5</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_21.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>chromatogram<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> aggregationFun <span class=\"operator\">=</span> <span class=\"string\">&quot;sum&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> clrs<span class=\"punctuation\">,</span> peakType <span class=\"operator\">=</span> <span class=\"string\">&quot;none&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_22.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plotAdjustedRtime<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> clrs<span class=\"punctuation\">,</span> peakGroupsPch <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> peakGroupsCol <span class=\"operator\">=</span> <span class=\"string\">&quot;#00ce0040&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_21.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_21.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Subset-alignment results with option average\"><br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_22.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_22.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Subset-alignment results with option average\"></p>\n<p><strong>图注</strong>：沿保留时间轴校正保留时间与原始保留时间之间的差异。对校准模型进行估算的样本显示为绿色，研究样本显示为灰色。</p>\n<p>选项<code>subsetAdjust = &quot;previous&quot;</code>基于单个子集样本（先前的）校正非子集样本的保留时间，这在大多数情况下导致非子集样本校正后的保留时间与用于校正的子集样本高度相似。</p>\n<h1 id=\"Correspondence\"><a href=\"#Correspondence\" class=\"headerlink\" title=\"Correspondence\"></a>Correspondence</h1><p>代谢组学预处理的最后一步是匹配样本之间（取决于设置，如果样本相邻，也在样本内）检测到的色谱峰的对应关系。在xcms中执行对应的方法是<code>groupChromPeaks</code>。我们将使用峰密度法[5]对色谱峰进行分组。该算法结合了色谱峰，这取决于沿着mz维度的小切片中沿着保留时间轴的峰密度。为了说明这一点，我们绘制了每个样品中具有多个色谱峰的mz切片的色谱图。我们使用0.4的<code>minFraction</code>参数值，因此每个样本组中至少有40%的样本中存在的色谱峰被分组为特征（feature）。样品组分配是使用<code>sampleGroups</code>参数指定的。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Define the mz slice.</span></span><br><span class=\"line\">mzr <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">305.05</span><span class=\"punctuation\">,</span> <span class=\"number\">305.15</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Extract and plot the chromatograms</span></span><br><span class=\"line\">chr_mzr <span class=\"operator\">&lt;-</span> chromatogram<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> mz <span class=\"operator\">=</span> mzr<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">## Define the parameters for the peak density method</span></span><br><span class=\"line\">pdp <span class=\"operator\">&lt;-</span> PeakDensityParam<span class=\"punctuation\">(</span>sampleGroups <span class=\"operator\">=</span> xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">,</span> minFraction <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">,</span> bw <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_23.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plotChromPeakDensity<span class=\"punctuation\">(</span>chr_mzr<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> pdp<span class=\"punctuation\">,</span> peakBg <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>chr_mzr<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> peakCol <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>chr_mzr<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> peakPch <span class=\"operator\">=</span> <span class=\"number\">16</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_23.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_23.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Example for peak density correspondence\"></p>\n<p><strong>图注</strong>：上图：具有多个色谱峰的mz切片的色谱图。下图：确定保留时间的色谱峰(x轴)和不同bw参数值的实验样品内的指数(y轴)。黑线表示峰密度估计值。峰分组（基于提供的设置）由灰色矩形表示。</p>\n<p>上图中的上部面板显示了每个样品的提取离子色谱图，突出显示了检测到的峰。中间和下部曲线显示了不同样品中每个检测到的峰的保留时间。黑色实线表示检测到的峰沿保留时间的密度分布。组合成特征（峰值组）的峰值用灰色矩形表示。这种类型的可视化非常适合在将示例m&#x2F;z切片应用于完整数据集之前测试它们的对应设置。</p>\n<p>下面，我们将基于定义设置（defined settings）对整个数据集进行对应分析。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Perform the correspondence</span></span><br><span class=\"line\">pdp <span class=\"operator\">&lt;-</span> PeakDensityParam<span class=\"punctuation\">(</span>sampleGroups <span class=\"operator\">=</span> xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">,</span> minFraction <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">,</span> bw <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> groupChromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> pdp<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>基于xcms的预处理结果可以通过<code>quantify</code>法从<em>SummarizedExperiment</em>包中汇总为<code>SummarizedExperiment</code>对象。该对象将包含作为分析矩阵的特征丰度、作为<code>rowData</code>（即行注释）的特征定义（其m&#x2F;z、保留时间和其他元数据）和作为<code>colData</code>（即列注释）的样本&#x2F;表型信息。所有处理历史记录都将放入对象的元数据中（metadata）。然后，该对象可以用于任何进一步的（与xcms无关的）处理和分析。</p>\n<p>下面我们使用<code>quantify</code>来生成当前分析的结果对象。参数值和任何其他附加参数将传递给<code>featureValues</code>方法，该方法在内部用于创建特征丰度矩阵。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">res <span class=\"operator\">&lt;-</span> quantify<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"string\">&quot;into&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>样品注释可以通过<code>colData</code>方法访问。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">colData<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## DataFrame with 8 rows and 3 columns</span><br><span class=\"line\">##          sample_name sample_group sample_type</span><br><span class=\"line\">##          &lt;character&gt;  &lt;character&gt; &lt;character&gt;</span><br><span class=\"line\">## ko15.CDF        ko15           KO          QC</span><br><span class=\"line\">## ko16.CDF        ko16           KO       study</span><br><span class=\"line\">## ko21.CDF        ko21           KO       study</span><br><span class=\"line\">## ko22.CDF        ko22           KO          QC</span><br><span class=\"line\">## wt15.CDF        wt15           WT       study</span><br><span class=\"line\">## wt16.CDF        wt16           WT       study</span><br><span class=\"line\">## wt21.CDF        wt21           WT          QC</span><br><span class=\"line\">## wt22.CDF        wt22           WT       study</span><br></pre></td></tr></table></figure>\n\n<p>通过<code>rowData</code>注释特征：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rowData<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DataFrame with 357 rows and 11 columns</span><br><span class=\"line\">          mzmed     mzmin     mzmax     rtmed     rtmin     rtmax    npeaks</span><br><span class=\"line\">      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span><br><span class=\"line\">FT001     200.1     200.1     200.1   2902.25   2882.24   2922.27         2</span><br><span class=\"line\">FT002     205.0     205.0     205.0   2789.40   2782.36   2795.94         8</span><br><span class=\"line\">FT003     206.0     206.0     206.0   2788.64   2780.79   2793.78         7</span><br><span class=\"line\">FT004     207.1     207.1     207.1   2718.25   2713.28   2726.63         7</span><br><span class=\"line\">FT005     219.1     219.1     219.1   2518.60   2517.35   2521.09         3</span><br><span class=\"line\">...         ...       ...       ...       ...       ...       ...       ...</span><br><span class=\"line\">FT353    595.25     595.2     595.3   3010.39   2992.58   3014.38         6</span><br><span class=\"line\">FT354    596.20     596.2     596.2   2997.60   2992.58   3002.61         2</span><br><span class=\"line\">FT355    596.30     596.3     596.3   3818.98   3811.68   3835.78         4</span><br><span class=\"line\">FT356    597.40     597.4     597.4   3821.10   3817.96   3825.14         3</span><br><span class=\"line\">FT357    599.30     599.3     599.3   4070.45   4042.10   4123.52         3</span><br><span class=\"line\">             KO        WT            peakidx  ms_level</span><br><span class=\"line\">      &lt;numeric&gt; &lt;numeric&gt;             &lt;list&gt; &lt;integer&gt;</span><br><span class=\"line\">FT001         2         0           463,1180         1</span><br><span class=\"line\">FT002         4         4     47,448,960,...         1</span><br><span class=\"line\">FT003         3         4   32, 435,1164,...         1</span><br><span class=\"line\">FT004         4         3     19,425,943,...         1</span><br><span class=\"line\">FT005         1         2     1140,1379,2382         1</span><br><span class=\"line\">...         ...       ...                ...       ...</span><br><span class=\"line\">FT353         2         3   67, 529,1466,...         1</span><br><span class=\"line\">FT354         0         2          1457,2452         1</span><br><span class=\"line\">FT355         2         2  332,1110,2071,...         1</span><br><span class=\"line\">FT356         1         2      838,2355,2680         1</span><br><span class=\"line\">FT357         1         2      375,1757,2137         1</span><br></pre></td></tr></table></figure>\n\n<p>特征丰度可以通过<code>assay</code>方法获得。还要注意，<code>SummarizedExperiment</code>支持多个这样的分析矩阵。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>assay<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ko15.CDF  ko16.CDF  ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF</span><br><span class=\"line\">FT001        NA  506848.9        NA  169955.6        NA        NA        NA</span><br><span class=\"line\">FT002 1924712.0 1757151.0 1383416.7 1180288.2 2129885.1 1634342.0 1623589.2</span><br><span class=\"line\">FT003  213659.3  289500.7        NA  178285.7  253825.6  241844.4  240606.0</span><br><span class=\"line\">FT004  349011.5  451863.7  343897.8  208002.8  364609.8  360908.9        NA</span><br><span class=\"line\">FT005        NA        NA        NA  107348.5  223951.8        NA        NA</span><br><span class=\"line\">FT006  286221.4        NA  164009.0  149097.6  255697.7  311296.8  366441.5</span><br><span class=\"line\">        wt22.CDF</span><br><span class=\"line\">FT001         NA</span><br><span class=\"line\">FT002 1354004.93</span><br><span class=\"line\">FT003  185399.47</span><br><span class=\"line\">FT004  221937.53</span><br><span class=\"line\">FT005   84772.92</span><br><span class=\"line\">FT006  271128.02</span><br></pre></td></tr></table></figure>\n\n<p>此外，还可以使用<code>featureDefinitions</code>和<code>featureValues</code>方法分别从对应分析中提取结果，前者返回带有特征定义的数据框(即mz和rt范围，在列peakidx中为每个特征的<code>chromPeaks</code>矩阵中的色谱峰指数)，后者为特征丰度。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Extract the feature definitions</span></span><br><span class=\"line\">featureDefinitions<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DataFrame with 357 rows and 11 columns</span><br><span class=\"line\">          mzmed     mzmin     mzmax     rtmed     rtmin     rtmax    npeaks</span><br><span class=\"line\">      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;</span><br><span class=\"line\">FT001     200.1     200.1     200.1   2902.25   2882.24   2922.27         2</span><br><span class=\"line\">FT002     205.0     205.0     205.0   2789.40   2782.36   2795.94         8</span><br><span class=\"line\">FT003     206.0     206.0     206.0   2788.64   2780.79   2793.78         7</span><br><span class=\"line\">FT004     207.1     207.1     207.1   2718.25   2713.28   2726.63         7</span><br><span class=\"line\">FT005     219.1     219.1     219.1   2518.60   2517.35   2521.09         3</span><br><span class=\"line\">...         ...       ...       ...       ...       ...       ...       ...</span><br><span class=\"line\">FT353    595.25     595.2     595.3   3010.39   2992.58   3014.38         6</span><br><span class=\"line\">FT354    596.20     596.2     596.2   2997.60   2992.58   3002.61         2</span><br><span class=\"line\">FT355    596.30     596.3     596.3   3818.98   3811.68   3835.78         4</span><br><span class=\"line\">FT356    597.40     597.4     597.4   3821.10   3817.96   3825.14         3</span><br><span class=\"line\">FT357    599.30     599.3     599.3   4070.45   4042.10   4123.52         3</span><br><span class=\"line\">             KO        WT            peakidx  ms_level</span><br><span class=\"line\">      &lt;numeric&gt; &lt;numeric&gt;             &lt;list&gt; &lt;integer&gt;</span><br><span class=\"line\">FT001         2         0           463,1180         1</span><br><span class=\"line\">FT002         4         4     47,448,960,...         1</span><br><span class=\"line\">FT003         3         4   32, 435,1164,...         1</span><br><span class=\"line\">FT004         4         3     19,425,943,...         1</span><br><span class=\"line\">FT005         1         2     1140,1379,2382         1</span><br><span class=\"line\">...         ...       ...                ...       ...</span><br><span class=\"line\">FT353         2         3   67, 529,1466,...         1</span><br><span class=\"line\">FT354         0         2          1457,2452         1</span><br><span class=\"line\">FT355         2         2  332,1110,2071,...         1</span><br><span class=\"line\">FT356         1         2      838,2355,2680         1</span><br><span class=\"line\">FT357         1         2      375,1757,2137         1</span><br></pre></td></tr></table></figure>\n\n<p><code>featureValues</code>方法返回一个矩阵，其中行是特征，列是样本。这个矩阵的内容可以使用<code>value</code>参数定义。默认值<code>value = &quot;into&quot;</code>返回一个矩阵，其中包含样本中某个特征对应的峰的整合信号。<code>chromPeaks</code>矩阵的任何列名都可以传递给参数<code>value</code>。下面我们提取每个特征&#x2F;样本的整合峰值强度。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Extract the into column for each feature.</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>featureValues<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> value <span class=\"operator\">=</span> <span class=\"string\">&quot;into&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ko15.CDF  ko16.CDF  ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF</span><br><span class=\"line\">FT001        NA  506848.9        NA  169955.6        NA        NA        NA</span><br><span class=\"line\">FT002 1924712.0 1757151.0 1383416.7 1180288.2 2129885.1 1634342.0 1623589.2</span><br><span class=\"line\">FT003  213659.3  289500.7        NA  178285.7  253825.6  241844.4  240606.0</span><br><span class=\"line\">FT004  349011.5  451863.7  343897.8  208002.8  364609.8  360908.9        NA</span><br><span class=\"line\">FT005        NA        NA        NA  107348.5  223951.8        NA        NA</span><br><span class=\"line\">FT006  286221.4        NA  164009.0  149097.6  255697.7  311296.8  366441.5</span><br><span class=\"line\">        wt22.CDF</span><br><span class=\"line\">FT001         NA</span><br><span class=\"line\">FT002 1354004.93</span><br><span class=\"line\">FT003  185399.47</span><br><span class=\"line\">FT004  221937.53</span><br><span class=\"line\">FT005   84772.92</span><br><span class=\"line\">FT006  271128.02</span><br></pre></td></tr></table></figure>\n\n<p>该特征矩阵包含某些样品在特征m&#x2F;z-rt区域未检测到色谱峰（NA值）。虽然在许多情况下，在相应的区域可能确实没有峰信号，但也可能有信号，但峰检测算法未能检测到色谱峰(例如，因为信号太低或噪声太大)。xcms提供<code>fillChromPeaks</code>方法来填充原始文件中这些缺失值的强度数据。填充的峰被添加到chromPeaks矩阵中，并在<code>chromPeakData</code>数据框的<code>“is_filled”</code>列中用<code>TRUE</code>表示。下面我们执行这样的填充。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xdata <span class=\"operator\">&lt;-</span> fillChromPeaks<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> param <span class=\"operator\">=</span> ChromPeakAreaParam<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>featureValues<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">       ko15.CDF   ko16.CDF   ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF</span><br><span class=\"line\">FT001  135315.2  506848.88  111783.48  169955.6  210166.7  141768.0  233086.7</span><br><span class=\"line\">FT002 1924712.0 1757150.96 1383416.72 1180288.2 2129885.1 1634342.0 1623589.2</span><br><span class=\"line\">FT003  213659.3  289500.67  164404.50  178285.7  253825.6  241844.4  240606.0</span><br><span class=\"line\">FT004  349011.5  451863.66  343897.76  208002.8  364609.8  360908.9  225332.1</span><br><span class=\"line\">FT005  161425.0   37819.63   82574.72  107348.5  223951.8  135617.6  191928.5</span><br><span class=\"line\">FT006  286221.4  286834.04  164008.97  149097.6  255697.7  311296.8  366441.5</span><br><span class=\"line\">        wt22.CDF</span><br><span class=\"line\">FT001  142142.23</span><br><span class=\"line\">FT002 1354004.93</span><br><span class=\"line\">FT003  185399.47</span><br><span class=\"line\">FT004  221937.53</span><br><span class=\"line\">FT005   84772.92</span><br><span class=\"line\">FT006  271128.02</span><br></pre></td></tr></table></figure>\n\n<p>对于样本中没有检测到峰的特征，该方法提取特征的mz-rt区域中的所有强度，对信号进行整合（integrates），并将填充的峰添加到<code>chromPeaks</code>矩阵中。如果特征的mz-rt区域没有测量&#x2F;可用信号，则不添加峰。对于这些，即使在填写了缺失的峰数据后，也会在<code>featureValues</code>矩阵中报告NA。</p>\n<p>可以使用不同的选项来定义特征的mz-rt区域。使用上面使用的<code>ChromPeakAreaParam()</code>参数对象，使用其所有（检测到的）色谱峰的m&#x2F;z和rt范围定义特征区域：区域中低的m&#x2F;z值定义为特征所有峰的“mzmin”值的下四分位（25%分位数），高m&#x2F;z值为“mzmax”值的上四分位数（75%分位数），低rt值作为“rtmin”值的下四分位（25%分位数），高rt值为“rtmax”值的上四分位数（75%分位数）。这确保了信号是从特定特征区域集成的。</p>\n<p>或者，可以在<code>fillChromPeaks</code>调用中使用<code>FillChromPpeaksParam</code>参数对象，这类似于初始（old）xcms实现的方法。</p>\n<p>下面我们比较填写缺失值前后缺失值的数量。我们可以使用<code>featureValues</code>方法的<code>filled</code>参数来定义是否也应该返回填充的峰值（filled-in peak values）。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Missing values before filling in peaks</span></span><br><span class=\"line\">apply<span class=\"punctuation\">(</span>featureValues<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> filled <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> MARGIN <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> FUN <span class=\"operator\">=</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## ko15.CDF ko16.CDF ko21.CDF ko22.CDF wt15.CDF wt16.CDF wt21.CDF wt22.CDF</span><br><span class=\"line\">##       91       93      168      154       95      119      167      123</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Missing values after filling in peaks</span></span><br><span class=\"line\">apply<span class=\"punctuation\">(</span>featureValues<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> MARGIN <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> FUN <span class=\"operator\">=</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>z<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## ko15.CDF ko16.CDF ko21.CDF ko22.CDF wt15.CDF wt16.CDF wt21.CDF wt22.CDF</span><br><span class=\"line\">##        5        4        5        5        4        7        6        2</span><br></pre></td></tr></table></figure>\n\n<p>接下来，我们使用<code>featureSummary</code>函数获取每个特征的一般摘要，其中包括找到峰的样本数量或为特征分配了多个峰的样本数。同时指定样本组可以分解每个样本组的汇总统计信息。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>featureSummary<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      count  perc multi_count multi_perc       rsd KO_count KO_perc</span><br><span class=\"line\">FT001     2  25.0           0          0 0.7039537        2      50</span><br><span class=\"line\">FT002     8 100.0           0          0 0.1936518        4     100</span><br><span class=\"line\">FT003     7  87.5           0          0 0.1717662        3      75</span><br><span class=\"line\">FT004     7  87.5           0          0 0.2609145        4     100</span><br><span class=\"line\">FT005     3  37.5           0          0 0.5385767        1      25</span><br><span class=\"line\">FT006     7  87.5           0          0 0.3016973        3      75</span><br><span class=\"line\">      KO_multi_count KO_multi_perc    KO_rsd WT_count WT_perc WT_multi_count</span><br><span class=\"line\">FT001              0             0 0.7039537        0       0              0</span><br><span class=\"line\">FT002              0             0 0.2178920        4     100              0</span><br><span class=\"line\">FT003              0             0 0.2501505        4     100              0</span><br><span class=\"line\">FT004              0             0 0.2957873        3      75              0</span><br><span class=\"line\">FT005              0             0        NA        2      50              0</span><br><span class=\"line\">FT006              0             0 0.3765933        4     100              0</span><br><span class=\"line\">      WT_multi_perc    WT_rsd</span><br><span class=\"line\">FT001             0        NA</span><br><span class=\"line\">FT002             0 0.1918936</span><br><span class=\"line\">FT003             0 0.1327983</span><br><span class=\"line\">FT004             0 0.2575039</span><br><span class=\"line\">FT005             0 0.6375539</span><br><span class=\"line\">FT006             0 0.1641781</span><br></pre></td></tr></table></figure>\n\n<p>我们可以将特征值矩阵与缺失峰值的填充数据一起添加到我们的<code>SummarizedExperiment</code>对象res中，作为附加矩阵（assay）：</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assays<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span><span class=\"operator\">$</span>raw_filled <span class=\"operator\">&lt;-</span> featureValues<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> filled <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>我们现在有两个可用的矩阵（assays），一个具有检测值的矩阵，一个包含检测值和填充值的矩阵，每个都可以通过其名称访问。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assayNames<span class=\"punctuation\">(</span>res<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## [1] &quot;raw&quot;        &quot;raw_filled&quot;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>assay<span class=\"punctuation\">(</span>res<span class=\"punctuation\">,</span> <span class=\"string\">&quot;raw&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ko15.CDF  ko16.CDF  ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF</span><br><span class=\"line\">FT001        NA  506848.9        NA  169955.6        NA        NA        NA</span><br><span class=\"line\">FT002 1924712.0 1757151.0 1383416.7 1180288.2 2129885.1 1634342.0 1623589.2</span><br><span class=\"line\">FT003  213659.3  289500.7        NA  178285.7  253825.6  241844.4  240606.0</span><br><span class=\"line\">FT004  349011.5  451863.7  343897.8  208002.8  364609.8  360908.9        NA</span><br><span class=\"line\">FT005        NA        NA        NA  107348.5  223951.8        NA        NA</span><br><span class=\"line\">FT006  286221.4        NA  164009.0  149097.6  255697.7  311296.8  366441.5</span><br><span class=\"line\">        wt22.CDF</span><br><span class=\"line\">FT001         NA</span><br><span class=\"line\">FT002 1354004.93</span><br><span class=\"line\">FT003  185399.47</span><br><span class=\"line\">FT004  221937.53</span><br><span class=\"line\">FT005   84772.92</span><br><span class=\"line\">FT006  271128.02</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>assay<span class=\"punctuation\">(</span>res<span class=\"punctuation\">,</span> <span class=\"string\">&quot;raw_filled&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">       ko15.CDF   ko16.CDF   ko21.CDF  ko22.CDF  wt15.CDF  wt16.CDF  wt21.CDF</span><br><span class=\"line\">FT001  135315.2  506848.88  111783.48  169955.6  210166.7  141768.0  233086.7</span><br><span class=\"line\">FT002 1924712.0 1757150.96 1383416.72 1180288.2 2129885.1 1634342.0 1623589.2</span><br><span class=\"line\">FT003  213659.3  289500.67  164404.50  178285.7  253825.6  241844.4  240606.0</span><br><span class=\"line\">FT004  349011.5  451863.66  343897.76  208002.8  364609.8  360908.9  225332.1</span><br><span class=\"line\">FT005  161425.0   37819.63   82574.72  107348.5  223951.8  135617.6  191928.5</span><br><span class=\"line\">FT006  286221.4  286834.04  164008.97  149097.6  255697.7  311296.8  366441.5</span><br><span class=\"line\">        wt22.CDF</span><br><span class=\"line\">FT001  142142.23</span><br><span class=\"line\">FT002 1354004.93</span><br><span class=\"line\">FT003  185399.47</span><br><span class=\"line\">FT004  221937.53</span><br><span class=\"line\">FT005   84772.92</span><br><span class=\"line\">FT006  271128.02</span><br></pre></td></tr></table></figure>\n\n<p>应始终通过检查提取的离子色谱图（例如已知化合物、内标或一般识别特征）来评估峰检测、比对（alignment）和对应（correspondence）的性能。<code>featureChromatogram</code>函数允许提取<code>featureDefinitions</code>中每个特征的色谱图。返回的<code>MCchromatograms</code>对象包含每个特征（每行包含一个特征的数据）和样本（每列代表一个样本的数据）的离子色谱图。下面我们提取前4个特征的色谱图。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">feature_chroms <span class=\"operator\">&lt;-</span> featureChromatograms<span class=\"punctuation\">(</span>xdata<span class=\"punctuation\">,</span> features <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">4</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">feature_chroms</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## XChromatograms with 4 rows and 8 columns</span><br><span class=\"line\">##                    1               2               3               4</span><br><span class=\"line\">##      &lt;XChromatogram&gt; &lt;XChromatogram&gt; &lt;XChromatogram&gt; &lt;XChromatogram&gt;</span><br><span class=\"line\">## [1,]        peaks: 0        peaks: 1        peaks: 0        peaks: 1</span><br><span class=\"line\">## [2,]        peaks: 1        peaks: 1        peaks: 1        peaks: 1</span><br><span class=\"line\">## [3,]        peaks: 1        peaks: 1        peaks: 0        peaks: 1</span><br><span class=\"line\">## [4,]        peaks: 1        peaks: 1        peaks: 1        peaks: 1</span><br><span class=\"line\">##                    5               6               7               8</span><br><span class=\"line\">##      &lt;XChromatogram&gt; &lt;XChromatogram&gt; &lt;XChromatogram&gt; &lt;XChromatogram&gt;</span><br><span class=\"line\">## [1,]        peaks: 0        peaks: 0        peaks: 0        peaks: 0</span><br><span class=\"line\">## [2,]        peaks: 1        peaks: 1        peaks: 1        peaks: 1</span><br><span class=\"line\">## [3,]        peaks: 1        peaks: 1        peaks: 1        peaks: 1</span><br><span class=\"line\">## [4,]        peaks: 1        peaks: 1        peaks: 0        peaks: 1</span><br><span class=\"line\">## phenoData with 3 variables</span><br><span class=\"line\">## featureData with 5 variables</span><br><span class=\"line\">## - - - xcms preprocessing - - -</span><br><span class=\"line\">## Chromatographic peak detection:</span><br><span class=\"line\">##  method: centWave</span><br><span class=\"line\">## Correspondence:</span><br><span class=\"line\">##  method: chromatographic peak density</span><br><span class=\"line\">##  4 feature(s) identified.</span><br></pre></td></tr></table></figure>\n<p>绘制提取的离子色谱图。我们再次使用每个鉴定峰的组颜色来填充该区域。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_24.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>feature_chroms<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">,</span> peakBg <span class=\"operator\">=</span> sample_colors<span class=\"punctuation\">[</span>chromPeaks<span class=\"punctuation\">(</span>feature_chroms<span class=\"punctuation\">)</span><span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_24.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_24.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"Extracted ion chromatograms for features 1 to 4\"><br> 为了访问第二个特征的EIC，我们可以简单地将<code>feature_chros</code>对象取子集。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> eic_2 <span class=\"operator\">&lt;-</span> feature_chroms<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br><span class=\"line\">chromPeaks<span class=\"punctuation\">(</span>eic_2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">        mz mzmin mzmax       rt    rtmin    rtmax    into    intb  maxo sn</span><br><span class=\"line\">CP0055 205   205   205 2791.599 2771.048 2815.323 1924712 1850331 84280 64</span><br><span class=\"line\">CP0502 205   205   205 2795.355 2773.257 2820.612 1757151 1711473 68384 69</span><br><span class=\"line\">CP1049 205   205   205 2795.936 2773.877 2821.143 1383417 1334570 47384 54</span><br><span class=\"line\">CP1277 205   205   205 2788.642 2768.195 2812.229 1180288 1126958 48336 32</span><br><span class=\"line\">CP1567 205   205   205 2782.355 2761.949 2805.895 2129885 2054677 93312 44</span><br><span class=\"line\">CP2005 205   205   205 2787.051 2766.690 2812.111 1634342 1566379 67984 53</span><br><span class=\"line\">CP2392 205   205   205 2790.157 2763.587 2821.427 1623589 1531573 49208 28</span><br><span class=\"line\">CP2649 205   205   205 2787.032 2766.714 2812.043 1354005 1299188 55712 35</span><br><span class=\"line\">       sample row column</span><br><span class=\"line\">CP0055      1   1      1</span><br><span class=\"line\">CP0502      2   1      2</span><br><span class=\"line\">CP1049      3   1      3</span><br><span class=\"line\">CP1277      4   1      4</span><br><span class=\"line\">CP1567      5   1      5</span><br><span class=\"line\">CP2005      6   1      6</span><br><span class=\"line\">CP2392      7   1      7</span><br><span class=\"line\">CP2649      8   1      8</span><br></pre></td></tr></table></figure>\n\n<p>最后，我们进行了主成分分析，以评估本实验中样本的分组。注意，我们没有执行任何数据标准化，因此分组可能（也将）受到技术偏见的影响。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## Extract the features and log2 transform them</span></span><br><span class=\"line\">ft_ints <span class=\"operator\">&lt;-</span> log2<span class=\"punctuation\">(</span>assay<span class=\"punctuation\">(</span>res<span class=\"punctuation\">,</span> <span class=\"string\">&quot;raw_filled&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Perform the PCA omitting all features with an NA in any of the</span></span><br><span class=\"line\"><span class=\"comment\">## samples. Also, the intensities are mean centered.</span></span><br><span class=\"line\">pc <span class=\"operator\">&lt;-</span> prcomp<span class=\"punctuation\">(</span>t<span class=\"punctuation\">(</span>na.omit<span class=\"punctuation\">(</span>ft_ints<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> center <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## Plot the PCA</span></span><br><span class=\"line\">cols <span class=\"operator\">&lt;-</span> group_colors<span class=\"punctuation\">[</span>xdata<span class=\"operator\">$</span>sample_group<span class=\"punctuation\">]</span></span><br><span class=\"line\">pcSummary <span class=\"operator\">&lt;-</span> summary<span class=\"punctuation\">(</span>pc<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">png<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;xcms_25.png&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot<span class=\"punctuation\">(</span>pc<span class=\"operator\">$</span>x<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> pc<span class=\"operator\">$</span>x<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> pch <span class=\"operator\">=</span> <span class=\"number\">21</span><span class=\"punctuation\">,</span> main <span class=\"operator\">=</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span> xlab <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;PC1: &quot;</span><span class=\"punctuation\">,</span> format<span class=\"punctuation\">(</span>pcSummary<span class=\"operator\">$</span>importance<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span> <span class=\"operator\">*</span> <span class=\"number\">100</span><span class=\"punctuation\">,</span> digits <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot; % variance&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> ylab <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;PC2: &quot;</span><span class=\"punctuation\">,</span> format<span class=\"punctuation\">(</span>pcSummary<span class=\"operator\">$</span>importance<span class=\"punctuation\">[</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">]</span> <span class=\"operator\">*</span> <span class=\"number\">100</span><span class=\"punctuation\">,</span> digits <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot; % variance&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> <span class=\"string\">&quot;darkgrey&quot;</span><span class=\"punctuation\">,</span> bg <span class=\"operator\">=</span> cols<span class=\"punctuation\">,</span> cex <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">grid<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">text<span class=\"punctuation\">(</span>pc<span class=\"operator\">$</span>x<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> pc<span class=\"operator\">$</span>x<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span> labels <span class=\"operator\">=</span> xdata<span class=\"operator\">$</span>sample_name<span class=\"punctuation\">,</span> col <span class=\"operator\">=</span> <span class=\"string\">&quot;darkgrey&quot;</span><span class=\"punctuation\">,</span> pos <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span> cex <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_25.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/xcms_25.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"PCA for the faahKO data set, un-normalized intensities\"></p>\n<p> 我们可以在PC2上看到KO和WT样品之间的预期分离。在PC1上样本根据其ID进行分离，ID&lt;&#x3D;18的样本与ID&gt;18的样本被分开。这种分离可能是由于技术偏差（例如，在不同的天&#x2F;周进行的测量）或由于所分析小鼠的生物学特性（性别、年龄、产仔等）造成的。</p>\n<h1 id=\"Further-data-processing-and-analysis\"><a href=\"#Further-data-processing-and-analysis\" class=\"headerlink\" title=\"Further data processing and analysis\"></a>Further data processing and analysis</h1><p>标准化特征的信号强度是必需的，但目前xcms还不支持（在不久的将来可能会添加一些方法）。建议将<code>quantify</code>方法返回的<code>SummarizedExperiment</code>用于任何进一步的数据处理，因为这种类型的对象在同一对象中存储特征定义（feature definitions）、样本注释以及特征丰度。为了识别例如具有显著不同强度&#x2F;丰度的特征，建议使用其他R包中提供的功能，例如Bioconductor的<code>limma</code>包。为了支持依赖于旧<code>xcmsSet</code>结果对象的其他包，可以使用<code>xset &lt;- as(x, &quot;xcmsSet&quot;)</code>将新的<code>XCMSnExp</code>对象强制转换为<code>xcmsSet</code>对象，其中x是<code>XCMSnExp</code>对象。</p>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://127.0.0.1:24676/library/xcms/doc/xcms.html\">LCMS data preprocessing and analysis with xcms</a></li>\n</ul>\n<p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，转载请注明出处请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"代谢组","path":"api/tags/代谢组.json"}]},{"title":"代谢组相关软件的安装及使用","slug":"代谢组相关软件的安装及使用","date":"2023-02-02T05:42:14.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/代谢组相关软件的安装及使用.json","excerpt":null,"keywords":null,"cover":"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<h1 id=\"软件安装\"><a href=\"#软件安装\" class=\"headerlink\" title=\"软件安装\"></a>软件安装</h1><h2 id=\"MZconvert\"><a href=\"#MZconvert\" class=\"headerlink\" title=\"MZconvert\"></a><a href=\"http://www.proteowizard.org/download.html\">MZconvert</a></h2><p>下载ProteoWizard项目下的Linux native 64-bit，上传至服务器并解压缩 (会将所有文件解压至当前目录，建议提前单独建一个目录)，解压后的文件即为可执行程序，需将该目录写入环境变量。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar jxvf pwiz-bin-linux-x86_64-gcc7-release-3_0_23032_0cc4840.tar.bz2</span><br></pre></td></tr></table></figure>\n\n<p><strong>注</strong>：在运行<code>msconvert</code>时，如果遇到报错<code>terminate called after throwing an instance of &#39;std::runtime_error&#39;</code>，<code>what():  locale::facet::_S_create_c_locale name not valid</code>，则在终端里运行命令<code>export LC_ALL=C</code>（去除所有本地化的设置，让命令能正确执行），为了永远生效，可将此命令写入环境变量。</p>\n<h2 id=\"MS-DIAL\"><a href=\"#MS-DIAL\" class=\"headerlink\" title=\"MS-DIAL\"></a><a href=\"http://prime.psc.riken.jp/compms/msdial/main.html\">MS-DIAL</a></h2><p>下载Linux最新版，解压后将路径添加至环境变量即可，有可能需要为主程序（MsdialConsoleApp）添加可执行权限（chmod +x MsdialConsoleApp）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget -c http://prime.psc.riken.jp/compms/msdial/download/repository/Linux/MSDIAL%20ver.4.9.221218%20Linuxx64.zip</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"代谢组","path":"api/tags/代谢组.json"}]},{"title":"多种方法批量下载NCBI基因组","slug":"多种方法批量下载NCBI基因组","date":"2022-07-10T02:04:23.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/多种方法批量下载NCBI基因组.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_1.png","content":"<h1 id=\"下载有summary的基因组\"><a href=\"#下载有summary的基因组\" class=\"headerlink\" title=\"下载有summary的基因组\"></a>下载有summary的基因组</h1><ul>\n<li><p>在NCBI基因组数据库搜索物种</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"搜索物种\"></p>\n</li>\n<li><p>下载元数据</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"下载TSV元数据\"></p>\n</li>\n<li><p>获取下载链接<br>打开下载的元数据文件<code>prokaryotes.csv</code>（该文件也可以直接去NCBI FTP中下载，一般在各物种的目录下，名字为<code>assembly_summary.txt</code>，其格式与<code>prokaryotes.csv</code>略有不同，但都含有链接），将倒数第二列或最后一列的链接拷贝到TXT文本文档中，在每一行的最后加上要下载的文件名和数据类型：</p>\n<ul>\n<li>基因组：文件名 _genomic.fna.gz</li>\n<li>蛋白序列：文件名 _protein.faa.gz</li>\n<li>CDs序列：文件名 _cds_from_genomic.fna.gz </li>\n<li>…</li>\n</ul>\n<p>可参考下图中的示例进行命名：<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_2.5.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_2.5.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"NCBI文件命名示例\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"获取下载链接\"></p>\n<p>建议用正则表达式替换（依赖EditPlus或其他具有正则表达式功能的文本编辑器），以基因组序列为例：</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_4.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_4.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"正则表达式批量替换获取基因组下载链接\"><br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_5.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_5.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"替换后获得的基因组完整下载链接\"></p>\n</li>\n<li><p>开始下载<br>将获得的完整链接保存到名字为<code>link.txt</code>的文本文档中，在LINUX终端中运行<code>for link in $(cat link.txt); do wget -c $link; done</code>即可批量下载基因组到<code>genome</code>目录中。若不慎在行末引入了看不见的换行符，可以用命令<code>perl -pe &#39;s/[\\n\\r]+//g&#39; link.txt &gt; link2.txt</code>进行删除。再用<code>for link in $(cat link2.txt); do wget -c $link; done</code>下载。</p>\n</li>\n</ul>\n<h1 id=\"SRA数据下载\"><a href=\"#SRA数据下载\" class=\"headerlink\" title=\"SRA数据下载\"></a>SRA数据下载</h1><ul>\n<li><p>下载<a href=\"https://github.com/ncbi/sra-tools/wiki/01.-Downloading-SRA-Toolkit\">SRA Toolkit</a></p>\n<p>根据自己的系统选择合适的版本进行下载，并将软件包中<code>bin</code>的绝对路径或相对路径加入到环境变量中，以便可以在终端中直接调用。</p>\n</li>\n<li><p>设置默认下载目录</p>\n<p>如果不设置，默认会将基因组下载到家目录下，通过在终端里输入<code>vdb-config -i</code>命令配置下载目录，即下载到当前目录下。</p>\n<p> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_6.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_6.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"设置SRA Toolkit默认下载文件存放位置\"></p>\n<p>  <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_7.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_7.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"设置SRA Toolkit默认下载文件存放位置\"></p>\n</li>\n<li><p>准备包含<code>SRA号</code>的列表文件，每一行含有一个编号，文件命名为<code>SRA.list</code>。</p>\n</li>\n<li><p>开始下载<br>将列表文件与脚本<code>downloadSRA.pl</code>放在同一目录下，在终端中运行<code>perl downloadSRA.pl</code>。</p>\n</li>\n</ul>\n<h1 id=\"利用FTP软件根据物种下载基因组\"><a href=\"#利用FTP软件根据物种下载基因组\" class=\"headerlink\" title=\"利用FTP软件根据物种下载基因组\"></a>利用FTP软件根据物种下载基因组</h1><p> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_8.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_8.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"通过FileZilla批量下载基因组\"><br> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_9.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/213_9.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"通过FileZilla批量下载基因组\"><br>    在右侧的列表中选中所有目录拖拽到本地即可开始下载。</p>\n<h1 id=\"根据WGA-assession-number下载基因组\"><a href=\"#根据WGA-assession-number下载基因组\" class=\"headerlink\" title=\"根据WGA assession number下载基因组\"></a>根据WGA assession number下载基因组</h1><ul>\n<li><p>安装<a href=\"https://github.com/kblin/ncbi-genome-download\">ncbi-genome-download</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">conda install -c bioconda ncbi-genome-download</span><br></pre></td></tr></table></figure></li>\n<li><p>准备WGA assession number列表文件</p>\n</li>\n<li><p>开始下载<br>终端里输入如下命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ncbi-genome-download --assembly-accessions GCA.txt --output-folder 6_3 bacteria --section genbank --formats fasta</span><br></pre></td></tr></table></figure>\n<p>其中<code>GCA.txt</code>为包含assession number的列表文件，每行一个assession number。<br>该软件的问题在于，需要<code>科学上网</code>，所以很多时候会掉链子。</p>\n</li>\n</ul>\n<h1 id=\"代码获取\"><a href=\"#代码获取\" class=\"headerlink\" title=\"代码获取\"></a>代码获取</h1><p>关注公众号“生信之巅”，聊天窗口回复“213”获取下载链接。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"NCBI","path":"api/tags/NCBI.json"},{"name":"下载","path":"api/tags/下载.json"}]},{"title":"利用PGCGAP根据ids提取序列信息","slug":"利用PGCGAP根据ids提取序列信息","date":"2022-04-15T13:57:11.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/利用PGCGAP根据ids提取序列信息.json","excerpt":null,"keywords":null,"cover":"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","content":"<h1 id=\"使用场景\"><a href=\"#使用场景\" class=\"headerlink\" title=\"使用场景\"></a>使用场景</h1><p>假设有一个fasta格式的序列文件<code>SRR9620252.faa</code>，我们想要提取其中的一些序列到一个新的文件中，我们拥有这些序列的id （假设这些id存放在文件<code>ids.txt</code>中）。常规操作的话，可以复制id，在fasta文件中打开搜索，粘贴id，点击查找，复制找到的序列，粘贴到新的文件中（假设为<code>Seqout.fasta</code>）。假如你只找一条序列，1 min之内可以完成，假如你要找100条序列，1 h可能没了。而用PGCGAP可以在1 min之内完成，剩下的59 min可以喝喝茶。</p>\n<h1 id=\"使用方法\"><a href=\"#使用方法\" class=\"headerlink\" title=\"使用方法\"></a>使用方法</h1><h2 id=\"PGCGAP安装\"><a href=\"#PGCGAP安装\" class=\"headerlink\" title=\"PGCGAP安装\"></a>PGCGAP安装</h2><p>参考<a href=\"https://liaochenlanruo.fun/pgcgap/\">官网</a>，需要版本v1.0.35及以上。</p>\n<h2 id=\"开始提取\"><a href=\"#开始提取\" class=\"headerlink\" title=\"开始提取\"></a>开始提取</h2><p>在终端里打开PGCGAP的conda安装环境，并运行如下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># ids.txt中含有要提取序列的id，可以是一列或者多列，如果为多列，需要用空格或者制表符来分隔列与列，id本身是不能带空格的。</span><br><span class=\"line\"></span><br><span class=\"line\">pgcgap --ACC --id2seq --ids ids.txt --seqin SRR9620252.faa --seqout Seqout.fasta</span><br></pre></td></tr></table></figure>\n\n<p>提取的文件保存在<code>Seqout.fasta</code>中。</p>\n<h1 id=\"引用\"><a href=\"#引用\" class=\"headerlink\" title=\"引用\"></a>引用</h1><p>Liu H, Xin B, Zheng J, Zhong H, Yu Y, Peng D, Sun M. Build a bioinformatics analysis platform and apply it to routine analysis of microbial genomics and comparative genomics. Protocol exchange, 2022. DOI: 10.21203&#x2F;rs.2.21224&#x2F;v6</p>\n<h1 id=\"示例获取\"><a href=\"#示例获取\" class=\"headerlink\" title=\"示例获取\"></a>示例获取</h1><p>关注公众号“生信之巅”，聊天窗口回复“e6ae”获取下载链接。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用PGCGAP，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite PGCGAP. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"序列处理","path":"api/tags/序列处理.json"}]}]}