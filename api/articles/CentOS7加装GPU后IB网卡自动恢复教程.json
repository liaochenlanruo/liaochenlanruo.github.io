{"title":"加装 GPU 后 IB 网卡（ib0）消失？CentOS 7.9 自动恢复教程（亲测有效）","slug":"CentOS7加装GPU后IB网卡自动恢复教程","date":"2025-12-16T10:18:18.000Z","updated":"2025-12-16T10:36:01.929Z","comments":true,"path":"api/articles/CentOS7加装GPU后IB网卡自动恢复教程.json","excerpt":null,"covers":null,"content":"<p>在集群运维中，IB（InfiniBand）网卡是高速数据传输的核心，但很多人遇到过这样的坑：给服务器加装 GPU 扩展卡后，原本正常的 ib0 设备突然消失，无法通过 IB 交换机与其他节点通信。本文结合实际案例，详细拆解问题根源，提供一步到位的自动修复方案，让 ib0 开机即启，无需手动干预。</p>\n<h1 id=\"一、问题背景\"><a href=\"#一、问题背景\" class=\"headerlink\" title=\"一、问题背景\"></a>一、问题背景</h1><ul>\n<li><p><strong>环境</strong>：CentOS 7 服务器（node1），搭载 Mellanox ConnectX 系列双模网卡（支持 IB&#x2F;ETH 模式），原本已配置 IB 模式（ib0 设备），与其他节点通过 IB 交换机实现 20.20.20.0&#x2F;24 网段高速通信。</p>\n</li>\n<li><p><strong>触发条件</strong>：为提升算力加装 GPU 扩展卡后，执行 <code>ip link show ib0</code> 提示 “Device ‘ib0’ does not exist”，IB 网卡失效。</p>\n</li>\n<li><p><strong>核心需求</strong>：恢复 ib0 设备，保持 IB 网段（20.20.20.0&#x2F;24）连通性，实现开机自动配置，不影响 GPU 正常工作。</p>\n</li>\n</ul>\n<h1 id=\"二、问题根源深度解析\"><a href=\"#二、问题根源深度解析\" class=\"headerlink\" title=\"二、问题根源深度解析\"></a>二、问题根源深度解析</h1><p>加装 GPU 后 IB 网卡失效，并非硬件损坏，而是<strong>多重连锁问题</strong>导致：</p>\n<ol>\n<li><p><strong>PCIe 资源冲突</strong>：GPU 占用大量 PCIe 通道，可能触发 BIOS 重置 PCIe 配置，或导致 IB 网卡的 PCIe 资源被占用，驱动加载异常。</p>\n</li>\n<li><p><strong>MLX_OFED 驱动冲突</strong>：服务器原本依赖 Mellanox 官方 OFED 驱动实现 IB 功能，加装 GPU 后，系统原生 RDMA 模块（rdma_cm&#x2F;rdma_ucm）与 OFED 驱动冲突，导致 openibd 服务启动失败（状态码 3&#x2F;NOTIMPLEMENTED），无法初始化 IB 设备。</p>\n</li>\n<li><p><strong>IB 模块未自动加载</strong>：openibd 服务失效后，MLX5 IB 核心模块（mlx5_ib）、IB 协议模块（ib_ipoib 等）无法开机自动加载，IB 网卡虽被识别但未生成 ib0 设备。</p>\n</li>\n</ol>\n<h1 id=\"三、解决方案：systemd-服务实现-ib0-自动初始化\"><a href=\"#三、解决方案：systemd-服务实现-ib0-自动初始化\" class=\"headerlink\" title=\"三、解决方案：systemd 服务实现 ib0 自动初始化\"></a>三、解决方案：systemd 服务实现 ib0 自动初始化</h1><p>无需修复复杂的驱动冲突，也不用手动执行命令，通过创建 systemd 服务，实现 “加载模块→创建 ib0→配置 IP” 全流程自动化，重启后依然生效。</p>\n<h2 id=\"步骤-1：创建-systemd-服务文件\"><a href=\"#步骤-1：创建-systemd-服务文件\" class=\"headerlink\" title=\"步骤 1：创建 systemd 服务文件\"></a>步骤 1：创建 systemd 服务文件</h2><p>创建<code>ib0-init.service</code>服务，适配 CentOS 7 老版本语法，避免参数报错：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/systemd/system/ib0-init.service</span><br></pre></td></tr></table></figure>\n\n<p>粘贴以下内容（核心兼容老版本 iproute2，无<code>parent</code>参数）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Initialize IB0 device (CentOS 7 iproute2 compatible)</span><br><span class=\"line\">After=network.target  # 确保网络服务启动后再执行</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=oneshot  # 一次性执行，执行完保持状态</span><br><span class=\"line\"># 核心命令：加载IB模块→创建ib0→启用设备→配置20网段IP</span><br><span class=\"line\">ExecStart=/bin/bash -c &quot;modprobe mlx5_ib; modprobe ib_core; modprobe ib_cm; modprobe ib_ipoib; ip link add ib0 type ipoib; ip link set ib0 up; ip addr add 20.20.20.109/24 dev ib0&quot;</span><br><span class=\"line\"># 停止命令：删除ib0→卸载模块（可选）</span><br><span class=\"line\">ExecStop=/bin/bash -c &quot;ip link delete ib0; modprobe -r ib_ipoib ib_cm ib_core mlx5_ib&quot;</span><br><span class=\"line\">RemainAfterExit=yes  # 执行完后保持服务活跃状态</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target  # 多用户模式下生效</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>说明：<code>20.20.20.101/24</code> 需替换为你的 IB 网段 IP（与其他节点保持同网段）；若集群 IB 分区使用 PKEY（如 0x8001），可在<code>ip link add ib0 type ipoib</code>后添加<code>pkey 0x8001</code>。</li>\n</ul>\n<h2 id=\"步骤-2：启用并启动服务\"><a href=\"#步骤-2：启用并启动服务\" class=\"headerlink\" title=\"步骤 2：启用并启动服务\"></a>步骤 2：启用并启动服务</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 重新加载systemd配置，让新服务生效</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置开机自启（关键！重启后自动执行）</span><br><span class=\"line\">sudo systemctl enable ib0-init.service</span><br><span class=\"line\"></span><br><span class=\"line\"># 立即启动服务，无需重启</span><br><span class=\"line\">sudo systemctl start ib0-init.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"步骤-3：验证-ib0-是否创建成功\"><a href=\"#步骤-3：验证-ib0-是否创建成功\" class=\"headerlink\" title=\"步骤 3：验证 ib0 是否创建成功\"></a>步骤 3：验证 ib0 是否创建成功</h2><p>执行以下命令，确认配置生效：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1. 检查ib0设备是否存在（状态UP为正常）</span><br><span class=\"line\">ip link show ib0</span><br><span class=\"line\"># 预期输出：</span><br><span class=\"line\"># 4: ib0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 4096 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">#    link/ib 00:00:00:00:00:00:00:00 brd 00:00:00:00:00:00:00:00</span><br><span class=\"line\"></span><br><span class=\"line\"># 2. 检查IB网段IP是否配置成功</span><br><span class=\"line\">ip addr show ib0 | grep 20.20.20.</span><br><span class=\"line\"># 预期输出：inet 20.20.20.101/24 scope global ib0</span><br><span class=\"line\"></span><br><span class=\"line\"># 3. 测试与其他IB节点的连通性（如node2的20.20.20.107）</span><br><span class=\"line\">ping 20.20.20.107 -c 3</span><br><span class=\"line\"># 输出“3 packets transmitted, 3 received”即为连通正常</span><br><span class=\"line\"></span><br><span class=\"line\"># 4. 验证NFS等依赖IB的服务（若有）</span><br><span class=\"line\">sudo mount -a</span><br><span class=\"line\">df -h /share  # 确认IB网段NFS挂载正常</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"步骤-4：重启验证永久生效\"><a href=\"#步骤-4：重启验证永久生效\" class=\"headerlink\" title=\"步骤 4：重启验证永久生效\"></a>步骤 4：重启验证永久生效</h2><p>为确保重启后不失效，执行重启测试：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo reboot</span><br></pre></td></tr></table></figure>\n\n<p>重启后再次执行<code>ip link show ib0</code>和<code>ping ``20.20.20.101</code>，若 ib0 存在且连通正常，说明服务配置成功。</p>\n<h1 id=\"四、关键补充：避坑指南\"><a href=\"#四、关键补充：避坑指南\" class=\"headerlink\" title=\"四、关键补充：避坑指南\"></a>四、关键补充：避坑指南</h1><ol>\n<li><p><strong>模块加载顺序不能乱</strong>：必须先加载<code>mlx5_ib</code>（MLX5 网卡专用 IB 模块），再加载<code>ib_core</code>等协议模块，否则会导致设备创建失败。</p>\n</li>\n<li><p><strong>若 ib0 仍未创建</strong>：</p>\n</li>\n</ol>\n<ul>\n<li><p>执行<code>ibv_devinfo</code>检查物理 IB 设备是否存在（如 mlx5_0），若无输出，需重新安装 Mellanox OFED 驱动（兼容 GPU 驱动版本）。</p>\n</li>\n<li><p>排查 IB 线缆是否插紧、IB 交换机对应端口是否启用（物理链路中断也会导致 ib0 创建失败）。</p>\n</li>\n</ul>\n<ol>\n<li><p><strong>GPU 与 IB 网卡资源冲突</strong>：若重启后 GPU 失效，需进入 BIOS 调整 PCIe 通道分配，将 IB 网卡和 GPU 分配到不同的 PCIe 根复合体，避免资源竞争。</p>\n</li>\n<li><p><strong>兜底方案</strong>：若 IB 模式始终无法恢复，可沿用以太网转发方案（无需 ib0）：</p>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;20.20.20.0/24 via 10.20.0.1 dev eno1 metric 200&quot; &gt;&gt; /etc/sysconfig/network-scripts/route-eno1</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl restart network</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"五、总结\"><a href=\"#五、总结\" class=\"headerlink\" title=\"五、总结\"></a>五、总结</h1><p>加装 GPU 后 IB 网卡失效的核心是 “驱动冲突 + 模块未自动加载”，通过 systemd 服务可完美解决：无需修改 BIOS、不卸载 GPU 驱动，仅需 3 步配置，即可实现 ib0 开机自动创建、IP 自动配置，恢复 IB 高速传输功能。</p>\n<p>该方案已在生产环境验证，适配 CentOS 7 所有版本，兼容 Mellanox ConnectX-4&#x2F;5&#x2F;6 系列网卡。如果遇到类似问题，欢迎留言交流，分享你的排查经验！</p>\n","more":"<p>在集群运维中，IB（InfiniBand）网卡是高速数据传输的核心，但很多人遇到过这样的坑：给服务器加装 GPU 扩展卡后，原本正常的 ib0 设备突然消失，无法通过 IB 交换机与其他节点通信。本文结合实际案例，详细拆解问题根源，提供一步到位的自动修复方案，让 ib0 开机即启，无需手动干预。</p>\n<h1 id=\"一、问题背景\"><a href=\"#一、问题背景\" class=\"headerlink\" title=\"一、问题背景\"></a>一、问题背景</h1><ul>\n<li><p><strong>环境</strong>：CentOS 7 服务器（node1），搭载 Mellanox ConnectX 系列双模网卡（支持 IB&#x2F;ETH 模式），原本已配置 IB 模式（ib0 设备），与其他节点通过 IB 交换机实现 20.20.20.0&#x2F;24 网段高速通信。</p>\n</li>\n<li><p><strong>触发条件</strong>：为提升算力加装 GPU 扩展卡后，执行 <code>ip link show ib0</code> 提示 “Device ‘ib0’ does not exist”，IB 网卡失效。</p>\n</li>\n<li><p><strong>核心需求</strong>：恢复 ib0 设备，保持 IB 网段（20.20.20.0&#x2F;24）连通性，实现开机自动配置，不影响 GPU 正常工作。</p>\n</li>\n</ul>\n<h1 id=\"二、问题根源深度解析\"><a href=\"#二、问题根源深度解析\" class=\"headerlink\" title=\"二、问题根源深度解析\"></a>二、问题根源深度解析</h1><p>加装 GPU 后 IB 网卡失效，并非硬件损坏，而是<strong>多重连锁问题</strong>导致：</p>\n<ol>\n<li><p><strong>PCIe 资源冲突</strong>：GPU 占用大量 PCIe 通道，可能触发 BIOS 重置 PCIe 配置，或导致 IB 网卡的 PCIe 资源被占用，驱动加载异常。</p>\n</li>\n<li><p><strong>MLX_OFED 驱动冲突</strong>：服务器原本依赖 Mellanox 官方 OFED 驱动实现 IB 功能，加装 GPU 后，系统原生 RDMA 模块（rdma_cm&#x2F;rdma_ucm）与 OFED 驱动冲突，导致 openibd 服务启动失败（状态码 3&#x2F;NOTIMPLEMENTED），无法初始化 IB 设备。</p>\n</li>\n<li><p><strong>IB 模块未自动加载</strong>：openibd 服务失效后，MLX5 IB 核心模块（mlx5_ib）、IB 协议模块（ib_ipoib 等）无法开机自动加载，IB 网卡虽被识别但未生成 ib0 设备。</p>\n</li>\n</ol>\n<h1 id=\"三、解决方案：systemd-服务实现-ib0-自动初始化\"><a href=\"#三、解决方案：systemd-服务实现-ib0-自动初始化\" class=\"headerlink\" title=\"三、解决方案：systemd 服务实现 ib0 自动初始化\"></a>三、解决方案：systemd 服务实现 ib0 自动初始化</h1><p>无需修复复杂的驱动冲突，也不用手动执行命令，通过创建 systemd 服务，实现 “加载模块→创建 ib0→配置 IP” 全流程自动化，重启后依然生效。</p>\n<h2 id=\"步骤-1：创建-systemd-服务文件\"><a href=\"#步骤-1：创建-systemd-服务文件\" class=\"headerlink\" title=\"步骤 1：创建 systemd 服务文件\"></a>步骤 1：创建 systemd 服务文件</h2><p>创建<code>ib0-init.service</code>服务，适配 CentOS 7 老版本语法，避免参数报错：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/systemd/system/ib0-init.service</span><br></pre></td></tr></table></figure>\n\n<p>粘贴以下内容（核心兼容老版本 iproute2，无<code>parent</code>参数）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Initialize IB0 device (CentOS 7 iproute2 compatible)</span><br><span class=\"line\">After=network.target  # 确保网络服务启动后再执行</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=oneshot  # 一次性执行，执行完保持状态</span><br><span class=\"line\"># 核心命令：加载IB模块→创建ib0→启用设备→配置20网段IP</span><br><span class=\"line\">ExecStart=/bin/bash -c &quot;modprobe mlx5_ib; modprobe ib_core; modprobe ib_cm; modprobe ib_ipoib; ip link add ib0 type ipoib; ip link set ib0 up; ip addr add 20.20.20.109/24 dev ib0&quot;</span><br><span class=\"line\"># 停止命令：删除ib0→卸载模块（可选）</span><br><span class=\"line\">ExecStop=/bin/bash -c &quot;ip link delete ib0; modprobe -r ib_ipoib ib_cm ib_core mlx5_ib&quot;</span><br><span class=\"line\">RemainAfterExit=yes  # 执行完后保持服务活跃状态</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target  # 多用户模式下生效</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>说明：<code>20.20.20.101/24</code> 需替换为你的 IB 网段 IP（与其他节点保持同网段）；若集群 IB 分区使用 PKEY（如 0x8001），可在<code>ip link add ib0 type ipoib</code>后添加<code>pkey 0x8001</code>。</li>\n</ul>\n<h2 id=\"步骤-2：启用并启动服务\"><a href=\"#步骤-2：启用并启动服务\" class=\"headerlink\" title=\"步骤 2：启用并启动服务\"></a>步骤 2：启用并启动服务</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 重新加载systemd配置，让新服务生效</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\"></span><br><span class=\"line\"># 设置开机自启（关键！重启后自动执行）</span><br><span class=\"line\">sudo systemctl enable ib0-init.service</span><br><span class=\"line\"></span><br><span class=\"line\"># 立即启动服务，无需重启</span><br><span class=\"line\">sudo systemctl start ib0-init.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"步骤-3：验证-ib0-是否创建成功\"><a href=\"#步骤-3：验证-ib0-是否创建成功\" class=\"headerlink\" title=\"步骤 3：验证 ib0 是否创建成功\"></a>步骤 3：验证 ib0 是否创建成功</h2><p>执行以下命令，确认配置生效：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1. 检查ib0设备是否存在（状态UP为正常）</span><br><span class=\"line\">ip link show ib0</span><br><span class=\"line\"># 预期输出：</span><br><span class=\"line\"># 4: ib0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 4096 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">#    link/ib 00:00:00:00:00:00:00:00 brd 00:00:00:00:00:00:00:00</span><br><span class=\"line\"></span><br><span class=\"line\"># 2. 检查IB网段IP是否配置成功</span><br><span class=\"line\">ip addr show ib0 | grep 20.20.20.</span><br><span class=\"line\"># 预期输出：inet 20.20.20.101/24 scope global ib0</span><br><span class=\"line\"></span><br><span class=\"line\"># 3. 测试与其他IB节点的连通性（如node2的20.20.20.107）</span><br><span class=\"line\">ping 20.20.20.107 -c 3</span><br><span class=\"line\"># 输出“3 packets transmitted, 3 received”即为连通正常</span><br><span class=\"line\"></span><br><span class=\"line\"># 4. 验证NFS等依赖IB的服务（若有）</span><br><span class=\"line\">sudo mount -a</span><br><span class=\"line\">df -h /share  # 确认IB网段NFS挂载正常</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"步骤-4：重启验证永久生效\"><a href=\"#步骤-4：重启验证永久生效\" class=\"headerlink\" title=\"步骤 4：重启验证永久生效\"></a>步骤 4：重启验证永久生效</h2><p>为确保重启后不失效，执行重启测试：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo reboot</span><br></pre></td></tr></table></figure>\n\n<p>重启后再次执行<code>ip link show ib0</code>和<code>ping ``20.20.20.101</code>，若 ib0 存在且连通正常，说明服务配置成功。</p>\n<h1 id=\"四、关键补充：避坑指南\"><a href=\"#四、关键补充：避坑指南\" class=\"headerlink\" title=\"四、关键补充：避坑指南\"></a>四、关键补充：避坑指南</h1><ol>\n<li><p><strong>模块加载顺序不能乱</strong>：必须先加载<code>mlx5_ib</code>（MLX5 网卡专用 IB 模块），再加载<code>ib_core</code>等协议模块，否则会导致设备创建失败。</p>\n</li>\n<li><p><strong>若 ib0 仍未创建</strong>：</p>\n</li>\n</ol>\n<ul>\n<li><p>执行<code>ibv_devinfo</code>检查物理 IB 设备是否存在（如 mlx5_0），若无输出，需重新安装 Mellanox OFED 驱动（兼容 GPU 驱动版本）。</p>\n</li>\n<li><p>排查 IB 线缆是否插紧、IB 交换机对应端口是否启用（物理链路中断也会导致 ib0 创建失败）。</p>\n</li>\n</ul>\n<ol>\n<li><p><strong>GPU 与 IB 网卡资源冲突</strong>：若重启后 GPU 失效，需进入 BIOS 调整 PCIe 通道分配，将 IB 网卡和 GPU 分配到不同的 PCIe 根复合体，避免资源竞争。</p>\n</li>\n<li><p><strong>兜底方案</strong>：若 IB 模式始终无法恢复，可沿用以太网转发方案（无需 ib0）：</p>\n</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;20.20.20.0/24 via 10.20.0.1 dev eno1 metric 200&quot; &gt;&gt; /etc/sysconfig/network-scripts/route-eno1</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl restart network</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"五、总结\"><a href=\"#五、总结\" class=\"headerlink\" title=\"五、总结\"></a>五、总结</h1><p>加装 GPU 后 IB 网卡失效的核心是 “驱动冲突 + 模块未自动加载”，通过 systemd 服务可完美解决：无需修改 BIOS、不卸载 GPU 驱动，仅需 3 步配置，即可实现 ib0 开机自动创建、IP 自动配置，恢复 IB 高速传输功能。</p>\n<p>该方案已在生产环境验证，适配 CentOS 7 所有版本，兼容 Mellanox ConnectX-4&#x2F;5&#x2F;6 系列网卡。如果遇到类似问题，欢迎留言交流，分享你的排查经验！</p>\n","categories":[{"name":"IT","path":"api/categories/IT.json"}],"tags":[{"name":"Linux","path":"api/tags/Linux.json"},{"name":"系统","path":"api/tags/系统.json"}]}