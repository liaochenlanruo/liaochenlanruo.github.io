{"title":"Use microeco分析扩增子数据","slug":"Use_microeco分析扩增子数据","date":"2021-03-14T07:01:45.000Z","updated":"2024-03-11T13:07:17.336Z","comments":true,"path":"api/articles/Use_microeco分析扩增子数据.json","excerpt":"本文阐述使用microeco分析扩增子数据……","covers":["#/images/lujia/show_15_taxa_at_Class_level.jpg","#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg","#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg","#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg","#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg","#/images/lujia/betaNRI_all.jpg","#/images/lujia/betaNRI_individual.jpg"],"content":"<p>本文阐述使用microeco分析扩增子数据……</p>\n<span id=\"more\"></span>\n\n<h1 id=\"1-安装microeco\"><a href=\"#1-安装microeco\" class=\"headerlink\" title=\"1. 安装microeco\"></a><font color=#FF0000 >1. 安装microeco</font></h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># If devtools package is not installed, first install it</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then install microeco</span></span><br><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;ChiLiubio/microeco&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"operator\">!</span>requireNamespace<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">,</span> quietly <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span>install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;jbisanz/qiime2R&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-准备数据\"><a href=\"#2-准备数据\" class=\"headerlink\" title=\"2. 准备数据\"></a><font color=#FF0000 >2. 准备数据</font></h1><h2 id=\"otu-table\"><a href=\"#otu-table\" class=\"headerlink\" title=\"otu_table\"></a><font color=#FF9800 >otu_table</font></h2><p>OTU表</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Sample 1</th>\n<th>Sample 2</th>\n<th>Sample 3</th>\n<th>Sample 4</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OTU1</td>\n<td>232.0</td>\n<td>209.0</td>\n<td>349.0</td>\n<td>256.0</td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>75.0</td>\n<td>35.0</td>\n<td>44.0</td>\n<td>0.0</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>237.0</td>\n<td>224.0</td>\n<td>291.0</td>\n<td>353.0</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>371.0</td>\n<td>80.0</td>\n<td>319.0</td>\n<td>345.0</td>\n</tr>\n</tbody></table>\n<h2 id=\"taxonomy-table\"><a href=\"#taxonomy-table\" class=\"headerlink\" title=\"taxonomy_table\"></a><font color=#FF9800 >taxonomy_table</font></h2><p>分类表</p>\n<div style=\"overflow-x:auto;\">\n<table>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Kingdom</th>\n<th>Phylum</th>\n<th>Class</th>\n<th>Order</th>\n<th>Family</th>\n<th>Genus</th>\n<th>Species</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OTU1</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Desulfobacteria</td>\n<td>o__Desulfatiglandales</td>\n<td>f__Desulfatiglandaceae</td>\n<td>g__Desulfatiglans</td>\n<td></td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>d__Bacteria</td>\n<td>p__Sva0485</td>\n<td>c__Sva0485</td>\n<td>o__Sva0485</td>\n<td>f__Sva0485</td>\n<td>g__Sva0485</td>\n<td>s__uncultured_hydrocarbon</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Syntrophobacteria</td>\n<td>o__Syntrophobacterales</td>\n<td>f__uncultured</td>\n<td>g__uncultured</td>\n<td>s__uncultured_delta</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>d__Bacteria</td>\n<td>p__Myxococcota</td>\n<td>c__Polyangia</td>\n<td>o__Polyangiales</td>\n<td>f__Sandaracinaceae</td>\n<td>g__uncultured</td>\n<td></td>\n</tr>\n</tbody></table>\n</table>\n</div>\n\n<h2 id=\"sample-info\"><a href=\"#sample-info\" class=\"headerlink\" title=\"sample_info\"></a><font color=#FF9800 >sample_info</font></h2><p>样本元数据</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Group</th>\n<th>Type</th>\n<th>Saline</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Sample 1</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>G2</td>\n<td>T1</td>\n<td>Saline</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>G2</td>\n<td>T2</td>\n<td>Saline</td>\n</tr>\n</tbody></table>\n<h2 id=\"env-data\"><a href=\"#env-data\" class=\"headerlink\" title=\"env_data\"></a><font color=#FF9800 >env_data</font></h2><p>环境因子</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Depth</th>\n<th>Longitude</th>\n<th>Latitude</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Sample 1</td>\n<td>0</td>\n<td>23.0</td>\n<td>20</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>10</td>\n<td>35.0</td>\n<td>44.0</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>20</td>\n<td>43.0</td>\n<td>70.0</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>30</td>\n<td>60.0</td>\n<td>69.0</td>\n</tr>\n</tbody></table>\n<h2 id=\"phylo-tree\"><a href=\"#phylo-tree\" class=\"headerlink\" title=\"phylo_tree\"></a><font color=#FF9800 >phylo_tree</font></h2><p>进化树</p>\n<h1 id=\"3-导入数据\"><a href=\"#3-导入数据\" class=\"headerlink\" title=\"3. 导入数据\"></a><font color=#FF0000 >3. 导入数据</font></h1><ul>\n<li><p>加载R包</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>microeco<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ape<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>qiime2R<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use pipe operator in magrittr package</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>magrittr<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># set.seed is used to fix the random number generation to make the results repeatable</span></span><br><span class=\"line\">set.seed<span class=\"punctuation\">(</span><span class=\"number\">123</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># make the plotting background same with the tutorial</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">theme_set<span class=\"punctuation\">(</span>theme_bw<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>导入数据</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 单独导入环境因子文件</span></span><br><span class=\"line\">env_data <span class=\"operator\">&lt;-</span> read.delim<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/Ordination_analyses/env4.txt&quot;</span><span class=\"punctuation\">,</span> sep <span class=\"operator\">=</span> <span class=\"string\">&quot;\\t&quot;</span><span class=\"punctuation\">,</span> header <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> row.names <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义数据导入函数</span></span><br><span class=\"line\">qiimed2meco <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>ASV_data<span class=\"punctuation\">,</span> sample_data<span class=\"punctuation\">,</span> taxonomy_data<span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\"># Read ASV data</span></span><br><span class=\"line\">\tASV <span class=\"operator\">&lt;-</span> as.data.frame<span class=\"punctuation\">(</span>read_qza<span class=\"punctuation\">(</span>ASV_data<span class=\"punctuation\">)</span><span class=\"operator\">$</span>data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\">#  Read metadata</span></span><br><span class=\"line\">\tmetadata <span class=\"operator\">&lt;-</span> read_q2metadata<span class=\"punctuation\">(</span>sample_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\trownames<span class=\"punctuation\">(</span>metadata<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>metadata<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\"># Read taxonomy table</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">&lt;-</span> read_qza<span class=\"punctuation\">(</span>taxonomy_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">&lt;-</span> parse_taxonomy<span class=\"punctuation\">(</span>taxa_table<span class=\"operator\">$</span>data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\"># Make the taxonomic table clean, this is very important.</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">%&lt;&gt;%</span> tidy_taxonomy</span><br><span class=\"line\">\t<span class=\"comment\"># Read phylo tree</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.null</span><span class=\"punctuation\">(</span>phylo_tree<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\tphylo_tree <span class=\"operator\">&lt;-</span> read_qza<span class=\"punctuation\">(</span>phylo_tree<span class=\"punctuation\">)</span><span class=\"operator\">$</span>data</span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\tdataset <span class=\"operator\">&lt;-</span> microtable<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>sample_table <span class=\"operator\">=</span> metadata<span class=\"punctuation\">,</span> tax_table <span class=\"operator\">=</span> taxa_table<span class=\"punctuation\">,</span> otu_table <span class=\"operator\">=</span> ASV<span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> phylo_tree<span class=\"punctuation\">)</span></span><br><span class=\"line\">\tdataset</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入本地数据，包括OTU表、样本元数据、分类表、tree文件。这几个文件均有QIIME2生成。</span></span><br><span class=\"line\">meco_dataset <span class=\"operator\">&lt;-</span> qiimed2meco<span class=\"punctuation\">(</span>ASV_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/dada2_table.qza&quot;</span><span class=\"punctuation\">,</span> sample_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/metadata.tsv&quot;</span><span class=\"punctuation\">,</span> taxonomy_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/taxonomy.qza&quot;</span><span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/tree.qza&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"4-数据预处理\"><a href=\"#4-数据预处理\" class=\"headerlink\" title=\"4. 数据预处理\"></a><font color=#FF0000 >4. 数据预处理</font></h1><ul>\n<li><p>移除未被分配到 “k__Archaea” 或 “k__Bacteria”的OTUs</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>tax_table <span class=\"operator\">%&lt;&gt;%</span> base<span class=\"operator\">::</span>subset<span class=\"punctuation\">(</span>Kingdom <span class=\"operator\">==</span> <span class=\"string\">&quot;k__Archaea&quot;</span> <span class=\"operator\">|</span> Kingdom <span class=\"operator\">==</span> <span class=\"string\">&quot;k__Bacteria&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>移除注释为线粒体和叶绿体的OTUs</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 移除tax_table中包含taxa名字的行，无论分类等级（taxonomic ranks），不区分大小写字母。简言之，taxa = c(&quot;mitochondria&quot;, &quot;chloroplast&quot;)定义了删除包含mitochondria和chloroplast的行。</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>filter_pollution<span class=\"punctuation\">(</span>taxa <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;mitochondria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;chloroplast&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为了使otu_table、tax_table和phylo_tree中的OTUs相同，我们再次使用tidy_dataset() 函数</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>tidy_dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用sample_sums()检查各样本中的序列数量</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>sample_sums<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">range</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>有时，为了减少物种数目对多样性度量的影响，我们需要进行重采样，使每个样本中的序列数量相等。函数rarefy_samples可以在稀疏（rarefying）前后自动调用函数tidy_dataset。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># As an example, we use 20001 sequences in each sample</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>rarefy_samples<span class=\"punctuation\">(</span>sample.size <span class=\"operator\">=</span> <span class=\"number\">20001</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>sample_sums<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">range</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"5-alpha多样性\"><a href=\"#5-alpha多样性\" class=\"headerlink\" title=\"5. alpha多样性\"></a><font color=#FF0000 >5. alpha多样性</font></h1><ul>\n<li><p>然后，我们使用cal_abund()计算每个分类等级的分类单元丰度（taxa abundance）。此函数返回一个名为taxa_abund的列表，其中包含每个分类等级上的丰度信息的多个数据框。列表自动存储在microtable object中。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_abund<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return dataset$taxa_abund</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>taxa_abund<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>通过save_abund()将taxa abundance保存至本地文件</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;taxa_abund&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_abund<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;taxa_abund&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>计算alpha多样性。结果自动存储在microtable object中。<font color=#2196F3>作为示例，此处未计算系统发育多样性（phylogenetic diversity）</font>。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 若要计算Faith&#x27;s phylogenetic diversity，设置PD = TRUE，计算速度会较慢</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_alphadiv<span class=\"punctuation\">(</span>PD <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return dataset$alpha_diversity</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>alpha_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save dataset$alpha_diversity to a directory</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;alpha_diversity&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_alphadiv<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;alpha_diversity&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"6-β多样性\"><a href=\"#6-β多样性\" class=\"headerlink\" title=\"6. β多样性\"></a><font color=#FF0000 >6. β多样性</font></h1><ul>\n<li><p>利用函数cal_betadiv()计算beta-多样性的距离矩阵。我们提供了四个最常用的索引：Bray-curtis、Jaccard、加权Unifrac和未加权Unifrac。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># If you do not want to calculate unifrac metrics, use unifrac = FALSE</span></span><br><span class=\"line\"><span class=\"comment\"># 需要GUniFrac package</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;GUniFrac&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_betadiv<span class=\"punctuation\">(</span>unifrac <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return dataset$beta_diversity</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save dataset$beta_diversity to a directory</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;beta_diversity&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_betadiv<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;beta_diversity&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"7-trans-abund-class\"><a href=\"#7-trans-abund-class\" class=\"headerlink\" title=\"7. trans_abund class\"></a><font color=#FF0000 >7. trans_abund class</font></h1><ul>\n<li><p>绘制Barplot。转换分类丰度数据，以便使用ggplot2包绘制分类单元丰度。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># create trans_abund object</span></span><br><span class=\"line\"><span class=\"comment\"># use 12 Phyla with the highest abundance in the dataset.</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1 object now include the transformed abundance data t1$abund_data and other elements for the following plotting</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制Barplot. We remove the sample names in x axis and add the facet to show abundance according to groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>others_color <span class=\"operator\">=</span> <span class=\"string\">&quot;grey70&quot;</span><span class=\"punctuation\">,</span> facet <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> xtext_keep <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return a ggplot2 object</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取组内平均值。The groupmean parameter can be used to obtain the group-mean barplot.</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span> groupmean <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>others_color <span class=\"operator\">=</span> <span class=\"string\">&quot;grey70&quot;</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then alluvial plot is implemented in the plot_bar function.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;ggalluvial&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use_alluvium = TRUE make the alluvial plot, clustering =TRUE can be used to reorder the samples by clustering</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>use_alluvium <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> clustering <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> xtext_type_hor <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> xtext_size <span class=\"operator\">=</span> <span class=\"number\">6</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>The box plot is an excellent way to intuitionally show data distribution across groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># show 15 taxa at Class level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Class&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_box<span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/show_15_taxa_at_Class_level.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/show_15_taxa_at_Class_level.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"show 15 taxa at Class level\"></p>\n<ul>\n<li><p>Then we show the heatmap with the high abundant genera.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># show 40 taxa at Genus level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">40</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_heatmap<span class=\"punctuation\">(</span>facet <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> xtext_keep <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> withmargin <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we show the pie chart.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">6</span><span class=\"punctuation\">,</span> groupmean <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># all pie chart in one row</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_pie<span class=\"punctuation\">(</span>facet_nrow <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"8-trans-venn-class\"><a href=\"#8-trans-venn-class\" class=\"headerlink\" title=\"8. trans_venn class\"></a><font color=#FF0000 >8. trans_venn class</font></h1><ul>\n<li><p>The trans_venn class is used for venn analysis. To analyze the unique and shared OTUs of groups, we first merge samples according to the “Group” column of sample_table.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># merge samples as one community for each group</span></span><br><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># dataset1 is a new microtable object</span></span><br><span class=\"line\"><span class=\"comment\"># create trans_venn object</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">,</span> ratio <span class=\"operator\">=</span> <span class=\"string\">&quot;seqratio&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_venn<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># The integer data is OTU number</span></span><br><span class=\"line\"><span class=\"comment\"># The percentage data is the sequence number/total sequence number</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>When the groups are too many to show with venn plot, we can use petal plot.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use &quot;Type&quot; column in sample_table</span></span><br><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_venn<span class=\"punctuation\">(</span>petal_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Sometimes, we are interested in the unique and shared species. In another words, the composition of the unique or shared species may account for the different and similar parts of ecological characteristics across groups[10]. For this goal, we first transform the results of venn plot to the traditional species-sample table, that is, another object of microtable class.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># transform venn results to the sample-species table, here do not consider abundance, only use presence/absence information.</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>trans_venn_com<span class=\"punctuation\">(</span>use_OTUs_frequency <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t2 is a new microtable class, each part is considered as a sample</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>t2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We use bar plot to show the composition at the Genus level.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate taxa abundance, that is, the frequency</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_abund<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># transform and plot</span></span><br><span class=\"line\">t3 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> t2<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t3<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>bar_type <span class=\"operator\">=</span> <span class=\"string\">&quot;part&quot;</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"built_in\">T</span><span class=\"punctuation\">,</span> ylab_title <span class=\"operator\">=</span> <span class=\"string\">&quot;Frequency (%)&quot;</span><span class=\"punctuation\">,</span> xtext_type_hor <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We also try to use pie chart to show the compositions at the Phylum level</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t3 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> t2<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">8</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t3<span class=\"operator\">$</span>plot_pie<span class=\"punctuation\">(</span>facet_nrow <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span> use_colors <span class=\"operator\">=</span> rev<span class=\"punctuation\">(</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span>RColorBrewer<span class=\"operator\">::</span>brewer.pal<span class=\"punctuation\">(</span><span class=\"number\">8</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Dark2&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;grey50&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"9-trans-alpha-class\"><a href=\"#9-trans-alpha-class\" class=\"headerlink\" title=\"9. trans_alpha class\"></a><font color=#FF0000 >9. trans_alpha class</font></h1><ul>\n<li><p>Alpha diversity can be transformed and plotted using trans_alpha class. Creating trans_alpha object can return two data frame: alpha_data and alpha_stat.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_alpha<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$alpha_stat</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>alpha_stat<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we test the differences among groups using the KW rank sum test and anova with multiple comparisons.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_diff<span class=\"punctuation\">(</span>method <span class=\"operator\">=</span> <span class=\"string\">&quot;KW&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_alpha_diff</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_alpha_diff<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Groups</th>\n<th>Measure</th>\n<th>Test method</th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>T16 vs T18</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.601895e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>2</td>\n<td>T16 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>3.011399e-08</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3</td>\n<td>T16 vs T21</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.174162e-04</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4</td>\n<td>T16 vs T17</td>\n<td>Observed</td>\n<td>KW</td>\n<td>1.234229e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>5</td>\n<td>T18 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>7.319258e-08</td>\n<td>***</td>\n</tr>\n</tbody></table>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_diff<span class=\"punctuation\">(</span>method <span class=\"operator\">=</span> <span class=\"string\">&quot;anova&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_alpha_diff</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_alpha_diff</span><br></pre></td></tr></table></figure>\n  <div style=\"overflow-x:auto;\">\n  <table>\n\n<table>\n<thead>\n<tr>\n<th>Observed</th>\n<th>Chao1</th>\n<th>ACE</th>\n<th>Shannon</th>\n<th>Simpson</th>\n<th>InvSimpson</th>\n<th>Fisher</th>\n<th>Coverage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>T18</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n</tr>\n<tr>\n<td>T16</td>\n<td>b</td>\n<td>b</td>\n<td>b</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>b</td>\n</tr>\n<tr>\n<td>T17</td>\n<td>c</td>\n<td>c</td>\n<td>c</td>\n<td>b</td>\n<td>a</td>\n<td>b</td>\n<td>c</td>\n</tr>\n<tr>\n<td>T21</td>\n<td>d</td>\n<td>d</td>\n<td>d</td>\n<td>c</td>\n<td>a</td>\n<td>c</td>\n<td>d</td>\n</tr>\n<tr>\n<td>T20</td>\n<td>e</td>\n<td>e</td>\n<td>e</td>\n<td>d</td>\n<td>b</td>\n<td>d</td>\n<td>e</td>\n</tr>\n<tr>\n<td></table></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></div></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n</li>\n<li><p>Now, let us plot the mean and se of alpha diversity for each group, and add the duncan.test (agricolae package) result.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_alpha<span class=\"punctuation\">(</span>add_letter <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;Chao1&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We can also use the boxplot to show the paired comparisons directly.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_alpha<span class=\"punctuation\">(</span>pair_compare <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;Chao1&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"10-trans-beta-class\"><a href=\"#10-trans-beta-class\" class=\"headerlink\" title=\"10. trans_beta class\"></a><font color=#FF0000 >10. trans_beta class</font></h1><ul>\n<li><p>The distance matrix of beta diversity can be transformed and plotted using trans_beta class. The analysis referred to the beta diversity in this class mainly include ordination, group distance, clustering and manova. We first show the ordination using PCoA.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># we first create an object and select PCoA for ordination</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">,</span> ordination <span class=\"operator\">=</span> <span class=\"string\">&quot;PCoA&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_ordination is the ordination result list</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>t1<span class=\"operator\">$</span>res_ordination<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># plot the PCoA result</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_ordination<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> plot_shape <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> plot_group_ellipse <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then we plot and compare the group distances.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate and plot sample distances within groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_group_distance</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># calculate and plot sample distances between groups (报错：错误: Insufficient values in manual scale. 10 needed but only 8 provided.)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span>within_group <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Clustering plot is also a frequently used method.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use replace_name to set the label name, group parameter used to set the color (报错：找不到对象&#x27;dataset&#x27;)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_clustering<span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> <span class=\"string\">&quot;Indexs&quot;</span><span class=\"punctuation\">,</span> replace_name <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;Water-depth(m)&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Indexs&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>perMANOVA is often used in the differential test of distances among groups.</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># manova for all groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_all <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova<span class=\"operator\">$</span>aov.tab</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Permutation: free</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Number of permutations: 999</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Terms added sequentially (first to last)</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(&gt;F)</td>\n</tr>\n<tr>\n<td>Site</td>\n<td>4</td>\n<td>15.669</td>\n<td>3.9173</td>\n<td>19.445</td>\n<td>0.48077</td>\n<td>0.001 ***</td>\n</tr>\n<tr>\n<td>Residuals</td>\n<td>84</td>\n<td>16.923</td>\n<td>0.2015</td>\n<td></td>\n<td>0.51923</td>\n<td></td>\n</tr>\n<tr>\n<td>Total</td>\n<td>88</td>\n<td>32.592</td>\n<td></td>\n<td></td>\n<td>1.00000</td>\n<td></td>\n</tr>\n</tbody></table>\n<p> &gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</p>\n</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># manova for each paired groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_paired <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Groups</th>\n<th>measure</th>\n<th>permutations</th>\n<th>R<sup>2</sup></th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>T16 vs T18</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2748773</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>2</td>\n<td>T16 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4539103</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>3</td>\n<td>T16 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4102009</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>4</td>\n<td>T16 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2243404</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>5</td>\n<td>T18 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3736482</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>6</td>\n<td>T18 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3504104</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>7</td>\n<td>T18 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2147055</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>8</td>\n<td>T20 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3575765</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>9</td>\n<td>T20 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4589248</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>10</td>\n<td>T21 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4395176</td>\n<td>0.001</td>\n</tr>\n</tbody></table>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\"># manova for specified group set: here &quot;Group + Type&quot;</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_set <span class=\"operator\">=</span> <span class=\"string\">&quot;Site+ Indexs&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova<span class=\"operator\">$</span>aov.tab</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Permutation: free</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Number of permutations: 999</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Terms added sequentially (first to last)</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(F)</td>\n</tr>\n<tr>\n<td>Site</td>\n<td>4</td>\n<td>15.669</td>\n<td>4</td>\n<td>0</td>\n<td>0.48077</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Indexs</td>\n<td>84</td>\n<td>16.923</td>\n<td>0</td>\n<td>0</td>\n<td>0.51923</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Residuals</td>\n<td>0</td>\n<td>0.000</td>\n<td>Inf</td>\n<td></td>\n<td>0.00000</td>\n<td></td>\n</tr>\n<tr>\n<td>Total</td>\n<td>88</td>\n<td>32.592</td>\n<td></td>\n<td></td>\n<td>1.00000</td>\n<td></td>\n</tr>\n</tbody></table>\n<h1 id=\"11-trans-diff-class\"><a href=\"#11-trans-diff-class\" class=\"headerlink\" title=\"11. trans_diff class\"></a><font color=#FF0000 >11. trans_diff class</font></h1><ul>\n<li><p>Differential abundance test is a very important part in the microbial community data analysis. It can be used to find the significant taxa in determining the community differences across groups. Currently, trans_diff class have three famous approaches to perform this analysis: metastat[11], LEfSe[12] and random forest. Metastat depends on the permutations and t-test and performs well on the sparse data. It is used for the comparisons between two groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># metastat analysis at Genus level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;metastat&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> metastat_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_metastat is the result</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_metastat_group_matrix is the group comparisons order for plotting</span></span><br><span class=\"line\"><span class=\"comment\"># plot the first paired groups, choose_group = 1</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_metastat<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> qvalue <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> choose_group <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>LEfSe combines the non-parametric test and linear discriminant analysis. We implement this approach in this package instead of the python version.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;lefse&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> alpha <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> lefse_subgroup <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_lefse is the LEfSe result</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_abund is the abundance information</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_bar<span class=\"punctuation\">(</span>LDA_score <span class=\"operator\">=</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We can also plot the abundance of taxa detected using LEfSe.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_diff_abund<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we show the cladogram of the differential features in the taxonomic tree. There are too many taxa in this dataset. As an example, we only use the highest 200 abundant taxa in the tree and 50 differential features. We only show the full taxonomic label at Phylum level and use letters at other levels to reduce the text overlap.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># clade_label_level 5 represent phylum level in this analysis</span></span><br><span class=\"line\"><span class=\"comment\"># require ggtree package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_cladogram<span class=\"punctuation\">(</span>use_taxa_num <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> use_feature_num <span class=\"operator\">=</span> <span class=\"number\">50</span><span class=\"punctuation\">,</span> clade_label_level <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>There may be a problem related with the taxonomic labels in the plot. When the levels used are too many, the taxonomic labels may have too much overlap. However, if we only indicate the Phylum labels, the taxa in the legend with marked letters are too many. At this time, you can select the taxa that you want to show in the plot manually like the following operation.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># choose some taxa according to the positions in the previous picture; those taxa labels have minimum overlap</span></span><br><span class=\"line\">use_labels <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;c__Deltaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Actinobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Rhizobiales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Proteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Bacteroidetes&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t<span class=\"string\">&quot;o__Micrococcales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Acidobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Verrucomicrobia&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Firmicutes&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t<span class=\"string\">&quot;p__Chloroflexi&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Acidobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Gammaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Betaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__KD4-96&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;c__Bacilli&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Gemmatimonadales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;f__Gemmatimonadaceae&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Bacillales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Rhodobacterales&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then use parameter select_show_labels to show</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_cladogram<span class=\"punctuation\">(</span>use_taxa_num <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> use_feature_num <span class=\"operator\">=</span> <span class=\"number\">50</span><span class=\"punctuation\">,</span> select_show_labels <span class=\"operator\">=</span> use_labels<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># Now we can see that more taxa names appear in the tree</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>If you are interested in taxonomic tree, you can also use metacoder package[13] to plot the taxonomic tree based on the selected taxa. We do not show the usage here.</p>\n</li>\n<li><p>The third approach is rf, which depends on the random forest[14, 15] and the non-parametric test. The current method can calculate random forest by bootstrapping like the method in LEfSe and only use the significant features. MeanDecreaseGini is selected as the indicator value in the analysis.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use Genus level for parameter rf_taxa_level, if you want to use all taxa, change to &quot;all&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># nresam = 1 and boots = 1 represent no bootstrapping and use all samples directly</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;rf&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> rf_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rf is the result stored in the object</span></span><br><span class=\"line\"><span class=\"comment\"># plot the result</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>plot_diff_abund<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">20</span><span class=\"punctuation\">,</span> only_abund_plot <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">gridExtra<span class=\"operator\">::</span>grid.arrange<span class=\"punctuation\">(</span>t2<span class=\"operator\">$</span>p1<span class=\"punctuation\">,</span> t2<span class=\"operator\">$</span>p2<span class=\"punctuation\">,</span> ncol<span class=\"operator\">=</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> nrow <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> widths <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># the middle asterisk represent the significances</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"12-trans-env-class\"><a href=\"#12-trans-env-class\" class=\"headerlink\" title=\"12. trans_env class\"></a><font color=#FF0000 >12. trans_env class</font></h1><ul>\n<li><p>分析环境因子对微生物群落结构和组装的影响：RDA分析(db-RDA和RDA).</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># add_data is used to add the environmental data</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use bray-curtis distance to do dbrda</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rda<span class=\"punctuation\">(</span>use_dbrda <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> use_measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda is the result list stored in the object</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>trans_rda<span class=\"punctuation\">(</span>adjust_arrow_length <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> max_perc_env <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda_trans is the transformed result for plotting</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_rda<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use Genus</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rda<span class=\"punctuation\">(</span>use_dbrda <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># As the main results of RDA are related with the projection and angles between different arrows,</span></span><br><span class=\"line\"><span class=\"comment\"># we adjust the length of the arrow to show them clearly using several parameters.</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>trans_rda<span class=\"punctuation\">(</span>show_taxa <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span> adjust_arrow_length <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> max_perc_env <span class=\"operator\">=</span> <span class=\"number\">1500</span><span class=\"punctuation\">,</span> max_perc_tax <span class=\"operator\">=</span> <span class=\"number\">3000</span><span class=\"punctuation\">,</span> min_perc_env <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> min_perc_tax <span class=\"operator\">=</span> <span class=\"number\">300</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda_trans is the transformed result for plotting</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_rda<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Mantel test 用于检测环境因子和距离矩阵之间是否具有显著的相关性。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_mantel<span class=\"punctuation\">(</span>use_measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_mantel</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_mantel</span><br></pre></td></tr></table></figure>\n\n  <div style=\"overflow-x:auto;\">\n  <table>\n  \n<table>\n<thead>\n<tr>\n<th></th>\n<th>variable_name</th>\n<th>cor_method</th>\n<th>corr_res</th>\n<th>p_res</th>\n<th>significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td><strong>TN</strong></td>\n<td>pearson</td>\n<td>0.5571885</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>2</td>\n<td><strong>TC</strong></td>\n<td>pearson</td>\n<td>0.5712239</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3</td>\n<td><strong>TS</strong></td>\n<td>pearson</td>\n<td>0.2665453</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4</td>\n<td><strong>TOC</strong></td>\n<td>pearson</td>\n<td>0.3540337</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>5</td>\n<td><strong>Salinity</strong></td>\n<td>pearson</td>\n<td>0.2782537</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Temperature</td>\n<td>pearson</td>\n<td>0.5856050</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>7</td>\n<td><strong>Dissolved.oxygen</strong></td>\n<td>pearson</td>\n<td>0.4358422</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>8</td>\n<td>Surface.chlorophyll.concentrations</td>\n<td>pearson</td>\n<td>0.2586823</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>9</td>\n<td>pH</td>\n<td>pearson</td>\n<td>0.4498964</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>10</td>\n<td><strong>PAR</strong></td>\n<td>pearson</td>\n<td>0.1712861</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>11</td>\n<td>Density</td>\n<td>pearson</td>\n<td>0.5682679</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>12</td>\n<td>Turbidity</td>\n<td>pearson</td>\n<td>0.2260436</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td></table></div></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n</li>\n<li><p>环境变量与分类群（taxa）的相关性对分析和推断影响群落结构的因素具有重要意义。在本例中，我们首先进行了差异丰度检验（differential abundance test）和随机森林分析（random forest），得到了重要的属（Genus）。然后利用这些分类单元进行相关性分析。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># first create trans_diff object</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;rf&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> rf_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then create trans_env object</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate correlation</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>use_data <span class=\"operator\">=</span> <span class=\"string\">&quot;other&quot;</span><span class=\"punctuation\">,</span> p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;fdr&quot;</span><span class=\"punctuation\">,</span> other_taxa <span class=\"operator\">=</span> t2<span class=\"operator\">$</span>res_rf<span class=\"operator\">$</span>Taxa<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">60</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用ggplot2或pheatmap进行可视化</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># default ggplot2 method</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># clustering heatmap; require pheatmap package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span>pheatmap <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"7个环境变量与分类群ggplot2\"></p>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"7个环境变量与分类群相关性_pheatmap\"></p>\n<ul>\n<li><p>各组内的环境变量与分类群taxa之间的关系</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate correlations for different groups using parameter by_group</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>by_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> use_data <span class=\"operator\">=</span> <span class=\"string\">&quot;other&quot;</span><span class=\"punctuation\">,</span> p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;fdr&quot;</span><span class=\"punctuation\">,</span> other_taxa <span class=\"operator\">=</span> t2<span class=\"operator\">$</span>res_rf<span class=\"operator\">$</span>Taxa<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">60</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"correlations_between_environmental_variables_and_60_taxa\"></p>\n<ul>\n<li><p>环境因子与alpha-多样性之间的关系</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use add_abund_table parameter to add the extra data table</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>add_abund_table <span class=\"operator\">=</span> meco_dataset<span class=\"operator\">$</span>alpha_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"relationship_between_7_environmental_factors_and_alpha_diversity\"></p>\n<h1 id=\"13-trans-nullmodel-class\"><a href=\"#13-trans-nullmodel-class\" class=\"headerlink\" title=\"13. trans_nullmodel class\"></a><font color=#FF0000 >13. trans_nullmodel class</font></h1><ul>\n<li><p>近几十年来，系统发育分析和空模型（null model）的结合，通过增加系统发育维度（phylogeny dimension），更加有力地促进了生态位和中性（niche and neutral）对群落组装影响的推断[16，17]。trans_nullmodel class提供了一个封装，包括对系统发育信号、beta平均成对系统发育距离（beta mean pairwise phylogenetic distance，betaMPD）、beta平均最近分类单元距离（beta mean nearest taxon distance，betaMNTD）、beta最近分类单元指数（beta nearest taxon index，betaNTI）、beta净相关指数（beta net relatedness index，betaNRI）和基于Bray-Curtis的Raup-Crick（Bray-Curtis-based Raup-Crick，RCbray）的计算。系统发育信号分析的方法基于mantel相关图（mantel correlogram）[18]，与其他方法相比，系统发育信号的变化是直观而清晰的。betaMNTD和betaMPD的算法已经过优化，比picante包中的算法更快[3]。RCbray和betaNTI（或betaNRI）之间的组合可用于推断在特定假设下支配群落装配（community assembly）的每个生态过程（ecological process）的强度[17]。这可以通过函数cal_process()来解析每个推断进程（ecological process）的百分比来实现。<font color=#2196F3 ><strong>我们首先检查系统发育信号：</strong></font></p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># generate trans_nullmodel object; use 10000 OTUs as example</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_nullmodel<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">,</span> taxa_number <span class=\"operator\">=</span> <span class=\"number\">10000</span><span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use TOC as the test variable (__报错：Error in cor(as.vector(xdis), ydis, method = method, use = use) : </span></span><br><span class=\"line\">  cov<span class=\"operator\">/</span>cor中有遗漏值__<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_mantel_corr<span class=\"punctuation\">(</span>use_env <span class=\"operator\">=</span> <span class=\"string\">&quot;TOC&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_mantel_corr</span></span><br><span class=\"line\"><span class=\"comment\"># plot the mantel correlogram(__报错：Error in names(x) &lt;- value : &#x27;names&#x27;属性的长度[4]必需和矢量的长度[0]一样__)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_mantel_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>betaNRI（ses.betampd）用于显示“basal”系统发育转换（phylogenetic turnover）[18]。与betaNTI相比，它能捕获更多与深层系统发育（deep phylogeny）相关的转换信息（turnover information）。值得注意的是，经过几十年的发展，出现了许多空模型（null models）。在trans-nullmodel class中，我们随机化了物种的系统发育相关性。这种洗牌方法（shuffling approach）固定了观察到的物种α-多样性和β-多样性的水平，以探讨观察到的系统发育转换是否与空模型（物种间的系统发育关系是随机的）显著不同。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行500次null model</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_ses_betampd<span class=\"punctuation\">(</span>runs<span class=\"operator\">=</span><span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 返回t1$res_ses_betampd</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>可以使用trans_beta class中的plot_group_distance function绘制betaNRI图。结果表明T20和T21的平均betaNRI 显著高于其它三者，表明T20和T21中的basal phylogenetic turnover是高的。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将betaNRI矩阵加入到beta_diversity列表中</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_ses_betampd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用measure &quot;betaNRI&quot;创建trans_beta class</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transform the distance for each group</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果可视化</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_all.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/betaNRI_all.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"betaNRI all\"></p>\n<ul>\n<li><p>若要单独的对每个组进行 null model analysis，例如每个组作为一个物种池（species pool），我们可以分别为每个组计算结果。 我们发现，当分别对每个组进行betaNRI 分析时，CW和TW间的mean betaNRI没有显著差异，且二者均显著高于IW ，揭示了在将每个区域视为特定物种库的条件下，CW和TW中变量选择的强度（strength of variable selection）可能相似。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个列表用于存放trans_nullmodel的结果</span></span><br><span class=\"line\">sesbeta_each <span class=\"operator\">&lt;-</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">group_col <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;Site&quot;</span></span><br><span class=\"line\">all_groups <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>sample_table<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> group_col<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对每个组分别进行计算</span></span><br><span class=\"line\"><span class=\"keyword\">for</span><span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> all_groups<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\"># like the above operation, but need provide &#x27;group&#x27; and &#x27;select_group&#x27;</span></span><br><span class=\"line\">\ttest <span class=\"operator\">&lt;-</span> trans_nullmodel<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> group_col<span class=\"punctuation\">,</span> select_group <span class=\"operator\">=</span> i<span class=\"punctuation\">,</span> taxa_number <span class=\"operator\">=</span> <span class=\"number\">1000</span><span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\ttest<span class=\"operator\">$</span>cal_ses_betampd<span class=\"punctuation\">(</span>runs <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">\tsesbeta_each<span class=\"punctuation\">[[</span>i<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> test<span class=\"operator\">$</span>res_ses_betampd</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 合并结果并重塑（reshape），得到一个对称矩阵（symmetrical matrix）</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>reshape2<span class=\"punctuation\">)</span></span><br><span class=\"line\">test <span class=\"operator\">&lt;-</span> lapply<span class=\"punctuation\">(</span>sesbeta_each<span class=\"punctuation\">,</span> melt<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> do.call<span class=\"punctuation\">(</span>rbind<span class=\"punctuation\">,</span> .<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> reshape2<span class=\"operator\">::</span>dcast<span class=\"punctuation\">(</span>.<span class=\"punctuation\">,</span> Var1<span class=\"operator\">~</span>Var2<span class=\"punctuation\">,</span> value.var <span class=\"operator\">=</span> <span class=\"string\">&quot;value&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `row.names&lt;-`<span class=\"punctuation\">(</span>.<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> .<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"operator\">-</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> drop <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如同上述操作</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> test</span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_individual.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/betaNRI_individual.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"betaNRI individual\"></p>\n<ul>\n<li><p>BetaNTI(ses.betamntd) 可用于指示系统发育的末端转换（ phylogenetic terminal turnover） [17]</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行500次null model</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_ses_betamntd<span class=\"punctuation\">(</span>runs<span class=\"operator\">=</span><span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 返回t1$res_ses_betamntd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将betaNTI矩阵加入到beta_diversity列表中</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNTI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_ses_betamntd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用measure &quot;betaNRI&quot;创建trans_beta class</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNTI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transform the distance for each group</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果可视化</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>cal_rcbray()功能用于计算RCbray (Bray-Curtis-based Raup-Crick) ，以评估成分转换（compositional turnover）是否主要受漂移控制[19]。我们应用空模型（null model）通过从每个物种池中随机采样个体来模拟物种分布，同时保留物种发生频率（species occurrence frequency）和样本物种丰富度（sample species richness）[18]。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># result stored in t1$res_rcbray</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rcbray<span class=\"punctuation\">(</span>runs <span class=\"operator\">=</span> <span class=\"number\">1000</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_rcbray</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>作为一个例子，我们还计算了引用文献[17，18]中所示的在群落组装（community assembly）上推断过程（ inferred processes ）所占的比例。在此示例中，具有显着betaNTI值（|βNTI|&gt; 2）的成对比较部分是估计的选择（Selection）造成影响； βNTI&gt; 2代表异构选择（heterogeneous ）； βNTI&lt;-2表示同质选择（homogeneous ）。 RCbray值表征了随机分配（randomization）下观察到的Bray-Curtis和Bray-Curtis期望值之间的偏差大小（magnitude of deviation）。 | RCbray | &gt; 0.95被认为是显着的。 |βNTI| &lt; 2和RCbray &gt; +0.95被视为受散播限制（Dispersal Limitation）与漂移（Drift）相结合的影响。 |βNTI| &lt; 2和RCbray &lt; -0.95被视为均质分散（Homogenizing Dispersal）影响的估计值。 |βNTI| &lt; 2和|RCbray| &lt; 0.95估算了漂移单独作用的影响。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use betaNTI and rcbray to evaluate processes</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_process<span class=\"punctuation\">(</span>use_betamntd <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_process</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_process</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>process</th>\n<th>percentage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>variable selection</td>\n<td>0.4341164</td>\n</tr>\n<tr>\n<td>2</td>\n<td>homogeneous selection</td>\n<td>63.6874362</td>\n</tr>\n<tr>\n<td>3</td>\n<td>dispersal limitation</td>\n<td>0.0000000</td>\n</tr>\n<tr>\n<td>4</td>\n<td>homogeneous dispersal</td>\n<td>14.8365679</td>\n</tr>\n<tr>\n<td>5</td>\n<td>drift</td>\n<td>21.0418795</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n<h1 id=\"14-trans-network-class\"><a href=\"#14-trans-network-class\" class=\"headerlink\" title=\"14. trans_network class\"></a><font color=#FF0000 >14. trans_network class</font></h1><h2 id=\"correlation-based-network\"><a href=\"#correlation-based-network\" class=\"headerlink\" title=\"correlation-based network\"></a><font color=#FF9800 >correlation-based network</font></h2><ul>\n<li>准备R包并进行计算相关性  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;WGCNA&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>WGCNA<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 以下3选1</span></span><br><span class=\"line\"><span class=\"comment\"># 1. Use R base cor.test, slow</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;base&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">,</span> cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor_p list; one table: correlation; another: p value</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. SparCC method, require SpiecEasi package</span></span><br><span class=\"line\"><span class=\"comment\"># SparCC is very slow, so consider filtering more species with low abundance</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;SparCC&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.001</span><span class=\"punctuation\">,</span> SparCC_simu_num <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. When the OTU number is large, use R WGCNA package to replace R base to calculate correlations</span></span><br><span class=\"line\"><span class=\"comment\"># require WGCNA package</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;WGCNA&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">,</span> cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"构建网络\"><a href=\"#构建网络\" class=\"headerlink\" title=\"构建网络\"></a><font color=#FF9800 >构建网络</font></h2><ul>\n<li><p>COR_optimization &#x3D; TRUE represent using RMT theory to find the optimized correlation threshold instead of the COR_cut.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># construct network; require igraph package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network<span class=\"punctuation\">(</span>p_thres <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> COR_optimization <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_network</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (可选) use arbitrary coefficient threshold to contruct network</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network<span class=\"punctuation\">(</span>p_thres <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> COR_cut <span class=\"operator\">=</span> <span class=\"number\">0.73</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save network</span></span><br><span class=\"line\"><span class=\"comment\"># open the gexf file using Gephi(https://gephi.org/)</span></span><br><span class=\"line\"><span class=\"comment\"># require rgexf package</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;rgexf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>save_network<span class=\"punctuation\">(</span>filepath <span class=\"operator\">=</span> <span class=\"string\">&quot;network.gexf&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Now, we show the node colors with the Phylum information and the edges colors with the positive and negative correlations. All the data used has been stored in the network.gexf file, including modules classifications, Phylum information and edges classifications.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate network attributes</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network_attr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_network_attr</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># classify the node; return t1$res_node_type</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_node_type<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_node_type</span></span><br><span class=\"line\"><span class=\"comment\"># we retain the file for the following example in trans_func part</span></span><br><span class=\"line\">network_node_type <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_node_type</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># plot node roles in terms of the within-module connectivity and among-module connectivity</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_taxa_roles<span class=\"punctuation\">(</span>use_type <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># plot node roles with phylum information</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_taxa_roles<span class=\"punctuation\">(</span>use_type <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Now, we show the eigengene analysis of modules. The eigengene of a module, i.e. the first principal component of PCA, represents the main variance of the abundance in the species of the module.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_eigen<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_eigen</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>出错了</strong>！Then we perform correlation heatmap to show the relationships between eigengenes and environmental factors.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># create trans_env object like the above operation</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data_16S<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">4</span><span class=\"operator\">:</span><span class=\"number\">11</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate correlations</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>add_abund_table <span class=\"operator\">=</span> t1<span class=\"operator\">$</span>res_eigen<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># plot the correlation heatmap</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>The function cal_sum_links() is used to sum the links (edge) number from one taxa to another or in the same taxa. The function plot_sum_links() is used to show the result from the function cal_sum_links(). This is very useful to fast see how many nodes are connected between different taxa or within one taxa. In terms of “Phylum” level in the tutorial, the function cal_sum_links() sum the linkages number from one Phylum to another Phylum or the linkages in the same Phylum. So the numbers along the outside of the circular plot represent how many edges or linkages are related with the Phylum. For example, in terms of Proteobacteria, there are roughly total 900 edges associated with the OTUs in Proteobacteria, in which roughly 200 edges connect both OTUs in Proteobacteria and roughly 150 edges connect the OTUs from Proteobacteria with the OTUs from Chloroflexi.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;mattflor/chorddiag&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate the links between or within taxonomic ranks (报错：Error in ecount(network) : 没有&quot;ecount&quot;这个函数)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_sum_links<span class=\"punctuation\">(</span>taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_sum_links_pos and t1$res_sum_links_neg</span></span><br><span class=\"line\"><span class=\"comment\"># require chorddiag package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_sum_links<span class=\"punctuation\">(</span>plot_pos <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> plot_num <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"15-trans-func-class\"><a href=\"#15-trans-func-class\" class=\"headerlink\" title=\"15. trans_func class\"></a><font color=#FF0000 >15. trans_func class</font></h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Identify microbial traits</span></span><br><span class=\"line\"><span class=\"comment\"># create object of trans_func</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_func<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># mapping the taxonomy to the database</span></span><br><span class=\"line\"><span class=\"comment\"># the function can recognize prokaryotes or fungi automatically</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_spe_func<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t2$res_spe_func, 1 represent function exists, 0 represent no or cannot confirmed.</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>The percentages of the OTUs having the same trait can reflect the functional redundancy of this function in the community or the module in the network.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate the percentages of OTUs for each trait in each module of network</span></span><br><span class=\"line\"><span class=\"comment\"># use_community = FALSE represent calculating module, not community, node_type_table provide the module information</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_spe_func_perc<span class=\"punctuation\">(</span>use_community <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> node_type_table <span class=\"operator\">=</span> network_node_type<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t2$res_spe_func_perc</span></span><br><span class=\"line\"><span class=\"comment\"># we only plot some important traits, so we use the default group list to filter and show the traits.</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>plot_spe_func_perc<span class=\"punctuation\">(</span>select_samples <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;M&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># M represents module, ordered by the nodes number from high to low</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Tax4Fun requires a strict input file demand on the taxonomic information. To analyze the trimmed or changed OTU data in R with Tax4Fun, we provide a link to the Tax4Fun functional prediction.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_func<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># install Tax4Fun package and download SILVA123 ref data from  http://tax4fun.gobics.de/</span></span><br><span class=\"line\">wget https<span class=\"operator\">:</span><span class=\"operator\">/</span><span class=\"operator\">/</span>github.com<span class=\"operator\">/</span>bwemheu<span class=\"operator\">/</span>Tax4Fun2<span class=\"operator\">/</span>releases<span class=\"operator\">/</span>download<span class=\"operator\">/</span><span class=\"number\">1.1</span>.5<span class=\"operator\">/</span>Tax4Fun2_1.1.5.tar.gz</span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span>pkgs <span class=\"operator\">=</span> <span class=\"string\">&quot;Tax4Fun2_1.1.5.tar.gz&quot;</span><span class=\"punctuation\">,</span> repos <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">,</span> source <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># decompress SILVA123; provide path in folderReferenceData as you put</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_tax4fun<span class=\"punctuation\">(</span>folderReferenceData <span class=\"operator\">=</span> <span class=\"string\">&quot;./SILVA123&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return two files: t1$tax4fun_KO: KO file; t1$tax4fun_path: pathway file.</span></span><br><span class=\"line\"><span class=\"comment\"># t1$tax4fun_KO$Tax4FunProfile[1:5, 1:2]</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"16-知识点\"><a href=\"#16-知识点\" class=\"headerlink\" title=\"16. 知识点\"></a><font color=#FF0000 >16. 知识点</font></h1><h2 id=\"确定性过程和随机过程\"><a href=\"#确定性过程和随机过程\" class=\"headerlink\" title=\"确定性过程和随机过程\"></a><font color=#FF9800 >确定性过程和随机过程</font></h2><ul>\n<li><p>The term <font color=#2196F3 size=5><b>“deterministic process”</b></font> refers to two types of selective forces, namely, those that lead to either more (i.e. homogeneous selection) or less (i.e. heterogeneous selection) similar structures among communities due to homogeneous and heterogeneous environmental pressures, respectively (Zhou &amp; Ning, 2017).  <font color=#2196F3 size=5><b>确定性过程</b></font>包括两种选择力，即分别导致更加相似（即同质选择）或更少相似（即异质选择）的群落间的结构的同质和异质环境压力。</p>\n</li>\n<li><p>The term<font color=#2196F3 size=5><b> “stochastic process” </b></font>refers to homogenizing dispersal, dispersal limitation (combined with drift) and pure drift, which can obscure the turnover among microbial communities due to high dispersal; low dispersal; and random changes in birth, death and reproduction, respectively (Zhou &amp; Ning, 2017). <font color=#2196F3 size=5><b>随机过程</b></font>是指均匀分散、分散限制（结合漂变）和纯漂变，它们可以通过高度分散、低分散和出生、死亡和繁殖的随机变化来掩盖&#x2F;减弱微生物群落之间的更替。</p>\n</li>\n</ul>\n<p><img src=\"/images/lujia/nullmodel.png\" alt=\"Community assembly processes by Stegen *et al.* https://www.nature.com/articles/ismej201393\n\"></p>\n<ul>\n<li>An NTI of &gt;+2 indicates that the ASVs in a local community are more closely related than expected by chance, suggesting the role of selective pressures (e.g. environmental conditions) in phylogenetic clustering. An NTI of &lt;−2 represents phylogenetic overdispersion, indicating two possible biotic interactions: competition and facilitation. In contrast, a mean NTI across multiple communities that is significantly greater or less than zero indicates phylogenetic clustering or overdispersion, respectively (Zhou &amp; Ning, 2017). NTI &gt;2表明，在一个地方群落中，ASVs的亲缘关系比预期的更为密切，表明选择压力（如环境条件）在系统发育聚类中的作用。NTI &lt;-2表示系统发育过度分散，表明两种可能的生物相互作用：竞争和促进。相反，多个群落间的平均NTI显著大于或小于零，分别表明系统发育聚类或过度分散（Zhou和Ning，2017）。</li>\n<li>βNTI&gt;+2 or &lt;−2 signified heterogeneous selection or homogeneous selection, respectively. βNTI&gt;+2 or &lt;−2 分别指示异质选择和同质选择。</li>\n</ul>\n<h1 id=\"17-参考\"><a href=\"#17-参考\" class=\"headerlink\" title=\"17. 参考\"></a><font color=#FF0000 >17. 参考</font></h1><ul>\n<li><a href=\"https://chiliubio.github.io/microeco/\">https://chiliubio.github.io/microeco/</a></li>\n<li>Zhou, J., &amp; Ning, D. (2017). Stochastic community assembly: Does it matter in microbial ecology? Microbiology and Molecular Biology Reviews, 81(4), e00002–17. <a href=\"https://doi.org/10.1128/MMBR.00002%E2%80%9017\">https://doi.org/10.1128/MMBR.00002‐17</a></li>\n<li><a href=\"http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml\">http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml</a></li>\n</ul>\n","more":"<h1 id=\"1-安装microeco\"><a href=\"#1-安装microeco\" class=\"headerlink\" title=\"1. 安装microeco\"></a><font color=#FF0000 >1. 安装microeco</font></h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># If devtools package is not installed, first install it</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then install microeco</span></span><br><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;ChiLiubio/microeco&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"punctuation\">(</span><span class=\"operator\">!</span>requireNamespace<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">,</span> quietly <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span>install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;devtools&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;jbisanz/qiime2R&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-准备数据\"><a href=\"#2-准备数据\" class=\"headerlink\" title=\"2. 准备数据\"></a><font color=#FF0000 >2. 准备数据</font></h1><h2 id=\"otu-table\"><a href=\"#otu-table\" class=\"headerlink\" title=\"otu_table\"></a><font color=#FF9800 >otu_table</font></h2><p>OTU表</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Sample 1</th>\n<th>Sample 2</th>\n<th>Sample 3</th>\n<th>Sample 4</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OTU1</td>\n<td>232.0</td>\n<td>209.0</td>\n<td>349.0</td>\n<td>256.0</td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>75.0</td>\n<td>35.0</td>\n<td>44.0</td>\n<td>0.0</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>237.0</td>\n<td>224.0</td>\n<td>291.0</td>\n<td>353.0</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>371.0</td>\n<td>80.0</td>\n<td>319.0</td>\n<td>345.0</td>\n</tr>\n</tbody></table>\n<h2 id=\"taxonomy-table\"><a href=\"#taxonomy-table\" class=\"headerlink\" title=\"taxonomy_table\"></a><font color=#FF9800 >taxonomy_table</font></h2><p>分类表</p>\n<div style=\"overflow-x:auto;\">\n<table>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Kingdom</th>\n<th>Phylum</th>\n<th>Class</th>\n<th>Order</th>\n<th>Family</th>\n<th>Genus</th>\n<th>Species</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OTU1</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Desulfobacteria</td>\n<td>o__Desulfatiglandales</td>\n<td>f__Desulfatiglandaceae</td>\n<td>g__Desulfatiglans</td>\n<td></td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>d__Bacteria</td>\n<td>p__Sva0485</td>\n<td>c__Sva0485</td>\n<td>o__Sva0485</td>\n<td>f__Sva0485</td>\n<td>g__Sva0485</td>\n<td>s__uncultured_hydrocarbon</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Syntrophobacteria</td>\n<td>o__Syntrophobacterales</td>\n<td>f__uncultured</td>\n<td>g__uncultured</td>\n<td>s__uncultured_delta</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>d__Bacteria</td>\n<td>p__Myxococcota</td>\n<td>c__Polyangia</td>\n<td>o__Polyangiales</td>\n<td>f__Sandaracinaceae</td>\n<td>g__uncultured</td>\n<td></td>\n</tr>\n</tbody></table>\n</table>\n</div>\n\n<h2 id=\"sample-info\"><a href=\"#sample-info\" class=\"headerlink\" title=\"sample_info\"></a><font color=#FF9800 >sample_info</font></h2><p>样本元数据</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Group</th>\n<th>Type</th>\n<th>Saline</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Sample 1</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>G2</td>\n<td>T1</td>\n<td>Saline</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>G2</td>\n<td>T2</td>\n<td>Saline</td>\n</tr>\n</tbody></table>\n<h2 id=\"env-data\"><a href=\"#env-data\" class=\"headerlink\" title=\"env_data\"></a><font color=#FF9800 >env_data</font></h2><p>环境因子</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Depth</th>\n<th>Longitude</th>\n<th>Latitude</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Sample 1</td>\n<td>0</td>\n<td>23.0</td>\n<td>20</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>10</td>\n<td>35.0</td>\n<td>44.0</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>20</td>\n<td>43.0</td>\n<td>70.0</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>30</td>\n<td>60.0</td>\n<td>69.0</td>\n</tr>\n</tbody></table>\n<h2 id=\"phylo-tree\"><a href=\"#phylo-tree\" class=\"headerlink\" title=\"phylo_tree\"></a><font color=#FF9800 >phylo_tree</font></h2><p>进化树</p>\n<h1 id=\"3-导入数据\"><a href=\"#3-导入数据\" class=\"headerlink\" title=\"3. 导入数据\"></a><font color=#FF0000 >3. 导入数据</font></h1><ul>\n<li><p>加载R包</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>microeco<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ape<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>qiime2R<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use pipe operator in magrittr package</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>magrittr<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># set.seed is used to fix the random number generation to make the results repeatable</span></span><br><span class=\"line\">set.seed<span class=\"punctuation\">(</span><span class=\"number\">123</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># make the plotting background same with the tutorial</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">theme_set<span class=\"punctuation\">(</span>theme_bw<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>导入数据</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 单独导入环境因子文件</span></span><br><span class=\"line\">env_data <span class=\"operator\">&lt;-</span> read.delim<span class=\"punctuation\">(</span><span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/Ordination_analyses/env4.txt&quot;</span><span class=\"punctuation\">,</span> sep <span class=\"operator\">=</span> <span class=\"string\">&quot;\\t&quot;</span><span class=\"punctuation\">,</span> header <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> row.names <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义数据导入函数</span></span><br><span class=\"line\">qiimed2meco <span class=\"operator\">&lt;-</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>ASV_data<span class=\"punctuation\">,</span> sample_data<span class=\"punctuation\">,</span> taxonomy_data<span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\"># Read ASV data</span></span><br><span class=\"line\">\tASV <span class=\"operator\">&lt;-</span> as.data.frame<span class=\"punctuation\">(</span>read_qza<span class=\"punctuation\">(</span>ASV_data<span class=\"punctuation\">)</span><span class=\"operator\">$</span>data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\">#  Read metadata</span></span><br><span class=\"line\">\tmetadata <span class=\"operator\">&lt;-</span> read_q2metadata<span class=\"punctuation\">(</span>sample_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\trownames<span class=\"punctuation\">(</span>metadata<span class=\"punctuation\">)</span> <span class=\"operator\">&lt;-</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>metadata<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\"># Read taxonomy table</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">&lt;-</span> read_qza<span class=\"punctuation\">(</span>taxonomy_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">&lt;-</span> parse_taxonomy<span class=\"punctuation\">(</span>taxa_table<span class=\"operator\">$</span>data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t<span class=\"comment\"># Make the taxonomic table clean, this is very important.</span></span><br><span class=\"line\">\ttaxa_table <span class=\"operator\">%&lt;&gt;%</span> tidy_taxonomy</span><br><span class=\"line\">\t<span class=\"comment\"># Read phylo tree</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.null</span><span class=\"punctuation\">(</span>phylo_tree<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t\tphylo_tree <span class=\"operator\">&lt;-</span> read_qza<span class=\"punctuation\">(</span>phylo_tree<span class=\"punctuation\">)</span><span class=\"operator\">$</span>data</span><br><span class=\"line\">\t<span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">\tdataset <span class=\"operator\">&lt;-</span> microtable<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>sample_table <span class=\"operator\">=</span> metadata<span class=\"punctuation\">,</span> tax_table <span class=\"operator\">=</span> taxa_table<span class=\"punctuation\">,</span> otu_table <span class=\"operator\">=</span> ASV<span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> phylo_tree<span class=\"punctuation\">)</span></span><br><span class=\"line\">\tdataset</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 导入本地数据，包括OTU表、样本元数据、分类表、tree文件。这几个文件均有QIIME2生成。</span></span><br><span class=\"line\">meco_dataset <span class=\"operator\">&lt;-</span> qiimed2meco<span class=\"punctuation\">(</span>ASV_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/dada2_table.qza&quot;</span><span class=\"punctuation\">,</span> sample_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/metadata.tsv&quot;</span><span class=\"punctuation\">,</span> taxonomy_data <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/taxonomy.qza&quot;</span><span class=\"punctuation\">,</span> phylo_tree <span class=\"operator\">=</span> <span class=\"string\">&quot;E:/Researches/lujia16S/Analysis_20200907/tree.qza&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"4-数据预处理\"><a href=\"#4-数据预处理\" class=\"headerlink\" title=\"4. 数据预处理\"></a><font color=#FF0000 >4. 数据预处理</font></h1><ul>\n<li><p>移除未被分配到 “k__Archaea” 或 “k__Bacteria”的OTUs</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>tax_table <span class=\"operator\">%&lt;&gt;%</span> base<span class=\"operator\">::</span>subset<span class=\"punctuation\">(</span>Kingdom <span class=\"operator\">==</span> <span class=\"string\">&quot;k__Archaea&quot;</span> <span class=\"operator\">|</span> Kingdom <span class=\"operator\">==</span> <span class=\"string\">&quot;k__Bacteria&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>移除注释为线粒体和叶绿体的OTUs</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 移除tax_table中包含taxa名字的行，无论分类等级（taxonomic ranks），不区分大小写字母。简言之，taxa = c(&quot;mitochondria&quot;, &quot;chloroplast&quot;)定义了删除包含mitochondria和chloroplast的行。</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>filter_pollution<span class=\"punctuation\">(</span>taxa <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;mitochondria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;chloroplast&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>为了使otu_table、tax_table和phylo_tree中的OTUs相同，我们再次使用tidy_dataset() 函数</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>tidy_dataset<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">print<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用sample_sums()检查各样本中的序列数量</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>sample_sums<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">range</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>有时，为了减少物种数目对多样性度量的影响，我们需要进行重采样，使每个样本中的序列数量相等。函数rarefy_samples可以在稀疏（rarefying）前后自动调用函数tidy_dataset。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># As an example, we use 20001 sequences in each sample</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>rarefy_samples<span class=\"punctuation\">(</span>sample.size <span class=\"operator\">=</span> <span class=\"number\">20001</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>sample_sums<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">range</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"5-alpha多样性\"><a href=\"#5-alpha多样性\" class=\"headerlink\" title=\"5. alpha多样性\"></a><font color=#FF0000 >5. alpha多样性</font></h1><ul>\n<li><p>然后，我们使用cal_abund()计算每个分类等级的分类单元丰度（taxa abundance）。此函数返回一个名为taxa_abund的列表，其中包含每个分类等级上的丰度信息的多个数据框。列表自动存储在microtable object中。</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_abund<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return dataset$taxa_abund</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>taxa_abund<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>通过save_abund()将taxa abundance保存至本地文件</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;taxa_abund&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_abund<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;taxa_abund&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>计算alpha多样性。结果自动存储在microtable object中。<font color=#2196F3>作为示例，此处未计算系统发育多样性（phylogenetic diversity）</font>。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 若要计算Faith&#x27;s phylogenetic diversity，设置PD = TRUE，计算速度会较慢</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_alphadiv<span class=\"punctuation\">(</span>PD <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return dataset$alpha_diversity</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>alpha_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save dataset$alpha_diversity to a directory</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;alpha_diversity&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_alphadiv<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;alpha_diversity&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"6-β多样性\"><a href=\"#6-β多样性\" class=\"headerlink\" title=\"6. β多样性\"></a><font color=#FF0000 >6. β多样性</font></h1><ul>\n<li><p>利用函数cal_betadiv()计算beta-多样性的距离矩阵。我们提供了四个最常用的索引：Bray-curtis、Jaccard、加权Unifrac和未加权Unifrac。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># If you do not want to calculate unifrac metrics, use unifrac = FALSE</span></span><br><span class=\"line\"><span class=\"comment\"># 需要GUniFrac package</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;GUniFrac&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>cal_betadiv<span class=\"punctuation\">(</span>unifrac <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return dataset$beta_diversity</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save dataset$beta_diversity to a directory</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;beta_diversity&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>save_betadiv<span class=\"punctuation\">(</span>dirpath <span class=\"operator\">=</span> <span class=\"string\">&quot;beta_diversity&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"7-trans-abund-class\"><a href=\"#7-trans-abund-class\" class=\"headerlink\" title=\"7. trans_abund class\"></a><font color=#FF0000 >7. trans_abund class</font></h1><ul>\n<li><p>绘制Barplot。转换分类丰度数据，以便使用ggplot2包绘制分类单元丰度。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># create trans_abund object</span></span><br><span class=\"line\"><span class=\"comment\"># use 12 Phyla with the highest abundance in the dataset.</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1 object now include the transformed abundance data t1$abund_data and other elements for the following plotting</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制Barplot. We remove the sample names in x axis and add the facet to show abundance according to groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>others_color <span class=\"operator\">=</span> <span class=\"string\">&quot;grey70&quot;</span><span class=\"punctuation\">,</span> facet <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> xtext_keep <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return a ggplot2 object</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取组内平均值。The groupmean parameter can be used to obtain the group-mean barplot.</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span> groupmean <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>others_color <span class=\"operator\">=</span> <span class=\"string\">&quot;grey70&quot;</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then alluvial plot is implemented in the plot_bar function.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;ggalluvial&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use_alluvium = TRUE make the alluvial plot, clustering =TRUE can be used to reorder the samples by clustering</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>use_alluvium <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> clustering <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> xtext_type_hor <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> xtext_size <span class=\"operator\">=</span> <span class=\"number\">6</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>The box plot is an excellent way to intuitionally show data distribution across groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># show 15 taxa at Class level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Class&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_box<span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/show_15_taxa_at_Class_level.jpg\" alt=\"show 15 taxa at Class level\"></p>\n<ul>\n<li><p>Then we show the heatmap with the high abundant genera.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># show 40 taxa at Genus level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">40</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_heatmap<span class=\"punctuation\">(</span>facet <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> xtext_keep <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> withmargin <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we show the pie chart.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">6</span><span class=\"punctuation\">,</span> groupmean <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># all pie chart in one row</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_pie<span class=\"punctuation\">(</span>facet_nrow <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"8-trans-venn-class\"><a href=\"#8-trans-venn-class\" class=\"headerlink\" title=\"8. trans_venn class\"></a><font color=#FF0000 >8. trans_venn class</font></h1><ul>\n<li><p>The trans_venn class is used for venn analysis. To analyze the unique and shared OTUs of groups, we first merge samples according to the “Group” column of sample_table.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># merge samples as one community for each group</span></span><br><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># dataset1 is a new microtable object</span></span><br><span class=\"line\"><span class=\"comment\"># create trans_venn object</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">,</span> ratio <span class=\"operator\">=</span> <span class=\"string\">&quot;seqratio&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_venn<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># The integer data is OTU number</span></span><br><span class=\"line\"><span class=\"comment\"># The percentage data is the sequence number/total sequence number</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>When the groups are too many to show with venn plot, we can use petal plot.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use &quot;Type&quot; column in sample_table</span></span><br><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_venn<span class=\"punctuation\">(</span>petal_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Sometimes, we are interested in the unique and shared species. In another words, the composition of the unique or shared species may account for the different and similar parts of ecological characteristics across groups[10]. For this goal, we first transform the results of venn plot to the traditional species-sample table, that is, another object of microtable class.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dataset1 <span class=\"operator\">&lt;-</span> meco_dataset<span class=\"operator\">$</span>merge_samples<span class=\"punctuation\">(</span>use_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_venn<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset1<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># transform venn results to the sample-species table, here do not consider abundance, only use presence/absence information.</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>trans_venn_com<span class=\"punctuation\">(</span>use_OTUs_frequency <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t2 is a new microtable class, each part is considered as a sample</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>t2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We use bar plot to show the composition at the Genus level.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate taxa abundance, that is, the frequency</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_abund<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># transform and plot</span></span><br><span class=\"line\">t3 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> t2<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t3<span class=\"operator\">$</span>plot_bar<span class=\"punctuation\">(</span>bar_type <span class=\"operator\">=</span> <span class=\"string\">&quot;part&quot;</span><span class=\"punctuation\">,</span> legend_text_italic <span class=\"operator\">=</span> <span class=\"built_in\">T</span><span class=\"punctuation\">,</span> ylab_title <span class=\"operator\">=</span> <span class=\"string\">&quot;Frequency (%)&quot;</span><span class=\"punctuation\">,</span> xtext_type_hor <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We also try to use pie chart to show the compositions at the Phylum level</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t3 <span class=\"operator\">&lt;-</span> trans_abund<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> t2<span class=\"punctuation\">,</span> taxrank <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">,</span> ntaxa <span class=\"operator\">=</span> <span class=\"number\">8</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t3<span class=\"operator\">$</span>plot_pie<span class=\"punctuation\">(</span>facet_nrow <span class=\"operator\">=</span> <span class=\"number\">3</span><span class=\"punctuation\">,</span> use_colors <span class=\"operator\">=</span> rev<span class=\"punctuation\">(</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span>RColorBrewer<span class=\"operator\">::</span>brewer.pal<span class=\"punctuation\">(</span><span class=\"number\">8</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Dark2&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;grey50&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"9-trans-alpha-class\"><a href=\"#9-trans-alpha-class\" class=\"headerlink\" title=\"9. trans_alpha class\"></a><font color=#FF0000 >9. trans_alpha class</font></h1><ul>\n<li><p>Alpha diversity can be transformed and plotted using trans_alpha class. Creating trans_alpha object can return two data frame: alpha_data and alpha_stat.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_alpha<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$alpha_stat</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>alpha_stat<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we test the differences among groups using the KW rank sum test and anova with multiple comparisons.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_diff<span class=\"punctuation\">(</span>method <span class=\"operator\">=</span> <span class=\"string\">&quot;KW&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_alpha_diff</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_alpha_diff<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">5</span><span class=\"punctuation\">,</span> <span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Groups</th>\n<th>Measure</th>\n<th>Test method</th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>T16 vs T18</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.601895e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>2</td>\n<td>T16 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>3.011399e-08</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3</td>\n<td>T16 vs T21</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.174162e-04</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4</td>\n<td>T16 vs T17</td>\n<td>Observed</td>\n<td>KW</td>\n<td>1.234229e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>5</td>\n<td>T18 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>7.319258e-08</td>\n<td>***</td>\n</tr>\n</tbody></table>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_diff<span class=\"punctuation\">(</span>method <span class=\"operator\">=</span> <span class=\"string\">&quot;anova&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_alpha_diff</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_alpha_diff</span><br></pre></td></tr></table></figure>\n  <div style=\"overflow-x:auto;\">\n  <table>\n\n<table>\n<thead>\n<tr>\n<th>Observed</th>\n<th>Chao1</th>\n<th>ACE</th>\n<th>Shannon</th>\n<th>Simpson</th>\n<th>InvSimpson</th>\n<th>Fisher</th>\n<th>Coverage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>T18</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n</tr>\n<tr>\n<td>T16</td>\n<td>b</td>\n<td>b</td>\n<td>b</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>b</td>\n</tr>\n<tr>\n<td>T17</td>\n<td>c</td>\n<td>c</td>\n<td>c</td>\n<td>b</td>\n<td>a</td>\n<td>b</td>\n<td>c</td>\n</tr>\n<tr>\n<td>T21</td>\n<td>d</td>\n<td>d</td>\n<td>d</td>\n<td>c</td>\n<td>a</td>\n<td>c</td>\n<td>d</td>\n</tr>\n<tr>\n<td>T20</td>\n<td>e</td>\n<td>e</td>\n<td>e</td>\n<td>d</td>\n<td>b</td>\n<td>d</td>\n<td>e</td>\n</tr>\n<tr>\n<td></table></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></div></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n</li>\n<li><p>Now, let us plot the mean and se of alpha diversity for each group, and add the duncan.test (agricolae package) result.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_alpha<span class=\"punctuation\">(</span>add_letter <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;Chao1&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We can also use the boxplot to show the paired comparisons directly.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_alpha<span class=\"punctuation\">(</span>pair_compare <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;Chao1&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"10-trans-beta-class\"><a href=\"#10-trans-beta-class\" class=\"headerlink\" title=\"10. trans_beta class\"></a><font color=#FF0000 >10. trans_beta class</font></h1><ul>\n<li><p>The distance matrix of beta diversity can be transformed and plotted using trans_beta class. The analysis referred to the beta diversity in this class mainly include ordination, group distance, clustering and manova. We first show the ordination using PCoA.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># we first create an object and select PCoA for ordination</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">,</span> ordination <span class=\"operator\">=</span> <span class=\"string\">&quot;PCoA&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_ordination is the ordination result list</span></span><br><span class=\"line\"><span class=\"built_in\">class</span><span class=\"punctuation\">(</span>t1<span class=\"operator\">$</span>res_ordination<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># plot the PCoA result</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_ordination<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> plot_shape <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> plot_group_ellipse <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then we plot and compare the group distances.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate and plot sample distances within groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_group_distance</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># calculate and plot sample distances between groups (报错：错误: Insufficient values in manual scale. 10 needed but only 8 provided.)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span>within_group <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Clustering plot is also a frequently used method.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use replace_name to set the label name, group parameter used to set the color (报错：找不到对象&#x27;dataset&#x27;)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_clustering<span class=\"punctuation\">(</span>group <span class=\"operator\">=</span> <span class=\"string\">&quot;Indexs&quot;</span><span class=\"punctuation\">,</span> replace_name <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;Water-depth(m)&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;Indexs&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>perMANOVA is often used in the differential test of distances among groups.</p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># manova for all groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_all <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova<span class=\"operator\">$</span>aov.tab</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Permutation: free</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Number of permutations: 999</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Terms added sequentially (first to last)</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(&gt;F)</td>\n</tr>\n<tr>\n<td>Site</td>\n<td>4</td>\n<td>15.669</td>\n<td>3.9173</td>\n<td>19.445</td>\n<td>0.48077</td>\n<td>0.001 ***</td>\n</tr>\n<tr>\n<td>Residuals</td>\n<td>84</td>\n<td>16.923</td>\n<td>0.2015</td>\n<td></td>\n<td>0.51923</td>\n<td></td>\n</tr>\n<tr>\n<td>Total</td>\n<td>88</td>\n<td>32.592</td>\n<td></td>\n<td></td>\n<td>1.00000</td>\n<td></td>\n</tr>\n</tbody></table>\n<p> &gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</p>\n</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># manova for each paired groups</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_paired <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Groups</th>\n<th>measure</th>\n<th>permutations</th>\n<th>R<sup>2</sup></th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>T16 vs T18</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2748773</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>2</td>\n<td>T16 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4539103</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>3</td>\n<td>T16 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4102009</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>4</td>\n<td>T16 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2243404</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>5</td>\n<td>T18 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3736482</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>6</td>\n<td>T18 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3504104</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>7</td>\n<td>T18 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2147055</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>8</td>\n<td>T20 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3575765</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>9</td>\n<td>T20 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4589248</td>\n<td>0.001</td>\n</tr>\n<tr>\n<td>10</td>\n<td>T21 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4395176</td>\n<td>0.001</td>\n</tr>\n</tbody></table>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"comment\"># manova for specified group set: here &quot;Group + Type&quot;</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_manova<span class=\"punctuation\">(</span>cal_manova_set <span class=\"operator\">=</span> <span class=\"string\">&quot;Site+ Indexs&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_manova<span class=\"operator\">$</span>aov.tab</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Permutation: free</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Number of permutations: 999</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td>Terms added sequentially (first to last)</td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n<tr>\n<td></td>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(F)</td>\n</tr>\n<tr>\n<td>Site</td>\n<td>4</td>\n<td>15.669</td>\n<td>4</td>\n<td>0</td>\n<td>0.48077</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Indexs</td>\n<td>84</td>\n<td>16.923</td>\n<td>0</td>\n<td>0</td>\n<td>0.51923</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Residuals</td>\n<td>0</td>\n<td>0.000</td>\n<td>Inf</td>\n<td></td>\n<td>0.00000</td>\n<td></td>\n</tr>\n<tr>\n<td>Total</td>\n<td>88</td>\n<td>32.592</td>\n<td></td>\n<td></td>\n<td>1.00000</td>\n<td></td>\n</tr>\n</tbody></table>\n<h1 id=\"11-trans-diff-class\"><a href=\"#11-trans-diff-class\" class=\"headerlink\" title=\"11. trans_diff class\"></a><font color=#FF0000 >11. trans_diff class</font></h1><ul>\n<li><p>Differential abundance test is a very important part in the microbial community data analysis. It can be used to find the significant taxa in determining the community differences across groups. Currently, trans_diff class have three famous approaches to perform this analysis: metastat[11], LEfSe[12] and random forest. Metastat depends on the permutations and t-test and performs well on the sparse data. It is used for the comparisons between two groups.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># metastat analysis at Genus level</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;metastat&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> metastat_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_metastat is the result</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_metastat_group_matrix is the group comparisons order for plotting</span></span><br><span class=\"line\"><span class=\"comment\"># plot the first paired groups, choose_group = 1</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_metastat<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> qvalue <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> choose_group <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>LEfSe combines the non-parametric test and linear discriminant analysis. We implement this approach in this package instead of the python version.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;lefse&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> alpha <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> lefse_subgroup <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_lefse is the LEfSe result</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_abund is the abundance information</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_bar<span class=\"punctuation\">(</span>LDA_score <span class=\"operator\">=</span> <span class=\"number\">4</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>We can also plot the abundance of taxa detected using LEfSe.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>plot_diff_abund<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Then, we show the cladogram of the differential features in the taxonomic tree. There are too many taxa in this dataset. As an example, we only use the highest 200 abundant taxa in the tree and 50 differential features. We only show the full taxonomic label at Phylum level and use letters at other levels to reduce the text overlap.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># clade_label_level 5 represent phylum level in this analysis</span></span><br><span class=\"line\"><span class=\"comment\"># require ggtree package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_cladogram<span class=\"punctuation\">(</span>use_taxa_num <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> use_feature_num <span class=\"operator\">=</span> <span class=\"number\">50</span><span class=\"punctuation\">,</span> clade_label_level <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>There may be a problem related with the taxonomic labels in the plot. When the levels used are too many, the taxonomic labels may have too much overlap. However, if we only indicate the Phylum labels, the taxa in the legend with marked letters are too many. At this time, you can select the taxa that you want to show in the plot manually like the following operation.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># choose some taxa according to the positions in the previous picture; those taxa labels have minimum overlap</span></span><br><span class=\"line\">use_labels <span class=\"operator\">&lt;-</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;c__Deltaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Actinobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Rhizobiales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Proteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Bacteroidetes&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t<span class=\"string\">&quot;o__Micrococcales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Acidobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Verrucomicrobia&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;p__Firmicutes&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t<span class=\"string\">&quot;p__Chloroflexi&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Acidobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Gammaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__Betaproteobacteria&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;c__KD4-96&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t<span class=\"string\">&quot;c__Bacilli&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Gemmatimonadales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;f__Gemmatimonadaceae&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Bacillales&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;o__Rhodobacterales&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then use parameter select_show_labels to show</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_lefse_cladogram<span class=\"punctuation\">(</span>use_taxa_num <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> use_feature_num <span class=\"operator\">=</span> <span class=\"number\">50</span><span class=\"punctuation\">,</span> select_show_labels <span class=\"operator\">=</span> use_labels<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># Now we can see that more taxa names appear in the tree</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>If you are interested in taxonomic tree, you can also use metacoder package[13] to plot the taxonomic tree based on the selected taxa. We do not show the usage here.</p>\n</li>\n<li><p>The third approach is rf, which depends on the random forest[14, 15] and the non-parametric test. The current method can calculate random forest by bootstrapping like the method in LEfSe and only use the significant features. MeanDecreaseGini is selected as the indicator value in the analysis.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use Genus level for parameter rf_taxa_level, if you want to use all taxa, change to &quot;all&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># nresam = 1 and boots = 1 represent no bootstrapping and use all samples directly</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;rf&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> rf_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rf is the result stored in the object</span></span><br><span class=\"line\"><span class=\"comment\"># plot the result</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>plot_diff_abund<span class=\"punctuation\">(</span>use_number <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">20</span><span class=\"punctuation\">,</span> only_abund_plot <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">gridExtra<span class=\"operator\">::</span>grid.arrange<span class=\"punctuation\">(</span>t2<span class=\"operator\">$</span>p1<span class=\"punctuation\">,</span> t2<span class=\"operator\">$</span>p2<span class=\"punctuation\">,</span> ncol<span class=\"operator\">=</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> nrow <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> widths <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">,</span><span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># the middle asterisk represent the significances</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"12-trans-env-class\"><a href=\"#12-trans-env-class\" class=\"headerlink\" title=\"12. trans_env class\"></a><font color=#FF0000 >12. trans_env class</font></h1><ul>\n<li><p>分析环境因子对微生物群落结构和组装的影响：RDA分析(db-RDA和RDA).</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># add_data is used to add the environmental data</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use bray-curtis distance to do dbrda</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rda<span class=\"punctuation\">(</span>use_dbrda <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> use_measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda is the result list stored in the object</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>trans_rda<span class=\"punctuation\">(</span>adjust_arrow_length <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> max_perc_env <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda_trans is the transformed result for plotting</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_rda<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use Genus</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rda<span class=\"punctuation\">(</span>use_dbrda <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># As the main results of RDA are related with the projection and angles between different arrows,</span></span><br><span class=\"line\"><span class=\"comment\"># we adjust the length of the arrow to show them clearly using several parameters.</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>trans_rda<span class=\"punctuation\">(</span>show_taxa <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span> adjust_arrow_length <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> max_perc_env <span class=\"operator\">=</span> <span class=\"number\">1500</span><span class=\"punctuation\">,</span> max_perc_tax <span class=\"operator\">=</span> <span class=\"number\">3000</span><span class=\"punctuation\">,</span> min_perc_env <span class=\"operator\">=</span> <span class=\"number\">200</span><span class=\"punctuation\">,</span> min_perc_tax <span class=\"operator\">=</span> <span class=\"number\">300</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># t1$res_rda_trans is the transformed result for plotting</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_rda<span class=\"punctuation\">(</span>plot_color <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Mantel test 用于检测环境因子和距离矩阵之间是否具有显著的相关性。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_mantel<span class=\"punctuation\">(</span>use_measure <span class=\"operator\">=</span> <span class=\"string\">&quot;bray&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_mantel</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_mantel</span><br></pre></td></tr></table></figure>\n\n  <div style=\"overflow-x:auto;\">\n  <table>\n  \n<table>\n<thead>\n<tr>\n<th></th>\n<th>variable_name</th>\n<th>cor_method</th>\n<th>corr_res</th>\n<th>p_res</th>\n<th>significance</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td><strong>TN</strong></td>\n<td>pearson</td>\n<td>0.5571885</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>2</td>\n<td><strong>TC</strong></td>\n<td>pearson</td>\n<td>0.5712239</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3</td>\n<td><strong>TS</strong></td>\n<td>pearson</td>\n<td>0.2665453</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4</td>\n<td><strong>TOC</strong></td>\n<td>pearson</td>\n<td>0.3540337</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>5</td>\n<td><strong>Salinity</strong></td>\n<td>pearson</td>\n<td>0.2782537</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>6</td>\n<td>Temperature</td>\n<td>pearson</td>\n<td>0.5856050</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>7</td>\n<td><strong>Dissolved.oxygen</strong></td>\n<td>pearson</td>\n<td>0.4358422</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>8</td>\n<td>Surface.chlorophyll.concentrations</td>\n<td>pearson</td>\n<td>0.2586823</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>9</td>\n<td>pH</td>\n<td>pearson</td>\n<td>0.4498964</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>10</td>\n<td><strong>PAR</strong></td>\n<td>pearson</td>\n<td>0.1712861</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>11</td>\n<td>Density</td>\n<td>pearson</td>\n<td>0.5682679</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>12</td>\n<td>Turbidity</td>\n<td>pearson</td>\n<td>0.2260436</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td></table></div></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n</li>\n<li><p>环境变量与分类群（taxa）的相关性对分析和推断影响群落结构的因素具有重要意义。在本例中，我们首先进行了差异丰度检验（differential abundance test）和随机森林分析（random forest），得到了重要的属（Genus）。然后利用这些分类单元进行相关性分析。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># first create trans_diff object</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_diff<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;rf&quot;</span><span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> rf_taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Genus&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># then create trans_env object</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate correlation</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>use_data <span class=\"operator\">=</span> <span class=\"string\">&quot;other&quot;</span><span class=\"punctuation\">,</span> p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;fdr&quot;</span><span class=\"punctuation\">,</span> other_taxa <span class=\"operator\">=</span> t2<span class=\"operator\">$</span>res_rf<span class=\"operator\">$</span>Taxa<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">60</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor </span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用ggplot2或pheatmap进行可视化</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># default ggplot2 method</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># clustering heatmap; require pheatmap package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span>pheatmap <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg\" alt=\"7个环境变量与分类群ggplot2\"></p>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg\" alt=\"7个环境变量与分类群相关性_pheatmap\"></p>\n<ul>\n<li><p>各组内的环境变量与分类群taxa之间的关系</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate correlations for different groups using parameter by_group</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>by_group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> use_data <span class=\"operator\">=</span> <span class=\"string\">&quot;other&quot;</span><span class=\"punctuation\">,</span> p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;fdr&quot;</span><span class=\"punctuation\">,</span> other_taxa <span class=\"operator\">=</span> t2<span class=\"operator\">$</span>res_rf<span class=\"operator\">$</span>Taxa<span class=\"punctuation\">[</span><span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">60</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg\" alt=\"correlations_between_environmental_variables_and_60_taxa\"></p>\n<ul>\n<li><p>环境因子与alpha-多样性之间的关系</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">7</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># use add_abund_table parameter to add the extra data table</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>add_abund_table <span class=\"operator\">=</span> meco_dataset<span class=\"operator\">$</span>alpha_diversity<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg\" alt=\"relationship_between_7_environmental_factors_and_alpha_diversity\"></p>\n<h1 id=\"13-trans-nullmodel-class\"><a href=\"#13-trans-nullmodel-class\" class=\"headerlink\" title=\"13. trans_nullmodel class\"></a><font color=#FF0000 >13. trans_nullmodel class</font></h1><ul>\n<li><p>近几十年来，系统发育分析和空模型（null model）的结合，通过增加系统发育维度（phylogeny dimension），更加有力地促进了生态位和中性（niche and neutral）对群落组装影响的推断[16，17]。trans_nullmodel class提供了一个封装，包括对系统发育信号、beta平均成对系统发育距离（beta mean pairwise phylogenetic distance，betaMPD）、beta平均最近分类单元距离（beta mean nearest taxon distance，betaMNTD）、beta最近分类单元指数（beta nearest taxon index，betaNTI）、beta净相关指数（beta net relatedness index，betaNRI）和基于Bray-Curtis的Raup-Crick（Bray-Curtis-based Raup-Crick，RCbray）的计算。系统发育信号分析的方法基于mantel相关图（mantel correlogram）[18]，与其他方法相比，系统发育信号的变化是直观而清晰的。betaMNTD和betaMPD的算法已经过优化，比picante包中的算法更快[3]。RCbray和betaNTI（或betaNRI）之间的组合可用于推断在特定假设下支配群落装配（community assembly）的每个生态过程（ecological process）的强度[17]。这可以通过函数cal_process()来解析每个推断进程（ecological process）的百分比来实现。<font color=#2196F3 ><strong>我们首先检查系统发育信号：</strong></font></p>\n <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># generate trans_nullmodel object; use 10000 OTUs as example</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_nullmodel<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">,</span> taxa_number <span class=\"operator\">=</span> <span class=\"number\">10000</span><span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># use TOC as the test variable (__报错：Error in cor(as.vector(xdis), ydis, method = method, use = use) : </span></span><br><span class=\"line\">  cov<span class=\"operator\">/</span>cor中有遗漏值__<span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_mantel_corr<span class=\"punctuation\">(</span>use_env <span class=\"operator\">=</span> <span class=\"string\">&quot;TOC&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_mantel_corr</span></span><br><span class=\"line\"><span class=\"comment\"># plot the mantel correlogram(__报错：Error in names(x) &lt;- value : &#x27;names&#x27;属性的长度[4]必需和矢量的长度[0]一样__)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_mantel_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>betaNRI（ses.betampd）用于显示“basal”系统发育转换（phylogenetic turnover）[18]。与betaNTI相比，它能捕获更多与深层系统发育（deep phylogeny）相关的转换信息（turnover information）。值得注意的是，经过几十年的发展，出现了许多空模型（null models）。在trans-nullmodel class中，我们随机化了物种的系统发育相关性。这种洗牌方法（shuffling approach）固定了观察到的物种α-多样性和β-多样性的水平，以探讨观察到的系统发育转换是否与空模型（物种间的系统发育关系是随机的）显著不同。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行500次null model</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_ses_betampd<span class=\"punctuation\">(</span>runs<span class=\"operator\">=</span><span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 返回t1$res_ses_betampd</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>可以使用trans_beta class中的plot_group_distance function绘制betaNRI图。结果表明T20和T21的平均betaNRI 显著高于其它三者，表明T20和T21中的basal phylogenetic turnover是高的。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将betaNRI矩阵加入到beta_diversity列表中</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_ses_betampd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用measure &quot;betaNRI&quot;创建trans_beta class</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transform the distance for each group</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果可视化</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_all.jpg\" alt=\"betaNRI all\"></p>\n<ul>\n<li><p>若要单独的对每个组进行 null model analysis，例如每个组作为一个物种池（species pool），我们可以分别为每个组计算结果。 我们发现，当分别对每个组进行betaNRI 分析时，CW和TW间的mean betaNRI没有显著差异，且二者均显著高于IW ，揭示了在将每个区域视为特定物种库的条件下，CW和TW中变量选择的强度（strength of variable selection）可能相似。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个列表用于存放trans_nullmodel的结果</span></span><br><span class=\"line\">sesbeta_each <span class=\"operator\">&lt;-</span> <span class=\"built_in\">list</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">group_col <span class=\"operator\">&lt;-</span> <span class=\"string\">&quot;Site&quot;</span></span><br><span class=\"line\">all_groups <span class=\"operator\">&lt;-</span> unique<span class=\"punctuation\">(</span>meco_dataset<span class=\"operator\">$</span>sample_table<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> group_col<span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对每个组分别进行计算</span></span><br><span class=\"line\"><span class=\"keyword\">for</span><span class=\"punctuation\">(</span>i <span class=\"keyword\">in</span> all_groups<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">\t<span class=\"comment\"># like the above operation, but need provide &#x27;group&#x27; and &#x27;select_group&#x27;</span></span><br><span class=\"line\">\ttest <span class=\"operator\">&lt;-</span> trans_nullmodel<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> group_col<span class=\"punctuation\">,</span> select_group <span class=\"operator\">=</span> i<span class=\"punctuation\">,</span> taxa_number <span class=\"operator\">=</span> <span class=\"number\">1000</span><span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data<span class=\"punctuation\">)</span></span><br><span class=\"line\">\ttest<span class=\"operator\">$</span>cal_ses_betampd<span class=\"punctuation\">(</span>runs <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">\tsesbeta_each<span class=\"punctuation\">[[</span>i<span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> test<span class=\"operator\">$</span>res_ses_betampd</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 合并结果并重塑（reshape），得到一个对称矩阵（symmetrical matrix）</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>reshape2<span class=\"punctuation\">)</span></span><br><span class=\"line\">test <span class=\"operator\">&lt;-</span> lapply<span class=\"punctuation\">(</span>sesbeta_each<span class=\"punctuation\">,</span> melt<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> do.call<span class=\"punctuation\">(</span>rbind<span class=\"punctuation\">,</span> .<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> reshape2<span class=\"operator\">::</span>dcast<span class=\"punctuation\">(</span>.<span class=\"punctuation\">,</span> Var1<span class=\"operator\">~</span>Var2<span class=\"punctuation\">,</span> value.var <span class=\"operator\">=</span> <span class=\"string\">&quot;value&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `row.names&lt;-`<span class=\"punctuation\">(</span>.<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span><span class=\"number\">1</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> .<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"operator\">-</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> drop <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如同上述操作</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> test</span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNRI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_individual.jpg\" alt=\"betaNRI individual\"></p>\n<ul>\n<li><p>BetaNTI(ses.betamntd) 可用于指示系统发育的末端转换（ phylogenetic terminal turnover） [17]</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 运行500次null model</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_ses_betamntd<span class=\"punctuation\">(</span>runs<span class=\"operator\">=</span><span class=\"number\">500</span><span class=\"punctuation\">,</span> abundance.weighted <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 返回t1$res_ses_betamntd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将betaNTI矩阵加入到beta_diversity列表中</span></span><br><span class=\"line\">meco_dataset<span class=\"operator\">$</span>beta_diversity<span class=\"punctuation\">[[</span><span class=\"string\">&quot;betaNTI&quot;</span><span class=\"punctuation\">]</span><span class=\"punctuation\">]</span> <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_ses_betamntd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用measure &quot;betaNRI&quot;创建trans_beta class</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_beta<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> group <span class=\"operator\">=</span> <span class=\"string\">&quot;Site&quot;</span><span class=\"punctuation\">,</span> measure <span class=\"operator\">=</span> <span class=\"string\">&quot;betaNTI&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># transform the distance for each group</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_group_distance<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 结果可视化</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggplot2<span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">&lt;-</span> t2<span class=\"operator\">$</span>plot_group_distance<span class=\"punctuation\">(</span>distance_pair_stat <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">g1 <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> geom_hline<span class=\"punctuation\">(</span>yintercept <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span> linetype <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>cal_rcbray()功能用于计算RCbray (Bray-Curtis-based Raup-Crick) ，以评估成分转换（compositional turnover）是否主要受漂移控制[19]。我们应用空模型（null model）通过从每个物种池中随机采样个体来模拟物种分布，同时保留物种发生频率（species occurrence frequency）和样本物种丰富度（sample species richness）[18]。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># result stored in t1$res_rcbray</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_rcbray<span class=\"punctuation\">(</span>runs <span class=\"operator\">=</span> <span class=\"number\">1000</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_rcbray</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>作为一个例子，我们还计算了引用文献[17，18]中所示的在群落组装（community assembly）上推断过程（ inferred processes ）所占的比例。在此示例中，具有显着betaNTI值（|βNTI|&gt; 2）的成对比较部分是估计的选择（Selection）造成影响； βNTI&gt; 2代表异构选择（heterogeneous ）； βNTI&lt;-2表示同质选择（homogeneous ）。 RCbray值表征了随机分配（randomization）下观察到的Bray-Curtis和Bray-Curtis期望值之间的偏差大小（magnitude of deviation）。 | RCbray | &gt; 0.95被认为是显着的。 |βNTI| &lt; 2和RCbray &gt; +0.95被视为受散播限制（Dispersal Limitation）与漂移（Drift）相结合的影响。 |βNTI| &lt; 2和RCbray &lt; -0.95被视为均质分散（Homogenizing Dispersal）影响的估计值。 |βNTI| &lt; 2和|RCbray| &lt; 0.95估算了漂移单独作用的影响。</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># use betaNTI and rcbray to evaluate processes</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_process<span class=\"punctuation\">(</span>use_betamntd <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_process</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>res_process</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th></th>\n<th>process</th>\n<th>percentage</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>variable selection</td>\n<td>0.4341164</td>\n</tr>\n<tr>\n<td>2</td>\n<td>homogeneous selection</td>\n<td>63.6874362</td>\n</tr>\n<tr>\n<td>3</td>\n<td>dispersal limitation</td>\n<td>0.0000000</td>\n</tr>\n<tr>\n<td>4</td>\n<td>homogeneous dispersal</td>\n<td>14.8365679</td>\n</tr>\n<tr>\n<td>5</td>\n<td>drift</td>\n<td>21.0418795</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n<h1 id=\"14-trans-network-class\"><a href=\"#14-trans-network-class\" class=\"headerlink\" title=\"14. trans_network class\"></a><font color=#FF0000 >14. trans_network class</font></h1><h2 id=\"correlation-based-network\"><a href=\"#correlation-based-network\" class=\"headerlink\" title=\"correlation-based network\"></a><font color=#FF9800 >correlation-based network</font></h2><ul>\n<li>准备R包并进行计算相关性  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;WGCNA&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>WGCNA<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># 以下3选1</span></span><br><span class=\"line\"><span class=\"comment\"># 1. Use R base cor.test, slow</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;base&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">,</span> cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_cor_p list; one table: correlation; another: p value</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. SparCC method, require SpiecEasi package</span></span><br><span class=\"line\"><span class=\"comment\"># SparCC is very slow, so consider filtering more species with low abundance</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> meco_dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;SparCC&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.001</span><span class=\"punctuation\">,</span> SparCC_simu_num <span class=\"operator\">=</span> <span class=\"number\">100</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. When the OTU number is large, use R WGCNA package to replace R base to calculate correlations</span></span><br><span class=\"line\"><span class=\"comment\"># require WGCNA package</span></span><br><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_network<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> dataset<span class=\"punctuation\">,</span> cal_cor <span class=\"operator\">=</span> <span class=\"string\">&quot;WGCNA&quot;</span><span class=\"punctuation\">,</span> taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;OTU&quot;</span><span class=\"punctuation\">,</span> filter_thres <span class=\"operator\">=</span> <span class=\"number\">0.0001</span><span class=\"punctuation\">,</span> cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"构建网络\"><a href=\"#构建网络\" class=\"headerlink\" title=\"构建网络\"></a><font color=#FF9800 >构建网络</font></h2><ul>\n<li><p>COR_optimization &#x3D; TRUE represent using RMT theory to find the optimized correlation threshold instead of the COR_cut.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># construct network; require igraph package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network<span class=\"punctuation\">(</span>p_thres <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> COR_optimization <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_network</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># (可选) use arbitrary coefficient threshold to contruct network</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network<span class=\"punctuation\">(</span>p_thres <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span> COR_cut <span class=\"operator\">=</span> <span class=\"number\">0.73</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># save network</span></span><br><span class=\"line\"><span class=\"comment\"># open the gexf file using Gephi(https://gephi.org/)</span></span><br><span class=\"line\"><span class=\"comment\"># require rgexf package</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;rgexf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>save_network<span class=\"punctuation\">(</span>filepath <span class=\"operator\">=</span> <span class=\"string\">&quot;network.gexf&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Now, we show the node colors with the Phylum information and the edges colors with the positive and negative correlations. All the data used has been stored in the network.gexf file, including modules classifications, Phylum information and edges classifications.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate network attributes</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_network_attr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_network_attr</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># classify the node; return t1$res_node_type</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_node_type<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_node_type</span></span><br><span class=\"line\"><span class=\"comment\"># we retain the file for the following example in trans_func part</span></span><br><span class=\"line\">network_node_type <span class=\"operator\">&lt;-</span> t1<span class=\"operator\">$</span>res_node_type</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># plot node roles in terms of the within-module connectivity and among-module connectivity</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_taxa_roles<span class=\"punctuation\">(</span>use_type <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># plot node roles with phylum information</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_taxa_roles<span class=\"punctuation\">(</span>use_type <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Now, we show the eigengene analysis of modules. The eigengene of a module, i.e. the first principal component of PCA, represents the main variance of the abundance in the species of the module.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1<span class=\"operator\">$</span>cal_eigen<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_eigen</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p><strong>出错了</strong>！Then we perform correlation heatmap to show the relationships between eigengenes and environmental factors.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># create trans_env object like the above operation</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_env<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>dataset <span class=\"operator\">=</span> dataset<span class=\"punctuation\">,</span> add_data <span class=\"operator\">=</span> env_data_16S<span class=\"punctuation\">[</span><span class=\"punctuation\">,</span> <span class=\"number\">4</span><span class=\"operator\">:</span><span class=\"number\">11</span><span class=\"punctuation\">]</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate correlations</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_cor<span class=\"punctuation\">(</span>add_abund_table <span class=\"operator\">=</span> t1<span class=\"operator\">$</span>res_eigen<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># plot the correlation heatmap</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>plot_corr<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>The function cal_sum_links() is used to sum the links (edge) number from one taxa to another or in the same taxa. The function plot_sum_links() is used to show the result from the function cal_sum_links(). This is very useful to fast see how many nodes are connected between different taxa or within one taxa. In terms of “Phylum” level in the tutorial, the function cal_sum_links() sum the linkages number from one Phylum to another Phylum or the linkages in the same Phylum. So the numbers along the outside of the circular plot represent how many edges or linkages are related with the Phylum. For example, in terms of Proteobacteria, there are roughly total 900 edges associated with the OTUs in Proteobacteria, in which roughly 200 edges connect both OTUs in Proteobacteria and roughly 150 edges connect the OTUs from Proteobacteria with the OTUs from Chloroflexi.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">devtools<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;mattflor/chorddiag&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># calculate the links between or within taxonomic ranks (报错：Error in ecount(network) : 没有&quot;ecount&quot;这个函数)</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_sum_links<span class=\"punctuation\">(</span>taxa_level <span class=\"operator\">=</span> <span class=\"string\">&quot;Phylum&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t1$res_sum_links_pos and t1$res_sum_links_neg</span></span><br><span class=\"line\"><span class=\"comment\"># require chorddiag package</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>plot_sum_links<span class=\"punctuation\">(</span>plot_pos <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> plot_num <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"15-trans-func-class\"><a href=\"#15-trans-func-class\" class=\"headerlink\" title=\"15. trans_func class\"></a><font color=#FF0000 >15. trans_func class</font></h1><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Identify microbial traits</span></span><br><span class=\"line\"><span class=\"comment\"># create object of trans_func</span></span><br><span class=\"line\">t2 <span class=\"operator\">&lt;-</span> trans_func<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># mapping the taxonomy to the database</span></span><br><span class=\"line\"><span class=\"comment\"># the function can recognize prokaryotes or fungi automatically</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_spe_func<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t2$res_spe_func, 1 represent function exists, 0 represent no or cannot confirmed.</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p>The percentages of the OTUs having the same trait can reflect the functional redundancy of this function in the community or the module in the network.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># calculate the percentages of OTUs for each trait in each module of network</span></span><br><span class=\"line\"><span class=\"comment\"># use_community = FALSE represent calculating module, not community, node_type_table provide the module information</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>cal_spe_func_perc<span class=\"punctuation\">(</span>use_community <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> node_type_table <span class=\"operator\">=</span> network_node_type<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return t2$res_spe_func_perc</span></span><br><span class=\"line\"><span class=\"comment\"># we only plot some important traits, so we use the default group list to filter and show the traits.</span></span><br><span class=\"line\">t2<span class=\"operator\">$</span>plot_spe_func_perc<span class=\"punctuation\">(</span>select_samples <span class=\"operator\">=</span> paste0<span class=\"punctuation\">(</span><span class=\"string\">&quot;M&quot;</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"operator\">:</span><span class=\"number\">10</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># M represents module, ordered by the nodes number from high to low</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Tax4Fun requires a strict input file demand on the taxonomic information. To analyze the trimmed or changed OTU data in R with Tax4Fun, we provide a link to the Tax4Fun functional prediction.</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">t1 <span class=\"operator\">&lt;-</span> trans_func<span class=\"operator\">$</span>new<span class=\"punctuation\">(</span>meco_dataset<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># install Tax4Fun package and download SILVA123 ref data from  http://tax4fun.gobics.de/</span></span><br><span class=\"line\">wget https<span class=\"operator\">:</span><span class=\"operator\">/</span><span class=\"operator\">/</span>github.com<span class=\"operator\">/</span>bwemheu<span class=\"operator\">/</span>Tax4Fun2<span class=\"operator\">/</span>releases<span class=\"operator\">/</span>download<span class=\"operator\">/</span><span class=\"number\">1.1</span>.5<span class=\"operator\">/</span>Tax4Fun2_1.1.5.tar.gz</span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span>pkgs <span class=\"operator\">=</span> <span class=\"string\">&quot;Tax4Fun2_1.1.5.tar.gz&quot;</span><span class=\"punctuation\">,</span> repos <span class=\"operator\">=</span> <span class=\"literal\">NULL</span><span class=\"punctuation\">,</span> source <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># decompress SILVA123; provide path in folderReferenceData as you put</span></span><br><span class=\"line\">t1<span class=\"operator\">$</span>cal_tax4fun<span class=\"punctuation\">(</span>folderReferenceData <span class=\"operator\">=</span> <span class=\"string\">&quot;./SILVA123&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># return two files: t1$tax4fun_KO: KO file; t1$tax4fun_path: pathway file.</span></span><br><span class=\"line\"><span class=\"comment\"># t1$tax4fun_KO$Tax4FunProfile[1:5, 1:2]</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h1 id=\"16-知识点\"><a href=\"#16-知识点\" class=\"headerlink\" title=\"16. 知识点\"></a><font color=#FF0000 >16. 知识点</font></h1><h2 id=\"确定性过程和随机过程\"><a href=\"#确定性过程和随机过程\" class=\"headerlink\" title=\"确定性过程和随机过程\"></a><font color=#FF9800 >确定性过程和随机过程</font></h2><ul>\n<li><p>The term <font color=#2196F3 size=5><b>“deterministic process”</b></font> refers to two types of selective forces, namely, those that lead to either more (i.e. homogeneous selection) or less (i.e. heterogeneous selection) similar structures among communities due to homogeneous and heterogeneous environmental pressures, respectively (Zhou &amp; Ning, 2017).  <font color=#2196F3 size=5><b>确定性过程</b></font>包括两种选择力，即分别导致更加相似（即同质选择）或更少相似（即异质选择）的群落间的结构的同质和异质环境压力。</p>\n</li>\n<li><p>The term<font color=#2196F3 size=5><b> “stochastic process” </b></font>refers to homogenizing dispersal, dispersal limitation (combined with drift) and pure drift, which can obscure the turnover among microbial communities due to high dispersal; low dispersal; and random changes in birth, death and reproduction, respectively (Zhou &amp; Ning, 2017). <font color=#2196F3 size=5><b>随机过程</b></font>是指均匀分散、分散限制（结合漂变）和纯漂变，它们可以通过高度分散、低分散和出生、死亡和繁殖的随机变化来掩盖&#x2F;减弱微生物群落之间的更替。</p>\n</li>\n</ul>\n<p><img src=\"/images/lujia/nullmodel.png\" alt=\"Community assembly processes by Stegen *et al.* https://www.nature.com/articles/ismej201393\n\"></p>\n<ul>\n<li>An NTI of &gt;+2 indicates that the ASVs in a local community are more closely related than expected by chance, suggesting the role of selective pressures (e.g. environmental conditions) in phylogenetic clustering. An NTI of &lt;−2 represents phylogenetic overdispersion, indicating two possible biotic interactions: competition and facilitation. In contrast, a mean NTI across multiple communities that is significantly greater or less than zero indicates phylogenetic clustering or overdispersion, respectively (Zhou &amp; Ning, 2017). NTI &gt;2表明，在一个地方群落中，ASVs的亲缘关系比预期的更为密切，表明选择压力（如环境条件）在系统发育聚类中的作用。NTI &lt;-2表示系统发育过度分散，表明两种可能的生物相互作用：竞争和促进。相反，多个群落间的平均NTI显著大于或小于零，分别表明系统发育聚类或过度分散（Zhou和Ning，2017）。</li>\n<li>βNTI&gt;+2 or &lt;−2 signified heterogeneous selection or homogeneous selection, respectively. βNTI&gt;+2 or &lt;−2 分别指示异质选择和同质选择。</li>\n</ul>\n<h1 id=\"17-参考\"><a href=\"#17-参考\" class=\"headerlink\" title=\"17. 参考\"></a><font color=#FF0000 >17. 参考</font></h1><ul>\n<li><a href=\"https://chiliubio.github.io/microeco/\">https://chiliubio.github.io/microeco/</a></li>\n<li>Zhou, J., &amp; Ning, D. (2017). Stochastic community assembly: Does it matter in microbial ecology? Microbiology and Molecular Biology Reviews, 81(4), e00002–17. <a href=\"https://doi.org/10.1128/MMBR.00002%E2%80%9017\">https://doi.org/10.1128/MMBR.00002‐17</a></li>\n<li><a href=\"http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml\">http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml</a></li>\n</ul>","categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"扩增子","path":"api/tags/扩增子.json"}]}