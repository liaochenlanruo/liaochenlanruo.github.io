{"title":"基于TidyMass的非靶向代谢组学分析","slug":"基于TidyMass的非靶向代谢组学分析","date":"2023-04-19T07:45:39.000Z","updated":"2024-03-11T13:07:17.000Z","comments":true,"path":"api/articles/基于TidyMass的非靶向代谢组学分析.json","excerpt":null,"covers":["https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png","https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png"],"content":"<h1 id=\"代谢组学常用仪器特点\"><a href=\"#代谢组学常用仪器特点\" class=\"headerlink\" title=\"代谢组学常用仪器特点\"></a>代谢组学常用仪器特点</h1><table border=\"1\">\n<tr>\n<th>仪器</th>\n<th>特点</th>\n</tr>\n<tr>\n<td>GC-MS</td>\n<td>易挥发，低极性，热稳定的小分子化合物；需衍生化</td>\n</tr>\n<tr>\n<td>LC-MS</td>\n<td>具有一定极性的有机化合物；无需衍生化</td>\n</tr>\n<tr>\n<td>NMR</td>\n<td>无偏性，无损检测；•无需繁琐前处理，便于活体、原位的动态检测</td>\n</tr>\n<tr>\n<td>CE-MS</td>\n<td>高极性化合物，如核酸，蛋白等</td>\n</tr>\n<tr>\n<td>ICP-MS</td>\n<td>无机化合物</td>\n</tr>\n</table>\n\n<h1 id=\"LC-QTOF原理\"><a href=\"#LC-QTOF原理\" class=\"headerlink\" title=\"LC-QTOF原理\"></a>LC-QTOF原理</h1><p>Q-TOF全称为四极飞行时间质谱仪（Quadrupole Time-of-Flight Mass Spectrometer）。其基本原理是将样品离子通过四极杆进行质量筛选，然后进入飞行时间质谱器（Time-of-Flight Mass Analyzer，ToF），测定其离子的飞行时间，从而得到样品中离子的质量信息。Q-TOF有正离子模式（positive ion mode, POS）和负离子模式（negative ion mode, NEG）两种电离方式，在检测代谢组时结合使用两种方式可以使代谢物覆盖率更高，检测效果也更好。</p>\n<p>Q-TOF的工作过程包含以下步骤：</p>\n<p><strong>离子化</strong>：样品通过电喷雾或者MALDI等方法被电离成为离子。</p>\n<p><strong>生成离子束</strong>：离子经过引出阱、加速器、光栅偏转镜等装置，形成一个带电的离子束。</p>\n<p><strong>四极杆质量筛选</strong>：离子束进入四极杆，通过高频交变电压（RF）和直流电压（DC）的控制，将不同质量的离子分离出来。</p>\n<p><strong>飞行时间质谱分析</strong>：通过激光或者其他方法对分散的离子束施加助推、聚焦和分析，并且测定其到达检测器所需的时间。不同质量的离子抵达检测器所需要的时间不同，从而可以得到离子的质量信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"LC-QTOF原理\"><br><font color=\"#FF0000\"><strong>FAQ</strong>：POS和NEG数据的利用。</font><br>负离子和正离子是数据采集时的时候的两种模式生成两套数据，一级分析（MS）结果中是提供 POS 和 NEG 两个检测结果列表的，但是在二级分析（MSMS）结果中，我们将鉴定正负离子模式下鉴定到的物质进行了合并，所以二级分析是针对代谢物来做的，不区分正负离子模式。</p>\n<p><font color=\"#FF0000\"><strong>FAQ</strong>: 当正负离子模式下都检测到了某种物质，如何对该物质的结果进行呈现？</font><br>会根据匹配参数进行取舍，选用匹配参数更好的模式下的数据在二级结果中进行分析。</p>\n<h1 id=\"数据分析\"><a href=\"#数据分析\" class=\"headerlink\" title=\"数据分析\"></a>数据分析</h1><h2 id=\"下机数据格式转换\"><a href=\"#下机数据格式转换\" class=\"headerlink\" title=\"下机数据格式转换\"></a>下机数据格式转换</h2><p>以下两个软件二选一，Windows下建议使用ProteoWizard，其用法可参考<a href=\"https://liaochenlanruo.fun/post/df57.html\">用metid构建代谢组数据库</a>。Linux下建议使用massconverter。</p>\n<h3 id=\"ProteoWizard\"><a href=\"#ProteoWizard\" class=\"headerlink\" title=\"ProteoWizard\"></a><a href=\"https://github.com/ProteoWizard\">ProteoWizard</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h3 id=\"massconverter\"><a href=\"#massconverter\" class=\"headerlink\" title=\"massconverter\"></a><a href=\"https://tidymass.github.io/massconverter/\">massconverter</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/massconverter&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取pwiz</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>massconverter<span class=\"punctuation\">)</span></span><br><span class=\"line\">docker_pull_pwiz<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><strong>Debug</strong>：如果报错<code>Error in docker_pull_pwiz() :   Please install docker first (https://www.docker.com/get-started)</code>，则首先确认系统是否已安装docker，如果未安装，请先安装docker；如已经安装，则是因为普通用户无运行docker的权限，将其添加到docker用户组中即可。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">root模式下运行如下shell命令，将用户lhl添加到docker组中</span></span><br><span class=\"line\">gpasswd -a lhl docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启docker生效</span></span><br><span class=\"line\">service docker restart</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置转换参数\"><a href=\"#设置转换参数\" class=\"headerlink\" title=\"设置转换参数\"></a>设置转换参数</h4><p>此处调用MSConvert进行格式转换，期间进行了过滤，主要采用了<code>Peak Picking</code>，<code>Subset</code>，和<code>Zero Samples</code>方法。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameter <span class=\"operator\">=</span></span><br><span class=\"line\">  massconverter<span class=\"operator\">::</span>create_msconvert_parameter<span class=\"punctuation\">(</span></span><br><span class=\"line\">    output_format <span class=\"operator\">=</span> <span class=\"string\">&quot;mzXML&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;mzXML&quot;, &quot;mzML&quot;, &quot;mz5&quot;, &quot;mgf&quot;, &quot;text&quot;, &quot;ms1&quot;, &quot;cms1&quot;, &quot;ms2&quot;, &quot;cms2&quot;</span></span><br><span class=\"line\">    binary_encoding_precision <span class=\"operator\">=</span> <span class=\"string\">&quot;64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    zlib <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    write_index <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    peak_picking_algorithm <span class=\"operator\">=</span> <span class=\"string\">&quot;cwt&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;vendor&quot; or &quot;cwt&quot;</span></span><br><span class=\"line\">    vendor_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 当前调用的是cwt，此参数可能无效</span></span><br><span class=\"line\">    cwt_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 如此设置即可</span></span><br><span class=\"line\">    cwt_min_snr <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum signal-to-noise ratio，设为0.1即可</span></span><br><span class=\"line\">    cwt_min_peak_spacing <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum peak spacing，设为0.1即可</span></span><br><span class=\"line\">    subset_polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;any&quot;, &quot;positive&quot; or &quot;negative&quot;，根据模式选择</span></span><br><span class=\"line\">    subset_scan_number <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"literal\">NA</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_scan_time <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">60</span><span class=\"punctuation\">,</span> <span class=\"number\">300</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_mode <span class=\"operator\">=</span> <span class=\"string\">&quot;removeExtra&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;no&quot;, &quot;removeExtra&quot;, or &quot;addMissing&quot;</span></span><br><span class=\"line\">    zero_samples_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_add_missing_flanking_zero_count <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"comment\"># 默认5即可</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"开始转换\"><a href=\"#开始转换\" class=\"headerlink\" title=\"开始转换\"></a>开始转换</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">convert_raw_data<span class=\"punctuation\">(</span>input_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/raw_data&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 output_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/mzxml&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 msconvert_parameter <span class=\"operator\">=</span> parameter<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 docker_parameters <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                 process_all <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"安装tidyMass\"><a href=\"#安装tidyMass\" class=\"headerlink\" title=\"安装tidyMass\"></a>安装<a href=\"https://tidymass.tidymass.org/\">tidyMass</a></h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mamba install gcc_linux-64 gxx_linux-64 gfortran_linux-64</span><br><span class=\"line\">mamba install bioconductor-msnbase bioconductor-rdisop r-openxlsx bioconductor-mzr bioconductor-xcms r-rvest r-tidyr r-stringi r-tidyversedyve r-hexbin</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/masstools&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/tidymass&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"原始数据处理\"><a href=\"#原始数据处理\" class=\"headerlink\" title=\"原始数据处理\"></a>原始数据处理</h2><p>调用<a href=\"https://massprocesser.tidymass.org/\">massprocesser</a>包进行原始数据处理，进行峰检测与对齐，输出peak table包括：<br>原始数据导入（read spectra from file）、峰检测（detect mass traces &amp; detect  chromatographic peaks）、校正保留时间（Correcting rentention time）、对已鉴定的色谱峰进行保留时间校正、Grouping peaks across samples、输出peak table。</p>\n<p><strong>数据目录结构</strong></p>\n<ul>\n<li>mzxml&#x2F;mzxml_ms1_data&#x2F;<ul>\n<li>POS&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n<li>NEG&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>mzxml&#x2F;mgf_ms2_data&#x2F;mgf_ms2_data&#x2F;<ul>\n<li>POS&#x2F;*.mgf</li>\n<li>NEG&#x2F;*.mgf</li>\n</ul>\n</li>\n<li>mzxml&#x2F;sample_info&#x2F;<ul>\n<li>sample_info_pos.csv</li>\n<li>sample_info_neg.csv</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"正离子模式\"><a href=\"#正离子模式\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><p><font color=#FF0000>注意：path指定的路径名不可以数字开头！</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/POS&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 路径根据实际情况定</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ppm</strong>：numeric defining the maximal tolerated m&#x2F;z deviation in consecutive scans in parts per million (ppm) for the initial regions-of-interest (ROI)  definition。<font color=#FF0000>此处的ppm来源于xcms包，但在xcms中不同的函数中，含义貌似不一样，需进一步确认。</font></li>\n<li><strong>peakwith</strong>：峰宽，取决于柱子（column）和LC系统。numeric(2) with the expected approximate peak width in chromatographic space. Given as a range (min, max) in seconds.</li>\n<li><strong>min_fraction</strong>：如果一个峰出现在至少一组样本中<code>min_fraction</code>样本以上（按比例），则将保留该峰值。</li>\n<li><strong>snthresh</strong> ：信噪比阈值。</li>\n<li><strong>prefilter</strong>：c(k, I) 在第一次分析步骤（ROI检测）中指定预筛选步骤。仅保留包含至少强度&gt;&#x3D;I的k个峰的的质量轨迹（Mass traces）。</li>\n<li><strong>fitgauss</strong> ：是否应对每个峰拟合高斯分布。主要影响峰的保留时间位置。</li>\n<li><strong>integrate</strong>：积分方法（1或2）。对于 integrate&#x3D;1，Peak limits通过在mexican hat 过滤后的数据上下降（descent）来确定；而对于 integrate&#x3D;2，则在原始数据上进行下降处理。后一种方法更准确但容易受到噪声的影响，而前一种方法更稳健但不太精确。</li>\n<li><strong>mzdiff</strong> ：representing the minimum difference in m&#x2F;z dimension required for peaks with overlapping retention times; can be negative to allow overlap. During peak post-processing, peaks defined to be overlapping are reduced to the one peak with the largest signal.</li>\n<li><strong>noise</strong>：设定第一步分析中需要的质心（centroids ）最小强度（intensity &lt; noise的质心将被省略在感兴趣区域检测之外）。</li>\n<li><strong>binSize</strong> ：将m&#x2F;z轴按照binSize划分为多个区间，再对各区间内的离子信号进行聚合。较小的binSize使得峰检测更加准确，检测到更多features，需要更多计算资源。</li>\n<li><strong>bw</strong>：带宽，通常在5-50间，这是用于峰值检测的核密度估计 （KDE） 算法中使用的参数。bw 控制估计的 KDE 曲线的平滑度，并确定峰的解析程度。较小的bw值将产生更详细的基础峰形表示，在紧密间隔或重叠的峰之间具有更好的分辨率，但也可能产生更高水平的噪声。相反，较大的bw值将导致对峰形的估计更平滑、更广义，这有助于降低噪声和杂散检测，但在某些情况下也可能导致峰分辨率降低。bw 值的选择将取决于所分析数据的具体特征以及分析的目标。通常，有必要试验一系列 bw 值，以找到给定数据集的最佳设置。</li>\n<li><strong>fill_peaks</strong>：Fill peaks NA or not。</li>\n</ul>\n<p><strong>结果</strong>：</p>\n<ul>\n<li><p>POS&#x2F;Result&#x2F;</p>\n<ul>\n<li><p>object：用于下一步分析</p>\n</li>\n<li><p>Peak_table.csv：用于下一步分析的峰表</p>\n</li>\n<li><p>Peak_table_for_cleaning.csv：删除了<code>Peak_table.csv</code>中无用的列，可直接用于后续的数据清洗</p>\n</li>\n<li><p>BPC.pdf：Base peak chromatogram，仅展示<code>group_for_figure</code>参数指定组内的样本<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"BPC.pdf\"></p>\n</li>\n<li><p>TIC.pdf：Total ion peak chromatogram，经色谱分离流出的组分不断进入质谱，质谱连续扫描采集数据，每一次扫描得到一张质谱图，将每一张质谱图中所有离子强度相加得到总离子流强度。然后以总离子强度为纵坐标，时间为横坐标绘图。<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"TIC.pdf\"></p>\n</li>\n<li><p>RT correction plot.pdf<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"RT correction plot.pdf\"></p>\n</li>\n<li><p>intermediate_data：中间文件目录，如果需要重新运行data processing，则需先删除该目录。</p>\n</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取互动图，在Rstudio中才能显示</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/intermediate_data/xdata2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot <span class=\"operator\">=</span> massprocesser<span class=\"operator\">::</span>plot_adjusted_rt<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> xdata2<span class=\"punctuation\">,</span> group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">interactive</span> <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"负离子模式\"><a href=\"#负离子模式\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">massprocesser<span class=\"operator\">::</span>process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/NEG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Explore-data\"><a href=\"#Explore-data\" class=\"headerlink\" title=\"Explore data\"></a>Explore data</h2><p>将peak table和样本信息（元数据）整合，得到<code>mass_dataset</code> class对象。获取数据的总结信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"样本信息表示例 sample_info_pos.csv\"></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"正离子模式-1\"><a href=\"#正离子模式-1\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_pos <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_pos.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  查看object_pos中的元数据</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12  Case Subject               6</span></span><br><span class=\"line\"><span class=\"comment\">#?? 为何还没整合的情况下object_pos中就存在了部分元数据列？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除object_pos中的&quot;group&quot;, &quot;class&quot;, &quot;injection.order&quot;</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_pos 中的所有列整合到object_pos 中</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看元数据信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/peak_distributation_plot_positive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span>hex <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 786005</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      4017       2713       4064       2981       2920       3846</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T73_POS  M70T53_POS M70T183_POS M70T527_POS M71T695_POS M71T183_POS</span></span><br><span class=\"line\"><span class=\"comment\">#        129          16         155          54         133         169</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> show_row_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;mz&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"峰分布图\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各variable的缺失值数量\"><br>黑色代表缺失值。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各样本的缺失值比例\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"各variable的缺失值比例\"></p>\n<h3 id=\"负离子模式-1\"><a href=\"#负离子模式-1\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_neg <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_neg.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12  Case Subject               6</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_neg添加至object_neg</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/peak_distributation_plot_negtive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 748237</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      3029       2766       3298       3100       2912       3053</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T712_NEG M70T527_NEG M70T587_NEG  M70T47_NEG M71T587_NEG M71T641_NEG</span></span><br><span class=\"line\"><span class=\"comment\">#         16         137           2         146          41          19</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据清洗（Data-cleaning）\"><a href=\"#数据清洗（Data-cleaning）\" class=\"headerlink\" title=\"数据清洗（Data cleaning）\"></a>数据清洗（Data cleaning）</h2><h3 id=\"查看质量\"><a href=\"#查看质量\" class=\"headerlink\" title=\"查看质量\"></a>查看质量</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载数据</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将批次号改为字符串</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 先评估数据质量</span></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"正离子PCA\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"负离子PCA\"><br><font color=\"#FF0000\">从上两图可看出正离子模式下存在严重的批次效应，负离子模式下不存在明显的批次效应。</font></p>\n<h3 id=\"开始清洗\"><a href=\"#开始清洗\" class=\"headerlink\" title=\"开始清洗\"></a>开始清洗</h3><h4 id=\"移除噪音代谢features——缺失值过滤。\"><a href=\"#移除噪音代谢features——缺失值过滤。\" class=\"headerlink\" title=\"移除噪音代谢features——缺失值过滤。\"></a>移除噪音代谢features——缺失值过滤。</h4><p>移除超过20% QC样本中含有MVs以及至少在50%实验组或对照组样本中含有MVs的variables。</p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1  M70T73_POS 70.04074  73.31705 0.28205128 0.6000000 0.4727273</span></span><br><span class=\"line\"><span class=\"comment\">#2  M70T53_POS 70.06596  52.78542 0.00000000 0.1454545 0.0000000</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T183_POS 70.19977 182.87981 0.00000000 0.6636364 0.7454545</span></span><br><span class=\"line\"><span class=\"comment\">#4 M70T527_POS 70.36113 526.76657 0.02564103 0.1818182 0.3000000</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T695_POS 70.56911 694.84592 0.02564103 0.6454545 0.5545455</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T183_POS 70.75034 182.77790 0.05128205 0.7272727 0.7909091</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos</span><br></pre></td></tr></table></figure>\n\n<p> <strong>注</strong>：na_freq、na_freq.1和na_freq.2在此处分别代表某variables 在QC样本、对照组样本和实验组样本中缺失值MV所占的百分比。</p>\n<p> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"MVpercentQC\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1 M70T712_NEG 70.05911 711.97894 0.05128205 0.109090909 0.018181818</span></span><br><span class=\"line\"><span class=\"comment\">#2 M70T527_NEG 70.13902 526.85416 0.33333333 0.509090909 0.618181818</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T587_NEG 70.31217 587.25330 0.00000000 0.009090909 0.009090909</span></span><br><span class=\"line\"><span class=\"comment\">#4  M70T47_NEG 70.33835  46.57537 0.84615385 0.936363636 0.090909091</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T587_NEG 70.56315 587.02570 0.17948718 0.145454545 0.163636364</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T641_NEG 70.70657 641.16672 0.10256410 0.063636364 0.072727273</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"过滤离群样本（Filter-outlier-samples）\"><a href=\"#过滤离群样本（Filter-outlier-samples）\" class=\"headerlink\" title=\"过滤离群样本（Filter outlier samples）\"></a>过滤离群样本（Filter outlier samples）</h4><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除离群样本，如果有的话</span></span><br><span class=\"line\">need_id_pos <span class=\"operator\">&lt;-</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `==`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> need_id_pos<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"MVpercentALL\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"缺失值填充（Missing-value-imputation）\"><a href=\"#缺失值填充（Missing-value-imputation）\" class=\"headerlink\" title=\"缺失值填充（Missing value imputation）\"></a>缺失值填充（Missing value imputation）</h2><p>对原始数据中的缺失值进行模拟（missing value recoding）。方法包括：”knn”, “rf” (missForest), “mean”, “median”, “zero”, “minimum”, “bpca”, “svdImpute”, “ppca”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取正离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 148907</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取负离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 146409</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据标准化与整合（Data-normalization-and-integration）\"><a href=\"#数据标准化与整合（Data-normalization-and-integration）\" class=\"headerlink\" title=\"数据标准化与整合（Data normalization and integration）\"></a>数据标准化与整合（Data normalization and integration）</h2><p>数据标准化处理， 利用内标（internal standard, IS）进行归一化<font color=\"#FF0000\">待确认是否通过IS实现</font>。</p>\n<ul>\n<li><p>正离子模式</p>\n<p>标准化方法包括：”svr”, “total”, “median”, “mean”, “pqn”, “loess”；整合方法包括：”qc_mean”, “qc_median”, “subject_mean”, “subject_median”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"标准化后正离子PCA\"></p>\n<ul>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"标准化后负离子PCA\"></p>\n<p><strong>保存数据</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代谢物注释\"><a href=\"#代谢物注释\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h2><h3 id=\"加载数据\"><a href=\"#加载数据\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将MS2数据添加到mass-dataset\"><a href=\"#将MS2数据添加到mass-dataset\" class=\"headerlink\" title=\"将MS2数据添加到mass_dataset\"></a>将MS2数据添加到mass_dataset</h3><p><strong>如果没有MS2数据，此步不执行应该也可以！</strong><br><font color=\"#FF0000\">？？只有QC样的MS2数据，MS2数据是怎么来的？</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># rp or hilic，对应RPLC（反相色谱）和HILIC（亲水相互作用色谱）</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span><span class=\"comment\"># ppm</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span><span class=\"comment\"># seconds</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/POS&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1043 out of 5101 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/NEG&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1092 out of 4104 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"代谢物注释-1\"><a href=\"#代谢物注释-1\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h3><p><font color=#FF0000>需要考虑数据库是RPLC还是HILIC。</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/snyder_database_rplc0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">snyder_database_rplc0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/orbitrap_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">orbitrap_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/mona_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">mona_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>annotate_metabolites_mass_dataset 参数解析</strong>：</p>\n<ul>\n<li><strong>ms1.match.ppm</strong>：Precursor match ppm tolerance [25].</li>\n<li><strong>ms2.match.ppm</strong>：Fragment ion match ppm tolerance [30].</li>\n<li><strong>mz.ppm.thr</strong>：Accurate mass tolerance for m&#x2F;z error calculation [400].</li>\n<li><strong>ms2.match.tol</strong>：MS2 match (MS2 similarity) tolerance [0.5].</li>\n<li><strong>fraction.weight</strong>：The weight for matched fragments [0.3].</li>\n<li><strong>dp.forward.weight</strong>：Forward dot product weight [0.6].</li>\n<li><strong>dp.reverse.weight</strong>：Reverse dot product weight [0.1].</li>\n<li><strong>remove_fragment_intensity_cutoff</strong>：remove_fragment_intensity_cutoff [0].</li>\n<li><strong>rt.match.tol</strong>：RT match tolerance [30].</li>\n<li><strong>polarity</strong>：The polarity of data, “positive”or “negative”.</li>\n<li><strong>ce</strong>：Collision energy. Please confirm the CE values in your database. [all].</li>\n<li><strong>column</strong>：”hilic” (HILIC column) or “rp” (reverse phase).</li>\n<li><strong>ms1.match.weight</strong>：The weight of MS1 match for total score calculation [0.25].</li>\n<li><strong>rt.match.weight</strong>：The weight of RT match for total score calculation [0.25].</li>\n<li><strong>ms2.match.weight</strong>：The weight of MS2 match for total score calculation [0.5]</li>\n<li><strong>total.score.tol</strong>：Total score tolerance. The total score are referring to MS-DIAL [0.5]</li>\n<li><strong>candidate.num</strong>：The number of candidate [3]</li>\n</ul>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"查看注释结果\"><a href=\"#查看注释结果\" class=\"headerlink\" title=\"查看注释结果\"></a>查看注释结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>extract_annotation_table<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">variable_info_pos <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>variable_info_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Level<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Database<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"保存数据\"><a href=\"#保存数据\" class=\"headerlink\" title=\"保存数据\"></a>保存数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"统计分析\"><a href=\"#统计分析\" class=\"headerlink\" title=\"统计分析\"></a>统计分析</h2><h3 id=\"加载数据-1\"><a href=\"#加载数据-1\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"移除未被注释的features\"><a href=\"#移除未被注释的features\" class=\"headerlink\" title=\"移除未被注释的features\"></a>移除未被注释的features</h3><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> object_pos2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> object_neg2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"合并POS和NEG数据\"><a href=\"#合并POS和NEG数据\" class=\"headerlink\" title=\"合并POS和NEG数据\"></a>合并POS和NEG数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># inner merge for samples and full merge for variables</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">merge_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    x <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    y <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    sample_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;inner&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用inner较合理</span></span><br><span class=\"line\">    variable_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;full&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用full合理</span></span><br><span class=\"line\">    sample_by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># merge samples by what columns from sample_info</span></span><br><span class=\"line\">    variable_by <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;variable_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;mz&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rt&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\"># merge variables by what columns from variable_info</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<p><strong>名词解释：</strong></p>\n<ul>\n<li>**左连接 (Left join)**：将左表中的所有记录都保留下来，而右表中与左表中记录没有匹配的部分则丢弃。</li>\n<li>**右连接 (Right join)**：将右表中的所有记录都保留下来，而左表中与右表中记录没有匹配的部分则丢弃。</li>\n<li>**内连接 (Inner join)**：只有两个表中都存在的记录才保留下来，否则丢弃。</li>\n<li>**全连接 (Full join)**：将左表和右表中的所有记录都保留下来，如果某个表中的记录没有匹配到另一个表中的记录，则用NULL填充。</li>\n</ul>\n<h3 id=\"Trace-processing-information-of-object\"><a href=\"#Trace-processing-information-of-object\" class=\"headerlink\" title=\"Trace processing information of object\"></a>Trace processing information of object</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">report_parameters<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"基于level和score移除冗余注释代谢物\"><a href=\"#基于level和score移除冗余注释代谢物\" class=\"headerlink\" title=\"基于level和score移除冗余注释代谢物\"></a>基于level和score移除冗余注释代谢物</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>Compound.name<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><font color=#FF0000>为何要选最小的level？SS是什么score？</font></p>\n<h3 id=\"样本聚类\"><a href=\"#样本聚类\" class=\"headerlink\" title=\"样本聚类\"></a>样本聚类</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 排除QC样本</span></span><br><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>group <span class=\"operator\">!=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Samples_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"样本聚类热图\"></p>\n<h3 id=\"差异表达代谢物\"><a href=\"#差异表达代谢物\" class=\"headerlink\" title=\"差异表达代谢物\"></a>差异表达代谢物</h3><p><font color=#FF0000>如果有多组数据，需要适当增加相应下述代码。“mutate_fc”的逻辑是每运行一次，则在object中增加一列“fc”，当有多个实验组时，可以将先前生成的fc重命名，因此，object中可以包含多个组间比较的fc结果。</font></p>\n<ul>\n<li><p>计算变化倍数</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取对照组样本名列表</span></span><br><span class=\"line\">control_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取实验组样本名列表</span></span><br><span class=\"line\">case_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，参照以上格式在此列出，假设有实验组Case2</span></span><br><span class=\"line\">case2_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case2&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\">#可选&quot;mean&quot;, &quot;median&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case1_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case1_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较，此处计算Case2与Control</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case2_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case2_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>计算p值<br><font color=\"#FF0000\">同理，当有多个实验组时，也可以分别计算p值，并将默认的列名“p_value”和“p_value_adjust”重命名，以在object中容纳多组相互比较的p值。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;t.test&quot;, &quot;wilcox.test&quot;</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"comment\"># &quot;holm&quot;, &quot;hochberg&quot;, &quot;hommel&quot;, &quot;bonferroni&quot;, &quot;BH&quot;, &quot;BY&quot;, &quot;fdr&quot;, &quot;none&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case1_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case1_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"comment\">#! 假设存在Case2组</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case2_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case2_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制火山图</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span></span><br><span class=\"line\">      object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">      fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t  fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  </span><br><span class=\"line\">  p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">  dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"火山图\"></p>\n<p><font color=\"#FF0000\">假设存在Case2，绘制火山图。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano2.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\"> fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"> p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">           point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">)</span> <span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"></span><br><span class=\"line\">p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"保存结果\"><a href=\"#保存结果\" class=\"headerlink\" title=\"保存结果\"></a>保存结果</h3><ul>\n<li><p>保存差异表达代谢物结果。如果有多个实验组，则将下述代码中的“fc”和“p_value_adjust”更改为重命名后的名称，并分别保存到不同的文件中。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">differential_metabolites <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>fc <span class=\"operator\">&gt;</span> <span class=\"number\">2</span> <span class=\"operator\">|</span> fc <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">readr<span class=\"operator\">::</span>write_csv<span class=\"punctuation\">(</span>differential_metabolites<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/differential_metabolites.csv&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>保存结果对象</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_final <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_final<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"绘制热图\"><a href=\"#绘制热图\" class=\"headerlink\" title=\"绘制热图\"></a>绘制热图</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">,</span> case_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> differential_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/diff_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  row_labels <span class=\"operator\">=</span> extract_variable_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>Compound.name<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  border <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>  <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"显著差异代谢物热图\"></p>\n<h2 id=\"代谢通路富集\"><a href=\"#代谢通路富集\" class=\"headerlink\" title=\"代谢通路富集\"></a>代谢通路富集</h2><h3 id=\"导入数据\"><a href=\"#导入数据\" class=\"headerlink\" title=\"导入数据\"></a>导入数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"富集\"><a href=\"#富集\" class=\"headerlink\" title=\"富集\"></a>富集</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">diff_metabolites <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  extract_variable_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>diff_metabolites<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"加载KEGG-human-pathway数据库\"><a href=\"#加载KEGG-human-pathway数据库\" class=\"headerlink\" title=\"加载KEGG human pathway数据库\"></a>加载KEGG human pathway数据库</h3><p><font color=#FF0000>可选数据库：kegg_hsa_pathway，keggMS1database，query_id_kegg，hmdb_pathway，hmdbMS1Database，query_id_hmdb。</font></p>\n<p><strong>？？这些数据库的区别是什么？</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data<span class=\"punctuation\">(</span><span class=\"string\">&quot;kegg_hsa_pathway&quot;</span><span class=\"punctuation\">,</span> package <span class=\"operator\">=</span> <span class=\"string\">&quot;metpath&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">kegg_hsa_pathway</span><br><span class=\"line\"></span><br><span class=\"line\">get_pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除疾病相关通路!根据课题选择是否移除？</span></span><br><span class=\"line\">pathway_class <span class=\"operator\">=</span> metpath<span class=\"operator\">::</span>pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>pathway_class<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">remain_idx <span class=\"operator\">=</span> pathway_class <span class=\"operator\">%&gt;%</span> unlist<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> stringr<span class=\"operator\">::</span>str_detect<span class=\"punctuation\">(</span><span class=\"string\">&quot;Disease&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `!`<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pathway_database <span class=\"operator\">=</span> kegg_hsa_pathway<span class=\"punctuation\">[</span>remain_idx<span class=\"punctuation\">]</span></span><br><span class=\"line\">pathway_database</span><br><span class=\"line\"></span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  diff_metabolites<span class=\"operator\">$</span>KEGG.ID </span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  kegg_id<span class=\"punctuation\">[</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>kegg_id<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">result <span class=\"operator\">&lt;-</span> enrich_kegg<span class=\"punctuation\">(</span></span><br><span class=\"line\">    query_id <span class=\"operator\">=</span> kegg_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    query_type <span class=\"operator\">=</span> <span class=\"string\">&quot;compound&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    id_type <span class=\"operator\">=</span> <span class=\"string\">&quot;KEGG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pathway_database <span class=\"operator\">=</span> pathway_database<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    threads <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">result</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>result<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/result&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"绘制结果\"><a href=\"#绘制结果\" class=\"headerlink\" title=\"绘制结果\"></a>绘制结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  bar plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/barplot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_bar_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> x_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># scatter plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/scatter_plot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_scatter_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> y_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> y_axis_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\">tiff<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/network.tiff&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_network<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> point_size <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> only_significant_pathway <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集bar plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集scatter plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"KEGG富集network\"></p>\n<h2 id=\"Correlation-network-analysis\"><a href=\"#Correlation-network-analysis\" class=\"headerlink\" title=\"Correlation network analysis\"></a>Correlation network analysis</h2><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> diff_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidygraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">graph_data <span class=\"operator\">&lt;-</span> convert_mass_dataset2graph<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    margin <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_adjust_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pos_cor_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    neg_cor_cutoff <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">0.7</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  mutate<span class=\"punctuation\">(</span>Degree <span class=\"operator\">=</span> centrality_degree<span class=\"punctuation\">(</span>mode <span class=\"operator\">=</span> <span class=\"string\">&#x27;all&#x27;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>extrafont<span class=\"punctuation\">)</span></span><br><span class=\"line\">loadfonts<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>showtext<span class=\"punctuation\">)</span></span><br><span class=\"line\">showtext_auto<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">ggraph<span class=\"punctuation\">(</span>graph <span class=\"operator\">=</span> graph_data<span class=\"punctuation\">,</span> layout <span class=\"operator\">=</span> <span class=\"string\">&quot;kk&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_edge_fan<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>color <span class=\"operator\">=</span> correlation<span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"comment\">#width = -log((p_adjust+0.1), 10)),</span></span><br><span class=\"line\">                show.legend <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_node_point<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> Degree<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  shadowtext<span class=\"operator\">::</span>geom_shadowtext<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>x <span class=\"operator\">=</span> x<span class=\"punctuation\">,</span> y <span class=\"operator\">=</span> y<span class=\"punctuation\">,</span></span><br><span class=\"line\">                                  label <span class=\"operator\">=</span> Compound.name<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              bg.colour <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              colour <span class=\"operator\">=</span> <span class=\"string\">&quot;black&quot;</span><span class=\"punctuation\">)</span><span class=\"operator\">+</span></span><br><span class=\"line\">  theme_graph<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  scale_edge_color_gradient2<span class=\"punctuation\">(</span>low <span class=\"operator\">=</span> <span class=\"string\">&quot;darkblue&quot;</span><span class=\"punctuation\">,</span> mid <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span> high <span class=\"operator\">=</span> <span class=\"string\">&quot;red&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ggsave<span class=\"punctuation\">(</span>plot<span class=\"punctuation\">,</span> filename <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/cor_network.pdf&quot;</span><span class=\"punctuation\">,</span> width <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span> height <span class=\"operator\">=</span> <span class=\"number\">7</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png\" class=\"lazyload placeholder\" data-srcset=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"代谢物Correlation network\"></p>\n<h1 id=\"术语\"><a href=\"#术语\" class=\"headerlink\" title=\"术语\"></a>术语</h1><ul>\n<li><strong>HILIC</strong>（亲水相互作用色谱）&amp; <strong>RPLC</strong>（反相色谱）：RPLC 色谱柱主要使用非极性固定相（C18、C8 等），而 HILIC 色谱柱则使用极性固定相（二氧化硅、酰胺等）。两种技术采用的流动相通常由乙腈和水组成，这使得两种液相色谱模式之间可以实现轻松切换。HILIC 和 RPLC 流动相的主要区别在于溶剂洗脱强度。对于 RPLC，乙腈是强洗脱溶剂。但对于HILIC，水是强洗脱溶剂。对于 RPLC，得到的色谱图通常是极性分析物到非极性分析物，而 HILIC 则相反。这种相反的洗脱顺序使 HILIC 成为更常用的 RPLC 的一个很好的补充技术。对于极性分析物和离子化分析物尤其如此，它们在 HILIC 模式下的保留时间更长。</li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://www.bioengx.com/%E8%B4%A8%E8%B0%B1%E5%88%86%E6%9E%90%E6%9C%AF%E8%AF%AD%E6%9C%80%E5%85%A8%E8%A7%A3%E8%AF%BB/\">质谱分析术语最全解读</a></li>\n<li><a href=\"https://www.tidymass.org/start/whole_workflow/\">Whole workflow using tidymass</a></li>\n<li><a href=\"https://www.agilent.com/cs/library/applications/application-note-hilic%20versus-rplc-5994-1137zh-cn-agilent.pdf\">极性分子的保留和分离 ― 关于何时使用 HILIC 与反相液相色谱柱的详细研究</a></li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","more":"<h1 id=\"代谢组学常用仪器特点\"><a href=\"#代谢组学常用仪器特点\" class=\"headerlink\" title=\"代谢组学常用仪器特点\"></a>代谢组学常用仪器特点</h1><table border=\"1\">\n<tr>\n<th>仪器</th>\n<th>特点</th>\n</tr>\n<tr>\n<td>GC-MS</td>\n<td>易挥发，低极性，热稳定的小分子化合物；需衍生化</td>\n</tr>\n<tr>\n<td>LC-MS</td>\n<td>具有一定极性的有机化合物；无需衍生化</td>\n</tr>\n<tr>\n<td>NMR</td>\n<td>无偏性，无损检测；•无需繁琐前处理，便于活体、原位的动态检测</td>\n</tr>\n<tr>\n<td>CE-MS</td>\n<td>高极性化合物，如核酸，蛋白等</td>\n</tr>\n<tr>\n<td>ICP-MS</td>\n<td>无机化合物</td>\n</tr>\n</table>\n\n<h1 id=\"LC-QTOF原理\"><a href=\"#LC-QTOF原理\" class=\"headerlink\" title=\"LC-QTOF原理\"></a>LC-QTOF原理</h1><p>Q-TOF全称为四极飞行时间质谱仪（Quadrupole Time-of-Flight Mass Spectrometer）。其基本原理是将样品离子通过四极杆进行质量筛选，然后进入飞行时间质谱器（Time-of-Flight Mass Analyzer，ToF），测定其离子的飞行时间，从而得到样品中离子的质量信息。Q-TOF有正离子模式（positive ion mode, POS）和负离子模式（negative ion mode, NEG）两种电离方式，在检测代谢组时结合使用两种方式可以使代谢物覆盖率更高，检测效果也更好。</p>\n<p>Q-TOF的工作过程包含以下步骤：</p>\n<p><strong>离子化</strong>：样品通过电喷雾或者MALDI等方法被电离成为离子。</p>\n<p><strong>生成离子束</strong>：离子经过引出阱、加速器、光栅偏转镜等装置，形成一个带电的离子束。</p>\n<p><strong>四极杆质量筛选</strong>：离子束进入四极杆，通过高频交变电压（RF）和直流电压（DC）的控制，将不同质量的离子分离出来。</p>\n<p><strong>飞行时间质谱分析</strong>：通过激光或者其他方法对分散的离子束施加助推、聚焦和分析，并且测定其到达检测器所需的时间。不同质量的离子抵达检测器所需要的时间不同，从而可以得到离子的质量信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/custom/metabolomics/LC-QTOF.png\" alt=\"LC-QTOF原理\"><br><font color=\"#FF0000\"><strong>FAQ</strong>：POS和NEG数据的利用。</font><br>负离子和正离子是数据采集时的时候的两种模式生成两套数据，一级分析（MS）结果中是提供 POS 和 NEG 两个检测结果列表的，但是在二级分析（MSMS）结果中，我们将鉴定正负离子模式下鉴定到的物质进行了合并，所以二级分析是针对代谢物来做的，不区分正负离子模式。</p>\n<p><font color=\"#FF0000\"><strong>FAQ</strong>: 当正负离子模式下都检测到了某种物质，如何对该物质的结果进行呈现？</font><br>会根据匹配参数进行取舍，选用匹配参数更好的模式下的数据在二级结果中进行分析。</p>\n<h1 id=\"数据分析\"><a href=\"#数据分析\" class=\"headerlink\" title=\"数据分析\"></a>数据分析</h1><h2 id=\"下机数据格式转换\"><a href=\"#下机数据格式转换\" class=\"headerlink\" title=\"下机数据格式转换\"></a>下机数据格式转换</h2><p>以下两个软件二选一，Windows下建议使用ProteoWizard，其用法可参考<a href=\"https://liaochenlanruo.fun/post/df57.html\">用metid构建代谢组数据库</a>。Linux下建议使用massconverter。</p>\n<h3 id=\"ProteoWizard\"><a href=\"#ProteoWizard\" class=\"headerlink\" title=\"ProteoWizard\"></a><a href=\"https://github.com/ProteoWizard\">ProteoWizard</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h3 id=\"massconverter\"><a href=\"#massconverter\" class=\"headerlink\" title=\"massconverter\"></a><a href=\"https://tidymass.github.io/massconverter/\">massconverter</a></h3><p>将raw data转换为<code>mzXML</code>格式。</p>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/massconverter&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取pwiz</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>massconverter<span class=\"punctuation\">)</span></span><br><span class=\"line\">docker_pull_pwiz<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><strong>Debug</strong>：如果报错<code>Error in docker_pull_pwiz() :   Please install docker first (https://www.docker.com/get-started)</code>，则首先确认系统是否已安装docker，如果未安装，请先安装docker；如已经安装，则是因为普通用户无运行docker的权限，将其添加到docker用户组中即可。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">root模式下运行如下shell命令，将用户lhl添加到docker组中</span></span><br><span class=\"line\">gpasswd -a lhl docker</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启docker生效</span></span><br><span class=\"line\">service docker restart</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"设置转换参数\"><a href=\"#设置转换参数\" class=\"headerlink\" title=\"设置转换参数\"></a>设置转换参数</h4><p>此处调用MSConvert进行格式转换，期间进行了过滤，主要采用了<code>Peak Picking</code>，<code>Subset</code>，和<code>Zero Samples</code>方法。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameter <span class=\"operator\">=</span></span><br><span class=\"line\">  massconverter<span class=\"operator\">::</span>create_msconvert_parameter<span class=\"punctuation\">(</span></span><br><span class=\"line\">    output_format <span class=\"operator\">=</span> <span class=\"string\">&quot;mzXML&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;mzXML&quot;, &quot;mzML&quot;, &quot;mz5&quot;, &quot;mgf&quot;, &quot;text&quot;, &quot;ms1&quot;, &quot;cms1&quot;, &quot;ms2&quot;, &quot;cms2&quot;</span></span><br><span class=\"line\">    binary_encoding_precision <span class=\"operator\">=</span> <span class=\"string\">&quot;64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    zlib <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    write_index <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    peak_picking_algorithm <span class=\"operator\">=</span> <span class=\"string\">&quot;cwt&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;vendor&quot; or &quot;cwt&quot;</span></span><br><span class=\"line\">    vendor_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 当前调用的是cwt，此参数可能无效</span></span><br><span class=\"line\">    cwt_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># 如此设置即可</span></span><br><span class=\"line\">    cwt_min_snr <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum signal-to-noise ratio，设为0.1即可</span></span><br><span class=\"line\">    cwt_min_peak_spacing <span class=\"operator\">=</span> <span class=\"number\">0.1</span><span class=\"punctuation\">,</span><span class=\"comment\"># minimum peak spacing，设为0.1即可</span></span><br><span class=\"line\">    subset_polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;any&quot;, &quot;positive&quot; or &quot;negative&quot;，根据模式选择</span></span><br><span class=\"line\">    subset_scan_number <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"literal\">NA</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_scan_time <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">60</span><span class=\"punctuation\">,</span> <span class=\"number\">300</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Can be c(NA, NA) if don&#x27;t use this</span></span><br><span class=\"line\">    subset_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_mode <span class=\"operator\">=</span> <span class=\"string\">&quot;removeExtra&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;no&quot;, &quot;removeExtra&quot;, or &quot;addMissing&quot;</span></span><br><span class=\"line\">    zero_samples_mslevels <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"literal\">NA</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span><span class=\"comment\"># A two numeric vector. Second can be set as NA</span></span><br><span class=\"line\">    zero_samples_add_missing_flanking_zero_count <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"comment\"># 默认5即可</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"开始转换\"><a href=\"#开始转换\" class=\"headerlink\" title=\"开始转换\"></a>开始转换</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">convert_raw_data<span class=\"punctuation\">(</span>input_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/raw_data&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 output_path <span class=\"operator\">=</span> <span class=\"string\">&quot;demo_data/mzxml&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 msconvert_parameter <span class=\"operator\">=</span> parameter<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                 docker_parameters <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                 process_all <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"安装tidyMass\"><a href=\"#安装tidyMass\" class=\"headerlink\" title=\"安装tidyMass\"></a>安装<a href=\"https://tidymass.tidymass.org/\">tidyMass</a></h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mamba install gcc_linux-64 gxx_linux-64 gfortran_linux-64</span><br><span class=\"line\">mamba install bioconductor-msnbase bioconductor-rdisop r-openxlsx bioconductor-mzr bioconductor-xcms r-rvest r-tidyr r-stringi r-tidyversedyve r-hexbin</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span><span class=\"punctuation\">(</span><span class=\"operator\">!</span>require<span class=\"punctuation\">(</span>remotes<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">install.packages<span class=\"punctuation\">(</span><span class=\"string\">&quot;remotes&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/masstools&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">remotes<span class=\"operator\">::</span>install_github<span class=\"punctuation\">(</span><span class=\"string\">&quot;tidymass/tidymass&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"原始数据处理\"><a href=\"#原始数据处理\" class=\"headerlink\" title=\"原始数据处理\"></a>原始数据处理</h2><p>调用<a href=\"https://massprocesser.tidymass.org/\">massprocesser</a>包进行原始数据处理，进行峰检测与对齐，输出peak table包括：<br>原始数据导入（read spectra from file）、峰检测（detect mass traces &amp; detect  chromatographic peaks）、校正保留时间（Correcting rentention time）、对已鉴定的色谱峰进行保留时间校正、Grouping peaks across samples、输出peak table。</p>\n<p><strong>数据目录结构</strong></p>\n<ul>\n<li>mzxml&#x2F;mzxml_ms1_data&#x2F;<ul>\n<li>POS&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n<li>NEG&#x2F;<ul>\n<li>Case&#x2F;*.mzXML</li>\n<li>Control&#x2F;*.mzXML</li>\n<li>QC&#x2F;*.mzXML</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>mzxml&#x2F;mgf_ms2_data&#x2F;mgf_ms2_data&#x2F;<ul>\n<li>POS&#x2F;*.mgf</li>\n<li>NEG&#x2F;*.mgf</li>\n</ul>\n</li>\n<li>mzxml&#x2F;sample_info&#x2F;<ul>\n<li>sample_info_pos.csv</li>\n<li>sample_info_neg.csv</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"正离子模式\"><a href=\"#正离子模式\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><p><font color=#FF0000>注意：path指定的路径名不可以数字开头！</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/POS&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 路径根据实际情况定</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>ppm</strong>：numeric defining the maximal tolerated m&#x2F;z deviation in consecutive scans in parts per million (ppm) for the initial regions-of-interest (ROI)  definition。<font color=#FF0000>此处的ppm来源于xcms包，但在xcms中不同的函数中，含义貌似不一样，需进一步确认。</font></li>\n<li><strong>peakwith</strong>：峰宽，取决于柱子（column）和LC系统。numeric(2) with the expected approximate peak width in chromatographic space. Given as a range (min, max) in seconds.</li>\n<li><strong>min_fraction</strong>：如果一个峰出现在至少一组样本中<code>min_fraction</code>样本以上（按比例），则将保留该峰值。</li>\n<li><strong>snthresh</strong> ：信噪比阈值。</li>\n<li><strong>prefilter</strong>：c(k, I) 在第一次分析步骤（ROI检测）中指定预筛选步骤。仅保留包含至少强度&gt;&#x3D;I的k个峰的的质量轨迹（Mass traces）。</li>\n<li><strong>fitgauss</strong> ：是否应对每个峰拟合高斯分布。主要影响峰的保留时间位置。</li>\n<li><strong>integrate</strong>：积分方法（1或2）。对于 integrate&#x3D;1，Peak limits通过在mexican hat 过滤后的数据上下降（descent）来确定；而对于 integrate&#x3D;2，则在原始数据上进行下降处理。后一种方法更准确但容易受到噪声的影响，而前一种方法更稳健但不太精确。</li>\n<li><strong>mzdiff</strong> ：representing the minimum difference in m&#x2F;z dimension required for peaks with overlapping retention times; can be negative to allow overlap. During peak post-processing, peaks defined to be overlapping are reduced to the one peak with the largest signal.</li>\n<li><strong>noise</strong>：设定第一步分析中需要的质心（centroids ）最小强度（intensity &lt; noise的质心将被省略在感兴趣区域检测之外）。</li>\n<li><strong>binSize</strong> ：将m&#x2F;z轴按照binSize划分为多个区间，再对各区间内的离子信号进行聚合。较小的binSize使得峰检测更加准确，检测到更多features，需要更多计算资源。</li>\n<li><strong>bw</strong>：带宽，通常在5-50间，这是用于峰值检测的核密度估计 （KDE） 算法中使用的参数。bw 控制估计的 KDE 曲线的平滑度，并确定峰的解析程度。较小的bw值将产生更详细的基础峰形表示，在紧密间隔或重叠的峰之间具有更好的分辨率，但也可能产生更高水平的噪声。相反，较大的bw值将导致对峰形的估计更平滑、更广义，这有助于降低噪声和杂散检测，但在某些情况下也可能导致峰分辨率降低。bw 值的选择将取决于所分析数据的具体特征以及分析的目标。通常，有必要试验一系列 bw 值，以找到给定数据集的最佳设置。</li>\n<li><strong>fill_peaks</strong>：Fill peaks NA or not。</li>\n</ul>\n<p><strong>结果</strong>：</p>\n<ul>\n<li><p>POS&#x2F;Result&#x2F;</p>\n<ul>\n<li><p>object：用于下一步分析</p>\n</li>\n<li><p>Peak_table.csv：用于下一步分析的峰表</p>\n</li>\n<li><p>Peak_table_for_cleaning.csv：删除了<code>Peak_table.csv</code>中无用的列，可直接用于后续的数据清洗</p>\n</li>\n<li><p>BPC.pdf：Base peak chromatogram，仅展示<code>group_for_figure</code>参数指定组内的样本<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_1.png\" alt=\"BPC.pdf\"></p>\n</li>\n<li><p>TIC.pdf：Total ion peak chromatogram，经色谱分离流出的组分不断进入质谱，质谱连续扫描采集数据，每一次扫描得到一张质谱图，将每一张质谱图中所有离子强度相加得到总离子流强度。然后以总离子强度为纵坐标，时间为横坐标绘图。<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_2.png\" alt=\"TIC.pdf\"></p>\n</li>\n<li><p>RT correction plot.pdf<br><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_3.png\" alt=\"RT correction plot.pdf\"></p>\n</li>\n<li><p>intermediate_data：中间文件目录，如果需要重新运行data processing，则需先删除该目录。</p>\n</li>\n</ul>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取互动图，在Rstudio中才能显示</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/intermediate_data/xdata2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot <span class=\"operator\">=</span> massprocesser<span class=\"operator\">::</span>plot_adjusted_rt<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> xdata2<span class=\"punctuation\">,</span> group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span> <span class=\"built_in\">interactive</span> <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">plot</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"负离子模式\"><a href=\"#负离子模式\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">massprocesser<span class=\"operator\">::</span>process_data<span class=\"punctuation\">(</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mzxml_ms1_data/NEG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ppm <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  peakwidth <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">,</span> <span class=\"number\">60</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  threads <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_tic <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_bpc <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  output_rt_correction_plot <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  min_fraction <span class=\"operator\">=</span> <span class=\"number\">0.5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  group_for_figure <span class=\"operator\">=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">   snthresh <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  prefilter <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">3</span><span class=\"punctuation\">,</span> <span class=\"number\">500</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fitgauss <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  integrate <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  mzdiff <span class=\"operator\">=</span> <span class=\"number\">0.01</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  noise <span class=\"operator\">=</span> <span class=\"number\">500</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  binSize <span class=\"operator\">=</span> <span class=\"number\">0.025</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  bw <span class=\"operator\">=</span> <span class=\"number\">5</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  fill_peaks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看metabolic features数量</span></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Explore-data\"><a href=\"#Explore-data\" class=\"headerlink\" title=\"Explore data\"></a>Explore data</h2><p>将peak table和样本信息（元数据）整合，得到<code>mass_dataset</code> class对象。获取数据的总结信息。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_0.png\" alt=\"样本信息表示例 sample_info_pos.csv\"></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"正离子模式-1\"><a href=\"#正离子模式-1\" class=\"headerlink\" title=\"正离子模式\"></a>正离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/POS/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_pos <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_pos.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  查看object_pos中的元数据</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12  Case Subject               6</span></span><br><span class=\"line\"><span class=\"comment\">#?? 为何还没整合的情况下object_pos中就存在了部分元数据列？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除object_pos中的&quot;group&quot;, &quot;class&quot;, &quot;injection.order&quot;</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_pos 中的所有列整合到object_pos 中</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看元数据信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;    sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_pos</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/peak_distributation_plot_positive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span>hex <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 786005</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      4017       2713       4064       2981       2920       3846</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T73_POS  M70T53_POS M70T183_POS M70T527_POS M71T695_POS M71T183_POS</span></span><br><span class=\"line\"><span class=\"comment\">#        129          16         155          54         133         169</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> show_row_names <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;mz&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_4.png\" alt=\"峰分布图\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_5.svg\" alt=\"各variable的缺失值数量\"><br>黑色代表缺失值。</p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_6.svg\" alt=\"各样本的缺失值比例\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_7.svg\" alt=\"各variable的缺失值比例\"></p>\n<h3 id=\"负离子模式-1\"><a href=\"#负离子模式-1\" class=\"headerlink\" title=\"负离子模式\"></a>负离子模式</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载对象</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;mzxml_ms1_data/NEG/Result/object&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 读入样本信息</span></span><br><span class=\"line\">sample_info_neg <span class=\"operator\">&lt;-</span> readr<span class=\"operator\">::</span>read_csv<span class=\"punctuation\">(</span><span class=\"string\">&quot;sample_info/sample_info_neg.csv&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span>  extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id group   class injection.order</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06  Case Subject               1</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103  Case Subject               2</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11  Case Subject               3</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112  Case Subject               4</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117  Case Subject               5</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12  Case Subject               6</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>select<span class=\"punctuation\">(</span><span class=\"operator\">-</span><span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;class&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将sample_info_neg添加至object_neg</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> left_join<span class=\"punctuation\">(</span>sample_info_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> extract_sample_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#   sample_id injection.order   class batch  subject_id group</span></span><br><span class=\"line\"><span class=\"comment\">#1  sample_06               4 Subject     1 subject_414  Case</span></span><br><span class=\"line\"><span class=\"comment\">#2 sample_103              71 Subject     1 subject_330  Case</span></span><br><span class=\"line\"><span class=\"comment\">#3  sample_11               6 Subject     1 subject_125  Case</span></span><br><span class=\"line\"><span class=\"comment\">#4 sample_112              78 Subject     1 subject_295  Case</span></span><br><span class=\"line\"><span class=\"comment\">#5 sample_117              80 Subject     1 subject_793  Case</span></span><br><span class=\"line\"><span class=\"comment\">#6  sample_12               8 Subject     1 subject_387  Case</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存数据</span></span><br><span class=\"line\">dir.create<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> recursive <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 统计样本数和variables数</span></span><br><span class=\"line\">object_neg</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 根据class统计样本数量，可将class换成group或batch等</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span><span class=\"built_in\">class</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取peak分布图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/peak_distributation_plot_negtive.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">10</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> show_mz_rt_plot<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看总缺失值数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#[1] 748237</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各样本内的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># sample_06 sample_103  sample_11 sample_112 sample_117  sample_12</span></span><br><span class=\"line\"><span class=\"comment\">#      3029       2766       3298       3100       2912       3053</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看各variable的缺失值</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> by <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#M70T712_NEG M70T527_NEG M70T587_NEG  M70T47_NEG M71T587_NEG M71T641_NEG</span></span><br><span class=\"line\"><span class=\"comment\">#         16         137           2         146          41          19</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/total_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> show_column_names <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各样本缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Samples_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 绘图展示各variables缺失值信息，可在下一节生成</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/Variables_MVs.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span></span><br><span class=\"line\">  percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_text <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  show_x_ticks <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据清洗（Data-cleaning）\"><a href=\"#数据清洗（Data-cleaning）\" class=\"headerlink\" title=\"数据清洗（Data cleaning）\"></a>数据清洗（Data cleaning）</h2><h3 id=\"查看质量\"><a href=\"#查看质量\" class=\"headerlink\" title=\"查看质量\"></a>查看质量</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 加载数据</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将批次号改为字符串</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>mutate<span class=\"punctuation\">(</span>batch <span class=\"operator\">=</span> <span class=\"built_in\">as.character</span><span class=\"punctuation\">(</span>batch<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 先评估数据质量</span></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massqc<span class=\"operator\">::</span>massqc_report<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/data_quality_before_data_cleaning&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_8.png\" alt=\"正离子PCA\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_9.png\" alt=\"负离子PCA\"><br><font color=\"#FF0000\">从上两图可看出正离子模式下存在严重的批次效应，负离子模式下不存在明显的批次效应。</font></p>\n<h3 id=\"开始清洗\"><a href=\"#开始清洗\" class=\"headerlink\" title=\"开始清洗\"></a>开始清洗</h3><h4 id=\"移除噪音代谢features——缺失值过滤。\"><a href=\"#移除噪音代谢features——缺失值过滤。\" class=\"headerlink\" title=\"移除噪音代谢features——缺失值过滤。\"></a>移除噪音代谢features——缺失值过滤。</h4><p>移除超过20% QC样本中含有MVs以及至少在50%实验组或对照组样本中含有MVs的variables。</p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> </span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_pos <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1  M70T73_POS 70.04074  73.31705 0.28205128 0.6000000 0.4727273</span></span><br><span class=\"line\"><span class=\"comment\">#2  M70T53_POS 70.06596  52.78542 0.00000000 0.1454545 0.0000000</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T183_POS 70.19977 182.87981 0.00000000 0.6636364 0.7454545</span></span><br><span class=\"line\"><span class=\"comment\">#4 M70T527_POS 70.36113 526.76657 0.02564103 0.1818182 0.3000000</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T695_POS 70.56911 694.84592 0.02564103 0.6454545 0.5545455</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T183_POS 70.75034 182.77790 0.05128205 0.7272727 0.7909091</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos</span><br></pre></td></tr></table></figure>\n\n<p> <strong>注</strong>：na_freq、na_freq.1和na_freq.2在此处分别代表某variables 在QC样本、对照组样本和实验组样本中缺失值MV所占的百分比。</p>\n<p> <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_19.png\" alt=\"MVpercentQC\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看各分组样本量</span></span><br><span class=\"line\">object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> dplyr<span class=\"operator\">::</span>count<span class=\"punctuation\">(</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt;     group   n</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 1    Case 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 2 Control 110</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 3      QC  39</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># QC样本中的MV占比</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentQC.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> show_variable_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.01</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计QC中的MV占比</span></span><br><span class=\"line\">qc_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">==</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计对照组中的MV占比</span></span><br><span class=\"line\">control_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 统计实验组中的MV占比</span></span><br><span class=\"line\">case_id <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 整合以上统计信息</span></span><br><span class=\"line\">object_neg <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> qc_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> control_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> mutate_variable_na_freq<span class=\"punctuation\">(</span>according_to_samples <span class=\"operator\">=</span> case_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>extract_variable_info<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#variable_id       mz        rt    na_freq na_freq.1 na_freq.2</span></span><br><span class=\"line\"><span class=\"comment\">#1 M70T712_NEG 70.05911 711.97894 0.05128205 0.109090909 0.018181818</span></span><br><span class=\"line\"><span class=\"comment\">#2 M70T527_NEG 70.13902 526.85416 0.33333333 0.509090909 0.618181818</span></span><br><span class=\"line\"><span class=\"comment\">#3 M70T587_NEG 70.31217 587.25330 0.00000000 0.009090909 0.009090909</span></span><br><span class=\"line\"><span class=\"comment\">#4  M70T47_NEG 70.33835  46.57537 0.84615385 0.936363636 0.090909091</span></span><br><span class=\"line\"><span class=\"comment\">#5 M71T587_NEG 70.56315 587.02570 0.17948718 0.145454545 0.163636364</span></span><br><span class=\"line\"><span class=\"comment\">#6 M71T641_NEG 70.70657 641.16672 0.10256410 0.063636364 0.072727273</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除variables</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> object_neg <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>na_freq <span class=\"operator\">&lt;</span> <span class=\"number\">0.2</span> <span class=\"operator\">&amp;</span> <span class=\"punctuation\">(</span>na_freq.1 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span> <span class=\"operator\">|</span> na_freq.2 <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"过滤离群样本（Filter-outlier-samples）\"><a href=\"#过滤离群样本（Filter-outlier-samples）\" class=\"headerlink\" title=\"过滤离群样本（Filter outlier samples）\"></a>过滤离群样本（Filter outlier samples）</h4><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_pos <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除离群样本，如果有的话</span></span><br><span class=\"line\">need_id_pos <span class=\"operator\">&lt;-</span> <span class=\"built_in\">names</span><span class=\"punctuation\">(</span>outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `==`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> object_pos <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> need_id_pos<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_20.png\" alt=\"MVpercentALL\"></p>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 总览</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/MVpercentALL.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> massdataset<span class=\"operator\">::</span>show_sample_missing_values<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;group&quot;</span><span class=\"punctuation\">,</span> order_by <span class=\"operator\">=</span> <span class=\"string\">&quot;injection.order&quot;</span><span class=\"punctuation\">,</span> percentage <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">+</span> theme<span class=\"punctuation\">(</span>axis.text.x <span class=\"operator\">=</span> element_text<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.1</span><span class=\"punctuation\">,</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span> ggsci<span class=\"operator\">::</span>scale_color_aaas<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检测离群样本</span></span><br><span class=\"line\">outlier_samples <span class=\"operator\">=</span> object_neg <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> detect_outlier<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_samples</span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#masscleaner</span></span><br><span class=\"line\"><span class=\"comment\">#--------------------</span></span><br><span class=\"line\"><span class=\"comment\">#1 according_to_na : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#2 according_to_pc_sd : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#3 according_to_pc_mad : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#4 accordint_to_distance : 0 outlier samples.</span></span><br><span class=\"line\"><span class=\"comment\">#extract all outlier table using extract_outlier_table()</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">&lt;-</span> extract_outlier_table<span class=\"punctuation\">(</span>outlier_samples<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> head<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#           according_to_na pc_sd pc_mad accordint_to_distance</span></span><br><span class=\"line\"><span class=\"comment\">#sample_06            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_103           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_11            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_112           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_117           FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"><span class=\"comment\">#sample_12            FALSE FALSE  FALSE                 FALSE</span></span><br><span class=\"line\"></span><br><span class=\"line\">outlier_table <span class=\"operator\">%&gt;%</span> apply<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">,</span> <span class=\"keyword\">function</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span><span class=\"punctuation\">&#123;</span> <span class=\"built_in\">sum</span><span class=\"punctuation\">(</span>x<span class=\"punctuation\">)</span>  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `&gt;`<span class=\"punctuation\">(</span><span class=\"number\">0</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\"># #named integer(0)</span></span><br><span class=\"line\"><span class=\"comment\">##无离群样本</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h2 id=\"缺失值填充（Missing-value-imputation）\"><a href=\"#缺失值填充（Missing-value-imputation）\" class=\"headerlink\" title=\"缺失值填充（Missing value imputation）\"></a>缺失值填充（Missing value imputation）</h2><p>对原始数据中的缺失值进行模拟（missing value recoding）。方法包括：”knn”, “rf” (missForest), “mean”, “median”, “zero”, “minimum”, “bpca”, “svdImpute”, “ppca”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取正离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 148907</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取负离子模式下的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 146409</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 填充正离子模式缺失值</span></span><br><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> impute_mv<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;knn&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取正离子模式下填充后的MV数量</span></span><br><span class=\"line\">get_mv_number<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; [1] 0</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据标准化与整合（Data-normalization-and-integration）\"><a href=\"#数据标准化与整合（Data-normalization-and-integration）\" class=\"headerlink\" title=\"数据标准化与整合（Data normalization and integration）\"></a>数据标准化与整合（Data normalization and integration）</h2><p>数据标准化处理， 利用内标（internal standard, IS）进行归一化<font color=\"#FF0000\">待确认是否通过IS实现</font>。</p>\n<ul>\n<li><p>正离子模式</p>\n<p>标准化方法包括：”svr”, “total”, “median”, “mean”, “pqn”, “loess”；整合方法包括：”qc_mean”, “qc_median”, “subject_mean”, “subject_median”。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_pos<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/POS/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_10.svg\" alt=\"标准化后正离子PCA\"></p>\n<ul>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg <span class=\"operator\">&lt;-</span> normalize_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> integrate_data<span class=\"punctuation\">(</span>object_neg<span class=\"punctuation\">,</span> method <span class=\"operator\">=</span> <span class=\"string\">&quot;subject_median&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 按批次分组绘制PCA图</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;data_cleaning/NEG/PC_batch_intergrated.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2 <span class=\"operator\">%&gt;%</span> `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> massqc<span class=\"operator\">::</span>massqc_pca<span class=\"punctuation\">(</span>color_by <span class=\"operator\">=</span> <span class=\"string\">&quot;batch&quot;</span><span class=\"punctuation\">,</span> line <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_11.svg\" alt=\"标准化后负离子PCA\"></p>\n<p><strong>保存数据</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"代谢物注释\"><a href=\"#代谢物注释\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h2><h3 id=\"加载数据\"><a href=\"#加载数据\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/POS/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;data_cleaning/NEG/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将MS2数据添加到mass-dataset\"><a href=\"#将MS2数据添加到mass-dataset\" class=\"headerlink\" title=\"将MS2数据添加到mass_dataset\"></a>将MS2数据添加到mass_dataset</h3><p><strong>如果没有MS2数据，此步不执行应该也可以！</strong><br><font color=\"#FF0000\">？？只有QC样的MS2数据，MS2数据是怎么来的？</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># rp or hilic，对应RPLC（反相色谱）和HILIC（亲水相互作用色谱）</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span><span class=\"comment\"># ppm</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span><span class=\"comment\"># seconds</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/POS&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1043 out of 5101 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> mutate_ms2<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span></span><br><span class=\"line\">  column <span class=\"operator\">=</span> <span class=\"string\">&quot;rp&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.mz.tol <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  ms1.ms2.match.rt.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  path <span class=\"operator\">=</span> <span class=\"string\">&quot;mgf_ms2_data/mgf_ms2_data/NEG&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#1092 out of 4104 variable have MS2 spectra.</span></span><br><span class=\"line\"><span class=\"comment\">#Selecting the most intense MS2 spectrum for each peak...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># summary</span></span><br><span class=\"line\">extract_ms2_data<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"代谢物注释-1\"><a href=\"#代谢物注释-1\" class=\"headerlink\" title=\"代谢物注释\"></a>代谢物注释</h3><p><font color=#FF0000>需要考虑数据库是RPLC还是HILIC。</font></p>\n<ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/snyder_database_rplc0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">snyder_database_rplc0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/orbitrap_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">orbitrap_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/mona_database0.0.3.rda&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 查看数据库信息</span></span><br><span class=\"line\">mona_database0.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 注释</span></span><br><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;positive&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">,</span></span><br><span class=\"line\"> threads <span class=\"operator\">=</span><span class=\"number\">30</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>annotate_metabolites_mass_dataset 参数解析</strong>：</p>\n<ul>\n<li><strong>ms1.match.ppm</strong>：Precursor match ppm tolerance [25].</li>\n<li><strong>ms2.match.ppm</strong>：Fragment ion match ppm tolerance [30].</li>\n<li><strong>mz.ppm.thr</strong>：Accurate mass tolerance for m&#x2F;z error calculation [400].</li>\n<li><strong>ms2.match.tol</strong>：MS2 match (MS2 similarity) tolerance [0.5].</li>\n<li><strong>fraction.weight</strong>：The weight for matched fragments [0.3].</li>\n<li><strong>dp.forward.weight</strong>：Forward dot product weight [0.6].</li>\n<li><strong>dp.reverse.weight</strong>：Reverse dot product weight [0.1].</li>\n<li><strong>remove_fragment_intensity_cutoff</strong>：remove_fragment_intensity_cutoff [0].</li>\n<li><strong>rt.match.tol</strong>：RT match tolerance [30].</li>\n<li><strong>polarity</strong>：The polarity of data, “positive”or “negative”.</li>\n<li><strong>ce</strong>：Collision energy. Please confirm the CE values in your database. [all].</li>\n<li><strong>column</strong>：”hilic” (HILIC column) or “rp” (reverse phase).</li>\n<li><strong>ms1.match.weight</strong>：The weight of MS1 match for total score calculation [0.25].</li>\n<li><strong>rt.match.weight</strong>：The weight of RT match for total score calculation [0.25].</li>\n<li><strong>ms2.match.weight</strong>：The weight of MS2 match for total score calculation [0.5]</li>\n<li><strong>total.score.tol</strong>：Total score tolerance. The total score are referring to MS-DIAL [0.5]</li>\n<li><strong>candidate.num</strong>：The number of candidate [3]</li>\n</ul>\n</li>\n<li><p>负离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Annotate features using snyder_database_rplc0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    rt.match.tol <span class=\"operator\">=</span> <span class=\"number\">30</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> snyder_database_rplc0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using orbitrap_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> orbitrap_database0.0.3<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Annotate features using mona_database0.0.3</span></span><br><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> annotate_metabolites_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    ms1.match.ppm <span class=\"operator\">=</span> <span class=\"number\">15</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    polarity <span class=\"operator\">=</span> <span class=\"string\">&quot;negative&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    database <span class=\"operator\">=</span> mona_database0.0.3<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"查看注释结果\"><a href=\"#查看注释结果\" class=\"headerlink\" title=\"查看注释结果\"></a>查看注释结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">head<span class=\"punctuation\">(</span>extract_annotation_table<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">variable_info_pos <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>variable_info_pos<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Level<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">table<span class=\"punctuation\">(</span>variable_info_pos<span class=\"operator\">$</span>Database<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"保存数据\"><a href=\"#保存数据\" class=\"headerlink\" title=\"保存数据\"></a>保存数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">save<span class=\"punctuation\">(</span>object_pos2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_neg2<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"统计分析\"><a href=\"#统计分析\" class=\"headerlink\" title=\"统计分析\"></a>统计分析</h2><h3 id=\"加载数据-1\"><a href=\"#加载数据-1\" class=\"headerlink\" title=\"加载数据\"></a>加载数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_pos2&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;metabolite_annotation/object_neg2&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"移除未被注释的features\"><a href=\"#移除未被注释的features\" class=\"headerlink\" title=\"移除未被注释的features\"></a>移除未被注释的features</h3><ul>\n<li><p>正离子模式</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_pos2 <span class=\"operator\">&lt;-</span> object_pos2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_pos2</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>负离子模式</p>\n  <figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_neg2 <span class=\"operator\">&lt;-</span> object_neg2 <span class=\"operator\">%&gt;%</span> activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"number\">1</span> <span class=\"operator\">|</span> Level <span class=\"operator\">==</span> <span class=\"number\">2</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object_neg2</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"合并POS和NEG数据\"><a href=\"#合并POS和NEG数据\" class=\"headerlink\" title=\"合并POS和NEG数据\"></a>合并POS和NEG数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># inner merge for samples and full merge for variables</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">merge_mass_dataset<span class=\"punctuation\">(</span></span><br><span class=\"line\">    x <span class=\"operator\">=</span> object_pos2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    y <span class=\"operator\">=</span> object_neg2<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    sample_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;inner&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用inner较合理</span></span><br><span class=\"line\">    variable_direction <span class=\"operator\">=</span> <span class=\"string\">&quot;full&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># left, right, inner or full，此处用full合理</span></span><br><span class=\"line\">    sample_by <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"comment\"># merge samples by what columns from sample_info</span></span><br><span class=\"line\">    variable_by <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"string\">&quot;variable_id&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;mz&quot;</span><span class=\"punctuation\">,</span> <span class=\"string\">&quot;rt&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\"># merge variables by what columns from variable_info</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object</span><br></pre></td></tr></table></figure>\n\n<p><strong>名词解释：</strong></p>\n<ul>\n<li>**左连接 (Left join)**：将左表中的所有记录都保留下来，而右表中与左表中记录没有匹配的部分则丢弃。</li>\n<li>**右连接 (Right join)**：将右表中的所有记录都保留下来，而左表中与右表中记录没有匹配的部分则丢弃。</li>\n<li>**内连接 (Inner join)**：只有两个表中都存在的记录才保留下来，否则丢弃。</li>\n<li>**全连接 (Full join)**：将左表和右表中的所有记录都保留下来，如果某个表中的记录没有匹配到另一个表中的记录，则用NULL填充。</li>\n</ul>\n<h3 id=\"Trace-processing-information-of-object\"><a href=\"#Trace-processing-information-of-object\" class=\"headerlink\" title=\"Trace processing information of object\"></a>Trace processing information of object</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">report_parameters<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> path <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"基于level和score移除冗余注释代谢物\"><a href=\"#基于level和score移除冗余注释代谢物\" class=\"headerlink\" title=\"基于level和score移除冗余注释代谢物\"></a>基于level和score移除冗余注释代谢物</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>Compound.name<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;annotation_table&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  group_by<span class=\"punctuation\">(</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>Level <span class=\"operator\">==</span> <span class=\"built_in\">min</span><span class=\"punctuation\">(</span>Level<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>SS <span class=\"operator\">==</span> <span class=\"built_in\">max</span><span class=\"punctuation\">(</span>SS<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  slice_head<span class=\"punctuation\">(</span>n <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><font color=#FF0000>为何要选最小的level？SS是什么score？</font></p>\n<h3 id=\"样本聚类\"><a href=\"#样本聚类\" class=\"headerlink\" title=\"样本聚类\"></a>样本聚类</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 排除QC样本</span></span><br><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>group <span class=\"operator\">!=</span> <span class=\"string\">&quot;QC&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Samples_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_16.png\" alt=\"样本聚类热图\"></p>\n<h3 id=\"差异表达代谢物\"><a href=\"#差异表达代谢物\" class=\"headerlink\" title=\"差异表达代谢物\"></a>差异表达代谢物</h3><p><font color=#FF0000>如果有多组数据，需要适当增加相应下述代码。“mutate_fc”的逻辑是每运行一次，则在object中增加一列“fc”，当有多个实验组时，可以将先前生成的fc重命名，因此，object中可以包含多个组间比较的fc结果。</font></p>\n<ul>\n<li><p>计算变化倍数</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取对照组样本名列表</span></span><br><span class=\"line\">control_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Control&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 获取实验组样本名列表</span></span><br><span class=\"line\">case_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，参照以上格式在此列出，假设有实验组Case2</span></span><br><span class=\"line\">case2_sample_id <span class=\"operator\">=</span> object <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">filter<span class=\"punctuation\">(</span>group <span class=\"operator\">==</span> <span class=\"string\">&quot;Case2&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span></span><br><span class=\"line\">pull<span class=\"punctuation\">(</span>sample_id<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span><span class=\"comment\">#可选&quot;mean&quot;, &quot;median&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case1_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case1_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! Calculate fold change，每次只能计算两个分组，如果有多个实验组，则依次将其与对照组比较，此处计算Case2与Control</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_fc<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">          mean_median <span class=\"operator\">=</span> <span class=\"string\">&quot;mean&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果有多个实验组，则需要在此更改fc列的默认名，假设将默认的“fc”改为“fc_case2_vs_control”</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>fc_case2_vs_control <span class=\"operator\">=</span> fc<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>计算p值<br><font color=\"#FF0000\">同理，当有多个实验组时，也可以分别计算p值，并将默认的列名“p_value”和“p_value_adjust”重命名，以在object中容纳多组相互比较的p值。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># &quot;t.test&quot;, &quot;wilcox.test&quot;</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"comment\"># &quot;holm&quot;, &quot;hochberg&quot;, &quot;hommel&quot;, &quot;bonferroni&quot;, &quot;BH&quot;, &quot;BY&quot;, &quot;fdr&quot;, &quot;none&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case1_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case1_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"comment\">#! 假设存在Case2组</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span> mutate_p_value<span class=\"punctuation\">(</span></span><br><span class=\"line\">  object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">  control_sample_id <span class=\"operator\">=</span> control_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  case_sample_id <span class=\"operator\">=</span> case2_sample_id<span class=\"punctuation\">,</span></span><br><span class=\"line\">  method <span class=\"operator\">=</span> <span class=\"string\">&quot;t.test&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  p_adjust_methods <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 control samples.</span></span><br><span class=\"line\"><span class=\"comment\">#&gt; 110 case samples.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#! 如果涉及多组间的比较，则需重命名默认表头</span></span><br><span class=\"line\">object <span class=\"operator\">&lt;-</span>  object <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">dplyr<span class=\"operator\">::</span>rename<span class=\"punctuation\">(</span>p_value_case2_vs_control <span class=\"operator\">=</span> p_value<span class=\"punctuation\">,</span></span><br><span class=\"line\">       p_value_adjust_case2_vs_control <span class=\"operator\">=</span> p_value_adjust<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>绘制火山图</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span></span><br><span class=\"line\">      object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">      fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">\t  fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">\t  p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">      point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust&quot;</span></span><br><span class=\"line\"><span class=\"punctuation\">)</span> </span><br><span class=\"line\">  </span><br><span class=\"line\">  p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">  dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_12.png\" alt=\"火山图\"></p>\n<p><font color=\"#FF0000\">假设存在Case2，绘制火山图。</font></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/Volcano2.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">p<span class=\"operator\">&lt;-</span> volcano_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    fc_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;fc_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> p_value_column_name <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">,</span><span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"> fc_up_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\"> fc_down_cutoff <span class=\"operator\">=</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\"> p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           add_text <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">           text_from <span class=\"operator\">=</span> <span class=\"string\">&quot;Compound.name&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">           point_size_scale <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value_adjust_case2_vs_control&quot;</span><span class=\"punctuation\">)</span> <span class=\"comment\"># 重命名后</span></span><br><span class=\"line\"></span><br><span class=\"line\">p <span class=\"operator\">+</span> scale_size_continuous<span class=\"punctuation\">(</span><span class=\"built_in\">range</span> <span class=\"operator\">=</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span><span class=\"number\">0.5</span><span class=\"punctuation\">,</span> <span class=\"number\">5</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"保存结果\"><a href=\"#保存结果\" class=\"headerlink\" title=\"保存结果\"></a>保存结果</h3><ul>\n<li><p>保存差异表达代谢物结果。如果有多个实验组，则将下述代码中的“fc”和“p_value_adjust”更改为重命名后的名称，并分别保存到不同的文件中。</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">differential_metabolites <span class=\"operator\">&lt;-</span> extract_variable_info<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> object<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>fc <span class=\"operator\">&gt;</span> <span class=\"number\">2</span> <span class=\"operator\">|</span> fc <span class=\"operator\">&lt;</span> <span class=\"number\">0.5</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">readr<span class=\"operator\">::</span>write_csv<span class=\"punctuation\">(</span>differential_metabolites<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/differential_metabolites.csv&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>保存结果对象</p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object_final <span class=\"operator\">&lt;-</span> object</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>object_final<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"绘制热图\"><a href=\"#绘制热图\" class=\"headerlink\" title=\"绘制热图\"></a>绘制热图</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">,</span> case_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> differential_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ComplexHeatmap<span class=\"punctuation\">)</span></span><br><span class=\"line\">h1 <span class=\"operator\">&lt;-</span> HeatmapAnnotation<span class=\"punctuation\">(</span><span class=\"built_in\">class</span> <span class=\"operator\">=</span> extract_sample_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>group<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;statistical_analysis/diff_heatmap.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">massstat<span class=\"operator\">::</span>Heatmap<span class=\"punctuation\">(</span>matrix <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  name <span class=\"operator\">=</span> <span class=\"string\">&quot;z-score&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">                  row_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.4</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  column_names_gp <span class=\"operator\">=</span> gpar<span class=\"punctuation\">(</span>cex <span class=\"operator\">=</span> <span class=\"number\">0.2</span><span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                  top_annotation <span class=\"operator\">=</span> h1<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  row_labels <span class=\"operator\">=</span> extract_variable_info<span class=\"punctuation\">(</span>temp_object<span class=\"punctuation\">)</span><span class=\"operator\">$</span>Compound.name<span class=\"punctuation\">,</span></span><br><span class=\"line\">                  border <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p>  <img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_17.png\" alt=\"显著差异代谢物热图\"></p>\n<h2 id=\"代谢通路富集\"><a href=\"#代谢通路富集\" class=\"headerlink\" title=\"代谢通路富集\"></a>代谢通路富集</h2><h3 id=\"导入数据\"><a href=\"#导入数据\" class=\"headerlink\" title=\"导入数据\"></a>导入数据</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">library<span class=\"punctuation\">(</span>tidymass<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidyverse<span class=\"punctuation\">)</span></span><br><span class=\"line\">load<span class=\"punctuation\">(</span><span class=\"string\">&quot;statistical_analysis/object_final&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"富集\"><a href=\"#富集\" class=\"headerlink\" title=\"富集\"></a>富集</h4><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dir.create<span class=\"punctuation\">(</span>path <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment&quot;</span><span class=\"punctuation\">,</span> showWarnings <span class=\"operator\">=</span> <span class=\"literal\">FALSE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">diff_metabolites <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>p_value_adjust <span class=\"operator\">&lt;</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  extract_variable_info<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>diff_metabolites<span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"加载KEGG-human-pathway数据库\"><a href=\"#加载KEGG-human-pathway数据库\" class=\"headerlink\" title=\"加载KEGG human pathway数据库\"></a>加载KEGG human pathway数据库</h3><p><font color=#FF0000>可选数据库：kegg_hsa_pathway，keggMS1database，query_id_kegg，hmdb_pathway，hmdbMS1Database，query_id_hmdb。</font></p>\n<p><strong>？？这些数据库的区别是什么？</strong></p>\n<figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">data<span class=\"punctuation\">(</span><span class=\"string\">&quot;kegg_hsa_pathway&quot;</span><span class=\"punctuation\">,</span> package <span class=\"operator\">=</span> <span class=\"string\">&quot;metpath&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">kegg_hsa_pathway</span><br><span class=\"line\"></span><br><span class=\"line\">get_pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 移除疾病相关通路!根据课题选择是否移除？</span></span><br><span class=\"line\">pathway_class <span class=\"operator\">=</span> metpath<span class=\"operator\">::</span>pathway_class<span class=\"punctuation\">(</span>kegg_hsa_pathway<span class=\"punctuation\">)</span></span><br><span class=\"line\">head<span class=\"punctuation\">(</span>pathway_class<span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">remain_idx <span class=\"operator\">=</span> pathway_class <span class=\"operator\">%&gt;%</span> unlist<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> stringr<span class=\"operator\">::</span>str_detect<span class=\"punctuation\">(</span><span class=\"string\">&quot;Disease&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> `!`<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> which<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">pathway_database <span class=\"operator\">=</span> kegg_hsa_pathway<span class=\"punctuation\">[</span>remain_idx<span class=\"punctuation\">]</span></span><br><span class=\"line\">pathway_database</span><br><span class=\"line\"></span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  diff_metabolites<span class=\"operator\">$</span>KEGG.ID </span><br><span class=\"line\">kegg_id <span class=\"operator\">&lt;-</span>  kegg_id<span class=\"punctuation\">[</span><span class=\"operator\">!</span><span class=\"built_in\">is.na</span><span class=\"punctuation\">(</span>kegg_id<span class=\"punctuation\">)</span><span class=\"punctuation\">]</span></span><br><span class=\"line\"></span><br><span class=\"line\">result <span class=\"operator\">&lt;-</span> enrich_kegg<span class=\"punctuation\">(</span></span><br><span class=\"line\">    query_id <span class=\"operator\">=</span> kegg_id<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    query_type <span class=\"operator\">=</span> <span class=\"string\">&quot;compound&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    id_type <span class=\"operator\">=</span> <span class=\"string\">&quot;KEGG&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pathway_database <span class=\"operator\">=</span> pathway_database<span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    p_adjust_method <span class=\"operator\">=</span> <span class=\"string\">&quot;BH&quot;</span><span class=\"punctuation\">,</span> </span><br><span class=\"line\">    threads <span class=\"operator\">=</span> <span class=\"number\">10</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">result</span><br><span class=\"line\"></span><br><span class=\"line\">save<span class=\"punctuation\">(</span>result<span class=\"punctuation\">,</span> file <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/result&quot;</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"绘制结果\"><a href=\"#绘制结果\" class=\"headerlink\" title=\"绘制结果\"></a>绘制结果</h3><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#  bar plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/barplot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_bar_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> x_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># scatter plot</span></span><br><span class=\"line\">pdf<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/scatter_plot.pdf&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_scatter_plot<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> y_axis <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> y_axis_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># network</span></span><br><span class=\"line\">tiff<span class=\"punctuation\">(</span>file<span class=\"operator\">=</span><span class=\"string\">&quot;pathway_enrichment/network.tiff&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">enrich_network<span class=\"punctuation\">(</span>object <span class=\"operator\">=</span> result<span class=\"punctuation\">,</span> point_size <span class=\"operator\">=</span> <span class=\"string\">&quot;p_value&quot;</span><span class=\"punctuation\">,</span> p_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span> only_significant_pathway <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">dev.off<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_13.png\" alt=\"KEGG富集bar plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_14.png\" alt=\"KEGG富集scatter plot\"></p>\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_15.png\" alt=\"KEGG富集network\"></p>\n<h2 id=\"Correlation-network-analysis\"><a href=\"#Correlation-network-analysis\" class=\"headerlink\" title=\"Correlation network analysis\"></a>Correlation network analysis</h2><figure class=\"highlight r\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">temp_object <span class=\"operator\">&lt;-</span> object_final <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;sample_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>sample_id <span class=\"operator\">%in%</span> <span class=\"built_in\">c</span><span class=\"punctuation\">(</span>control_sample_id<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  activate_mass_dataset<span class=\"punctuation\">(</span>what <span class=\"operator\">=</span> <span class=\"string\">&quot;variable_info&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  filter<span class=\"punctuation\">(</span>variable_id <span class=\"operator\">%in%</span> diff_metabolites<span class=\"operator\">$</span>variable_id<span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  `+`<span class=\"punctuation\">(</span><span class=\"number\">1</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  <span class=\"built_in\">log</span><span class=\"punctuation\">(</span><span class=\"number\">2</span><span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  scale<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>ggraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>tidygraph<span class=\"punctuation\">)</span></span><br><span class=\"line\">graph_data <span class=\"operator\">&lt;-</span> convert_mass_dataset2graph<span class=\"punctuation\">(</span></span><br><span class=\"line\">    object <span class=\"operator\">=</span> temp_object<span class=\"punctuation\">,</span></span><br><span class=\"line\">    margin <span class=\"operator\">=</span> <span class=\"string\">&quot;variable&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    cor_method <span class=\"operator\">=</span> <span class=\"string\">&quot;spearman&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_adjust_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    p_value_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.05</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    pos_cor_cutoff <span class=\"operator\">=</span> <span class=\"number\">0.7</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    neg_cor_cutoff <span class=\"operator\">=</span> <span class=\"operator\">-</span><span class=\"number\">0.7</span></span><br><span class=\"line\">  <span class=\"punctuation\">)</span> <span class=\"operator\">%&gt;%</span> </span><br><span class=\"line\">  mutate<span class=\"punctuation\">(</span>Degree <span class=\"operator\">=</span> centrality_degree<span class=\"punctuation\">(</span>mode <span class=\"operator\">=</span> <span class=\"string\">&#x27;all&#x27;</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>extrafont<span class=\"punctuation\">)</span></span><br><span class=\"line\">loadfonts<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">library<span class=\"punctuation\">(</span>showtext<span class=\"punctuation\">)</span></span><br><span class=\"line\">showtext_auto<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span></span><br><span class=\"line\">plot <span class=\"operator\">&lt;-</span> </span><br><span class=\"line\">ggraph<span class=\"punctuation\">(</span>graph <span class=\"operator\">=</span> graph_data<span class=\"punctuation\">,</span> layout <span class=\"operator\">=</span> <span class=\"string\">&quot;kk&quot;</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_edge_fan<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>color <span class=\"operator\">=</span> correlation<span class=\"punctuation\">,</span></span><br><span class=\"line\">                    <span class=\"comment\">#width = -log((p_adjust+0.1), 10)),</span></span><br><span class=\"line\">                show.legend <span class=\"operator\">=</span> <span class=\"literal\">TRUE</span><span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  geom_node_point<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>size <span class=\"operator\">=</span> Degree<span class=\"punctuation\">)</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  shadowtext<span class=\"operator\">::</span>geom_shadowtext<span class=\"punctuation\">(</span>aes<span class=\"punctuation\">(</span>x <span class=\"operator\">=</span> x<span class=\"punctuation\">,</span> y <span class=\"operator\">=</span> y<span class=\"punctuation\">,</span></span><br><span class=\"line\">                                  label <span class=\"operator\">=</span> Compound.name<span class=\"punctuation\">)</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              bg.colour <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">                              colour <span class=\"operator\">=</span> <span class=\"string\">&quot;black&quot;</span><span class=\"punctuation\">)</span><span class=\"operator\">+</span></span><br><span class=\"line\">  theme_graph<span class=\"punctuation\">(</span><span class=\"punctuation\">)</span> <span class=\"operator\">+</span></span><br><span class=\"line\">  scale_edge_color_gradient2<span class=\"punctuation\">(</span>low <span class=\"operator\">=</span> <span class=\"string\">&quot;darkblue&quot;</span><span class=\"punctuation\">,</span> mid <span class=\"operator\">=</span> <span class=\"string\">&quot;white&quot;</span><span class=\"punctuation\">,</span> high <span class=\"operator\">=</span> <span class=\"string\">&quot;red&quot;</span><span class=\"punctuation\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">ggsave<span class=\"punctuation\">(</span>plot<span class=\"punctuation\">,</span> filename <span class=\"operator\">=</span> <span class=\"string\">&quot;pathway_enrichment/cor_network.pdf&quot;</span><span class=\"punctuation\">,</span> width <span class=\"operator\">=</span> <span class=\"number\">12</span><span class=\"punctuation\">,</span> height <span class=\"operator\">=</span> <span class=\"number\">7</span><span class=\"punctuation\">)</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://fastly.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/0_18.png\" alt=\"代谢物Correlation network\"></p>\n<h1 id=\"术语\"><a href=\"#术语\" class=\"headerlink\" title=\"术语\"></a>术语</h1><ul>\n<li><strong>HILIC</strong>（亲水相互作用色谱）&amp; <strong>RPLC</strong>（反相色谱）：RPLC 色谱柱主要使用非极性固定相（C18、C8 等），而 HILIC 色谱柱则使用极性固定相（二氧化硅、酰胺等）。两种技术采用的流动相通常由乙腈和水组成，这使得两种液相色谱模式之间可以实现轻松切换。HILIC 和 RPLC 流动相的主要区别在于溶剂洗脱强度。对于 RPLC，乙腈是强洗脱溶剂。但对于HILIC，水是强洗脱溶剂。对于 RPLC，得到的色谱图通常是极性分析物到非极性分析物，而 HILIC 则相反。这种相反的洗脱顺序使 HILIC 成为更常用的 RPLC 的一个很好的补充技术。对于极性分析物和离子化分析物尤其如此，它们在 HILIC 模式下的保留时间更长。</li>\n</ul>\n<h1 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h1><ul>\n<li><a href=\"http://www.bioengx.com/%E8%B4%A8%E8%B0%B1%E5%88%86%E6%9E%90%E6%9C%AF%E8%AF%AD%E6%9C%80%E5%85%A8%E8%A7%A3%E8%AF%BB/\">质谱分析术语最全解读</a></li>\n<li><a href=\"https://www.tidymass.org/start/whole_workflow/\">Whole workflow using tidymass</a></li>\n<li><a href=\"https://www.agilent.com/cs/library/applications/application-note-hilic%20versus-rplc-5994-1137zh-cn-agilent.pdf\">极性分子的保留和分离 ― 关于何时使用 HILIC 与反相液相色谱柱的详细研究</a></li>\n</ul>\n<h1 id=\"加关注\"><a href=\"#加关注\" class=\"headerlink\" title=\"加关注\"></a>加关注</h1><p>关注公众号“生信之巅”。</p>\n<table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/生信之巅公众号.jpg\" alt=\"生信之巅微信公众号\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/小程序码.png\" alt=\"生信之巅小程序码\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n\n\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"生信软件","path":"api/tags/生信软件.json"},{"name":"代谢组","path":"api/tags/代谢组.json"}]}