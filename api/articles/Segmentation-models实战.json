{"title":"Segmentation modelså®æˆ˜","slug":"Segmentation-modelså®æˆ˜","date":"2025-11-16T02:42:14.000Z","updated":"2025-11-23T02:03:51.679Z","comments":true,"path":"api/articles/Segmentation-modelså®æˆ˜.json","excerpt":null,"covers":["https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Fig01.webp","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_26_0.png","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_35_0.png","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_48_0.png","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_61_0.png","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/ç”Ÿä¿¡ä¹‹å·…å…¬ä¼—å·.jpg","https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/å°ç¨‹åºç .png"],"content":"<h1 id=\"1-Segmentation-models-ç®€ä»‹\"><a href=\"#1-Segmentation-models-ç®€ä»‹\" class=\"headerlink\" title=\"1. Segmentation models ç®€ä»‹\"></a>1. Segmentation models ç®€ä»‹</h1><p>ä½¿ç”¨Transformeréª¨å¹²ç½‘ç»œçš„åˆ†å‰²æ¨¡å‹ï¼ˆå¦‚Nucleotide Transformerã€Enformerã€Borzoiï¼‰å¯ç”¨äºå•æ ¸è‹·é…¸åˆ†è¾¨ç‡ä¸‹çš„åŸºå› ç»„å…ƒä»¶é¢„æµ‹ã€‚ä¾‹å¦‚ï¼Œ<code>SegmentNT</code>èƒ½åœ¨é•¿è¾¾30kbçš„åºåˆ—ï¼ˆå¯æ‰©å±•è‡³50kbpï¼‰ä¸­<strong>é¢„æµ‹14ç§ä¸åŒç±»åˆ«çš„äººç±»åŸºå› ç»„å…ƒä»¶</strong>ï¼Œå¹¶è¡¨ç°å‡ºä¼˜å¼‚çš„æ€§èƒ½ã€‚</p>\n<p>æ‰€æœ‰æ¨¡å‹å‡æ­é…ä¸€ç»´U-Netåˆ†å‰²å¤´ï¼Œä»¥å•æ ¸è‹·é…¸åˆ†è¾¨ç‡é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒä»¶çš„ä½ç½®ã€‚è¿™äº›å…ƒä»¶åŒ…æ‹¬åŸºå› å…ƒä»¶ï¼ˆè›‹ç™½è´¨ç¼–ç åŸºå› ã€é•¿é“¾éç¼–ç RNAã€5â€™éç¿»è¯‘åŒºã€3â€™éç¿»è¯‘åŒºã€å¤–æ˜¾å­ã€å†…å«å­ã€å‰ªæ¥å—ä½“ä½ç‚¹å’Œä¾›ä½“ä½ç‚¹ï¼‰å’Œè°ƒæ§å…ƒä»¶ï¼ˆpolyA signalã€ç»„ç»‡éç‰¹å¼‚æ€§å’Œç»„ç»‡ç‰¹å¼‚æ€§å¯åŠ¨å­åŠå¢å¼ºå­ï¼Œä»¥åŠCTCFç»“åˆä½ç‚¹ï¼‰ã€‚</p>\n<ul>\n<li>ğŸ“œ <strong><a href=\"https://www.nature.com/articles/s41592-025-02881-2\">Read the Paper (Nature Methods 2025)</a></strong></li>\n<li>ğŸ¤— <strong><a href=\"https://huggingface.co/collections/InstaDeepAI/segmentnt-65eb4941c57808b4a3fe1319\">SegmentNT Hugging Face Collection</a></strong></li>\n<li>ğŸš€ <strong><a href=\"https://colab.research.google.com/#fileId=https%3A//huggingface.co/InstaDeepAI/segment_nt/blob/main/inference_segment_nt.ipynb\">SegmentNT Inference Notebook (HF)</a></strong></li>\n</ul>\n<img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Fig01.webp\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Fig01.webp\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt= \"Performance on downstream tasks\" width=\"600\">\n\n<p><em>Fig. 1: SegmentNT localizes genomics elements at nucleotide resolution.</em></p>\n<h1 id=\"2-å¦‚ä½•ä½¿ç”¨-ğŸš€\"><a href=\"#2-å¦‚ä½•ä½¿ç”¨-ğŸš€\" class=\"headerlink\" title=\"2. å¦‚ä½•ä½¿ç”¨ ğŸš€\"></a>2. å¦‚ä½•ä½¿ç”¨ ğŸš€</h1><h2 id=\"2-1-å®‰è£…å¹¶åŠ è½½æ¨¡å—\"><a href=\"#2-1-å®‰è£…å¹¶åŠ è½½æ¨¡å—\" class=\"headerlink\" title=\"2.1 å®‰è£…å¹¶åŠ è½½æ¨¡å—\"></a>2.1 å®‰è£…å¹¶åŠ è½½æ¨¡å—</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!pip install boto3</span><br><span class=\"line\">!pip install matplotlib</span><br><span class=\"line\">!pip install biopython</span><br><span class=\"line\">!pip install dm-haiku</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: boto3 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (1.28.2)</span><br><span class=\"line\">Requirement already satisfied: botocore&lt;1.32.0,&gt;=1.31.2 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (1.31.2)</span><br><span class=\"line\">Requirement already satisfied: jmespath&lt;2.0.0,&gt;=0.7.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (1.0.1)</span><br><span class=\"line\">Requirement already satisfied: s3transfer&lt;0.7.0,&gt;=0.6.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (0.6.1)</span><br><span class=\"line\">Requirement already satisfied: python-dateutil&lt;3.0.0,&gt;=2.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (2.8.2)</span><br><span class=\"line\">Requirement already satisfied: urllib3&lt;1.27,&gt;=1.25.4 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (1.26.16)</span><br><span class=\"line\">Requirement already satisfied: six&gt;=1.5 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from python-dateutil&lt;3.0.0,&gt;=2.1-&gt;botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (1.16.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: matplotlib in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (3.7.2)</span><br><span class=\"line\">Requirement already satisfied: contourpy&gt;=1.0.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.1.0)</span><br><span class=\"line\">Requirement already satisfied: cycler&gt;=0.10 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (0.11.0)</span><br><span class=\"line\">Requirement already satisfied: fonttools&gt;=4.22.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (4.41.0)</span><br><span class=\"line\">Requirement already satisfied: kiwisolver&gt;=1.0.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.4.4)</span><br><span class=\"line\">Requirement already satisfied: numpy&gt;=1.20 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.25.1)</span><br><span class=\"line\">Requirement already satisfied: packaging&gt;=20.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (23.1)</span><br><span class=\"line\">Requirement already satisfied: pillow&gt;=6.2.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (10.0.0)</span><br><span class=\"line\">Requirement already satisfied: pyparsing&lt;3.1,&gt;=2.3.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (3.0.9)</span><br><span class=\"line\">Requirement already satisfied: python-dateutil&gt;=2.7 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (2.8.2)</span><br><span class=\"line\">Requirement already satisfied: six&gt;=1.5 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib) (1.16.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: biopython in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (1.81)</span><br><span class=\"line\">Requirement already satisfied: numpy in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from biopython) (1.25.1)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: dm-haiku in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (0.0.9)</span><br><span class=\"line\">Requirement already satisfied: absl-py&gt;=0.7.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (1.4.0)</span><br><span class=\"line\">Requirement already satisfied: jmp&gt;=0.0.2 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (0.0.4)</span><br><span class=\"line\">Requirement already satisfied: numpy&gt;=1.18.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (1.25.1)</span><br><span class=\"line\">Requirement already satisfied: tabulate&gt;=0.8.9 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (0.9.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"keyword\">import</span> nucleotide_transformer</span><br><span class=\"line\"><span class=\"keyword\">except</span>:</span><br><span class=\"line\">    !pip install git+https://github.com/instadeepai/nucleotide-transformer@main |tail -n <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">import</span> nucleotide_transformer</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&quot;COLAB_TPU_ADDR&quot;</span> <span class=\"keyword\">in</span> os.environ:</span><br><span class=\"line\">    <span class=\"keyword\">from</span> jax.tools <span class=\"keyword\">import</span> colab_tpu</span><br><span class=\"line\"></span><br><span class=\"line\">    colab_tpu.setup_tpu()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-2-SegmentNT\"><a href=\"#2-2-SegmentNT\" class=\"headerlink\" title=\"2.2 SegmentNT\"></a>2.2 SegmentNT</h2><p>âš ï¸ SegmentNT æ¨¡å‹é‡‡ç”¨ <a href=\"https://www.nature.com/articles/s41592-024-02523-z\">æ ¸è‹·é…¸è½¬æ¢å™¨ï¼ˆNTï¼‰</a> ä½œä¸ºéª¨å¹²ç½‘ç»œï¼Œè®­ç»ƒæ•°æ®ä¸º 30,000 ä¸ªæ ¸è‹·é…¸åºåˆ—ï¼ˆå¯¹åº” 5001 ä¸ªæ ‡è®°ï¼ŒåŒ…å« CLS æ ‡è®°ï¼‰ã€‚ä½†ç ”ç©¶è¡¨æ˜ï¼ŒSegmentNT å¯æ³›åŒ–è‡³ 50,000 bpï¼ˆç¢±åŸºå¯¹ï¼‰çš„åºåˆ—ã€‚ç”±äº 30,000 bp çš„è®­ç»ƒé•¿åº¦è¶…è¿‡äº†æ ¸è‹·é…¸è½¬æ¢å™¨æ‰€èƒ½å¤„ç†çš„æœ€å¤§é•¿åº¦ï¼ˆ2048 ä¸ª 6-mer æ ‡è®°ï¼‰ï¼Œå› æ­¤é‡‡ç”¨äº† Yarn ç¼©æ”¾æŠ€æœ¯ã€‚</p>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>ç¼©æ”¾ç³»æ•°ï¼ˆrescaling factorï¼‰</code> å·²è®¾ç½®ä¸ºè®­ç»ƒæ—¶ä½¿ç”¨çš„å€¼ã€‚è‹¥éœ€å¯¹ 30kbp è‡³ 50kbp ä¹‹é—´çš„åºåˆ—è¿›è¡Œæ¨ç†ï¼Œéœ€åœ¨ <code>get_pretrained_segment_nt_model</code> å‡½æ•°ä¸­ä¼ å…¥ <code>rescaling_factor</code> å‚æ•°ï¼Œå…¶å€¼è®¡ç®—å…¬å¼ä¸ºï¼š</p>\n<p><strong>rescaling_factor &#x3D; æœ€å¤§æ ¸è‹·é…¸æ•° &#x2F; æ ¸è‹·é…¸è½¬æ¢å™¨æœ€å¤§æ ‡è®°æ•°</strong></p>\n<p>å…¶ä¸­ï¼Œ<code>æ¨ç†æ—¶ DNA æ ‡è®°æ•°ï¼ˆnum_dna_tokens_inferenceï¼‰</code> æŒ‡æ¨ç†è¿‡ç¨‹ä¸­çš„æ ‡è®°æ€»æ•°ï¼ˆä¾‹å¦‚ 40008 ä¸ªç¢±åŸºå¯¹çš„åºåˆ—å¯¹åº” 6669 ä¸ªæ ‡è®°ï¼‰ï¼Œ<code>æ ¸è‹·é…¸è½¬æ¢å™¨æœ€å¤§æ ‡è®°æ•°ï¼ˆmax_num_tokens_ntï¼‰</code> ä¸ºéª¨å¹²ç½‘ç»œæ ¸è‹·é…¸è½¬æ¢å™¨çš„è®­ç»ƒæœ€å¤§æ ‡è®°æ•°ï¼Œå³ <code>2048</code>ã€‚</p>\n<p>ğŸš§ <font color=\"#FF0000\">SegmentNT æ¨¡å‹ä¸æ”¯æŒè¾“å…¥åºåˆ—ä¸­åŒ…å«ä»»ä½• â€œ<strong>N</strong>â€ ç¢±åŸºã€‚åŸå› æ˜¯æ¯ä¸ªæ ¸è‹·é…¸éœ€è¢«æ ‡è®°åŒ–ä¸º <code>6-mer</code> å½¢å¼ï¼Œè€ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª â€œNâ€ ç¢±åŸºçš„åºåˆ—æ— æ³•æ»¡è¶³è¿™ä¸€æ ‡è®°åŒ–è¦æ±‚ã€‚</font></p>\n<h3 id=\"2-2-1-ğŸ”-ç¤ºä¾‹ä»£ç \"><a href=\"#2-2-1-ğŸ”-ç¤ºä¾‹ä»£ç \" class=\"headerlink\" title=\"2.2.1 ğŸ” ç¤ºä¾‹ä»£ç \"></a>2.2.1 ğŸ” <strong>ç¤ºä¾‹ä»£ç </strong></h3><p>ä¸‹é¢è¿™æ®µä»£ç çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä½¿ç”¨é¢„è®­ç»ƒçš„<code>segment_nt</code>æ¨¡å‹å¯¹ DNA åºåˆ—è¿›è¡ŒåŸºå› ç»„ç‰¹å¾é¢„æµ‹ï¼ˆå¦‚é¢„æµ‹åºåˆ—æ˜¯å¦ä¸ºå†…å«å­ intron ç­‰ï¼‰ï¼Œå¹¶å±•ç¤ºäº†ä»æ¨¡å‹åŠ è½½ã€æ•°æ®é¢„å¤„ç†åˆ°å¹¶è¡Œæ¨ç†çš„å®Œæ•´æµç¨‹ã€‚å…·ä½“åŒ…æ‹¬ï¼š</p>\n<ul>\n<li><strong>ç¯å¢ƒé…ç½®</strong>ï¼šæŒ‡å®š JAX ä½¿ç”¨ CPU è®¾å¤‡ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼ŒåŒæ—¶å‡†å¤‡å¤šè®¾å¤‡å¹¶è¡Œè®¡ç®—ç¯å¢ƒã€‚</li>\n<li><strong>æ¨¡å‹åŠ è½½</strong>ï¼šåŠ è½½é¢„è®­ç»ƒçš„segment_ntæ¨¡å‹ï¼ŒåŒ…æ‹¬æ¨¡å‹å‚æ•°ã€å‰å‘è®¡ç®—å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ Haiku å’Œ JAX çš„å¹¶è¡Œæ¥å£ï¼ˆpmapï¼‰é€‚é…å¤šè®¾å¤‡è®¡ç®—ã€‚</li>\n<li><strong>æ•°æ®å¤„ç†</strong>ï¼šå°†è¾“å…¥çš„ DNA åºåˆ—é€šè¿‡åˆ†è¯å™¨è½¬æ¢ä¸ºæ¨¡å‹å¯è¯†åˆ«çš„ token idsï¼Œå¹¶è½¬æ¢ä¸º JAX æ•°ç»„æ ¼å¼ã€‚</li>\n<li><strong>å¹¶è¡Œæ¨ç†</strong>ï¼šåœ¨å¤šä¸ª CPU è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œæ¨¡å‹ï¼Œè¾“å‡º DNA åºåˆ—å¯¹åº”å„ç±»åŸºå› ç»„ç‰¹å¾çš„é¢„æµ‹æ¦‚ç‡ï¼Œå¹¶é‡ç‚¹æå–äº† â€œintronâ€ï¼ˆå†…å«å­ï¼‰çš„é¢„æµ‹æ¦‚ç‡ã€‚</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯¼å…¥æ‰€éœ€åº“ï¼šhaikuç”¨äºæ„å»ºç¥ç»ç½‘ç»œï¼Œjaxç”¨äºé«˜æ€§èƒ½æ•°å€¼è®¡ç®—ï¼Œjax.numpyæ˜¯jaxçš„numpyæ¥å£</span></span><br><span class=\"line\"><span class=\"comment\"># nucleotide_transformer.pretrainedä¸­çš„get_pretrained_segment_nt_modelç”¨äºè·å–é¢„è®­ç»ƒçš„æ ¸è‹·é…¸åºåˆ—æ¨¡å‹</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_nt_model</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®JAXé»˜è®¤ä½¿ç”¨CPUä½œä¸ºè®¡ç®—è®¾å¤‡ï¼Œé¿å…åœ¨å…¶ä»–è®¾å¤‡ï¼ˆå¦‚GPUï¼‰ä¸Šå¯èƒ½å‡ºç°çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå¢å¼ºä»£ç ç¨³å®šæ€§</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šè®¡ç®—åç«¯ä¸ºCPUï¼Œè·å–æ‰€æœ‰å¯ç”¨çš„CPUè®¾å¤‡ï¼Œå¹¶è®¡ç®—è®¾å¤‡æ•°é‡</span></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Devices found: <span class=\"subst\">&#123;devices&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°æ‰¾åˆ°çš„è®¾å¤‡ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># DNAåºåˆ—tokenæ•°é‡ï¼ˆä¸åŒ…å«å‰ç¼€çš„CLS tokenï¼‰éœ€è¦èƒ½è¢«ä¸‹é‡‡æ ·å—æ•°é‡çš„2çš„å¹‚æ•´é™¤ï¼ˆæ­¤å¤„ä¸‹é‡‡æ ·å—å¯¹åº”çš„å€¼ä¸º4ï¼‰</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">8</span>  <span class=\"comment\"># å®šä¹‰æœ€å¤§æ ¸è‹·é…¸æ•°é‡</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–­è¨€æ£€æŸ¥ï¼šç¡®ä¿max_num_nucleotidesèƒ½è¢«4æ•´é™¤ï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ï¼ˆä¿è¯æ¨¡å‹è¾“å…¥å°ºå¯¸å…¼å®¹ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–é¢„è®­ç»ƒçš„segment_ntæ¨¡å‹ï¼šåŒ…æ‹¬æ¨¡å‹å‚æ•°ã€å‰å‘è®¡ç®—å‡½æ•°ã€åˆ†è¯å™¨å’Œæ¨¡å‹é…ç½®</span></span><br><span class=\"line\"><span class=\"comment\"># å…¶ä¸­ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># - model_nameæŒ‡å®šæ¨¡å‹åä¸º&quot;segment_nt&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># - embeddings_layers_to_saveæŒ‡å®šä¿å­˜ç¬¬29å±‚çš„åµŒå…¥ç‰¹å¾</span></span><br><span class=\"line\"><span class=\"comment\"># - attention_maps_to_saveæŒ‡å®šä¿å­˜(1,4)å’Œ(7,10)ä½ç½®çš„æ³¨æ„åŠ›å›¾</span></span><br><span class=\"line\"><span class=\"comment\"># - max_positionsæŒ‡å®šæœ€å¤§ä½ç½®æ•°ï¼ˆåŒ…å«CLS tokenï¼Œå› æ­¤ä¸ºmax_num_nucleotides + 1ï¼‰</span></span><br><span class=\"line\">parameters, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\"># ç”¨haiku.transformè½¬æ¢å‰å‘å‡½æ•°ï¼Œä½¿å…¶ç¬¦åˆhaikuçš„å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼</span></span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨jax.pmapå¯¹å‰å‘è®¡ç®—å‡½æ•°è¿›è¡Œå¹¶è¡Œæ˜ å°„ï¼ŒæŒ‡å®šè®¡ç®—è®¾å¤‡ï¼Œdonate_argnums=(0,)è¡¨ç¤ºå…è®¸é‡Šæ”¾å‚æ•°çš„å†…å­˜</span></span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å‡†å¤‡è¾“å…¥æ•°æ®å¹¶è¿›è¡Œåˆ†è¯</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;ATTCCGATTCCGATTCCAACGGATTATTCCGATTAACCGATTCCAATT&quot;</span>, <span class=\"string\">&quot;ATTTCTCTCTCTCTCTGAGATCGATGATTTCTCTCTCATCGAACTATG&quot;</span>]  <span class=\"comment\"># ä¸¤ä¸ªDNAåºåˆ—ç¤ºä¾‹</span></span><br><span class=\"line\"><span class=\"comment\"># å¯¹åºåˆ—è¿›è¡Œæ‰¹é‡åˆ†è¯ï¼Œæå–token idsï¼ˆå¿½ç•¥å…ƒç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¿ç•™token idsï¼‰</span></span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"><span class=\"comment\"># å°†token idsè½¬æ¢ä¸ºjaxæ•°ç»„ï¼ˆint32ç±»å‹ï¼‰ï¼Œä½œä¸ºæ¨¡å‹è¾“å…¥</span></span><br><span class=\"line\">tokens = jnp.asarray(tokens_ids, dtype=jnp.int32)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆå§‹åŒ–éšæœºç§å­ï¼Œå¹¶å°†éšæœºé”®å¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡ï¼ˆå¤šè®¾å¤‡å¹¶è¡Œæ—¶ä¿æŒä¸€è‡´æ€§ï¼‰</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\"><span class=\"comment\"># å°†æ¨¡å‹å‚æ•°å¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡</span></span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\"><span class=\"comment\"># å°†è¾“å…¥tokenå¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡</span></span><br><span class=\"line\">tokens = jax.device_put_replicated(tokens, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯¹è¾“å…¥åºåˆ—è¿›è¡Œæ¨¡å‹æ¨ç†</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"><span class=\"comment\"># ä»æ¨ç†ç»“æœä¸­è·å–åŸºå› ç»„ç‰¹å¾çš„logitsï¼ˆæœªå½’ä¸€åŒ–çš„æ¦‚ç‡ï¼‰</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># å°†logitsé€šè¿‡softmaxè½¬æ¢ä¸ºæ¦‚ç‡ï¼Œå¹¶å–æœ€åä¸€ä¸ªç»´åº¦çš„ç»“æœ</span></span><br><span class=\"line\">probabilities = jnp.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Probabilities shape: <span class=\"subst\">&#123;probabilities.shape&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°æ¦‚ç‡çš„å½¢çŠ¶</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰“å°æ¨¡å‹å¯é¢„æµ‹çš„åŸºå› ç»„ç‰¹å¾ï¼ˆå¦‚intronã€exonç­‰ï¼‰</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Features inferred: <span class=\"subst\">&#123;config.features&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–&quot;intron&quot;ï¼ˆå†…å«å­ï¼‰ç‰¹å¾åœ¨ç‰¹å¾åˆ—è¡¨ä¸­çš„ç´¢å¼•</span></span><br><span class=\"line\">idx_intron = config.features.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># æå–&quot;intron&quot;å¯¹åº”çš„æ¦‚ç‡</span></span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°å†…å«å­æ¦‚ç‡çš„å½¢çŠ¶</span></span><br></pre></td></tr></table></figure>\n\n<p>æ”¯æŒçš„æ¨¡å‹å:</p>\n<ul>\n<li><strong>segment_nt</strong></li>\n<li><strong>segment_nt_multi_species</strong></li>\n</ul>\n<h3 id=\"2-2-2-å®Œæ•´ä»£ç \"><a href=\"#2-2-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.2.2 å®Œæ•´ä»£ç \"></a>2.2.2 å®Œæ•´ä»£ç </h3><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ 10kb å’Œ 50kb åºåˆ—è¿›è¡Œæ¨ç†ï¼Œä»¥åŠå¦‚ä½•ç»˜åˆ¶æ¦‚ç‡åˆ†å¸ƒå›¾ä»¥å¤ç°è®ºæ–‡ä¸­çš„å›¾ 1ï¼ˆFig.1dï¼‰ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> Bio <span class=\"keyword\">import</span> SeqIO</span><br><span class=\"line\"><span class=\"keyword\">import</span> gzip</span><br><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> seaborn <span class=\"keyword\">as</span> sns</span><br><span class=\"line\"><span class=\"keyword\">from</span> typing <span class=\"keyword\">import</span> <span class=\"type\">List</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_nt_model</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Specify &quot;cpu&quot; as default (but you can decide to use GPU or TPU in the next cell)</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Devices found: [CpuDevice(id=0)]\n</code></pre>\n<p><strong>ï¼ˆ1ï¼‰æŒ‡å®šåç«¯è®¾å¤‡</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Use either &quot;cpu&quot;, &quot;gpu&quot; or &quot;tpu&quot;</span></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Devices found: <span class=\"subst\">&#123;devices&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰å®šä¹‰ç”¨äºç»˜åˆ¶æ¦‚ç‡çš„å‡½æ•°</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># seaborn settings</span></span><br><span class=\"line\">sns.set_style(<span class=\"string\">&quot;whitegrid&quot;</span>)</span><br><span class=\"line\">sns.set_context(</span><br><span class=\"line\">    <span class=\"string\">&quot;notebook&quot;</span>,</span><br><span class=\"line\">    font_scale=<span class=\"number\">1</span>,</span><br><span class=\"line\">    rc=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;font.size&quot;</span>: <span class=\"number\">14</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;axes.titlesize&quot;</span>: <span class=\"number\">18</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;axes.labelsize&quot;</span>: <span class=\"number\">18</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;xtick.labelsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ytick.labelsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;legend.fontsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;xtick.bottom&#x27;</span>] = <span class=\"literal\">True</span></span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;ytick.left&#x27;</span>] = <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># set colors</span></span><br><span class=\"line\">colors = sns.color_palette(<span class=\"string\">&quot;Set2&quot;</span>).as_hex()</span><br><span class=\"line\">colors2 = sns.color_palette(<span class=\"string\">&quot;husl&quot;</span>).as_hex()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Rearrange order of the features to match Fig.3 from the paper.</span></span><br><span class=\"line\">features_rearranged = [</span><br><span class=\"line\"> <span class=\"string\">&#x27;protein_coding_gene&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;lncRNA&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;5UTR&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;3UTR&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;exon&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;intron&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;splice_donor&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;splice_acceptor&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;promoter_Tissue_specific&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;promoter_Tissue_invariant&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;enhancer_Tissue_specific&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;enhancer_Tissue_invariant&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;CTCF-bound&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;polyA_signal&#x27;</span>,</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">plot_features</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">    predicted_probabilities_all,</span></span><br><span class=\"line\"><span class=\"params\">    seq_length: <span class=\"built_in\">int</span>,</span></span><br><span class=\"line\"><span class=\"params\">    features: <span class=\"type\">List</span>[<span class=\"built_in\">str</span>],</span></span><br><span class=\"line\"><span class=\"params\">    order_to_plot: <span class=\"type\">List</span>[<span class=\"built_in\">str</span>],</span></span><br><span class=\"line\"><span class=\"params\">    fig_width=<span class=\"number\">8</span>,</span></span><br><span class=\"line\"><span class=\"params\"></span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    Function to plot labels and predicted probabilities.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    Args:</span></span><br><span class=\"line\"><span class=\"string\">        predicted_probabilities_all: Probabilities per genomic feature for each</span></span><br><span class=\"line\"><span class=\"string\">            nucleotides in the DNA sequence.</span></span><br><span class=\"line\"><span class=\"string\">        seq_length: DNA sequence length.</span></span><br><span class=\"line\"><span class=\"string\">        feature: Genomic features to plot.</span></span><br><span class=\"line\"><span class=\"string\">        order_to_plot: Order in which to plot the genomic features. This needs to be</span></span><br><span class=\"line\"><span class=\"string\">            specified in order to match the order presented in the Fig.3 of the paper</span></span><br><span class=\"line\"><span class=\"string\">        fig_width: Width of the figure</span></span><br><span class=\"line\"><span class=\"string\">    &quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    sc = <span class=\"number\">1.8</span></span><br><span class=\"line\">    n_panels = <span class=\"number\">7</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># fig, axes = plt.subplots(n_panels, 1, figsize=(fig_width * sc, (n_panels + 2) * sc), height_ratios=[6] + [2] * (n_panels-1))</span></span><br><span class=\"line\">    _, axes = plt.subplots(n_panels, <span class=\"number\">1</span>, figsize=(fig_width * sc, (n_panels + <span class=\"number\">4</span>) * sc))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> n, feat <span class=\"keyword\">in</span> <span class=\"built_in\">enumerate</span>(order_to_plot):</span><br><span class=\"line\">        feat_id = features.index(feat)</span><br><span class=\"line\">        prob_dist = predicted_probabilities_all[:, feat_id]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Use the appropriate subplot</span></span><br><span class=\"line\">        ax = axes[n // <span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            id_color = colors[feat_id]</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            id_color = colors2[feat_id - <span class=\"number\">8</span>]</span><br><span class=\"line\">        ax.plot(</span><br><span class=\"line\">            prob_dist,</span><br><span class=\"line\">            color=id_color,</span><br><span class=\"line\">            label=feat,</span><br><span class=\"line\">            linestyle=<span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">            linewidth=<span class=\"number\">1.5</span>,</span><br><span class=\"line\">        )</span><br><span class=\"line\">        ax.set_xlim(<span class=\"number\">0</span>, seq_length)</span><br><span class=\"line\">        ax.grid(<span class=\"literal\">False</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;bottom&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;top&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;right&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;left&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> <span class=\"built_in\">range</span> (<span class=\"number\">0</span>,n_panels):</span><br><span class=\"line\">        axes[a].set_ylim(<span class=\"number\">0</span>, <span class=\"number\">1.05</span>)</span><br><span class=\"line\">        axes[a].set_ylabel(<span class=\"string\">&quot;Prob.&quot;</span>)</span><br><span class=\"line\">        axes[a].legend(loc=<span class=\"string\">&quot;upper left&quot;</span>, bbox_to_anchor=(<span class=\"number\">1</span>, <span class=\"number\">1</span>), borderaxespad=<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a != (n_panels-<span class=\"number\">1</span>):</span><br><span class=\"line\">            axes[a].tick_params(axis=<span class=\"string\">&#x27;x&#x27;</span>, which=<span class=\"string\">&#x27;both&#x27;</span>, bottom=<span class=\"literal\">True</span>, top=<span class=\"literal\">False</span>, labelbottom=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Set common x-axis label</span></span><br><span class=\"line\">    axes[-<span class=\"number\">1</span>].set_xlabel(<span class=\"string\">&quot;Nucleotides&quot;</span>)</span><br><span class=\"line\">    <span class=\"comment\"># axes[0].axis(&#x27;off&#x27;)  # Turn off the axis</span></span><br><span class=\"line\">    axes[n_panels-<span class=\"number\">1</span>].grid(<span class=\"literal\">False</span>)</span><br><span class=\"line\">    axes[n_panels-<span class=\"number\">1</span>].tick_params(axis=<span class=\"string\">&#x27;y&#x27;</span>, which=<span class=\"string\">&#x27;both&#x27;</span>, left=<span class=\"literal\">True</span>, right=<span class=\"literal\">False</span>, labelleft=<span class=\"literal\">True</span>, labelright=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    axes[<span class=\"number\">0</span>].set_title(<span class=\"string\">&quot;Probabilities predicted over all genomics features&quot;</span>, fontweight=<span class=\"string\">&quot;bold&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ3ï¼‰è·å–äººçš„ 20å·æŸ“è‰²ä½“åºåˆ—</strong></p>\n<p>ä¸ºäº†é‡ç°Segment-NTè®ºæ–‡ä¸­çš„å›¾è¡¨ï¼Œæˆ‘ä»¬åœ¨æ­¤æ£€ç´¢ä¸‹è½½äººç±»20å·æŸ“è‰²ä½“çš„æ–‡ä»¶</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! wget https://ftp.ensembl.org/pub/release-<span class=\"number\">111</span>/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.chromosome<span class=\"number\">.20</span>.fa.gz</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    --2024-07-23 09:38:24--  https://ftp.ensembl.org/pub/release-111/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.chromosome.20.fa.gz</span><br><span class=\"line\">    Resolving ftp.ensembl.org (ftp.ensembl.org)... 193.62.193.169</span><br><span class=\"line\">    Connecting to ftp.ensembl.org (ftp.ensembl.org)|193.62.193.169|:443... connected.</span><br><span class=\"line\">    HTTP request sent, awaiting response... 200 OK</span><br><span class=\"line\">    Length: 18833053 (18M) [application/x-gzip]</span><br><span class=\"line\">    Saving to: â€˜Homo_sapiens.GRCh38.dna.chromosome.20.fa.gzâ€™</span><br><span class=\"line\">    </span><br><span class=\"line\">    Homo_sapiens.GRCh38 100%[===================&gt;]  17,96M  1,77MB/s    in 10s     </span><br><span class=\"line\">    </span><br><span class=\"line\">    2024-07-23 09:38:35 (1,75 MB/s) - â€˜Homo_sapiens.GRCh38.dna.chromosome.20.fa.gzâ€™ saved [18833053/18833053]</span><br><span class=\"line\">```` </span><br><span class=\"line\"></span><br><span class=\"line\">```python</span><br><span class=\"line\">fasta_path = &quot;Homo_sapiens.GRCh38.dna.chromosome.20.fa.gz&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">with gzip.open(fasta_path, &quot;rt&quot;) as handle:</span><br><span class=\"line\">    record = next(SeqIO.parse(handle, &quot;fasta&quot;))</span><br><span class=\"line\">    chr20 = str(record.seq)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ4ï¼‰å¯¹10kbåŸºå› ç»„åºåˆ—è¿›è¡Œæ¨æ–­</strong>ï¼ˆä¸éœ€è¦æ”¹å˜å‰å‘å‡½æ•°ä¸­çš„é‡æ–°ç¼©æ”¾å› å­ï¼‰</p>\n<p><strong>â‘  å®ä¾‹åŒ–SegmentNTæ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½å…¶ä¸­ä¸€ä¸ªSegment-NTæ¨¡å‹çš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<p>ä¸<code>get_pretrained_nucleotide_transformer</code>å‡½æ•°ç±»ä¼¼ï¼Œæ‚¨è¿˜å¯ä»¥æŒ‡å®šï¼š</p>\n<ol>\n<li>æ‚¨å¸Œæœ›æ”¶é›†åµŒå…¥çš„å±‚ï¼ˆä¾‹å¦‚ï¼Œ(5, 10, 20) è¡¨ç¤ºè·å–ç¬¬5ã€10å’Œ20å±‚çš„åµŒå…¥ï¼‰</li>\n<li>æ‚¨å¸Œæœ›æ”¶é›†çš„æ³¨æ„åŠ›å›¾ï¼ˆä¾‹å¦‚ï¼Œ((1,4), (7,18)) è¡¨ç¤ºè·å–å¯¹åº”äºç¬¬1å±‚ç¬¬4å¤´å’Œç¬¬7å±‚ç¬¬18å¤´çš„æ³¨æ„åŠ›å›¾ï¼‰ã€‚è¯·å‚è€ƒé…ç½®ä»¥æŸ¥çœ‹æ¨¡å‹ä¸­çš„å±‚æ•°å’Œå¤´æ•°ã€‚</li>\n<li>æ‚¨å°†è¿›è¡Œæ¨ç†è®¡ç®—çš„åºåˆ—ä¸­çš„æœ€å¤§æ ‡è®°æ•°ã€‚æ‚¨å¯ä»¥è¾“å…¥ä¸è¶…è¿‡æ¨¡å‹é…ç½®ä¸­æŒ‡å®šçš„å€¼ï¼ˆåŒ…å«å°†è‡ªåŠ¨æ·»åŠ åˆ°åºåˆ—å¼€å¤´çš„ç±»æ ‡è®°ï¼‰ï¼Œä½†ä¸ºäº†ä¼˜åŒ–å†…å­˜å’Œæ¨ç†æ—¶é—´ï¼Œæˆ‘ä»¬å»ºè®®å°†æ­¤æ•°å­—å°½å¯èƒ½è®¾å°ã€‚</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by</span></span><br><span class=\"line\"><span class=\"comment\"># the square of the number of downsampling block, i.e 4.</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">1668</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If max_num_nucleotides is larger than what was used to train Segment-NT, the rescaling</span></span><br><span class=\"line\"><span class=\"comment\"># factor needs to be adapted.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> max_num_nucleotides + <span class=\"number\">1</span> &gt; <span class=\"number\">5001</span>:</span><br><span class=\"line\">    inference_rescaling_factor = (max_num_nucleotides + <span class=\"number\">1</span>) / <span class=\"number\">2048</span></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    inference_rescaling_factor=<span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If this download fails at one point, restarting it will not work.</span></span><br><span class=\"line\"><span class=\"comment\"># Before rerunning the cell, make sure to delete the cache by executing:</span></span><br><span class=\"line\"><span class=\"comment\"># ! rm -rf ~/.cache/nucleotide_transformer/</span></span><br><span class=\"line\">parameters, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    rescaling_factor=inference_rescaling_factor,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s hyperparameters json file...\nDownloaded model&#39;s hyperparameters.\nDownloading model&#39;s weights...\nDownloaded model&#39;s weights...\n</code></pre>\n<p><strong>â‘¡ å¯¹DNAåºåˆ—è¿›è¡Œåˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_stop = idx_start + max_num_nucleotides*<span class=\"number\">6</span></span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>(1, 1, 1669)\n</code></pre>\n<p><strong>â‘¢ å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨ç†</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages/jax/interpreters/mlir.py:622: UserWarning: Some donated buffers were not usable: ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[4107,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[4107]), ShapedArray(float32[1024,4107]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[168]), ShapedArray(float32[1024,168]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[2048]), ShapedArray(float32[3,1024,2048]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]).</span><br><span class=\"line\">See an explanation at https://jax.readthedocs.io/en/latest/faq.html#buffer-donation.</span><br><span class=\"line\">  warnings.warn(f&quot;Some donated buffers were not usable: &#123;&#x27;, &#x27;.join(unused_donations)&#125;.\\n&#123;msg&#125;&quot;)</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n<pre><code>(1, 1, 10008, 14)\n</code></pre>\n<p><strong>â‘£ ç»˜åˆ¶è¿™æ¡DNAåºåˆ—ä¸Š14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<p>è¯·æ³¨æ„ï¼ŒSegmentNTè®ºæ–‡ä¸­çš„å›¾1æ˜¯ç”¨SegmentNT-10kbå®ç°çš„ï¼Œè€Œè¿™é‡Œä½¿ç”¨çš„æ˜¯SegmentNT-30kbï¼Œè¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¦‚ç‡å¹¶éå®Œå…¨ç›¸åŒã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>,<span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=config.features,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_26_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_26_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<p><strong>ï¼ˆ5ï¼‰å¯¹50kbçš„åŸºå› ç»„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜å›¾</strong>ï¼ˆéœ€è¦æ›´æ”¹å‰å‘å‡½æ•°ä¸­çš„é‡æ–°ç¼©æ”¾å› å­ï¼‰</p>\n<p><strong>â‘  å®ä¾‹åŒ–SegmentNTæ¨ç†å‡½æ•°</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by</span></span><br><span class=\"line\"><span class=\"comment\"># the square of the number of downsampling block, i.e 4.</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">8332</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If max_num_nucleotides is larger than what was used to train Segment-NT, the rescaling</span></span><br><span class=\"line\"><span class=\"comment\"># factor needs to be adapted.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> max_num_nucleotides + <span class=\"number\">1</span> &gt; <span class=\"number\">5001</span>:</span><br><span class=\"line\">    inference_rescaling_factor = (max_num_nucleotides + <span class=\"number\">1</span>) / <span class=\"number\">2048</span></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    inference_rescaling_factor=<span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The parameters have already been downloaded above</span></span><br><span class=\"line\"><span class=\"comment\"># so we do not instantiate them. However we instantiate a new forward function</span></span><br><span class=\"line\"><span class=\"comment\"># where the context length extension needed is in effect.</span></span><br><span class=\"line\">_, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    rescaling_factor=inference_rescaling_factor,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br></pre></td></tr></table></figure>\n\n<p><strong>â‘¡ å¯¹DNAåºåˆ—è¿›è¡Œåˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idx_start = <span class=\"number\">5099984</span></span><br><span class=\"line\">idx_stop = idx_start + max_num_nucleotides*<span class=\"number\">6</span></span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.asarray(tokens_ids, dtype=jnp.int32)[<span class=\"literal\">None</span>, :]</span><br><span class=\"line\">tokens.shape, idx_stop</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>((1, 1, 8333), 5149976)\n</code></pre>\n<p><strong>â‘¢ å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨ç†</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n<p><strong>â‘£ ç»˜åˆ¶è¿™æ¡DNAåºåˆ—ä¸Š14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>,<span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=config.features,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_35_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_35_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h2 id=\"2-3-SegmentEnformer\"><a href=\"#2-3-SegmentEnformer\" class=\"headerlink\" title=\"2.3 SegmentEnformer\"></a>2.3 SegmentEnformer</h2><p>SegmentEnformerå€ŸåŠ©äº†<a href=\"https://www.nature.com/articles/s41592-021-01252-x\">Enformer</a>ï¼Œå®ƒç§»é™¤äº†é¢„æµ‹å¤´ï¼Œå¹¶ç”¨ä¸€ä¸ªä¸€ç»´U-Netåˆ†å‰²å¤´å–è€Œä»£ä¹‹ï¼Œä»¥å•æ ¸è‹·é…¸åˆ†è¾¨ç‡<strong>é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒä»¶çš„ä½ç½®</strong>ã€‚</p>\n<h3 id=\"2-3-1-ğŸ”-ç¤ºä¾‹\"><a href=\"#2-3-1-ğŸ”-ç¤ºä¾‹\" class=\"headerlink\" title=\"2.3.1 ğŸ” ç¤ºä¾‹\"></a>2.3.1 ğŸ” ç¤ºä¾‹</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_enformer_model</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.features <span class=\"keyword\">import</span> FEATURES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Initialize CPU as default JAX device. This makes the code robust to memory leakage on</span></span><br><span class=\"line\"><span class=\"comment\"># the devices.</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Load model</span></span><br><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_enformer_model()</span><br><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\"></span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replicate over devices</span></span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get data and tokenize it</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">196_608</span>]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)] * num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[..., -<span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get probabilities associated with intron</span></span><br><span class=\"line\">idx_intron = FEATURES.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-2-å®Œæ•´ä»£ç \"><a href=\"#2-3-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.3.2 å®Œæ•´ä»£ç \"></a>2.3.2 å®Œæ•´ä»£ç </h3><p>ä¸‹åˆ—ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ä¸€ä¸ª196,608bp çš„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜åˆ¶æ¦‚ç‡å›¾ã€‚æ¨¡å—å¯¼å…¥ã€åŸºå› ç»„ä¸‹è½½ã€ç»˜å›¾å‡½æ•°å¦‚å‰æ‰€è¿°ï¼Œä¸å†é‡å¤ã€‚</p>\n<p><strong>ï¼ˆ1ï¼‰å®ä¾‹åŒ–SegmentEnformeræ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½SegmentEnformerçš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_enformer_model()</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s weights...\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰DNAåºåˆ—åˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_nucleotides = <span class=\"number\">196_608</span></span><br><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_stop = idx_start + num_nucleotides</span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608)\n</code></pre>\n<p><strong>ï¼ˆ3ï¼‰å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨æ–­</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608, 14)\n</code></pre>\n<p><strong>ï¼ˆ4ï¼‰ç»˜åˆ¶è¯¥DNAåºåˆ—ä¸­14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=FEATURES,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_48_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_48_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h2 id=\"2-4-SegmentBorzoi\"><a href=\"#2-4-SegmentBorzoi\" class=\"headerlink\" title=\"2.4 SegmentBorzoi\"></a>2.4 SegmentBorzoi</h2><p>SegmentBorzoiåˆ©ç”¨äº†<a href=\"https://www.nature.com/articles/s41588-024-02053-6\">Borzoi</a>ï¼Œå®ƒç§»é™¤äº†é¢„æµ‹å¤´ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºä¸€ä¸ªä¸€ç»´U-Netåˆ†å‰²å¤´ï¼Œä»¥<strong>é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒç´ çš„ä½ç½®</strong>ã€‚</p>\n<h3 id=\"2-4-1-ğŸ”-ç¤ºä¾‹\"><a href=\"#2-4-1-ğŸ”-ç¤ºä¾‹\" class=\"headerlink\" title=\"2.4.1 ğŸ” ç¤ºä¾‹\"></a>2.4.1 ğŸ” ç¤ºä¾‹</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.borzoi.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_borzoi_model</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.features <span class=\"keyword\">import</span> FEATURES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Initialize CPU as default JAX device. This makes the code robust to memory leakage on</span></span><br><span class=\"line\"><span class=\"comment\"># the devices.</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Load model</span></span><br><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_borzoi_model()</span><br><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replicate over devices</span></span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get data and tokenize it</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">524_288</span>]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)] * num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[..., -<span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get probabilities associated with intron</span></span><br><span class=\"line\">idx_intron = FEATURES.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-2-å®Œæ•´ä»£ç \"><a href=\"#2-4-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.4.2 å®Œæ•´ä»£ç \"></a>2.4.2 å®Œæ•´ä»£ç </h3><p>ä¸‹è¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ä¸€ä¸ª196608 bp ï¼ˆ524288bpï¼Ÿï¼‰çš„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜åˆ¶æ¦‚ç‡å›¾ã€‚æ¨¡å—å¯¼å…¥ã€åŸºå› ç»„ä¸‹è½½ã€ç»˜å›¾å‡½æ•°å¦‚å‰æ‰€è¿°ï¼Œä¸å†é‡å¤ã€‚</p>\n<p><strong>ï¼ˆ1ï¼‰å®ä¾‹åŒ–SegmentBorzoiæ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½SegmentBorzoiçš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_borzoi_model()</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s weights...\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰DNA åºåˆ—åˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_nucleotides = <span class=\"number\">524_288</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\">idx_stop = idx_start + num_nucleotides</span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 524288)\n</code></pre>\n<p><strong>ï¼ˆ3ï¼‰å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨æ–­</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608, 14)\n</code></pre>\n<p><strong>ï¼ˆ4ï¼‰ç»˜åˆ¶è¯¥DNAåºåˆ—ä¸­14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=FEATURES,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_61_0.png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_61_0.png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"png\"></p>\n<h1 id=\"å‚è€ƒæ–‡çŒ®-ğŸ“š\"><a href=\"#å‚è€ƒæ–‡çŒ®-ğŸ“š\" class=\"headerlink\" title=\"å‚è€ƒæ–‡çŒ® ğŸ“š\"></a>å‚è€ƒæ–‡çŒ® ğŸ“š</h1><ul>\n<li>[1] de Almeida, B.P., Dalla-Torre, H., Richard, G. et al. Annotating the genome at single-nucleotide resolution with DNA foundation models. Nat Methods (2025). <a href=\"https://doi.org/10.1038/s41592-025-02881-2\">https://doi.org/10.1038/s41592-025-02881-2</a></li>\n</ul>\n<h1 id=\"åŠ å…³æ³¨\"><a href=\"#åŠ å…³æ³¨\" class=\"headerlink\" title=\"åŠ å…³æ³¨\"></a>åŠ å…³æ³¨</h1><table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/ç”Ÿä¿¡ä¹‹å·…å…¬ä¼—å·.jpg\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/ç”Ÿä¿¡ä¹‹å·…å…¬ä¼—å·.jpg\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"ç”Ÿä¿¡ä¹‹å·…å¾®ä¿¡å…¬ä¼—å·\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/å°ç¨‹åºç .png\" class=\"lazyload placeholder\" data-srcset=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/å°ç¨‹åºç .png\" srcset=\"https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp\" alt=\"ç”Ÿä¿¡ä¹‹å·…å°ç¨‹åºç \" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n","more":"<h1 id=\"1-Segmentation-models-ç®€ä»‹\"><a href=\"#1-Segmentation-models-ç®€ä»‹\" class=\"headerlink\" title=\"1. Segmentation models ç®€ä»‹\"></a>1. Segmentation models ç®€ä»‹</h1><p>ä½¿ç”¨Transformeréª¨å¹²ç½‘ç»œçš„åˆ†å‰²æ¨¡å‹ï¼ˆå¦‚Nucleotide Transformerã€Enformerã€Borzoiï¼‰å¯ç”¨äºå•æ ¸è‹·é…¸åˆ†è¾¨ç‡ä¸‹çš„åŸºå› ç»„å…ƒä»¶é¢„æµ‹ã€‚ä¾‹å¦‚ï¼Œ<code>SegmentNT</code>èƒ½åœ¨é•¿è¾¾30kbçš„åºåˆ—ï¼ˆå¯æ‰©å±•è‡³50kbpï¼‰ä¸­<strong>é¢„æµ‹14ç§ä¸åŒç±»åˆ«çš„äººç±»åŸºå› ç»„å…ƒä»¶</strong>ï¼Œå¹¶è¡¨ç°å‡ºä¼˜å¼‚çš„æ€§èƒ½ã€‚</p>\n<p>æ‰€æœ‰æ¨¡å‹å‡æ­é…ä¸€ç»´U-Netåˆ†å‰²å¤´ï¼Œä»¥å•æ ¸è‹·é…¸åˆ†è¾¨ç‡é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒä»¶çš„ä½ç½®ã€‚è¿™äº›å…ƒä»¶åŒ…æ‹¬åŸºå› å…ƒä»¶ï¼ˆè›‹ç™½è´¨ç¼–ç åŸºå› ã€é•¿é“¾éç¼–ç RNAã€5â€™éç¿»è¯‘åŒºã€3â€™éç¿»è¯‘åŒºã€å¤–æ˜¾å­ã€å†…å«å­ã€å‰ªæ¥å—ä½“ä½ç‚¹å’Œä¾›ä½“ä½ç‚¹ï¼‰å’Œè°ƒæ§å…ƒä»¶ï¼ˆpolyA signalã€ç»„ç»‡éç‰¹å¼‚æ€§å’Œç»„ç»‡ç‰¹å¼‚æ€§å¯åŠ¨å­åŠå¢å¼ºå­ï¼Œä»¥åŠCTCFç»“åˆä½ç‚¹ï¼‰ã€‚</p>\n<ul>\n<li>ğŸ“œ <strong><a href=\"https://www.nature.com/articles/s41592-025-02881-2\">Read the Paper (Nature Methods 2025)</a></strong></li>\n<li>ğŸ¤— <strong><a href=\"https://huggingface.co/collections/InstaDeepAI/segmentnt-65eb4941c57808b4a3fe1319\">SegmentNT Hugging Face Collection</a></strong></li>\n<li>ğŸš€ <strong><a href=\"https://colab.research.google.com/#fileId=https%3A//huggingface.co/InstaDeepAI/segment_nt/blob/main/inference_segment_nt.ipynb\">SegmentNT Inference Notebook (HF)</a></strong></li>\n</ul>\n<img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Fig01.webp\" alt= \"Performance on downstream tasks\" width=\"600\">\n\n<p><em>Fig. 1: SegmentNT localizes genomics elements at nucleotide resolution.</em></p>\n<h1 id=\"2-å¦‚ä½•ä½¿ç”¨-ğŸš€\"><a href=\"#2-å¦‚ä½•ä½¿ç”¨-ğŸš€\" class=\"headerlink\" title=\"2. å¦‚ä½•ä½¿ç”¨ ğŸš€\"></a>2. å¦‚ä½•ä½¿ç”¨ ğŸš€</h1><h2 id=\"2-1-å®‰è£…å¹¶åŠ è½½æ¨¡å—\"><a href=\"#2-1-å®‰è£…å¹¶åŠ è½½æ¨¡å—\" class=\"headerlink\" title=\"2.1 å®‰è£…å¹¶åŠ è½½æ¨¡å—\"></a>2.1 å®‰è£…å¹¶åŠ è½½æ¨¡å—</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!pip install boto3</span><br><span class=\"line\">!pip install matplotlib</span><br><span class=\"line\">!pip install biopython</span><br><span class=\"line\">!pip install dm-haiku</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: boto3 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (1.28.2)</span><br><span class=\"line\">Requirement already satisfied: botocore&lt;1.32.0,&gt;=1.31.2 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (1.31.2)</span><br><span class=\"line\">Requirement already satisfied: jmespath&lt;2.0.0,&gt;=0.7.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (1.0.1)</span><br><span class=\"line\">Requirement already satisfied: s3transfer&lt;0.7.0,&gt;=0.6.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from boto3) (0.6.1)</span><br><span class=\"line\">Requirement already satisfied: python-dateutil&lt;3.0.0,&gt;=2.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (2.8.2)</span><br><span class=\"line\">Requirement already satisfied: urllib3&lt;1.27,&gt;=1.25.4 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (1.26.16)</span><br><span class=\"line\">Requirement already satisfied: six&gt;=1.5 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from python-dateutil&lt;3.0.0,&gt;=2.1-&gt;botocore&lt;1.32.0,&gt;=1.31.2-&gt;boto3) (1.16.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: matplotlib in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (3.7.2)</span><br><span class=\"line\">Requirement already satisfied: contourpy&gt;=1.0.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.1.0)</span><br><span class=\"line\">Requirement already satisfied: cycler&gt;=0.10 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (0.11.0)</span><br><span class=\"line\">Requirement already satisfied: fonttools&gt;=4.22.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (4.41.0)</span><br><span class=\"line\">Requirement already satisfied: kiwisolver&gt;=1.0.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.4.4)</span><br><span class=\"line\">Requirement already satisfied: numpy&gt;=1.20 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (1.25.1)</span><br><span class=\"line\">Requirement already satisfied: packaging&gt;=20.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (23.1)</span><br><span class=\"line\">Requirement already satisfied: pillow&gt;=6.2.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (10.0.0)</span><br><span class=\"line\">Requirement already satisfied: pyparsing&lt;3.1,&gt;=2.3.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (3.0.9)</span><br><span class=\"line\">Requirement already satisfied: python-dateutil&gt;=2.7 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from matplotlib) (2.8.2)</span><br><span class=\"line\">Requirement already satisfied: six&gt;=1.5 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from python-dateutil&gt;=2.7-&gt;matplotlib) (1.16.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: biopython in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (1.81)</span><br><span class=\"line\">Requirement already satisfied: numpy in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from biopython) (1.25.1)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br><span class=\"line\">Looking in indexes: https://pypi.org/simple, https://packagecloud.io/github/git-lfs/pypi/simple</span><br><span class=\"line\">Requirement already satisfied: dm-haiku in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (0.0.9)</span><br><span class=\"line\">Requirement already satisfied: absl-py&gt;=0.7.1 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (1.4.0)</span><br><span class=\"line\">Requirement already satisfied: jmp&gt;=0.0.2 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (0.0.4)</span><br><span class=\"line\">Requirement already satisfied: numpy&gt;=1.18.0 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (1.25.1)</span><br><span class=\"line\">Requirement already satisfied: tabulate&gt;=0.8.9 in /home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages (from dm-haiku) (0.9.0)</span><br><span class=\"line\"></span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m A new release of pip is available: \u001b[0m\u001b[31;49m24.1.1\u001b[0m\u001b[39;49m -&gt; \u001b[0m\u001b[32;49m24.1.2\u001b[0m</span><br><span class=\"line\">\u001b[1m[\u001b[0m\u001b[34;49mnotice\u001b[0m\u001b[1;39;49m]\u001b[0m\u001b[39;49m To update, run: \u001b[0m\u001b[32;49mpip install --upgrade pip\u001b[0m</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> os</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">try</span>:</span><br><span class=\"line\">    <span class=\"keyword\">import</span> nucleotide_transformer</span><br><span class=\"line\"><span class=\"keyword\">except</span>:</span><br><span class=\"line\">    !pip install git+https://github.com/instadeepai/nucleotide-transformer@main |tail -n <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">import</span> nucleotide_transformer</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"string\">&quot;COLAB_TPU_ADDR&quot;</span> <span class=\"keyword\">in</span> os.environ:</span><br><span class=\"line\">    <span class=\"keyword\">from</span> jax.tools <span class=\"keyword\">import</span> colab_tpu</span><br><span class=\"line\"></span><br><span class=\"line\">    colab_tpu.setup_tpu()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-2-SegmentNT\"><a href=\"#2-2-SegmentNT\" class=\"headerlink\" title=\"2.2 SegmentNT\"></a>2.2 SegmentNT</h2><p>âš ï¸ SegmentNT æ¨¡å‹é‡‡ç”¨ <a href=\"https://www.nature.com/articles/s41592-024-02523-z\">æ ¸è‹·é…¸è½¬æ¢å™¨ï¼ˆNTï¼‰</a> ä½œä¸ºéª¨å¹²ç½‘ç»œï¼Œè®­ç»ƒæ•°æ®ä¸º 30,000 ä¸ªæ ¸è‹·é…¸åºåˆ—ï¼ˆå¯¹åº” 5001 ä¸ªæ ‡è®°ï¼ŒåŒ…å« CLS æ ‡è®°ï¼‰ã€‚ä½†ç ”ç©¶è¡¨æ˜ï¼ŒSegmentNT å¯æ³›åŒ–è‡³ 50,000 bpï¼ˆç¢±åŸºå¯¹ï¼‰çš„åºåˆ—ã€‚ç”±äº 30,000 bp çš„è®­ç»ƒé•¿åº¦è¶…è¿‡äº†æ ¸è‹·é…¸è½¬æ¢å™¨æ‰€èƒ½å¤„ç†çš„æœ€å¤§é•¿åº¦ï¼ˆ2048 ä¸ª 6-mer æ ‡è®°ï¼‰ï¼Œå› æ­¤é‡‡ç”¨äº† Yarn ç¼©æ”¾æŠ€æœ¯ã€‚</p>\n<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>ç¼©æ”¾ç³»æ•°ï¼ˆrescaling factorï¼‰</code> å·²è®¾ç½®ä¸ºè®­ç»ƒæ—¶ä½¿ç”¨çš„å€¼ã€‚è‹¥éœ€å¯¹ 30kbp è‡³ 50kbp ä¹‹é—´çš„åºåˆ—è¿›è¡Œæ¨ç†ï¼Œéœ€åœ¨ <code>get_pretrained_segment_nt_model</code> å‡½æ•°ä¸­ä¼ å…¥ <code>rescaling_factor</code> å‚æ•°ï¼Œå…¶å€¼è®¡ç®—å…¬å¼ä¸ºï¼š</p>\n<p><strong>rescaling_factor &#x3D; æœ€å¤§æ ¸è‹·é…¸æ•° &#x2F; æ ¸è‹·é…¸è½¬æ¢å™¨æœ€å¤§æ ‡è®°æ•°</strong></p>\n<p>å…¶ä¸­ï¼Œ<code>æ¨ç†æ—¶ DNA æ ‡è®°æ•°ï¼ˆnum_dna_tokens_inferenceï¼‰</code> æŒ‡æ¨ç†è¿‡ç¨‹ä¸­çš„æ ‡è®°æ€»æ•°ï¼ˆä¾‹å¦‚ 40008 ä¸ªç¢±åŸºå¯¹çš„åºåˆ—å¯¹åº” 6669 ä¸ªæ ‡è®°ï¼‰ï¼Œ<code>æ ¸è‹·é…¸è½¬æ¢å™¨æœ€å¤§æ ‡è®°æ•°ï¼ˆmax_num_tokens_ntï¼‰</code> ä¸ºéª¨å¹²ç½‘ç»œæ ¸è‹·é…¸è½¬æ¢å™¨çš„è®­ç»ƒæœ€å¤§æ ‡è®°æ•°ï¼Œå³ <code>2048</code>ã€‚</p>\n<p>ğŸš§ <font color=\"#FF0000\">SegmentNT æ¨¡å‹ä¸æ”¯æŒè¾“å…¥åºåˆ—ä¸­åŒ…å«ä»»ä½• â€œ<strong>N</strong>â€ ç¢±åŸºã€‚åŸå› æ˜¯æ¯ä¸ªæ ¸è‹·é…¸éœ€è¢«æ ‡è®°åŒ–ä¸º <code>6-mer</code> å½¢å¼ï¼Œè€ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª â€œNâ€ ç¢±åŸºçš„åºåˆ—æ— æ³•æ»¡è¶³è¿™ä¸€æ ‡è®°åŒ–è¦æ±‚ã€‚</font></p>\n<h3 id=\"2-2-1-ğŸ”-ç¤ºä¾‹ä»£ç \"><a href=\"#2-2-1-ğŸ”-ç¤ºä¾‹ä»£ç \" class=\"headerlink\" title=\"2.2.1 ğŸ” ç¤ºä¾‹ä»£ç \"></a>2.2.1 ğŸ” <strong>ç¤ºä¾‹ä»£ç </strong></h3><p>ä¸‹é¢è¿™æ®µä»£ç çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä½¿ç”¨é¢„è®­ç»ƒçš„<code>segment_nt</code>æ¨¡å‹å¯¹ DNA åºåˆ—è¿›è¡ŒåŸºå› ç»„ç‰¹å¾é¢„æµ‹ï¼ˆå¦‚é¢„æµ‹åºåˆ—æ˜¯å¦ä¸ºå†…å«å­ intron ç­‰ï¼‰ï¼Œå¹¶å±•ç¤ºäº†ä»æ¨¡å‹åŠ è½½ã€æ•°æ®é¢„å¤„ç†åˆ°å¹¶è¡Œæ¨ç†çš„å®Œæ•´æµç¨‹ã€‚å…·ä½“åŒ…æ‹¬ï¼š</p>\n<ul>\n<li><strong>ç¯å¢ƒé…ç½®</strong>ï¼šæŒ‡å®š JAX ä½¿ç”¨ CPU è®¾å¤‡ï¼Œé¿å…å†…å­˜æ³„æ¼ï¼ŒåŒæ—¶å‡†å¤‡å¤šè®¾å¤‡å¹¶è¡Œè®¡ç®—ç¯å¢ƒã€‚</li>\n<li><strong>æ¨¡å‹åŠ è½½</strong>ï¼šåŠ è½½é¢„è®­ç»ƒçš„segment_ntæ¨¡å‹ï¼ŒåŒ…æ‹¬æ¨¡å‹å‚æ•°ã€å‰å‘è®¡ç®—å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ Haiku å’Œ JAX çš„å¹¶è¡Œæ¥å£ï¼ˆpmapï¼‰é€‚é…å¤šè®¾å¤‡è®¡ç®—ã€‚</li>\n<li><strong>æ•°æ®å¤„ç†</strong>ï¼šå°†è¾“å…¥çš„ DNA åºåˆ—é€šè¿‡åˆ†è¯å™¨è½¬æ¢ä¸ºæ¨¡å‹å¯è¯†åˆ«çš„ token idsï¼Œå¹¶è½¬æ¢ä¸º JAX æ•°ç»„æ ¼å¼ã€‚</li>\n<li><strong>å¹¶è¡Œæ¨ç†</strong>ï¼šåœ¨å¤šä¸ª CPU è®¾å¤‡ä¸Šå¹¶è¡Œè¿è¡Œæ¨¡å‹ï¼Œè¾“å‡º DNA åºåˆ—å¯¹åº”å„ç±»åŸºå› ç»„ç‰¹å¾çš„é¢„æµ‹æ¦‚ç‡ï¼Œå¹¶é‡ç‚¹æå–äº† â€œintronâ€ï¼ˆå†…å«å­ï¼‰çš„é¢„æµ‹æ¦‚ç‡ã€‚</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># å¯¼å…¥æ‰€éœ€åº“ï¼šhaikuç”¨äºæ„å»ºç¥ç»ç½‘ç»œï¼Œjaxç”¨äºé«˜æ€§èƒ½æ•°å€¼è®¡ç®—ï¼Œjax.numpyæ˜¯jaxçš„numpyæ¥å£</span></span><br><span class=\"line\"><span class=\"comment\"># nucleotide_transformer.pretrainedä¸­çš„get_pretrained_segment_nt_modelç”¨äºè·å–é¢„è®­ç»ƒçš„æ ¸è‹·é…¸åºåˆ—æ¨¡å‹</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_nt_model</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># é…ç½®JAXé»˜è®¤ä½¿ç”¨CPUä½œä¸ºè®¡ç®—è®¾å¤‡ï¼Œé¿å…åœ¨å…¶ä»–è®¾å¤‡ï¼ˆå¦‚GPUï¼‰ä¸Šå¯èƒ½å‡ºç°çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œå¢å¼ºä»£ç ç¨³å®šæ€§</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æŒ‡å®šè®¡ç®—åç«¯ä¸ºCPUï¼Œè·å–æ‰€æœ‰å¯ç”¨çš„CPUè®¾å¤‡ï¼Œå¹¶è®¡ç®—è®¾å¤‡æ•°é‡</span></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Devices found: <span class=\"subst\">&#123;devices&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°æ‰¾åˆ°çš„è®¾å¤‡ä¿¡æ¯</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># DNAåºåˆ—tokenæ•°é‡ï¼ˆä¸åŒ…å«å‰ç¼€çš„CLS tokenï¼‰éœ€è¦èƒ½è¢«ä¸‹é‡‡æ ·å—æ•°é‡çš„2çš„å¹‚æ•´é™¤ï¼ˆæ­¤å¤„ä¸‹é‡‡æ ·å—å¯¹åº”çš„å€¼ä¸º4ï¼‰</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">8</span>  <span class=\"comment\"># å®šä¹‰æœ€å¤§æ ¸è‹·é…¸æ•°é‡</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ–­è¨€æ£€æŸ¥ï¼šç¡®ä¿max_num_nucleotidesèƒ½è¢«4æ•´é™¤ï¼Œå¦åˆ™æŠ›å‡ºé”™è¯¯ï¼ˆä¿è¯æ¨¡å‹è¾“å…¥å°ºå¯¸å…¼å®¹ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–é¢„è®­ç»ƒçš„segment_ntæ¨¡å‹ï¼šåŒ…æ‹¬æ¨¡å‹å‚æ•°ã€å‰å‘è®¡ç®—å‡½æ•°ã€åˆ†è¯å™¨å’Œæ¨¡å‹é…ç½®</span></span><br><span class=\"line\"><span class=\"comment\"># å…¶ä¸­ï¼š</span></span><br><span class=\"line\"><span class=\"comment\"># - model_nameæŒ‡å®šæ¨¡å‹åä¸º&quot;segment_nt&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># - embeddings_layers_to_saveæŒ‡å®šä¿å­˜ç¬¬29å±‚çš„åµŒå…¥ç‰¹å¾</span></span><br><span class=\"line\"><span class=\"comment\"># - attention_maps_to_saveæŒ‡å®šä¿å­˜(1,4)å’Œ(7,10)ä½ç½®çš„æ³¨æ„åŠ›å›¾</span></span><br><span class=\"line\"><span class=\"comment\"># - max_positionsæŒ‡å®šæœ€å¤§ä½ç½®æ•°ï¼ˆåŒ…å«CLS tokenï¼Œå› æ­¤ä¸ºmax_num_nucleotides + 1ï¼‰</span></span><br><span class=\"line\">parameters, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"comment\"># ç”¨haiku.transformè½¬æ¢å‰å‘å‡½æ•°ï¼Œä½¿å…¶ç¬¦åˆhaikuçš„å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼</span></span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\"><span class=\"comment\"># ä½¿ç”¨jax.pmapå¯¹å‰å‘è®¡ç®—å‡½æ•°è¿›è¡Œå¹¶è¡Œæ˜ å°„ï¼ŒæŒ‡å®šè®¡ç®—è®¾å¤‡ï¼Œdonate_argnums=(0,)è¡¨ç¤ºå…è®¸é‡Šæ”¾å‚æ•°çš„å†…å­˜</span></span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å‡†å¤‡è¾“å…¥æ•°æ®å¹¶è¿›è¡Œåˆ†è¯</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;ATTCCGATTCCGATTCCAACGGATTATTCCGATTAACCGATTCCAATT&quot;</span>, <span class=\"string\">&quot;ATTTCTCTCTCTCTCTGAGATCGATGATTTCTCTCTCATCGAACTATG&quot;</span>]  <span class=\"comment\"># ä¸¤ä¸ªDNAåºåˆ—ç¤ºä¾‹</span></span><br><span class=\"line\"><span class=\"comment\"># å¯¹åºåˆ—è¿›è¡Œæ‰¹é‡åˆ†è¯ï¼Œæå–token idsï¼ˆå¿½ç•¥å…ƒç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¿ç•™token idsï¼‰</span></span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"><span class=\"comment\"># å°†token idsè½¬æ¢ä¸ºjaxæ•°ç»„ï¼ˆint32ç±»å‹ï¼‰ï¼Œä½œä¸ºæ¨¡å‹è¾“å…¥</span></span><br><span class=\"line\">tokens = jnp.asarray(tokens_ids, dtype=jnp.int32)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># åˆå§‹åŒ–éšæœºç§å­ï¼Œå¹¶å°†éšæœºé”®å¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡ï¼ˆå¤šè®¾å¤‡å¹¶è¡Œæ—¶ä¿æŒä¸€è‡´æ€§ï¼‰</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\"><span class=\"comment\"># å°†æ¨¡å‹å‚æ•°å¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡</span></span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\"><span class=\"comment\"># å°†è¾“å…¥tokenå¤åˆ¶åˆ°æ‰€æœ‰è®¾å¤‡</span></span><br><span class=\"line\">tokens = jax.device_put_replicated(tokens, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># å¯¹è¾“å…¥åºåˆ—è¿›è¡Œæ¨¡å‹æ¨ç†</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"><span class=\"comment\"># ä»æ¨ç†ç»“æœä¸­è·å–åŸºå› ç»„ç‰¹å¾çš„logitsï¼ˆæœªå½’ä¸€åŒ–çš„æ¦‚ç‡ï¼‰</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># å°†logitsé€šè¿‡softmaxè½¬æ¢ä¸ºæ¦‚ç‡ï¼Œå¹¶å–æœ€åä¸€ä¸ªç»´åº¦çš„ç»“æœ</span></span><br><span class=\"line\">probabilities = jnp.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Probabilities shape: <span class=\"subst\">&#123;probabilities.shape&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°æ¦‚ç‡çš„å½¢çŠ¶</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># æ‰“å°æ¨¡å‹å¯é¢„æµ‹çš„åŸºå› ç»„ç‰¹å¾ï¼ˆå¦‚intronã€exonç­‰ï¼‰</span></span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Features inferred: <span class=\"subst\">&#123;config.features&#125;</span>&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># è·å–&quot;intron&quot;ï¼ˆå†…å«å­ï¼‰ç‰¹å¾åœ¨ç‰¹å¾åˆ—è¡¨ä¸­çš„ç´¢å¼•</span></span><br><span class=\"line\">idx_intron = config.features.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># æå–&quot;intron&quot;å¯¹åº”çš„æ¦‚ç‡</span></span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)  <span class=\"comment\"># æ‰“å°å†…å«å­æ¦‚ç‡çš„å½¢çŠ¶</span></span><br></pre></td></tr></table></figure>\n\n<p>æ”¯æŒçš„æ¨¡å‹å:</p>\n<ul>\n<li><strong>segment_nt</strong></li>\n<li><strong>segment_nt_multi_species</strong></li>\n</ul>\n<h3 id=\"2-2-2-å®Œæ•´ä»£ç \"><a href=\"#2-2-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.2.2 å®Œæ•´ä»£ç \"></a>2.2.2 å®Œæ•´ä»£ç </h3><p>ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ 10kb å’Œ 50kb åºåˆ—è¿›è¡Œæ¨ç†ï¼Œä»¥åŠå¦‚ä½•ç»˜åˆ¶æ¦‚ç‡åˆ†å¸ƒå›¾ä»¥å¤ç°è®ºæ–‡ä¸­çš„å›¾ 1ï¼ˆFig.1dï¼‰ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> Bio <span class=\"keyword\">import</span> SeqIO</span><br><span class=\"line\"><span class=\"keyword\">import</span> gzip</span><br><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"><span class=\"keyword\">import</span> seaborn <span class=\"keyword\">as</span> sns</span><br><span class=\"line\"><span class=\"keyword\">from</span> typing <span class=\"keyword\">import</span> <span class=\"type\">List</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> matplotlib.pyplot <span class=\"keyword\">as</span> plt</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_nt_model</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Specify &quot;cpu&quot; as default (but you can decide to use GPU or TPU in the next cell)</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Devices found: [CpuDevice(id=0)]\n</code></pre>\n<p><strong>ï¼ˆ1ï¼‰æŒ‡å®šåç«¯è®¾å¤‡</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Use either &quot;cpu&quot;, &quot;gpu&quot; or &quot;tpu&quot;</span></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Devices found: <span class=\"subst\">&#123;devices&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰å®šä¹‰ç”¨äºç»˜åˆ¶æ¦‚ç‡çš„å‡½æ•°</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># seaborn settings</span></span><br><span class=\"line\">sns.set_style(<span class=\"string\">&quot;whitegrid&quot;</span>)</span><br><span class=\"line\">sns.set_context(</span><br><span class=\"line\">    <span class=\"string\">&quot;notebook&quot;</span>,</span><br><span class=\"line\">    font_scale=<span class=\"number\">1</span>,</span><br><span class=\"line\">    rc=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;font.size&quot;</span>: <span class=\"number\">14</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;axes.titlesize&quot;</span>: <span class=\"number\">18</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;axes.labelsize&quot;</span>: <span class=\"number\">18</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;xtick.labelsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ytick.labelsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;legend.fontsize&quot;</span>: <span class=\"number\">16</span>,</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;xtick.bottom&#x27;</span>] = <span class=\"literal\">True</span></span><br><span class=\"line\">plt.rcParams[<span class=\"string\">&#x27;ytick.left&#x27;</span>] = <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># set colors</span></span><br><span class=\"line\">colors = sns.color_palette(<span class=\"string\">&quot;Set2&quot;</span>).as_hex()</span><br><span class=\"line\">colors2 = sns.color_palette(<span class=\"string\">&quot;husl&quot;</span>).as_hex()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Rearrange order of the features to match Fig.3 from the paper.</span></span><br><span class=\"line\">features_rearranged = [</span><br><span class=\"line\"> <span class=\"string\">&#x27;protein_coding_gene&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;lncRNA&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;5UTR&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;3UTR&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;exon&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;intron&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;splice_donor&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;splice_acceptor&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;promoter_Tissue_specific&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;promoter_Tissue_invariant&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;enhancer_Tissue_specific&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;enhancer_Tissue_invariant&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;CTCF-bound&#x27;</span>,</span><br><span class=\"line\"> <span class=\"string\">&#x27;polyA_signal&#x27;</span>,</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">plot_features</span>(<span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">    predicted_probabilities_all,</span></span><br><span class=\"line\"><span class=\"params\">    seq_length: <span class=\"built_in\">int</span>,</span></span><br><span class=\"line\"><span class=\"params\">    features: <span class=\"type\">List</span>[<span class=\"built_in\">str</span>],</span></span><br><span class=\"line\"><span class=\"params\">    order_to_plot: <span class=\"type\">List</span>[<span class=\"built_in\">str</span>],</span></span><br><span class=\"line\"><span class=\"params\">    fig_width=<span class=\"number\">8</span>,</span></span><br><span class=\"line\"><span class=\"params\"></span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    Function to plot labels and predicted probabilities.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    Args:</span></span><br><span class=\"line\"><span class=\"string\">        predicted_probabilities_all: Probabilities per genomic feature for each</span></span><br><span class=\"line\"><span class=\"string\">            nucleotides in the DNA sequence.</span></span><br><span class=\"line\"><span class=\"string\">        seq_length: DNA sequence length.</span></span><br><span class=\"line\"><span class=\"string\">        feature: Genomic features to plot.</span></span><br><span class=\"line\"><span class=\"string\">        order_to_plot: Order in which to plot the genomic features. This needs to be</span></span><br><span class=\"line\"><span class=\"string\">            specified in order to match the order presented in the Fig.3 of the paper</span></span><br><span class=\"line\"><span class=\"string\">        fig_width: Width of the figure</span></span><br><span class=\"line\"><span class=\"string\">    &quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    sc = <span class=\"number\">1.8</span></span><br><span class=\"line\">    n_panels = <span class=\"number\">7</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># fig, axes = plt.subplots(n_panels, 1, figsize=(fig_width * sc, (n_panels + 2) * sc), height_ratios=[6] + [2] * (n_panels-1))</span></span><br><span class=\"line\">    _, axes = plt.subplots(n_panels, <span class=\"number\">1</span>, figsize=(fig_width * sc, (n_panels + <span class=\"number\">4</span>) * sc))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> n, feat <span class=\"keyword\">in</span> <span class=\"built_in\">enumerate</span>(order_to_plot):</span><br><span class=\"line\">        feat_id = features.index(feat)</span><br><span class=\"line\">        prob_dist = predicted_probabilities_all[:, feat_id]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\"># Use the appropriate subplot</span></span><br><span class=\"line\">        ax = axes[n // <span class=\"number\">2</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            id_color = colors[feat_id]</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            id_color = colors2[feat_id - <span class=\"number\">8</span>]</span><br><span class=\"line\">        ax.plot(</span><br><span class=\"line\">            prob_dist,</span><br><span class=\"line\">            color=id_color,</span><br><span class=\"line\">            label=feat,</span><br><span class=\"line\">            linestyle=<span class=\"string\">&quot;-&quot;</span>,</span><br><span class=\"line\">            linewidth=<span class=\"number\">1.5</span>,</span><br><span class=\"line\">        )</span><br><span class=\"line\">        ax.set_xlim(<span class=\"number\">0</span>, seq_length)</span><br><span class=\"line\">        ax.grid(<span class=\"literal\">False</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;bottom&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;top&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;right&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\">        ax.spines[<span class=\"string\">&#x27;left&#x27;</span>].set_color(<span class=\"string\">&#x27;black&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> a <span class=\"keyword\">in</span> <span class=\"built_in\">range</span> (<span class=\"number\">0</span>,n_panels):</span><br><span class=\"line\">        axes[a].set_ylim(<span class=\"number\">0</span>, <span class=\"number\">1.05</span>)</span><br><span class=\"line\">        axes[a].set_ylabel(<span class=\"string\">&quot;Prob.&quot;</span>)</span><br><span class=\"line\">        axes[a].legend(loc=<span class=\"string\">&quot;upper left&quot;</span>, bbox_to_anchor=(<span class=\"number\">1</span>, <span class=\"number\">1</span>), borderaxespad=<span class=\"number\">0</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> a != (n_panels-<span class=\"number\">1</span>):</span><br><span class=\"line\">            axes[a].tick_params(axis=<span class=\"string\">&#x27;x&#x27;</span>, which=<span class=\"string\">&#x27;both&#x27;</span>, bottom=<span class=\"literal\">True</span>, top=<span class=\"literal\">False</span>, labelbottom=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Set common x-axis label</span></span><br><span class=\"line\">    axes[-<span class=\"number\">1</span>].set_xlabel(<span class=\"string\">&quot;Nucleotides&quot;</span>)</span><br><span class=\"line\">    <span class=\"comment\"># axes[0].axis(&#x27;off&#x27;)  # Turn off the axis</span></span><br><span class=\"line\">    axes[n_panels-<span class=\"number\">1</span>].grid(<span class=\"literal\">False</span>)</span><br><span class=\"line\">    axes[n_panels-<span class=\"number\">1</span>].tick_params(axis=<span class=\"string\">&#x27;y&#x27;</span>, which=<span class=\"string\">&#x27;both&#x27;</span>, left=<span class=\"literal\">True</span>, right=<span class=\"literal\">False</span>, labelleft=<span class=\"literal\">True</span>, labelright=<span class=\"literal\">False</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    axes[<span class=\"number\">0</span>].set_title(<span class=\"string\">&quot;Probabilities predicted over all genomics features&quot;</span>, fontweight=<span class=\"string\">&quot;bold&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    plt.show()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ3ï¼‰è·å–äººçš„ 20å·æŸ“è‰²ä½“åºåˆ—</strong></p>\n<p>ä¸ºäº†é‡ç°Segment-NTè®ºæ–‡ä¸­çš„å›¾è¡¨ï¼Œæˆ‘ä»¬åœ¨æ­¤æ£€ç´¢ä¸‹è½½äººç±»20å·æŸ“è‰²ä½“çš„æ–‡ä»¶</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">! wget https://ftp.ensembl.org/pub/release-<span class=\"number\">111</span>/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.chromosome<span class=\"number\">.20</span>.fa.gz</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    --2024-07-23 09:38:24--  https://ftp.ensembl.org/pub/release-111/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.chromosome.20.fa.gz</span><br><span class=\"line\">    Resolving ftp.ensembl.org (ftp.ensembl.org)... 193.62.193.169</span><br><span class=\"line\">    Connecting to ftp.ensembl.org (ftp.ensembl.org)|193.62.193.169|:443... connected.</span><br><span class=\"line\">    HTTP request sent, awaiting response... 200 OK</span><br><span class=\"line\">    Length: 18833053 (18M) [application/x-gzip]</span><br><span class=\"line\">    Saving to: â€˜Homo_sapiens.GRCh38.dna.chromosome.20.fa.gzâ€™</span><br><span class=\"line\">    </span><br><span class=\"line\">    Homo_sapiens.GRCh38 100%[===================&gt;]  17,96M  1,77MB/s    in 10s     </span><br><span class=\"line\">    </span><br><span class=\"line\">    2024-07-23 09:38:35 (1,75 MB/s) - â€˜Homo_sapiens.GRCh38.dna.chromosome.20.fa.gzâ€™ saved [18833053/18833053]</span><br><span class=\"line\">```` </span><br><span class=\"line\"></span><br><span class=\"line\">```python</span><br><span class=\"line\">fasta_path = &quot;Homo_sapiens.GRCh38.dna.chromosome.20.fa.gz&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">with gzip.open(fasta_path, &quot;rt&quot;) as handle:</span><br><span class=\"line\">    record = next(SeqIO.parse(handle, &quot;fasta&quot;))</span><br><span class=\"line\">    chr20 = str(record.seq)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ4ï¼‰å¯¹10kbåŸºå› ç»„åºåˆ—è¿›è¡Œæ¨æ–­</strong>ï¼ˆä¸éœ€è¦æ”¹å˜å‰å‘å‡½æ•°ä¸­çš„é‡æ–°ç¼©æ”¾å› å­ï¼‰</p>\n<p><strong>â‘  å®ä¾‹åŒ–SegmentNTæ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½å…¶ä¸­ä¸€ä¸ªSegment-NTæ¨¡å‹çš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<p>ä¸<code>get_pretrained_nucleotide_transformer</code>å‡½æ•°ç±»ä¼¼ï¼Œæ‚¨è¿˜å¯ä»¥æŒ‡å®šï¼š</p>\n<ol>\n<li>æ‚¨å¸Œæœ›æ”¶é›†åµŒå…¥çš„å±‚ï¼ˆä¾‹å¦‚ï¼Œ(5, 10, 20) è¡¨ç¤ºè·å–ç¬¬5ã€10å’Œ20å±‚çš„åµŒå…¥ï¼‰</li>\n<li>æ‚¨å¸Œæœ›æ”¶é›†çš„æ³¨æ„åŠ›å›¾ï¼ˆä¾‹å¦‚ï¼Œ((1,4), (7,18)) è¡¨ç¤ºè·å–å¯¹åº”äºç¬¬1å±‚ç¬¬4å¤´å’Œç¬¬7å±‚ç¬¬18å¤´çš„æ³¨æ„åŠ›å›¾ï¼‰ã€‚è¯·å‚è€ƒé…ç½®ä»¥æŸ¥çœ‹æ¨¡å‹ä¸­çš„å±‚æ•°å’Œå¤´æ•°ã€‚</li>\n<li>æ‚¨å°†è¿›è¡Œæ¨ç†è®¡ç®—çš„åºåˆ—ä¸­çš„æœ€å¤§æ ‡è®°æ•°ã€‚æ‚¨å¯ä»¥è¾“å…¥ä¸è¶…è¿‡æ¨¡å‹é…ç½®ä¸­æŒ‡å®šçš„å€¼ï¼ˆåŒ…å«å°†è‡ªåŠ¨æ·»åŠ åˆ°åºåˆ—å¼€å¤´çš„ç±»æ ‡è®°ï¼‰ï¼Œä½†ä¸ºäº†ä¼˜åŒ–å†…å­˜å’Œæ¨ç†æ—¶é—´ï¼Œæˆ‘ä»¬å»ºè®®å°†æ­¤æ•°å­—å°½å¯èƒ½è®¾å°ã€‚</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by</span></span><br><span class=\"line\"><span class=\"comment\"># the square of the number of downsampling block, i.e 4.</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">1668</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If max_num_nucleotides is larger than what was used to train Segment-NT, the rescaling</span></span><br><span class=\"line\"><span class=\"comment\"># factor needs to be adapted.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> max_num_nucleotides + <span class=\"number\">1</span> &gt; <span class=\"number\">5001</span>:</span><br><span class=\"line\">    inference_rescaling_factor = (max_num_nucleotides + <span class=\"number\">1</span>) / <span class=\"number\">2048</span></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    inference_rescaling_factor=<span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If this download fails at one point, restarting it will not work.</span></span><br><span class=\"line\"><span class=\"comment\"># Before rerunning the cell, make sure to delete the cache by executing:</span></span><br><span class=\"line\"><span class=\"comment\"># ! rm -rf ~/.cache/nucleotide_transformer/</span></span><br><span class=\"line\">parameters, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    rescaling_factor=inference_rescaling_factor,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s hyperparameters json file...\nDownloaded model&#39;s hyperparameters.\nDownloading model&#39;s weights...\nDownloaded model&#39;s weights...\n</code></pre>\n<p><strong>â‘¡ å¯¹DNAåºåˆ—è¿›è¡Œåˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_stop = idx_start + max_num_nucleotides*<span class=\"number\">6</span></span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>(1, 1, 1669)\n</code></pre>\n<p><strong>â‘¢ å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨ç†</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/home/hugo/anaconda3/envs/trix/lib/python3.10/site-packages/jax/interpreters/mlir.py:622: UserWarning: Some donated buffers were not usable: ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,8192]), ShapedArray(float32[4096,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[4107,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[4107]), ShapedArray(float32[1024,4107]), ShapedArray(float32[1024]), ShapedArray(float32[1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[1024]), ShapedArray(float32[168]), ShapedArray(float32[1024,168]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[2048]), ShapedArray(float32[3,1024,2048]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[2048]), ShapedArray(float32[3,2048,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,2048]), ShapedArray(float32[1024]), ShapedArray(float32[3,1024,1024]).</span><br><span class=\"line\">See an explanation at https://jax.readthedocs.io/en/latest/faq.html#buffer-donation.</span><br><span class=\"line\">  warnings.warn(f&quot;Some donated buffers were not usable: &#123;&#x27;, &#x27;.join(unused_donations)&#125;.\\n&#123;msg&#125;&quot;)</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n<pre><code>(1, 1, 10008, 14)\n</code></pre>\n<p><strong>â‘£ ç»˜åˆ¶è¿™æ¡DNAåºåˆ—ä¸Š14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<p>è¯·æ³¨æ„ï¼ŒSegmentNTè®ºæ–‡ä¸­çš„å›¾1æ˜¯ç”¨SegmentNT-10kbå®ç°çš„ï¼Œè€Œè¿™é‡Œä½¿ç”¨çš„æ˜¯SegmentNT-30kbï¼Œè¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¦‚ç‡å¹¶éå®Œå…¨ç›¸åŒã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>,<span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=config.features,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_26_0.png\" alt=\"png\"></p>\n<p><strong>ï¼ˆ5ï¼‰å¯¹50kbçš„åŸºå› ç»„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜å›¾</strong>ï¼ˆéœ€è¦æ›´æ”¹å‰å‘å‡½æ•°ä¸­çš„é‡æ–°ç¼©æ”¾å› å­ï¼‰</p>\n<p><strong>â‘  å®ä¾‹åŒ–SegmentNTæ¨ç†å‡½æ•°</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by</span></span><br><span class=\"line\"><span class=\"comment\"># the square of the number of downsampling block, i.e 4.</span></span><br><span class=\"line\">max_num_nucleotides = <span class=\"number\">8332</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">assert</span> max_num_nucleotides % <span class=\"number\">4</span> == <span class=\"number\">0</span>, (</span><br><span class=\"line\">    <span class=\"string\">&quot;The number of DNA tokens (excluding the CLS token prepended) needs to be dividible by&quot;</span></span><br><span class=\"line\">     <span class=\"string\">&quot;2 to the power of the number of downsampling block, i.e 4.&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># If max_num_nucleotides is larger than what was used to train Segment-NT, the rescaling</span></span><br><span class=\"line\"><span class=\"comment\"># factor needs to be adapted.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> max_num_nucleotides + <span class=\"number\">1</span> &gt; <span class=\"number\">5001</span>:</span><br><span class=\"line\">    inference_rescaling_factor = (max_num_nucleotides + <span class=\"number\">1</span>) / <span class=\"number\">2048</span></span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    inference_rescaling_factor=<span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The parameters have already been downloaded above</span></span><br><span class=\"line\"><span class=\"comment\"># so we do not instantiate them. However we instantiate a new forward function</span></span><br><span class=\"line\"><span class=\"comment\"># where the context length extension needed is in effect.</span></span><br><span class=\"line\">_, forward_fn, tokenizer, config = get_pretrained_segment_nt_model(</span><br><span class=\"line\">    model_name=<span class=\"string\">&quot;segment_nt&quot;</span>,</span><br><span class=\"line\">    rescaling_factor=inference_rescaling_factor,</span><br><span class=\"line\">    embeddings_layers_to_save=(<span class=\"number\">29</span>,),</span><br><span class=\"line\">    attention_maps_to_save=((<span class=\"number\">1</span>, <span class=\"number\">4</span>), (<span class=\"number\">7</span>, <span class=\"number\">10</span>)),</span><br><span class=\"line\">    max_positions=max_num_nucleotides + <span class=\"number\">1</span>,</span><br><span class=\"line\">)</span><br><span class=\"line\">forward_fn = hk.transform(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br></pre></td></tr></table></figure>\n\n<p><strong>â‘¡ å¯¹DNAåºåˆ—è¿›è¡Œåˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">idx_start = <span class=\"number\">5099984</span></span><br><span class=\"line\">idx_stop = idx_start + max_num_nucleotides*<span class=\"number\">6</span></span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.asarray(tokens_ids, dtype=jnp.int32)[<span class=\"literal\">None</span>, :]</span><br><span class=\"line\">tokens.shape, idx_stop</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<pre><code>((1, 1, 8333), 5149976)\n</code></pre>\n<p><strong>â‘¢ å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨ç†</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs = apply_fn(parameters, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n<p><strong>â‘£ ç»˜åˆ¶è¿™æ¡DNAåºåˆ—ä¸Š14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>,<span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=config.features,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_35_0.png\" alt=\"png\"></p>\n<h2 id=\"2-3-SegmentEnformer\"><a href=\"#2-3-SegmentEnformer\" class=\"headerlink\" title=\"2.3 SegmentEnformer\"></a>2.3 SegmentEnformer</h2><p>SegmentEnformerå€ŸåŠ©äº†<a href=\"https://www.nature.com/articles/s41592-021-01252-x\">Enformer</a>ï¼Œå®ƒç§»é™¤äº†é¢„æµ‹å¤´ï¼Œå¹¶ç”¨ä¸€ä¸ªä¸€ç»´U-Netåˆ†å‰²å¤´å–è€Œä»£ä¹‹ï¼Œä»¥å•æ ¸è‹·é…¸åˆ†è¾¨ç‡<strong>é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒä»¶çš„ä½ç½®</strong>ã€‚</p>\n<h3 id=\"2-3-1-ğŸ”-ç¤ºä¾‹\"><a href=\"#2-3-1-ğŸ”-ç¤ºä¾‹\" class=\"headerlink\" title=\"2.3.1 ğŸ” ç¤ºä¾‹\"></a>2.3.1 ğŸ” ç¤ºä¾‹</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_enformer_model</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.features <span class=\"keyword\">import</span> FEATURES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Initialize CPU as default JAX device. This makes the code robust to memory leakage on</span></span><br><span class=\"line\"><span class=\"comment\"># the devices.</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Load model</span></span><br><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_enformer_model()</span><br><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\"></span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replicate over devices</span></span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get data and tokenize it</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">196_608</span>]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)] * num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[..., -<span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get probabilities associated with intron</span></span><br><span class=\"line\">idx_intron = FEATURES.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-3-2-å®Œæ•´ä»£ç \"><a href=\"#2-3-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.3.2 å®Œæ•´ä»£ç \"></a>2.3.2 å®Œæ•´ä»£ç </h3><p>ä¸‹åˆ—ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ä¸€ä¸ª196,608bp çš„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜åˆ¶æ¦‚ç‡å›¾ã€‚æ¨¡å—å¯¼å…¥ã€åŸºå› ç»„ä¸‹è½½ã€ç»˜å›¾å‡½æ•°å¦‚å‰æ‰€è¿°ï¼Œä¸å†é‡å¤ã€‚</p>\n<p><strong>ï¼ˆ1ï¼‰å®ä¾‹åŒ–SegmentEnformeræ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½SegmentEnformerçš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_enformer_model()</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s weights...\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰DNAåºåˆ—åˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_nucleotides = <span class=\"number\">196_608</span></span><br><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_stop = idx_start + num_nucleotides</span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608)\n</code></pre>\n<p><strong>ï¼ˆ3ï¼‰å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨æ–­</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608, 14)\n</code></pre>\n<p><strong>ï¼ˆ4ï¼‰ç»˜åˆ¶è¯¥DNAåºåˆ—ä¸­14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=FEATURES,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_48_0.png\" alt=\"png\"></p>\n<h2 id=\"2-4-SegmentBorzoi\"><a href=\"#2-4-SegmentBorzoi\" class=\"headerlink\" title=\"2.4 SegmentBorzoi\"></a>2.4 SegmentBorzoi</h2><p>SegmentBorzoiåˆ©ç”¨äº†<a href=\"https://www.nature.com/articles/s41588-024-02053-6\">Borzoi</a>ï¼Œå®ƒç§»é™¤äº†é¢„æµ‹å¤´ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸ºä¸€ä¸ªä¸€ç»´U-Netåˆ†å‰²å¤´ï¼Œä»¥<strong>é¢„æµ‹åºåˆ—ä¸­å¤šç§åŸºå› ç»„å…ƒç´ çš„ä½ç½®</strong>ã€‚</p>\n<h3 id=\"2-4-1-ğŸ”-ç¤ºä¾‹\"><a href=\"#2-4-1-ğŸ”-ç¤ºä¾‹\" class=\"headerlink\" title=\"2.4.1 ğŸ” ç¤ºä¾‹\"></a>2.4.1 ğŸ” ç¤ºä¾‹</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> haiku <span class=\"keyword\">as</span> hk</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax</span><br><span class=\"line\"><span class=\"keyword\">import</span> jax.numpy <span class=\"keyword\">as</span> jnp</span><br><span class=\"line\"><span class=\"keyword\">import</span> numpy <span class=\"keyword\">as</span> np</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.borzoi.pretrained <span class=\"keyword\">import</span> get_pretrained_segment_borzoi_model</span><br><span class=\"line\"><span class=\"keyword\">from</span> nucleotide_transformer.enformer.features <span class=\"keyword\">import</span> FEATURES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Initialize CPU as default JAX device. This makes the code robust to memory leakage on</span></span><br><span class=\"line\"><span class=\"comment\"># the devices.</span></span><br><span class=\"line\">jax.config.update(<span class=\"string\">&quot;jax_platform_name&quot;</span>, <span class=\"string\">&quot;cpu&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">backend = <span class=\"string\">&quot;cpu&quot;</span></span><br><span class=\"line\">devices = jax.devices(backend)</span><br><span class=\"line\">num_devices = <span class=\"built_in\">len</span>(devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Load model</span></span><br><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_borzoi_model()</span><br><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Replicate over devices</span></span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get data and tokenize it</span></span><br><span class=\"line\">sequences = [<span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">524_288</span>]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)] * num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[..., -<span class=\"number\">1</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Get probabilities associated with intron</span></span><br><span class=\"line\">idx_intron = FEATURES.index(<span class=\"string\">&quot;intron&quot;</span>)</span><br><span class=\"line\">probabilities_intron = probabilities[..., idx_intron]</span><br><span class=\"line\"><span class=\"built_in\">print</span>(<span class=\"string\">f&quot;Intron probabilities shape: <span class=\"subst\">&#123;probabilities_intron.shape&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-4-2-å®Œæ•´ä»£ç \"><a href=\"#2-4-2-å®Œæ•´ä»£ç \" class=\"headerlink\" title=\"2.4.2 å®Œæ•´ä»£ç \"></a>2.4.2 å®Œæ•´ä»£ç </h3><p>ä¸‹è¿°ä»£ç å±•ç¤ºäº†å¦‚ä½•å¯¹ä¸€ä¸ª196608 bp ï¼ˆ524288bpï¼Ÿï¼‰çš„åºåˆ—è¿›è¡Œæ¨æ–­å¹¶ç»˜åˆ¶æ¦‚ç‡å›¾ã€‚æ¨¡å—å¯¼å…¥ã€åŸºå› ç»„ä¸‹è½½ã€ç»˜å›¾å‡½æ•°å¦‚å‰æ‰€è¿°ï¼Œä¸å†é‡å¤ã€‚</p>\n<p><strong>ï¼ˆ1ï¼‰å®ä¾‹åŒ–SegmentBorzoiæ¨ç†å‡½æ•°</strong></p>\n<p>ä»¥ä¸‹ä»£ç å…è®¸æ‚¨ä¸‹è½½SegmentBorzoiçš„æƒé‡ã€‚å®ƒä¼šè¿”å›æƒé‡å­—å…¸ã€haikuå‰å‘å‡½æ•°ã€åˆ†è¯å™¨å’Œé…ç½®å­—å…¸ã€‚</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parameters, state, forward_fn, tokenizer, config = get_pretrained_segment_borzoi_model()</span><br></pre></td></tr></table></figure>\n\n<pre><code>Downloading model&#39;s weights...\n</code></pre>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">forward_fn = hk.transform_with_state(forward_fn)</span><br><span class=\"line\">apply_fn = jax.pmap(forward_fn.apply, devices=devices, donate_argnums=(<span class=\"number\">0</span>,))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Put required quantities for the inference on the devices. This step is not</span></span><br><span class=\"line\"><span class=\"comment\"># reproduced in the second inference since the quantities will already be loaded</span></span><br><span class=\"line\"><span class=\"comment\"># on the devices !</span></span><br><span class=\"line\">random_key = jax.random.PRNGKey(seed=<span class=\"number\">0</span>)</span><br><span class=\"line\">keys = jax.device_put_replicated(random_key, devices=devices)</span><br><span class=\"line\">parameters = jax.device_put_replicated(parameters, devices=devices)</span><br><span class=\"line\">state = jax.device_put_replicated(state, devices=devices)</span><br></pre></td></tr></table></figure>\n\n<p><strong>ï¼ˆ2ï¼‰DNA åºåˆ—åˆ†è¯</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num_nucleotides = <span class=\"number\">524_288</span></span><br><span class=\"line\"></span><br><span class=\"line\">idx_start = <span class=\"number\">2650520</span></span><br><span class=\"line\">idx_stop = idx_start + num_nucleotides</span><br><span class=\"line\"></span><br><span class=\"line\">sequences = [chr20[idx_start:idx_stop]]</span><br><span class=\"line\">tokens_ids = [b[<span class=\"number\">1</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\">tokens_str = [b[<span class=\"number\">0</span>] <span class=\"keyword\">for</span> b <span class=\"keyword\">in</span> tokenizer.batch_tokenize(sequences)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This stacks the batch so that it is repeated across the devices. This is done</span></span><br><span class=\"line\"><span class=\"comment\"># in order to allow for replication even if one has more than one device.</span></span><br><span class=\"line\"><span class=\"comment\"># To take advantage of the multiple devices and infer different sequences on</span></span><br><span class=\"line\"><span class=\"comment\"># each of the devices, make sure to change this line into a reshape.</span></span><br><span class=\"line\"><span class=\"comment\"># a reshape</span></span><br><span class=\"line\">tokens = jnp.stack([jnp.asarray(tokens_ids, dtype=jnp.int32)]*num_devices, axis=<span class=\"number\">0</span>)</span><br><span class=\"line\">tokens.shape</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 524288)\n</code></pre>\n<p><strong>ï¼ˆ3ï¼‰å¯¹ç”Ÿæˆçš„æ‰¹æ¬¡è¿›è¡Œæ¨æ–­</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Infer</span></span><br><span class=\"line\">outs, state = apply_fn(parameters, state, keys, tokens) </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Obtain the logits over the genomic features</span></span><br><span class=\"line\">logits = outs[<span class=\"string\">&quot;logits&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\"># Transform them on probabilities</span></span><br><span class=\"line\">probabilities = np.asarray(jax.nn.softmax(logits, axis=-<span class=\"number\">1</span>))[...,-<span class=\"number\">1</span>]</span><br></pre></td></tr></table></figure>\n\n\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">probabilities.shape</span><br></pre></td></tr></table></figure>\n\n\n<pre><code>(1, 1, 196608, 14)\n</code></pre>\n<p><strong>ï¼ˆ4ï¼‰ç»˜åˆ¶è¯¥DNAåºåˆ—ä¸­14ä¸ªåŸºå› ç»„ç‰¹å¾çš„æ¦‚ç‡å›¾</strong></p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">plot_features(</span><br><span class=\"line\">    probabilities[<span class=\"number\">0</span>, <span class=\"number\">0</span>],</span><br><span class=\"line\">    probabilities.shape[-<span class=\"number\">2</span>],</span><br><span class=\"line\">    fig_width=<span class=\"number\">20</span>,</span><br><span class=\"line\">    features=FEATURES,</span><br><span class=\"line\">    order_to_plot=features_rearranged</span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/images/post/BioAI/03/Segmentation_models%E5%AE%9E%E6%88%98_61_0.png\" alt=\"png\"></p>\n<h1 id=\"å‚è€ƒæ–‡çŒ®-ğŸ“š\"><a href=\"#å‚è€ƒæ–‡çŒ®-ğŸ“š\" class=\"headerlink\" title=\"å‚è€ƒæ–‡çŒ® ğŸ“š\"></a>å‚è€ƒæ–‡çŒ® ğŸ“š</h1><ul>\n<li>[1] de Almeida, B.P., Dalla-Torre, H., Richard, G. et al. Annotating the genome at single-nucleotide resolution with DNA foundation models. Nat Methods (2025). <a href=\"https://doi.org/10.1038/s41592-025-02881-2\">https://doi.org/10.1038/s41592-025-02881-2</a></li>\n</ul>\n<h1 id=\"åŠ å…³æ³¨\"><a href=\"#åŠ å…³æ³¨\" class=\"headerlink\" title=\"åŠ å…³æ³¨\"></a>åŠ å…³æ³¨</h1><table align=\"center\"><tr>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/ç”Ÿä¿¡ä¹‹å·…å…¬ä¼—å·.jpg\" alt=\"ç”Ÿä¿¡ä¹‹å·…å¾®ä¿¡å…¬ä¼—å·\" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-right: 0px;margin-bottom: 5px;align: center;\"></td>\n  <td align=\"center\"><img src=\"https://cdn.jsdelivr.net/gh/liaochenlanruo/cdn@master/img/social/å°ç¨‹åºç .png\" alt=\"ç”Ÿä¿¡ä¹‹å·…å°ç¨‹åºç \" style=\"width: 100px;height: 100px;vertical-align: -20px;border-radius: 0%;margin-left: 0px;margin-bottom: 5px;align: center\"></td>\n</tr></table>\n","categories":[{"name":"BioAI","path":"api/categories/BioAI.json"}],"tags":[{"name":"LLM","path":"api/tags/LLM.json"},{"name":"ç”Ÿç‰©ä¿¡æ¯","path":"api/tags/ç”Ÿç‰©ä¿¡æ¯.json"}]}