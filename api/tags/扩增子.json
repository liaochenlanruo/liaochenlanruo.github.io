{"name":"扩增子","postlist":[{"title":"扩增子分析--计算随机过程和决定性过程比例","slug":"扩增子分析-计算随机过程和决定性过程比例","date":"2021-03-25T08:42:06.000Z","updated":"2022-01-08T02:16:28.447Z","comments":true,"path":"api/articles/扩增子分析-计算随机过程和决定性过程比例.json","excerpt":null,"keywords":null,"cover":null,"content":"<p>确定性过程（deterministic processes）和随机性过程（stochastic processes) 是两个影响微生物群落结构系统发育组装的重要过程，本文介绍计算二者所占比例的方法。</p>\n<span id=\"more\"></span>\n<h1 id=\"font-colorff0000-1-软件font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-1-软件font\"></a> <font color=#FF0000 >1. 软件</font></h1>\n<ul>\n<li>NST</li>\n<li>iCAMP</li>\n<li>ape 用于读取进化树文件</li>\n<li>picante</li>\n</ul>\n<h1 id=\"font-colorff0000-2-文件准备font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-2-文件准备font\"></a> <font color=#FF0000 >2. 文件准备</font></h1>\n<h2 id=\"font-colorff0000-21-feature-tablefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-21-feature-tablefont\"></a> <font color=#FF0000 >2.1 Feature Table</font></h2>\n<p>行为 OTUs/ASVs，列为样本。</p>\n<table>\n<thead>\n<tr>\n<th>TaxonID</th>\n<th>Sample 1</th>\n<th>Sample 2</th>\n<th>Sample 3</th>\n<th>Sample 4</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>OTU1</td>\n<td>232.0</td>\n<td>209.0</td>\n<td>349.0</td>\n<td>256.0</td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>75.0</td>\n<td>35.0</td>\n<td>44.0</td>\n<td>0.0</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>237.0</td>\n<td>224.0</td>\n<td>291.0</td>\n<td>353.0</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>371.0</td>\n<td>80.0</td>\n<td>319.0</td>\n<td>345.0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"font-colorff0000-22-group-filefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-22-group-filefont\"></a> <font color=#FF0000 >2.2 Group File</font></h2>\n<p>该文件描述了所有样本的分组情况，如实验组和对照组，或者其他分组。</p>\n<table>\n<thead>\n<tr>\n<th>Sample_ID</th>\n<th>Group</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Sample 1</td>\n<td>Group x</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>Group x</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>Group y</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>Group y</td>\n</tr>\n<tr>\n<td>...</td>\n<td>...</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"font-colorff0000-23-tree-filefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-23-tree-filefont\"></a> <font color=#FF0000 >2.3 Tree File</font></h2>\n<p>包含 Feature table 中所有 OTUs/ASVs 的系统发育树文件，理想条件下仅包含 Feature table 中的 OTUs/ASVs，不过大部分情况下还会包含数据库中的一些物种，在随后的分析中需要去除多余的物种（后续会讲到）。</p>\n<h1 id=\"font-colorff0000-3-开始分析font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-3-开始分析font\"></a> <font color=#FF0000 >3. 开始分析</font></h1>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\">########################</span>\n<span class=\"token comment\">#!/usr/bin/env R</span>\n<span class=\"token comment\"># version 20200919</span>\n<span class=\"token comment\"># Step 1. 文件、路径和参数</span>\n\n<span class=\"token comment\"># 指定包含输入文件的目录路径，注意区分Windows和Linux的路径写法</span>\nwd<span class=\"token operator\">=</span><span class=\"token string\">\"/mnt/e/Researches/lujia16S/Analysis_20200907/exported-feature-table_2k_abund22/Raup_Crick\"</span>\n\n<span class=\"token comment\"># 指定结果文件的保存路径</span>\nsave.wd<span class=\"token operator\">=</span><span class=\"token string\">\"/mnt/e/Researches/lujia16S/Analysis_20200907/exported-feature-table_2k_abund22/Raup_Crick/Result2\"</span>\n\n<span class=\"token comment\"># 创建文件保存路径</span>\ndir.create<span class=\"token punctuation\">(</span>save.wd<span class=\"token punctuation\">,</span> recursive <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 指定Feature table（OTU表）的文件名</span>\ncom.file<span class=\"token operator\">=</span><span class=\"token string\">\"feature-table.tsv\"</span>\n\n<span class=\"token comment\"># 指定样本分组文件，每行为一个样本</span>\ngroup.file<span class=\"token operator\">=</span><span class=\"token string\">\"treatment.txt\"</span>\n\n<span class=\"token comment\"># 指定NWK格式的系统发育树文件</span>\ntree.file<span class=\"token operator\">=</span><span class=\"token string\">\"tree.nwk\"</span>\n\n<span class=\"token comment\"># 设置并行运算使用的线程数</span>\nnworker<span class=\"token operator\">=</span><span class=\"token number\">8</span>\n\n<span class=\"token comment\"># randomization time for null model analysis. 真实分析的时候一般设置为1000，如果测试的话可以设20</span>\nrand.time<span class=\"token operator\">=</span><span class=\"token number\">999</span>\n\n<span class=\"token comment\"># 输出文件的前缀名，随便设置</span>\nprefix<span class=\"token operator\">=</span><span class=\"token string\">\"Lujia\"</span>\n\n<span class=\"token comment\"># Step 2. 加载R包</span>\n\n<span class=\"token comment\"># 确保已经安装过所需的R包</span>\n<span class=\"token comment\">#install.packages(\"NST\") </span>\n\nlibrary<span class=\"token punctuation\">(</span>ape<span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>iCAMP<span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>NST<span class=\"token punctuation\">)</span> <span class=\"token comment\"># need to be NST >=3.0.3</span>\nlibrary<span class=\"token punctuation\">(</span>picante<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Step 3. 加载数据并匹配IDs</span>\n\nsetwd<span class=\"token punctuation\">(</span>wd<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 读入Feature Table，注意自己文件的列与列之间的分隔符是什么，制表符用sep = \"\\t\"，逗号用sep = \",\"</span>\ncomm<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>read.table<span class=\"token punctuation\">(</span>com.file<span class=\"token punctuation\">,</span>header <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> row.names <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> as.is <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> stringsAsFactors <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 读入分组文件，同样注意设置分隔符</span>\ngroup<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span>group.file<span class=\"token punctuation\">,</span> header <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> row.names <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> as.is <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> stringsAsFactors <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#如果tree中的OTUs和Feature Table中的OTUs一一对应，可以直接用下面一个命令读入tree（注意去掉###），否则的话则运行下面LHL加入的3行命令</span>\n<span class=\"token comment\">###tree=ape::read.tree(file = tree.file) # if you have tree</span>\n\n<span class=\"token comment\"># 以下3行是LHL加入的</span>\nphy<span class=\"token operator\">&lt;-</span>read.tree<span class=\"token punctuation\">(</span>tree.file<span class=\"token punctuation\">)</span><span class=\"token comment\"># 读入树文件</span>\nprune_tree<span class=\"token operator\">&lt;-</span>prune.sample<span class=\"token punctuation\">(</span>comm<span class=\"token punctuation\">,</span>phy<span class=\"token punctuation\">)</span><span class=\"token comment\"># 使树文件和OTU表文件一一对齐</span>\ntree<span class=\"token operator\">=</span>prune_tree <span class=\"token comment\"># 此刻的Tree干净了，可用于后续分析而不会报错</span>\n\n<span class=\"token comment\"># 以下命令检测Feature Table中的样本名称是否与分组文件中的样本名一一对应</span>\nsamp.ck<span class=\"token operator\">=</span>NST<span class=\"token operator\">::</span>match.name<span class=\"token punctuation\">(</span>rn.list<span class=\"token operator\">=</span>list<span class=\"token punctuation\">(</span>comm<span class=\"token operator\">=</span>comm<span class=\"token punctuation\">,</span>group<span class=\"token operator\">=</span>group<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ncomm<span class=\"token operator\">=</span>samp.ck<span class=\"token operator\">$</span>comm\ncomm<span class=\"token operator\">=</span>comm<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span>colSums<span class=\"token punctuation\">(</span>comm<span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>drop<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">]</span>\ngroup<span class=\"token operator\">=</span>samp.ck<span class=\"token operator\">$</span>group\n\n<span class=\"token comment\"># 以下命令检测Feature Table中的OTUs名称是否与Tree中的OTUs名一一对应</span>\ntax.ck<span class=\"token operator\">=</span>NST<span class=\"token operator\">::</span>match.name<span class=\"token punctuation\">(</span>cn.list <span class=\"token operator\">=</span> list<span class=\"token punctuation\">(</span>comm<span class=\"token operator\">=</span>comm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>tree.list <span class=\"token operator\">=</span> list<span class=\"token punctuation\">(</span>tree<span class=\"token operator\">=</span>tree<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># if you have tree</span>\ncomm<span class=\"token operator\">=</span>tax.ck<span class=\"token operator\">$</span>comm\ntree<span class=\"token operator\">=</span>tax.ck<span class=\"token operator\">$</span>tree\n\n<span class=\"token comment\"># Step 4. Grouping way and metacommunity seting</span>\n\n<span class=\"token comment\"># 选择分组，如果拥有多种分组方式，每次运行时选择其中的一组。此处选择的时分组文件中的第二列</span>\ngroupi<span class=\"token operator\">=</span>group<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>drop<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 重新定义输出文件的前缀，以分组的名称来命名，此处以分组文件第二列的表头“Group”为前缀</span>\nprefixi<span class=\"token operator\">=</span>paste0<span class=\"token punctuation\">(</span>prefix<span class=\"token punctuation\">,</span><span class=\"token string\">\".Group\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># if treatment and control are from different metacommunities, you may set meta.groupi=groupi，默认为NULL</span>\n<span class=\"token comment\">#meta.groupi=NULL</span>\nmeta.groupi<span class=\"token operator\">=</span>groupi\n\n<span class=\"token comment\"># Step 5. taxonomic NST</span>\n<span class=\"token comment\"># Step 5.1 calculate tNST</span>\n\n<span class=\"token comment\"># 指定计算距离矩阵的方法，\"jaccard\" and \"bray\" are preferred.</span>\ndist.method<span class=\"token operator\">=</span><span class=\"token string\">\"bray\"</span>\n\n<span class=\"token comment\"># 记录运行时间</span>\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 进入输出目录</span>\nsetwd<span class=\"token punctuation\">(</span>save.wd<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 计算tNST</span>\ntnst<span class=\"token operator\">=</span>tNST<span class=\"token punctuation\">(</span>comm<span class=\"token operator\">=</span>comm<span class=\"token punctuation\">,</span> group<span class=\"token operator\">=</span>groupi<span class=\"token punctuation\">,</span> meta.group<span class=\"token operator\">=</span>meta.groupi<span class=\"token punctuation\">,</span> meta.com<span class=\"token operator\">=</span><span class=\"token keyword\">NULL</span><span class=\"token punctuation\">,</span> dist.method<span class=\"token operator\">=</span>dist.method<span class=\"token punctuation\">,</span> abundance.weighted<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> rand<span class=\"token operator\">=</span>rand.time<span class=\"token punctuation\">,</span> output.rand<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> nworker<span class=\"token operator\">=</span>nworker<span class=\"token punctuation\">,</span> LB<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> null.model<span class=\"token operator\">=</span><span class=\"token string\">\"PF\"</span><span class=\"token punctuation\">,</span> between.group<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> SES<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> RC<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 以R data格式保存tNST的输出 </span>\nsave<span class=\"token punctuation\">(</span>tnst<span class=\"token punctuation\">,</span> file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span> <span class=\"token string\">\".tNST.rda\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 保存其他tNST结果到多个文件中</span>\nwrite.table<span class=\"token punctuation\">(</span>tnst<span class=\"token operator\">$</span>index.grp<span class=\"token punctuation\">,</span> file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span> <span class=\"token string\">\".tNST.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>tnst<span class=\"token operator\">$</span>index.pair.grp<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.pairwise.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>tnst<span class=\"token operator\">$</span>index.pair<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.pairwise.index.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\nwrite.table<span class=\"token punctuation\">(</span>tnst<span class=\"token operator\">$</span>index.between<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.between.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>tnst<span class=\"token operator\">$</span>index.pair.between<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.pairwise.between.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nformat<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Step 5.2 Bootstrapping test</span>\n\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 计算Bootstrapping</span>\ntnstbt<span class=\"token operator\">=</span>nst.boot<span class=\"token punctuation\">(</span>nst.result<span class=\"token operator\">=</span>tnst<span class=\"token punctuation\">,</span> group<span class=\"token operator\">=</span>groupi<span class=\"token punctuation\">,</span> rand<span class=\"token operator\">=</span>rand.time<span class=\"token punctuation\">,</span> trace<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> two.tail<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> out.detail<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> between.group<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> nworker<span class=\"token operator\">=</span>nworker<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 保存结果</span>\nsave<span class=\"token punctuation\">(</span>tnstbt<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.boot.rda\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 保存结果</span>\nwrite.table<span class=\"token punctuation\">(</span>tnstbt<span class=\"token operator\">$</span>summary<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.boot.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\nwrite.table<span class=\"token punctuation\">(</span>tnstbt<span class=\"token operator\">$</span>compare<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.boot.compare.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span>t<span class=\"token operator\">=</span>format<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Step 5.3 PERMANOVA</span>\n\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\ntnstpaov<span class=\"token operator\">=</span>nst.panova<span class=\"token punctuation\">(</span>nst.result<span class=\"token operator\">=</span>tnst<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> groupi<span class=\"token punctuation\">,</span> rand <span class=\"token operator\">=</span> rand.time<span class=\"token punctuation\">,</span> trace <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>tnstpaov<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".tNST.PERMANOVA.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">(</span>t<span class=\"token operator\">=</span>format<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Steo 6. phylogenetic NST</span>\n\n<span class=\"token comment\"># Step 6.1 phylogentic distance matrix # use bigmemory for big dataset</span>\n\nwd.pd<span class=\"token operator\">=</span>paste0<span class=\"token punctuation\">(</span>save.wd<span class=\"token punctuation\">,</span><span class=\"token string\">\"/pdbig\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>dir.exists<span class=\"token punctuation\">(</span>wd.pd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>dir.create<span class=\"token punctuation\">(</span>wd.pd<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>\n\nsetwd<span class=\"token punctuation\">(</span>wd.pd<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>file.exists<span class=\"token punctuation\">(</span><span class=\"token string\">\"pd.desc\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\"># if already done before, directly use it.</span>\n  pdbig<span class=\"token operator\">=</span>list<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  pdbig<span class=\"token operator\">$</span>tip.label<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"pd.taxon.name.csv\"</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> row.names <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> header <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> stringsAsFactors <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> as.is <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n  pdbig<span class=\"token operator\">$</span>pd.wd<span class=\"token operator\">=</span>wd.pd\n  pdbig<span class=\"token operator\">$</span>pd.file<span class=\"token operator\">=</span><span class=\"token string\">\"pd.desc\"</span>\n  pdbig<span class=\"token operator\">$</span>pd.name.file<span class=\"token operator\">=</span><span class=\"token string\">\"pd.taxon.name.csv\"</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">&#123;</span>\n  pdbig<span class=\"token operator\">=</span>iCAMP<span class=\"token operator\">::</span>pdist.big<span class=\"token punctuation\">(</span>tree <span class=\"token operator\">=</span> tree<span class=\"token punctuation\">,</span> wd <span class=\"token operator\">=</span> wd.pd<span class=\"token punctuation\">,</span> nworker <span class=\"token operator\">=</span> nworker<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\"># Step 6.2 calculate pNST</span>\n\n<span class=\"token comment\"># to count time cost</span>\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nsetwd<span class=\"token punctuation\">(</span>save.wd<span class=\"token punctuation\">)</span>\n\npnst<span class=\"token operator\">=</span>NST<span class=\"token operator\">::</span>pNST<span class=\"token punctuation\">(</span>comm<span class=\"token operator\">=</span>comm<span class=\"token punctuation\">,</span> pd.desc<span class=\"token operator\">=</span>pdbig<span class=\"token operator\">$</span>pd.file<span class=\"token punctuation\">,</span> pd.wd<span class=\"token operator\">=</span>pdbig<span class=\"token operator\">$</span>pd.wd<span class=\"token punctuation\">,</span>\npd.spname<span class=\"token operator\">=</span>pdbig<span class=\"token operator\">$</span>tip.label<span class=\"token punctuation\">,</span> group<span class=\"token operator\">=</span>groupi<span class=\"token punctuation\">,</span> meta.group<span class=\"token operator\">=</span>meta.groupi<span class=\"token punctuation\">,</span> abundance.weighted<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> rand<span class=\"token operator\">=</span>rand.time<span class=\"token punctuation\">,</span> output.rand<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> taxo.null.model<span class=\"token operator\">=</span><span class=\"token keyword\">NULL</span><span class=\"token punctuation\">,</span> phylo.shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> exclude.conspecifics<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> nworker<span class=\"token operator\">=</span>nworker<span class=\"token punctuation\">,</span> between.group<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> SES<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> RC<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># save pNST output in R data format</span>\nsave<span class=\"token punctuation\">(</span>pnst<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.rda\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnst<span class=\"token operator\">$</span>index.grp<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnst<span class=\"token operator\">$</span>index.pair.grp<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.pairwise.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnst<span class=\"token operator\">$</span>index.pair<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.pairwise.index.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnst<span class=\"token operator\">$</span>index.between<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.between.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnst<span class=\"token operator\">$</span>index.pair.between<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.pairwise.between.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nformat<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Step 6.3 Bootstrapping test</span>\n\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\npnstbt<span class=\"token operator\">=</span>nst.boot<span class=\"token punctuation\">(</span>nst.result<span class=\"token operator\">=</span>pnst<span class=\"token punctuation\">,</span> group<span class=\"token operator\">=</span>groupi<span class=\"token punctuation\">,</span> rand<span class=\"token operator\">=</span>rand.time<span class=\"token punctuation\">,</span> trace<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> two.tail<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> out.detail<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> between.group<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> nworker<span class=\"token operator\">=</span>nworker<span class=\"token punctuation\">)</span>\n\nsave<span class=\"token punctuation\">(</span>pnstbt<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.boot.rda\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnstbt<span class=\"token operator\">$</span>summary<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.boot.summary.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnstbt<span class=\"token operator\">$</span>compare<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.boot.compare.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">(</span>t<span class=\"token operator\">=</span>format<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Step 6.4 PERMANOVA</span>\n\nt1<span class=\"token operator\">=</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\npnstpaov<span class=\"token operator\">=</span>nst.panova<span class=\"token punctuation\">(</span>nst.result<span class=\"token operator\">=</span>pnst<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> groupi<span class=\"token punctuation\">,</span> rand <span class=\"token operator\">=</span> rand.time<span class=\"token punctuation\">,</span> trace <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\nwrite.table<span class=\"token punctuation\">(</span>pnstpaov<span class=\"token punctuation\">,</span>file <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span>prefixi<span class=\"token punctuation\">,</span><span class=\"token string\">\".pNST.PERMANOVA.csv\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span>sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">(</span>t<span class=\"token operator\">=</span>format<span class=\"token punctuation\">(</span>Sys.time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span>t1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"font-colorff0000-4-结果解读font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-4-结果解读font\"></a> <font color=#FF0000 >4. 结果解读</font></h1>\n<h2 id=\"font-colorff0000-41-确定性过程和随机性过程的相对重要性font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-41-确定性过程和随机性过程的相对重要性font\"></a> <font color=#FF0000 >4.1 确定性过程和随机性过程的相对重要性</font></h2>\n<ul>\n<li>\n<p>An index, normalized stochasticity ratio (NST), was developed with 50% as the boundary point between more deterministic (&lt;50%) and more stochastic (&gt;50%) assembly. <font color=#2196F3>NST &gt; 50% 时 Stochastic Processes 占主导，而 NST &lt; 50% 时，Deterministic Processes 占主导。</font></p>\n</li>\n<li>\n<p>用显著的偏差 (即 |β NTI|&gt; 2) 来表示确定性过程占主导地位和用小的偏差 (即 |β NTI| &lt; 2) 来表明随机过程占主导地位。用显著的偏差 (即 |β NTI| &gt; 2) 来表示确定性过程占主导地位和用小的偏差 (即 |β NTI| &lt; 2) 来表明随机过程占主导地位。同质性和变异性选择应分别造成小于和大于预期的群落更替；βNTI &lt;−2 或 &gt; + 2 进一步解释为表明同质性或变异性选择分别占主导地位；</p>\n</li>\n</ul>\n<h2 id=\"font-colorff0000-42-通过rcbray判断随机过程中各种过程的贡献font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-42-通过rcbray判断随机过程中各种过程的贡献font\"></a> <font color=#FF0000 >4.2 通过 RCbray 判断随机过程中各种过程的贡献</font></h2>\n<p>Modified Raup-Crick index (RCbray) is subsequently calculated by comparing empirically observed Bray-Curtis and simulated null distribution. Thus, according to themodified Raup-Crick index (RCbray), stochastic processes could be classified into 3 ecological processes: 均质分散 homogenizing dispersal (RCbray &lt; −0.95), 分散限制 dispersal limitation (RCbray &gt; +0.95) and 生态漂变 ecological drift (−0.95&lt; RCbray &lt; +0.95) <a href=\"https://doi.org/10.1038/ismej.2012.22\">Stegen et al., 2012</a>;  <a href=\"https://doi.org/10.1038/ismej.2013.93\">Stegen et al., 2013</a>.</p>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"扩增子","path":"api/tags/扩增子.json"}]},{"title":"扩增子系之绘制物种分类堆叠图","slug":"扩增子系之绘制物种分类堆叠图","date":"2021-09-27T09:09:53.000Z","updated":"2022-01-08T02:16:28.448Z","comments":true,"path":"api/articles/扩增子系之绘制物种分类堆叠图.json","excerpt":null,"keywords":null,"cover":null,"content":"<p><strong>为何要手绘堆叠图？</strong><br />\nQIIME2 虽然可以生成堆叠图，然而图片只能在网页上查看，无法下载。此外，QIIME2 的图有几分丑，且不可个性化修改，因此，手绘最靠谱。手绘当然不是用手画，而是用手敲代码。</p>\n<h1 id=\"输入文件\"><a class=\"markdownIt-Anchor\" href=\"#输入文件\"></a> 输入文件</h1>\n<ul>\n<li>各级别的物种分布文件，可以直接从 QIIME2 生成的 taxa_barplot.qzv 文件提交至 <a href=\"https://view.qiime2.org\">https://view.qiime2.org</a> ，随后从网页左上角 “CSV” 按钮处导出各分类级别的丰度表，但是要删除风度表最后几列的元数据信息，只保留丰度信息，各列之间以逗号分隔，内容如下所示，该文件是 LEVEL-2（Phylum）水平的物种丰度分布：</li>\n</ul>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">index,Bacteria;Chloroflexi,Bacteria;Planctomycetota,Archaea;Nanoarchaeota,Bacteria;Patescibacteria,Bacteria;Proteobacteria,Bacteria;Actinobacteriota,Archaea;Aenigmarchaeota,Bacteria;Acidobacteriota,Archaea;Altiarchaeota,Bacteria;Firmicutes,Bacteria;Bdellovibrionota,Bacteria;Dependentiae,Bacteria;Spirochaetota,Bacteria;Margulisbacteria,Bacteria;Myxococcota,Archaea;Halobacterota,Archaea;Crenarchaeota,Bacteria;Latescibacterota,Bacteria;NB1-j,Bacteria;Desulfobacterota,Bacteria;Verrucomicrobiota,Archaea;Iainarchaeota,Bacteria;DTB120,Bacteria;Elusimicrobiota,Eukaryota;SAR,Archaea;Asgardarchaeota,Archaea;Euryarchaeota,Bacteria;CK-2C2-2,Bacteria;Sva0485,Archaea;Thermoplasmatota,Bacteria;Bacteroidota,Bacteria;Marinimicrobia (SAR406 clade),Bacteria;MBNT15,Bacteria;Nitrospinota,Bacteria;Zixibacteria,Bacteria;Nitrospirota,Archaea;Micrarchaeota,Bacteria;LCP-89,Bacteria;Armatimonadota,Bacteria;WOR-1,Bacteria;Gemmatimonadota,Bacteria;Fibrobacterota,Bacteria;Calditrichota,Bacteria;Sumerlaeota,Bacteria;Aerophobota,Bacteria;WS1,Bacteria;NKB15,Bacteria;SAR324 clade(Marine group B),Bacteria;Dadabacteria,Bacteria;BHI80-139,Bacteria;Desantisbacteria,Bacteria;Schekmanbacteria,Archaea;Hadarchaeota,Archaea;Hydrothermarchaeota,Bacteria;Caldatribacteriota,Bacteria;TA06,Bacteria;WS2,Eukaryota;Amorphea,Bacteria;Cyanobacteria,Bacteria;Hydrogenedentes,Bacteria;Cloacimonadota,Bacteria;WPS-2,Bacteria;Modulibacteria,Eukaryota;Archaeplastida,Bacteria;10bav-F6,Bacteria;Methylomirabilota,Bacteria;Deferrisomatota,Bacteria;Fusobacteriota,Bacteria;Fermentibacterota,Bacteria;Entotheonellaeota,Eukaryota;Discoba,Bacteria;Campylobacterota,Bacteria;PAUC34f,Bacteria;Poribacteria,Bacteria;AncK6,Bacteria;GN01,Bacteria;Acetothermia,Bacteria;FCPU426\nB01,383,1058,157,274,7755,1317,0,1025,0,39,22,16,0,0,71,0,6841,20,633,49,145,0,0,0,247,13,0,0,0,13,1012,0,0,53,0,137,0,0,39,0,271,7,17,4,0,0,0,7,471,0,0,0,0,0,3,0,0,69,3,53,0,0,0,0,0,46,0,0,0,0,0,0,0,0,0,0,0,0\nB02,225,507,98,27,3279,228,0,522,0,10,4,0,0,0,25,0,7995,8,336,6,54,0,0,0,9,4,0,0,0,0,259,0,12,65,0,29,0,0,0,0,163,0,16,0,0,0,0,22,106,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,71,0,0,0,0,0,0,0,0,0,0,0,0\nB03,196,360,246,38,2605,119,0,587,0,8,5,0,0,0,172,0,11619,16,370,11,0,3,0,0,13,0,0,0,0,0,206,5,0,83,8,67,0,0,0,0,130,0,5,0,0,0,0,27,136,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,120,0,0,0,0,0,0,0,0,0,0,0,0\nB04,437,922,636,61,4209,195,0,1051,0,9,5,6,0,0,274,0,14573,22,628,5,88,9,0,0,17,8,0,0,0,26,271,14,0,129,7,95,0,0,0,0,219,0,20,0,0,0,0,84,145,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,467,0,0,0,5,0,0,12,0,0,0,0,0\nB05,240,1159,187,26,2929,149,0,778,0,8,0,0,0,0,204,0,10918,26,473,0,20,0,0,7,10,8,0,0,0,0,193,9,0,209,0,96,0,0,2,0,244,3,19,0,0,0,0,131,125,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,532,0,0,0,12,0,0,0,0,0,0,0,0\nB06,211,2003,1380,168,2469,188,12,617,3,13,4,15,7,2,196,0,7802,16,383,47,94,0,0,22,7,43,25,0,0,84,223,33,0,244,5,112,0,0,0,0,204,8,28,8,0,0,0,69,105,0,5,0,0,8,0,0,0,0,0,0,0,0,0,0,0,639,0,0,0,9,0,0,0,0,0,0,0,0\nB07,231,2607,4129,694,2667,231,20,399,12,36,10,21,37,0,156,0,5611,47,453,76,93,112,0,16,21,187,53,0,0,267,196,73,0,106,0,74,0,0,0,24,169,8,37,6,6,0,5,82,118,0,7,0,0,0,0,0,0,4,0,0,0,0,0,0,0,399,0,0,0,8,0,0,0,0,0,0,0,0\nB08,228,2573,4942,604,2084,150,51,507,7,14,0,22,32,2,109,0,6026,28,269,58,156,94,0,31,7,193,21,0,0,264,220,11,4,212,0,67,4,0,0,65,113,3,26,0,0,0,0,81,108,0,0,5,0,0,0,0,0,0,0,13,0,0,0,0,0,468,0,0,0,21,0,0,7,0,0,0,0,0\nB09,606,3235,2950,1247,1922,696,52,487,16,21,20,84,12,0,107,0,1559,80,341,478,198,148,0,34,63,131,6,3,9,144,141,30,6,106,13,87,42,0,4,0,205,6,76,5,8,11,8,142,70,9,0,3,0,15,0,0,0,0,0,7,0,0,0,0,0,508,0,0,0,18,0,5,0,0,0,0,0,0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>样本元数据，描述各样本特征的文件，以制表符分隔各列，内容如下：</li>\n</ul>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">ID\tSamples\tLayer\tDepth\tLocation\tPosition\tSite\nB01\tB01\t0-1\t5\tRight\tDownstream\tB\nB02\tB02\t1-2\t5\tRight\tDownstream\tB\nB03\tB03\t2-3\t5\tRight\tDownstream\tB\nB04\tB04\t3-4\t5\tRight\tDownstream\tB\nB05\tB05\t4-5\t5\tRight\tDownstream\tB\nB06\tB06\t5-6\t10\tRight\tDownstream\tB\nB07\tB07\t6-7\t10\tRight\tDownstream\tB\nB08\tB08\t7-8\t10\tRight\tDownstream\tB\nB09\tB09\t8-9\t10\tRight\tDownstream\tB<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"代码\"><a class=\"markdownIt-Anchor\" href=\"#代码\"></a> 代码</h1>\n<p><strong>建议在 Rstudio 中运行。</strong></p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 首先需要安装依赖包“amplicon”，如果没有安装“devtools”需要先安装，命令如下：</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">,</span> quietly<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">)</span>\n\nlibrary<span class=\"token punctuation\">(</span>devtools<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 安装依赖包“amplicon”，我对原作者的程序做了些许的优化，所以，可以从我的GitHub进行安装，命令如下：</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"amplicon\"</span><span class=\"token punctuation\">,</span> quietly<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"liaochenlanruo/amplicon\"</span><span class=\"token punctuation\">)</span>\nsuppressWarnings<span class=\"token punctuation\">(</span>suppressMessages<span class=\"token punctuation\">(</span>library<span class=\"token punctuation\">(</span>amplicon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 设置工作目录，视自己的具体情况而定，工作目录中当包含输入文件：</span>\nsetwd<span class=\"token punctuation\">(</span><span class=\"token string\">\"E:/Researches/Xiaqian/NGS/CleanData/ALL/细菌V6V8-1/Analysis_20210624/barplot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 从文件读取元数据和物种注释</span>\nmetadata<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"sample-metadata.tsv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\ntaxonomy<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"taxonomy.tsv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 绘制堆叠柱状图，颜色自定义。界水平物种组成表和元数据作为输入，分组列名为Group，显示前4个分类，其余归类为其他(Other)，按丰度排序。</span>\notutab1<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"level-1.csv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\notutab1<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otutab1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#按照站位分组，通过“groupID”参数设置分组信息，这里我选择根据站位（Site）分组，用户当根据自己的实际情况来设置。</span>\n<span class=\"token punctuation\">(</span>ds<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab1<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nds2 <span class=\"token operator\">=</span> ds <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 出图</span>\nds2\n\n<span class=\"token comment\">#按照深度分组</span>\n<span class=\"token punctuation\">(</span>dd<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab1<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Depth\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ndd2 <span class=\"token operator\">=</span> dd <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ndd2\n\n<span class=\"token comment\"># 门水平物种组成表和元数据作为输入，分组列名为Group，显示前19个分类，按丰度排序</span>\notutab2<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"level-2.csv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\notutab2<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otutab2<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#按照站位分组</span>\n<span class=\"token punctuation\">(</span>ps<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab2<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nps2 <span class=\"token operator\">=</span> ps <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nps2\n\n<span class=\"token comment\">#按照深度分组</span>\n<span class=\"token punctuation\">(</span>pd<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab2<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Depth\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\npd2 <span class=\"token operator\">=</span> pd <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\npd2\n\n<span class=\"token comment\"># 纲水平物种组成表和元数据作为输入，分组列名为Group，显示前19个分类，按丰度排序</span>\notutab3<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"level-3.csv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">,</span> quote<span class=\"token operator\">=</span><span class=\"token string\">\"\\\"\"</span><span class=\"token punctuation\">)</span>\n\notutab3<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otutab3<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#按照站位分组</span>\n<span class=\"token punctuation\">(</span>cs<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab3<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncs2 <span class=\"token operator\">=</span> cs <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncs2\n\n<span class=\"token comment\">#按照深度分组</span>\n<span class=\"token punctuation\">(</span>cd<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab3<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Depth\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncd2 <span class=\"token operator\">=</span> cd <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncd2\n\n<span class=\"token comment\"># 属水平物种组成表和元数据作为输入，分组列名为Site，显示前19个分类，按丰度排序</span>\notutab6<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"level-6.csv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\notutab6<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otutab6<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#按照站位分组</span>\n<span class=\"token punctuation\">(</span>gs<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab6<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ngs2 <span class=\"token operator\">=</span> gs <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ngs2\n\n<span class=\"token comment\">#按照深度分组</span>\n<span class=\"token punctuation\">(</span>gd<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab6<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Depth\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ngd2 <span class=\"token operator\">=</span> gd <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ngd2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<p>最后的图可以在 Rstudio 中手动导出。</p>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\"><iframe src=\"//player.bilibili.com/player.html?aid=378319348&page=\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\"></iframe></div>\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"可视化","path":"api/categories/可视化.json"}],"tags":[{"name":"SY179","path":"api/tags/SY179.json"},{"name":"R语言","path":"api/tags/R语言.json"},{"name":"扩增子","path":"api/tags/扩增子.json"}]},{"title":"扩增子可视化专题","slug":"扩增子可视化专题","date":"2021-09-15T03:23:28.000Z","updated":"2022-01-08T02:16:28.447Z","comments":true,"path":"api/articles/扩增子可视化专题.json","excerpt":null,"keywords":null,"cover":null,"content":"<p>扩增子分析较常用的软件是 QIIME2，然而其生成的图并不美观，且无法下载，是不可能够达到发表要求的，因此需要我们通过其他方法将 QIIME2 生成的数据结果进行可视化。本文将记录相关的分析方法和示例。</p>\n<h1 id=\"准备数据\"><a class=\"markdownIt-Anchor\" href=\"#准备数据\"></a> 准备数据</h1>\n<ul>\n<li>特征表（Feature table），或者叫做 OTU 表，本教程中文件名为<strong> feature-table.tsv</strong>。该文件可由 QIIME2 生成，由 biome 格式转换而来。</li>\n</ul>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">\tF01\tF02\tF03\tF04\tF05\tF06\tH2_1\tH2_2\tH2_3\tH2_4\tH2_5\tH2_6\tI1_1\tI1_2\tI1_3\tI1_4\tI1_5\tI1_6\n3733c766539aba5e3e8f964a5ba39048\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t6.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\n547715c94c5b0c7ba2049658f732397b\t0.0\t0.0\t0.0\t6.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\n708c69ff1252447c0709333304cd9bed\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t5.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\n344ee69a9e51ffac2811294d3f04833d\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t7.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\nd2e467b7867f49c25caaacdea5c7eb43\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t18.0\t0.0\t0.0\t0.0\t0.0\n4adc9b2b0866f620425d07d3ff7ca7e2\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t8.0\t0.0\t0.0\t0.0\t0.0\n0ffcdef70b9c1436126ba32d7a40d961\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t31.0\t0.0\t0.0\t0.0\n7170ce6c7520acc3c13189478aea54a8\t53.0\t0.0\t0.0\t0.0\t0.0\t0.0\t37.0\t25.0\t0.0\t0.0\t0.0\t0.0\t23.0\t21.0\t0.0\t0.0\t0.0\t0.0\nb624986630f3d33fbe0a21e66c46d1a5\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t9.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\n78305c3f5955043aba7de952c78859c9\t0.0\t0.0\t22.0\t57.0\t73.0\t55.0\t0.0\t0.0\t0.0\t82.0\t73.0\t0.0\t0.0\t0.0\t43.0\t132.0\t82.0\t95.0\n60d9992b10f6dd4da4dc53826b7433f5\t0.0\t0.0\t0.0\t0.0\t45.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\n33468988848349138af5cb1c23b550f2\t0.0\t2.0\t11.0\t12.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0\t0.0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>样本元数据（Metadata），本教程中文件名为<strong> sample-metadata.tsv</strong>。该文件由分析者自己准备，用于描述各个样本的特征。</li>\n</ul>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">  ID\tSamples\tLayer\tDepth\tDepth2\tLocation\tPosition\tSite\nF01\tF01\t0-5\t5\t05 cmbsf\tTurn\tUpstream\tF\nF02\tF02\t5-9\t10\t10 cmbsf\tTurn\tUpstream\tF\nF03\tF03\t9-13\t15\t15 cmbsf\tTurn\tUpstream\tF\nF04\tF04\t13-17\t15\t15 cmbsf\tTurn\tUpstream\tF\nF05\tF05\t17-22\t20\t20 cmbsf\tTurn\tUpstream\tF\nF06\tF06\t22-26\t25\t25 cmbsf\tTurn\tUpstream\tF\nH2_1\tH2_1\t0-5\t5\t05 cmbsf\tLeft\tUpstream\tH2\nH2_2\tH2_2\t5-10\t10\t10 cmbsf\tLeft\tUpstream\tH2\nH2_3\tH2_3\t10-15\t15\t15 cmbsf\tLeft\tUpstream\tH2\nH2_4\tH2_4\t15-20\t20\t20 cmbsf\tLeft\tUpstream\tH2\nH2_5\tH2_5\t20-25\t25\t25 cmbsf\tLeft\tUpstream\tH2\nH2_6\tH2_6\t25-29\t30\t30 cmbsf\tLeft\tUpstream\tH2\nI1_1\tI1_1\t0-5\t5\t05 cmbsf\tLeft\tUpstream\tI1\nI1_2\tI1_2\t5-10\t10\t10 cmbsf\tLeft\tUpstream\tI1\nI1_3\tI1_3\t10-15\t15\t15 cmbsf\tLeft\tUpstream\tI1\nI1_4\tI1_4\t15-20\t20\t20 cmbsf\tLeft\tUpstream\tI1\nI1_5\tI1_5\t20-25\t25\t25 cmbsf\tLeft\tUpstream\tI1\nI1_6\tI1_6\t25-29\t30\t30 cmbsf\tLeft\tUpstream\tI1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>分类信息，本教程中文件名为<strong> taxonomy.tsv</strong>。该文件可由 QIIME2 生成。</li>\n</ul>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">Feature ID\tTaxon\tConfidence\n9e24eb7a415db9a59586d17d0f49cbea\tArchaea;Asgardarchaeota;Lokiarchaeia\t0.9999999998216045\n2a1d71d9fca92f9b3fc8f3126db076d0\tBacteria;Proteobacteria;Gammaproteobacteria;Pseudomonadales;Pseudomonadaceae;Pseudomonas\t0.9881304182870394\n5d89868f1a1db1bc0b153eca96bbf7fd\tArchaea;Crenarchaeota;Nitrososphaeria;Nitrosopumilales;Nitrosopumilaceae\t0.9999999999859067\ncc957f2e853493d72875a6528ca83435\tArchaea;Crenarchaeota;Nitrososphaeria;Nitrosopumilales;Nitrosopumilaceae\t0.9999999999854506\n5179960239613d4c220e889075c6773e\tArchaea;Crenarchaeota;Nitrososphaeria;Nitrosopumilales;Nitrosopumilaceae;Candidatus Nitrosopumilus\t0.9558707678091154\nd62ab321b324b106e11961e79384f974\tBacteria;Methylomirabilota;Methylomirabilia;Methylomirabilales;Methylomirabilaceae;wb1-A12\t0.9999999975860316\n920aa9728ffb783cbc5721932cadda36\tBacteria;Aerophobota;Aerophobia;Aerophobales;uncultured bacterium\t0.9999939600150409\nb5edcefd9280528ee377cb70dea8a6a7\tArchaea;Asgardarchaeota;Lokiarchaeia;uncultured archaeon\t0.99744406884555\n43b02d567fe419b94ad063081c7bba58\tBacteria;Planctomycetota;Brocadiae;Brocadiales;Scalinduaceae;Candidatus Scalindua;uncultured bacterium\t0.9999941829048367\n0f1be1121dd04bc63b5ec4be0efc09b8\tArchaea;Asgardarchaeota;Lokiarchaeia;uncultured archaeon\t0.7884239553020901\n430d9115ca79bad01227bcc9c7694cf1\tBacteria;Proteobacteria;Gammaproteobacteria;Xanthomonadales;Xanthomonadaceae;Thermomonas;uncultured bacterium\t0.7413321650122459\n0bf08973da329747d913d5c261f91944\tBacteria;Aerophobota;Aerophobia;Aerophobales\t1.0000000000000024<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>进化树，本教程中文件名为<strong> tree.nwk</strong>。该文件可由 QIIME2 生成，Newick 格式，是用代表序列构建的系统发育树。</li>\n</ul>\n<hr />\n<h1 id=\"alpha-diversity\"><a class=\"markdownIt-Anchor\" href=\"#alpha-diversity\"></a> Alpha diversity</h1>\n<h2 id=\"shannon-richness-simpson-chao1-ace-pielou-pd_whole_tree指数的计算与可视化\"><a class=\"markdownIt-Anchor\" href=\"#shannon-richness-simpson-chao1-ace-pielou-pd_whole_tree指数的计算与可视化\"></a> Shannon、Richness、Simpson、Chao1、ACE、Pielou、PD_whole_tree 指数的计算与可视化</h2>\n<h3 id=\"输入文件\"><a class=\"markdownIt-Anchor\" href=\"#输入文件\"></a> 输入文件</h3>\n<ul>\n<li>feature-table.tsv</li>\n<li>sample-metadata.tsv</li>\n</ul>\n<h3 id=\"第一步计算多样性\"><a class=\"markdownIt-Anchor\" href=\"#第一步计算多样性\"></a> 第一步：计算多样性</h3>\n<p>将如下代码保存到文件”compute_alpha.R“中，并将程序与输入文件放在同一目录下。在终端中运行命令”Rscript compute_alpha.R“，得到输出文件”alpha.txt“。</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\">#!/usr/bin/env R</span>\n<span class=\"token comment\">#定义函数</span>\nlibrary<span class=\"token punctuation\">(</span>picante<span class=\"token punctuation\">)</span>       <span class=\"token comment\">#picante 包加载时默认同时加载 vegan</span>\n \nalpha <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> tree <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">,</span> base <span class=\"token operator\">=</span> exp<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n        est <span class=\"token operator\">&lt;-</span> estimateR<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        Richness <span class=\"token operator\">&lt;-</span> est<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span>\n        Chao1 <span class=\"token operator\">&lt;-</span> est<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span>\n        ACE <span class=\"token operator\">&lt;-</span> est<span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span>\n        Shannon <span class=\"token operator\">&lt;-</span> diversity<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">'shannon'</span><span class=\"token punctuation\">,</span> base <span class=\"token operator\">=</span> base<span class=\"token punctuation\">)</span>\n        Simpson <span class=\"token operator\">&lt;-</span> diversity<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">'simpson'</span><span class=\"token punctuation\">)</span>    <span class=\"token comment\">#Gini-Simpson 指数</span>\n        Pielou <span class=\"token operator\">&lt;-</span> Shannon <span class=\"token operator\">/</span> log<span class=\"token punctuation\">(</span>Richness<span class=\"token punctuation\">,</span> base<span class=\"token punctuation\">)</span>\n        goods_coverage <span class=\"token operator\">&lt;-</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> rowSums<span class=\"token punctuation\">(</span>x <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> rowSums<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        \n        result <span class=\"token operator\">&lt;-</span> data.frame<span class=\"token punctuation\">(</span>Richness<span class=\"token punctuation\">,</span> Shannon<span class=\"token punctuation\">,</span> Simpson<span class=\"token punctuation\">,</span> Pielou<span class=\"token punctuation\">,</span> Chao1<span class=\"token punctuation\">,</span> ACE<span class=\"token punctuation\">,</span> goods_coverage<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>is.null<span class=\"token punctuation\">(</span>tree<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n                PD_whole_tree <span class=\"token operator\">&lt;-</span> pd<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> tree<span class=\"token punctuation\">,</span> include.root <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n                names<span class=\"token punctuation\">(</span>PD_whole_tree<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span> <span class=\"token string\">'PD_whole_tree'</span>\n                result <span class=\"token operator\">&lt;-</span> cbind<span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">,</span> PD_whole_tree<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">&#125;</span>\n        result\n<span class=\"token punctuation\">&#125;</span>\n \n<span class=\"token comment\">#现在直接使用定义好的命令 alpha()，一步得到多种 Alpha 多样性指数</span>\n<span class=\"token comment\">#加载 OTU 丰度表和进化树文件</span>\notu <span class=\"token operator\">&lt;-</span> read.delim<span class=\"token punctuation\">(</span><span class=\"token string\">'feature-table.tsv'</span><span class=\"token punctuation\">,</span> row.names <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">'\\t'</span><span class=\"token punctuation\">,</span> stringsAsFactors <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> check.names <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\notu <span class=\"token operator\">&lt;-</span> t<span class=\"token punctuation\">(</span>otu<span class=\"token punctuation\">)</span>\ntree <span class=\"token operator\">&lt;-</span> read.tree<span class=\"token punctuation\">(</span><span class=\"token string\">'tree.nwk'</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token comment\">#不包含谱系多样性，无需指定进化树；Shannon 公式的 log 底数我们使用 2</span>\n<span class=\"token comment\">##alpha_all &lt;- alpha(otu, base = 2)</span>\n<span class=\"token comment\">#包含谱系多样性时，指定进化树文件；Shannon 公式的 log 底数我们使用 2</span>\nalpha_all <span class=\"token operator\">&lt;-</span> alpha<span class=\"token punctuation\">(</span>otu<span class=\"token punctuation\">,</span> tree<span class=\"token punctuation\">,</span> base <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n \n<span class=\"token comment\">#输出保存在本地</span>\nwrite.table<span class=\"token punctuation\">(</span>alpha_all<span class=\"token punctuation\">,</span> <span class=\"token string\">'alpha.txt'</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> quote <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"第二步制图\"><a class=\"markdownIt-Anchor\" href=\"#第二步制图\"></a> 第二步：制图</h3>\n<p>这一步需要在 Rstudio 中运行如下命令，在终端里直接运行会报错（莫名其妙），最终输出 7 个 PDF 图形文件。</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\">#!/usr/bin/env R</span>\n<span class=\"token comment\"># 基于github安装包，需要devtools，检测是否存在，不存在则安装</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">,</span> quietly <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 加载github包安装工具</span>\nlibrary<span class=\"token punctuation\">(</span>devtools<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 检测amplicon包是否安装，没有从源码安装</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"amplicon\"</span><span class=\"token punctuation\">,</span> quietly <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"liaochenlanruo/amplicon\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 提示升级，选择3 None不升级；升级会容易出现报错</span>\n\n<span class=\"token comment\"># library加载包，suppress不显示消息和警告信息</span>\nsuppressWarnings<span class=\"token punctuation\">(</span>suppressMessages<span class=\"token punctuation\">(</span>library<span class=\"token punctuation\">(</span>amplicon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 设置工作目录，根据实际情况设定</span>\nsetwd<span class=\"token punctuation\">(</span><span class=\"token string\">\"用户自己的工作目录\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 读取元数据，参数指定包括标题行(TRUE)，列名为1列，制表符分隔，无注释行，不转换为因子类型</span>\nmetadata <span class=\"token operator\">=</span> read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"sample-metadata.tsv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors <span class=\"token operator\">=</span> F<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 读取第一步中vegan计算的6种alpha多样性指数</span>\n<span class=\"token comment\">#alpha_div = read.table(\"alpha.txt\", header=T, row.names=1, sep=\"\\t\", comment.char=\"\")</span>\nalpha_div <span class=\"token operator\">&lt;-</span> read.delim<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha.txt\"</span><span class=\"token punctuation\">,</span> quote<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span><span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 绘制各组香农指数分布，外层()可对保存的图形同时预览</span>\n<span class=\"token punctuation\">(</span>p1 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"Shannon\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">##物种丰富度 Richness 指数</span>\n<span class=\"token punctuation\">(</span>p2 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"Richness\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#Gini-Simpson 指数（我们平时常用的 Simpson 指数即为 Gini-Simpson 指数）</span>\n<span class=\"token punctuation\">(</span>p3 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"Simpson\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#Chao1 指数</span>\n<span class=\"token punctuation\">(</span>p4 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"Chao1\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#ACE 指数</span>\n<span class=\"token punctuation\">(</span>p5 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"ACE\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#Shannon 均匀度（Pielou 均匀度）</span>\n<span class=\"token punctuation\">(</span>p6 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"Pielou\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">##谱系多样性</span>\n<span class=\"token punctuation\">(</span>p7 <span class=\"token operator\">=</span> alpha_boxplot<span class=\"token punctuation\">(</span>alpha_div<span class=\"token punctuation\">,</span> index <span class=\"token operator\">=</span> <span class=\"token string\">\"PD_whole_tree\"</span><span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID <span class=\"token operator\">=</span> <span class=\"token string\">\"Depth2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 保存图片，指定图片为pdf格式方便后期修改，图片宽89毫米，高75毫米</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_shannon.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p1<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_Richness.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p2<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_Simpson.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p3<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_Chao1.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p4<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_ACE.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p5<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_Pielou.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p6<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span>\nggsave<span class=\"token punctuation\">(</span>paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_boxplot_PD_whole_tree.pdf\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p7<span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">89</span><span class=\"token punctuation\">,</span> height<span class=\"token operator\">=</span><span class=\"token number\">75</span><span class=\"token punctuation\">,</span> units<span class=\"token operator\">=</span><span class=\"token string\">\"mm\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"演示视频\"><a class=\"markdownIt-Anchor\" href=\"#演示视频\"></a> 演示视频</h3>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\"><iframe src=\"//player.bilibili.com/player.html?aid=335536606&page=\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\"></iframe></div>\n<hr />\n<h2 id=\"物种多样性条形图的绘制\"><a class=\"markdownIt-Anchor\" href=\"#物种多样性条形图的绘制\"></a> 物种多样性条形图的绘制</h2>\n<h3 id=\"输入文件-2\"><a class=\"markdownIt-Anchor\" href=\"#输入文件-2\"></a> 输入文件</h3>\n<ul>\n<li>处理后的 Feature Table</li>\n</ul>\n<p>从 QIIME2 可视化网站上下载的各 level 的物种丰度表，此处以 level-2（Phylum 水平）为例，命名为 “level-2.csv”。该文件可以用 excel 或 WPS 打开，然后复制所有内容至一个新建的名字为 “level-2.txt” 的文本文档中，删除无关的行或列（如路径），只保留丰度数据，并保存。格式如下：</p>\n<pre class=\"line-numbers language-tex\" data-language=\"tex\"><code class=\"language-tex\">index\tspecies1\tspecies2\tspecies3\tspecies4\nSample1\t0\t8152\t11\t65\nSample2\t12\t97\t1097\t1315\n...\nSamplex\t15\t46\t2928\t1011<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>sample-metadata.tsv</li>\n<li>taxonomy.tsv</li>\n</ul>\n<h3 id=\"绘图\"><a class=\"markdownIt-Anchor\" href=\"#绘图\"></a> 绘图</h3>\n<p>以下代码在 Rstudio 中逐步输入运行</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">setwd<span class=\"token punctuation\">(</span><span class=\"token string\">\"用户自己的路径\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">,</span> quietly<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>devtools<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"amplicon\"</span><span class=\"token punctuation\">,</span> quietly<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"microbiota/amplicon\"</span><span class=\"token punctuation\">)</span>\nsuppressWarnings<span class=\"token punctuation\">(</span>suppressMessages<span class=\"token punctuation\">(</span>library<span class=\"token punctuation\">(</span>amplicon<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 从文件读取元数据，特征表和物种注释</span>\nmetadata<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"sample-metadata.tsv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\ntaxonomy<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"taxonomy.tsv\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\notutab2<span class=\"token operator\">=</span>read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"level-2.txt\"</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span> row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> comment.char<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> stringsAsFactors<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#堆叠柱状图。以分组均值绘制，展示丰度最高的19个门，其余归类为其他(Other)</span>\n<span class=\"token comment\"># 门水平物种组成表和元数据作为输入，分组列名为Group，默认显示前19个分类，按丰度排序</span>\notutab2<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otutab2<span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">(</span>ps<span class=\"token operator\">=</span>tax_stackplot<span class=\"token punctuation\">(</span>otutab2<span class=\"token punctuation\">,</span> metadata<span class=\"token punctuation\">,</span> groupID<span class=\"token operator\">=</span><span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> topN<span class=\"token operator\">=</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"sample\"</span><span class=\"token punctuation\">,</span> sorted<span class=\"token operator\">=</span><span class=\"token string\">\"abundance\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nps2 <span class=\"token operator\">=</span> ps <span class=\"token operator\">+</span> scale_fill_manual<span class=\"token punctuation\">(</span>values <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span><span class=\"token string\">\"#1f77b4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#aec7e8\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff7f0e\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ffbb78\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#2ca02c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#98df8a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#d62728\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#ff9896\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9467bd\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c5b0d5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#8c564b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c49c94\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#e377c2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#f7b6d2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#7f7f7f\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#c7c7c7\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#bcbd22\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#dbdb8d\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#17becf\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"#9edae5\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> theme<span class=\"token punctuation\">(</span>axis.text.x <span class=\"token operator\">=</span> element_text<span class=\"token punctuation\">(</span>angle <span class=\"token operator\">=</span> <span class=\"token number\">90</span><span class=\"token punctuation\">,</span> hjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> vjust <span class=\"token operator\">=</span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nps2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"演示视频-2\"><a class=\"markdownIt-Anchor\" href=\"#演示视频-2\"></a> 演示视频</h3>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\"><iframe src=\"//player.bilibili.com/player.html?aid=633107204&page=\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\"></iframe></div>\n<hr />\n<h1 id=\"beta多样性\"><a class=\"markdownIt-Anchor\" href=\"#beta多样性\"></a> Beta 多样性</h1>\n<h2 id=\"nmds分析及可视化\"><a class=\"markdownIt-Anchor\" href=\"#nmds分析及可视化\"></a> NMDS 分析及可视化</h2>\n<h3 id=\"输入文件-3\"><a class=\"markdownIt-Anchor\" href=\"#输入文件-3\"></a> 输入文件</h3>\n<ul>\n<li>feature-table.tsv</li>\n<li>sample-metadata.tsv</li>\n</ul>\n<h3 id=\"分析过程\"><a class=\"markdownIt-Anchor\" href=\"#分析过程\"></a> 分析过程</h3>\n<p>在 Rstudio 中运行如下代码：</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">setwd<span class=\"token punctuation\">(</span><span class=\"token string\">\"用户的工作目录\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"vegan\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 读取数据，一份otu.table文件和一份分组信息文件</span>\notu <span class=\"token operator\">&lt;-</span> read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"feature-table.tsv\"</span><span class=\"token punctuation\">,</span>row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span>sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span>check.names<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\ndesign <span class=\"token operator\">&lt;-</span> read.table<span class=\"token punctuation\">(</span><span class=\"token string\">\"sample-metadata.tsv\"</span><span class=\"token punctuation\">,</span>header<span class=\"token operator\">=</span>T<span class=\"token punctuation\">,</span>sep<span class=\"token operator\">=</span><span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span>row.names<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>check.names<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 数据调整为列名是OTU，行名是样本名</span>\notu<span class=\"token operator\">=</span>t<span class=\"token punctuation\">(</span>otu<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 标准化，当然method有很多，可以通过?decostand查看其它method</span>\nvare.hel<span class=\"token operator\">&lt;-</span>decostand<span class=\"token punctuation\">(</span>otu<span class=\"token punctuation\">,</span>method<span class=\"token operator\">=</span><span class=\"token string\">\"hellinger\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 计算Bray-curtis距离矩阵</span>\nvare.dis <span class=\"token operator\">&lt;-</span> vegdist<span class=\"token punctuation\">(</span>vare.hel<span class=\"token punctuation\">,</span>method<span class=\"token operator\">=</span><span class=\"token string\">\"bray\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 使用NMDS的方法</span>\nvare.mds <span class=\"token operator\">&lt;-</span> metaMDS<span class=\"token punctuation\">(</span>vare.hel<span class=\"token punctuation\">,</span>distance <span class=\"token operator\">=</span> <span class=\"token string\">\"bray\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 首先提取前两轴坐标</span>\npoint <span class=\"token operator\">=</span> scores<span class=\"token punctuation\">(</span>vare.mds<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 将分组文件和得分文件合并</span>\nindex <span class=\"token operator\">=</span> merge<span class=\"token punctuation\">(</span>design<span class=\"token punctuation\">,</span> point<span class=\"token punctuation\">,</span>by<span class=\"token operator\">=</span><span class=\"token string\">\"row.names\"</span><span class=\"token punctuation\">,</span>all<span class=\"token operator\">=</span>F<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 查看Stress值</span>\n<span class=\"token comment\"># Stress值是反映模型合适程度的指标，NMDS会多次打乱数据计算Stress值，直到找到最合适的模型，也就是最低的Stress值；理想状况下，Stress值为0，一般Stress值低于0.1较为合理。</span>\nvare.mds\n\n<span class=\"token comment\"># Stress:     0.07498046 #记住这个数字，后面会打印在图中</span>\n\n<span class=\"token comment\"># 显着性检验；anosim本质是基于排名的算法，更加适合NMDS，这里基于元数据中的深度（Depth）计算</span>\nanosim.result<span class=\"token operator\">&lt;-</span>anosim<span class=\"token punctuation\">(</span>vare.dis<span class=\"token punctuation\">,</span> design<span class=\"token operator\">$</span>Depth<span class=\"token punctuation\">,</span>permutations <span class=\"token operator\">=</span><span class=\"token number\">999</span><span class=\"token punctuation\">)</span>\n\nsummary<span class=\"token punctuation\">(</span>anosim.result<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># ANOSIM statistic R: 0.8036 #记住这个数字，后面会打印在图中</span>\n<span class=\"token comment\">#       Significance: 0.001 #记住这个数字，后面会打印在图中</span>\n\n<span class=\"token comment\"># tiff输出图形，适合大部分出版刊物，入门级别分辩率300,18*14的长宽；</span>\n<span class=\"token comment\">#tiff(file=\"beta_bray_NMDS.tiff\", res = 300, compression =\"none\", width=180,height=140,units= \"mm\")</span>\n\n<span class=\"token comment\"># 在这里我选择输出为PDF，后续可以进一步的编辑</span>\npdf<span class=\"token punctuation\">(</span>file<span class=\"token operator\">=</span><span class=\"token string\">\"beta_bray_NMDS.pdf\"</span><span class=\"token punctuation\">,</span> width<span class=\"token operator\">=</span><span class=\"token number\">180</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token number\">140</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#开始出图，代码如下：</span>\nlibrary<span class=\"token punctuation\">(</span><span class=\"token string\">\"ggplot2\"</span><span class=\"token punctuation\">)</span>\n\np <span class=\"token operator\">=</span> ggplot<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">,</span> aes<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span>NMDS1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span>NMDS2<span class=\"token punctuation\">,</span> color<span class=\"token operator\">=</span>as.factor<span class=\"token punctuation\">(</span>Depth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n      geom_point<span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n     <span class=\"token comment\">#scale_colour_manual(values = c(\"red\",\"blue\", \"green\")) +#这行代码是用于自定义颜色的，有几个组就用几个颜色，少于3个组的话不支持自定义</span>\n     labs<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span>paste<span class=\"token punctuation\">(</span><span class=\"token string\">\"NMDS1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span>paste<span class=\"token punctuation\">(</span><span class=\"token string\">\"NMDS2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> title<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#置信区间当然要加上，有三种方式，线条类型也可以更改。将上面得到的三个指标在图中更换Stress，R，p。</span>\n\np<span class=\"token operator\">+</span>stat_ellipse<span class=\"token punctuation\">(</span>type <span class=\"token operator\">=</span> <span class=\"token string\">\"t\"</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> level <span class=\"token operator\">=</span> <span class=\"token number\">0.95</span><span class=\"token punctuation\">,</span> show.legend <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>\n    annotate<span class=\"token punctuation\">(</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span>x<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">2.5</span><span class=\"token punctuation\">,</span>y<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1.25</span><span class=\"token punctuation\">,</span>parse<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span>size<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">=</span><span class=\"token string\">\"'R: '*0.8036\"</span><span class=\"token punctuation\">,</span>family<span class=\"token operator\">=</span><span class=\"token string\">\"serif\"</span><span class=\"token punctuation\">,</span>fontface<span class=\"token operator\">=</span><span class=\"token string\">\"italic\"</span><span class=\"token punctuation\">,</span>colour<span class=\"token operator\">=</span><span class=\"token string\">\"darkred\"</span><span class=\"token punctuation\">,</span>hjust <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>\n    annotate<span class=\"token punctuation\">(</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span>x<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">2.5</span><span class=\"token punctuation\">,</span>y<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1.35</span><span class=\"token punctuation\">,</span>parse<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span>size<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">=</span><span class=\"token string\">\"'p: '*0.001\"</span><span class=\"token punctuation\">,</span>family<span class=\"token operator\">=</span><span class=\"token string\">\"serif\"</span><span class=\"token punctuation\">,</span>fontface<span class=\"token operator\">=</span><span class=\"token string\">\"italic\"</span><span class=\"token punctuation\">,</span>colour<span class=\"token operator\">=</span><span class=\"token string\">\"darkred\"</span><span class=\"token punctuation\">,</span>hjust <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>\n    annotate<span class=\"token punctuation\">(</span><span class=\"token string\">\"text\"</span><span class=\"token punctuation\">,</span>x<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">2.5</span><span class=\"token punctuation\">,</span>y<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1.45</span><span class=\"token punctuation\">,</span>parse<span class=\"token operator\">=</span><span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span>size<span class=\"token operator\">=</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>label<span class=\"token operator\">=</span><span class=\"token string\">\"'Stress: '*0.075\"</span><span class=\"token punctuation\">,</span>family<span class=\"token operator\">=</span><span class=\"token string\">\"serif\"</span><span class=\"token punctuation\">,</span>fontface<span class=\"token operator\">=</span><span class=\"token string\">\"italic\"</span><span class=\"token punctuation\">,</span>colour<span class=\"token operator\">=</span><span class=\"token string\">\"darkred\"</span><span class=\"token punctuation\">,</span>hjust <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> geom_point<span class=\"token punctuation\">(</span>aes<span class=\"token punctuation\">(</span>x<span class=\"token operator\">=</span>NMDS1<span class=\"token punctuation\">,</span> y<span class=\"token operator\">=</span>NMDS2<span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span>Site<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> size<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span>\n\t<span class=\"token comment\">#scale_shape_manual(values = c(15, 19, 17))+#这行代码是用于自定义形状的，有几个组就用几个形状，少于3个组的话不支持自定义</span>\n    theme_classic<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\ndev.off<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h3 id=\"演示视频-3\"><a class=\"markdownIt-Anchor\" href=\"#演示视频-3\"></a> 演示视频</h3>\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\"><iframe src=\"//player.bilibili.com/player.html?aid=548008577&page=\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\"></iframe></div>\n<h1 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\"></a> 参考</h1>\n<ul>\n<li><a href=\"https://github.com/YongxinLiu/MicrobiomeStatPlot\">https://github.com/YongxinLiu/MicrobiomeStatPlot</a></li>\n</ul>\n<p><font color=\"#FF0000\"><ruby><b>敬告</b>：使用文中脚本请引用本文网址，请尊重本人的劳动成果，谢谢！<rt><b>Notice</b>: When you use the scripts in this article, please cite the link of this webpage. Thank you!</rt></ruby></font></p>\n","raw":null,"categories":[{"name":"可视化","path":"api/categories/可视化.json"}],"tags":[{"name":"SY179","path":"api/tags/SY179.json"},{"name":"R语言","path":"api/tags/R语言.json"},{"name":"扩增子","path":"api/tags/扩增子.json"}]},{"title":"Use microeco分析扩增子数据","slug":"Use_microeco分析扩增子数据","date":"2021-03-14T07:01:45.000Z","updated":"2022-01-08T02:16:28.417Z","comments":true,"path":"api/articles/Use_microeco分析扩增子数据.json","excerpt":null,"keywords":null,"cover":"#/images/lujia/show_15_taxa_at_Class_level.jpg","content":"<p>本文阐述使用 microeco 分析扩增子数据……</p>\n<span id=\"more\"></span>\n<h1 id=\"font-colorff0000-1-安装microecofont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-1-安装microecofont\"></a> <font color=#FF0000 >1. 安装 microeco</font></h1>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># If devtools package is not installed, first install it</span>\ninstall.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># then install microeco</span>\ndevtools<span class=\"token operator\">::</span>install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"ChiLiubio/microeco\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requireNamespace<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">,</span> quietly <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"devtools\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#125;</span>\ndevtools<span class=\"token operator\">::</span>install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"jbisanz/qiime2R\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<h1 id=\"font-colorff0000-2-准备数据font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-2-准备数据font\"></a> <font color=#FF0000 >2. 准备数据</font></h1>\n<h2 id=\"font-colorff9800-otu_tablefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-otu_tablefont\"></a> <font color=#FF9800 >otu_table</font></h2>\n<p>OTU 表</p>\n<table>\n<thead>\n<tr>\n<th>Sample 1</th>\n<th>Sample 2</th>\n<th>Sample 3</th>\n<th>Sample 4</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>OTU1</td>\n<td>232.0</td>\n<td>209.0</td>\n<td>349.0</td>\n<td>256.0</td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>75.0</td>\n<td>35.0</td>\n<td>44.0</td>\n<td>0.0</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>237.0</td>\n<td>224.0</td>\n<td>291.0</td>\n<td>353.0</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>371.0</td>\n<td>80.0</td>\n<td>319.0</td>\n<td>345.0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"font-colorff9800-taxonomy_tablefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-taxonomy_tablefont\"></a> <font color=#FF9800 >taxonomy_table</font></h2>\n<p>分类表</p>\n<div style=\"overflow-x:auto;\">\n<table>\n<table>\n<thead>\n<tr>\n<th>Kingdom</th>\n<th>Phylum</th>\n<th>Class</th>\n<th>Order</th>\n<th>Family</th>\n<th>Genus</th>\n<th>Species</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>OTU1</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Desulfobacteria</td>\n<td>o__Desulfatiglandales</td>\n<td>f__Desulfatiglandaceae</td>\n<td colspan=\"2\">g__Desulfatiglans</td>\n</tr>\n<tr>\n<td>OTU2</td>\n<td>d__Bacteria</td>\n<td>p__Sva0485</td>\n<td>c__Sva0485</td>\n<td>o__Sva0485</td>\n<td>f__Sva0485</td>\n<td>g__Sva0485</td>\n<td>s__uncultured_hydrocarbon</td>\n</tr>\n<tr>\n<td>OTU3</td>\n<td>d__Bacteria</td>\n<td>p__Desulfobacterota</td>\n<td>c__Syntrophobacteria</td>\n<td>o__Syntrophobacterales</td>\n<td>f__uncultured</td>\n<td>g__uncultured</td>\n<td>s__uncultured_delta</td>\n</tr>\n<tr>\n<td>OTU4</td>\n<td>d__Bacteria</td>\n<td>p__Myxococcota</td>\n<td>c__Polyangia</td>\n<td>o__Polyangiales</td>\n<td>f__Sandaracinaceae</td>\n<td colspan=\"2\">g__uncultured</td>\n</tr>\n</tbody>\n</table>\n</table>\n</div>\n<h2 id=\"font-colorff9800-sample_infofont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-sample_infofont\"></a> <font color=#FF9800 >sample_info</font></h2>\n<p>样本元数据</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Group</th>\n<th>Type</th>\n<th>Saline</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Sample 1</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>G1</td>\n<td>T1</td>\n<td>Non-saline</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>G2</td>\n<td>T1</td>\n<td>Saline</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>G2</td>\n<td>T2</td>\n<td>Saline</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"font-colorff9800-env_datafont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-env_datafont\"></a> <font color=#FF9800 >env_data</font></h2>\n<p>环境因子</p>\n<table>\n<thead>\n<tr>\n<th>SampleID</th>\n<th>Depth</th>\n<th>Longitude</th>\n<th>Latitude</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Sample 1</td>\n<td>0</td>\n<td>23.0</td>\n<td>20</td>\n</tr>\n<tr>\n<td>Sample 2</td>\n<td>10</td>\n<td>35.0</td>\n<td>44.0</td>\n</tr>\n<tr>\n<td>Sample 3</td>\n<td>20</td>\n<td>43.0</td>\n<td>70.0</td>\n</tr>\n<tr>\n<td>Sample 4</td>\n<td>30</td>\n<td>60.0</td>\n<td>69.0</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"font-colorff9800-phylo_treefont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-phylo_treefont\"></a> <font color=#FF9800 >phylo_tree</font></h2>\n<p>进化树</p>\n<h1 id=\"font-colorff0000-3-导入数据font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-3-导入数据font\"></a> <font color=#FF0000 >3. 导入数据</font></h1>\n<ul>\n<li>\n<p>加载 R 包</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">library<span class=\"token punctuation\">(</span>microeco<span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>ape<span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>qiime2R<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># use pipe operator in magrittr package</span>\nlibrary<span class=\"token punctuation\">(</span>magrittr<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># set.seed is used to fix the random number generation to make the results repeatable</span>\nset.seed<span class=\"token punctuation\">(</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># make the plotting background same with the tutorial</span>\nlibrary<span class=\"token punctuation\">(</span>ggplot2<span class=\"token punctuation\">)</span>\ntheme_set<span class=\"token punctuation\">(</span>theme_bw<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>导入数据</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 单独导入环境因子文件</span>\nenv_data <span class=\"token operator\">&lt;-</span> read.delim<span class=\"token punctuation\">(</span><span class=\"token string\">\"E:/Researches/lujia16S/Analysis_20200907/Ordination_analyses/env4.txt\"</span><span class=\"token punctuation\">,</span> sep <span class=\"token operator\">=</span> <span class=\"token string\">\"\\t\"</span><span class=\"token punctuation\">,</span> header <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> row.names <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 定义数据导入函数</span>\nqiimed2meco <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>ASV_data<span class=\"token punctuation\">,</span> sample_data<span class=\"token punctuation\">,</span> taxonomy_data<span class=\"token punctuation\">,</span> phylo_tree <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\"># Read ASV data</span>\n\tASV <span class=\"token operator\">&lt;-</span> as.data.frame<span class=\"token punctuation\">(</span>read_qza<span class=\"token punctuation\">(</span>ASV_data<span class=\"token punctuation\">)</span><span class=\"token operator\">$</span>data<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">#  Read metadata</span>\n\tmetadata <span class=\"token operator\">&lt;-</span> read_q2metadata<span class=\"token punctuation\">(</span>sample_data<span class=\"token punctuation\">)</span>\n\trownames<span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;-</span> as.character<span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\"># Read taxonomy table</span>\n\ttaxa_table <span class=\"token operator\">&lt;-</span> read_qza<span class=\"token punctuation\">(</span>taxonomy_data<span class=\"token punctuation\">)</span>\n\ttaxa_table <span class=\"token operator\">&lt;-</span> parse_taxonomy<span class=\"token punctuation\">(</span>taxa_table<span class=\"token operator\">$</span>data<span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\"># Make the taxonomic table clean, this is very important.</span>\n\ttaxa_table <span class=\"token percent-operator operator\">%&lt;>%</span> tidy_taxonomy\n\t<span class=\"token comment\"># Read phylo tree</span>\n\t<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>is.null<span class=\"token punctuation\">(</span>phylo_tree<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t\tphylo_tree <span class=\"token operator\">&lt;-</span> read_qza<span class=\"token punctuation\">(</span>phylo_tree<span class=\"token punctuation\">)</span><span class=\"token operator\">$</span>data\n\t<span class=\"token punctuation\">&#125;</span>\n\tdataset <span class=\"token operator\">&lt;-</span> microtable<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>sample_table <span class=\"token operator\">=</span> metadata<span class=\"token punctuation\">,</span> tax_table <span class=\"token operator\">=</span> taxa_table<span class=\"token punctuation\">,</span> otu_table <span class=\"token operator\">=</span> ASV<span class=\"token punctuation\">,</span> phylo_tree <span class=\"token operator\">=</span> phylo_tree<span class=\"token punctuation\">)</span>\n\tdataset\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\"># 导入本地数据，包括OTU表、样本元数据、分类表、tree文件。这几个文件均有QIIME2生成。</span>\nmeco_dataset <span class=\"token operator\">&lt;-</span> qiimed2meco<span class=\"token punctuation\">(</span>ASV_data <span class=\"token operator\">=</span> <span class=\"token string\">\"E:/Researches/lujia16S/Analysis_20200907/dada2_table.qza\"</span><span class=\"token punctuation\">,</span> sample_data <span class=\"token operator\">=</span> <span class=\"token string\">\"E:/Researches/lujia16S/Analysis_20200907/metadata.tsv\"</span><span class=\"token punctuation\">,</span> taxonomy_data <span class=\"token operator\">=</span> <span class=\"token string\">\"E:/Researches/lujia16S/Analysis_20200907/taxonomy.qza\"</span><span class=\"token punctuation\">,</span> phylo_tree <span class=\"token operator\">=</span> <span class=\"token string\">\"E:/Researches/lujia16S/Analysis_20200907/tree.qza\"</span><span class=\"token punctuation\">)</span>\n\nmeco_dataset<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-4-数据预处理font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-4-数据预处理font\"></a> <font color=#FF0000 >4. 数据预处理</font></h1>\n<ul>\n<li>\n<p>移除未被分配到 &quot;k__Archaea&quot; 或 &quot;k__Bacteria&quot; 的 OTUs</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">meco_dataset<span class=\"token operator\">$</span>tax_table <span class=\"token percent-operator operator\">%&lt;>%</span> base<span class=\"token operator\">::</span>subset<span class=\"token punctuation\">(</span>Kingdom <span class=\"token operator\">==</span> <span class=\"token string\">\"k__Archaea\"</span> <span class=\"token operator\">|</span> Kingdom <span class=\"token operator\">==</span> <span class=\"token string\">\"k__Bacteria\"</span><span class=\"token punctuation\">)</span>\nprint<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>移除注释为线粒体和叶绿体的 OTUs</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 移除tax_table中包含taxa名字的行，无论分类等级（taxonomic ranks），不区分大小写字母。简言之，taxa = c(\"mitochondria\", \"chloroplast\")定义了删除包含mitochondria和chloroplast的行。</span>\n\nmeco_dataset<span class=\"token operator\">$</span>filter_pollution<span class=\"token punctuation\">(</span>taxa <span class=\"token operator\">=</span> c<span class=\"token punctuation\">(</span><span class=\"token string\">\"mitochondria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"chloroplast\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nprint<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>为了使 otu_table、tax_table 和 phylo_tree 中的 OTUs 相同，我们再次使用 tidy_dataset () 函数</p>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">meco_dataset<span class=\"token operator\">$</span>tidy_dataset<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nprint<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>调用 sample_sums () 检查各样本中的序列数量</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">meco_dataset<span class=\"token operator\">$</span>sample_sums<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> range<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>有时，为了减少物种数目对多样性度量的影响，我们需要进行重采样，使每个样本中的序列数量相等。函数 rarefy_samples 可以在稀疏（rarefying）前后自动调用函数 tidy_dataset。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># As an example, we use 20001 sequences in each sample</span>\nmeco_dataset<span class=\"token operator\">$</span>rarefy_samples<span class=\"token punctuation\">(</span>sample.size <span class=\"token operator\">=</span> <span class=\"token number\">20001</span><span class=\"token punctuation\">)</span>\nmeco_dataset<span class=\"token operator\">$</span>sample_sums<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> range<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-5-alpha多样性font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-5-alpha多样性font\"></a> <font color=#FF0000 >5. alpha 多样性</font></h1>\n<ul>\n<li>\n<p>然后，我们使用 cal_abund () 计算每个分类等级的分类单元丰度（taxa abundance）。此函数返回一个名为 taxa_abund 的列表，其中包含每个分类等级上的丰度信息的多个数据框。列表自动存储在 microtable object 中。</p>\n <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">meco_dataset<span class=\"token operator\">$</span>cal_abund<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return dataset$taxa_abund</span>\nclass<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token operator\">$</span>taxa_abund<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>通过 save_abund () 将 taxa abundance 保存至本地文件</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">dir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"taxa_abund\"</span><span class=\"token punctuation\">)</span>\nmeco_dataset<span class=\"token operator\">$</span>save_abund<span class=\"token punctuation\">(</span>dirpath <span class=\"token operator\">=</span> <span class=\"token string\">\"taxa_abund\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>计算 alpha 多样性。结果自动存储在 microtable object 中。<font color=#2196F3>作为示例，此处未计算系统发育多样性（phylogenetic diversity）</font>。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 若要计算Faith's phylogenetic diversity，设置PD = TRUE，计算速度会较慢</span>\nmeco_dataset<span class=\"token operator\">$</span>cal_alphadiv<span class=\"token punctuation\">(</span>PD <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># return dataset$alpha_diversity</span>\nclass<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token operator\">$</span>alpha_diversity<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># save dataset$alpha_diversity to a directory</span>\ndir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"alpha_diversity\"</span><span class=\"token punctuation\">)</span>\nmeco_dataset<span class=\"token operator\">$</span>save_alphadiv<span class=\"token punctuation\">(</span>dirpath <span class=\"token operator\">=</span> <span class=\"token string\">\"alpha_diversity\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-6-β多样性font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-6-β多样性font\"></a> <font color=#FF0000 >6. β 多样性</font></h1>\n<ul>\n<li>\n<p>利用函数 cal_betadiv () 计算 beta - 多样性的距离矩阵。我们提供了四个最常用的索引：Bray-curtis、Jaccard、加权 Unifrac 和未加权 Unifrac。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># If you do not want to calculate unifrac metrics, use unifrac = FALSE</span>\n<span class=\"token comment\"># 需要GUniFrac package</span>\ninstall.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"GUniFrac\"</span><span class=\"token punctuation\">)</span>\n\nmeco_dataset<span class=\"token operator\">$</span>cal_betadiv<span class=\"token punctuation\">(</span>unifrac <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return dataset$beta_diversity</span>\nclass<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token operator\">$</span>beta_diversity<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># save dataset$beta_diversity to a directory</span>\ndir.create<span class=\"token punctuation\">(</span><span class=\"token string\">\"beta_diversity\"</span><span class=\"token punctuation\">)</span>\nmeco_dataset<span class=\"token operator\">$</span>save_betadiv<span class=\"token punctuation\">(</span>dirpath <span class=\"token operator\">=</span> <span class=\"token string\">\"beta_diversity\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-7-trans_abund-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-7-trans_abund-classfont\"></a> <font color=#FF0000 >7. trans_abund class</font></h1>\n<ul>\n<li>\n<p>绘制 Barplot。转换分类丰度数据，以便使用 ggplot2 包绘制分类单元丰度。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># create trans_abund object</span>\n<span class=\"token comment\"># use 12 Phyla with the highest abundance in the dataset.</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1 object now include the transformed abundance data t1$abund_data and other elements for the following plotting</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>绘制 Barplot. We remove the sample names in x axis and add the facet to show abundance according to groups.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>plot_bar<span class=\"token punctuation\">(</span>others_color <span class=\"token operator\">=</span> <span class=\"token string\">\"grey70\"</span><span class=\"token punctuation\">,</span> facet <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> xtext_keep <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> legend_text_italic <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return a ggplot2 object</span>\n\n<span class=\"token comment\"># 获取组内平均值。The groupmean parameter can be used to obtain the group-mean barplot.</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">,</span> groupmean <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_bar<span class=\"token punctuation\">(</span>others_color <span class=\"token operator\">=</span> <span class=\"token string\">\"grey70\"</span><span class=\"token punctuation\">,</span> legend_text_italic <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Then alluvial plot is implemented in the plot_bar function.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"ggalluvial\"</span><span class=\"token punctuation\">)</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># use_alluvium = TRUE make the alluvial plot, clustering =TRUE can be used to reorder the samples by clustering</span>\nt1<span class=\"token operator\">$</span>plot_bar<span class=\"token punctuation\">(</span>use_alluvium <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> clustering <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> xtext_type_hor <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> xtext_size <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>The box plot is an excellent way to intuitionally show data distribution across groups.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># show 15 taxa at Class level</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Class\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">15</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_box<span class=\"token punctuation\">(</span>group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/show_15_taxa_at_Class_level.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/show_15_taxa_at_Class_level.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"show 15 taxa at Class level\" /></p>\n<ul>\n<li>\n<p>Then we show the heatmap with the high abundant genera.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># show 40 taxa at Genus level</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">40</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_heatmap<span class=\"token punctuation\">(</span>facet <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> xtext_keep <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> withmargin <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Then, we show the pie chart.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> groupmean <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># all pie chart in one row</span>\nt1<span class=\"token operator\">$</span>plot_pie<span class=\"token punctuation\">(</span>facet_nrow <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-8-trans_venn-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-8-trans_venn-classfont\"></a> <font color=#FF0000 >8. trans_venn class</font></h1>\n<ul>\n<li>\n<p>The trans_venn class is used for venn analysis. To analyze the unique and shared OTUs of groups, we first merge samples according to the “Group” column of sample_table.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># merge samples as one community for each group</span>\ndataset1 <span class=\"token operator\">&lt;-</span> meco_dataset<span class=\"token operator\">$</span>merge_samples<span class=\"token punctuation\">(</span>use_group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># dataset1 is a new microtable object</span>\n<span class=\"token comment\"># create trans_venn object</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_venn<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset1<span class=\"token punctuation\">,</span> ratio <span class=\"token operator\">=</span> <span class=\"token string\">\"seqratio\"</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_venn<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># The integer data is OTU number</span>\n<span class=\"token comment\"># The percentage data is the sequence number/total sequence number</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>When the groups are too many to show with venn plot, we can use petal plot.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># use \"Type\" column in sample_table</span>\ndataset1 <span class=\"token operator\">&lt;-</span> meco_dataset<span class=\"token operator\">$</span>merge_samples<span class=\"token punctuation\">(</span>use_group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_venn<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset1<span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_venn<span class=\"token punctuation\">(</span>petal_plot <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Sometimes, we are interested in the unique and shared species. In another words, the composition of the unique or shared species may account for the different and similar parts of ecological characteristics across groups[10]. For this goal, we first transform the results of venn plot to the traditional species-sample table, that is, another object of microtable class.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">dataset1 <span class=\"token operator\">&lt;-</span> meco_dataset<span class=\"token operator\">$</span>merge_samples<span class=\"token punctuation\">(</span>use_group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_venn<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset1<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># transform venn results to the sample-species table, here do not consider abundance, only use presence/absence information.</span>\nt2 <span class=\"token operator\">&lt;-</span> t1<span class=\"token operator\">$</span>trans_venn_com<span class=\"token punctuation\">(</span>use_OTUs_frequency <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t2 is a new microtable class, each part is considered as a sample</span>\nclass<span class=\"token punctuation\">(</span>t2<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>We use bar plot to show the composition at the Genus level.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># calculate taxa abundance, that is, the frequency</span>\nt2<span class=\"token operator\">$</span>cal_abund<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># transform and plot</span>\nt3 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span>\nt3<span class=\"token operator\">$</span>plot_bar<span class=\"token punctuation\">(</span>bar_type <span class=\"token operator\">=</span> <span class=\"token string\">\"part\"</span><span class=\"token punctuation\">,</span> legend_text_italic <span class=\"token operator\">=</span> T<span class=\"token punctuation\">,</span> ylab_title <span class=\"token operator\">=</span> <span class=\"token string\">\"Frequency (%)\"</span><span class=\"token punctuation\">,</span> xtext_type_hor <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>We also try to use pie chart to show the compositions at the Phylum level</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t3 <span class=\"token operator\">&lt;-</span> trans_abund<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> t2<span class=\"token punctuation\">,</span> taxrank <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">,</span> ntaxa <span class=\"token operator\">=</span> <span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\nt3<span class=\"token operator\">$</span>plot_pie<span class=\"token punctuation\">(</span>facet_nrow <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> use_colors <span class=\"token operator\">=</span> rev<span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">(</span>RColorBrewer<span class=\"token operator\">::</span>brewer.pal<span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Dark2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"grey50\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-9-trans_alpha-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-9-trans_alpha-classfont\"></a> <font color=#FF0000 >9. trans_alpha class</font></h1>\n<ul>\n<li>\n<p>Alpha diversity can be transformed and plotted using trans_alpha class. Creating trans_alpha object can return two data frame: alpha_data and alpha_stat.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1 <span class=\"token operator\">&lt;-</span> trans_alpha<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$alpha_stat</span>\nt1<span class=\"token operator\">$</span>alpha_stat<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Then, we test the differences among groups using the KW rank sum test and anova with multiple comparisons.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>cal_diff<span class=\"token punctuation\">(</span>method <span class=\"token operator\">=</span> <span class=\"token string\">\"KW\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_alpha_diff</span>\nt1<span class=\"token operator\">$</span>res_alpha_diff<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th>|Groups</th>\n<th>Measure</th>\n<th>Test method</th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1|T16 vs T18</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.601895e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>2|T16 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>3.011399e-08</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3|T16 vs T21</td>\n<td>Observed</td>\n<td>KW</td>\n<td>2.174162e-04</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4|T16 vs T17</td>\n<td>Observed</td>\n<td>KW</td>\n<td>1.234229e-03</td>\n<td>**</td>\n</tr>\n<tr>\n<td>5|T18 vs T20</td>\n<td>Observed</td>\n<td>KW</td>\n<td>7.319258e-08</td>\n<td>***</td>\n</tr>\n</tbody>\n</table>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>cal_diff<span class=\"token punctuation\">(</span>method <span class=\"token operator\">=</span> <span class=\"token string\">\"anova\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_alpha_diff</span>\nt1<span class=\"token operator\">$</span>res_alpha_diff<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n  <div style=\"overflow-x:auto;\">\n  <table>\n<table>\n<thead>\n<tr>\n<th>Observed</th>\n<th>Chao1</th>\n<th>ACE</th>\n<th>Shannon</th>\n<th>Simpson</th>\n<th>InvSimpson</th>\n<th>Fisher</th>\n<th>Coverage</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>T18</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>c</td>\n</tr>\n<tr>\n<td>T16</td>\n<td>b</td>\n<td>b</td>\n<td>b</td>\n<td>a</td>\n<td>a</td>\n<td>a</td>\n<td>b</td>\n<td>b</td>\n</tr>\n<tr>\n<td>T17</td>\n<td>c</td>\n<td>c</td>\n<td>c</td>\n<td>b</td>\n<td>a</td>\n<td>b</td>\n<td>c</td>\n<td>b</td>\n</tr>\n<tr>\n<td>T21</td>\n<td>d</td>\n<td>d</td>\n<td>d</td>\n<td>c</td>\n<td>a</td>\n<td>c</td>\n<td>d</td>\n<td>b</td>\n</tr>\n<tr>\n<td>T20</td>\n<td>e</td>\n<td>e</td>\n<td>e</td>\n<td>d</td>\n<td>b</td>\n<td>d</td>\n<td>e</td>\n<td>a</td>\n</tr>\n</tbody>\n</table>\n  </table>\n  </div>\n</li>\n<li>\n<p>Now, let us plot the mean and se of alpha diversity for each group, and add the duncan.test (agricolae package) result.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>plot_alpha<span class=\"token punctuation\">(</span>add_letter <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"Chao1\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>We can also use the boxplot to show the paired comparisons directly.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>plot_alpha<span class=\"token punctuation\">(</span>pair_compare <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"Chao1\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-10-trans_beta-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-10-trans_beta-classfont\"></a> <font color=#FF0000 >10. trans_beta class</font></h1>\n<ul>\n<li>\n<p>The distance matrix of beta diversity can be transformed and plotted using trans_beta class. The analysis referred to the beta diversity in this class mainly include ordination, group distance, clustering and manova. We first show the ordination using PCoA.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># we first create an object and select PCoA for ordination</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_beta<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"bray\"</span><span class=\"token punctuation\">,</span> ordination <span class=\"token operator\">=</span> <span class=\"token string\">\"PCoA\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1$res_ordination is the ordination result list</span>\nclass<span class=\"token punctuation\">(</span>t1<span class=\"token operator\">$</span>res_ordination<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># plot the PCoA result</span>\nt1<span class=\"token operator\">$</span>plot_ordination<span class=\"token punctuation\">(</span>plot_color <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> plot_shape <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> plot_group_ellipse <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Then we plot and compare the group distances.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># calculate and plot sample distances within groups</span>\nt1<span class=\"token operator\">$</span>cal_group_distance<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_group_distance</span>\nt1<span class=\"token operator\">$</span>plot_group_distance<span class=\"token punctuation\">(</span>distance_pair_stat <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># calculate and plot sample distances between groups (报错：错误: Insufficient values in manual scale. 10 needed but only 8 provided.)</span>\nt1<span class=\"token operator\">$</span>cal_group_distance<span class=\"token punctuation\">(</span>within_group <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_group_distance<span class=\"token punctuation\">(</span>distance_pair_stat <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Clustering plot is also a frequently used method.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># use replace_name to set the label name, group parameter used to set the color (报错：找不到对象'dataset')</span>\nt1<span class=\"token operator\">$</span>plot_clustering<span class=\"token punctuation\">(</span>group <span class=\"token operator\">=</span> <span class=\"token string\">\"Indexs\"</span><span class=\"token punctuation\">,</span> replace_name <span class=\"token operator\">=</span> c<span class=\"token punctuation\">(</span><span class=\"token string\">\"Water-depth(m)\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Indexs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>perMANOVA is often used in the differential test of distances among groups.</p>\n <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># manova for all groups</span>\nt1<span class=\"token operator\">$</span>cal_manova<span class=\"token punctuation\">(</span>cal_manova_all <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>res_manova<span class=\"token operator\">$</span>aov.tab<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th colspan=\"7\">ermutation: free</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>umber of permutations: 999</td>\n</tr>\n<tr>\n<td>erms added sequentially (first to last)</td>\n</tr>\n<tr>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(&gt;F)</td>\n</tr>\n<tr>\n<td>ite</td>\n<td>4</td>\n<td>15.669</td>\n<td>3.9173</td>\n<td>19.445</td>\n<td>0.48077</td>\n<td>0.001 ***</td>\n</tr>\n<tr>\n<td>esiduals</td>\n<td>84</td>\n<td>16.923</td>\n<td colspan=\"2\">0.2015</td>\n<td>0.51923</td>\n</tr>\n<tr>\n<td>otal</td>\n<td>88</td>\n<td colspan=\"3\">32.592</td>\n<td>1.00000</td>\n</tr>\n</tbody>\n</table>\n<p>&gt; Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1</p>\n</li>\n</ul>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># manova for each paired groups</span>\nt1<span class=\"token operator\">$</span>cal_manova<span class=\"token punctuation\">(</span>cal_manova_paired <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>res_manova<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th>Groups</th>\n<th>measure</th>\n<th>permutations</th>\n<th>R<sup>2</sup></th>\n<th>p.value</th>\n<th>Significance</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>T16 vs T18</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2748773</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>2</td>\n<td>T16 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4539103</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3</td>\n<td>T16 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4102009</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4</td>\n<td>T16 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2243404</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>5</td>\n<td>T18 vs T20</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3736482</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>6</td>\n<td>T18 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3504104</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>7</td>\n<td>T18 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.2147055</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>8</td>\n<td>T20 vs T21</td>\n<td>bray</td>\n<td>999</td>\n<td>0.3575765</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>9</td>\n<td>T20 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4589248</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>10</td>\n<td>T21 vs T17</td>\n<td>bray</td>\n<td>999</td>\n<td>0.4395176</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n</tbody>\n</table>\n <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"> <span class=\"token comment\"># manova for specified group set: here \"Group + Type\"</span>\nt1<span class=\"token operator\">$</span>cal_manova<span class=\"token punctuation\">(</span>cal_manova_set <span class=\"token operator\">=</span> <span class=\"token string\">\"Site+ Indexs\"</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>res_manova<span class=\"token operator\">$</span>aov.tab<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th colspan=\"7\">Permutation: free</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td colspan=\"7\">Number of permutations: 999</td>\n</tr>\n<tr>\n<td colspan=\"7\">Terms added sequentially (first to last)</td>\n</tr>\n<tr>\n<td>Df</td>\n<td>SumsOfSqs</td>\n<td>MeanSqs</td>\n<td>F.Model</td>\n<td>R<sup>2</sup></td>\n<td>Pr(F)</td>\n</tr>\n<tr>\n<td>Site</td>\n<td>4</td>\n<td>15.669</td>\n<td>4</td>\n<td>0</td>\n<td>0.48077</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Indexs</td>\n<td>84</td>\n<td>16.923</td>\n<td>0</td>\n<td>0</td>\n<td>0.51923</td>\n<td>1</td>\n</tr>\n<tr>\n<td>Residuals</td>\n<td>0</td>\n<td>0.000</td>\n<td colspan=\"2\">Inf</td>\n<td colspan=\"2\">0.00000</td>\n</tr>\n<tr>\n<td>Total</td>\n<td>88</td>\n<td colspan=\"3\">32.592</td>\n<td colspan=\"2\">1.00000</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"font-colorff0000-11-trans_diff-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-11-trans_diff-classfont\"></a> <font color=#FF0000 >11. trans_diff class</font></h1>\n<ul>\n<li>\n<p>Differential abundance test is a very important part in the microbial community data analysis. It can be used to find the significant taxa in determining the community differences across groups. Currently, trans_diff class have three famous approaches to perform this analysis: metastat[11], LEfSe[12] and random forest. Metastat depends on the permutations and t-test and performs well on the sparse data. It is used for the comparisons between two groups.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># metastat analysis at Genus level</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_diff<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> method <span class=\"token operator\">=</span> <span class=\"token string\">\"metastat\"</span><span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> metastat_taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1$res_metastat is the result</span>\n<span class=\"token comment\"># t1$res_metastat_group_matrix is the group comparisons order for plotting</span>\n<span class=\"token comment\"># plot the first paired groups, choose_group = 1</span>\nt1<span class=\"token operator\">$</span>plot_metastat<span class=\"token punctuation\">(</span>use_number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> qvalue <span class=\"token operator\">=</span> <span class=\"token number\">0.05</span><span class=\"token punctuation\">,</span> choose_group <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>LEfSe combines the non-parametric test and linear discriminant analysis. We implement this approach in this package instead of the python version.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1 <span class=\"token operator\">&lt;-</span> trans_diff<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> method <span class=\"token operator\">=</span> <span class=\"token string\">\"lefse\"</span><span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> alpha <span class=\"token operator\">=</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> lefse_subgroup <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1$res_lefse is the LEfSe result</span>\n<span class=\"token comment\"># t1$res_abund is the abundance information</span>\nt1<span class=\"token operator\">$</span>plot_lefse_bar<span class=\"token punctuation\">(</span>LDA_score <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>We can also plot the abundance of taxa detected using LEfSe.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>plot_diff_abund<span class=\"token punctuation\">(</span>use_number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li>\n<p>Then, we show the cladogram of the differential features in the taxonomic tree. There are too many taxa in this dataset. As an example, we only use the highest 200 abundant taxa in the tree and 50 differential features. We only show the full taxonomic label at Phylum level and use letters at other levels to reduce the text overlap.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># clade_label_level 5 represent phylum level in this analysis</span>\n<span class=\"token comment\"># require ggtree package</span>\nt1<span class=\"token operator\">$</span>plot_lefse_cladogram<span class=\"token punctuation\">(</span>use_taxa_num <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> use_feature_num <span class=\"token operator\">=</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> clade_label_level <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>There may be a problem related with the taxonomic labels in the plot. When the levels used are too many, the taxonomic labels may have too much overlap. However, if we only indicate the Phylum labels, the taxa in the legend with marked letters are too many. At this time, you can select the taxa that you want to show in the plot manually like the following operation.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># choose some taxa according to the positions in the previous picture; those taxa labels have minimum overlap</span>\nuse_labels <span class=\"token operator\">&lt;-</span> c<span class=\"token punctuation\">(</span><span class=\"token string\">\"c__Deltaproteobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c__Actinobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o__Rhizobiales\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"p__Proteobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"p__Bacteroidetes\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token string\">\"o__Micrococcales\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"p__Acidobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"p__Verrucomicrobia\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"p__Firmicutes\"</span><span class=\"token punctuation\">,</span> \n\t<span class=\"token string\">\"p__Chloroflexi\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c__Acidobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c__Gammaproteobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c__Betaproteobacteria\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c__KD4-96\"</span><span class=\"token punctuation\">,</span>\n\t<span class=\"token string\">\"c__Bacilli\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o__Gemmatimonadales\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"f__Gemmatimonadaceae\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o__Bacillales\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"o__Rhodobacterales\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># then use parameter select_show_labels to show</span>\nt1<span class=\"token operator\">$</span>plot_lefse_cladogram<span class=\"token punctuation\">(</span>use_taxa_num <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> use_feature_num <span class=\"token operator\">=</span> <span class=\"token number\">50</span><span class=\"token punctuation\">,</span> select_show_labels <span class=\"token operator\">=</span> use_labels<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># Now we can see that more taxa names appear in the tree</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>If you are interested in taxonomic tree, you can also use metacoder package[13] to plot the taxonomic tree based on the selected taxa. We do not show the usage here.</p>\n</li>\n<li>\n<p>The third approach is rf, which depends on the random forest[14, 15] and the non-parametric test. The current method can calculate random forest by bootstrapping like the method in LEfSe and only use the significant features. MeanDecreaseGini is selected as the indicator value in the analysis.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># use Genus level for parameter rf_taxa_level, if you want to use all taxa, change to \"all\"</span>\n<span class=\"token comment\"># nresam = 1 and boots = 1 represent no bootstrapping and use all samples directly</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_diff<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> method <span class=\"token operator\">=</span> <span class=\"token string\">\"rf\"</span><span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> rf_taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1$res_rf is the result stored in the object</span>\n<span class=\"token comment\"># plot the result</span>\nt2 <span class=\"token operator\">&lt;-</span> t1<span class=\"token operator\">$</span>plot_diff_abund<span class=\"token punctuation\">(</span>use_number <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">20</span><span class=\"token punctuation\">,</span> only_abund_plot <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">)</span>\ngridExtra<span class=\"token operator\">::</span>grid.arrange<span class=\"token punctuation\">(</span>t2<span class=\"token operator\">$</span>p1<span class=\"token punctuation\">,</span> t2<span class=\"token operator\">$</span>p2<span class=\"token punctuation\">,</span> ncol<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> nrow <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> widths <span class=\"token operator\">=</span> c<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># the middle asterisk represent the significances</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-12-trans_env-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-12-trans_env-classfont\"></a> <font color=#FF0000 >12. trans_env class</font></h1>\n<ul>\n<li>\n<p>分析环境因子对微生物群落结构和组装的影响：RDA 分析 (db-RDA 和 RDA).</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># add_data is used to add the environmental data</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_env<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># use bray-curtis distance to do dbrda</span>\nt1<span class=\"token operator\">$</span>cal_rda<span class=\"token punctuation\">(</span>use_dbrda <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> use_measure <span class=\"token operator\">=</span> <span class=\"token string\">\"bray\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># t1$res_rda is the result list stored in the object</span>\nt1<span class=\"token operator\">$</span>trans_rda<span class=\"token punctuation\">(</span>adjust_arrow_length <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> max_perc_env <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># t1$res_rda_trans is the transformed result for plotting</span>\nt1<span class=\"token operator\">$</span>plot_rda<span class=\"token punctuation\">(</span>plot_color <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># use Genus</span>\nt1<span class=\"token operator\">$</span>cal_rda<span class=\"token punctuation\">(</span>use_dbrda <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># As the main results of RDA are related with the projection and angles between different arrows,</span>\n<span class=\"token comment\"># we adjust the length of the arrow to show them clearly using several parameters.</span>\nt1<span class=\"token operator\">$</span>trans_rda<span class=\"token punctuation\">(</span>show_taxa <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">,</span> adjust_arrow_length <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> max_perc_env <span class=\"token operator\">=</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">,</span> max_perc_tax <span class=\"token operator\">=</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">,</span> min_perc_env <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> min_perc_tax <span class=\"token operator\">=</span> <span class=\"token number\">300</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># t1$res_rda_trans is the transformed result for plotting</span>\nt1<span class=\"token operator\">$</span>plot_rda<span class=\"token punctuation\">(</span>plot_color <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Mantel test 用于检测环境因子和距离矩阵之间是否具有显著的相关性。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>cal_mantel<span class=\"token punctuation\">(</span>use_measure <span class=\"token operator\">=</span> <span class=\"token string\">\"bray\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_mantel</span>\nt1<span class=\"token operator\">$</span>res_mantel<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n  <div style=\"overflow-x:auto;\">\n  <table>\n<table>\n<thead>\n<tr>\n<th>|variable_name</th>\n<th>cor_method</th>\n<th>corr_res</th>\n<th>p_res</th>\n<th>significance</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1|<strong>TN</strong></td>\n<td>pearson</td>\n<td>0.5571885</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>2|<strong>TC</strong></td>\n<td>pearson</td>\n<td>0.5712239</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>3|<strong>TS</strong></td>\n<td>pearson</td>\n<td>0.2665453</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>4|<strong>TOC</strong></td>\n<td>pearson</td>\n<td>0.3540337</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>5|<strong>Salinity</strong></td>\n<td>pearson</td>\n<td>0.2782537</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>6|Temperature</td>\n<td>pearson</td>\n<td>0.5856050</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>7|<strong>Dissolved.oxygen</strong></td>\n<td>pearson</td>\n<td>0.4358422</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>8|Surface.chlorophyll.concentrations</td>\n<td>pearson</td>\n<td>0.2586823</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>9|pH</td>\n<td>pearson</td>\n<td>0.4498964</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>10</td>\n<td><strong>PAR</strong></td>\n<td>pearson</td>\n<td>0.1712861</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>11</td>\n<td>Density</td>\n<td>pearson</td>\n<td>0.5682679</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n<tr>\n<td>12</td>\n<td>Turbidity</td>\n<td>pearson</td>\n<td>0.2260436</td>\n<td>0.001</td>\n<td>***</td>\n</tr>\n</tbody>\n</table>\n  </table></div>\n</li>\n<li>\n<p>环境变量与分类群（taxa）的相关性对分析和推断影响群落结构的因素具有重要意义。在本例中，我们首先进行了差异丰度检验（differential abundance test）和随机森林分析（random forest），得到了重要的属（Genus）。然后利用这些分类单元进行相关性分析。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># first create trans_diff object</span>\nt2 <span class=\"token operator\">&lt;-</span> trans_diff<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> method <span class=\"token operator\">=</span> <span class=\"token string\">\"rf\"</span><span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> rf_taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"Genus\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># then create trans_env object</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_env<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># calculate correlation</span>\nt1<span class=\"token operator\">$</span>cal_cor<span class=\"token punctuation\">(</span>use_data <span class=\"token operator\">=</span> <span class=\"token string\">\"other\"</span><span class=\"token punctuation\">,</span> p_adjust_method <span class=\"token operator\">=</span> <span class=\"token string\">\"fdr\"</span><span class=\"token punctuation\">,</span> other_taxa <span class=\"token operator\">=</span> t2<span class=\"token operator\">$</span>res_rf<span class=\"token operator\">$</span>Taxa<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_cor </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>使用 ggplot2 或 pheatmap 进行可视化</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># default ggplot2 method</span>\nt1<span class=\"token operator\">$</span>plot_corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># clustering heatmap; require pheatmap package</span>\nt1<span class=\"token operator\">$</span>plot_corr<span class=\"token punctuation\">(</span>pheatmap <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4ggplot2.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"7个环境变量与分类群ggplot2\" /></p>\n<p><img src=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/7%E4%B8%AA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E4%B8%8E%E5%88%86%E7%B1%BB%E7%BE%A4%E7%9B%B8%E5%85%B3%E6%80%A7_pheatmap.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"7个环境变量与分类群相关性_pheatmap\" /></p>\n<ul>\n<li>\n<p>各组内的环境变量与分类群 taxa 之间的关系</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># calculate correlations for different groups using parameter by_group</span>\nt1<span class=\"token operator\">$</span>cal_cor<span class=\"token punctuation\">(</span>by_group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> use_data <span class=\"token operator\">=</span> <span class=\"token string\">\"other\"</span><span class=\"token punctuation\">,</span> p_adjust_method <span class=\"token operator\">=</span> <span class=\"token string\">\"fdr\"</span><span class=\"token punctuation\">,</span> other_taxa <span class=\"token operator\">=</span> t2<span class=\"token operator\">$</span>res_rf<span class=\"token operator\">$</span>Taxa<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">60</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_cor</span>\nt1<span class=\"token operator\">$</span>plot_corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/correlations_between_environmental_variables_and_60_taxa.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"correlations_between_environmental_variables_and_60_taxa\" /></p>\n<ul>\n<li>\n<p>环境因子与 alpha - 多样性之间的关系</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1 <span class=\"token operator\">&lt;-</span> trans_env<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># use add_abund_table parameter to add the extra data table</span>\nt1<span class=\"token operator\">$</span>cal_cor<span class=\"token punctuation\">(</span>add_abund_table <span class=\"token operator\">=</span> meco_dataset<span class=\"token operator\">$</span>alpha_diversity<span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>plot_corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/relationship_between_7_environmental_factors_and_alpha_diversity.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"relationship_between_7_environmental_factors_and_alpha_diversity\" /></p>\n<h1 id=\"font-colorff0000-13-trans_nullmodel-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-13-trans_nullmodel-classfont\"></a> <font color=#FF0000 >13. trans_nullmodel class</font></h1>\n<ul>\n<li>\n<p>近几十年来，系统发育分析和空模型（null model）的结合，通过增加系统发育维度（phylogeny dimension），更加有力地促进了生态位和中性（niche and neutral）对群落组装影响的推断 [16，17]。trans_nullmodel class 提供了一个封装，包括对系统发育信号、beta 平均成对系统发育距离（beta mean pairwise phylogenetic distance，betaMPD）、beta 平均最近分类单元距离（beta mean nearest taxon distance，betaMNTD）、beta 最近分类单元指数（beta nearest taxon index，betaNTI）、beta 净相关指数（beta net relatedness index，betaNRI）和基于 Bray-Curtis 的 Raup-Crick（Bray-Curtis-based Raup-Crick，RCbray）的计算。系统发育信号分析的方法基于 mantel 相关图（mantel correlogram）[18]，与其他方法相比，系统发育信号的变化是直观而清晰的。betaMNTD 和 betaMPD 的算法已经过优化，比 picante 包中的算法更快 [3]。RCbray 和 betaNTI（或 betaNRI）之间的组合可用于推断在特定假设下支配群落装配（community assembly）的每个生态过程（ecological process）的强度 [17]。这可以通过函数 cal_process () 来解析每个推断进程（ecological process）的百分比来实现。<font color=#2196F3 ><strong>我们首先检查系统发育信号：</strong></font></p>\n <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># generate trans_nullmodel object; use 10000 OTUs as example</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_nullmodel<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">,</span> taxa_number <span class=\"token operator\">=</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># use TOC as the test variable (__报错：Error in cor(as.vector(xdis), ydis, method = method, use = use) : </span>\n  cov<span class=\"token operator\">/</span>cor中有遗漏值__<span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>cal_mantel_corr<span class=\"token punctuation\">(</span>use_env <span class=\"token operator\">=</span> <span class=\"token string\">\"TOC\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># return t1$res_mantel_corr</span>\n<span class=\"token comment\"># plot the mantel correlogram(__报错：Error in names(x) &lt;- value : 'names'属性的长度[4]必需和矢量的长度[0]一样__)</span>\nt1<span class=\"token operator\">$</span>plot_mantel_corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>betaNRI（ses.betampd）用于显示 “basal” 系统发育转换（phylogenetic turnover）[18]。与 betaNTI 相比，它能捕获更多与深层系统发育（deep phylogeny）相关的转换信息（turnover information）。值得注意的是，经过几十年的发展，出现了许多空模型（null models）。在 trans-nullmodel class 中，我们随机化了物种的系统发育相关性。这种洗牌方法（shuffling approach）固定了观察到的物种 α- 多样性和 β- 多样性的水平，以探讨观察到的系统发育转换是否与空模型（物种间的系统发育关系是随机的）显著不同。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 运行500次null model</span>\nt1<span class=\"token operator\">$</span>cal_ses_betampd<span class=\"token punctuation\">(</span>runs<span class=\"token operator\">=</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> abundance.weighted <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 返回t1$res_ses_betampd</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>可以使用 trans_beta class 中的 plot_group_distance function 绘制 betaNRI 图。结果表明 T20 和 T21 的平均 betaNRI 显著高于其它三者，表明 T20 和 T21 中的 basal phylogenetic turnover 是高的。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 将betaNRI矩阵加入到beta_diversity列表中</span>\nmeco_dataset<span class=\"token operator\">$</span>beta_diversity<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"betaNRI\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;-</span> t1<span class=\"token operator\">$</span>res_ses_betampd\n\n<span class=\"token comment\"># 使用measure \"betaNRI\"创建trans_beta class</span>\nt2 <span class=\"token operator\">&lt;-</span> trans_beta<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"betaNRI\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># transform the distance for each group</span>\nt2<span class=\"token operator\">$</span>cal_group_distance<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 结果可视化</span>\nlibrary<span class=\"token punctuation\">(</span>ggplot2<span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">&lt;-</span> t2<span class=\"token operator\">$</span>plot_group_distance<span class=\"token punctuation\">(</span>distance_pair_stat <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_all.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/betaNRI_all.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"betaNRI all\" /></p>\n<ul>\n<li>\n<p>若要单独的对每个组进行 null model analysis，例如每个组作为一个物种池（species pool），我们可以分别为每个组计算结果。 我们发现，当分别对每个组进行 betaNRI 分析时，CW 和 TW 间的 mean betaNRI 没有显著差异，且二者均显著高于 IW ，揭示了在将每个区域视为特定物种库的条件下，CW 和 TW 中变量选择的强度（strength of variable selection）可能相似。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 创建一个列表用于存放trans_nullmodel的结果</span>\nsesbeta_each <span class=\"token operator\">&lt;-</span> list<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ngroup_col <span class=\"token operator\">&lt;-</span> <span class=\"token string\">\"Site\"</span>\nall_groups <span class=\"token operator\">&lt;-</span> unique<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token operator\">$</span>sample_table<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> group_col<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 对每个组分别进行计算</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> all_groups<span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>\n\t<span class=\"token comment\"># like the above operation, but need provide 'group' and 'select_group'</span>\n\ttest <span class=\"token operator\">&lt;-</span> trans_nullmodel<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> group_col<span class=\"token punctuation\">,</span> select_group <span class=\"token operator\">=</span> i<span class=\"token punctuation\">,</span> taxa_number <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data<span class=\"token punctuation\">)</span>\n\ttest<span class=\"token operator\">$</span>cal_ses_betampd<span class=\"token punctuation\">(</span>runs <span class=\"token operator\">=</span> <span class=\"token number\">500</span><span class=\"token punctuation\">,</span> abundance.weighted <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\tsesbeta_each<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;-</span> test<span class=\"token operator\">$</span>res_ses_betampd\n<span class=\"token punctuation\">&#125;</span>\n\n<span class=\"token comment\"># 合并结果并重塑（reshape），得到一个对称矩阵（symmetrical matrix）</span>\nlibrary<span class=\"token punctuation\">(</span>reshape2<span class=\"token punctuation\">)</span>\ntest <span class=\"token operator\">&lt;-</span> lapply<span class=\"token punctuation\">(</span>sesbeta_each<span class=\"token punctuation\">,</span> melt<span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> do.call<span class=\"token punctuation\">(</span>rbind<span class=\"token punctuation\">,</span> .<span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> reshape2<span class=\"token operator\">::</span>dcast<span class=\"token punctuation\">(</span>.<span class=\"token punctuation\">,</span> Var1<span class=\"token operator\">~</span>Var2<span class=\"token punctuation\">,</span> value.var <span class=\"token operator\">=</span> <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> `row.names<span class=\"token operator\">&lt;-</span>`<span class=\"token punctuation\">(</span>.<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token percent-operator operator\">%>%</span> .<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> drop <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 如同上述操作</span>\nmeco_dataset<span class=\"token operator\">$</span>beta_diversity<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"betaNRI\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;-</span> test\nt2 <span class=\"token operator\">&lt;-</span> trans_beta<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"betaNRI\"</span><span class=\"token punctuation\">)</span>\nt2<span class=\"token operator\">$</span>cal_group_distance<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">&lt;-</span> t2<span class=\"token operator\">$</span>plot_group_distance<span class=\"token punctuation\">(</span>distance_pair_stat <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<p><img src=\"#/images/lujia/betaNRI_individual.jpg\" class=\"lazyload placeholder\" data-srcset=\"#/images/lujia/betaNRI_individual.jpg\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"betaNRI individual\" /></p>\n<ul>\n<li>\n<p>BetaNTI (ses.betamntd) 可用于指示系统发育的末端转换（ phylogenetic terminal turnover） [17]</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># 运行500次null model</span>\nt1<span class=\"token operator\">$</span>cal_ses_betamntd<span class=\"token punctuation\">(</span>runs<span class=\"token operator\">=</span><span class=\"token number\">500</span><span class=\"token punctuation\">,</span> abundance.weighted <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 返回t1$res_ses_betamntd</span>\n\n<span class=\"token comment\"># 将betaNTI矩阵加入到beta_diversity列表中</span>\nmeco_dataset<span class=\"token operator\">$</span>beta_diversity<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"betaNTI\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&lt;-</span> t1<span class=\"token operator\">$</span>res_ses_betamntd\n\n<span class=\"token comment\"># 使用measure \"betaNRI\"创建trans_beta class</span>\nt2 <span class=\"token operator\">&lt;-</span> trans_beta<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> group <span class=\"token operator\">=</span> <span class=\"token string\">\"Site\"</span><span class=\"token punctuation\">,</span> measure <span class=\"token operator\">=</span> <span class=\"token string\">\"betaNTI\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># transform the distance for each group</span>\nt2<span class=\"token operator\">$</span>cal_group_distance<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 结果可视化</span>\nlibrary<span class=\"token punctuation\">(</span>ggplot2<span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">&lt;-</span> t2<span class=\"token operator\">$</span>plot_group_distance<span class=\"token punctuation\">(</span>distance_pair_stat <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\ng1 <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> geom_hline<span class=\"token punctuation\">(</span>yintercept <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> linetype <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>cal_rcbray () 功能用于计算 RCbray (Bray-Curtis-based Raup-Crick) ，以评估成分转换（compositional turnover）是否主要受漂移控制 [19]。我们应用空模型（null model）通过从每个物种池中随机采样个体来模拟物种分布，同时保留物种发生频率（species occurrence frequency）和样本物种丰富度（sample species richness）[18]。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># result stored in t1$res_rcbray</span>\nt1<span class=\"token operator\">$</span>cal_rcbray<span class=\"token punctuation\">(</span>runs <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_rcbray</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>作为一个例子，我们还计算了引用文献 [17，18] 中所示的在群落组装（community assembly）上推断过程（ inferred processes ）所占的比例。在此示例中，具有显着 betaNTI 值（|βNTI|&gt; 2）的成对比较部分是估计的选择（Selection）造成影响； βNTI&gt; 2 代表异构选择（heterogeneous ）； βNTI&lt;-2 表示同质选择（homogeneous ）。 RCbray 值表征了随机分配（randomization）下观察到的 Bray-Curtis 和 Bray-Curtis 期望值之间的偏差大小（magnitude of deviation）。 | RCbray | &gt; 0.95 被认为是显着的。 |βNTI| &lt; 2 和 RCbray &gt; +0.95 被视为受散播限制（Dispersal Limitation）与漂移（Drift）相结合的影响。 |βNTI| &lt; 2 和 RCbray &lt; -0.95 被视为均质分散（Homogenizing Dispersal）影响的估计值。 |βNTI| &lt; 2 和 | RCbray| &lt; 0.95 估算了漂移单独作用的影响。</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># use betaNTI and rcbray to evaluate processes</span>\nt1<span class=\"token operator\">$</span>cal_process<span class=\"token punctuation\">(</span>use_betamntd <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># return t1$res_process</span>\nt1<span class=\"token operator\">$</span>res_process<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>process</th>\n<th>percentage</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>variable selection</td>\n<td>0.4341164</td>\n</tr>\n<tr>\n<td>2</td>\n<td>homogeneous selection</td>\n<td>63.6874362</td>\n</tr>\n<tr>\n<td>3</td>\n<td>dispersal limitation</td>\n<td>0.0000000</td>\n</tr>\n<tr>\n<td>4</td>\n<td>homogeneous dispersal</td>\n<td>14.8365679</td>\n</tr>\n<tr>\n<td>5</td>\n<td>drift</td>\n<td>21.0418795</td>\n</tr>\n</tbody>\n</table>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-14-trans_network-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-14-trans_network-classfont\"></a> <font color=#FF0000 >14. trans_network class</font></h1>\n<h2 id=\"font-colorff9800-correlation-based-networkfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-correlation-based-networkfont\"></a> <font color=#FF9800 >correlation-based network</font></h2>\n<ul>\n<li>准备 R 包并进行计算相关性  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">install.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"WGCNA\"</span><span class=\"token punctuation\">)</span>\nlibrary<span class=\"token punctuation\">(</span>WGCNA<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 以下3选1</span>\n<span class=\"token comment\"># 1. Use R base cor.test, slow</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_network<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> cal_cor <span class=\"token operator\">=</span> <span class=\"token string\">\"base\"</span><span class=\"token punctuation\">,</span> taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"OTU\"</span><span class=\"token punctuation\">,</span> filter_thres <span class=\"token operator\">=</span> <span class=\"token number\">0.0001</span><span class=\"token punctuation\">,</span> cor_method <span class=\"token operator\">=</span> <span class=\"token string\">\"spearman\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_cor_p list; one table: correlation; another: p value</span>\n\n<span class=\"token comment\"># 2. SparCC method, require SpiecEasi package</span>\n<span class=\"token comment\"># SparCC is very slow, so consider filtering more species with low abundance</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_network<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> meco_dataset<span class=\"token punctuation\">,</span> cal_cor <span class=\"token operator\">=</span> <span class=\"token string\">\"SparCC\"</span><span class=\"token punctuation\">,</span> taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"OTU\"</span><span class=\"token punctuation\">,</span> filter_thres <span class=\"token operator\">=</span> <span class=\"token number\">0.001</span><span class=\"token punctuation\">,</span> SparCC_simu_num <span class=\"token operator\">=</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 3. When the OTU number is large, use R WGCNA package to replace R base to calculate correlations</span>\n<span class=\"token comment\"># require WGCNA package</span>\nt1 <span class=\"token operator\">&lt;-</span> trans_network<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> dataset<span class=\"token punctuation\">,</span> cal_cor <span class=\"token operator\">=</span> <span class=\"token string\">\"WGCNA\"</span><span class=\"token punctuation\">,</span> taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"OTU\"</span><span class=\"token punctuation\">,</span> filter_thres <span class=\"token operator\">=</span> <span class=\"token number\">0.0001</span><span class=\"token punctuation\">,</span> cor_method <span class=\"token operator\">=</span> <span class=\"token string\">\"spearman\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h2 id=\"font-colorff9800-构建网络font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-构建网络font\"></a> <font color=#FF9800 >构建网络</font></h2>\n<ul>\n<li>\n<p>COR_optimization = TRUE represent using RMT theory to find the optimized correlation threshold instead of the COR_cut.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># construct network; require igraph package</span>\nt1<span class=\"token operator\">$</span>cal_network<span class=\"token punctuation\">(</span>p_thres <span class=\"token operator\">=</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> COR_optimization <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_network</span>\n\n<span class=\"token comment\"># (可选) use arbitrary coefficient threshold to contruct network</span>\nt1<span class=\"token operator\">$</span>cal_network<span class=\"token punctuation\">(</span>p_thres <span class=\"token operator\">=</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> COR_cut <span class=\"token operator\">=</span> <span class=\"token number\">0.73</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># save network</span>\n<span class=\"token comment\"># open the gexf file using Gephi(https://gephi.org/)</span>\n<span class=\"token comment\"># require rgexf package</span>\ninstall.packages<span class=\"token punctuation\">(</span><span class=\"token string\">\"rgexf\"</span><span class=\"token punctuation\">)</span>\nt1<span class=\"token operator\">$</span>save_network<span class=\"token punctuation\">(</span>filepath <span class=\"token operator\">=</span> <span class=\"token string\">\"network.gexf\"</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Now, we show the node colors with the Phylum information and the edges colors with the positive and negative correlations. All the data used has been stored in the network.gexf file, including modules classifications, Phylum information and edges classifications.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># calculate network attributes</span>\nt1<span class=\"token operator\">$</span>cal_network_attr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_network_attr</span>\n\n<span class=\"token comment\"># classify the node; return t1$res_node_type</span>\nt1<span class=\"token operator\">$</span>cal_node_type<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_node_type</span>\n<span class=\"token comment\"># we retain the file for the following example in trans_func part</span>\nnetwork_node_type <span class=\"token operator\">&lt;-</span> t1<span class=\"token operator\">$</span>res_node_type\n\n<span class=\"token comment\"># plot node roles in terms of the within-module connectivity and among-module connectivity</span>\nt1<span class=\"token operator\">$</span>plot_taxa_roles<span class=\"token punctuation\">(</span>use_type <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># plot node roles with phylum information</span>\nt1<span class=\"token operator\">$</span>plot_taxa_roles<span class=\"token punctuation\">(</span>use_type <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Now, we show the eigengene analysis of modules. The eigengene of a module, i.e. the first principal component of PCA, represents the main variance of the abundance in the species of the module.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1<span class=\"token operator\">$</span>cal_eigen<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_eigen</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p><strong>出错了</strong>！Then we perform correlation heatmap to show the relationships between eigengenes and environmental factors.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># create trans_env object like the above operation</span>\nt2 <span class=\"token operator\">&lt;-</span> trans_env<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>dataset <span class=\"token operator\">=</span> dataset<span class=\"token punctuation\">,</span> add_data <span class=\"token operator\">=</span> env_data_16S<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token operator\">:</span><span class=\"token number\">11</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># calculate correlations</span>\nt2<span class=\"token operator\">$</span>cal_cor<span class=\"token punctuation\">(</span>add_abund_table <span class=\"token operator\">=</span> t1<span class=\"token operator\">$</span>res_eigen<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># plot the correlation heatmap</span>\nt2<span class=\"token operator\">$</span>plot_corr<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>The function cal_sum_links() is used to sum the links (edge) number from one taxa to another or in the same taxa. The function plot_sum_links() is used to show the result from the function cal_sum_links(). This is very useful to fast see how many nodes are connected between different taxa or within one taxa. In terms of “Phylum” level in the tutorial, the function cal_sum_links() sum the linkages number from one Phylum to another Phylum or the linkages in the same Phylum. So the numbers along the outside of the circular plot represent how many edges or linkages are related with the Phylum. For example, in terms of Proteobacteria, there are roughly total 900 edges associated with the OTUs in Proteobacteria, in which roughly 200 edges connect both OTUs in Proteobacteria and roughly 150 edges connect the OTUs from Proteobacteria with the OTUs from Chloroflexi.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">devtools<span class=\"token operator\">::</span>install_github<span class=\"token punctuation\">(</span><span class=\"token string\">\"mattflor/chorddiag\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># calculate the links between or within taxonomic ranks (报错：Error in ecount(network) : 没有\"ecount\"这个函数)</span>\nt1<span class=\"token operator\">$</span>cal_sum_links<span class=\"token punctuation\">(</span>taxa_level <span class=\"token operator\">=</span> <span class=\"token string\">\"Phylum\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t1$res_sum_links_pos and t1$res_sum_links_neg</span>\n<span class=\"token comment\"># require chorddiag package</span>\nt1<span class=\"token operator\">$</span>plot_sum_links<span class=\"token punctuation\">(</span>plot_pos <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">,</span> plot_num <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-15-trans_func-classfont\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-15-trans_func-classfont\"></a> <font color=#FF0000 >15. trans_func class</font></h1>\n<pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># Identify microbial traits</span>\n<span class=\"token comment\"># create object of trans_func</span>\nt2 <span class=\"token operator\">&lt;-</span> trans_func<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># mapping the taxonomy to the database</span>\n<span class=\"token comment\"># the function can recognize prokaryotes or fungi automatically</span>\nt2<span class=\"token operator\">$</span>cal_spe_func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t2$res_spe_func, 1 represent function exists, 0 represent no or cannot confirmed.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n<ul>\n<li>\n<p>The percentages of the OTUs having the same trait can reflect the functional redundancy of this function in the community or the module in the network.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\"><span class=\"token comment\"># calculate the percentages of OTUs for each trait in each module of network</span>\n<span class=\"token comment\"># use_community = FALSE represent calculating module, not community, node_type_table provide the module information</span>\nt2<span class=\"token operator\">$</span>cal_spe_func_perc<span class=\"token punctuation\">(</span>use_community <span class=\"token operator\">=</span> <span class=\"token boolean\">FALSE</span><span class=\"token punctuation\">,</span> node_type_table <span class=\"token operator\">=</span> network_node_type<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return t2$res_spe_func_perc</span>\n<span class=\"token comment\"># we only plot some important traits, so we use the default group list to filter and show the traits.</span>\nt2<span class=\"token operator\">$</span>plot_spe_func_perc<span class=\"token punctuation\">(</span>select_samples <span class=\"token operator\">=</span> paste0<span class=\"token punctuation\">(</span><span class=\"token string\">\"M\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token operator\">:</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># M represents module, ordered by the nodes number from high to low</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li>\n<p>Tax4Fun requires a strict input file demand on the taxonomic information. To analyze the trimmed or changed OTU data in R with Tax4Fun, we provide a link to the Tax4Fun functional prediction.</p>\n  <pre class=\"line-numbers language-r\" data-language=\"r\"><code class=\"language-r\">t1 <span class=\"token operator\">&lt;-</span> trans_func<span class=\"token operator\">$</span>new<span class=\"token punctuation\">(</span>meco_dataset<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># install Tax4Fun package and download SILVA123 ref data from  http://tax4fun.gobics.de/</span>\nwget https<span class=\"token operator\">:</span><span class=\"token operator\">/</span><span class=\"token operator\">/</span>github.com<span class=\"token operator\">/</span>bwemheu<span class=\"token operator\">/</span>Tax4Fun2<span class=\"token operator\">/</span>releases<span class=\"token operator\">/</span>download<span class=\"token operator\">/</span><span class=\"token number\">1.1</span><span class=\"token number\">.5</span><span class=\"token operator\">/</span>Tax4Fun2_1.<span class=\"token number\">1.5</span>.tar.gz\ninstall.packages<span class=\"token punctuation\">(</span>pkgs <span class=\"token operator\">=</span> <span class=\"token string\">\"Tax4Fun2_1.1.5.tar.gz\"</span><span class=\"token punctuation\">,</span> repos <span class=\"token operator\">=</span> <span class=\"token keyword\">NULL</span><span class=\"token punctuation\">,</span> source <span class=\"token operator\">=</span> <span class=\"token boolean\">TRUE</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># decompress SILVA123; provide path in folderReferenceData as you put</span>\nt1<span class=\"token operator\">$</span>cal_tax4fun<span class=\"token punctuation\">(</span>folderReferenceData <span class=\"token operator\">=</span> <span class=\"token string\">\"./SILVA123\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># return two files: t1$tax4fun_KO: KO file; t1$tax4fun_path: pathway file.</span>\n<span class=\"token comment\"># t1$tax4fun_KO$Tax4FunProfile[1:5, 1:2]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n</ul>\n<h1 id=\"font-colorff0000-16-知识点font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-16-知识点font\"></a> <font color=#FF0000 >16. 知识点</font></h1>\n<h2 id=\"font-colorff9800-确定性过程和随机过程font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff9800-确定性过程和随机过程font\"></a> <font color=#FF9800 >确定性过程和随机过程</font></h2>\n<ul>\n<li>\n<p>The term <font color=#2196F3 size=5><b>“deterministic process”</b></font> refers to two types of selective forces, namely, those that lead to either more (i.e. homogeneous selection) or less (i.e. heterogeneous selection) similar structures among communities due to homogeneous and heterogeneous environmental pressures, respectively (Zhou &amp; Ning, 2017).  <font color=#2196F3 size=5><b>确定性过程</b></font>包括两种选择力，即分别导致更加相似（即同质选择）或更少相似（即异质选择）的群落间的结构的同质和异质环境压力。</p>\n</li>\n<li>\n<p>The term<font color=#2196F3 size=5><b> “stochastic process” </b></font>refers to homogenizing dispersal, dispersal limitation (combined with drift) and pure drift, which can obscure the turnover among microbial communities due to high dispersal; low dispersal; and random changes in birth, death and reproduction, respectively (Zhou &amp; Ning, 2017). <font color=#2196F3 size=5><b>随机过程</b></font>是指均匀分散、分散限制（结合漂变）和纯漂变，它们可以通过高度分散、低分散和出生、死亡和繁殖的随机变化来掩盖 / 减弱微生物群落之间的更替。</p>\n</li>\n</ul>\n<p><img src=\"/images/lujia/nullmodel.png\" class=\"lazyload placeholder\" data-srcset=\"/images/lujia/nullmodel.png\" srcset=\"https://img2.baidu.com/it/u=2037979560,2772131037&fm=26&fmt=auto&gp=0.jpg\" alt=\"Community assembly processes by Stegen et al. https://www.nature.com/articles/ismej201393\" /></p>\n<ul>\n<li>An NTI of &gt;+2 indicates that the ASVs in a local community are more closely related than expected by chance, suggesting the role of selective pressures (e.g. environmental conditions) in phylogenetic clustering. An NTI of &lt;−2 represents phylogenetic overdispersion, indicating two possible biotic interactions: competition and facilitation. In contrast, a mean NTI across multiple communities that is significantly greater or less than zero indicates phylogenetic clustering or overdispersion, respectively (Zhou &amp; Ning, 2017). NTI &gt;2 表明，在一个地方群落中，ASVs 的亲缘关系比预期的更为密切，表明选择压力（如环境条件）在系统发育聚类中的作用。NTI &lt;-2 表示系统发育过度分散，表明两种可能的生物相互作用：竞争和促进。相反，多个群落间的平均 NTI 显著大于或小于零，分别表明系统发育聚类或过度分散（Zhou 和 Ning，2017）。</li>\n<li>βNTI&gt;+2 or &lt;−2 signified heterogeneous selection or homogeneous selection, respectively. βNTI&gt;+2 or &lt;−2 分别指示异质选择和同质选择。</li>\n</ul>\n<h1 id=\"font-colorff0000-17-参考font\"><a class=\"markdownIt-Anchor\" href=\"#font-colorff0000-17-参考font\"></a> <font color=#FF0000 >17. 参考</font></h1>\n<ul>\n<li><a href=\"https://chiliubio.github.io/microeco/\">https://chiliubio.github.io/microeco/</a></li>\n<li>Zhou, J., &amp; Ning, D. (2017). Stochastic community assembly: Does it matter in microbial ecology? Microbiology and Molecular Biology Reviews, 81(4), e00002–17. <a href=\"https://doi.org/10.1128/MMBR.00002%E2%80%9017\">https://doi.org/10.1128/MMBR.00002‐17</a></li>\n<li><a href=\"http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml\">http://www.360doc.com/content/20/1223/07/71874948_952966442.shtml</a></li>\n</ul>\n","raw":null,"categories":[{"name":"生物信息","path":"api/categories/生物信息.json"}],"tags":[{"name":"扩增子","path":"api/tags/扩增子.json"}]}]}